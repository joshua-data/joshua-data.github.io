<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="4.3.2">Jekyll</generator><link href="http://localhost:4000/feed.xml" rel="self" type="application/atom+xml" /><link href="http://localhost:4000/" rel="alternate" type="text/html" /><updated>2025-05-03T22:32:20+09:00</updated><id>http://localhost:4000/feed.xml</id><title type="html">Joshua Kim</title><subtitle>Analytics Engineer | Data Analyst</subtitle><entry><title type="html">ë°ì´í„° ë§ˆíŠ¸ ëª¨ë¸ë§ í›„ê¸° (First Activation Funnel ì§€í‘œ)</title><link href="http://localhost:4000/first-activation-data-mart-ko/" rel="alternate" type="text/html" title="ë°ì´í„° ë§ˆíŠ¸ ëª¨ë¸ë§ í›„ê¸° (First Activation Funnel ì§€í‘œ)" /><published>2025-01-25T00:00:00+09:00</published><updated>2025-01-25T00:00:00+09:00</updated><id>http://localhost:4000/first-activation-data-mart-ko</id><content type="html" xml:base="http://localhost:4000/first-activation-data-mart-ko/"><![CDATA[<blockquote>
  <p>â€œì‹ ê·œ ì‚¬ìš©ì í™œì„± ì „í™˜ìœ¨ ì§€í‘œë¥¼ íš¨ê³¼ì ìœ¼ë¡œ ì œê³µí•˜ê¸° ìœ„í•´ ë°ì´í„° ë§ˆíŠ¸ë¥¼ ì§ì ‘ ì„¤ê³„í•˜ê³  êµ¬ì¶•í•œ ê²½í—˜ì„ ì •ë¦¬í–ˆìŠµë‹ˆë‹¤. ë¹„ì¦ˆë‹ˆìŠ¤ ìš”êµ¬ì‚¬í•­ ë³€í™”ì— ìœ ì—°í•˜ê²Œ ëŒ€ì‘í•  ìˆ˜ ìˆë„ë¡ ë°ì´í„° ëª¨ë¸ì„ ì„¤ê³„í–ˆê³ , ì‹¤ë¬´ì—ì„œ ë°”ë¡œ í™œìš© ê°€ëŠ¥í•œ ì¿¼ë¦¬ì™€ êµ¬ì¡°ë¥¼ ê³ ë¯¼í–ˆìŠµë‹ˆë‹¤. ì´ ê³¼ì •ì„ í†µí•´ ë°ì´í„° ëª¨ë¸ë§ ì´ë¡ ì„ ì‹¤ì œ ë¬¸ì œ í•´ê²°ì— ì ìš©í•˜ëŠ” ì—­ëŸ‰ê³¼, ìš”êµ¬ì‚¬í•­ì„ ê¹Šì´ ìˆê²Œ íŒŒì•…í•˜ëŠ” ì¤‘ìš”ì„±ì„ ë‹¤ì‹œ í•œ ë²ˆ ì²´ê°í•  ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤.â€</p>
</blockquote>

<p><img src="/assets/2025-01-25-first-activation-data-mart/3.webp" alt="" /></p>

<hr />

<h1 id="ëª©ì°¨">ëª©ì°¨</h1>
<ol>
  <li><strong>ìŠ¤ì¿¼ë“œ ì¡°ì§ì´ ë°œì¡±ëì–´ìš”!</strong>
    <ul>
      <li>1.1. ë°°ê²½</li>
      <li>1.2. ìŠ¤ì¿¼ë“œ ì¡°ì§ì˜ í•µì‹¬ ì§€í‘œ</li>
      <li>1.3. ë°ì´í„°ìŸì´ê°€ í•  ì¼</li>
    </ul>
  </li>
  <li><strong>ë°ì´í„°ìŸì´, ë¨¸ë¦¬ë¥¼ êµ´ë¦¬ë‹¤.</strong>
    <ul>
      <li>2.1. í•µì‹¬ ì§€í‘œë¥¼ ê³±ì”¹ì–´ë´¤ì–´ìš”.</li>
      <li>2.2. ë°ì´í„° ë§ˆíŠ¸ë¥¼ ë§Œë“¤ì!</li>
    </ul>
  </li>
  <li><strong>ë°ì´í„° ë§ˆíŠ¸, ë¯¸ë¦¬ ì‚´í´ë³´ì‹œì£ !</strong>
    <ul>
      <li>3.1. <code class="language-plaintext highlighter-rouge">dim__users</code></li>
      <li>3.2. <code class="language-plaintext highlighter-rouge">fact__first_activation_events</code></li>
      <li>3.3. ë ˆì½”ë“œ ì‚¬ë¡€ë¡œ ì‚´í´ë³¼ê¹Œìš”?</li>
      <li>3.4. ì´ëŸ° íŠ¹ì§•ì„ ì§€ë‹ˆê³  ìˆì–´ìš”.</li>
    </ul>
  </li>
  <li><strong>ì´ëŸ° ì‹ìœ¼ë¡œ ì¿¼ë¦¬ë¥¼ ì‘ì„±í•  ìˆ˜ ìˆì–´ìš”.</strong>
    <ul>
      <li>4.1. ë°ì´í„° ë§ˆíŠ¸ê°€ ì´ëŸ° ì‚¬ìš©ì„±ì„ ì§€ë‹ˆë„ë¡ ë„ëª¨í–ˆì–´ìš”.</li>
      <li>4.2. ì´ˆê¸‰ ì¿¼ë¦¬</li>
      <li>4.3. ì¤‘ê¸‰ ì¿¼ë¦¬</li>
      <li>4.4. ê³ ê¸‰ ì¿¼ë¦¬</li>
    </ul>
  </li>
  <li><strong>ì´ë ‡ê²Œ ëª¨ë¸ë§í–ˆì–´ìš”.</strong>
    <ul>
      <li>5.1. [STEP 1] <code class="language-plaintext highlighter-rouge">dim__users</code> í…Œì´ë¸” ì „ì²´ë¥¼ ë¶ˆëŸ¬ì™€ìš”.</li>
      <li>5.2. [STEP 2] ì‹ ê·œ <code class="language-plaintext highlighter-rouge">first_visit</code> ë°ì´í„°ë§Œ ë‚¨ê²¨ìš”.</li>
      <li>5.3. [STEP 3] <code class="language-plaintext highlighter-rouge">fact__events</code> í…Œì´ë¸”ì„ ì¦ë¶„ì ìœ¼ë¡œ ë¶ˆëŸ¬ì™€ìš”.</li>
      <li>5.4. [STEP 4] ì‹ ê·œ ìµœì´ˆ Key Events ë°ì´í„°ë§Œ ë‚¨ê²¨ìš”.</li>
      <li>5.5. [STEP 5] ì‹ ê·œ <code class="language-plaintext highlighter-rouge">first_visit</code> ë° ì‹ ê·œ ìµœì´ˆ Key Events ë°ì´í„° í•©ì³ì„œ ì‚½ì…í•´ìš”.</li>
      <li>5.6. ë§ˆì§€ë§‰ìœ¼ë¡œ ë‹¤ì‹œ ì‚´í´ë³¼ê¹Œìš”?</li>
    </ul>
  </li>
  <li><strong>ëª¨ë¸ë§ í›„ê¸°ë¥¼ ì •ë¦¬í•´ë³¼ê²Œìš”.</strong>
    <ul>
      <li>6.1. ìš”êµ¬ì‚¬í•­ì„ ì˜ ì •ë¦¬í•´ì•¼, ì¢‹ì€ ë°ì´í„° ë§ˆíŠ¸ë¥¼ ë§Œë“¤ ìˆ˜ ìˆì–´ìš”.</li>
      <li>6.2. ë°ì´í„° ëª¨ë¸ë§ì€ ì´ë¡  í•™ìŠµë§Œìœ¼ë¡œ ì™„ì„±ë˜ì§€ ì•Šì•„ìš”.</li>
    </ul>
  </li>
  <li><strong>ê°ì‚¬ì˜ ì¸ì‚¬ë¥¼ ë“œë ¤ìš”.</strong>
    <ul>
      <li>7.1. í† ìŠ¤ì¦ê¶Œì˜ â€œDW ì„¤ê³„ í›„ê¸°â€ ì˜ìƒì—ì„œ ì˜ê°ì„ ì–»ì—ˆì–´ìš”.</li>
      <li>7.2. ìŠ¤ì¿¼ë“œ ë¦¬ë” ë¶„ê»˜ ì •ë§ ê°ì‚¬ ë“œë ¤ìš”.</li>
    </ul>
  </li>
</ol>

<hr />

<h1 id="1-ìŠ¤ì¿¼ë“œ-ì¡°ì§ì´-ë°œì¡±ëì–´ìš”">1. ìŠ¤ì¿¼ë“œ ì¡°ì§ì´ ë°œì¡±ëì–´ìš”!</h1>

<h3 id="11-ë°°ê²½">1.1. ë°°ê²½</h3>

<blockquote>
  <p>ë‹¨ìˆœí•œ ìœ ì…ì´ ì•„ë‹ˆë¼, ì‹ ê·œ ì‚¬ìš©ìë¥¼ ì œí’ˆì— Lock-inì‹œí‚¤ëŠ” ì œí’ˆ ê°œì„ ê³¼ ë§ˆì¼€íŒ… í™œë™ì„ ì§„í–‰í•´ë³´ì!</p>
</blockquote>

<h3 id="12-ìŠ¤ì¿¼ë“œ-ì¡°ì§ì˜-í•µì‹¬-ì§€í‘œ">1.2. ìŠ¤ì¿¼ë“œ ì¡°ì§ì˜ í•µì‹¬ ì§€í‘œ</h3>

<blockquote>
  <p>â€œ<strong>ì‹ ê·œ ë°©ë¬¸ í›„ 1ì¼ ì´ë‚´ Key Event 1ì„ ìˆ˜í–‰í•˜ê³ , 7ì¼ ì´ë‚´ì— Key Event 2ë¥¼ ìˆ˜í–‰í•˜ëŠ” ì „í™˜ìœ¨</strong>â€ì„ ë†’ì—¬ë³´ì!</p>
</blockquote>

<p><img src="/assets/2025-01-25-first-activation-data-mart/1.webp" alt="" /></p>

<p><img src="/assets/2025-01-25-first-activation-data-mart/2.webp" alt="" /></p>

<h3 id="13-ë°ì´í„°ìŸì´ê°€-í• -ì¼">1.3. ë°ì´í„°ìŸì´ê°€ í•  ì¼</h3>

<blockquote>
  <p>â€œí•µì‹¬ ì§€í‘œë¥¼ ì˜ ëœ¯ì–´ë³¼ ìˆ˜ ìˆë„ë¡ ë°ì´í„°ë¥¼ ì¤€ë¹„í•˜ê³  ëŒ€ì‹œë³´ë“œë¡œ ì œê³µí•´ì£¼ì„¸ìš”.â€</p>
</blockquote>

<h1 id="2-ë°ì´í„°ìŸì´-ë¨¸ë¦¬ë¥¼-êµ´ë¦¬ë‹¤">2. ë°ì´í„°ìŸì´, ë¨¸ë¦¬ë¥¼ êµ´ë¦¬ë‹¤.</h1>

<h3 id="21-í•µì‹¬-ì§€í‘œë¥¼-ê³±ì”¹ì–´ë´¤ì–´ìš”">2.1. í•µì‹¬ ì§€í‘œë¥¼ ê³±ì”¹ì–´ë´¤ì–´ìš”.</h3>

<ul>
  <li>First Visit - Key Event 1 - Key Event 2 ì„ í›„ ê´€ê³„ê°€ ëª…í™•í•¨</li>
  <li>ìµœëŒ€ ì „í™˜ê¸°ê°„ ë‚´ì—ì„œë§Œ ì „í™˜ ì¸ì •</li>
  <li>ì‚¬ìš©ì ê¸°ì¤€ì˜ ì „í™˜ìœ¨ ì¸¡ì •í•˜ê¸°</li>
  <li>ì¶”í›„ ìŠ¤ì¿¼ë“œì˜ í•µì‹¬ ì§€í‘œ ë³€ë™ ê°€ëŠ¥ì„±: Key Eventê³¼ ìµœëŒ€ ì „í™˜ê¸°ê°„</li>
</ul>

<h3 id="22-ë°ì´í„°-ë§ˆíŠ¸ë¥¼-ë§Œë“¤ì">2.2. ë°ì´í„° ë§ˆíŠ¸ë¥¼ ë§Œë“¤ì!</h3>

<ul>
  <li>Core Layerì˜ <code class="language-plaintext highlighter-rouge">fact__events</code>ì— ì˜ì¡´í•œ ì¿¼ë¦¬ë¥¼ ì‹¤í–‰í•˜ë©´ ì¿¼ë¦¬ê°€ ì§€ë‚˜ì¹˜ê²Œ ì–´ë ¤ì›Œì§€ê³ , ë¹„ìš©ë„ ë§ì´ ë“¤ ê²ƒ ê°™ì•„.</li>
  <li>í•µì‹¬ ì§€í‘œ ë³€ë™ ê°€ëŠ¥ì„±ì— ë”°ë¼ ì¿¼ë¦¬ì˜ ì •í™•ì„±ê³¼ ë”œë¦¬ë²„ë¦¬ë¥¼ í†µì œí•˜ê¸° ì–´ë ¤ì›Œì§ˆ ê²ƒ ê°™ì•„.</li>
</ul>

<h1 id="3-ë°ì´í„°-ë§ˆíŠ¸-ë¯¸ë¦¬-ì‚´í´ë³´ì‹œì£ ">3. ë°ì´í„° ë§ˆíŠ¸, ë¯¸ë¦¬ ì‚´í´ë³´ì‹œì£ !</h1>

<h3 id="31-dim__users">3.1. <code class="language-plaintext highlighter-rouge">dim__users</code></h3>

<ul>
  <li>ì´ë¯¸ Core Layer ìƒì—ì„œ Conformed Dimensionìœ¼ë¡œ ê´€ë¦¬í•˜ê³  ìˆì—ˆì–´ìš”.</li>
  <li>SCD Type 1ì— í•´ë‹¹í•´ìš”. (ê³¼ê±° ê°’ì„ ë³´ì¡´í•˜ì§€ ì•Šê³ , ê°€ì¥ ìµœì‹  ê°’ë§Œ ìœ ì§€í•´ìš”.)</li>
</ul>

<table>
  <thead>
    <tr>
      <th><strong>Column</strong></th>
      <th><strong>Description</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">user_id</code></td>
      <td>ì‚¬ìš©ì ID</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">first_date</code></td>
      <td>ìµœì´ˆ ë°©ë¬¸ì¼ì</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">first_datetime</code></td>
      <td>ìµœì´ˆ ë°©ë¬¸ì¼ì‹œ</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">country</code></td>
      <td>ìµœê·¼ ì ‘ì† êµ­ê°€</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">device_os</code></td>
      <td>ìµœê·¼ ì ‘ì† ê¸°ê¸° OS</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">app_version</code></td>
      <td>ìµœê·¼ ì•± ë‹¤ìš´ë¡œë“œ ë²„ì „</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">first_campaign</code></td>
      <td>ìµœì´ˆ ë°©ë¬¸ì‹œ UTM Campaign</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">first_medium</code></td>
      <td>ìµœì´ˆ ë°©ë¬¸ì‹œ UTM Medium</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">first_source</code></td>
      <td>ìµœì´ˆ ë°©ë¬¸ì‹œ UTM Source</td>
    </tr>
    <tr>
      <td>â€¦</td>
      <td>â€¦</td>
    </tr>
  </tbody>
</table>

<h3 id="32-fact__first_activation_events">3.2. <code class="language-plaintext highlighter-rouge">fact__first_activation_events</code></h3>

<ul>
  <li>ì´ë²ˆ ë°ì´í„° ë§ˆíŠ¸ì— ìƒˆë¡­ê²Œ ë§Œë“  í…Œì´ë¸”ì´ì—ìš”.</li>
  <li>ê° ì‚¬ìš©ìì˜ ìµœì´ˆ ì´ë²¤íŠ¸ë“¤ë§Œ ì ì¬í•´ìš”.</li>
</ul>

<table>
  <thead>
    <tr>
      <th><strong>Column</strong></th>
      <th><strong>Description</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">date</code></td>
      <td>ì´ë²¤íŠ¸ ìµœì´ˆ ë°œìƒ ì¼ì</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">datetime</code></td>
      <td>ì´ë²¤íŠ¸ ìµœì´ˆ ë°œìƒ ì¼ì‹œ</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">user_id</code></td>
      <td>ì‚¬ìš©ì ID</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">event_name</code></td>
      <td>ì´ë²¤íŠ¸ ì´ë¦„</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">first_visit_date</code></td>
      <td>ì‚¬ìš©ìì˜ ìµœì´ˆ ë°©ë¬¸ ì¼ì</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">first_visit_datetime</code></td>
      <td>ì‚¬ìš©ìì˜ ìµœì´ˆ ë°©ë¬¸ ì¼ì‹œ</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">hours_from_first_visit</code></td>
      <td>ìµœì´ˆ ë°©ë¬¸ í›„ ì´ë²¤íŠ¸ ìµœì´ˆ ë°œìƒê¹Œì§€ ì†Œìš”ëœ ì‹œê°„ ìˆ˜</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">days_from_first_visit</code></td>
      <td>ìµœì´ˆ ë°©ë¬¸ í›„ ì´ë²¤íŠ¸ ìµœì´ˆ ë°œìƒê¹Œì§€ ì†Œìš”ëœ ì¼ ìˆ˜</td>
    </tr>
  </tbody>
</table>

<h3 id="33-ë ˆì½”ë“œ-ì‚¬ë¡€ë¡œ-ì‚´í´ë³¼ê¹Œìš”">3.3. ë ˆì½”ë“œ ì‚¬ë¡€ë¡œ ì‚´í´ë³¼ê¹Œìš”?</h3>

<ul>
  <li><code class="language-plaintext highlighter-rouge">fact__events</code> í…Œì´ë¸”ì´ ë‹¤ìŒê³¼ ê°™ì„ ê²½ìš°, <code class="language-plaintext highlighter-rouge">fact__first_activation_events</code> í…Œì´ë¸”ì€ ë‹¤ìŒê³¼ ê°™ì´ êµ¬ì„±ë  ê±°ì˜ˆìš”.</li>
</ul>

<p><strong><code class="language-plaintext highlighter-rouge">fact__events</code></strong></p>

<ul>
  <li>ê¹€ì§„ì„ì˜ ì´ë²¤íŠ¸ ë¡œê·¸ê°€ ë‹¤ìŒê³¼ ê°™ì´ ì¡´ì¬í•  ê²½ìš°,</li>
</ul>

<table>
  <thead>
    <tr>
      <th><strong>date</strong></th>
      <th><strong>datetime</strong></th>
      <th><strong>user_id</strong></th>
      <th><strong>event_name</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>2025-01-01</td>
      <td>2025-01-01 01:00:00</td>
      <td>ì§„ì„</td>
      <td><code class="language-plaintext highlighter-rouge">first_visit</code></td>
    </tr>
    <tr>
      <td>2025-01-01</td>
      <td>2025-01-01 01:01:00</td>
      <td>ì§„ì„</td>
      <td><code class="language-plaintext highlighter-rouge">add_to_cart</code></td>
    </tr>
    <tr>
      <td>2025-01-02</td>
      <td>2025-01-02 01:00:00</td>
      <td>ì§„ì„</td>
      <td><code class="language-plaintext highlighter-rouge">add_to_cart</code></td>
    </tr>
    <tr>
      <td>2025-01-02</td>
      <td>2025-01-02 01:01:00</td>
      <td>ì§„ì„</td>
      <td><code class="language-plaintext highlighter-rouge">purchase</code></td>
    </tr>
  </tbody>
</table>

<p><strong><code class="language-plaintext highlighter-rouge">fact__first_activation_events</code></strong></p>

<ul>
  <li>ìµœì´ˆ ì´ë²¤íŠ¸ë“¤ë§Œ ë‚¨ê¸´ í›„ í•„ìš”í•œ ì •ë³´ë¥¼ ì¹¼ëŸ¼ìœ¼ë¡œ ì¶”ê°€í•´ìš”.</li>
</ul>

<table>
  <thead>
    <tr>
      <th><strong>date</strong></th>
      <th><strong>datetime</strong></th>
      <th><strong>user_id</strong></th>
      <th><strong>event_name</strong></th>
      <th><strong>first_visit_date</strong></th>
      <th><strong>first_visit_datetime</strong></th>
      <th><strong>hours_from_first_visit</strong></th>
      <th><strong>days_from_first_visit</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>2025-01-01</td>
      <td>2025-01-01 01:00:00</td>
      <td>ì§„ì„</td>
      <td><code class="language-plaintext highlighter-rouge">first_visit</code></td>
      <td>2025-01-01</td>
      <td>2025-01-01 01:00:00</td>
      <td>1</td>
      <td>1</td>
    </tr>
    <tr>
      <td>2025-01-01</td>
      <td>2025-01-01 01:01:00</td>
      <td>ì§„ì„</td>
      <td><code class="language-plaintext highlighter-rouge">add_to_cart</code></td>
      <td>2025-01-01</td>
      <td>2025-01-01 01:00:00</td>
      <td>1</td>
      <td>1</td>
    </tr>
    <tr>
      <td>2025-01-02</td>
      <td>2025-01-02 01:01:00</td>
      <td>ì§„ì„</td>
      <td><code class="language-plaintext highlighter-rouge">purchase</code></td>
      <td>2025-01-01</td>
      <td>2025-01-01 01:00:00</td>
      <td>25</td>
      <td>2</td>
    </tr>
  </tbody>
</table>

<h3 id="34-ì´ëŸ°-íŠ¹ì§•ì„-ì§€ë‹ˆê³ -ìˆì–´ìš”">3.4. ì´ëŸ° íŠ¹ì§•ì„ ì§€ë‹ˆê³  ìˆì–´ìš”.</h3>

<ul>
  <li>Transaction Fact Tableì´ì—ìš”. (<code class="language-plaintext highlighter-rouge">user_id</code>ê°€ ì‚´ì•„ ìˆëŠ” í…Œì´ë¸”ì´ë¼, ì¶”í›„ <code class="language-plaintext highlighter-rouge">dim__users</code>ì„ í†µí•´ Dimension í•„í„°ë§ì„ ìš©ì´í•˜ê²Œ ì‚¬ìš©í•  ìˆ˜ ìˆì–´ìš”.)</li>
  <li>Grainì´ <code class="language-plaintext highlighter-rouge">user_id</code> + <code class="language-plaintext highlighter-rouge">event_name</code> ì¡°í•©ì´ì—ìš”. (ê° ì‚¬ìš©ìì˜ ìµœì´ˆ ì´ë²¤íŠ¸ë“¤ë§Œ ì €ì¥ë˜ë‹ˆê¹Œìš”.)</li>
  <li>ì „í™˜ê¸°ê°„ ì •ë³´ê°€ Pre-calculated Non-additive Factë¡œ ë‹´ê²¨ ìˆì–´ìš”. (ì¶”í›„ Joinì´ë‚˜ Window Functionì„ êµ³ì´ ì‚¬ìš©í•˜ì§€ ì•Šì•„ë„ ë¼ìš”.)</li>
</ul>

<h1 id="4-ì´ëŸ°-ì‹ìœ¼ë¡œ-ì¿¼ë¦¬ë¥¼-ì‘ì„±í• -ìˆ˜-ìˆì–´ìš”">4. ì´ëŸ° ì‹ìœ¼ë¡œ ì¿¼ë¦¬ë¥¼ ì‘ì„±í•  ìˆ˜ ìˆì–´ìš”.</h1>

<h3 id="41-ë°ì´í„°-ë§ˆíŠ¸ê°€-ì´ëŸ°-ì‚¬ìš©ì„±ì„-ì§€ë‹ˆë„ë¡-ë„ëª¨í–ˆì–´ìš”">4.1. ë°ì´í„° ë§ˆíŠ¸ê°€ ì´ëŸ° ì‚¬ìš©ì„±ì„ ì§€ë‹ˆë„ë¡ ë„ëª¨í–ˆì–´ìš”.</h3>

<ul>
  <li>í•µì‹¬ ì§€í‘œì˜ Key Eventê°€ ë³€ê²½ë˜ë©´? â†’ <code class="language-plaintext highlighter-rouge">event_name</code> ë¶€ë¶„ë§Œ ìˆ˜ì •í•˜ë©´ ë¼ìš”.</li>
  <li>í•µì‹¬ ì§€í‘œì˜ ìµœëŒ€ ì „í™˜ê¸°ê°„ì´ ë³€ê²½ë˜ë©´? â†’ <code class="language-plaintext highlighter-rouge">hours_from_first_visit</code>, <code class="language-plaintext highlighter-rouge">days_from_first_visit</code> ë¶€ë¶„ë§Œ ìˆ˜ì •í•˜ë©´ ë¼ìš”.</li>
  <li>ì‚¬ìš©ì ì†ì„± í•„í„°ë§ì´ í•„ìš”í•˜ë©´? â†’ <code class="language-plaintext highlighter-rouge">dim__users</code> JOINë§Œ í•˜ë©´ ë¼ìš”.</li>
</ul>

<h3 id="42-ì´ˆê¸‰-ì¿¼ë¦¬">4.2. ì´ˆê¸‰ ì¿¼ë¦¬</h3>

<ul>
  <li>â˜ğŸ» <code class="language-plaintext highlighter-rouge">key_event_1</code> ì „í™˜ ì‚¬ìš©ì ìˆ˜ ì¶”ì´ë¥¼ ì•Œë ¤ì£¼ì„¸ìš”. (ì „í™˜ê¸°ê°„ì€ ìƒê´€ ì—†ì–´ìš”.)</li>
</ul>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">SELECT</span>
        <span class="nb">date</span><span class="p">,</span>
        <span class="k">COUNT</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="k">AS</span> <span class="n">users_cnt</span>
    <span class="k">FROM</span>
        <span class="n">fact__first_activation_events</span>
    <span class="k">WHERE</span> <span class="k">TRUE</span>
        <span class="k">AND</span> <span class="n">event_name</span> <span class="o">=</span> <span class="s1">'key_event_1'</span>
    <span class="k">GROUP</span> <span class="k">BY</span>
        <span class="mi">1</span>
    <span class="k">ORDER</span> <span class="k">BY</span>
        <span class="mi">1</span>
</code></pre></div></div>

<h3 id="43-ì¤‘ê¸‰-ì¿¼ë¦¬">4.3. ì¤‘ê¸‰ ì¿¼ë¦¬</h3>

<ul>
  <li>â˜ğŸ» <code class="language-plaintext highlighter-rouge">first_visit</code> â†’ 1ì¼ ì´ë‚´ <code class="language-plaintext highlighter-rouge">key_event_1</code> ì „í™˜ìœ¨ ì¶”ì´ë¥¼ ì•Œë ¤ì£¼ì„¸ìš”.</li>
</ul>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">SELECT</span>
        <span class="n">first_visit_date</span> <span class="k">AS</span> <span class="n">cohort_date</span><span class="p">,</span>
        <span class="k">COUNT</span><span class="p">(</span><span class="k">CASE</span> <span class="k">WHEN</span> <span class="n">event_name</span> <span class="o">=</span> <span class="s1">'first_visit'</span> <span class="k">THEN</span> <span class="mi">1</span> <span class="k">END</span><span class="p">)</span> <span class="k">AS</span> <span class="n">first_visit</span><span class="p">,</span>
        <span class="k">COUNT</span><span class="p">(</span><span class="k">CASE</span> <span class="k">WHEN</span> <span class="n">event_name</span> <span class="o">=</span> <span class="s1">'key_event_1'</span> <span class="k">THEN</span> <span class="mi">1</span> <span class="k">END</span><span class="p">)</span> <span class="k">AS</span> <span class="n">key_event_1</span>
    <span class="k">FROM</span>
        <span class="n">fact__first_activation_events</span>
    <span class="k">WHERE</span> <span class="k">TRUE</span>
        <span class="k">AND</span> <span class="p">(</span>
            <span class="n">event_name</span> <span class="o">=</span> <span class="s1">'first_visit'</span>
            <span class="k">OR</span> <span class="p">(</span><span class="n">event_name</span> <span class="o">=</span> <span class="s1">'key_event_1'</span> <span class="k">AND</span> <span class="n">days_from_first_visit</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="k">GROUP</span> <span class="k">BY</span>
        <span class="mi">1</span>
    <span class="k">ORDER</span> <span class="k">BY</span>
        <span class="mi">1</span>
</code></pre></div></div>

<ul>
  <li>â˜ğŸ» (ìŠ¤ì¿¼ë“œì˜ í•µì‹¬ ì§€í‘œ) <code class="language-plaintext highlighter-rouge">first_visit</code> â†’ 1ì¼ ì´ë‚´ <code class="language-plaintext highlighter-rouge">key_event_1</code> â†’ 7ì¼ ì´ë‚´ <code class="language-plaintext highlighter-rouge">key_event_2</code> ì „í™˜ìœ¨ ì¶”ì´ë¥¼ ì•Œë ¤ì£¼ì„¸ìš”.</li>
</ul>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">SELECT</span>
        <span class="n">first_visit_date</span> <span class="k">AS</span> <span class="n">cohort_date</span><span class="p">,</span>
        <span class="k">COUNT</span><span class="p">(</span><span class="k">CASE</span> <span class="k">WHEN</span> <span class="n">event_name</span> <span class="o">=</span> <span class="s1">'first_visit'</span> <span class="k">THEN</span> <span class="mi">1</span> <span class="k">END</span><span class="p">)</span> <span class="k">AS</span> <span class="n">first_visit</span><span class="p">,</span>
        <span class="k">COUNT</span><span class="p">(</span><span class="k">CASE</span> <span class="k">WHEN</span> <span class="n">event_name</span> <span class="o">=</span> <span class="s1">'key_event_1'</span> <span class="k">THEN</span> <span class="mi">1</span> <span class="k">END</span><span class="p">)</span> <span class="k">AS</span> <span class="n">key_event_1</span><span class="p">,</span>
        <span class="k">COUNT</span><span class="p">(</span><span class="k">CASE</span> <span class="k">WHEN</span> <span class="n">event_name</span> <span class="o">=</span> <span class="s1">'key_event_2'</span> <span class="k">THEN</span> <span class="mi">1</span> <span class="k">END</span><span class="p">)</span> <span class="k">AS</span> <span class="n">key_event_2</span>
    <span class="k">FROM</span>
        <span class="n">fact__first_activation_events</span>
    <span class="k">WHERE</span> <span class="k">TRUE</span>
        <span class="k">AND</span> <span class="p">(</span>
            <span class="n">event_name</span> <span class="o">=</span> <span class="s1">'first_visit'</span>
            <span class="k">OR</span> <span class="p">(</span><span class="n">event_name</span> <span class="o">=</span> <span class="s1">'key_event_1'</span> <span class="k">AND</span> <span class="n">days_from_first_visit</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">OR</span> <span class="p">(</span><span class="n">event_name</span> <span class="o">=</span> <span class="s1">'key_event_2'</span> <span class="k">AND</span> <span class="n">days_from_first_visit</span> <span class="o">&lt;=</span> <span class="mi">7</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="k">GROUP</span> <span class="k">BY</span>
        <span class="mi">1</span>
    <span class="k">ORDER</span> <span class="k">BY</span>
        <span class="mi">1</span>
</code></pre></div></div>

<h3 id="44-ê³ ê¸‰-ì¿¼ë¦¬">4.4. ê³ ê¸‰ ì¿¼ë¦¬</h3>

<ul>
  <li>â˜ğŸ» ë¯¸êµ­ ì‚¬ìš©ìì˜ <code class="language-plaintext highlighter-rouge">first_visit</code> â†’ 1ì¼ ì´ë‚´ <code class="language-plaintext highlighter-rouge">key_event_1</code> â†’ 7ì¼ ì´ë‚´ <code class="language-plaintext highlighter-rouge">key_event_2</code> ì „í™˜ìœ¨ ì¶”ì´ë¥¼ ì•Œë ¤ì£¼ì„¸ìš”.</li>
</ul>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">SELECT</span>
        <span class="n">FACT</span><span class="p">.</span><span class="n">first_visit_date</span> <span class="k">AS</span> <span class="n">cohort_date</span><span class="p">,</span>
        <span class="k">COUNT</span><span class="p">(</span><span class="k">CASE</span> <span class="k">WHEN</span> <span class="n">FACT</span><span class="p">.</span><span class="n">event_name</span> <span class="o">=</span> <span class="s1">'first_visit'</span> <span class="k">THEN</span> <span class="mi">1</span> <span class="k">END</span><span class="p">)</span> <span class="k">AS</span> <span class="n">first_visit</span><span class="p">,</span>
        <span class="k">COUNT</span><span class="p">(</span><span class="k">CASE</span> <span class="k">WHEN</span> <span class="n">FACT</span><span class="p">.</span><span class="n">event_name</span> <span class="o">=</span> <span class="s1">'key_event_1'</span> <span class="k">THEN</span> <span class="mi">1</span> <span class="k">END</span><span class="p">)</span> <span class="k">AS</span> <span class="n">key_event_1</span><span class="p">,</span>
        <span class="k">COUNT</span><span class="p">(</span><span class="k">CASE</span> <span class="k">WHEN</span> <span class="n">FACT</span><span class="p">.</span><span class="n">event_name</span> <span class="o">=</span> <span class="s1">'key_event_2'</span> <span class="k">THEN</span> <span class="mi">1</span> <span class="k">END</span><span class="p">)</span> <span class="k">AS</span> <span class="n">key_event_2</span>
    <span class="k">FROM</span>
        <span class="n">fact__first_activation_events</span> <span class="n">FACT</span>
    <span class="k">LEFT</span> <span class="k">JOIN</span>
        <span class="n">dim__users</span> <span class="n">DIM</span>
        <span class="k">ON</span> <span class="n">FACT</span><span class="p">.</span><span class="n">user_id</span> <span class="o">=</span> <span class="n">DIM</span><span class="p">.</span><span class="n">user_id</span>
    <span class="k">WHERE</span> <span class="k">TRUE</span>
        <span class="k">AND</span> <span class="n">DIM</span><span class="p">.</span><span class="n">country</span> <span class="o">=</span> <span class="s1">'United States'</span>
        <span class="k">AND</span> <span class="p">(</span>
            <span class="n">FACT</span><span class="p">.</span><span class="n">event_name</span> <span class="o">=</span> <span class="s1">'first_visit'</span>
            <span class="k">OR</span> <span class="p">(</span><span class="n">FACT</span><span class="p">.</span><span class="n">event_name</span> <span class="o">=</span> <span class="s1">'key_event_1'</span> <span class="k">AND</span> <span class="n">FACT</span><span class="p">.</span><span class="n">days_from_first_visit</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">OR</span> <span class="p">(</span><span class="n">FACT</span><span class="p">.</span><span class="n">event_name</span> <span class="o">=</span> <span class="s1">'key_event_2'</span> <span class="k">AND</span> <span class="n">FACT</span><span class="p">.</span><span class="n">days_from_first_visit</span> <span class="o">&lt;=</span> <span class="mi">7</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="k">GROUP</span> <span class="k">BY</span>
        <span class="mi">1</span>
    <span class="k">ORDER</span> <span class="k">BY</span>
        <span class="mi">1</span>
</code></pre></div></div>

<h1 id="5-ì´ë ‡ê²Œ-ëª¨ë¸ë§í–ˆì–´ìš”">5. ì´ë ‡ê²Œ ëª¨ë¸ë§í–ˆì–´ìš”.</h1>

<p><img src="/assets/2025-01-25-first-activation-data-mart/3.webp" alt="" /></p>

<h3 id="51-step-1-dim__users-í…Œì´ë¸”-ì „ì²´ë¥¼-ë¶ˆëŸ¬ì™€ìš”">5.1. [STEP 1] <code class="language-plaintext highlighter-rouge">dim__users</code> í…Œì´ë¸” ì „ì²´ë¥¼ ë¶ˆëŸ¬ì™€ìš”.</h3>

<p><img src="/assets/2025-01-25-first-activation-data-mart/4.webp" alt="" /></p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">WITH</span>
    <span class="n">CTE_first_visits_raw</span> <span class="k">AS</span> <span class="p">(</span>
        <span class="k">SELECT</span>
            <span class="n">user_id</span><span class="p">,</span>
            <span class="n">first_date</span> <span class="k">AS</span> <span class="nb">date</span><span class="p">,</span>
            <span class="n">first_datetime</span> <span class="k">AS</span> <span class="nb">datetime</span>
        <span class="k">FROM</span>
            <span class="p">{{</span> <span class="k">ref</span><span class="p">(</span><span class="s1">'dim__users'</span><span class="p">)</span> <span class="p">}}</span>
    <span class="p">),</span>	
</code></pre></div></div>

<h3 id="52-step-2-ì‹ ê·œ-first_visit-ë°ì´í„°ë§Œ-ë‚¨ê²¨ìš”">5.2. [STEP 2] ì‹ ê·œ <code class="language-plaintext highlighter-rouge">first_visit</code> ë°ì´í„°ë§Œ ë‚¨ê²¨ìš”.</h3>

<p><img src="/assets/2025-01-25-first-activation-data-mart/5.webp" alt="" /></p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="p">{</span><span class="o">%</span> <span class="n">if</span> <span class="n">is_incremental</span><span class="p">()</span> <span class="o">%</span><span class="p">}</span>

    <span class="n">CTE_first_visits</span> <span class="k">AS</span> <span class="p">(</span>
        <span class="k">SELECT</span>
            <span class="n">SRC</span><span class="p">.</span><span class="n">user_id</span><span class="p">,</span>
            <span class="n">SRC</span><span class="p">.</span><span class="nb">date</span><span class="p">,</span>
            <span class="n">SRC</span><span class="p">.</span><span class="nb">datetime</span>
        <span class="k">FROM</span>
            <span class="n">CTE_first_visits_raw</span> <span class="n">SRC</span>
        <span class="k">LEFT</span> <span class="k">JOIN</span> 
            <span class="p">{{</span> <span class="n">this</span> <span class="p">}}</span> <span class="k">EXISTING</span>
            <span class="k">ON</span> <span class="n">SRC</span><span class="p">.</span><span class="n">user_id</span> <span class="o">=</span> <span class="k">EXISTING</span><span class="p">.</span><span class="n">user_id</span>
            <span class="k">AND</span> <span class="k">EXISTING</span><span class="p">.</span><span class="n">event_name</span> <span class="o">=</span> <span class="s1">'first_visit'</span>
        <span class="k">WHERE</span> <span class="k">TRUE</span>
            <span class="k">AND</span> <span class="k">EXISTING</span><span class="p">.</span><span class="n">user_id</span> <span class="k">IS</span> <span class="k">NULL</span>
    <span class="p">),</span>

    <span class="p">{</span><span class="o">%</span> <span class="n">endif</span> <span class="o">%</span><span class="p">}</span>
</code></pre></div></div>

<h3 id="53-step-3-fact__events-í…Œì´ë¸”ì„-ì¦ë¶„ì ìœ¼ë¡œ-ë¶ˆëŸ¬ì™€ìš”">5.3. [STEP 3] <code class="language-plaintext highlighter-rouge">fact__events</code> í…Œì´ë¸”ì„ ì¦ë¶„ì ìœ¼ë¡œ ë¶ˆëŸ¬ì™€ìš”.</h3>

<p><img src="/assets/2025-01-25-first-activation-data-mart/6.webp" alt="" /></p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="n">CTE_events_raw</span> <span class="k">AS</span> <span class="p">(</span>
        <span class="k">SELECT</span>
            <span class="n">user_id</span><span class="p">,</span>
            <span class="n">event_name</span><span class="p">,</span>
            <span class="k">MIN</span><span class="p">(</span><span class="nb">date</span><span class="p">)</span> <span class="k">AS</span> <span class="nb">date</span><span class="p">,</span>
            <span class="k">MIN</span><span class="p">(</span><span class="nb">datetime</span><span class="p">)</span> <span class="k">AS</span> <span class="nb">datetime</span>
        <span class="k">FROM</span>
            <span class="p">{{</span> <span class="k">ref</span><span class="p">(</span><span class="s1">'fact__events'</span><span class="p">)</span> <span class="p">}}</span>
        <span class="k">WHERE</span> <span class="k">TRUE</span>
            <span class="p">{</span><span class="o">%</span> <span class="n">if</span> <span class="n">is_incremental</span><span class="p">()</span> <span class="o">%</span><span class="p">}</span>
            <span class="k">AND</span> <span class="nb">datetime</span> <span class="o">&gt;</span> <span class="p">(</span><span class="k">SELECT</span> <span class="k">MAX</span><span class="p">(</span><span class="nb">datetime</span><span class="p">)</span> <span class="k">FROM</span> <span class="p">{{</span> <span class="n">this</span> <span class="p">}})</span>
            <span class="p">{</span><span class="o">%</span> <span class="n">endif</span> <span class="o">%</span><span class="p">}</span>
            <span class="k">AND</span> <span class="n">event_name</span> <span class="k">IN</span> <span class="p">(</span>
                <span class="s1">'Key Event 1'</span><span class="p">,</span>
                <span class="s1">'Key Event 2'</span><span class="p">,</span>
                <span class="p">...</span>
            <span class="p">)</span>
        <span class="k">GROUP</span> <span class="k">BY</span>
            <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span>
    <span class="p">)</span>
</code></pre></div></div>

<h3 id="54-step-4-ì‹ ê·œ-ìµœì´ˆ-key-events-ë°ì´í„°ë§Œ-ë‚¨ê²¨ìš”">5.4. [STEP 4] ì‹ ê·œ ìµœì´ˆ Key Events ë°ì´í„°ë§Œ ë‚¨ê²¨ìš”.</h3>

<p><img src="/assets/2025-01-25-first-activation-data-mart/7.webp" alt="" /></p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="p">{</span><span class="o">%</span> <span class="n">if</span> <span class="n">is_incremental</span><span class="p">()</span> <span class="o">%</span><span class="p">}</span>
    <span class="p">,</span>

    <span class="n">CTE_events</span> <span class="k">AS</span> <span class="p">(</span>
        <span class="k">SELECT</span>
            <span class="n">SRC</span><span class="p">.</span><span class="o">*</span>
        <span class="k">FROM</span>
            <span class="n">CTE_events_raw</span> <span class="n">SRC</span>
        <span class="k">LEFT</span> <span class="k">JOIN</span> 
            <span class="p">{{</span> <span class="n">this</span> <span class="p">}}</span> <span class="k">EXISTING</span>
            <span class="k">ON</span> <span class="n">SRC</span><span class="p">.</span><span class="n">user_id</span> <span class="o">=</span> <span class="k">EXISTING</span><span class="p">.</span><span class="n">user_id</span>
            <span class="k">AND</span> <span class="n">SRC</span><span class="p">.</span><span class="n">event_name</span> <span class="o">=</span> <span class="k">EXISTING</span><span class="p">.</span><span class="n">event_name</span>
        <span class="k">WHERE</span> <span class="k">TRUE</span>
            <span class="k">AND</span> <span class="k">EXISTING</span><span class="p">.</span><span class="n">user_id</span> <span class="k">IS</span> <span class="k">NULL</span>
            <span class="k">AND</span> <span class="k">EXISTING</span><span class="p">.</span><span class="n">event_name</span> <span class="k">IS</span> <span class="k">NULL</span>
    <span class="p">)</span>

    <span class="p">{</span><span class="o">%</span> <span class="n">endif</span> <span class="o">%</span><span class="p">}</span>
</code></pre></div></div>

<h3 id="55-step-5-ì‹ ê·œ-first_visit-ë°-ì‹ ê·œ-ìµœì´ˆ-key-events-ë°ì´í„°-í•©ì³ì„œ-ì‚½ì…í•´ìš”">5.5. [STEP 5] ì‹ ê·œ <code class="language-plaintext highlighter-rouge">first_visit</code> ë° ì‹ ê·œ ìµœì´ˆ Key Events ë°ì´í„° í•©ì³ì„œ ì‚½ì…í•´ìš”.</h3>

<p><img src="/assets/2025-01-25-first-activation-data-mart/8.webp" alt="" /></p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">SELECT</span>
        <span class="nb">date</span><span class="p">,</span>
        <span class="nb">datetime</span><span class="p">,</span>
        <span class="n">user_id</span><span class="p">,</span>
        <span class="s1">'first_visit'</span> <span class="k">AS</span> <span class="n">event_name</span><span class="p">,</span>
        <span class="nb">date</span> <span class="k">AS</span> <span class="n">first_visit_date</span><span class="p">,</span>
        <span class="nb">datetime</span> <span class="k">AS</span> <span class="n">first_visit_datetime</span><span class="p">,</span>
        <span class="k">NULL</span> <span class="k">AS</span> <span class="n">hours_from_first_visit</span><span class="p">,</span>
        <span class="k">NULL</span> <span class="k">AS</span> <span class="n">days_from_first_visit</span>
    <span class="k">FROM</span>
        <span class="p">{</span><span class="o">%</span> <span class="n">if</span> <span class="n">is_incremental</span><span class="p">()</span> <span class="o">%</span><span class="p">}</span>
        <span class="n">CTE_first_visits</span>
        <span class="p">{</span><span class="o">%</span> <span class="k">else</span> <span class="o">%</span><span class="p">}</span>
        <span class="n">CTE_first_visits_raw</span>
        <span class="p">{</span><span class="o">%</span> <span class="n">endif</span> <span class="o">%</span><span class="p">}</span>

    <span class="k">UNION</span> <span class="k">ALL</span>

    <span class="k">SELECT</span>
        <span class="n">FCT</span><span class="p">.</span><span class="nb">date</span><span class="p">,</span>
        <span class="n">FCT</span><span class="p">.</span><span class="nb">datetime</span><span class="p">,</span>
        <span class="n">FCT</span><span class="p">.</span><span class="n">user_id</span><span class="p">,</span>
        <span class="n">FCT</span><span class="p">.</span><span class="n">event_name</span><span class="p">,</span>
        <span class="n">DIM</span><span class="p">.</span><span class="nb">date</span> <span class="k">AS</span> <span class="n">first_visit_date</span><span class="p">,</span>
        <span class="n">DIM</span><span class="p">.</span><span class="nb">datetime</span> <span class="k">AS</span> <span class="n">first_visit_datetime</span><span class="p">,</span>
        <span class="n">TIMESTAMP_DIFF</span><span class="p">(</span>
            <span class="n">TIMESTAMP_TRUNC</span><span class="p">(</span><span class="n">FCT</span><span class="p">.</span><span class="nb">datetime</span><span class="p">,</span> <span class="n">HOUR</span><span class="p">),</span>
            <span class="n">TIMESTAMP_TRUNC</span><span class="p">(</span><span class="n">DIM</span><span class="p">.</span><span class="nb">datetime</span><span class="p">,</span> <span class="n">HOUR</span><span class="p">),</span>
            <span class="n">HOUR</span>
        <span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">AS</span> <span class="n">hours_from_first_visit</span><span class="p">,</span> <span class="c1">-- 1ë¶€í„° ì‹œì‘</span>
        <span class="n">TIMESTAMP_DIFF</span><span class="p">(</span>
            <span class="n">TIMESTAMP_TRUNC</span><span class="p">(</span><span class="n">FCT</span><span class="p">.</span><span class="nb">datetime</span><span class="p">,</span> <span class="k">DAY</span><span class="p">),</span>
            <span class="n">TIMESTAMP_TRUNC</span><span class="p">(</span><span class="n">DIM</span><span class="p">.</span><span class="nb">datetime</span><span class="p">,</span> <span class="k">DAY</span><span class="p">),</span>
            <span class="k">DAY</span>
        <span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">AS</span> <span class="n">days_from_first_visit</span> <span class="c1">-- 1ë¶€í„° ì‹œì‘</span>
    <span class="k">FROM</span>
        <span class="p">{</span><span class="o">%</span> <span class="n">if</span> <span class="n">is_incremental</span><span class="p">()</span> <span class="o">%</span><span class="p">}</span>
        <span class="n">CTE_events</span> <span class="n">FCT</span>
        <span class="p">{</span><span class="o">%</span> <span class="k">else</span> <span class="o">%</span><span class="p">}</span>
        <span class="n">CTE_events_raw</span> <span class="n">FCT</span> 
        <span class="p">{</span><span class="o">%</span> <span class="n">endif</span> <span class="o">%</span><span class="p">}</span>
    <span class="k">INNER</span> <span class="k">JOIN</span>
        <span class="n">CTE_first_visits_raw</span> <span class="n">DIM</span>
        <span class="k">ON</span> <span class="n">FCT</span><span class="p">.</span><span class="n">user_id</span> <span class="o">=</span> <span class="n">DIM</span><span class="p">.</span><span class="n">user_id</span>
</code></pre></div></div>

<h3 id="56-ë§ˆì§€ë§‰ìœ¼ë¡œ-ë‹¤ì‹œ-ì‚´í´ë³¼ê¹Œìš”">5.6. ë§ˆì§€ë§‰ìœ¼ë¡œ ë‹¤ì‹œ ì‚´í´ë³¼ê¹Œìš”?</h3>

<p><img src="/assets/2025-01-25-first-activation-data-mart/3.webp" alt="" /></p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">models</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">fact__first_activation_events</span>
    <span class="na">description</span><span class="pi">:</span> <span class="s">ì‚¬ìš©ìì˜ ìµœì´ˆ ì´ë²¤íŠ¸ ë‚´ì—­</span>
    <span class="na">meta</span><span class="pi">:</span>
      <span class="na">owner</span><span class="pi">:</span> <span class="s">ê¹€ì§„ì„</span>
    <span class="na">config</span><span class="pi">:</span>
      <span class="na">materialized</span><span class="pi">:</span> <span class="s">incremental</span>
      <span class="na">incremental_strategy</span><span class="pi">:</span> <span class="s">insert_overwrite</span>
      <span class="na">on_schema_change</span><span class="pi">:</span> <span class="s">append_new_columns</span>
      <span class="na">partition_by</span><span class="pi">:</span>
        <span class="na">field</span><span class="pi">:</span> <span class="s">date</span>
        <span class="na">data_type</span><span class="pi">:</span> <span class="s">date</span>
        <span class="na">granularity</span><span class="pi">:</span> <span class="s">day</span>
      <span class="na">time_ingestion_partitioning</span><span class="pi">:</span> <span class="kc">true</span>
      <span class="na">require_partition_filter</span><span class="pi">:</span> <span class="kc">false</span>
      <span class="na">copy_partitions</span><span class="pi">:</span> <span class="kc">true</span>
    <span class="na">columns</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">date</span>
        <span class="na">description</span><span class="pi">:</span> <span class="s">...</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">...</span>
        <span class="na">description</span><span class="pi">:</span> <span class="s">...</span>
</code></pre></div></div>

<h1 id="6-ëª¨ë¸ë§-í›„ê¸°ë¥¼-ì •ë¦¬í•´ë³¼ê²Œìš”">6. ëª¨ë¸ë§ í›„ê¸°ë¥¼ ì •ë¦¬í•´ë³¼ê²Œìš”.</h1>

<h3 id="61-ìš”êµ¬ì‚¬í•­ì„-ì˜-ì •ë¦¬í•´ì•¼-ì¢‹ì€-ë°ì´í„°-ë§ˆíŠ¸ë¥¼-ë§Œë“¤-ìˆ˜-ìˆì–´ìš”">6.1. ìš”êµ¬ì‚¬í•­ì„ ì˜ ì •ë¦¬í•´ì•¼, ì¢‹ì€ ë°ì´í„° ë§ˆíŠ¸ë¥¼ ë§Œë“¤ ìˆ˜ ìˆì–´ìš”.</h3>

<ul>
  <li>ì¢‹ì€ ë°ì´í„° ë§ˆíŠ¸ = ì—¬ëŸ¬ ë²ˆ ì§€ì†ì ìœ¼ë¡œ ì¨ë¨¹ì„ ìˆ˜ ìˆëŠ” ë°ì´í„° ë§ˆíŠ¸</li>
  <li>ìŠ¤ì¿¼ë“œì˜ í•µì‹¬ ì§€í‘œë¥¼ ì •í™•í•˜ê²Œ ì´í•´í•˜ê¸° ìœ„í•´, ìŠ¤ì¿¼ë“œ ë¦¬ë” ë¶„ê³¼ ìˆ˜ ì‹œê°„ ë™ì•ˆ ë§ì€ ì´ì•¼ê¸°ë¥¼ ë‚˜ëˆ´ì–´ìš”.
    <ul>
      <li>ì „í™˜ìœ¨ì˜ ì •ì˜ê°€ ì •í™•íˆ ì–´ë–»ê²Œ ë˜ëŠ”ê°€?</li>
      <li>í•µì‹¬ ì§€í‘œê°€ ì¶”í›„ ì–´ë–¤ ë°©í–¥ìœ¼ë¡œ ë³€ë™ë  ìˆ˜ ìˆëŠ”ê°€?</li>
    </ul>
  </li>
</ul>

<h3 id="62-ë°ì´í„°-ëª¨ë¸ë§ì€-ì´ë¡ -í•™ìŠµë§Œìœ¼ë¡œ-ì™„ì„±ë˜ì§€-ì•Šì•„ìš”">6.2. ë°ì´í„° ëª¨ë¸ë§ì€ ì´ë¡  í•™ìŠµë§Œìœ¼ë¡œ ì™„ì„±ë˜ì§€ ì•Šì•„ìš”.</h3>

<ul>
  <li>Kimball, Inmon ë“± DWHì— ëŒ€í•œ ì²´ê³„ì ì¸ ì´ë¡ ì´ ìˆì–´ìš”.</li>
  <li>í•˜ì§€ë§Œ, ê°€ì¥ ì¤‘ìš”í•œ ê±´ â€œë¬¸ì œ í•´ê²°ì— ë„ì›€ì´ ë˜ëŠ”ê°€?â€
    <ul>
      <li>ì¡°ì§ì˜ ë°ì´í„° í™œìš© ì„±í–¥, ë°ì´í„° íŠ¹ì„±, í•µì‹¬ ë¬¸ì œ</li>
    </ul>
  </li>
  <li><code class="language-plaintext highlighter-rouge">fact__first_activation_events</code> í…Œì´ë¸”ì€ ì´ë¡ ì— ê¸°ëŒ€ì–´ ë§Œë“  í…Œì´ë¸”ì´ ì•„ë‹ˆì—ìš”.
    <ul>
      <li>ì¡°ì§ì´ í•„ìš”í•´ì„œ DWH ì´ë¡ ì„ ì‘ìš©í•´ì„œ ë§Œë“  ê±°ì˜ˆìš”.</li>
    </ul>
  </li>
</ul>

<h1 id="7-ê°ì‚¬ì˜-ì¸ì‚¬ë¥¼-ë“œë ¤ìš”">7. ê°ì‚¬ì˜ ì¸ì‚¬ë¥¼ ë“œë ¤ìš”.</h1>

<h3 id="71-í† ìŠ¤ì¦ê¶Œì˜-dw-ì„¤ê³„-í›„ê¸°-ì˜ìƒì—ì„œ-ì˜ê°ì„-ì–»ì—ˆì–´ìš”">7.1. í† ìŠ¤ì¦ê¶Œì˜ â€œDW ì„¤ê³„ í›„ê¸°â€ ì˜ìƒì—ì„œ ì˜ê°ì„ ì–»ì—ˆì–´ìš”.</h3>

<blockquote>
  <p><a href="https://www.youtube.com/watch?v=MWDVBZycou4">í† ìŠ¤ã…£SLASH 24 - ì „ì²œí›„ ë°ì´í„° ë¶„ì„ì„ ìœ„í•œ DW ì„¤ê³„ ë° ìš´ì˜í•˜ê¸°</a></p>
</blockquote>

<ul>
  <li>ì‚¬ìš©ì í™œì„±í™” ì •ë³´ë¥¼ ì ì¬í•˜ëŠ” íë¦„ì„ íŒŒì•…í•˜ëŠ” ë° ì¤‘ìš”í•œ ë‹¨ì„œë¥¼ ì–»ì—ˆì–´ìš”.</li>
</ul>

<h3 id="72-ìŠ¤ì¿¼ë“œ-ë¦¬ë”-ë¶„ê»˜-ì •ë§-ê°ì‚¬-ë“œë ¤ìš”">7.2. ìŠ¤ì¿¼ë“œ ë¦¬ë” ë¶„ê»˜ ì •ë§ ê°ì‚¬ ë“œë ¤ìš”.</h3>

<ul>
  <li>í•µì‹¬ ì§€í‘œ ë°ì´í„°ë¥¼ ì˜ ì œê³µí•´ë“œë¦¬ê¸° ìœ„í•œ ì €ì˜ ê¶ê¸ˆì¦ì„ ì ê·¹ì ìœ¼ë¡œ í’€ì–´ì£¼ì…¨ì–´ìš”.
    <ul>
      <li>ë¹„ì¦ˆë‹ˆìŠ¤ ëª©í‘œë¥¼ ì˜ ì¡°ë§í•  ìˆ˜ ìˆë„ë¡ ì—¬ëŸ¬ëª¨ë¡œ ë°°ê²½ì„ ì˜ ì•Œë ¤ì£¼ì…¨ì–´ìš”.</li>
      <li>í•µì‹¬ ì§€í‘œë¥¼ í•¨ê»˜ ê¼¼ê¼¼í•˜ê²Œ ì •ëŸ‰í™”í•´ì£¼ì…¨ì–´ìš”.</li>
    </ul>
  </li>
  <li>ë°ì´í„°ìŸì´ê°€ ì¡°ì§ì˜ ëª©í‘œì— ì˜ ì‹±í¬ì—…í•˜ëŠ” ëˆˆì„ ê¸°ë¥¼ ìˆ˜ ìˆë„ë¡ ê°•ë„ ë†’ì€ íŠ¸ë ˆì´ë‹ì„ í•´ì£¼ì…”ì„œ ì§„ì‹¬ìœ¼ë¡œ ê°ì‚¬ ë“œë¦½ë‹ˆë‹¤.</li>
</ul>

<hr />

<h2 id="published-by-joshua-kim"><em>Published by</em> Joshua Kim</h2>

<p><img src="/assets/profile/joshua-profile.png" alt="Joshua Kim" /></p>]]></content><author><name></name></author><category term="Language (Korean)" /><category term="Article (Project)" /><category term="Level (2. Intermediate)" /><category term="Field (Analytics Engineering)" /><category term="Skills (SQL)" /><category term="Skills (dbt)" /><summary type="html"><![CDATA[â€œì‹ ê·œ ì‚¬ìš©ì í™œì„± ì „í™˜ìœ¨ ì§€í‘œë¥¼ íš¨ê³¼ì ìœ¼ë¡œ ì œê³µí•˜ê¸° ìœ„í•´ ë°ì´í„° ë§ˆíŠ¸ë¥¼ ì§ì ‘ ì„¤ê³„í•˜ê³  êµ¬ì¶•í•œ ê²½í—˜ì„ ì •ë¦¬í–ˆìŠµë‹ˆë‹¤. ë¹„ì¦ˆë‹ˆìŠ¤ ìš”êµ¬ì‚¬í•­ ë³€í™”ì— ìœ ì—°í•˜ê²Œ ëŒ€ì‘í•  ìˆ˜ ìˆë„ë¡ ë°ì´í„° ëª¨ë¸ì„ ì„¤ê³„í–ˆê³ , ì‹¤ë¬´ì—ì„œ ë°”ë¡œ í™œìš© ê°€ëŠ¥í•œ ì¿¼ë¦¬ì™€ êµ¬ì¡°ë¥¼ ê³ ë¯¼í–ˆìŠµë‹ˆë‹¤. ì´ ê³¼ì •ì„ í†µí•´ ë°ì´í„° ëª¨ë¸ë§ ì´ë¡ ì„ ì‹¤ì œ ë¬¸ì œ í•´ê²°ì— ì ìš©í•˜ëŠ” ì—­ëŸ‰ê³¼, ìš”êµ¬ì‚¬í•­ì„ ê¹Šì´ ìˆê²Œ íŒŒì•…í•˜ëŠ” ì¤‘ìš”ì„±ì„ ë‹¤ì‹œ í•œ ë²ˆ ì²´ê°í•  ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤.â€]]></summary></entry><entry><title type="html">Data Mart Modeling Review (First Activation Funnel Metrics)</title><link href="http://localhost:4000/first-activation-data-mart-en/" rel="alternate" type="text/html" title="Data Mart Modeling Review (First Activation Funnel Metrics)" /><published>2025-01-25T00:00:00+09:00</published><updated>2025-01-25T00:00:00+09:00</updated><id>http://localhost:4000/first-activation-data-mart-en</id><content type="html" xml:base="http://localhost:4000/first-activation-data-mart-en/"><![CDATA[<blockquote>
  <p>â€œThis post summarizes my experience designing and building a data mart to effectively provide new user activation conversion metrics. I designed the data model to flexibly respond to changing business requirements, and focused on queries and structures that are immediately applicable in practice. Through this process, I was able to apply data modeling theory to real-world problem solving and once again realized the importance of deeply understanding requirements.â€</p>
</blockquote>

<p><img src="/assets/2025-01-25-first-activation-data-mart/3.webp" alt="" /></p>

<hr />

<h1 id="table-of-contents">Table of Contents</h1>
<ol>
  <li><strong>The Squad Organization Was Launched!</strong>
    <ul>
      <li>1.1. Background</li>
      <li>1.2. Core Metrics of the Squad</li>
      <li>1.3. What the Data Analyst Needs to Do</li>
    </ul>
  </li>
  <li><strong>What I Needed to Do</strong>
    <ul>
      <li>2.1. Reflecting on the Core Metrics</li>
      <li>2.2. Letâ€™s Build a Data Mart!</li>
    </ul>
  </li>
  <li><strong>A Preview of the Data Mart</strong>
    <ul>
      <li>3.1. <code class="language-plaintext highlighter-rouge">dim__users</code></li>
      <li>3.2. <code class="language-plaintext highlighter-rouge">fact__first_activation_events</code></li>
      <li>3.3. Example Records</li>
      <li>3.4. Key Features</li>
    </ul>
  </li>
  <li><strong>Example Queries</strong>
    <ul>
      <li>4.1. Designed for Usability</li>
      <li>4.2. Beginner Query</li>
      <li>4.3. Intermediate Query</li>
      <li>4.4. Advanced Query</li>
    </ul>
  </li>
  <li><strong>How the Modeling Was Done</strong>
    <ul>
      <li>5.1. [STEP 1] Load the Entire <code class="language-plaintext highlighter-rouge">dim__users</code> Table</li>
      <li>5.2. [STEP 2] Keep Only New <code class="language-plaintext highlighter-rouge">first_visit</code> Data</li>
      <li>5.3. [STEP 3] Incrementally Load the <code class="language-plaintext highlighter-rouge">fact__events</code> Table</li>
      <li>5.4. [STEP 4] Keep Only New First Key Events</li>
      <li>5.5. [STEP 5] Combine and Insert New <code class="language-plaintext highlighter-rouge">first_visit</code> and First Key Events Data</li>
      <li>5.6. Final Review</li>
    </ul>
  </li>
  <li><strong>Modeling Review</strong>
    <ul>
      <li>6.1. Good Requirement Gathering Leads to Good Data Marts</li>
      <li>6.2. Data Modeling Is Not Complete with Theory Alone</li>
    </ul>
  </li>
  <li><strong>Acknowledgements</strong>
    <ul>
      <li>7.1. Inspired by Toss Securitiesâ€™ â€œDW Design Reviewâ€ Video</li>
      <li>7.2. Special Thanks to the Squad Leader</li>
    </ul>
  </li>
</ol>

<hr />

<h1 id="1-the-squad-organization-was-launched">1. The Squad Organization Was Launched!</h1>

<h3 id="11-background">1.1. Background</h3>

<blockquote>
  <p>Letâ€™s focus not just on user acquisition, but on product improvements and marketing activities that lock in new users!</p>
</blockquote>

<h3 id="12-core-metrics-of-the-squad">1.2. Core Metrics of the Squad</h3>

<blockquote>
  <p>â€œLetâ€™s increase the <strong>conversion rate of users who perform Key Event 1 within 1 day after their first visit, and Key Event 2 within 7 days</strong>!â€</p>
</blockquote>

<p><img src="/assets/2025-01-25-first-activation-data-mart/1.webp" alt="" /></p>

<p><img src="/assets/2025-01-25-first-activation-data-mart/2.webp" alt="" /></p>

<h3 id="13-what-the-data-analyst-needs-to-do">1.3. What the Data Analyst Needs to Do</h3>

<blockquote>
  <p>â€œPlease prepare the data so that we can thoroughly analyze the core metrics and provide them via dashboard.â€</p>
</blockquote>

<h1 id="2-what-i-needed-to-do">2. What I Needed to Do</h1>

<h3 id="21-reflecting-on-the-core-metrics">2.1. Reflecting on the Core Metrics</h3>

<ul>
  <li>The sequence of First Visit - Key Event 1 - Key Event 2 is clear.</li>
  <li>Only conversions within the maximum conversion period are recognized.</li>
  <li>Conversion rates are measured on a user basis.</li>
  <li>The squadâ€™s core metrics may change in the future: Key Events and maximum conversion periods.</li>
</ul>

<h3 id="22-lets-build-a-data-mart">2.2. Letâ€™s Build a Data Mart!</h3>

<ul>
  <li>Running queries directly on the Core Layerâ€™s <code class="language-plaintext highlighter-rouge">fact__events</code> would be too complex and costly.</li>
  <li>With the possibility of changes in core metrics, it would be difficult to control query accuracy and delivery.</li>
</ul>

<h1 id="3-a-preview-of-the-data-mart">3. A Preview of the Data Mart</h1>

<h3 id="31-dim__users">3.1. <code class="language-plaintext highlighter-rouge">dim__users</code></h3>

<ul>
  <li>Already managed as a conformed dimension in the Core Layer.</li>
  <li>SCD Type 1 (only the latest value is kept, no historical values).</li>
</ul>

<table>
  <thead>
    <tr>
      <th><strong>Column</strong></th>
      <th><strong>Description</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">user_id</code></td>
      <td>User ID</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">first_date</code></td>
      <td>First visit date</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">first_datetime</code></td>
      <td>First visit datetime</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">country</code></td>
      <td>Most recent country</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">device_os</code></td>
      <td>Most recent device OS</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">app_version</code></td>
      <td>Most recent app version</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">first_campaign</code></td>
      <td>UTM Campaign at first visit</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">first_medium</code></td>
      <td>UTM Medium at first visit</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">first_source</code></td>
      <td>UTM Source at first visit</td>
    </tr>
    <tr>
      <td>â€¦</td>
      <td>â€¦</td>
    </tr>
  </tbody>
</table>

<h3 id="32-fact__first_activation_events">3.2. <code class="language-plaintext highlighter-rouge">fact__first_activation_events</code></h3>

<ul>
  <li>This is a newly created table for this data mart.</li>
  <li>Only the first events for each user are stored.</li>
</ul>

<table>
  <thead>
    <tr>
      <th><strong>Column</strong></th>
      <th><strong>Description</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">date</code></td>
      <td>Date of first event occurrence</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">datetime</code></td>
      <td>Datetime of first event occurrence</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">user_id</code></td>
      <td>User ID</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">event_name</code></td>
      <td>Event name</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">first_visit_date</code></td>
      <td>Userâ€™s first visit date</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">first_visit_datetime</code></td>
      <td>Userâ€™s first visit datetime</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">hours_from_first_visit</code></td>
      <td>Hours elapsed from first visit to first event</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">days_from_first_visit</code></td>
      <td>Days elapsed from first visit to first event</td>
    </tr>
  </tbody>
</table>

<h3 id="33-example-records">3.3. Example Records</h3>

<ul>
  <li>If the <code class="language-plaintext highlighter-rouge">fact__events</code> table looks like this for user Jinseok:</li>
</ul>

<table>
  <thead>
    <tr>
      <th><strong>date</strong></th>
      <th><strong>datetime</strong></th>
      <th><strong>user_id</strong></th>
      <th><strong>event_name</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>2025-01-01</td>
      <td>2025-01-01 01:00:00</td>
      <td>Jinseok</td>
      <td><code class="language-plaintext highlighter-rouge">first_visit</code></td>
    </tr>
    <tr>
      <td>2025-01-01</td>
      <td>2025-01-01 01:01:00</td>
      <td>Jinseok</td>
      <td><code class="language-plaintext highlighter-rouge">add_to_cart</code></td>
    </tr>
    <tr>
      <td>2025-01-02</td>
      <td>2025-01-02 01:00:00</td>
      <td>Jinseok</td>
      <td><code class="language-plaintext highlighter-rouge">add_to_cart</code></td>
    </tr>
    <tr>
      <td>2025-01-02</td>
      <td>2025-01-02 01:01:00</td>
      <td>Jinseok</td>
      <td><code class="language-plaintext highlighter-rouge">purchase</code></td>
    </tr>
  </tbody>
</table>

<ul>
  <li>The <code class="language-plaintext highlighter-rouge">fact__first_activation_events</code> table would be constructed as follows, keeping only the first events and adding necessary columns:</li>
</ul>

<table>
  <thead>
    <tr>
      <th><strong>date</strong></th>
      <th><strong>datetime</strong></th>
      <th><strong>user_id</strong></th>
      <th><strong>event_name</strong></th>
      <th><strong>first_visit_date</strong></th>
      <th><strong>first_visit_datetime</strong></th>
      <th><strong>hours_from_first_visit</strong></th>
      <th><strong>days_from_first_visit</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>2025-01-01</td>
      <td>2025-01-01 01:00:00</td>
      <td>Jinseok</td>
      <td><code class="language-plaintext highlighter-rouge">first_visit</code></td>
      <td>2025-01-01</td>
      <td>2025-01-01 01:00:00</td>
      <td>1</td>
      <td>1</td>
    </tr>
    <tr>
      <td>2025-01-01</td>
      <td>2025-01-01 01:01:00</td>
      <td>Jinseok</td>
      <td><code class="language-plaintext highlighter-rouge">add_to_cart</code></td>
      <td>2025-01-01</td>
      <td>2025-01-01 01:00:00</td>
      <td>1</td>
      <td>1</td>
    </tr>
    <tr>
      <td>2025-01-02</td>
      <td>2025-01-02 01:01:00</td>
      <td>Jinseok</td>
      <td><code class="language-plaintext highlighter-rouge">purchase</code></td>
      <td>2025-01-01</td>
      <td>2025-01-01 01:00:00</td>
      <td>25</td>
      <td>2</td>
    </tr>
  </tbody>
</table>

<h3 id="34-key-features">3.4. Key Features</h3>

<ul>
  <li>This is a transaction fact table (since <code class="language-plaintext highlighter-rouge">user_id</code> is present, you can easily filter dimensions via <code class="language-plaintext highlighter-rouge">dim__users</code>).</li>
  <li>The grain is the combination of <code class="language-plaintext highlighter-rouge">user_id</code> and <code class="language-plaintext highlighter-rouge">event_name</code> (only the first event for each user is stored).</li>
  <li>Conversion period information is stored as a pre-calculated non-additive fact (so you donâ€™t need to use joins or window functions later).</li>
</ul>

<h1 id="4-example-queries">4. Example Queries</h1>

<h3 id="41-designed-for-usability">4.1. Designed for Usability</h3>

<ul>
  <li>If the core metricâ€™s Key Event changes? â†’ Just modify the <code class="language-plaintext highlighter-rouge">event_name</code> part.</li>
  <li>If the maximum conversion period changes? â†’ Just modify the <code class="language-plaintext highlighter-rouge">hours_from_first_visit</code> or <code class="language-plaintext highlighter-rouge">days_from_first_visit</code> part.</li>
  <li>Need to filter by user attributes? â†’ Just join with <code class="language-plaintext highlighter-rouge">dim__users</code>.</li>
</ul>

<h3 id="42-beginner-query">4.2. Beginner Query</h3>

<ul>
  <li>â˜ğŸ» Show the trend of users who converted via <code class="language-plaintext highlighter-rouge">key_event_1</code> (regardless of conversion period).</li>
</ul>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">SELECT</span>
        <span class="nb">date</span><span class="p">,</span>
        <span class="k">COUNT</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="k">AS</span> <span class="n">users_cnt</span>
    <span class="k">FROM</span>
        <span class="n">fact__first_activation_events</span>
    <span class="k">WHERE</span> <span class="k">TRUE</span>
        <span class="k">AND</span> <span class="n">event_name</span> <span class="o">=</span> <span class="s1">'key_event_1'</span>
    <span class="k">GROUP</span> <span class="k">BY</span>
        <span class="mi">1</span>
    <span class="k">ORDER</span> <span class="k">BY</span>
        <span class="mi">1</span>
</code></pre></div></div>

<h3 id="43-intermediate-query">4.3. Intermediate Query</h3>

<ul>
  <li>â˜ğŸ» Show the trend of conversion rates for users who performed <code class="language-plaintext highlighter-rouge">key_event_1</code> within 1 day of <code class="language-plaintext highlighter-rouge">first_visit</code>.</li>
</ul>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">SELECT</span>
        <span class="n">first_visit_date</span> <span class="k">AS</span> <span class="n">cohort_date</span><span class="p">,</span>
        <span class="k">COUNT</span><span class="p">(</span><span class="k">CASE</span> <span class="k">WHEN</span> <span class="n">event_name</span> <span class="o">=</span> <span class="s1">'first_visit'</span> <span class="k">THEN</span> <span class="mi">1</span> <span class="k">END</span><span class="p">)</span> <span class="k">AS</span> <span class="n">first_visit</span><span class="p">,</span>
        <span class="k">COUNT</span><span class="p">(</span><span class="k">CASE</span> <span class="k">WHEN</span> <span class="n">event_name</span> <span class="o">=</span> <span class="s1">'key_event_1'</span> <span class="k">THEN</span> <span class="mi">1</span> <span class="k">END</span><span class="p">)</span> <span class="k">AS</span> <span class="n">key_event_1</span>
    <span class="k">FROM</span>
        <span class="n">fact__first_activation_events</span>
    <span class="k">WHERE</span> <span class="k">TRUE</span>
        <span class="k">AND</span> <span class="p">(</span>
            <span class="n">event_name</span> <span class="o">=</span> <span class="s1">'first_visit'</span>
            <span class="k">OR</span> <span class="p">(</span><span class="n">event_name</span> <span class="o">=</span> <span class="s1">'key_event_1'</span> <span class="k">AND</span> <span class="n">days_from_first_visit</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="k">GROUP</span> <span class="k">BY</span>
        <span class="mi">1</span>
    <span class="k">ORDER</span> <span class="k">BY</span>
        <span class="mi">1</span>
</code></pre></div></div>

<ul>
  <li>â˜ğŸ» (Squadâ€™s core metric) Show the trend of conversion rates for users who performed <code class="language-plaintext highlighter-rouge">key_event_1</code> within 1 day and <code class="language-plaintext highlighter-rouge">key_event_2</code> within 7 days of <code class="language-plaintext highlighter-rouge">first_visit</code>.</li>
</ul>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">SELECT</span>
        <span class="n">first_visit_date</span> <span class="k">AS</span> <span class="n">cohort_date</span><span class="p">,</span>
        <span class="k">COUNT</span><span class="p">(</span><span class="k">CASE</span> <span class="k">WHEN</span> <span class="n">event_name</span> <span class="o">=</span> <span class="s1">'first_visit'</span> <span class="k">THEN</span> <span class="mi">1</span> <span class="k">END</span><span class="p">)</span> <span class="k">AS</span> <span class="n">first_visit</span><span class="p">,</span>
        <span class="k">COUNT</span><span class="p">(</span><span class="k">CASE</span> <span class="k">WHEN</span> <span class="n">event_name</span> <span class="o">=</span> <span class="s1">'key_event_1'</span> <span class="k">THEN</span> <span class="mi">1</span> <span class="k">END</span><span class="p">)</span> <span class="k">AS</span> <span class="n">key_event_1</span><span class="p">,</span>
        <span class="k">COUNT</span><span class="p">(</span><span class="k">CASE</span> <span class="k">WHEN</span> <span class="n">event_name</span> <span class="o">=</span> <span class="s1">'key_event_2'</span> <span class="k">THEN</span> <span class="mi">1</span> <span class="k">END</span><span class="p">)</span> <span class="k">AS</span> <span class="n">key_event_2</span>
    <span class="k">FROM</span>
        <span class="n">fact__first_activation_events</span>
    <span class="k">WHERE</span> <span class="k">TRUE</span>
        <span class="k">AND</span> <span class="p">(</span>
            <span class="n">event_name</span> <span class="o">=</span> <span class="s1">'first_visit'</span>
            <span class="k">OR</span> <span class="p">(</span><span class="n">event_name</span> <span class="o">=</span> <span class="s1">'key_event_1'</span> <span class="k">AND</span> <span class="n">days_from_first_visit</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">OR</span> <span class="p">(</span><span class="n">event_name</span> <span class="o">=</span> <span class="s1">'key_event_2'</span> <span class="k">AND</span> <span class="n">days_from_first_visit</span> <span class="o">&lt;=</span> <span class="mi">7</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="k">GROUP</span> <span class="k">BY</span>
        <span class="mi">1</span>
    <span class="k">ORDER</span> <span class="k">BY</span>
        <span class="mi">1</span>
</code></pre></div></div>

<h3 id="44-advanced-query">4.4. Advanced Query</h3>

<ul>
  <li>â˜ğŸ» Show the trend of conversion rates for US users who performed <code class="language-plaintext highlighter-rouge">key_event_1</code> within 1 day and <code class="language-plaintext highlighter-rouge">key_event_2</code> within 7 days of <code class="language-plaintext highlighter-rouge">first_visit</code>.</li>
</ul>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">SELECT</span>
        <span class="n">FACT</span><span class="p">.</span><span class="n">first_visit_date</span> <span class="k">AS</span> <span class="n">cohort_date</span><span class="p">,</span>
        <span class="k">COUNT</span><span class="p">(</span><span class="k">CASE</span> <span class="k">WHEN</span> <span class="n">FACT</span><span class="p">.</span><span class="n">event_name</span> <span class="o">=</span> <span class="s1">'first_visit'</span> <span class="k">THEN</span> <span class="mi">1</span> <span class="k">END</span><span class="p">)</span> <span class="k">AS</span> <span class="n">first_visit</span><span class="p">,</span>
        <span class="k">COUNT</span><span class="p">(</span><span class="k">CASE</span> <span class="k">WHEN</span> <span class="n">FACT</span><span class="p">.</span><span class="n">event_name</span> <span class="o">=</span> <span class="s1">'key_event_1'</span> <span class="k">THEN</span> <span class="mi">1</span> <span class="k">END</span><span class="p">)</span> <span class="k">AS</span> <span class="n">key_event_1</span><span class="p">,</span>
        <span class="k">COUNT</span><span class="p">(</span><span class="k">CASE</span> <span class="k">WHEN</span> <span class="n">FACT</span><span class="p">.</span><span class="n">event_name</span> <span class="o">=</span> <span class="s1">'key_event_2'</span> <span class="k">THEN</span> <span class="mi">1</span> <span class="k">END</span><span class="p">)</span> <span class="k">AS</span> <span class="n">key_event_2</span>
    <span class="k">FROM</span>
        <span class="n">fact__first_activation_events</span> <span class="n">FACT</span>
    <span class="k">LEFT</span> <span class="k">JOIN</span>
        <span class="n">dim__users</span> <span class="n">DIM</span>
        <span class="k">ON</span> <span class="n">FACT</span><span class="p">.</span><span class="n">user_id</span> <span class="o">=</span> <span class="n">DIM</span><span class="p">.</span><span class="n">user_id</span>
    <span class="k">WHERE</span> <span class="k">TRUE</span>
        <span class="k">AND</span> <span class="n">DIM</span><span class="p">.</span><span class="n">country</span> <span class="o">=</span> <span class="s1">'United States'</span>
        <span class="k">AND</span> <span class="p">(</span>
            <span class="n">FACT</span><span class="p">.</span><span class="n">event_name</span> <span class="o">=</span> <span class="s1">'first_visit'</span>
            <span class="k">OR</span> <span class="p">(</span><span class="n">FACT</span><span class="p">.</span><span class="n">event_name</span> <span class="o">=</span> <span class="s1">'key_event_1'</span> <span class="k">AND</span> <span class="n">FACT</span><span class="p">.</span><span class="n">days_from_first_visit</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">OR</span> <span class="p">(</span><span class="n">FACT</span><span class="p">.</span><span class="n">event_name</span> <span class="o">=</span> <span class="s1">'key_event_2'</span> <span class="k">AND</span> <span class="n">FACT</span><span class="p">.</span><span class="n">days_from_first_visit</span> <span class="o">&lt;=</span> <span class="mi">7</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="k">GROUP</span> <span class="k">BY</span>
        <span class="mi">1</span>
    <span class="k">ORDER</span> <span class="k">BY</span>
        <span class="mi">1</span>
</code></pre></div></div>

<h1 id="5-how-the-modeling-was-done">5. How the Modeling Was Done</h1>

<p><img src="/assets/2025-01-25-first-activation-data-mart/3.webp" alt="" /></p>

<h3 id="51-step-1-load-the-entire-dim__users-table">5.1. [STEP 1] Load the Entire <code class="language-plaintext highlighter-rouge">dim__users</code> Table</h3>

<p><img src="/assets/2025-01-25-first-activation-data-mart/4.webp" alt="" /></p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">WITH</span>
    <span class="n">CTE_first_visits_raw</span> <span class="k">AS</span> <span class="p">(</span>
        <span class="k">SELECT</span>
            <span class="n">user_id</span><span class="p">,</span>
            <span class="n">first_date</span> <span class="k">AS</span> <span class="nb">date</span><span class="p">,</span>
            <span class="n">first_datetime</span> <span class="k">AS</span> <span class="nb">datetime</span>
        <span class="k">FROM</span>
            <span class="p">{{</span> <span class="k">ref</span><span class="p">(</span><span class="s1">'dim__users'</span><span class="p">)</span> <span class="p">}}</span>
    <span class="p">),</span>	
</code></pre></div></div>

<h3 id="52-step-2-keep-only-new-first_visit-data">5.2. [STEP 2] Keep Only New <code class="language-plaintext highlighter-rouge">first_visit</code> Data</h3>

<p><img src="/assets/2025-01-25-first-activation-data-mart/5.webp" alt="" /></p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="p">{</span><span class="o">%</span> <span class="n">if</span> <span class="n">is_incremental</span><span class="p">()</span> <span class="o">%</span><span class="p">}</span>

    <span class="n">CTE_first_visits</span> <span class="k">AS</span> <span class="p">(</span>
        <span class="k">SELECT</span>
            <span class="n">SRC</span><span class="p">.</span><span class="n">user_id</span><span class="p">,</span>
            <span class="n">SRC</span><span class="p">.</span><span class="nb">date</span><span class="p">,</span>
            <span class="n">SRC</span><span class="p">.</span><span class="nb">datetime</span>
        <span class="k">FROM</span>
            <span class="n">CTE_first_visits_raw</span> <span class="n">SRC</span>
        <span class="k">LEFT</span> <span class="k">JOIN</span> 
            <span class="p">{{</span> <span class="n">this</span> <span class="p">}}</span> <span class="k">EXISTING</span>
            <span class="k">ON</span> <span class="n">SRC</span><span class="p">.</span><span class="n">user_id</span> <span class="o">=</span> <span class="k">EXISTING</span><span class="p">.</span><span class="n">user_id</span>
            <span class="k">AND</span> <span class="k">EXISTING</span><span class="p">.</span><span class="n">event_name</span> <span class="o">=</span> <span class="s1">'first_visit'</span>
        <span class="k">WHERE</span> <span class="k">TRUE</span>
            <span class="k">AND</span> <span class="k">EXISTING</span><span class="p">.</span><span class="n">user_id</span> <span class="k">IS</span> <span class="k">NULL</span>
    <span class="p">),</span>

    <span class="p">{</span><span class="o">%</span> <span class="n">endif</span> <span class="o">%</span><span class="p">}</span>
</code></pre></div></div>

<h3 id="53-step-3-incrementally-load-the-fact__events-table">5.3. [STEP 3] Incrementally Load the <code class="language-plaintext highlighter-rouge">fact__events</code> Table</h3>

<p><img src="/assets/2025-01-25-first-activation-data-mart/6.webp" alt="" /></p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="n">CTE_events_raw</span> <span class="k">AS</span> <span class="p">(</span>
        <span class="k">SELECT</span>
            <span class="n">user_id</span><span class="p">,</span>
            <span class="n">event_name</span><span class="p">,</span>
            <span class="k">MIN</span><span class="p">(</span><span class="nb">date</span><span class="p">)</span> <span class="k">AS</span> <span class="nb">date</span><span class="p">,</span>
            <span class="k">MIN</span><span class="p">(</span><span class="nb">datetime</span><span class="p">)</span> <span class="k">AS</span> <span class="nb">datetime</span>
        <span class="k">FROM</span>
            <span class="p">{{</span> <span class="k">ref</span><span class="p">(</span><span class="s1">'fact__events'</span><span class="p">)</span> <span class="p">}}</span>
        <span class="k">WHERE</span> <span class="k">TRUE</span>
            <span class="p">{</span><span class="o">%</span> <span class="n">if</span> <span class="n">is_incremental</span><span class="p">()</span> <span class="o">%</span><span class="p">}</span>
            <span class="k">AND</span> <span class="nb">datetime</span> <span class="o">&gt;</span> <span class="p">(</span><span class="k">SELECT</span> <span class="k">MAX</span><span class="p">(</span><span class="nb">datetime</span><span class="p">)</span> <span class="k">FROM</span> <span class="p">{{</span> <span class="n">this</span> <span class="p">}})</span>
            <span class="p">{</span><span class="o">%</span> <span class="n">endif</span> <span class="o">%</span><span class="p">}</span>
            <span class="k">AND</span> <span class="n">event_name</span> <span class="k">IN</span> <span class="p">(</span>
                <span class="s1">'Key Event 1'</span><span class="p">,</span>
                <span class="s1">'Key Event 2'</span><span class="p">,</span>
                <span class="p">...</span>
            <span class="p">)</span>
        <span class="k">GROUP</span> <span class="k">BY</span>
            <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span>
    <span class="p">)</span>
</code></pre></div></div>

<h3 id="54-step-4-keep-only-new-first-key-events">5.4. [STEP 4] Keep Only New First Key Events</h3>

<p><img src="/assets/2025-01-25-first-activation-data-mart/7.webp" alt="" /></p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="p">{</span><span class="o">%</span> <span class="n">if</span> <span class="n">is_incremental</span><span class="p">()</span> <span class="o">%</span><span class="p">}</span>
    <span class="p">,</span>

    <span class="n">CTE_events</span> <span class="k">AS</span> <span class="p">(</span>
        <span class="k">SELECT</span>
            <span class="n">SRC</span><span class="p">.</span><span class="o">*</span>
        <span class="k">FROM</span>
            <span class="n">CTE_events_raw</span> <span class="n">SRC</span>
        <span class="k">LEFT</span> <span class="k">JOIN</span> 
            <span class="p">{{</span> <span class="n">this</span> <span class="p">}}</span> <span class="k">EXISTING</span>
            <span class="k">ON</span> <span class="n">SRC</span><span class="p">.</span><span class="n">user_id</span> <span class="o">=</span> <span class="k">EXISTING</span><span class="p">.</span><span class="n">user_id</span>
            <span class="k">AND</span> <span class="n">SRC</span><span class="p">.</span><span class="n">event_name</span> <span class="o">=</span> <span class="k">EXISTING</span><span class="p">.</span><span class="n">event_name</span>
        <span class="k">WHERE</span> <span class="k">TRUE</span>
            <span class="k">AND</span> <span class="k">EXISTING</span><span class="p">.</span><span class="n">user_id</span> <span class="k">IS</span> <span class="k">NULL</span>
            <span class="k">AND</span> <span class="k">EXISTING</span><span class="p">.</span><span class="n">event_name</span> <span class="k">IS</span> <span class="k">NULL</span>
    <span class="p">)</span>

    <span class="p">{</span><span class="o">%</span> <span class="n">endif</span> <span class="o">%</span><span class="p">}</span>
</code></pre></div></div>

<h3 id="55-step-5-combine-and-insert-new-first_visit-and-first-key-events-data">5.5. [STEP 5] Combine and Insert New <code class="language-plaintext highlighter-rouge">first_visit</code> and First Key Events Data</h3>

<p><img src="/assets/2025-01-25-first-activation-data-mart/8.webp" alt="" /></p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">SELECT</span>
        <span class="nb">date</span><span class="p">,</span>
        <span class="nb">datetime</span><span class="p">,</span>
        <span class="n">user_id</span><span class="p">,</span>
        <span class="s1">'first_visit'</span> <span class="k">AS</span> <span class="n">event_name</span><span class="p">,</span>
        <span class="nb">date</span> <span class="k">AS</span> <span class="n">first_visit_date</span><span class="p">,</span>
        <span class="nb">datetime</span> <span class="k">AS</span> <span class="n">first_visit_datetime</span><span class="p">,</span>
        <span class="k">NULL</span> <span class="k">AS</span> <span class="n">hours_from_first_visit</span><span class="p">,</span>
        <span class="k">NULL</span> <span class="k">AS</span> <span class="n">days_from_first_visit</span>
    <span class="k">FROM</span>
        <span class="p">{</span><span class="o">%</span> <span class="n">if</span> <span class="n">is_incremental</span><span class="p">()</span> <span class="o">%</span><span class="p">}</span>
        <span class="n">CTE_first_visits</span>
        <span class="p">{</span><span class="o">%</span> <span class="k">else</span> <span class="o">%</span><span class="p">}</span>
        <span class="n">CTE_first_visits_raw</span>
        <span class="p">{</span><span class="o">%</span> <span class="n">endif</span> <span class="o">%</span><span class="p">}</span>

    <span class="k">UNION</span> <span class="k">ALL</span>

    <span class="k">SELECT</span>
        <span class="n">FCT</span><span class="p">.</span><span class="nb">date</span><span class="p">,</span>
        <span class="n">FCT</span><span class="p">.</span><span class="nb">datetime</span><span class="p">,</span>
        <span class="n">FCT</span><span class="p">.</span><span class="n">user_id</span><span class="p">,</span>
        <span class="n">FCT</span><span class="p">.</span><span class="n">event_name</span><span class="p">,</span>
        <span class="n">DIM</span><span class="p">.</span><span class="nb">date</span> <span class="k">AS</span> <span class="n">first_visit_date</span><span class="p">,</span>
        <span class="n">DIM</span><span class="p">.</span><span class="nb">datetime</span> <span class="k">AS</span> <span class="n">first_visit_datetime</span><span class="p">,</span>
        <span class="n">TIMESTAMP_DIFF</span><span class="p">(</span>
            <span class="n">TIMESTAMP_TRUNC</span><span class="p">(</span><span class="n">FCT</span><span class="p">.</span><span class="nb">datetime</span><span class="p">,</span> <span class="n">HOUR</span><span class="p">),</span>
            <span class="n">TIMESTAMP_TRUNC</span><span class="p">(</span><span class="n">DIM</span><span class="p">.</span><span class="nb">datetime</span><span class="p">,</span> <span class="n">HOUR</span><span class="p">),</span>
            <span class="n">HOUR</span>
        <span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">AS</span> <span class="n">hours_from_first_visit</span><span class="p">,</span> <span class="c1">-- Starts from 1</span>
        <span class="n">TIMESTAMP_DIFF</span><span class="p">(</span>
            <span class="n">TIMESTAMP_TRUNC</span><span class="p">(</span><span class="n">FCT</span><span class="p">.</span><span class="nb">datetime</span><span class="p">,</span> <span class="k">DAY</span><span class="p">),</span>
            <span class="n">TIMESTAMP_TRUNC</span><span class="p">(</span><span class="n">DIM</span><span class="p">.</span><span class="nb">datetime</span><span class="p">,</span> <span class="k">DAY</span><span class="p">),</span>
            <span class="k">DAY</span>
        <span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">AS</span> <span class="n">days_from_first_visit</span> <span class="c1">-- Starts from 1</span>
    <span class="k">FROM</span>
        <span class="p">{</span><span class="o">%</span> <span class="n">if</span> <span class="n">is_incremental</span><span class="p">()</span> <span class="o">%</span><span class="p">}</span>
        <span class="n">CTE_events</span> <span class="n">FCT</span>
        <span class="p">{</span><span class="o">%</span> <span class="k">else</span> <span class="o">%</span><span class="p">}</span>
        <span class="n">CTE_events_raw</span> <span class="n">FCT</span> 
        <span class="p">{</span><span class="o">%</span> <span class="n">endif</span> <span class="o">%</span><span class="p">}</span>
    <span class="k">INNER</span> <span class="k">JOIN</span>
        <span class="n">CTE_first_visits_raw</span> <span class="n">DIM</span>
        <span class="k">ON</span> <span class="n">FCT</span><span class="p">.</span><span class="n">user_id</span> <span class="o">=</span> <span class="n">DIM</span><span class="p">.</span><span class="n">user_id</span>
</code></pre></div></div>

<h3 id="56-final-review">5.6. Final Review</h3>

<p><img src="/assets/2025-01-25-first-activation-data-mart/3.webp" alt="" /></p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">models</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">fact__first_activation_events</span>
    <span class="na">description</span><span class="pi">:</span> <span class="s">User's first event history</span>
    <span class="na">meta</span><span class="pi">:</span>
      <span class="na">owner</span><span class="pi">:</span> <span class="s">Jinseok Kim</span>
    <span class="na">config</span><span class="pi">:</span>
      <span class="na">materialized</span><span class="pi">:</span> <span class="s">incremental</span>
      <span class="na">incremental_strategy</span><span class="pi">:</span> <span class="s">insert_overwrite</span>
      <span class="na">on_schema_change</span><span class="pi">:</span> <span class="s">append_new_columns</span>
      <span class="na">partition_by</span><span class="pi">:</span>
        <span class="na">field</span><span class="pi">:</span> <span class="s">date</span>
        <span class="na">data_type</span><span class="pi">:</span> <span class="s">date</span>
        <span class="na">granularity</span><span class="pi">:</span> <span class="s">day</span>
      <span class="na">time_ingestion_partitioning</span><span class="pi">:</span> <span class="kc">true</span>
      <span class="na">require_partition_filter</span><span class="pi">:</span> <span class="kc">false</span>
      <span class="na">copy_partitions</span><span class="pi">:</span> <span class="kc">true</span>
    <span class="na">columns</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">date</span>
        <span class="na">description</span><span class="pi">:</span> <span class="s">...</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">...</span>
        <span class="na">description</span><span class="pi">:</span> <span class="s">...</span>
</code></pre></div></div>

<h1 id="6-modeling-review">6. Modeling Review</h1>

<h3 id="61-good-requirement-gathering-leads-to-good-data-marts">6.1. Good Requirement Gathering Leads to Good Data Marts</h3>

<ul>
  <li>A good data mart = a data mart that can be used repeatedly and sustainably</li>
  <li>To accurately understand the squadâ€™s core metrics, I spent hours discussing with the squad leader.
    <ul>
      <li>How exactly is the conversion rate defined?</li>
      <li>How might the core metrics change in the future?</li>
    </ul>
  </li>
</ul>

<h3 id="62-data-modeling-is-not-complete-with-theory-alone">6.2. Data Modeling Is Not Complete with Theory Alone</h3>

<ul>
  <li>There are systematic theories for DWH such as Kimball and Inmon.</li>
  <li>However, the most important thing is: â€œDoes it help solve the problem?â€
    <ul>
      <li>Organizational data usage tendencies, data characteristics, core problems</li>
    </ul>
  </li>
  <li>The <code class="language-plaintext highlighter-rouge">fact__first_activation_events</code> table was not created solely based on theory.
    <ul>
      <li>It was created by applying DWH theory to meet organizational needs.</li>
    </ul>
  </li>
</ul>

<h1 id="7-acknowledgements">7. Acknowledgements</h1>

<h3 id="71-inspired-by-toss-securities-dw-design-review-video">7.1. Inspired by Toss Securitiesâ€™ â€œDW Design Reviewâ€ Video</h3>

<blockquote>
  <p><a href="https://www.youtube.com/watch?v=MWDVBZycou4">Toss SLASH 24 - Designing and Operating a DW for All-Purpose Data Analysis</a></p>
</blockquote>

<ul>
  <li>This video provided important clues for understanding the flow of user activation data.</li>
</ul>

<h3 id="72-special-thanks-to-the-squad-leader">7.2. Special Thanks to the Squad Leader</h3>

<ul>
  <li>The squad leader actively helped resolve my questions to provide core metric data.
    <ul>
      <li>Provided background to help see the business goals clearly.</li>
      <li>Carefully quantified the core metrics together.</li>
    </ul>
  </li>
  <li>I am sincerely grateful for the intensive training that helped me align my perspective as a data analyst with the organizationâ€™s goals.</li>
</ul>

<hr />

<h2 id="published-by-joshua-kim"><em>Published by</em> Joshua Kim</h2>

<p><img src="/assets/profile/joshua-profile.png" alt="Joshua Kim" /></p>]]></content><author><name></name></author><category term="Language (English)" /><category term="Article (Project)" /><category term="Level (2. Intermediate)" /><category term="Field (Analytics Engineering)" /><category term="Skills (SQL)" /><category term="Skills (dbt)" /><summary type="html"><![CDATA[â€œThis post summarizes my experience designing and building a data mart to effectively provide new user activation conversion metrics. I designed the data model to flexibly respond to changing business requirements, and focused on queries and structures that are immediately applicable in practice. Through this process, I was able to apply data modeling theory to real-world problem solving and once again realized the importance of deeply understanding requirements.â€]]></summary></entry><entry><title type="html">Airflow ë„ì… í›„ê¸°</title><link href="http://localhost:4000/implementing-airflow-ko/" rel="alternate" type="text/html" title="Airflow ë„ì… í›„ê¸°" /><published>2024-12-28T00:00:00+09:00</published><updated>2024-12-28T00:00:00+09:00</updated><id>http://localhost:4000/implementing-airflow-ko</id><content type="html" xml:base="http://localhost:4000/implementing-airflow-ko/"><![CDATA[<blockquote>
  <p>â€œAirflow ë„ì…ì„ í†µí•´ ì‚¬ë‚´ ë°ì´í„° ì•Œë¦¼ ì‹œìŠ¤í…œì„ íš¨ìœ¨ì ìœ¼ë¡œ ê´€ë¦¬í•˜ê³ ì ê¸°ì¡´ Python ê¸°ë°˜ ì„¸ì…˜ ë°©ì‹ì—ì„œ ë²—ì–´ë‚˜ DAG ê¸°ë°˜ ì›Œí¬í”Œë¡œìš°ë¥¼ êµ¬ì¶•í–ˆìŠµë‹ˆë‹¤. Docker Composeë¥¼ í™œìš©í•´ ë¡œì»¬ ë° VM í™˜ê²½ì—ì„œ Airflowë¥¼ ì„¤ì •í•˜ê³ , Slack ì•Œë¦¼ì„ í¬í•¨í•œ ë‹¤ì–‘í•œ ë°ì´í„° íŒŒì´í”„ë¼ì¸ì„ ìë™í™”í–ˆìŠµë‹ˆë‹¤. ì´ë¥¼ í†µí•´ ìœ ì§€ë³´ìˆ˜ ë¶€ë‹´ì„ ì¤„ì´ê³ , ì•ˆì •ì„±ì„ ë†’ì´ë©°, í™•ì¥ ê°€ëŠ¥í•œ ë°ì´í„° ì²˜ë¦¬ í™˜ê²½ì„ ë§ˆë ¨í•  ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤.â€</p>
</blockquote>

<hr />

<h1 id="ëª©ì°¨">ëª©ì°¨</h1>
<ol>
  <li>ë„ì… ë°°ê²½</li>
  <li>ë„ì… í›„ê¸°
    <ul>
      <li>2.1. ì‘ì—… ê³„íš</li>
      <li>2.2. ë¡œì»¬ í™˜ê²½ ì„¸íŒ…</li>
      <li>2.3. VM Instance í™˜ê²½ ì„¸íŒ…</li>
      <li>2.4. DAG ë§Œë“¤ê¸°</li>
    </ul>
  </li>
  <li>ì•ìœ¼ë¡œì˜ ê³¼ì œ</li>
</ol>

<hr />

<h1 id="1-ë„ì…-ë°°ê²½">1. ë„ì… ë°°ê²½</h1>

<p>ì €ëŠ” ì•„ì´ì˜¤íŠ¸ëŸ¬ìŠ¤íŠ¸ì—ì„œ ë°ì´í„° ì—”ì§€ë‹ˆì–´ í¬ì§€ì…˜ìœ¼ë¡œ ê·¼ë¬´í•˜ë©°, ì•„ë˜ì™€ ê°™ì´ ì£¼ë¡œ <strong>ì• ë„ë¦¬í‹±ìŠ¤ ì—”ì§€ë‹ˆì–´ë§</strong> ì—…ë¬´ì— ì§‘ì¤‘í•˜ê³  ìˆì–´ìš”.</p>

<pre><code class="language-plain">- (1) ë°ì´í„° ì›¨ì–´í•˜ìš°ìŠ¤ &amp; ë°ì´í„° ë§ˆíŠ¸ ì„¤ê³„ ë° ê°œë°œ
- (2) BI ëŒ€ì‹œë³´ë“œ
- (3) Ad-hoc ë°ì´í„° ì•Œë¦¼ ë´‡ ê°œë°œ
- (4) ì´ë²¤íŠ¸ íƒì†Œë…¸ë¯¸ ì„¤ê³„ + ì •ì˜ì„œ ê´€ë¦¬
- (5) (Finance/HR/CX) ì—…ë¬´ ìë™í™” í™˜ê²½ êµ¬ì¶•
</code></pre>

<p>ê·¸ëŸ°ë°, ì‹œê°„ì´ íë¥¼ìˆ˜ë¡ â€œ<strong>(3) Ad-hoc ë°ì´í„° ì•Œë¦¼ ë´‡ ê°œë°œ</strong>â€ ì—­í• ì— ë¬¸ì œê°€ ë°œìƒí•˜ê¸° ì‹œì‘í–ˆì–´ìš”. ë™ë£Œë“¤ì´ ì ì‹œì— ì¤‘ìš”í•œ í•µì‹¬ ì§€í‘œë¥¼ ìŠ¬ë™ìœ¼ë¡œ ë¹ ë¥´ê²Œ í™•ì¸í•  ìˆ˜ ìˆë„ë¡ ì§€ì›í•˜ëŠ” ê³¼ì •ì—ì„œ, ì„œì„œíˆ Python íŒŒì¼ì´ ë§ì•„ì¡Œê³  ê´€ë¦¬ ë¦¬ì†ŒìŠ¤ë„ ì œë²• ëŠ˜ì–´ë‚˜ê²Œ ëœ ê²ƒì´ì£ .</p>

<p><img src="/assets/2024-12-28-implementing-airflow/1.webp" alt="" /></p>

<p>êµ¬ì²´ì ìœ¼ë¡œëŠ”, ì•„ë˜ì™€ ê°™ì´ <code class="language-plaintext highlighter-rouge">tmux</code>ë¥¼ í†µí•´ ì„¸ì…˜ ë ˆë²¨ì—ì„œ ê° Python íŒŒì¼ì„ ì§ì ‘ ì‹¤í–‰í•˜ì—¬ ëª¨ë“  ìŠ¬ë™ ì•Œë¦¼ì„ ê´€ë¦¬í•˜ê³  ìˆì—ˆì–´ìš”. <code class="language-plaintext highlighter-rouge">tmux</code>ëŠ” ë‹¨ì¼ í„°ë¯¸ë„ì—ì„œ ì—¬ëŸ¬ ì„¸ì…˜ì„ ë…ë¦½ì ìœ¼ë¡œ ê´€ë¦¬í•  ìˆ˜ ìˆë„ë¡ í•´ì£¼ëŠ” ì˜¤í”ˆì†ŒìŠ¤ í„°ë¯¸ë„ ìë™í™” ë„êµ¬ì˜ˆìš”. (<a href="https://en.wikipedia.org/wiki/Tmux">Wikipedia</a>)</p>

<p><img src="/assets/2024-12-28-implementing-airflow/2.webp" alt="" /></p>

<p>ì ì°¨ Python íŒŒì¼ì´ ë§ì•„ì§€ê³  ë³µì¡í•´ì§€ë©´ì„œ êµ¬ì²´ì ìœ¼ë¡œ ë‹¤ìŒê³¼ ê°™ì€ ë¬¸ì œê°€ ë°œìƒí•˜ê¸° ì‹œì‘í–ˆì–´ìš”.</p>

<p><strong>(1) ìœ ì§€ë³´ìˆ˜ ë¶€ë‹´ì´ ëŠ˜ì–´ë‚¬ì–´ìš”.</strong></p>

<p>Python íŒŒì¼ì˜ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ë©´ ì‹¤í–‰ì´ ì¦‰ì‹œ ì¤‘ë‹¨ë˜ì–´ ë””ë²„ê¹…ì´ ì™„ë£Œë˜ê¸° ì „ê¹Œì§€ëŠ” ë™ë£Œë“¤ì´ ì•Œë¦¼ì„ ë°›ì„ ìˆ˜ ì—†ì—ˆì–´ìš”. ì‘ì—… ì¬ì‹œë„ ê¸°ëŠ¥ì´ ì—†ì—ˆê¸° ë•Œë¬¸ì´ì£ .</p>

<p>ë˜í•œ, ë””ë²„ê¹… ê³¼ì •ì—ì„œ ì œë²• ë§ì€ ì‹œê°„ì„ í—ˆë¹„í–ˆì–´ìš”. ì˜ì¡´ì„±ì´ ìˆëŠ” ê° íŒŒì´í”„ë¼ì¸ ë‹¨ê³„ë¥¼ main() í•¨ìˆ˜ í•˜ë‚˜ë¡œ ê´€ë¦¬í•˜ë‹¤ ë³´ë‹ˆ, ì •í™•í•œ ì‹¤íŒ¨ ì›ì¸ì„ ì°¾ëŠ” ë° ìƒë‹¹í•œ ì‹œê°„ì´ ì†Œìš”ë˜ì—ˆë˜ ê²ƒì´ì£ . ê·¸ëŸ¬ë‹¤ë³´ë‹ˆ ì¤‘ìš”í•œ ì¼ì— ëª°ì…í•˜ì§€ ëª»í•˜ê³  ì—…ë¬´ê°€ ì‚°ë§Œí•´ì§€ê¸° ì‰¬ì› ì£ .</p>

<p><strong>(2) ì„¸ì…˜ ê¸°ë°˜ ê´€ë¦¬ì˜ ì•ˆì •ì„±ì´ ë¶€ì¡±í–ˆì–´ìš”.</strong></p>

<p>ì„œë²„ ì¬ë¶€íŒ…ì´ë‚˜ ë„¤íŠ¸ì›Œí¬ ë¬¸ì œë¡œ ì¸í•´ ì‘ì—…ì´ ì¤‘ë‹¨ë  ì—¬ì§€ê°€ ë†’ì•˜ê³ , ì‹¤ì œë¡œ ì•Œ ìˆ˜ ì—†ëŠ” ì´ìœ ë¡œ ì„¸ì…˜ì´ ëª¨ë‘ ì¢…ë£Œë˜ì–´ ë³µêµ¬ ì‘ì—…ì„ í•´ì•¼ í–ˆë˜ ì ë„ ìˆì—ˆì–´ìš”.</p>

<p>ë˜í•œ, ê° ì„¸ì…˜ì´ ë™ì¼í•œ í™˜ê²½ì„ ê³µìœ í•˜ê¸° ë•Œë¬¸ì— <a href="https://docs.python.org/3/library/venv.html">Python Venv</a>ë¥¼ ì‚¬ìš©í•˜ë”ë¼ë„ ì˜ë„ì¹˜ ì•Šì€ ì¶©ëŒì´ë‚˜ ì¢…ì†ì„± ë¬¸ì œê°€ ë°œìƒí•  ì—¬ì§€ê°€ ìˆì—ˆì–´ìš”.</p>

<p><strong>ì´ëŸ° ì´ìœ ë¡œ Airflowë¥¼ í†µí•œ ì›Œí¬í”Œë¡œìš° ê´€ë¦¬ í•„ìš”ì„±ì´ ì ì°¨ ì»¤ì§€ê²Œ ë˜ì—ˆì–´ìš”.</strong></p>

<ul>
  <li>ì»¨í…Œì´ë„ˆë§Œ ì¬ì‹œì‘í•˜ë©´ ê° ì‘ì—…ì„ ìë™ìœ¼ë¡œ ë³µêµ¬í•  ìˆ˜ ìˆì–´ìš”.</li>
  <li>ê° ì‘ì—…ë³„ë¡œ ë…ë¦½ëœ í™˜ê²½ì„ ì œê³µí•´ìš”.</li>
  <li>ì§€ì†ì ìœ¼ë¡œ ì‘ì—…ì„ í™•ì¥í•  ìˆ˜ ìˆì–´ìš”.</li>
  <li>ì›¹ì„œë²„ UIë¥¼ í†µí•´ ê´€ë¦¬ë¥¼ ìš©ì´í•˜ê²Œ í•  ìˆ˜ ìˆì–´ìš”.</li>
</ul>

<p>ì‚¬ì‹¤, â€œ<strong>Ad-hoc ë°ì´í„° ì•Œë¦¼ ë´‡ ê°œë°œ</strong>â€ ì—…ë¬´ ì´ˆê¸°ì— ì´ë¯¸ Airflow ë„ì…ì„ ì ê·¹ì ìœ¼ë¡œ ê²€í† í–ˆì—ˆìŠµë‹ˆë‹¤. í•˜ì§€ë§Œ ë‹¹ì‹œ ì›Œí¬í”Œë¡œìš°ì˜ ê·œëª¨ê°€ ë§¤ìš° ì‘ì•˜ê¸° ë•Œë¬¸ì—, <strong>YAGNI</strong> ì›ì¹™ì— ë”°ë¼ êµ³ì´ ë„ì…í•  í•„ìš”ê°€ ì—†ë‹¤ê³  íŒë‹¨í–ˆì£ .</p>

<p><a href="https://en.wikipedia.org/wiki/You_aren%27t_gonna_need_it">YAGNI</a>ëŠ” â€œ<strong>You Arenâ€™t Gonna Need It</strong>â€ì˜ ì¤€ë§ë¡œ, í•„ìš”í•˜ì§€ ì•Šì€ ê¸°ëŠ¥ì´ë‚˜ ë³µì¡ì„±ì„ ë¯¸ë¦¬ ì¶”ê°€í•˜ì§€ ë§ë¼ëŠ” ì• ìì¼ ì†Œí”„íŠ¸ì›¨ì–´ ê°œë°œì˜ í•µì‹¬ ì›ì¹™ ì¤‘ í•˜ë‚˜ì…ë‹ˆë‹¤. ë‹¹ì‹œì—ëŠ” í˜„ì¬ ìš”êµ¬ ì‚¬í•­ì„ ì¶©ì¡±í•˜ëŠ” ì ì ˆí•œ ìˆ˜ì¤€ì—ì„œë§Œ ì›Œí¬í”Œë¡œìš° í™˜ê²½ì„ êµ¬ì¶•í•˜ëŠ” ê²ƒì´ ì¤‘ìš”í•˜ë‹¤ê³  ìƒê°í•´, ì„¸ì…˜ ê¸°ë°˜ ê´€ë¦¬ ë°©ì‹ì„ ì„ íƒí–ˆì–´ìš”.</p>

<p>ê·¸ëŸ¬ë‚˜ ì›Œí¬í”Œë¡œìš° ê·œëª¨ê°€ ì ì°¨ ì»¤ì§€ë©´ì„œ ì„¸ì…˜ ê´€ë¦¬ ë°©ì‹ì—ì„œ ë°œìƒí•˜ëŠ” ë¦¬ì†ŒìŠ¤ ë‚­ë¹„ì™€ ë¹„íš¨ìœ¨ì„±ì´ ëˆˆì— ë„ê²Œ ëŠ˜ì–´ë‚¬ì–´ìš”. ì´ì— ë”°ë¼, Airflow ë„ì…ì´ í•„ìš”í•˜ë‹¤ê³  íŒë‹¨í•˜ê²Œ ë˜ì—ˆìŠµë‹ˆë‹¤.</p>

<hr />

<h1 id="2-ë„ì…-í›„ê¸°">2. ë„ì… í›„ê¸°</h1>

<h3 id="21-ì‘ì—…-ê³„íš">2.1. ì‘ì—… ê³„íš</h3>

<p><img src="/assets/2024-12-28-implementing-airflow/3.webp" alt="" /></p>

<p>ë¨¼ì € ìœ„ ê·¸ë¦¼ê³¼ ê°™ì´ ê³„íšì„ ì„¸ì› ì–´ìš”.</p>

<p>(1) ê¸°ì¡´ Python íŒŒì¼ë“¤ì„ <strong>DAG í¬ë§·</strong>ì— ë§ê²Œ ì½”ë“œë¥¼ ìˆ˜ì •í•©ë‹ˆë‹¤.</p>

<p>(2) <strong>ë¡œì»¬ í™˜ê²½</strong>ì—ì„œ Airflow í”„ë¡œì íŠ¸ë¥¼ Docker Composeë¡œ ë¹Œë“œí•˜ì—¬, ì•Œë¦¼ì´ ìŠ¬ë™ í…ŒìŠ¤íŠ¸ ì±„ë„ì— ì œëŒ€ë¡œ ì „ì†¡ë˜ëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.</p>

<p>(3) <strong>VM Instance í™˜ê²½</strong>ì—ì„œë„ Airflow í”„ë¡œì íŠ¸ë¥¼ Docker Composeë¡œ ë¹Œë“œí•˜ì—¬, ìµœì¢…ì ìœ¼ë¡œ ì•Œë¦¼ í™˜ê²½ì„ ë°°í¬í•©ë‹ˆë‹¤.</p>

<h3 id="22-ë¡œì»¬-í™˜ê²½-ì„¸íŒ…">2.2. ë¡œì»¬ í™˜ê²½ ì„¸íŒ…</h3>

<p>(0) ê¸°ë³¸ì ìœ¼ë¡œ Dockerê°€ ì„¤ì¹˜ë˜ì–´ ìˆì–´ì•¼ í•´ìš”.</p>

<ul>
  <li>ì €ëŠ” Docker Desktop ì•±ì„ ì„¤ì¹˜í•˜ëŠ” ë°©í–¥ìœ¼ë¡œ ì¤€ë¹„í–ˆì–´ìš”. ì •í™•í•œ ì„¤ì¹˜ ë°©ë²•ì€ <a href="https://www.docker.com/get-started/">ì´ ë¬¸ì„œ</a>ë¥¼ ì°¸ê³ í•´ì£¼ì„¸ìš”.</li>
</ul>

<p>(1) Python Venvë¥¼ ìƒì„±í–ˆì–´ìš”.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python <span class="nt">-m</span> venv venv
<span class="nb">source </span>venv/bin/activate
</code></pre></div></div>

<p>(2) <code class="language-plaintext highlighter-rouge">airflow</code> ì´ë¦„ì˜ ë””ë ‰í† ë¦¬ì—ì„œ ì•„ë˜ ëª…ë ¹ì–´ë¥¼ í†µí•´ Airflow ì´ë¯¸ì§€ë¥¼ ë¡œë“œí–ˆì–´ìš”. (<code class="language-plaintext highlighter-rouge">docker-compose.yaml</code> íŒŒì¼ì´ ìƒì„±ë  ê±°ì˜ˆìš”.)</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl <span class="nt">-LfO</span> <span class="s1">'https://airflow.apache.org/docs/apache-airflow/2.9.1/docker-compose.yaml'</span>
</code></pre></div></div>

<p>(3) <code class="language-plaintext highlighter-rouge">dags</code>, <code class="language-plaintext highlighter-rouge">logs</code>, <code class="language-plaintext highlighter-rouge">plugins</code> í•˜ìœ„ ë””ë ‰í† ë¦¬ë¥¼ ìƒì„±í•˜ê³ , <strong>AIRFLOW_UID</strong> í™˜ê²½ ë³€ìˆ˜ë¥¼ ì§€ë‹Œ <code class="language-plaintext highlighter-rouge">.env</code> íŒŒì¼ì„ ìƒì„±í–ˆì–´ìš”.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">mkdir</span> <span class="nt">-p</span> ./dags ./logs ./plugins
<span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"AIRFLOW_UID=</span><span class="si">$(</span><span class="nb">id</span> <span class="nt">-u</span><span class="si">)</span><span class="s2">"</span> <span class="o">&gt;</span> .env
</code></pre></div></div>

<p>(4) ì•„ë˜ ë‚´ìš©ì„ ì§€ë‹Œ <code class="language-plaintext highlighter-rouge">Dockerfile</code> íŒŒì¼ì„ ìƒì„±í–ˆì–´ìš”.</p>

<div class="language-Dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># First-time build can take upto 10 mins.</span>

<span class="k">FROM</span><span class="s"> apache/airflow:2.9.1</span>

<span class="k">ENV</span><span class="s"> AIRFLOW_HOME=/opt/airflow</span>

<span class="k">USER</span><span class="s"> root</span>
<span class="k">RUN </span>apt-get update <span class="nt">-qq</span> <span class="o">&amp;&amp;</span> apt-get <span class="nb">install </span>vim <span class="nt">-qqq</span>
<span class="c"># git gcc g++ -qqq</span>

<span class="k">COPY</span><span class="s"> requirements.txt .</span>
<span class="k">RUN </span>pip <span class="nb">install</span> <span class="nt">--no-cache-dir</span> <span class="nt">-r</span> requirements.txt

<span class="c"># Ref: https://airflow.apache.org/docs/docker-stack/recipes.html</span>

<span class="k">SHELL</span><span class="s"> ["/bin/bash", "-o", "pipefail", "-e", "-u", "-x", "-c"]</span>

<span class="k">ARG</span><span class="s"> CLOUD_SDK_VERSION=322.0.0</span>
<span class="k">ENV</span><span class="s"> GCLOUD_HOME=/home/google-cloud-sdk</span>

<span class="k">ENV</span><span class="s"> PATH="${GCLOUD_HOME}/bin/:${PATH}"</span>

<span class="k">RUN </span><span class="nv">DOWNLOAD_URL</span><span class="o">=</span><span class="s2">"https://dl.google.com/dl/cloudsdk/channels/rapid/downloads/google-cloud-sdk-</span><span class="k">${</span><span class="nv">CLOUD_SDK_VERSION</span><span class="k">}</span><span class="s2">-linux-x86_64.tar.gz"</span> <span class="se">\
</span>    <span class="o">&amp;&amp;</span> <span class="nv">TMP_DIR</span><span class="o">=</span><span class="s2">"</span><span class="si">$(</span><span class="nb">mktemp</span> <span class="nt">-d</span><span class="si">)</span><span class="s2">"</span> <span class="se">\
</span>    <span class="o">&amp;&amp;</span> curl <span class="nt">-fL</span> <span class="s2">"</span><span class="k">${</span><span class="nv">DOWNLOAD_URL</span><span class="k">}</span><span class="s2">"</span> <span class="nt">--output</span> <span class="s2">"</span><span class="k">${</span><span class="nv">TMP_DIR</span><span class="k">}</span><span class="s2">/google-cloud-sdk.tar.gz"</span> <span class="se">\
</span>    <span class="o">&amp;&amp;</span> <span class="nb">mkdir</span> <span class="nt">-p</span> <span class="s2">"</span><span class="k">${</span><span class="nv">GCLOUD_HOME</span><span class="k">}</span><span class="s2">"</span> <span class="se">\
</span>    <span class="o">&amp;&amp;</span> <span class="nb">tar </span>xzf <span class="s2">"</span><span class="k">${</span><span class="nv">TMP_DIR</span><span class="k">}</span><span class="s2">/google-cloud-sdk.tar.gz"</span> <span class="nt">-C</span> <span class="s2">"</span><span class="k">${</span><span class="nv">GCLOUD_HOME</span><span class="k">}</span><span class="s2">"</span> <span class="nt">--strip-components</span><span class="o">=</span>1 <span class="se">\
</span>    <span class="o">&amp;&amp;</span> <span class="s2">"</span><span class="k">${</span><span class="nv">GCLOUD_HOME</span><span class="k">}</span><span class="s2">/install.sh"</span> <span class="se">\
</span>       <span class="nt">--bash-completion</span><span class="o">=</span><span class="nb">false</span> <span class="se">\
</span>       <span class="nt">--path-update</span><span class="o">=</span><span class="nb">false</span> <span class="se">\
</span>       <span class="nt">--usage-reporting</span><span class="o">=</span><span class="nb">false</span> <span class="se">\
</span>       <span class="nt">--quiet</span> <span class="se">\
</span>    <span class="o">&amp;&amp;</span> <span class="nb">rm</span> <span class="nt">-rf</span> <span class="s2">"</span><span class="k">${</span><span class="nv">TMP_DIR</span><span class="k">}</span><span class="s2">"</span> <span class="se">\
</span>    <span class="o">&amp;&amp;</span> gcloud <span class="nt">--version</span>

<span class="k">WORKDIR</span><span class="s"> $AIRFLOW_HOME</span>

<span class="k">COPY</span><span class="s"> scripts scripts</span>
<span class="k">RUN </span><span class="nb">chmod</span> +x scripts

<span class="k">USER</span><span class="s"> $AIRFLOW_UID</span>
</code></pre></div></div>

<p>(5) ì•„ë˜ ë‚´ìš©ì„ ì§€ë‹Œ <code class="language-plaintext highlighter-rouge">requirements.txt</code> íŒŒì¼ì„ ìƒì„±í–ˆì–´ìš”.</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apache-airflow-providers-google
pyarrow
</code></pre></div></div>

<p>(6) <code class="language-plaintext highlighter-rouge">docker-compose.yaml</code> íŒŒì¼ì—ì„œ ë‹¤ìŒ í•­ëª©ë“¤ì„ ì¶”ê°€/í¸ì§‘í–ˆì–´ìš”.</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">/keys</code>: êµ¬ê¸€ í´ë¼ìš°ë“œ ì„œë¹„ìŠ¤ ê³„ì • json key íŒŒì¼ì„ ë³´ê´€í•˜ëŠ” ìš©ë„</li>
  <li><code class="language-plaintext highlighter-rouge">.env</code>: Airflow Admin ë¡œê·¸ì¸ ì •ë³´ì™€ ìŠ¬ë™ API í† í°ì„ ë³´ê´€í•˜ëŠ” ìš©ë„</li>
</ul>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">x-airflow-common</span><span class="pi">:</span>
  <span class="s">...</span>
  <span class="s">environment</span><span class="err">:</span>
    <span class="s">...</span>
    <span class="s">AIRFLOW__CORE__LOAD_EXAMPLES</span><span class="err">:</span> <span class="s1">'</span><span class="s">false'</span> <span class="c1"># ìƒ˜í”Œ DAGê°€ ìƒì„±ë˜ì§€ ì•Šë„ë¡ í–ˆì–´ìš”.</span>
    <span class="s">...</span>
    <span class="s">GOOGLE_APPLICATION_CREDENTIALS</span><span class="err">:</span> <span class="s">/keys/airflow_credentials.json</span> <span class="c1"># êµ¬ê¸€ í´ë¼ìš°ë“œ ì„œë¹„ìŠ¤ ê³„ì • json key íŒŒì¼ì˜ ê²½ë¡œë¥¼ ì…ë ¥í–ˆì–´ìš”.</span>
    <span class="na">AIRFLOW_CONN_GOOGLE_CLOUD_DEFAULT</span><span class="pi">:</span> <span class="s1">'</span><span class="s">google-cloud-platform://?extra__google_cloud_platform__key_path=/keys/airflow_credentials.json'</span> <span class="c1"># ì—¬ê¸°ë„ ë§ˆì°¬ê°€ì§€ì—ìš”.</span>
    <span class="na">GCP_PROJECT_ID</span><span class="pi">:</span> <span class="s1">'</span><span class="s">gcp_project_id'</span> <span class="c1"># êµ¬ê¸€ í´ë¼ìš°ë“œ í”„ë¡œì íŠ¸ IDë¥¼ ì…ë ¥í–ˆì–´ìš”.</span>
    <span class="na">AIRFLOW_CONN_SLACK_DEFAULT</span><span class="pi">:</span> <span class="s1">'</span><span class="s">slack://:${SLACK_TOKEN}@'</span> <span class="c1"># ìŠ¬ë™ API í† í°ì€ .env íŒŒì¼ì—ì„œ ê´€ë¦¬í–ˆì–´ìš”.</span>
    <span class="s">...</span>
  <span class="na">volumes</span><span class="pi">:</span>
    <span class="s">...</span>
    <span class="s">- ./keys:/keys:ro</span> <span class="c1"># êµ¬ê¸€ í´ë¼ìš°ë“œ ì„œë¹„ìŠ¤ ê³„ì • json key íŒŒì¼ì´ ë‹´ê¸´ /keys ë””ë ‰í† ë¦¬ë¥¼ Docker ìƒì— ë§¤í•‘í•´ì¤¬ì–´ìš”.</span>
<span class="nn">...</span>
<span class="na">services</span><span class="pi">:</span>
  <span class="s">...</span>
  <span class="s">airflow-init</span><span class="err">:</span>
    <span class="s">...</span>
    <span class="s">environment</span><span class="err">:</span>
      <span class="s">...</span>
      <span class="s">_AIRFLOW_WWW_USER_USERNAME</span><span class="err">:</span> <span class="s">${_AIRFLOW_WWW_USER_USERNAME}</span> <span class="c1"># Airflow Webserver ë¡œê·¸ì¸ ì •ë³´ëŠ” .env íŒŒì¼ì—ì„œ ê´€ë¦¬í–ˆì–´ìš”.</span>
      <span class="na">_AIRFLOW_WWW_USER_PASSWORD</span><span class="pi">:</span> <span class="s">${_AIRFLOW_WWW_USER_PASSWORD}</span> <span class="c1"># Airflow Webserver ë¡œê·¸ì¸ ì •ë³´ëŠ” .env íŒŒì¼ì—ì„œ ê´€ë¦¬í–ˆì–´ìš”.</span>
      <span class="s">...</span>
</code></pre></div></div>

<p>(7) Docker Composeë¥¼ ë¹Œë“œí•˜ê³ , Initialize Airflow í–ˆì–´ìš”.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker-compose build
docker-compose up airflow-init
</code></pre></div></div>

<p>(8) ë§ˆì§€ë§‰ìœ¼ë¡œ Docker Composeë¥¼ ì‹¤í–‰í–ˆì–´ìš”.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker-compose up <span class="nt">-d</span>
docker-compose ps
</code></pre></div></div>

<p>(9) ë¸Œë¼ìš°ì €ì—ì„œ Airflow Webserverì— ì ‘ì†í•˜ì—¬ ë¡œê·¸ì¸í–ˆì–´ìš”.</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1) http://0.0.0.0:8080 ë¡œ ì ‘ì†í•´ìš”.
2) docker-compose.yamlì—ì„œ ì„¤ì •í–ˆë˜ ì•„ë˜ì˜ í™˜ê²½ ë³€ìˆ˜ë¡œ ë¡œê·¸ì¸í•˜ë©´ ë¼ìš”.
  - _AIRFLOW_WWW_USER_USERNAME
  - _AIRFLOW_WWW_USER_PASSWORD
</code></pre></div></div>

<p><img src="/assets/2024-12-28-implementing-airflow/4.webp" alt="" /></p>

<p>(10) <code class="language-plaintext highlighter-rouge">airflow</code> ë””ë ‰í† ë¦¬ì— Initialize Gitì„ í•œ í›„, GitHub Remote Repoì— ì—°ë™í–ˆì–´ìš”. (ë¬¼ë¡ , ì—°ë™í•˜ë©´ ì•ˆë˜ëŠ” íŒŒì¼ë“¤ì€ <code class="language-plaintext highlighter-rouge">.gitignore</code>ì— ë¦¬ìŠ¤íŠ¸ì—…í–ˆì–´ìš”.)</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git init
git remote add origin https://github.com/.../airflow.git
git branch <span class="nt">-m</span> main
git add <span class="nb">.</span>
git commit <span class="nt">-m</span> <span class="s2">"created airflow project"</span>
git push <span class="nt">-u</span> origin main
</code></pre></div></div>

<h3 id="23-vm-instance-í™˜ê²½-ì„¸íŒ…">2.3. VM Instance í™˜ê²½ ì„¸íŒ…</h3>

<p>(1) ë°©í™”ë²½ ê·œì¹™ì„ ìƒì„±í–ˆì–´ìš”. (VM Instanceì—ì„œ ìš´ì˜ ì¤‘ì¸ Airflow Webserverì— ì‚¬ë‚´ ë¡œì»¬ì—ì„œë„ ì ‘ì†í•  ìˆ˜ ìˆë„ë¡ í•´ì•¼ í•˜ê±°ë“ ìš”.)</p>

<p><img src="/assets/2024-12-28-implementing-airflow/5.webp" alt="" /></p>

<ul>
  <li><strong>ë°©í–¥</strong>: Ingress</li>
  <li><strong>ëŒ€ìƒ íƒœê·¸</strong>: airflow (ì›í•˜ëŠ” ì´ë¦„ìœ¼ë¡œ ì ìœ¼ì…”ë„ ë¼ìš”.)</li>
  <li><strong>ì†ŒìŠ¤ í•„í„° &gt; IP ë²”ìœ„</strong>: ì‚¬ë‚´ IP Address Rangeë¥¼ ì…ë ¥í–ˆì–´ìš”.</li>
  <li><strong>í”„ë¡œí† ì½œ ë° í¬íŠ¸</strong>: tcp-8080 (WebserverëŠ” 8080 í¬íŠ¸ë¥¼ í†µí•´ Host Machineê³¼ ì†Œí†µí•˜ê¸° ë•Œë¬¸ì´ì—ìš”. <code class="language-plaintext highlighter-rouge">docker-compose.yaml</code> íŒŒì¼ì—ì„œ í¬íŠ¸ë¥¼ ìˆ˜ì •í•  ìˆ˜ë„ ìˆì–´ìš”.)</li>
</ul>

<p>(2) <code class="language-plaintext highlighter-rouge">airflow</code> ì´ë¦„ì˜ VM Instanceë¥¼ ë§Œë“¤ì—ˆì–´ìš”.</p>

<p><img src="/assets/2024-12-28-implementing-airflow/6.webp" alt="" /></p>

<ul>
  <li><strong>Machine</strong>: E2 ì‹œë¦¬ì¦ˆ ì¤‘ vCPU 2ê°œ ì´ìƒ, ë©”ëª¨ë¦¬ 8GB ì´ìƒì„ ì¶”ì²œí•´ìš”. (ë©”ëª¨ë¦¬ 4GBë¥¼ ì„ íƒí•˜ë©´ ì„œë²„ê°€ ë„¤íŠ¸ì›Œí¬ íŠ¸ë˜í”½ì„ ê²¬ë””ì§€ ëª»í•´ ì‰½ê²Œ ë¨¹í†µì´ ë  ê±°ì˜ˆìš”.)</li>
  <li><strong>OS &amp; Storage</strong>: OSëŠ” Debian, ìŠ¤í† ë¦¬ì§€ ì‚¬ì´ì¦ˆëŠ” 10GBë¥¼ ì„ íƒí–ˆì–´ìš”.</li>
  <li><strong>ë°©í™”ë²½</strong>: HTTP &amp; HTTPS íŠ¸ë˜í”½ì„ â€œì‚¬ìš©â€ìœ¼ë¡œ ì„¤ì •í•œ í›„, ë°©í™”ë²½ ê·œì¹™ì—ì„œ ìƒì„±í–ˆë˜ íƒœê·¸ì¸ <code class="language-plaintext highlighter-rouge">airflow</code>ë¥¼ ì…ë ¥í–ˆì–´ìš”.</li>
</ul>

<p>(3) ë¡œì»¬ í™˜ê²½ì—ì„œ ì„¸íŒ…í•œ ê²ƒê³¼ ë§ˆì°¬ê°€ì§€ë¡œ Dockerë¥¼ ì„¤ì¹˜í•˜ê³ , Python Venvë¥¼ ìƒì„±í–ˆì–´ìš”.</p>

<ul>
  <li>2.2. ë¡œì»¬ í™˜ê²½ ì„¸íŒ…ì˜ (0), (1)ì„ ì°¸ê³ í•´ì£¼ì„¸ìš”.</li>
</ul>

<p>(4) <code class="language-plaintext highlighter-rouge">airflow</code> ë””ë ‰í† ë¦¬ë¥¼ ë§Œë“¤ê³  Remote Repoë¥¼ Cloneí•œ í›„, <code class="language-plaintext highlighter-rouge">/keys</code>, <code class="language-plaintext highlighter-rouge">.env</code> íŒŒì¼ì€ ì§ì ‘ ì‘ì„±í•´ì¤¬ì–´ìš”.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git clone https://github.com/.../airflow.git
</code></pre></div></div>

<p>(5) ë¡œì»¬ í™˜ê²½ì—ì„œ ì„¸íŒ…í•œ ê²ƒê³¼ ë§ˆì°¬ê°€ì§€ë¡œ Docker Composeë¥¼ ë¹Œë“œí•œ í›„ ì‹¤í–‰í–ˆì–´ìš”.</p>

<ul>
  <li>2.2. ë¡œì»¬ í™˜ê²½ ì„¸íŒ…ì˜ (7), (8)ì„ ì°¸ê³ í•´ì£¼ì„¸ìš”.</li>
</ul>

<p>(6) ë¡œì»¬ í™˜ê²½ì—ì„œ VM Instance Airflow Webserverì— ì ‘ì†í•˜ì—¬ ë¡œê·¸ì¸í–ˆì–´ìš”.</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1) http://{VM Instanceì˜ ì™¸ë¶€ IP ì£¼ì†Œ}:8080 ë¡œ ì ‘ì†í•´ìš”.
2) docker-compose.yamlì—ì„œ ì„¤ì •í–ˆë˜ ì•„ë˜ì˜ í™˜ê²½ ë³€ìˆ˜ë¡œ ë¡œê·¸ì¸í•˜ë©´ ë¼ìš”.
  - _AIRFLOW_WWW_USER_USERNAME
  - _AIRFLOW_WWW_USER_PASSWORD
</code></pre></div></div>

<h3 id="24-dag-ë§Œë“¤ê¸°">2.4. DAG ë§Œë“¤ê¸°</h3>

<p>ì œê°€ ì‘ì„±í•œ DAG ì¤‘ ê°€ì¥ ê°„ë‹¨í•œ ê²ƒì€ â€œ<strong>ë§¤ì¼ ë¹…ì¿¼ë¦¬ ì‚¬ìš©ëŸ‰ ì•Œë¦¼</strong>â€ì…ë‹ˆë‹¤. êµ¬ê¸€ í´ë¼ìš°ë“œë¥¼ ê´€ë¦¬í•˜ê³  ìˆëŠ” ì €ì˜ ì•ˆì‹¬(?)ì„ ë„ëª¨í•˜ê¸° ìœ„í•œ ì…€í”„ ì•Œë¦¼ ëª©ì ì„ ì§€ë‹ˆê³  ìˆëŠ”ë°ìš”. <code class="language-plaintext highlighter-rouge">DAG.py</code> ì½”ë“œë¥¼ ë‹¨ê³„ë¥¼ ë‚˜ëˆ„ì–´ ì„œìˆ í•´ë“œë¦´ê²Œìš”.</p>

<p>(1) í•„ìš”í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ ë° ì˜¤í¼ë ˆì´í„°ë¥¼ ë¶ˆëŸ¬ì™”ì–´ìš”.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># ========================================================================
# ë¼ì´ë¸ŒëŸ¬ë¦¬ ë° í™˜ê²½ë³€ìˆ˜ ë¶ˆëŸ¬ì˜¤ê¸°
# ========================================================================
</span>
<span class="kn">from</span> <span class="n">airflow</span> <span class="kn">import</span> <span class="n">DAG</span>
<span class="kn">from</span> <span class="n">airflow.operators.python</span> <span class="kn">import</span> <span class="n">PythonOperator</span>
<span class="kn">from</span> <span class="n">airflow.providers.slack.operators.slack</span> <span class="kn">import</span> <span class="n">SlackAPIPostOperator</span>
<span class="kn">from</span> <span class="n">airflow.models</span> <span class="kn">import</span> <span class="n">Variable</span>

<span class="kn">from</span> <span class="n">google.cloud</span> <span class="kn">import</span> <span class="n">bigquery</span>

<span class="kn">from</span> <span class="n">pendulum</span> <span class="kn">import</span> <span class="n">timezone</span>
<span class="kn">from</span> <span class="n">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
</code></pre></div></div>

<ul>
  <li>BigQuery ê´€ë ¨ ì˜¤í¼ë ˆì´í„°ë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šê³ , <code class="language-plaintext highlighter-rouge">google.cloud.bigquery</code>ì™€ <code class="language-plaintext highlighter-rouge">PythonOperator</code>ë¥¼ ì‚¬ìš©í–ˆì–´ìš”. Create, Insert, Update ì‘ì—…ì´ ì•„ë‹Œ, Select ì‘ì—…ì˜ ê²½ìš° ì‘ë‹µ ë°›ì•„ì•¼ í•˜ëŠ” ë°ì´í„°ê°€ ë§ìœ¼ë¯€ë¡œ Xcomì„ í™œìš©í•˜ê¸°ì—ëŠ” ë¶€ì ì ˆí•˜ë‹¤ê³  íŒë‹¨í–ˆê¸° ë•Œë¬¸ì´ì—ìš”.</li>
</ul>

<p>(2) ì¤‘ìš”í•œ ë³€ìˆ˜ë“¤ê³¼ í´ë¼ì´ì–¸íŠ¸ë¥¼ ì •ì˜í–ˆì–´ìš”.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># ========================================================================
# í´ë¼ì´ì–¸íŠ¸ ë° ì¤‘ìš”í•œ ë³€ìˆ˜ ì •ì˜
# ========================================================================
</span>
<span class="n">bigquery_client</span> <span class="o">=</span> <span class="n">bigquery</span><span class="p">.</span><span class="nc">Client</span><span class="p">()</span>
<span class="n">kst</span> <span class="o">=</span> <span class="nf">timezone</span><span class="p">(</span><span class="sh">'</span><span class="s">Asia/Seoul</span><span class="sh">'</span><span class="p">)</span>

<span class="n">SLACK_CHANNEL_TEST</span> <span class="o">=</span> <span class="n">Variable</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">'</span><span class="s">slack-channel-test</span><span class="sh">'</span><span class="p">)</span>
<span class="n">SLACK_CHANNEL</span> <span class="o">=</span> <span class="n">Variable</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span>
    <span class="sh">'</span><span class="s">slack-channel-prod</span><span class="sh">'</span><span class="p">,</span>
    <span class="n">default_var</span><span class="o">=</span><span class="n">SLACK_CHANNEL_TEST</span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div></div>

<ul>
  <li><strong>kst</strong>: Airflowì˜ ì‹œê°„ëŒ€ë¥¼ í•œêµ­ ê¸°ì¤€ìœ¼ë¡œ ëª…ì‹œí•˜ê¸° ìœ„í•´ <code class="language-plaintext highlighter-rouge">pendulum.timezone</code>ì„ ì‚¬ìš©í–ˆì–´ìš”. (AirflowëŠ” ê¸°ë³¸ì ìœ¼ë¡œ UTC ê¸°ì¤€ì˜ ì‹œê°„ëŒ€ë¥¼ ë°”ë¼ë³´ê³  ìˆëŠ”ë°, ì‘ì—…ì‹œ ìƒë‹¹íˆ í˜¼ë™ìŠ¤ëŸ¬ìš¸ ìˆ˜ ìˆê±°ë“ ìš”.)</li>
  <li><strong>ìŠ¬ë™ ì±„ë„</strong>: ë³¸ DAGëŠ” ìµœì¢…ì ìœ¼ë¡œ ìŠ¬ë™ ì±„ë„ì— ì•Œë¦¼ì„ ì „ì†¡í•˜ëŠ” Taskë¡œ ëë‚˜ìš”. ë”°ë¼ì„œ, â€œ<strong>í…ŒìŠ¤íŠ¸ ëª©ì ìœ¼ë¡œ ë§Œë“  ìŠ¬ë™ ì±„ë„</strong>â€ì— ê¸°ë³¸ì ìœ¼ë¡œ DAGë¥¼ ì‹¤í–‰í•œ í›„ ë¬¸ì œê°€ ì—†ë‹¤ë©´ ë¹„ë¡œì†Œ íƒ€ê²Ÿ ìŠ¬ë™ ì±„ë„ì— ë°°í¬í•˜ëŠ” ê²ƒì´ ì•Œë¦¼ì„ ë°›ì•„ë³´ëŠ” ë™ë£Œë“¤ì—ê²Œ ì¢‹ì€ ì¸ìƒì„ ì¤„ ìˆ˜ ìˆì„ ê±°ì˜ˆìš”. ë‹¤ìŒê³¼ ê°™ì´, Airflow Webserver ìƒì—ì„œ Variableì„ ì¶”ê°€í•´ì„œ ê´€ë¦¬í–ˆì–´ìš”.</li>
</ul>

<p><img src="/assets/2024-12-28-implementing-airflow/7.webp" alt="" /></p>
<blockquote>
  <p><a href="https://airflow.apache.org/docs/apache-airflow/stable/howto/variable.html">Apache Airflow Docs</a></p>
</blockquote>

<p>(3) DAGì˜ ê¸°ë³¸ Argumentsë¥¼ Dictionaryë¡œ ì •ì˜í•´ì¤¬ì–´ìš”.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># ========================================================================
# DAG Default Arguments ì •ì˜
# ========================================================================
</span>
<span class="n">default_args</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">'</span><span class="s">owner</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">ê¹€ì§„ì„ì˜ ì´ë©”ì¼ ì£¼ì†Œ</span><span class="sh">'</span><span class="p">,</span>
    <span class="sh">'</span><span class="s">start_date</span><span class="sh">'</span><span class="p">:</span> <span class="nf">datetime</span><span class="p">(</span><span class="mi">2025</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">tzinfo</span><span class="o">=</span><span class="n">kst</span><span class="p">),</span>
    <span class="sh">'</span><span class="s">depends_on_past</span><span class="sh">'</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
    <span class="bp">...</span>
<span class="p">}</span>
</code></pre></div></div>

<p>(4) ì¿¼ë¦¬ë¬¸ì„ ë™ì ìœ¼ë¡œ ì‹¤í–‰í•  ìˆ˜ ìˆë„ë¡ í•¨ìˆ˜í™”í–ˆì–´ìš”.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># ========================================================================
# ì¿¼ë¦¬ë¬¸ ì •ì˜
# ========================================================================
</span>
<span class="bp">...</span>

<span class="c1"># ì´ ì‚¬ìš©ëŸ‰ (ì‚¬ìš©ìë³„)
</span><span class="k">def</span> <span class="nf">query_usage_by_user</span><span class="p">(</span><span class="n">date</span><span class="p">):</span>
    <span class="k">return</span> <span class="sa">f</span><span class="sh">"""</span><span class="s">
        SELECT
            user_email AS user,
            SUM(total_bytes_billed) / POW(2, 30) AS gibibyte
        FROM
            `</span><span class="si">{</span><span class="n">project_id</span><span class="si">}</span><span class="s">.</span><span class="si">{</span><span class="n">region</span><span class="si">}</span><span class="s">.INFORMATION_SCHEMA.JOBS`
        WHERE
            DATE(TIMESTAMP(creation_time), </span><span class="sh">"</span><span class="s">Asia/Seoul</span><span class="sh">"</span><span class="s">) = </span><span class="sh">'</span><span class="si">{</span><span class="n">date</span><span class="si">}</span><span class="sh">'</span><span class="s">
            AND job_type = </span><span class="sh">'</span><span class="s">QUERY</span><span class="sh">'</span><span class="s">
        GROUP BY
            1
        ORDER BY
            2 DESC
    </span><span class="sh">"""</span>

<span class="bp">...</span>
</code></pre></div></div>

<p>(5) Taskë“¤ì„ ì‹¤í–‰í•  ì£¼ìš” í•¨ìˆ˜ë“¤ì„ ì‘ì„±í–ˆì–´ìš”.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># ========================================================================
# í•¨ìˆ˜ ì •ì˜
# ========================================================================
</span>
<span class="c1"># BigQuery ë°ì´í„° ì¶”ì¶œ
</span><span class="k">def</span> <span class="nf">fetch_bigquery_data</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

    <span class="c1"># ì–´ì œ ë‚ ì§œ êµ¬í•˜ê¸°
</span>    <span class="n">today_kst</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="sh">'</span><span class="s">execution_date</span><span class="sh">'</span><span class="p">].</span><span class="nf">in_timezone</span><span class="p">(</span><span class="n">kst</span><span class="p">)</span>
    <span class="n">yesterday_kst</span> <span class="o">=</span> <span class="n">today_kst</span><span class="p">.</span><span class="nf">subtract</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">).</span><span class="nf">to_date_string</span><span class="p">()</span>

    <span class="bp">...</span>

    <span class="c1"># ì–´ì œ ì´ ì‚¬ìš©ëŸ‰ (ì‚¬ìš©ìë³„)
</span>    <span class="n">usage_by_user_df</span> <span class="o">=</span> <span class="n">bigquery_client</span><span class="p">.</span><span class="nf">query</span><span class="p">(</span><span class="nf">query_usage_by_user</span><span class="p">(</span><span class="n">yesterday_kst</span><span class="p">)).</span><span class="nf">to_dataframe</span><span class="p">()</span>
    <span class="n">usage_by_user_dict</span> <span class="o">=</span> <span class="n">usage_by_user_df</span><span class="p">.</span><span class="nf">set_index</span><span class="p">(</span><span class="sh">'</span><span class="s">user</span><span class="sh">'</span><span class="p">)[</span><span class="sh">'</span><span class="s">gibibyte</span><span class="sh">'</span><span class="p">].</span><span class="nf">to_dict</span><span class="p">()</span>

    <span class="c1"># XCommìœ¼ë¡œ ë°ì´í„° ì „ë‹¬
</span>    <span class="bp">...</span>
    <span class="n">kwargs</span><span class="p">[</span><span class="sh">'</span><span class="s">ti</span><span class="sh">'</span><span class="p">].</span><span class="nf">xcom_push</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="sh">'</span><span class="s">usage_by_user_dict</span><span class="sh">'</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">usage_by_user_dict</span><span class="p">)</span>
    <span class="bp">...</span>

<span class="c1"># Slack ë©”ì‹œì§€ ì‘ì„±
</span><span class="k">def</span> <span class="nf">write_slack_message</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

    <span class="c1"># BigQuery ê²°ê³¼ ì½ì–´ì˜¤ê¸°
</span>    <span class="bp">...</span>
    <span class="n">usage_by_user_dict</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="sh">'</span><span class="s">ti</span><span class="sh">'</span><span class="p">].</span><span class="nf">xcom_pull</span><span class="p">(</span><span class="n">task_ids</span><span class="o">=</span><span class="sh">'</span><span class="s">fetch_bigquery_data</span><span class="sh">'</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="sh">'</span><span class="s">usage_by_user_dict</span><span class="sh">'</span><span class="p">)</span>

    <span class="c1"># ë©”ì‹œì§€ ë§Œë“¤ê¸°
</span>    <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">:bigquery: *ì „ì¼ BigQuery ì‚¬ìš©ëŸ‰ ìš”ì•½* (í•œêµ­ì‹œê° ê¸°ì¤€)</span><span class="se">\n</span><span class="sh">"</span>
    <span class="bp">...</span>
    <span class="n">message</span> <span class="o">+=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">*:busts_in_silhouette: ì‚¬ìš©ìë³„*</span><span class="se">\n</span><span class="sh">"</span>
    <span class="bp">...</span>
    <span class="k">for</span> <span class="n">user</span><span class="p">,</span> <span class="n">usage</span> <span class="ow">in</span> <span class="n">usage_by_user_dict</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
        <span class="n">message</span> <span class="o">+=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">   - *</span><span class="si">{</span><span class="n">user</span><span class="si">}</span><span class="s">*: `</span><span class="si">{</span><span class="nf">float</span><span class="p">(</span><span class="n">usage</span><span class="p">)</span><span class="si">:</span><span class="p">,.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s">`GiB</span><span class="se">\n</span><span class="sh">"</span>
    <span class="bp">...</span>

    <span class="k">return</span> <span class="n">message</span>
</code></pre></div></div>

<p>(6) ë§ˆì§€ë§‰ìœ¼ë¡œ DAGë¥¼ ì •ì˜í–ˆì–´ìš”.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># ========================================================================
# DAG ì •ì˜
# ========================================================================
</span>
<span class="k">with</span> <span class="nc">DAG</span><span class="p">(</span>
    <span class="sh">'</span><span class="s">DAG.py íŒŒì¼ ì´ë¦„ê³¼ ë™ì¼í•˜ê²Œ ì‘ì„±</span><span class="sh">'</span><span class="p">,</span>
    <span class="n">default_args</span> <span class="o">=</span> <span class="n">default_args</span><span class="p">,</span>
    <span class="n">description</span> <span class="o">=</span> <span class="sh">'</span><span class="s">BigQuery ì‚¬ìš©ëŸ‰ ì•Œë¦¼</span><span class="sh">'</span><span class="p">,</span>
    <span class="n">schedule_interval</span> <span class="o">=</span> <span class="sh">'</span><span class="s">5 0 * * *</span><span class="sh">'</span><span class="p">,</span> <span class="c1"># ë§¤ì¼ 00:05 AM KST
</span>    <span class="n">catchup</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
<span class="p">)</span> <span class="k">as</span> <span class="n">dag</span><span class="p">:</span>
    
    <span class="c1"># BigQuery ë°ì´í„° ì¶”ì¶œ
</span>    <span class="n">task_fetch_bigquery_data</span> <span class="o">=</span> <span class="nc">PythonOperator</span><span class="p">(</span>
        <span class="n">task_id</span> <span class="o">=</span> <span class="sh">'</span><span class="s">fetch_bigquery_data</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">python_callable</span> <span class="o">=</span> <span class="n">fetch_bigquery_data</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Slack ë©”ì‹œì§€ ì‘ì„±
</span>    <span class="n">task_write_slack_message</span> <span class="o">=</span> <span class="nc">PythonOperator</span><span class="p">(</span>
        <span class="n">task_id</span> <span class="o">=</span> <span class="sh">'</span><span class="s">write_slack_message</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">python_callable</span> <span class="o">=</span> <span class="n">write_slack_message</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Slack ë©”ì‹œì§€ ì „ì†¡
</span>    <span class="n">task_send_slack_message</span> <span class="o">=</span> <span class="nc">SlackAPIPostOperator</span><span class="p">(</span>
        <span class="n">task_id</span> <span class="o">=</span> <span class="sh">'</span><span class="s">send_slack_message</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">text</span> <span class="o">=</span> <span class="sh">''</span><span class="p">,</span>
        <span class="n">slack_conn_id</span> <span class="o">=</span> <span class="sh">'</span><span class="s">slack_default</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">channel</span> <span class="o">=</span> <span class="n">SLACK_CHANNEL</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Task ê°„ì˜ ì‹¤í–‰ ìˆœì„œ ì •ì˜
</span>    <span class="n">task_fetch_bigquery_data</span> <span class="o">&gt;&gt;</span> <span class="n">task_write_slack_message</span> <span class="o">&gt;&gt;</span> <span class="n">task_send_slack_message</span>
</code></pre></div></div>

<ul>
  <li>ì´ DAGëŠ” ë‹¤ìŒê³¼ ê°™ì€ íë¦„ìœ¼ë¡œ ê° Taskë“¤ì„ ì‹¤í–‰í•´ìš”.</li>
</ul>

<p><img src="/assets/2024-12-28-implementing-airflow/8.webp" alt="" /></p>

<ul>
  <li>ë‹¤ìŒê³¼ ê°™ì€ ìŠ¬ë™ ë©”ì‹œì§€ê°€ ì „ì†¡ë˜ì—ˆì–´ìš”.</li>
</ul>

<p><img src="/assets/2024-12-28-implementing-airflow/9.webp" alt="" /></p>

<hr />

<h1 id="3-ì•ìœ¼ë¡œì˜-ê³¼ì œ">3. ì•ìœ¼ë¡œì˜ ê³¼ì œ</h1>

<p>ì‚¬ì‹¤, Linuxë‚˜ Docker í™˜ê²½ì— ìµìˆ™í•˜ì§€ ì•Šì€ ì‚¬ëŒë“¤ì—ê²Œ AirflowëŠ” ëŸ¬ë‹ ì»¤ë¸Œê°€ ìƒë‹¹íˆ ê°€íŒŒë¥¸ í¸ì´ì—ìš”. ì—¬ëŸ¬ ê°€ì§€ Orchestration ê´€ë¦¬ ë„êµ¬ ì¤‘ Airflowê°€ ê°€ì¥ ììœ ë„ê°€ ë†’ì€ ë§Œí¼ ì–´ë µê¸° ë•Œë¬¸ì¸ë°ìš”. í•˜ì§€ë§Œ Pythonì— ìƒë‹¹íˆ ìµìˆ™í•œ ë°ì´í„° ë¶„ì„ê°€, ì• ë„ë¦¬í‹±ìŠ¤ ì—”ì§€ë‹ˆì–´, ê·¸ë¦¬ê³  ë°±ì—”ë“œ ê°œë°œìë¼ë©´ ì„œë¡œ ì»¤ë®¤ë‹ˆì¼€ì´ì…˜ì„ í•˜ëŠ” ë° ìƒë‹¹íˆ ë„ì›€ì´ ë  ê±°ì˜ˆìš”.</p>

<p>ì‚¬ë‚´ì— ë³¸ê²©ì ìœ¼ë¡œ Airflowë¥¼ ë„ì…í•œ í›„, ë‹¤ìŒê³¼ ê°™ì€ â€œ<strong>ì‘ìš© ë²„ì „</strong>â€ì˜ ê³ ë¯¼ë“¤ì´ ì¶”ê°€ë¡œ ìƒê²¼ì–´ìš”. ê¼­ í’€ì–´ê°€ê³  ì‹¶ì€ ê²ƒë“¤ì…ë‹ˆë‹¤.</p>

<ul>
  <li>ì™¸ë¶€ ë°ì´í„° ìˆ˜ì§‘ì„ ìœ„í•œ íŒŒì´í”„ë¼ì¸ì„ ì„¤ê³„í•œ í›„, ì •ì œëœ ë°ì´í„°ë¥¼ ì´í•´ê´€ê³„ì ë™ë£Œë“¤ì—ê²Œ ì´ë©”ì¼ì´ë‚˜ ìŠ¬ë™ DMìœ¼ë¡œ ì „ì†¡í•˜ê¸°</li>
  <li>dbtì˜ ê° í…Œì´ë¸” ì˜ì¡´ì„±ì´ë‚˜ ìµœì‹ í™” ì£¼ê¸° ì°¨ì´ì— ë”°ë¼ ë°°ì¹˜ ì‹¤í–‰ì„ ë¶„ë¦¬í•œ í›„ Airflow DAGë¡œ ê´€ë¦¬í•˜ê¸°</li>
  <li>ì´ ì™¸ì—ë„ ì—¬ëŸ¬ ê°€ì§€ ê³ ë¯¼ë“¤</li>
</ul>

<p>Airflowë¥¼ í†µí•´ ìœ ì§€ë³´ìˆ˜ ë¶€ë‹´ì„ ì¤„ì´ê³ , ì›Œí¬í”Œë¡œìš°ì˜ ì•ˆì •ì„±ì„ ì œê³ í•¨ìœ¼ë¡œì¨ ê°œì¸ì ì¸ ì—…ë¬´ íš¨ìœ¨í™”ë¥¼ ê·¹ëŒ€í™”í•  ìˆ˜ ìˆì„ ê²ƒìœ¼ë¡œ ê¸°ëŒ€í•˜ê³  ìˆì–´ìš”. ëŠ˜ì–´ë‚œ ê°€ìš© ì‹œê°„ë§Œí¼ ë”ìš± ì¤‘ìš”í•œ ì¼ì— ëª°ì…í•˜ì—¬ ë™ë£Œë“¤ì´ ë°ì´í„°ë¥¼ ë”ìš± ì˜ í™œìš©í•  ìˆ˜ ìˆëŠ” í™˜ê²½ì„ ë§Œë“¤ ìˆ˜ ìˆê¸°ë¥¼ ë°”ë¼ìš”. ê°œì¸ì ì¸ í•™ìŠµ ë¿ë§Œ ì•„ë‹ˆë¼, ê¸°ì—…ì˜ ì„±ì¥ê³¼ ê³ ê°ì˜ ë§Œì¡±ì„ ìœ„í•œ ë°©í–¥ì¼í…Œë‹ˆê¹Œìš”.</p>

<hr />

<h2 id="published-by-joshua-kim"><em>Published by</em> Joshua Kim</h2>

<p><img src="/assets/profile/joshua-profile.png" alt="Joshua Kim" /></p>]]></content><author><name></name></author><category term="Language (Korean)" /><category term="Article (Project)" /><category term="Level (1. Beginner)" /><category term="Field (Data Engineering)" /><category term="Skills (Airflow)" /><summary type="html"><![CDATA[â€œAirflow ë„ì…ì„ í†µí•´ ì‚¬ë‚´ ë°ì´í„° ì•Œë¦¼ ì‹œìŠ¤í…œì„ íš¨ìœ¨ì ìœ¼ë¡œ ê´€ë¦¬í•˜ê³ ì ê¸°ì¡´ Python ê¸°ë°˜ ì„¸ì…˜ ë°©ì‹ì—ì„œ ë²—ì–´ë‚˜ DAG ê¸°ë°˜ ì›Œí¬í”Œë¡œìš°ë¥¼ êµ¬ì¶•í–ˆìŠµë‹ˆë‹¤. Docker Composeë¥¼ í™œìš©í•´ ë¡œì»¬ ë° VM í™˜ê²½ì—ì„œ Airflowë¥¼ ì„¤ì •í•˜ê³ , Slack ì•Œë¦¼ì„ í¬í•¨í•œ ë‹¤ì–‘í•œ ë°ì´í„° íŒŒì´í”„ë¼ì¸ì„ ìë™í™”í–ˆìŠµë‹ˆë‹¤. ì´ë¥¼ í†µí•´ ìœ ì§€ë³´ìˆ˜ ë¶€ë‹´ì„ ì¤„ì´ê³ , ì•ˆì •ì„±ì„ ë†’ì´ë©°, í™•ì¥ ê°€ëŠ¥í•œ ë°ì´í„° ì²˜ë¦¬ í™˜ê²½ì„ ë§ˆë ¨í•  ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤.â€]]></summary></entry><entry><title type="html">Review of Implementing Airflow</title><link href="http://localhost:4000/implementing-airflow-en/" rel="alternate" type="text/html" title="Review of Implementing Airflow" /><published>2024-12-28T00:00:00+09:00</published><updated>2024-12-28T00:00:00+09:00</updated><id>http://localhost:4000/implementing-airflow-en</id><content type="html" xml:base="http://localhost:4000/implementing-airflow-en/"><![CDATA[<blockquote>
  <p>â€œBy adopting Airflow, we transitioned from a traditional Python-based session approach to a DAG-based workflow to efficiently manage our internal data notification system. Using Docker Compose, we set up Airflow in both local and VM environments and automated various data pipelines, including Slack notifications. This implementation reduced maintenance overhead, improved stability, and established a scalable data processing environment.â€</p>
</blockquote>

<hr />

<h1 id="table-of-contents">Table of Contents</h1>
<ol>
  <li>Background of Adoption</li>
  <li>Review of Implementation
    <ul>
      <li>2.1. Project Plan</li>
      <li>2.2. Local Environment Setup</li>
      <li>2.3. VM Instance Environment Setup</li>
      <li>2.4. Creating a DAG</li>
    </ul>
  </li>
  <li>Future Challenges</li>
</ol>

<hr />

<h1 id="1-background-of-adoption">1. Background of Adoption</h1>

<p>As a Data Engineer at IoTrust, I mainly focus on <strong>Analytics Engineering</strong> tasks such as:</p>

<pre><code class="language-plain">- (1) Designing and developing the data warehouse &amp; data mart
- (2) BI dashboards
- (3) Ad-hoc data notification bot development
- (4) Event taxonomy design and documentation management
- (5) Automation of (Finance/HR/CX) tasks
</code></pre>

<p>However, over time, problems began to arise with my role in â€œ<strong>(3) Ad-hoc data notification bot development</strong>â€. As I worked to enable colleagues to quickly check key metrics on Slack in real-time, the number of Python files gradually increased, and managing them became more resource-intensive.</p>

<p><img src="/assets/2024-12-28-implementing-airflow/1.webp" alt="" /></p>

<p>Specifically, I was managing all Slack notifications by running individual Python files directly in separate sessions using <code class="language-plaintext highlighter-rouge">tmux</code>. <code class="language-plaintext highlighter-rouge">tmux</code> is an open-source terminal multiplexer that allows managing multiple sessions independently within a single terminal. (<a href="https://en.wikipedia.org/wiki/Tmux">Wikipedia</a>)</p>

<p><img src="/assets/2024-12-28-implementing-airflow/2.webp" alt="" /></p>

<p>As the number of Python files grew and the complexity increased, the following issues emerged:</p>

<p><strong>(1) Increased Maintenance Burden</strong></p>

<p>When a Python script encountered an error, execution stopped immediately, and colleagues would not receive notifications until debugging was complete. There was no retry mechanism in place.</p>

<p>Additionally, debugging took a significant amount of time. Since dependent pipeline steps were all managed within a single main() function, identifying the exact failure point was difficult, leading to considerable time wasted. As a result, it became harder to stay focused on more important tasks.</p>

<p><strong>(2) Lack of Stability in Session-Based Management</strong></p>

<p>Server reboots or network issues could disrupt tasks, and there were instances where sessions were unexpectedly terminated, requiring recovery efforts.</p>

<p>Moreover, since all sessions shared the same environment, dependency conflicts could occur even when using <a href="https://docs.python.org/3/library/venv.html">Python Venv</a>.</p>

<p><strong>Due to these reasons, the need for Airflow as a workflow management tool grew stronger.</strong></p>

<ul>
  <li>Tasks can be automatically recovered simply by restarting containers.</li>
  <li>Each task operates in an isolated environment.</li>
  <li>The system is scalable for future workflow expansions.</li>
  <li>The web UI makes task monitoring and management easier.</li>
</ul>

<p>Initially, I had considered introducing Airflow when starting â€œ<strong>Ad-hoc data notification bot development</strong>â€. However, since the workflow was small at the time, I followed the <strong>YAGNI</strong> principle and decided against premature adoption.</p>

<p><a href="https://en.wikipedia.org/wiki/You_aren%27t_gonna_need_it">YAGNI</a> stands for â€œ<strong>You Arenâ€™t Gonna Need It</strong>,â€ an Agile software development principle that advises against adding unnecessary complexity. At that time, I believed in setting up a workflow that only met current needs, so I opted for a session-based approach.</p>

<p>However, as the workflow scaled, inefficiencies and resource waste in session management became more evident. This led me to finally decide on adopting Airflow.</p>

<hr />

<h1 id="2-review-of-implementation">2. Review of Implementation</h1>

<h3 id="21-project-plan">2.1. Project Plan</h3>

<p><img src="/assets/2024-12-28-implementing-airflow/3.webp" alt="" /></p>

<p>First, I established a plan as shown above.</p>

<p>(1) Modify existing Python scripts to fit the <strong>DAG format</strong>.</p>

<p>(2) Build the Airflow project in a <strong>local environment</strong> using Docker Compose and verify that notifications are correctly sent to a Slack test channel.</p>

<p>(3) Deploy the Airflow project on a <strong>VM instance</strong> using Docker Compose to finalize the notification system.</p>

<h3 id="22-local-environment-setup">2.2. Local Environment Setup</h3>

<p>(0) Docker must be installed.</p>

<ul>
  <li>I installed the Docker Desktop app. You can refer to <a href="https://www.docker.com/get-started/">this guide</a> for installation instructions.</li>
</ul>

<p>(1) Created a Python virtual environment.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python <span class="nt">-m</span> venv venv
<span class="nb">source </span>venv/bin/activate
</code></pre></div></div>

<p>(2) Loaded the Airflow image by running the following command in a directory named <code class="language-plaintext highlighter-rouge">airflow</code> (this will generate a <code class="language-plaintext highlighter-rouge">docker-compose.yaml</code> file).</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl <span class="nt">-LfO</span> <span class="s1">'https://airflow.apache.org/docs/apache-airflow/2.9.1/docker-compose.yaml'</span>
</code></pre></div></div>

<p>(3) Created <code class="language-plaintext highlighter-rouge">dags</code>, <code class="language-plaintext highlighter-rouge">logs</code>, <code class="language-plaintext highlighter-rouge">plugins</code> directories and an <code class="language-plaintext highlighter-rouge">.env</code> file with the <strong>AIRFLOW_UID</strong> environment variable.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">mkdir</span> <span class="nt">-p</span> ./dags ./logs ./plugins
<span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"AIRFLOW_UID=</span><span class="si">$(</span><span class="nb">id</span> <span class="nt">-u</span><span class="si">)</span><span class="s2">"</span> <span class="o">&gt;</span> .env
</code></pre></div></div>

<p>(4) Created a <code class="language-plaintext highlighter-rouge">Dockerfile</code> with the following content.</p>

<div class="language-Dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># First-time build can take upto 10 mins.</span>

<span class="k">FROM</span><span class="s"> apache/airflow:2.9.1</span>

<span class="k">ENV</span><span class="s"> AIRFLOW_HOME=/opt/airflow</span>

<span class="k">USER</span><span class="s"> root</span>
<span class="k">RUN </span>apt-get update <span class="nt">-qq</span> <span class="o">&amp;&amp;</span> apt-get <span class="nb">install </span>vim <span class="nt">-qqq</span>
<span class="c"># git gcc g++ -qqq</span>

<span class="k">COPY</span><span class="s"> requirements.txt .</span>
<span class="k">RUN </span>pip <span class="nb">install</span> <span class="nt">--no-cache-dir</span> <span class="nt">-r</span> requirements.txt

<span class="c"># Ref: https://airflow.apache.org/docs/docker-stack/recipes.html</span>

<span class="k">SHELL</span><span class="s"> ["/bin/bash", "-o", "pipefail", "-e", "-u", "-x", "-c"]</span>

<span class="k">ARG</span><span class="s"> CLOUD_SDK_VERSION=322.0.0</span>
<span class="k">ENV</span><span class="s"> GCLOUD_HOME=/home/google-cloud-sdk</span>

<span class="k">ENV</span><span class="s"> PATH="${GCLOUD_HOME}/bin/:${PATH}"</span>

<span class="k">RUN </span><span class="nv">DOWNLOAD_URL</span><span class="o">=</span><span class="s2">"https://dl.google.com/dl/cloudsdk/channels/rapid/downloads/google-cloud-sdk-</span><span class="k">${</span><span class="nv">CLOUD_SDK_VERSION</span><span class="k">}</span><span class="s2">-linux-x86_64.tar.gz"</span> <span class="se">\
</span>    <span class="o">&amp;&amp;</span> <span class="nv">TMP_DIR</span><span class="o">=</span><span class="s2">"</span><span class="si">$(</span><span class="nb">mktemp</span> <span class="nt">-d</span><span class="si">)</span><span class="s2">"</span> <span class="se">\
</span>    <span class="o">&amp;&amp;</span> curl <span class="nt">-fL</span> <span class="s2">"</span><span class="k">${</span><span class="nv">DOWNLOAD_URL</span><span class="k">}</span><span class="s2">"</span> <span class="nt">--output</span> <span class="s2">"</span><span class="k">${</span><span class="nv">TMP_DIR</span><span class="k">}</span><span class="s2">/google-cloud-sdk.tar.gz"</span> <span class="se">\
</span>    <span class="o">&amp;&amp;</span> <span class="nb">mkdir</span> <span class="nt">-p</span> <span class="s2">"</span><span class="k">${</span><span class="nv">GCLOUD_HOME</span><span class="k">}</span><span class="s2">"</span> <span class="se">\
</span>    <span class="o">&amp;&amp;</span> <span class="nb">tar </span>xzf <span class="s2">"</span><span class="k">${</span><span class="nv">TMP_DIR</span><span class="k">}</span><span class="s2">/google-cloud-sdk.tar.gz"</span> <span class="nt">-C</span> <span class="s2">"</span><span class="k">${</span><span class="nv">GCLOUD_HOME</span><span class="k">}</span><span class="s2">"</span> <span class="nt">--strip-components</span><span class="o">=</span>1 <span class="se">\
</span>    <span class="o">&amp;&amp;</span> <span class="s2">"</span><span class="k">${</span><span class="nv">GCLOUD_HOME</span><span class="k">}</span><span class="s2">/install.sh"</span> <span class="se">\
</span>       <span class="nt">--bash-completion</span><span class="o">=</span><span class="nb">false</span> <span class="se">\
</span>       <span class="nt">--path-update</span><span class="o">=</span><span class="nb">false</span> <span class="se">\
</span>       <span class="nt">--usage-reporting</span><span class="o">=</span><span class="nb">false</span> <span class="se">\
</span>       <span class="nt">--quiet</span> <span class="se">\
</span>    <span class="o">&amp;&amp;</span> <span class="nb">rm</span> <span class="nt">-rf</span> <span class="s2">"</span><span class="k">${</span><span class="nv">TMP_DIR</span><span class="k">}</span><span class="s2">"</span> <span class="se">\
</span>    <span class="o">&amp;&amp;</span> gcloud <span class="nt">--version</span>

<span class="k">WORKDIR</span><span class="s"> $AIRFLOW_HOME</span>

<span class="k">COPY</span><span class="s"> scripts scripts</span>
<span class="k">RUN </span><span class="nb">chmod</span> +x scripts

<span class="k">USER</span><span class="s"> $AIRFLOW_UID</span>
</code></pre></div></div>

<p>(5) Created a <code class="language-plaintext highlighter-rouge">requirements.txt</code> file.</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apache-airflow-providers-google
pyarrow
</code></pre></div></div>

<p>(6) Edited <code class="language-plaintext highlighter-rouge">docker-compose.yaml</code> to include environment variables for Google Cloud and Slack authentication.</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">/keys</code>: Used to store the Google Cloud service account JSON key file.</li>
  <li><code class="language-plaintext highlighter-rouge">.env</code>: Stores Airflow Admin login credentials and Slack API token.</li>
</ul>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">x-airflow-common</span><span class="pi">:</span>
  <span class="s">...</span>
  <span class="s">environment</span><span class="err">:</span>
    <span class="s">...</span>
    <span class="s">AIRFLOW__CORE__LOAD_EXAMPLES</span><span class="err">:</span> <span class="s1">'</span><span class="s">false'</span> <span class="c1"># Prevents sample DAGs from being created.</span>
    <span class="s">...</span>
    <span class="s">GOOGLE_APPLICATION_CREDENTIALS</span><span class="err">:</span> <span class="s">/keys/airflow_credentials.json</span> <span class="c1"># Path to Google Cloud service account JSON key file.</span>
    <span class="na">AIRFLOW_CONN_GOOGLE_CLOUD_DEFAULT</span><span class="pi">:</span> <span class="s1">'</span><span class="s">google-cloud-platform://?extra__google_cloud_platform__key_path=/keys/airflow_credentials.json'</span> <span class="c1"># Same as above.</span>
    <span class="na">GCP_PROJECT_ID</span><span class="pi">:</span> <span class="s1">'</span><span class="s">gcp_project_id'</span> <span class="c1"># Google Cloud project ID.</span>
    <span class="na">AIRFLOW_CONN_SLACK_DEFAULT</span><span class="pi">:</span> <span class="s1">'</span><span class="s">slack://:${SLACK_TOKEN}@'</span> <span class="c1"># Slack API token managed in the .env file.</span>
    <span class="s">...</span>
  <span class="na">volumes</span><span class="pi">:</span>
    <span class="s">...</span>
    <span class="s">- ./keys:/keys:ro</span> <span class="c1"># Maps the `/keys` directory containing the Google Cloud service account JSON key file to Docker.</span>
<span class="nn">...</span>
<span class="na">services</span><span class="pi">:</span>
  <span class="s">...</span>
  <span class="s">airflow-init</span><span class="err">:</span>
    <span class="s">...</span>
    <span class="s">environment</span><span class="err">:</span>
      <span class="s">...</span>
      <span class="s">_AIRFLOW_WWW_USER_USERNAME</span><span class="err">:</span> <span class="s">${_AIRFLOW_WWW_USER_USERNAME}</span> <span class="c1"># Airflow Webserver login credentials stored in .env.</span>
      <span class="na">_AIRFLOW_WWW_USER_PASSWORD</span><span class="pi">:</span> <span class="s">${_AIRFLOW_WWW_USER_PASSWORD}</span> <span class="c1"># Airflow Webserver login credentials stored in .env.</span>
      <span class="s">...</span>
</code></pre></div></div>

<p>(7) Building Docker Compose and Initializing Airflow</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker-compose build
docker-compose up airflow-init
</code></pre></div></div>

<p>(8) Running Docker Compose</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker-compose up <span class="nt">-d</span>
docker-compose ps
</code></pre></div></div>

<p>(9) Accessing the Airflow Webserver</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1) Open http://0.0.0.0:8080 in a browser.
2) Log in using the credentials set in the `docker-compose.yaml` file:
  - _AIRFLOW_WWW_USER_USERNAME
  - _AIRFLOW_WWW_USER_PASSWORD
</code></pre></div></div>

<p><img src="/assets/2024-12-28-implementing-airflow/4.webp" alt="" /></p>

<p>(10) Initializing Git and Linking to GitHub</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git init
git remote add origin https://github.com/.../airflow.git
git branch <span class="nt">-m</span> main
git add <span class="nb">.</span>
git commit <span class="nt">-m</span> <span class="s2">"created airflow project"</span>
git push <span class="nt">-u</span> origin main
</code></pre></div></div>

<h3 id="23-vm-instance-environment-setup">2.3. VM Instance Environment Setup</h3>

<p>(1) Creating Firewall Rules (To allow internal access to the Airflow Webserver running on the VM Instance, I configured firewall rules.)</p>

<p><img src="/assets/2024-12-28-implementing-airflow/5.webp" alt="" /></p>

<ul>
  <li><strong>Direction</strong>: Ingress</li>
  <li><strong>Target Tags</strong>: airflow (You can name this as needed.)</li>
  <li><strong>Source Filter &gt; IP Range</strong>: Internal company IP address range.</li>
  <li><strong>Protocol and Port</strong>: tcp-8080 (The webserver communicates with the host machine via port 8080, which can be modified in <code class="language-plaintext highlighter-rouge">docker-compose.yaml</code>.)</li>
</ul>

<p>(2) Creating the <code class="language-plaintext highlighter-rouge">airflow</code> VM Instance</p>

<p><img src="/assets/2024-12-28-implementing-airflow/6.webp" alt="" /></p>

<ul>
  <li><strong>Machine Type</strong>: E2 series with at least 2 vCPUs and 8GB of memory (If using 4GB, the server may struggle with network traffic.)</li>
  <li><strong>OS &amp; Storage</strong>: Debian OS, 10GB storage.</li>
  <li><strong>Firewall</strong>: Enabled HTTP &amp; HTTPS traffic, and assigned the <code class="language-plaintext highlighter-rouge">airflow</code> tag created in the firewall settings.</li>
</ul>

<p>(3) Installing Docker and Python Virtual Environment (Following the same setup as in the local environment)</p>

<ul>
  <li>Refer to steps (0) and (1) from Section 2.2 for installing Docker and setting up a Python virtual environment.</li>
</ul>

<p>(4) Cloning the Repository and Configuring Environment Files (Created the <code class="language-plaintext highlighter-rouge">airflow</code> directory and cloned the remote repository. Then, manually added <code class="language-plaintext highlighter-rouge">/keys</code> and <code class="language-plaintext highlighter-rouge">.env</code> files.)</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git clone https://github.com/.../airflow.git
</code></pre></div></div>

<p>(5) Building and Running Airflow on the VM (Following the same procedure as the local environment)</p>

<ul>
  <li>Refer to steps (7) and (8) from Section 2.2 to build and execute Docker Compose.</li>
</ul>

<p>(6) Accessing the Airflow Webserver on the VM</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1) Open http://{VM Instance External IP}:8080 in a browser.
2) Log in using the credentials set in the docker-compose.yaml file:
  - _AIRFLOW_WWW_USER_USERNAME
  - _AIRFLOW_WWW_USER_PASSWORD
</code></pre></div></div>

<h3 id="24-creating-a-dag">2.4. Creating a DAG</h3>

<p>The simplest DAG I created is <strong>the Daily BigQuery Usage Notification</strong>. This is primarily a self-notification system to help me manage Google Cloud resources efficiently. Below, I will break down the <code class="language-plaintext highlighter-rouge">DAG.py</code> code step by step.</p>

<p>(1) Importing Required Libraries and Operators</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># ========================================================================
# Importing Required Libraries and Environment Variables
# ========================================================================
</span>
<span class="kn">from</span> <span class="n">airflow</span> <span class="kn">import</span> <span class="n">DAG</span>
<span class="kn">from</span> <span class="n">airflow.operators.python</span> <span class="kn">import</span> <span class="n">PythonOperator</span>
<span class="kn">from</span> <span class="n">airflow.providers.slack.operators.slack</span> <span class="kn">import</span> <span class="n">SlackAPIPostOperator</span>
<span class="kn">from</span> <span class="n">airflow.models</span> <span class="kn">import</span> <span class="n">Variable</span>

<span class="kn">from</span> <span class="n">google.cloud</span> <span class="kn">import</span> <span class="n">bigquery</span>

<span class="kn">from</span> <span class="n">pendulum</span> <span class="kn">import</span> <span class="n">timezone</span>
<span class="kn">from</span> <span class="n">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
</code></pre></div></div>

<ul>
  <li>Instead of using BigQuery-specific Airflow operators, I opted for <code class="language-plaintext highlighter-rouge">google.cloud.bigquery</code> and <code class="language-plaintext highlighter-rouge">PythonOperator</code>. Since this DAG primarily involves SELECT queries that return large datasets, using XCom to pass data between tasks would be inefficient.</li>
</ul>

<p>(2) Defining Key Variables and Clients</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># ========================================================================
# Defining Clients and Key Variables
# ========================================================================
</span>
<span class="n">bigquery_client</span> <span class="o">=</span> <span class="n">bigquery</span><span class="p">.</span><span class="nc">Client</span><span class="p">()</span>
<span class="n">kst</span> <span class="o">=</span> <span class="nf">timezone</span><span class="p">(</span><span class="sh">'</span><span class="s">Asia/Seoul</span><span class="sh">'</span><span class="p">)</span>

<span class="n">SLACK_CHANNEL_TEST</span> <span class="o">=</span> <span class="n">Variable</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">'</span><span class="s">slack-channel-test</span><span class="sh">'</span><span class="p">)</span>
<span class="n">SLACK_CHANNEL</span> <span class="o">=</span> <span class="n">Variable</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span>
    <span class="sh">'</span><span class="s">slack-channel-prod</span><span class="sh">'</span><span class="p">,</span>
    <span class="n">default_var</span><span class="o">=</span><span class="n">SLACK_CHANNEL_TEST</span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div></div>

<ul>
  <li><strong>kst</strong>: Since Airflow uses UTC as its default timezone, I explicitly set it to Korean Standard Time using <code class="language-plaintext highlighter-rouge">pendulum.timezone</code>.</li>
  <li><strong>Slack Channel</strong>: The final step in this DAG sends a notification to a Slack channel. To prevent unnecessary alerts, I first test the DAG using <strong>a dedicated Slack test channel</strong> before deploying it to the production channel.</li>
</ul>

<p><img src="/assets/2024-12-28-implementing-airflow/7.webp" alt="" /></p>
<blockquote>
  <p><a href="https://airflow.apache.org/docs/apache-airflow/stable/howto/variable.html">Apache Airflow Docs</a></p>
</blockquote>

<p>(3) Defining DAG Default Arguments</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># ========================================================================
# Defining DAG Default Arguments
# ========================================================================
</span>
<span class="n">default_args</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">'</span><span class="s">owner</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">Joshua Kim</span><span class="sh">'</span><span class="p">,</span>
    <span class="sh">'</span><span class="s">start_date</span><span class="sh">'</span><span class="p">:</span> <span class="nf">datetime</span><span class="p">(</span><span class="mi">2025</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">tzinfo</span><span class="o">=</span><span class="n">kst</span><span class="p">),</span>
    <span class="sh">'</span><span class="s">depends_on_past</span><span class="sh">'</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
    <span class="bp">...</span>
<span class="p">}</span>
</code></pre></div></div>

<p>(4) Writing Dynamic Query Functions</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># ========================================================================
# Query Definitions
# ========================================================================
</span>
<span class="bp">...</span>

<span class="c1"># Query Usage (by user)
</span><span class="k">def</span> <span class="nf">query_usage_by_user</span><span class="p">(</span><span class="n">date</span><span class="p">):</span>
    <span class="k">return</span> <span class="sa">f</span><span class="sh">"""</span><span class="s">
        SELECT
            user_email AS user,
            SUM(total_bytes_billed) / POW(2, 30) AS gibibyte
        FROM
            `</span><span class="si">{</span><span class="n">project_id</span><span class="si">}</span><span class="s">.</span><span class="si">{</span><span class="n">region</span><span class="si">}</span><span class="s">.INFORMATION_SCHEMA.JOBS`
        WHERE
            DATE(TIMESTAMP(creation_time), </span><span class="sh">"</span><span class="s">Asia/Seoul</span><span class="sh">"</span><span class="s">) = </span><span class="sh">'</span><span class="si">{</span><span class="n">date</span><span class="si">}</span><span class="sh">'</span><span class="s">
            AND job_type = </span><span class="sh">'</span><span class="s">QUERY</span><span class="sh">'</span><span class="s">
        GROUP BY
            1
        ORDER BY
            2 DESC
    </span><span class="sh">"""</span>

<span class="bp">...</span>
</code></pre></div></div>

<p>(5) Writing Core Functions for Task Execution</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># ========================================================================
# Function Definitions
# ========================================================================
</span>
<span class="c1"># Fetch BigQuery Data
</span><span class="k">def</span> <span class="nf">fetch_bigquery_data</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

    <span class="c1"># Yesterday
</span>    <span class="n">today_kst</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="sh">'</span><span class="s">execution_date</span><span class="sh">'</span><span class="p">].</span><span class="nf">in_timezone</span><span class="p">(</span><span class="n">kst</span><span class="p">)</span>
    <span class="n">yesterday_kst</span> <span class="o">=</span> <span class="n">today_kst</span><span class="p">.</span><span class="nf">subtract</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">).</span><span class="nf">to_date_string</span><span class="p">()</span>

    <span class="bp">...</span>

    <span class="c1"># Query Usage by user Yesterday
</span>    <span class="n">usage_by_user_df</span> <span class="o">=</span> <span class="n">bigquery_client</span><span class="p">.</span><span class="nf">query</span><span class="p">(</span><span class="nf">query_usage_by_user</span><span class="p">(</span><span class="n">yesterday_kst</span><span class="p">)).</span><span class="nf">to_dataframe</span><span class="p">()</span>
    <span class="n">usage_by_user_dict</span> <span class="o">=</span> <span class="n">usage_by_user_df</span><span class="p">.</span><span class="nf">set_index</span><span class="p">(</span><span class="sh">'</span><span class="s">user</span><span class="sh">'</span><span class="p">)[</span><span class="sh">'</span><span class="s">gibibyte</span><span class="sh">'</span><span class="p">].</span><span class="nf">to_dict</span><span class="p">()</span>

    <span class="c1"># Push Data to XCom
</span>    <span class="bp">...</span>
    <span class="n">kwargs</span><span class="p">[</span><span class="sh">'</span><span class="s">ti</span><span class="sh">'</span><span class="p">].</span><span class="nf">xcom_push</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="sh">'</span><span class="s">usage_by_user_dict</span><span class="sh">'</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">usage_by_user_dict</span><span class="p">)</span>
    <span class="bp">...</span>

<span class="c1"># Write a Slack Message
</span><span class="k">def</span> <span class="nf">write_slack_message</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

    <span class="c1"># Read BigQuery Data
</span>    <span class="bp">...</span>
    <span class="n">usage_by_user_dict</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="sh">'</span><span class="s">ti</span><span class="sh">'</span><span class="p">].</span><span class="nf">xcom_pull</span><span class="p">(</span><span class="n">task_ids</span><span class="o">=</span><span class="sh">'</span><span class="s">fetch_bigquery_data</span><span class="sh">'</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="sh">'</span><span class="s">usage_by_user_dict</span><span class="sh">'</span><span class="p">)</span>

    <span class="c1"># Create a Message
</span>    <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">:bigquery: *Daily BigQuery Usage Summary* (Korean Timezone)</span><span class="se">\n</span><span class="sh">"</span>
    <span class="bp">...</span>
    <span class="n">message</span> <span class="o">+=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">*:busts_in_silhouette: By User*</span><span class="se">\n</span><span class="sh">"</span>
    <span class="bp">...</span>
    <span class="k">for</span> <span class="n">user</span><span class="p">,</span> <span class="n">usage</span> <span class="ow">in</span> <span class="n">usage_by_user_dict</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
        <span class="n">message</span> <span class="o">+=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">   - *</span><span class="si">{</span><span class="n">user</span><span class="si">}</span><span class="s">*: `</span><span class="si">{</span><span class="nf">float</span><span class="p">(</span><span class="n">usage</span><span class="p">)</span><span class="si">:</span><span class="p">,.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s">`GiB</span><span class="se">\n</span><span class="sh">"</span>
    <span class="bp">...</span>

    <span class="k">return</span> <span class="n">message</span>
</code></pre></div></div>

<p>(6) Defining the DAG</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># ========================================================================
# DAG Definition
# ========================================================================
</span>
<span class="k">with</span> <span class="nc">DAG</span><span class="p">(</span>
    <span class="sh">'</span><span class="s">bigquery_usage_alert</span><span class="sh">'</span><span class="p">,</span>
    <span class="n">default_args</span><span class="o">=</span><span class="n">default_args</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="sh">'</span><span class="s">BigQuery Usage Notification</span><span class="sh">'</span><span class="p">,</span>
    <span class="n">schedule_interval</span><span class="o">=</span><span class="sh">'</span><span class="s">5 0 * * *</span><span class="sh">'</span><span class="p">,</span> <span class="c1"># Runs daily at 12:05 AM KST
</span>    <span class="n">catchup</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
<span class="p">)</span> <span class="k">as</span> <span class="n">dag</span><span class="p">:</span>
    
    <span class="c1"># Fetch BigQuery Data
</span>    <span class="n">task_fetch_bigquery_data</span> <span class="o">=</span> <span class="nc">PythonOperator</span><span class="p">(</span>
        <span class="n">task_id</span><span class="o">=</span><span class="sh">'</span><span class="s">fetch_bigquery_data</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">python_callable</span><span class="o">=</span><span class="n">fetch_bigquery_data</span><span class="p">,</span>
    <span class="p">)</span>
    
    <span class="c1"># Write a Slack Message
</span>    <span class="n">task_write_slack_message</span> <span class="o">=</span> <span class="nc">PythonOperator</span><span class="p">(</span>
        <span class="n">task_id</span><span class="o">=</span><span class="sh">'</span><span class="s">write_slack_message</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">python_callable</span><span class="o">=</span><span class="n">write_slack_message</span><span class="p">,</span>
    <span class="p">)</span>
    
    <span class="c1"># Send a Slack Message
</span>    <span class="n">task_send_slack_message</span> <span class="o">=</span> <span class="nc">SlackAPIPostOperator</span><span class="p">(</span>
        <span class="n">task_id</span><span class="o">=</span><span class="sh">'</span><span class="s">send_slack_message</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">text</span><span class="o">=</span><span class="sh">''</span><span class="p">,</span>
        <span class="n">slack_conn_id</span><span class="o">=</span><span class="sh">'</span><span class="s">slack_default</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">channel</span><span class="o">=</span><span class="n">SLACK_CHANNEL</span><span class="p">,</span>
    <span class="p">)</span>
    
    <span class="c1"># Data Lineage
</span>    <span class="n">task_fetch_bigquery_data</span> <span class="o">&gt;&gt;</span> <span class="n">task_write_slack_message</span> <span class="o">&gt;&gt;</span> <span class="n">task_send_slack_message</span>
</code></pre></div></div>

<ul>
  <li>This DAG follows a straightforward workflow:</li>
</ul>

<p><img src="/assets/2024-12-28-implementing-airflow/8.webp" alt="" /></p>

<ul>
  <li>And the Slack notification looks like this:</li>
</ul>

<p><img src="/assets/2024-12-28-implementing-airflow/9.webp" alt="" /></p>

<hr />

<h1 id="3-future-challenges">3. Future Challenges</h1>

<p>Airflow presents a steep learning curve, especially for those unfamiliar with Linux or Docker environments. However, its flexibility makes it an excellent orchestration tool for data analysts, analytics engineers, and backend developers.</p>

<p>Following the successful implementation of Airflow in our company, I am now considering <strong>additional enhancements</strong>:</p>

<ul>
  <li>Designing external data collection pipelines and sending refined data to stakeholders via email or Slack.</li>
  <li>Managing dbt table dependencies by setting up separate batch executions using Airflow DAGs.</li>
  <li>Exploring other optimization opportunities.</li>
</ul>

<p>By reducing maintenance overhead and improving workflow stability through Airflow, I aim to maximize my work efficiency and focus more on high-impact tasks that enable my colleagues to better utilize data. Ultimately, this aligns with both my learning goals and my companyâ€™s growth objectives.</p>

<hr />

<h2 id="published-by-joshua-kim"><em>Published by</em> Joshua Kim</h2>

<p><img src="/assets/profile/joshua-profile.png" alt="Joshua Kim" /></p>]]></content><author><name></name></author><category term="Language (English)" /><category term="Article (Project)" /><category term="Level (1. Beginner)" /><category term="Field (Data Engineering)" /><category term="Skills (Airflow)" /><summary type="html"><![CDATA[â€œBy adopting Airflow, we transitioned from a traditional Python-based session approach to a DAG-based workflow to efficiently manage our internal data notification system. Using Docker Compose, we set up Airflow in both local and VM environments and automated various data pipelines, including Slack notifications. This implementation reduced maintenance overhead, improved stability, and established a scalable data processing environment.â€]]></summary></entry><entry><title type="html">GA4 ê¸°ë°˜ ë°ì´í„° ì›¨ì–´í•˜ìš°ìŠ¤ êµ¬ì¶• í›„ê¸°</title><link href="http://localhost:4000/implementing-data-warehouse-ga4-ko/" rel="alternate" type="text/html" title="GA4 ê¸°ë°˜ ë°ì´í„° ì›¨ì–´í•˜ìš°ìŠ¤ êµ¬ì¶• í›„ê¸°" /><published>2024-11-03T00:00:00+09:00</published><updated>2024-11-03T00:00:00+09:00</updated><id>http://localhost:4000/implementing-data-warehouse-ga4-ko</id><content type="html" xml:base="http://localhost:4000/implementing-data-warehouse-ga4-ko/"><![CDATA[<blockquote>
  <p>â€œì´ ê¸€ì€ Google Analytics 4(GA4) ë°ì´í„°ë¥¼ íš¨ìœ¨ì ìœ¼ë¡œ í™œìš©í•˜ê¸° ìœ„í•´ ë°ì´í„° ì›¨ì–´í•˜ìš°ìŠ¤ë¥¼ êµ¬ì¶•í•œ ê³¼ì •ê³¼ ê²°ê³¼ë¥¼ ê³µìœ í•˜ëŠ” í›„ê¸°ì…ë‹ˆë‹¤. ê¸°ì¡´ì—ëŠ” GA4 Export Tableì— ì§ì ‘ ì¿¼ë¦¬ë¥¼ ì‹¤í–‰í•˜ëŠ” ë°©ì‹ì´ì—ˆì§€ë§Œ, ìŠ¤í‚¤ë§ˆ ë³µì¡ì„±, ëŠë¦° ì¿¼ë¦¬ ì‹¤í–‰ ì‹œê°„, ë†’ì€ ë¹„ìš© ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ ë°ì´í„° ë§ˆíŠ¸ë¥¼ êµ¬ì„±í•˜ê³ , dbtë¥¼ í™œìš©í•œ Incremental Strategyë¥¼ ì ìš©í•˜ì—¬ ì„±ëŠ¥ì„ ìµœì í™”í–ˆìŠµë‹ˆë‹¤. ê·¸ ê²°ê³¼, ì¿¼ë¦¬ ì†ë„ê°€ íšê¸°ì ìœ¼ë¡œ í–¥ìƒë˜ê³  ë¹„ìš©ì´ ì ˆê°ë˜ì—ˆìœ¼ë©°, ì¡°ì§ ë‚´ ë°ì´í„° ì ‘ê·¼ì„±ì´ ë†’ì•„ì ¸ ë³´ë‹¤ íš¨ìœ¨ì ì¸ ë°ì´í„° í™œìš©ì´ ê°€ëŠ¥í•´ì¡ŒìŠµë‹ˆë‹¤.â€</p>
</blockquote>

<hr />

<h1 id="ëª©ì°¨">ëª©ì°¨</h1>
<ol>
  <li>ë“¤ì–´ê°€ëŠ” ê¸€</li>
  <li>ë¬¸ì œ ìƒí™© ì§„ë‹¨
    <ul>
      <li>2.1. ì†ŒìŠ¤ í…Œì´ë¸”ì˜ ê¹Œë‹¤ë¡œìš´ ìŠ¤í‚¤ë§ˆ</li>
      <li>2.2. ëŠë¦° ì¿¼ë¦¬ ì‹¤í–‰ ì‹œê°„ê³¼ ë†’ì€ ì¿¼ë¦¬ ë¹„ìš©</li>
    </ul>
  </li>
  <li>í•´ê²° ë°©ë²•: ë°ì´í„° ì›¨ì–´í•˜ìš°ìŠ¤ êµ¬ì¶•
    <ul>
      <li>3.1. ê° ë°ì´í„° ë§ˆíŠ¸ í…Œì´ë¸”ì˜ ê°„ê²°í•œ ìŠ¤í‚¤ë§ˆ</li>
      <li>3.2. ë¹ ë¥¸ ì¿¼ë¦¬ ì‹¤í–‰ ì‹œê°„ê³¼ ë‚®ì€ ì¿¼ë¦¬ ë¹„ìš©</li>
    </ul>
  </li>
  <li>ë°ì´í„° ì›¨ì–´í•˜ìš°ìŠ¤ êµ¬ì¶• ë°©ë²•
    <ul>
      <li>4.1. ë°ì´í„° ì›¨ì–´í•˜ìš°ìŠ¤ Data Lineage ë¯¸ë¦¬ë³´ê¸°</li>
      <li>4.2. <code class="language-plaintext highlighter-rouge">core_fct_events</code> í…Œì´ë¸” ëª¨ë¸ ë§Œë“¤ê¸°</li>
      <li>4.3. ê° event-specific í…Œì´ë¸” ëª¨ë¸ ë§Œë“¤ê¸°</li>
      <li>4.4. <code class="language-plaintext highlighter-rouge">core_dim_users</code> í…Œì´ë¸” ëª¨ë¸ ë§Œë“¤ê¸°</li>
      <li>4.5. Incremental Strategy ì „ëµì„ ìœ„í•œ Where Statementì™€ Variables ê´€ë¦¬</li>
    </ul>
  </li>
  <li>ê²°ê³¼
    <ul>
      <li>5.1. ì¿¼ë¦¬ ì†ë„ í–¥ìƒ ë° ë¹„ìš© ê°ì†Œ</li>
      <li>5.2. ì¡°ì§ì˜ ë°ì´í„° ì ‘ê·¼ì„± í–¥ìƒ</li>
    </ul>
  </li>
  <li>ë‚˜ê°€ëŠ” ê¸€</li>
</ol>

<hr />

<h1 id="1-ë“¤ì–´ê°€ëŠ”-ê¸€">1. ë“¤ì–´ê°€ëŠ” ê¸€</h1>

<p><img src="/assets/2024-11-03-implementing-data-warehouse-ga4/1.webp" alt="" /></p>
<blockquote>
  <p>ì•„ì´ì˜¤íŠ¸ëŸ¬ìŠ¤íŠ¸ ë°ì´í„° íŒŒì´í”„ë¼ì¸ ê°„ëµí™”</p>
</blockquote>

<p>ì €í¬ íšŒì‚¬ëŠ” B2C í”„ë¡œë•íŠ¸ ë””ì„¼íŠ¸ ì§€ê°‘ê³¼ B2B2C í”„ë¡œë•íŠ¸ ìœ„í•€ ì§€ê°‘ì„ ìš´ì˜í•˜ê³  ìˆìŠµë‹ˆë‹¤. ì´ ì¤‘, ë””ì„¼íŠ¸ ì§€ê°‘ì˜ ê²½ìš° ê¸°ë³¸ì ìœ¼ë¡œ ëª¨ë‘ Google Analytics 4ë¥¼ ê±°ì³ BigQueryì— ë°ì´í„°ë¥¼ ì ì¬í•˜ê³  ìˆëŠ”ë°ìš”!</p>

<p>ë§ì€ ìŠ¤íƒ€íŠ¸ì—…ë“¤ì´ BigQueryì— ì ì¬ëœ Google Analytics 4 Export Tableì— ì§ì ‘ ì¿¼ë¦¬ë¥¼ ì‹¤í–‰í•˜ëŠ” ë°©ì‹ìœ¼ë¡œ ë°ì´í„°ë¥¼ í™œìš©í•˜ê³  ê³„ì‹¤ ê²ƒì…ë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜ ì´ëŸ¬í•œ â€œì†ŒìŠ¤ í…Œì´ë¸”ì— ì˜ì¡´ëœâ€ ì¿¼ë¦¬ ì‹¤í–‰ ë°©ì‹ì€ ì‹œê°„ì´ íë¥¼ìˆ˜ë¡ ì¿¼ë¦¬ ë¹„ìš©ê³¼ ì‹œê°„ì— í° ì¥ì• ë¥¼ ë‚³ê¸° ì‰½ìŠµë‹ˆë‹¤.</p>

<p>ë”°ë¼ì„œ ì €ëŠ” ì´ë¥¼ ê·¹ë³µí•˜ê¸° ìœ„í•´ â€œì •ë§ í”ì¹˜ ì•Šì€â€ GA4 ê¸°ë°˜ ë°ì´í„° ì›¨ì–´í•˜ìš°ìŠ¤ êµ¬ì¡°ë¥¼ ë„ì…í–ˆê³ , ì´ë²ˆ ê¸€ì—ì„œëŠ” ì´ì— ëŒ€í•œ í›„ê¸°ë¥¼ ì „ë‹¬í•´ë“œë¦¬ê³ ì í•©ë‹ˆë‹¤.</p>

<hr />

<h1 id="2-ë¬¸ì œ-ìƒí™©-ì§„ë‹¨">2. ë¬¸ì œ ìƒí™© ì§„ë‹¨</h1>

<h3 id="21-ì†ŒìŠ¤-í…Œì´ë¸”ì˜-ê¹Œë‹¤ë¡œìš´-ìŠ¤í‚¤ë§ˆ">2.1. ì†ŒìŠ¤ í…Œì´ë¸”ì˜ ê¹Œë‹¤ë¡œìš´ ìŠ¤í‚¤ë§ˆ</h3>

<p>BigQueryì— ìŠ¤íŠ¸ë¦¬ë°ë˜ëŠ” Google Analytics 4 Export Tableì€ êµ¬ì¡°ì  í™•ì¥ì— ë”°ë¥¸ ìœ ì—°ì„±ì„ ê°–ì¶”ê³ ì ê° ì´ë²¤íŠ¸ íŒŒë¼ë¯¸í„°ë‚˜ êµ¬ë§¤ ì œí’ˆ ì •ë³´ê°€ RECORD íƒ€ì…ìœ¼ë¡œ ì´ë£¨ì–´ì ¸ ìˆìŠµë‹ˆë‹¤. Columnar Database êµ¬ì¡°ë¥¼ í†µí•´ ìŠ¤í† ë¦¬ì§€ ë¹„ìš©ì„ ì¤„ì´ê¸° ìœ„í•œ êµ¬ê¸€ì˜ ì±„íƒ ë°©ì‹ì¸ ê²ƒì´ì£ .</p>

<p>ê°€ë ¹, <code class="language-plaintext highlighter-rouge">event_params</code> ì˜ ê²½ìš° ë§ˆì¹˜ JSON í˜•ì‹ ì²˜ëŸ¼ Key, Valueê°€ ë¶„ë¦¬ëœ í˜•íƒœë¡œ ì ì¬ë˜ì–´ ìˆì–´ì„œ ì´ë¥¼ ë‹¤ë¤„ë³´ì§€ ì•Šì€ ì‚¬ëŒì—ê²ŒëŠ” ì¿¼ë¦¬ ì‘ì„± ë‚œì´ë„ê°€ ê½¤ ë†’ì€ í¸ì…ë‹ˆë‹¤.</p>

<p><img src="/assets/2024-11-03-implementing-data-warehouse-ga4/2.webp" alt="" /></p>
<blockquote>
  <p>GA4 ì†ŒìŠ¤ í…Œì´ë¸” ìŠ¤í‚¤ë§ˆ (ê³µê°œ ìƒ˜í”Œ í…Œì´ë¸”)</p>
</blockquote>

<p><img src="/assets/2024-11-03-implementing-data-warehouse-ga4/3.webp" alt="" /></p>
<blockquote>
  <p>GA4 ì†ŒìŠ¤ í…Œì´ë¸” ë¯¸ë¦¬ë³´ê¸° (ê³µê°œ ìƒ˜í”Œ í…Œì´ë¸”)</p>
</blockquote>

<p>ë”°ë¼ì„œ ë‹¨ìˆœíˆ íŠ¹ì • í˜ì´ì§€ì˜ ë°©ë¬¸ ìˆ˜ë§Œ ì¶”ì¶œí•˜ë ¤ê³  í•˜ë”ë¼ë„, ì•„ë˜ì™€ ê°™ì´ ë³µì¡í•œ ì¿¼ë¦¬ ì‘ì„±ì´ í•„ìš”í•©ë‹ˆë‹¤. ì²˜ìŒ ì ‘í•˜ëŠ” ì‚¬ëŒì—ê²ŒëŠ” ë¶„ëª… í•™ìŠµì˜ ì–´ë ¤ì›€ì´ ëŠê»´ì§ˆ ê²ƒì…ë‹ˆë‹¤.</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span>
    <span class="n">event_date</span><span class="p">,</span>
    <span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="n">ga_session_id</span><span class="p">)</span> <span class="k">AS</span> <span class="n">sessions_cnt</span><span class="p">,</span>
    <span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="n">user_pseudo_id</span><span class="p">)</span> <span class="k">AS</span> <span class="n">users_cnt</span>
<span class="k">FROM</span>
    <span class="nv">`events_*`</span>
<span class="k">WHERE</span>
    <span class="n">_table_suffix</span> <span class="k">BETWEEN</span> <span class="s1">'20240101'</span> <span class="k">AND</span> <span class="s1">'20241231'</span>
    <span class="k">AND</span> <span class="n">event_name</span> <span class="o">=</span> <span class="s1">'page_view'</span>
    <span class="k">AND</span> <span class="p">(</span><span class="k">SELECT</span> <span class="n">value</span><span class="p">.</span><span class="n">string_value</span> <span class="k">FROM</span> <span class="k">UNNEST</span> <span class="p">(</span><span class="n">event_params</span><span class="p">)</span> <span class="k">WHERE</span> <span class="k">key</span> <span class="o">=</span> <span class="s1">'page_location'</span><span class="p">)</span> <span class="k">LIKE</span> <span class="s1">'%store.dcentwallet.com/pages/dcent-biometric-crypto-wallet%'</span>
<span class="k">GROUP</span> <span class="k">BY</span>
    <span class="mi">1</span>
<span class="k">ORDER</span> <span class="k">BY</span>
    <span class="mi">1</span>
<span class="p">;</span>
</code></pre></div></div>

<p>ë”°ë¼ì„œ ëˆ„êµ¬ë‚˜ ê°„ê²°í™”ëœ í…Œì´ë¸” ìŠ¤í‚¤ë§ˆë¥¼ í†µí•´ ì‰½ê²Œ ì¿¼ë¦¬ë¥¼ ì‘ì„±í•  ìˆ˜ ìˆëŠ” í™˜ê²½ì´ ìš”êµ¬ë˜ëŠ” ê²ƒì…ë‹ˆë‹¤.</p>

<h3 id="22-ëŠë¦°-ì¿¼ë¦¬-ì‹¤í–‰-ì‹œê°„ê³¼-ë†’ì€-ì¿¼ë¦¬-ë¹„ìš©">2.2. ëŠë¦° ì¿¼ë¦¬ ì‹¤í–‰ ì‹œê°„ê³¼ ë†’ì€ ì¿¼ë¦¬ ë¹„ìš©</h3>

<p>ì†ŒìŠ¤ í…Œì´ë¸”ì„ í–¥í•´ ì§ì ‘ ì¿¼ë¦¬ë¥¼ ì‹¤í–‰í•˜ë©´ ì‹œê°„ì´ íë¥¼ìˆ˜ë¡ ì¿¼ë¦¬ ì‹¤í–‰ ì‹œê°„ì´ ëŠë¦´ ë¿ë§Œ ì•„ë‹ˆë¼, ì¿¼ë¦¬ ë¹„ìš© ë¶€ë‹´ë„ ê°€íŒŒë¥´ê²Œ ì¦ê°€í•˜ê²Œ ë©ë‹ˆë‹¤.</p>

<p>íŠ¹íˆ, ì¿¼ë¦¬ë¥¼ ì‘ì„±í•˜ì§€ëŠ” ì•Šì§€ë§Œ ëŒ€ì‹œë³´ë“œë¥¼ ì†Œë¹„í•˜ëŠ” ë™ë£Œì˜ ì…ì¥ì—ì„œ, ëŒ€ì‹œë³´ë“œ ì—…ë°ì´íŠ¸ ê³¼ì •ì´ ì˜¤ë˜ ê±¸ë¦¬ë©´ ë°ì´í„° í™œìš©ë„ì— í° ì˜í–¥ì„ ë¯¸ì¹˜ê²Œ ë©ë‹ˆë‹¤. ì¡°ê¸ˆ ê·¹ë‹¨ì ì´ê¸°ëŠ” í•˜ì§€ë§Œ ì•„ë˜ì™€ ê°™ì€ ëª…ì–¸ë„ ìˆì£ .</p>

<blockquote>
  <p>â€œëŒ€ì‹œë³´ë“œ ì—…ë°ì´íŠ¸ ì‹œê°„ì´ 5ì´ˆë¥¼ ë„˜ì–´ê°€ëŠ” ìˆœê°„, ë§ˆì¼€í„°ì™€ ë””ìì´ë„ˆëŠ” ë°”ë¡œ ì´íƒˆí•´ë²„ë¦¬ê¸° ë§ˆë ¨ì´ë‹¤. ë”°ë¼ì„œ ì¿¼ë¦¬ ìµœì í™”ëŠ” ë°ì´í„° í™œìš©ë„ì— ë§¤ìš° ì¤‘ìš”í•œ ì˜í–¥ì„ ë¼ì¹œë‹¤.â€</p>
</blockquote>

<hr />

<h1 id="3-í•´ê²°-ë°©ë²•-ë°ì´í„°-ì›¨ì–´í•˜ìš°ìŠ¤-êµ¬ì¶•">3. í•´ê²° ë°©ë²•: ë°ì´í„° ì›¨ì–´í•˜ìš°ìŠ¤ êµ¬ì¶•</h1>

<p><img src="/assets/2024-11-03-implementing-data-warehouse-ga4/4.webp" alt="" /></p>
<blockquote>
  <p><a href="https://ardas-it.com/benefits-of-enterprise-data-warehouse">Benefits of Enterprise Data Warehouse</a></p>
</blockquote>

<p>ë°ì´í„° ì›¨ì–´í•˜ìš°ìŠ¤ë¥¼ êµ¬ì¶•í•˜ë©´ ìœ„ì—ì„œ ì–¸ê¸‰í•´ë“œë¦° ë¬¸ì œë¥¼ ë“œë¼ë§ˆí‹±í•˜ê²Œ ê·¹ë³µí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<h3 id="31-ê°-ë°ì´í„°-ë§ˆíŠ¸-í…Œì´ë¸”ì˜-ê°„ê²°í•œ-ìŠ¤í‚¤ë§ˆ">3.1. ê° ë°ì´í„° ë§ˆíŠ¸ í…Œì´ë¸”ì˜ ê°„ê²°í•œ ìŠ¤í‚¤ë§ˆ</h3>

<p>ë™ë£Œë“¤ì´ ì‰½ê²Œ ì¿¼ë¦¬ë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆë„ë¡, ê° ë°ì´í„° ë§ˆíŠ¸ì™€ í…Œì´ë¸” êµ¬ì¡°ë¥¼ ê°„ê²°í™”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ë¥¼ í†µí•´ ë°ì´í„° ë¶„ì„ê°€ë‚˜ ì• ë„ë¦¬í‹±ìŠ¤ ì—”ì§€ë‹ˆì–´ì— ëŒ€í•œ ì˜ì¡´ë„ë¥¼ ì¤„ì´ê³ , ì¦‰ê°ì ìœ¼ë¡œ ì—…ë¬´ì— í™œìš©í•  ìˆ˜ ìˆëŠ” ë°ì´í„° ì¡°íšŒ í™˜ê²½ì„ êµ¬ì¶•í•  ìˆ˜ ìˆê²Œ ë©ë‹ˆë‹¤.</p>

<h3 id="32-ë¹ ë¥¸-ì¿¼ë¦¬-ì‹¤í–‰-ì‹œê°„ê³¼-ë‚®ì€-ì¿¼ë¦¬-ë¹„ìš©">3.2. ë¹ ë¥¸ ì¿¼ë¦¬ ì‹¤í–‰ ì‹œê°„ê³¼ ë‚®ì€ ì¿¼ë¦¬ ë¹„ìš©</h3>

<p>ë°ì´í„° ë§ˆíŠ¸ì˜ í…Œì´ë¸”ë“¤ì€ ëª©ì ì— ë§ëŠ” Columnsì™€ ë°˜ë“œì‹œ í•„ìš”í•œ Rowsë¡œë§Œ êµ¬ì„±ë˜ì–´ ìˆê¸° ë•Œë¬¸ì— ì†ŒìŠ¤ í…Œì´ë¸”ì— ë¹„í•´ ì‚¬ì´ì¦ˆê°€ í›¨ì”¬ ê²½ê°ë˜ê¸° ë§ˆë ¨ì…ë‹ˆë‹¤. ì´ ë•ë¶„ì— ë°ì´í„° ë§ˆíŠ¸ë¥¼ í–¥í•´ ì¿¼ë¦¬ë¥¼ ì‹¤í–‰í•¨ìœ¼ë¡œì¨ ì¿¼ë¦¬ ì‹¤í–‰ ì‹œê°„ê³¼ ì¿¼ë¦¬ ë¹„ìš©ì´ ê¸‰ê²©í•˜ê²Œ ì¤„ì–´ë“¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<hr />

<h1 id="4-ë°ì´í„°-ì›¨ì–´í•˜ìš°ìŠ¤-êµ¬ì¶•-ë°©ë²•">4. ë°ì´í„° ì›¨ì–´í•˜ìš°ìŠ¤ êµ¬ì¶• ë°©ë²•</h1>

<h3 id="41-ë°ì´í„°-ì›¨ì–´í•˜ìš°ìŠ¤-data-lineage-ë¯¸ë¦¬ë³´ê¸°">4.1. ë°ì´í„° ì›¨ì–´í•˜ìš°ìŠ¤ Data Lineage ë¯¸ë¦¬ë³´ê¸°</h3>

<p>ë””ì„¼íŠ¸ ì•± ë°ì´í„° ì›¨ì–´í•˜ìš°ìŠ¤ Core Layerì˜ Data LineageëŠ” ë‹¤ìŒê³¼ ê°™ì´ êµ¬ì„±ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ì¦‰, ì†ŒìŠ¤ í…Œì´ë¸”ì— í•´ë‹¹í•˜ëŠ” <code class="language-plaintext highlighter-rouge">ga4.events</code> ë° <code class="language-plaintext highlighter-rouge">ga4.events_intraday</code>ë¡œë¶€í„° ê° í…Œì´ë¸”ë“¤ì´ Star Schema í˜•íƒœë¡œ ìƒì„±ë©ë‹ˆë‹¤.</p>

<p><img src="/assets/2024-11-03-implementing-data-warehouse-ga4/5.webp" alt="" /></p>
<blockquote>
  <p>ë””ì„¼íŠ¸ ì•± ë°ì´í„° ì›¨ì–´í•˜ìš°ìŠ¤ Data Lineageì˜ ì¼ë¶€</p>
</blockquote>

<h3 id="42core_fct_events-í…Œì´ë¸”-ëª¨ë¸-ë§Œë“¤ê¸°">4.2.<code class="language-plaintext highlighter-rouge">core_fct_events</code> í…Œì´ë¸” ëª¨ë¸ ë§Œë“¤ê¸°</h3>

<p>ìš°ì„ , ëª¨ë“  ì´ë²¤íŠ¸ë“¤ì´ ì ì¬ëœ ê¸°ë³¸ Fact í…Œì´ë¸”ì„ ë§Œë“¤ì—ˆìŠµë‹ˆë‹¤. ê° ì´ë²¤íŠ¸ë“¤ì´ ì§€ë‹Œ ì´ë²¤íŠ¸ íŒŒë¼ë¯¸í„°ëŠ” ì œê°ê¸° ë‹¤ë¥´ë¯€ë¡œ ì´ëŠ” ì œì™¸í•œ ìƒíƒœì—ì„œ ìµœëŒ€í•œ ë§ì€ ì •ë³´ë¥¼ ë‹´ì•„ëƒˆì–´ìš”.</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span>
    <span class="k">DISTINCT</span>

    <span class="n">PARSE_DATE</span><span class="p">(</span><span class="s1">'%Y%m%d'</span><span class="p">,</span> <span class="n">event_date</span><span class="p">)</span> <span class="k">AS</span> <span class="nb">date</span><span class="p">,</span>
    <span class="nb">DATETIME</span><span class="p">(</span><span class="n">TIMESTAMP_MICROS</span><span class="p">(</span><span class="n">event_timestamp</span><span class="p">),</span> <span class="s1">'Asia/Seoul'</span><span class="p">)</span> <span class="k">AS</span> <span class="nb">datetime</span><span class="p">,</span>

    <span class="n">COALESCE</span><span class="p">(</span><span class="n">user_pseudo_id</span><span class="p">,</span> <span class="s1">'UNK'</span><span class="p">)</span> <span class="k">AS</span> <span class="n">user_pseudo_id</span><span class="p">,</span>
    <span class="n">COALESCE</span><span class="p">((</span><span class="k">SELECT</span> <span class="n">value</span><span class="p">.</span><span class="n">int_value</span> <span class="k">FROM</span> <span class="k">UNNEST</span> <span class="p">(</span><span class="n">event_params</span><span class="p">)</span> <span class="k">WHERE</span> <span class="k">key</span> <span class="o">=</span> <span class="s1">'ga_session_id'</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">AS</span> <span class="n">ga_session_id</span><span class="p">,</span>
    <span class="n">COALESCE</span><span class="p">((</span><span class="k">SELECT</span> <span class="n">value</span><span class="p">.</span><span class="n">int_value</span> <span class="k">FROM</span> <span class="k">UNNEST</span> <span class="p">(</span><span class="n">event_params</span><span class="p">)</span> <span class="k">WHERE</span> <span class="k">key</span> <span class="o">=</span> <span class="s1">'ga_session_number'</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">AS</span> <span class="n">ga_session_number</span><span class="p">,</span>

    <span class="n">event_name</span><span class="p">,</span>
    
    <span class="n">COALESCE</span><span class="p">(</span><span class="n">device</span><span class="p">.</span><span class="n">web_info</span><span class="p">.</span><span class="n">hostname</span><span class="p">,</span> <span class="s1">'UNK'</span><span class="p">)</span> <span class="k">AS</span> <span class="n">hostname</span><span class="p">,</span>
    <span class="n">COALESCE</span><span class="p">((</span><span class="k">SELECT</span> <span class="n">value</span><span class="p">.</span><span class="n">string_value</span> <span class="k">FROM</span> <span class="k">UNNEST</span> <span class="p">(</span><span class="n">event_params</span><span class="p">)</span> <span class="k">WHERE</span> <span class="k">key</span> <span class="o">=</span> <span class="s1">'page_location'</span><span class="p">),</span> <span class="s1">'UNK'</span><span class="p">)</span> <span class="k">AS</span> <span class="n">page_location_full</span><span class="p">,</span>        
    <span class="n">COALESCE</span><span class="p">((</span><span class="k">SELECT</span>  <span class="k">FROM</span> <span class="k">UNNEST</span> <span class="p">(</span><span class="n">event_params</span><span class="p">)</span> <span class="k">WHERE</span> <span class="k">key</span> <span class="o">=</span> <span class="s1">'page_location'</span><span class="p">),</span> <span class="s1">'UNK'</span><span class="p">)</span> <span class="k">AS</span> <span class="n">page_location</span><span class="p">,</span>
    <span class="n">COALESCE</span><span class="p">((</span><span class="k">SELECT</span> <span class="n">value</span><span class="p">.</span><span class="n">string_value</span> <span class="k">FROM</span> <span class="k">UNNEST</span> <span class="p">(</span><span class="n">event_params</span><span class="p">)</span> <span class="k">WHERE</span> <span class="k">key</span> <span class="o">=</span> <span class="s1">'page_title'</span><span class="p">),</span> <span class="s1">'UNK'</span><span class="p">)</span> <span class="k">AS</span> <span class="n">page_title</span><span class="p">,</span>

    <span class="n">COALESCE</span><span class="p">(</span>
        <span class="k">LOWER</span><span class="p">((</span><span class="k">SELECT</span> <span class="n">value</span><span class="p">.</span><span class="n">string_value</span> <span class="k">FROM</span> <span class="k">UNNEST</span> <span class="p">(</span><span class="n">user_properties</span><span class="p">)</span> <span class="k">WHERE</span> <span class="k">key</span> <span class="o">=</span> <span class="s1">'xxx'</span><span class="p">)),</span>
        <span class="k">LOWER</span><span class="p">(</span><span class="k">CAST</span><span class="p">((</span><span class="k">SELECT</span> <span class="n">value</span><span class="p">.</span><span class="n">double_value</span> <span class="k">FROM</span> <span class="k">UNNEST</span> <span class="p">(</span><span class="n">user_properties</span><span class="p">)</span> <span class="k">WHERE</span> <span class="k">key</span> <span class="o">=</span> <span class="s1">'xxx'</span><span class="p">)</span> <span class="k">AS</span> <span class="n">STRING</span><span class="p">)),</span>
        <span class="k">LOWER</span><span class="p">(</span><span class="k">CAST</span><span class="p">((</span><span class="k">SELECT</span> <span class="n">value</span><span class="p">.</span><span class="n">float_value</span> <span class="k">FROM</span> <span class="k">UNNEST</span> <span class="p">(</span><span class="n">user_properties</span><span class="p">)</span> <span class="k">WHERE</span> <span class="k">key</span> <span class="o">=</span> <span class="s1">'xxx'</span><span class="p">)</span> <span class="k">AS</span> <span class="n">STRING</span><span class="p">)),</span>
        <span class="k">LOWER</span><span class="p">(</span><span class="k">CAST</span><span class="p">((</span><span class="k">SELECT</span> <span class="n">value</span><span class="p">.</span><span class="n">int_value</span> <span class="k">FROM</span> <span class="k">UNNEST</span> <span class="p">(</span><span class="n">user_properties</span><span class="p">)</span> <span class="k">WHERE</span> <span class="k">key</span> <span class="o">=</span> <span class="s1">'xxx'</span><span class="p">)</span> <span class="k">AS</span> <span class="n">STRING</span><span class="p">)),</span>
        <span class="s1">'UNK'</span>
    <span class="p">)</span> <span class="k">AS</span> <span class="n">xxx</span><span class="p">,</span>

    <span class="n">COALESCE</span><span class="p">(</span><span class="n">platform</span><span class="p">,</span> <span class="s1">'UNK'</span><span class="p">)</span> <span class="k">AS</span> <span class="n">platform</span><span class="p">,</span>
    <span class="n">COALESCE</span><span class="p">(</span><span class="n">device</span><span class="p">.</span><span class="n">operating_system</span><span class="p">,</span> <span class="s1">'UNK'</span><span class="p">)</span> <span class="k">AS</span> <span class="n">device_os</span><span class="p">,</span>
    <span class="n">COALESCE</span><span class="p">(</span><span class="n">device</span><span class="p">.</span><span class="n">category</span><span class="p">,</span> <span class="s1">'UNK'</span><span class="p">)</span> <span class="k">AS</span> <span class="n">device_category</span><span class="p">,</span>
    <span class="n">COALESCE</span><span class="p">(</span><span class="n">app_info</span><span class="p">.</span><span class="k">version</span><span class="p">,</span> <span class="s1">'UNK'</span><span class="p">)</span> <span class="k">AS</span> <span class="n">app_version</span><span class="p">,</span>

    <span class="k">CASE</span>
        <span class="k">WHEN</span> <span class="n">geo</span><span class="p">.</span><span class="n">continent</span> <span class="k">IS</span> <span class="k">NULL</span> <span class="k">THEN</span> <span class="s1">'UNK'</span>
        <span class="k">WHEN</span> <span class="n">geo</span><span class="p">.</span><span class="n">continent</span> <span class="o">=</span> <span class="s1">''</span> <span class="k">THEN</span> <span class="s1">'UNK'</span>
        <span class="k">WHEN</span> <span class="n">geo</span><span class="p">.</span><span class="n">continent</span> <span class="o">=</span> <span class="s1">'(not set)'</span> <span class="k">THEN</span> <span class="s1">'UNK'</span>
        <span class="k">ELSE</span> <span class="n">geo</span><span class="p">.</span><span class="n">continent</span>
    <span class="k">END</span> <span class="k">AS</span> <span class="n">continent</span><span class="p">,</span>
    <span class="k">CASE</span>
        <span class="k">WHEN</span> <span class="n">geo</span><span class="p">.</span><span class="n">country</span> <span class="k">IS</span> <span class="k">NULL</span> <span class="k">THEN</span> <span class="s1">'UNK'</span>
        <span class="k">WHEN</span> <span class="n">geo</span><span class="p">.</span><span class="n">country</span> <span class="o">=</span> <span class="s1">''</span> <span class="k">THEN</span> <span class="s1">'UNK'</span>
        <span class="k">WHEN</span> <span class="n">geo</span><span class="p">.</span><span class="n">country</span> <span class="o">=</span> <span class="s1">'(not set)'</span> <span class="k">THEN</span> <span class="s1">'UNK'</span>
        <span class="k">ELSE</span> <span class="n">geo</span><span class="p">.</span><span class="n">country</span>
    <span class="k">END</span> <span class="k">AS</span> <span class="n">country</span><span class="p">,</span>

    <span class="n">COALESCE</span><span class="p">(</span><span class="n">traffic_source</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">'UNK'</span><span class="p">)</span> <span class="k">AS</span> <span class="n">first_utm_campaign</span><span class="p">,</span>
    <span class="n">COALESCE</span><span class="p">(</span><span class="n">traffic_source</span><span class="p">.</span><span class="n">medium</span><span class="p">,</span> <span class="s1">'UNK'</span><span class="p">)</span> <span class="k">AS</span> <span class="n">first_utm_medium</span><span class="p">,</span>
    <span class="n">COALESCE</span><span class="p">(</span><span class="n">traffic_source</span><span class="p">.</span><span class="k">source</span><span class="p">,</span> <span class="s1">'UNK'</span><span class="p">)</span> <span class="k">AS</span> <span class="n">first_utm_source</span><span class="p">,</span>

    <span class="n">COALESCE</span><span class="p">((</span><span class="k">SELECT</span> <span class="n">value</span><span class="p">.</span><span class="n">string_value</span> <span class="k">FROM</span> <span class="k">UNNEST</span> <span class="p">(</span><span class="n">event_params</span><span class="p">)</span> <span class="k">WHERE</span> <span class="k">key</span> <span class="o">=</span> <span class="s1">'campaign_id'</span><span class="p">),</span> <span class="s1">'UNK'</span><span class="p">)</span> <span class="k">AS</span> <span class="n">event_utm_campaign_id</span><span class="p">,</span>
    <span class="n">COALESCE</span><span class="p">((</span><span class="k">SELECT</span> <span class="n">value</span><span class="p">.</span><span class="n">string_value</span> <span class="k">FROM</span> <span class="k">UNNEST</span> <span class="p">(</span><span class="n">event_params</span><span class="p">)</span> <span class="k">WHERE</span> <span class="k">key</span> <span class="o">=</span> <span class="s1">'campaign'</span><span class="p">),</span> <span class="s1">'UNK'</span><span class="p">)</span> <span class="k">AS</span> <span class="n">event_utm_campaign</span><span class="p">,</span>
    <span class="n">COALESCE</span><span class="p">((</span><span class="k">SELECT</span> <span class="n">value</span><span class="p">.</span><span class="n">string_value</span> <span class="k">FROM</span> <span class="k">UNNEST</span> <span class="p">(</span><span class="n">event_params</span><span class="p">)</span> <span class="k">WHERE</span> <span class="k">key</span> <span class="o">=</span> <span class="s1">'medium'</span><span class="p">),</span> <span class="s1">'UNK'</span><span class="p">)</span> <span class="k">AS</span> <span class="n">event_utm_medium</span><span class="p">,</span>
    <span class="n">COALESCE</span><span class="p">((</span><span class="k">SELECT</span> <span class="n">value</span><span class="p">.</span><span class="n">string_value</span> <span class="k">FROM</span> <span class="k">UNNEST</span> <span class="p">(</span><span class="n">event_params</span><span class="p">)</span> <span class="k">WHERE</span> <span class="k">key</span> <span class="o">=</span> <span class="s1">'source'</span><span class="p">),</span> <span class="s1">'UNK'</span><span class="p">)</span> <span class="k">AS</span> <span class="n">event_utm_source</span><span class="p">,</span>
    <span class="n">COALESCE</span><span class="p">((</span><span class="k">SELECT</span> <span class="n">value</span><span class="p">.</span><span class="n">string_value</span> <span class="k">FROM</span> <span class="k">UNNEST</span> <span class="p">(</span><span class="n">event_params</span><span class="p">)</span> <span class="k">WHERE</span> <span class="k">key</span> <span class="o">=</span> <span class="s1">'term'</span><span class="p">),</span> <span class="s1">'UNK'</span><span class="p">)</span> <span class="k">AS</span> <span class="n">event_utm_term</span><span class="p">,</span>
    <span class="n">COALESCE</span><span class="p">((</span><span class="k">SELECT</span> <span class="n">value</span><span class="p">.</span><span class="n">string_value</span> <span class="k">FROM</span> <span class="k">UNNEST</span> <span class="p">(</span><span class="n">event_params</span><span class="p">)</span> <span class="k">WHERE</span> <span class="k">key</span> <span class="o">=</span> <span class="s1">'content'</span><span class="p">),</span> <span class="s1">'UNK'</span><span class="p">)</span> <span class="k">AS</span> <span class="n">event_utm_content</span><span class="p">,</span>
    <span class="p">...</span>
<span class="k">FROM</span>
    
<span class="k">WHERE</span>
    <span class="n">event_date</span> <span class="k">IS</span> <span class="k">NOT</span> <span class="k">NULL</span>
    <span class="k">AND</span> <span class="n">event_timestamp</span> <span class="k">IS</span> <span class="k">NOT</span> <span class="k">NULL</span>
    <span class="k">AND</span> <span class="n">event_name</span> <span class="k">IS</span> <span class="k">NOT</span> <span class="k">NULL</span>
    <span class="p">...</span>
</code></pre></div></div>

<p>(1) GA4 Export Tableì—ëŠ” ëª¨ì¢…ì˜ ì´ìœ ë¡œ ì™„ì „íˆ ë™ì¼í•œ ì´ë²¤íŠ¸ê°€ ì—°ë‹¬ì•„ 2ë²ˆ ìˆ˜ì§‘ë˜ëŠ” ê²½ìš°ê°€ ë§ìŠµë‹ˆë‹¤. íŠ¹íˆ, ì•±ì˜ ê°œë°œ ì†ŒìŠ¤ ì½”ë“œì˜ êµ¬ì¡°ì— ë”°ë¼ ì´ëŸ° ê²½ìš°ê°€ ë¹ˆë²ˆí•˜ê²Œ ë°œìƒí•˜ëŠ”ë°ìš”. ì´ëŠ” Aggregation ê³¼ì •ì‹œ ë°ì´í„° ì™œê³¡ì´ ë°œìƒí•˜ê¸° ì‰¬ìœ¼ë¯€ë¡œ ì—°ì‚° ë¹„ìš©ì´ ë°œìƒí•˜ë”ë¼ë„ DISTINCT ë¥¼ í†µí•´ ì¤‘ë³µì„ ë°˜ë“œì‹œ ì œê±°í•˜ë„ë¡ í–ˆìŠµë‹ˆë‹¤.</p>

<p>(2) ê° ì´ë²¤íŠ¸ íŒŒë¼ë¯¸í„°ë‚˜ ì‚¬ìš©ì ì†ì„±ì˜ ê²½ìš° UNNESTë¥¼ í†µí•´ Select Subqueryë¥¼ ì‚¬ìš©í•¨ìœ¼ë¡œì¨ ëª¨ë¸ ì¿¼ë¦¬ë¬¸ì„ ê°„ê²°í™”í•˜ë„ë¡ ë…¸ë ¥í–ˆìŠµë‹ˆë‹¤.</p>

<p>(3) Null Handlingì„ ìœ„í•´ ë‹¤ìŒê³¼ ê°™ì€ ê·œì¹™ì„ ì •í–ˆìŠµë‹ˆë‹¤. ì´ëŠ” Aggregation ê³¼ì •ì—ì„œ Nullì˜ ì¡´ì¬ë¡œ ì¸í•œ ë°ì´í„° ì™œê³¡ í˜„ìƒì„ ì›ì²œì ìœ¼ë¡œ ì°¨ë‹¨í•˜ê¸° ìœ„í•œ ì¡°ì¹˜ì˜€ì–´ìš”.</p>

<ul>
  <li>String: â€œUNKâ€ (unknown)</li>
  <li>Number: -1</li>
  <li>Date: â€œ1900â€“01â€“01â€</li>
</ul>

<p>(4) <code class="language-plaintext highlighter-rouge">event_date</code>, <code class="language-plaintext highlighter-rouge">event_timestamp</code>, <code class="language-plaintext highlighter-rouge">event_name</code> ê°’ì´ ì¡´ì¬í•˜ì§€ ì•ŠëŠ” Rowsì˜ ê²½ìš° ì• ì´ˆì— ëª¨ë¸ì— ì ì¬í•˜ì§€ ì•Šë„ë¡ í–ˆìŠµë‹ˆë‹¤. ì„¸ ê°€ì§€ ê°’ ì¤‘ í•˜ë‚˜ë¼ë„ ì•Œ ìˆ˜ ì—†ë‹¤ë©´ ë°ì´í„°ë¡œì„œ ì•„ë¬´ëŸ° ê°€ì¹˜ë¥¼ ì°½ì¶œí•  ìˆ˜ ì—†ë‹¤ê³  íŒë‹¨í–ˆê¸° ë•Œë¬¸ì´ì—ìš”.</p>

<p>(5) <code class="language-plaintext highlighter-rouge">page_location</code>ì˜ ê²½ìš°, í˜ì´ì§€ URL ë‚´ì˜ ì¿¼ë¦¬ ìš”ì†Œê°€ ì œê°ê¸° ë‹¤ë¥¼ ê²½ìš° ì´ë¥¼ ì „ì²˜ë¦¬í•˜ëŠ” ê³¼ì •ì´ ì¿¼ë¦¬ ì‘ì„±ìì—ê²Œ ì‹œê°„ ì†Œëª¨ê°€ ë§ìŠµë‹ˆë‹¤. ë”°ë¼ì„œ <code class="language-plaintext highlighter-rouge">clean_url</code>ì´ë¼ëŠ” dbt ë§¤í¬ë¡œ í•¨ìˆ˜ë¥¼ ì§ì ‘ ì •ì˜í•˜ì—¬ ê¹¨ë—í•˜ê³  ê·œì¹™ì ìœ¼ë¡œ ì¶œë ¥ë  ìˆ˜ ìˆë„ë¡ ì ìš©í–ˆì–´ìš”.</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">clean_url</code> ë§¤í¬ë¡œ ì‚¬ë¡€</li>
</ul>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="o">%</span> <span class="n">macro</span> <span class="n">clean_url</span><span class="p">(</span><span class="k">column_name</span><span class="p">)</span> <span class="o">%</span><span class="p">}</span>

    <span class="k">REPLACE</span><span class="p">(</span>
        <span class="n">REGEXP_REPLACE</span><span class="p">(</span>
            <span class="n">REGEXP_REPLACE</span><span class="p">(</span>
                <span class="k">LOWER</span><span class="p">({{</span> <span class="k">column_name</span> <span class="p">}}),</span>
                <span class="n">r</span><span class="s1">'(</span><span class="se">\?</span><span class="s1">.*)$'</span><span class="p">,</span>
                <span class="s1">''</span>
            <span class="p">),</span>
            <span class="n">r</span><span class="s1">'/$'</span><span class="p">,</span>
            <span class="s1">''</span>
        <span class="p">),</span>
        <span class="s1">'https://'</span><span class="p">,</span>
        <span class="s1">''</span>
    <span class="p">)</span>

<span class="p">{</span><span class="o">%</span> <span class="n">endmacro</span> <span class="o">%</span><span class="p">}</span>
</code></pre></div></div>

<h3 id="43-ê°-event-specific-í…Œì´ë¸”-ëª¨ë¸-ë§Œë“¤ê¸°">4.3. ê° event-specific í…Œì´ë¸” ëª¨ë¸ ë§Œë“¤ê¸°</h3>

<p>ì „ìˆ í•´ë“œë ¸ë“¯ì´, ê° ì´ë²¤íŠ¸ë§ˆë‹¤ ì™„ì „íˆ ë‹¤ë¥¸ ì´ë²¤íŠ¸ íŒŒë¼ë¯¸í„° êµ¬ì¡°ë¥¼ ì§€ë‹ˆê³  ìˆìŠµë‹ˆë‹¤. ì´ë²¤íŠ¸ íŒŒë¼ë¯¸í„° ì •ë³´ëŠ” ê° ì´ë²¤íŠ¸ ë³„ë¡œ ë…ë¦½ì ìœ¼ë¡œ ì ìš©ë˜ë„ë¡ êµ¬ì¶•í•˜ëŠ” ê²ƒì´ í•„ìš”í–ˆëŠ”ë°ìš”. ê°€ë ¹, ì¡°ì§ì˜ ì´ë²¤íŠ¸ íƒì†Œë…¸ë¯¸ê°€ ë³€ê²½ë˜ì–´ ì‹ ê·œ íŒŒë¼ë¯¸í„°ë¥¼ ìˆ˜ì§‘í•˜ê²Œ ë˜ì—ˆë‹¤ë©´, ì´ë¥¼ ë°ì´í„° ì›¨ì–´í•˜ìš°ìŠ¤ ì „ì²´ì— ì ìš©í•˜ê²Œ ë˜ë©´ ì¿¼ë¦¬ ë¹„ìš©ì´ ê¸‰ê²©í•˜ê²Œ ì¦ê°€í•  ìˆ˜ë°–ì— ì—†ì„ ê²ƒì…ë‹ˆë‹¤. ë”°ë¼ì„œ ì´ë¥¼ event-specificí•˜ê²Œ ê´€ë¦¬í•¨ìœ¼ë¡œì¨, ë°˜ë“œì‹œ í•„ìš”í•œ ì´ë²¤íŠ¸ ì „ìš© í…Œì´ë¸”ì—ë§Œ ì˜í–¥ì„ ë¼ì¹˜ë„ë¡ í–ˆìŠµë‹ˆë‹¤. ì†ŒìŠ¤ í…Œì´ë¸”ì˜ ë³€ë™ìœ¼ë¡œ ì¸í•œ ì˜í–¥ì„ ìµœì†Œí™”í•˜ê¸° ìœ„í•œ ì„¤ê³„ì¸ ê²ƒì´ì£ .</p>

<p>ê°€ë ¹, ì•„ë˜ ëª¨ë¸ ì¿¼ë¦¬ë¬¸ì€ <code class="language-plaintext highlighter-rouge">click_tab</code>ì´ë¼ëŠ” ì´ë²¤íŠ¸ì™€ <code class="language-plaintext highlighter-rouge">to_tab_name</code> íŒŒë¼ë¯¸í„° ì •ë³´ë§Œì„ ë‹´ì€ <code class="language-plaintext highlighter-rouge">core_fct_evt_click_tab</code>ì…ë‹ˆë‹¤.</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span>
    <span class="k">DISTINCT</span>

    <span class="n">PARSE_DATE</span><span class="p">(</span><span class="s1">'%Y%m%d'</span><span class="p">,</span> <span class="n">event_date</span><span class="p">)</span> <span class="k">AS</span> <span class="nb">date</span><span class="p">,</span>
    <span class="nb">DATETIME</span><span class="p">(</span><span class="n">TIMESTAMP_MICROS</span><span class="p">(</span><span class="n">event_timestamp</span><span class="p">),</span> <span class="s1">'Asia/Seoul'</span><span class="p">)</span> <span class="k">AS</span> <span class="nb">datetime</span><span class="p">,</span>

    <span class="n">COALESCE</span><span class="p">(</span><span class="n">user_pseudo_id</span><span class="p">,</span> <span class="s1">'UNK'</span><span class="p">)</span> <span class="k">AS</span> <span class="n">user_pseudo_id</span><span class="p">,</span>
    <span class="n">COALESCE</span><span class="p">((</span><span class="k">SELECT</span> <span class="n">value</span><span class="p">.</span><span class="n">int_value</span> <span class="k">FROM</span> <span class="k">UNNEST</span> <span class="p">(</span><span class="n">event_params</span><span class="p">)</span> <span class="k">WHERE</span> <span class="k">key</span> <span class="o">=</span> <span class="s1">'ga_session_id'</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">AS</span> <span class="n">ga_session_id</span><span class="p">,</span>
    <span class="n">COALESCE</span><span class="p">((</span><span class="k">SELECT</span> <span class="n">value</span><span class="p">.</span><span class="n">int_value</span> <span class="k">FROM</span> <span class="k">UNNEST</span> <span class="p">(</span><span class="n">event_params</span><span class="p">)</span> <span class="k">WHERE</span> <span class="k">key</span> <span class="o">=</span> <span class="s1">'ga_session_number'</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">AS</span> <span class="n">ga_session_number</span><span class="p">,</span>

    <span class="n">COALESCE</span><span class="p">(</span><span class="n">device</span><span class="p">.</span><span class="n">web_info</span><span class="p">.</span><span class="n">hostname</span><span class="p">,</span> <span class="s1">'UNK'</span><span class="p">)</span> <span class="k">AS</span> <span class="n">hostname</span><span class="p">,</span>
    <span class="n">COALESCE</span><span class="p">((</span><span class="k">SELECT</span> <span class="n">value</span><span class="p">.</span><span class="n">string_value</span> <span class="k">FROM</span> <span class="k">UNNEST</span> <span class="p">(</span><span class="n">event_params</span><span class="p">)</span> <span class="k">WHERE</span> <span class="k">key</span> <span class="o">=</span> <span class="s1">'page_location'</span><span class="p">),</span> <span class="s1">'UNK'</span><span class="p">)</span> <span class="k">AS</span> <span class="n">page_location_full</span><span class="p">,</span>        
    <span class="n">COALESCE</span><span class="p">((</span><span class="k">SELECT</span> <span class="p">{{</span> <span class="n">clean_url</span><span class="p">(</span><span class="s1">'value.string_value'</span><span class="p">)</span> <span class="p">}}</span> <span class="k">FROM</span> <span class="k">UNNEST</span> <span class="p">(</span><span class="n">event_params</span><span class="p">)</span> <span class="k">WHERE</span> <span class="k">key</span> <span class="o">=</span> <span class="s1">'page_location'</span><span class="p">),</span> <span class="s1">'UNK'</span><span class="p">)</span> <span class="k">AS</span> <span class="n">page_location</span><span class="p">,</span>
    <span class="n">COALESCE</span><span class="p">((</span><span class="k">SELECT</span> <span class="n">value</span><span class="p">.</span><span class="n">string_value</span> <span class="k">FROM</span> <span class="k">UNNEST</span> <span class="p">(</span><span class="n">event_params</span><span class="p">)</span> <span class="k">WHERE</span> <span class="k">key</span> <span class="o">=</span> <span class="s1">'page_title'</span><span class="p">),</span> <span class="s1">'UNK'</span><span class="p">)</span> <span class="k">AS</span> <span class="n">page_title</span><span class="p">,</span>

    <span class="n">COALESCE</span><span class="p">((</span><span class="k">SELECT</span> <span class="p">{{</span> <span class="n">clean_url</span><span class="p">(</span><span class="s1">'value.string_value'</span><span class="p">)</span> <span class="p">}}</span> <span class="k">FROM</span> <span class="k">UNNEST</span> <span class="p">(</span><span class="n">event_params</span><span class="p">)</span> <span class="k">WHERE</span> <span class="k">key</span> <span class="o">=</span> <span class="s1">'to_tab_name'</span><span class="p">),</span> <span class="s1">'UNK'</span><span class="p">)</span> <span class="k">AS</span> <span class="n">to_tab_name</span><span class="p">,</span>
    <span class="p">...</span>
<span class="k">FROM</span>
    <span class="p">{{</span> <span class="k">source</span><span class="p">(</span><span class="s1">'ga4'</span><span class="p">,</span> <span class="s1">'events'</span><span class="p">)</span> <span class="p">}}</span>
<span class="k">WHERE</span>
    <span class="n">event_date</span> <span class="k">IS</span> <span class="k">NOT</span> <span class="k">NULL</span>
    <span class="k">AND</span> <span class="n">event_timestamp</span> <span class="k">IS</span> <span class="k">NOT</span> <span class="k">NULL</span>
    <span class="k">AND</span> <span class="n">event_name</span> <span class="o">=</span> <span class="s1">'click_tab'</span>
    <span class="p">...</span>
</code></pre></div></div>

<p>(1) Geo, Demographic, Tech ë“±ì˜ ìƒì„¸í•œ ì¹¼ëŸ¼ë“¤ì€ êµ³ì´ ìˆ˜ì§‘í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì´ëŠ” <code class="language-plaintext highlighter-rouge">core_fct_events</code> í…Œì´ë¸”ê³¼ <code class="language-plaintext highlighter-rouge">core_dim_users</code> í…Œì´ë¸”ì„ í†µí•´ JOINí•˜ë„ë¡ ê´€ë¦¬í•˜ëŠ” ê²ƒì´ Star Schema ê´€ì ì—ì„œ ë”ìš± ë°”ëŒì§í•œ êµ¬ì¡°ì´ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.</p>

<p>(2) ê° event-specificí•œ ëª¨ë¸ ì¿¼ë¦¬ë¬¸ ìˆ˜ì‹­ ê°œë¥¼ ì´ëŸ° ë°©ì‹ìœ¼ë¡œ ìƒì„±í•´ë‘ì—ˆìŠµë‹ˆë‹¤.</p>

<p><img src="/assets/2024-11-03-implementing-data-warehouse-ga4/6.webp" alt="" /></p>
<blockquote>
  <p>ë””ì„¼íŠ¸ ì•± ë°ì´í„° ì›¨ì–´í•˜ìš°ìŠ¤ Data Lineageì˜ ì¼ë¶€</p>
</blockquote>

<p>í•œí¸, <code class="language-plaintext highlighter-rouge">core_fct_events</code> ëª¨ë¸ê³¼ ê° event-specific ëª¨ë¸ë“¤ì˜ Configurationì€ ë‹¤ìŒê³¼ ê°™ì´ êµ¬ì„±í–ˆìŠµë‹ˆë‹¤.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">version</span><span class="pi">:</span> <span class="s">xxx</span>

<span class="na">models</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">core_fct_events</span>
    <span class="na">description</span><span class="pi">:</span> <span class="s">ì „ì²´ ì´ë²¤íŠ¸ í…Œì´ë¸”</span>
    <span class="na">meta</span><span class="pi">:</span>
      <span class="na">owner</span><span class="pi">:</span> <span class="s">js.kim@iotrust.kr</span>
    <span class="na">config</span><span class="pi">:</span>
      <span class="na">tags</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">core"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">fact"</span><span class="pi">]</span>
      <span class="na">materialized</span><span class="pi">:</span> <span class="s">incremental</span>
      <span class="na">incremental_strategy</span><span class="pi">:</span> <span class="s">insert_overwrite</span>
      <span class="na">on_schema_change</span><span class="pi">:</span> <span class="s">append_new_columns</span>
      <span class="na">partition_by</span><span class="pi">:</span>
        <span class="na">field</span><span class="pi">:</span> <span class="s">date</span>
        <span class="na">data_type</span><span class="pi">:</span> <span class="s">date</span>
        <span class="na">granularity</span><span class="pi">:</span> <span class="s">day</span>
      <span class="na">time_ingestion_partitioning</span><span class="pi">:</span> <span class="kc">true</span>
      <span class="na">require_partition_filter</span><span class="pi">:</span> <span class="kc">true</span>
      <span class="na">copy_partitions</span><span class="pi">:</span> <span class="kc">true</span>
    <span class="na">columns</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">date</span>
        <span class="na">description</span><span class="pi">:</span> <span class="s">ì´ë²¤íŠ¸ ë°œìƒ ì¼ì (NOT NULL)</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">datetime</span>
        <span class="na">description</span><span class="pi">:</span> <span class="s">ì´ë²¤íŠ¸ ë°œìƒ ì¼ì‹œ (NOT NULL)</span>
      <span class="s">...</span>

</code></pre></div></div>

<p>(1) <code class="language-plaintext highlighter-rouge">date</code> ì¹¼ëŸ¼ì„ íŒŒí‹°ì…˜ ê¸°ì¤€ìœ¼ë¡œ ì •í–ˆìŠµë‹ˆë‹¤.</p>

<p>(2) í…Œì´ë¸”ì„ í–¥í•´ ì¿¼ë¦¬ë¥¼ ì‹¤í–‰í•  ë•Œ <code class="language-plaintext highlighter-rouge">date</code> íŒŒí‹°ì…˜ í•„í„°ë¥¼ ì ìš©í•˜ë„ë¡ ê°•ì œí–ˆìŠµë‹ˆë‹¤. (<strong>require_partition_filter</strong>) ì´ëŠ” í–¥í›„ ì „ì²´ í…Œì´ë¸”ì„ ì½ì–´ì˜¤ëŠ” ë“± ì¿¼ë¦¬ ì‹¤í–‰ ë¹„ìš©ì„ ì¤„ì´ê¸° ìœ„í•œ ì˜ë„ì ì¸ ì¥ì¹˜ì˜€ì–´ìš”.</p>

<p>(3) Materialization StrategyëŠ” Incremental (Insert Overwrite) ë°©ì‹ì„ ì ìš©í–ˆìŠµë‹ˆë‹¤.</p>

<ul>
  <li>ë””ì„¼íŠ¸ ì•± ë°ì´í„° ì›¨ì–´í•˜ìš°ìŠ¤ëŠ” í˜„ì¬ ë§¤ 1ì‹œê°„ ë§ˆë‹¤ ì—…ë°ì´íŠ¸ ë˜ë„ë¡ êµ¬ì¶•í–ˆëŠ”ë°ìš”. ë§¤ë²ˆ Incremental Updateê°€ ë°œìƒí•  ë•Œ ê° <code class="language-plaintext highlighter-rouge">date</code>ë³„ ì†ŒìŠ¤ í…Œì´ë¸”ì˜ ì—…ë°ì´íŠ¸ ìœ ë¬´ë¥¼ í™•ì¸í•˜ì—¬ ì—…ë°ì´íŠ¸ê°€ ëœ <code class="language-plaintext highlighter-rouge">date</code> í…Œì´ë¸” ë°ì´í„°ë¥¼ ë°°ì¹˜ì— ì ìš©í•©ë‹ˆë‹¤.</li>
  <li>BigQueryì˜ <code class="language-plaintext highlighter-rouge">date</code> íŒŒí‹°ì…˜ í™˜ê²½ì—ì„œ Insert Overwrite ë°©ì‹ì„ ì‚¬ìš©í•˜ë©´, í•´ë‹¹ <code class="language-plaintext highlighter-rouge">date</code> í…Œì´ë¸”ì˜ ë°ì´í„°ë¥¼ ëª¨ë‘ ì‚­ì œí•œ í›„ ë‹¤ì‹œ ì „ì²´ ë°ì´í„°ë¥¼ ì‚½ì…í•˜ëŠ” ë°©ì‹ìœ¼ë¡œ ì—…ë°ì´íŠ¸ê°€ ì´ë¤„ì§‘ë‹ˆë‹¤. ì´ ë•ë¶„ì—, dbtì˜ ê° ëª¨ë¸ ì¿¼ë¦¬ë¬¸ì— Incremental ì „ëµì— ëŒ€í•œ ê¹Œë‹¤ë¡œìš´ ì¡°ê±´ì„ ì‘ì„±í•˜ì§€ ì•Šë”ë¼ë„ ì•ˆì •ì ì¸ ì—…ë°ì´íŠ¸ ì „ëµì´ ì´ë¤„ì§‘ë‹ˆë‹¤. (BigQueryì™€ dbtì˜ ê¶í•©ì´ ì˜ ë§ëŠ” ì´ìœ  ì¤‘ í•˜ë‚˜)</li>
</ul>

<h3 id="44-core_dim_users-í…Œì´ë¸”-ëª¨ë¸-ë§Œë“¤ê¸°">4.4. <code class="language-plaintext highlighter-rouge">core_dim_users</code> í…Œì´ë¸” ëª¨ë¸ ë§Œë“¤ê¸°</h3>

<p><code class="language-plaintext highlighter-rouge">core_dim_users</code>ëŠ” ì‚¬ìš©ì Dimension Tableë¡œì„œ, Star Schemaì—ì„œ ê° Fact Tablesê°€ ê³µìœ í•˜ëŠ” <code class="language-plaintext highlighter-rouge">user_pseudo_id</code>ì˜ ì‚¬ìš©ì ì†ì„±ì„ ë‹´ê³  ìˆëŠ” í…Œì´ë¸”ì…ë‹ˆë‹¤.</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">WITH</span>
<span class="n">CTE_raw</span> <span class="k">AS</span> <span class="p">(</span>
    <span class="k">SELECT</span>
        <span class="n">user_pseudo_id</span><span class="p">,</span>
        <span class="n">event_timestamp</span><span class="p">,</span>
        <span class="n">user_first_touch_timestamp</span><span class="p">,</span>
        <span class="p">...</span>
        <span class="n">geo</span><span class="p">.</span><span class="n">country</span><span class="p">,</span>
        <span class="p">...</span>
    <span class="k">FROM</span>
        <span class="p">{{</span> <span class="k">source</span><span class="p">(</span><span class="s1">'ga4'</span><span class="p">,</span> <span class="s1">'events'</span><span class="p">)</span> <span class="p">}}</span>
    <span class="k">WHERE</span>
        <span class="n">user_pseudo_id</span> <span class="k">IS</span> <span class="k">NOT</span> <span class="k">NULL</span>
        <span class="p">...</span>
<span class="p">),</span>

<span class="n">CTE_latest</span> <span class="k">AS</span> <span class="p">(</span>
    <span class="k">SELECT</span>
        <span class="n">user_pseudo_id</span><span class="p">,</span>
        <span class="n">event_timestamp</span><span class="p">,</span>
        <span class="n">COALESCE</span><span class="p">(</span><span class="nb">DATE</span><span class="p">(</span><span class="n">TIMESTAMP_MICROS</span><span class="p">(</span><span class="n">LAST_VALUE</span><span class="p">(</span><span class="n">user_first_touch_timestamp</span> <span class="k">IGNORE</span> <span class="n">NULLS</span><span class="p">)</span> <span class="n">OVER</span> <span class="n">w</span><span class="p">),</span> <span class="s1">'Asia/Seoul'</span><span class="p">),</span> <span class="nb">DATE</span><span class="p">(</span><span class="s1">'1900-01-01 00:00:00'</span><span class="p">,</span> <span class="s1">'Asia/Seoul'</span><span class="p">))</span> <span class="k">AS</span> <span class="n">user_first_touch_date</span><span class="p">,</span>
        <span class="n">COALESCE</span><span class="p">(</span><span class="nb">DATETIME</span><span class="p">(</span><span class="n">TIMESTAMP_MICROS</span><span class="p">(</span><span class="n">LAST_VALUE</span><span class="p">(</span><span class="n">user_first_touch_timestamp</span> <span class="k">IGNORE</span> <span class="n">NULLS</span><span class="p">)</span> <span class="n">OVER</span> <span class="n">w</span><span class="p">),</span> <span class="s1">'Asia/Seoul'</span><span class="p">),</span> <span class="nb">DATETIME</span><span class="p">(</span><span class="s1">'1900-01-01 00:00:00'</span><span class="p">,</span> <span class="s1">'Asia/Seoul'</span><span class="p">))</span> <span class="k">AS</span> <span class="n">user_first_touch_datetime</span><span class="p">,</span>
        
        <span class="k">CASE</span>
            <span class="k">WHEN</span> <span class="n">LAST_VALUE</span><span class="p">(</span><span class="n">country</span> <span class="k">IGNORE</span> <span class="n">NULLS</span><span class="p">)</span> <span class="n">OVER</span> <span class="n">w</span> <span class="k">IS</span> <span class="k">NULL</span> <span class="k">THEN</span> <span class="s1">'UNK'</span>
            <span class="k">WHEN</span> <span class="n">LAST_VALUE</span><span class="p">(</span><span class="n">country</span> <span class="k">IGNORE</span> <span class="n">NULLS</span><span class="p">)</span> <span class="n">OVER</span> <span class="n">w</span> <span class="o">=</span> <span class="s1">''</span> <span class="k">THEN</span> <span class="s1">'UNK'</span>
            <span class="k">WHEN</span> <span class="n">LAST_VALUE</span><span class="p">(</span><span class="n">country</span> <span class="k">IGNORE</span> <span class="n">NULLS</span><span class="p">)</span> <span class="n">OVER</span> <span class="n">w</span> <span class="o">=</span> <span class="s1">'(not set)'</span> <span class="k">THEN</span> <span class="s1">'UNK'</span>
            <span class="k">ELSE</span> <span class="n">LAST_VALUE</span><span class="p">(</span><span class="n">country</span> <span class="k">IGNORE</span> <span class="n">NULLS</span><span class="p">)</span> <span class="n">OVER</span> <span class="n">w</span>
        <span class="k">END</span> <span class="k">AS</span> <span class="n">country</span><span class="p">,</span>

        <span class="n">ROW_NUMBER</span><span class="p">()</span> <span class="n">OVER</span> <span class="p">(</span><span class="k">PARTITION</span> <span class="k">BY</span> <span class="n">user_pseudo_id</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">event_timestamp</span> <span class="k">DESC</span><span class="p">)</span> <span class="k">AS</span> <span class="n">row_num</span>
    <span class="k">FROM</span>
        <span class="n">CTE_raw</span>
    <span class="k">WINDOW</span> <span class="n">w</span> 
        <span class="k">AS</span> <span class="p">(</span><span class="k">PARTITION</span> <span class="k">BY</span> <span class="n">user_pseudo_id</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">event_timestamp</span> <span class="k">ROWS</span> <span class="k">BETWEEN</span> <span class="n">UNBOUNDED</span> <span class="k">PRECEDING</span> <span class="k">AND</span> <span class="n">UNBOUNDED</span> <span class="k">FOLLOWING</span><span class="p">)</span>    
<span class="p">)</span>

<span class="k">SELECT</span>
    <span class="o">*</span> <span class="k">EXCEPT</span> <span class="p">(</span><span class="n">event_timestamp</span><span class="p">,</span> <span class="n">row_num</span><span class="p">)</span>
<span class="k">FROM</span>
    <span class="n">CTE_latest</span>
<span class="k">WHERE</span>
    <span class="n">row_num</span> <span class="o">=</span> <span class="mi">1</span>
</code></pre></div></div>

<p>(1) ì¿¼ë¦¬ì˜ íë¦„ì€ í¬ê²Œ ë‹¤ìŒê³¼ ê°™ì•„ìš”.</p>

<ul>
  <li>ë¨¼ì € ì†ŒìŠ¤ í…Œì´ë¸”ì—ì„œ ì „ì²´ ì‚¬ìš©ì ì •ë³´ë¥¼ ì½ì–´ì˜¨ í›„, ê°€ì¥ ìµœê·¼ ì •ë³´ë“¤ë§Œ ê¸°ì¡´ í…Œì´ë¸”ì— Insert Overwriteí•©ë‹ˆë‹¤.</li>
</ul>

<p>(2) SCD(Slowly Changing Dimension) Type 1 ë°©ì‹ì„ ì‚¬ìš©í•˜ê¸°ë¡œ í–ˆìŠµë‹ˆë‹¤. ì¦‰, ì‚¬ìš©ìì˜ íŠ¹ì • ì •ë³´ì— ë³€ë™ì´ ìƒê¸¸ ë•Œ ì´ë¥¼ ì—…ë°ì´íŠ¸ í•˜ì§€ë§Œ, ì˜ˆì „ ì •ë³´ë¥¼ íˆìŠ¤í† ë¦¬ë¡œ ë‚¨ê¸°ì§€ëŠ” ì•ŠëŠ” ë°©ì‹ì´ì—ìš”. ë¬¼ë¡ , SCD Type 3ì™€ ê°™ì´ ì‚¬ìš©ì ì •ë³´ íˆìŠ¤í† ë¦¬ ë³´ê´€ ë°©ì‹ë„ ê³ ë¯¼í•´ë´¤ì§€ë§Œ, ë‹¤ìŒ ë‘ ê°€ì§€ ì¸¡ë©´ì—ì„œ ì ìš©í•˜ì§€ ì•Šê¸°ë¡œ í–ˆì–´ìš”.</p>

<ul>
  <li>ì‚¬ìš©ì Dimensionì˜ íˆìŠ¤í† ë¦¬ê¹Œì§€ í™•ì¸í•´ì•¼ í•  ì •ë„ë¡œ ì¡°ì§ì˜ ë°ì´í„° ë¦¬í„°ëŸ¬ì‹œê°€ ì¶©ë¶„íˆ ê°–ì¶°ì§€ì§€ ì•Šì•˜ë‹¤ê³  ëŠê¼ˆì–´ìš”.</li>
  <li>ê²Œë‹¤ê°€ SCD Type 3 ë°©ì‹ì€ ì¿¼ë¦¬ ë¹„ìš©ì´ ìƒë‹¹íˆ ë§ì´ ë°œìƒí•˜ëŠ” í¸ì´ë¯€ë¡œ, ì¡°ì§ì˜ í•„ìš”ì„±ì´ ìì—°ìŠ¤ëŸ½ê²Œ ëŒ€ë‘ë˜ëŠ” ì‹œì ì— ë„ì…í•´ë³´ê¸°ë¡œ íŒë‹¨í–ˆì–´ìš”.</li>
</ul>

<p><img src="/assets/2024-11-03-implementing-data-warehouse-ga4/7.webp" alt="" /></p>
<blockquote>
  <p><a href="https://www.bps-corp.com/post/so-what-are-slowly-changing-dimensions-scd">What are Slowly Changing Dimensions (SCD)?</a></p>
</blockquote>

<p>í•œí¸, <code class="language-plaintext highlighter-rouge">core_dim_users</code> ëª¨ë¸ì˜ Configurationì€ ë‹¤ìŒê³¼ ê°™ì´ êµ¬ì„±í–ˆìŠµë‹ˆë‹¤.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">version</span><span class="pi">:</span> <span class="m">1</span>

<span class="na">models</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">core_dim_users</span>
    <span class="na">description</span><span class="pi">:</span> <span class="s">ì‚¬ìš©ì Dimension í…Œì´ë¸”</span>
    <span class="na">meta</span><span class="pi">:</span>
      <span class="na">owner</span><span class="pi">:</span> <span class="s">js.kim@iotrust.kr</span>
    <span class="na">config</span><span class="pi">:</span>
      <span class="na">tags</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">core"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">dim"</span><span class="pi">]</span>
      <span class="na">materialized</span><span class="pi">:</span> <span class="s">incremental</span>
      <span class="na">incremental_strategy</span><span class="pi">:</span> <span class="s">merge</span>
      <span class="na">unique_key</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">user_pseudo_id"</span><span class="pi">]</span>
      <span class="na">cluster_by</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">user_pseudo_id"</span><span class="pi">]</span>
      <span class="na">on_schema_change</span><span class="pi">:</span> <span class="s">append_new_columns</span>
    <span class="na">columns</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">user_pseudo_id</span>
        <span class="na">description</span><span class="pi">:</span> <span class="s">ì‚¬ìš©ì ì‹ë³„ì (PK)</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">user_first_touch_date</span>
        <span class="na">description</span><span class="pi">:</span> <span class="s">ì‚¬ìš©ìê°€ ì²˜ìŒ ì•±ì„ ì—´ì—ˆê±°ë‚˜ ì‚¬ì´íŠ¸ë¥¼ ë°©ë¬¸í•œ ì¼ì (NULL=1900-01-01)</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">user_first_touch_datetime</span>
        <span class="na">description</span><span class="pi">:</span> <span class="s">ì‚¬ìš©ìê°€ ì²˜ìŒ ì•±ì„ ì—´ì—ˆê±°ë‚˜ ì‚¬ì´íŠ¸ë¥¼ ë°©ë¬¸í•œ ì¼ì‹œ (NULL=1900-01-01 00:00:00)</span>
      <span class="s">...</span>
</code></pre></div></div>

<p>(1) <code class="language-plaintext highlighter-rouge">user_pseudo_id</code> ë³„ë¡œ Clusteringí•¨ìœ¼ë¡œì¨(<strong>cluster_by</strong>), í–¥í›„ JOIN ê³¼ì •ì—ì„œ ë¹ ë¥´ê²Œ Dimensionì„ ì½ì–´ì˜¬ ìˆ˜ ìˆë„ë¡ í–ˆìŠµë‹ˆë‹¤.</p>

<p>(2) Materialization StrategyëŠ” Incremental (Merge) ë°©ì‹ì„ ì ìš©í–ˆìŠµë‹ˆë‹¤.</p>

<ul>
  <li>Incremental ë°©ì‹ì„ ì‚¬ìš©í•˜ë˜, <code class="language-plaintext highlighter-rouge">user_pseudo_id</code>ë¥¼ Unique Keyë¡œ í•˜ì—¬ ì‚¬ìš©ì ì •ë³´ ì¹¼ëŸ¼ë“¤ì— ë³€ë™ì´ ìƒê¸¸ ê²½ìš° ì´ë¥¼ Mergeí•˜ë„ë¡ í–ˆì–´ìš”. ì¦‰, ê°€ì¥ ìµœê·¼ ì‚¬ìš©ì ì •ë³´ë¡œë§Œ ì´ë£¨ì–´ì§„ SCD Type 1 ë°©ì‹ì˜ í…Œì´ë¸”ì´ ì™„ì„±ë¼ìš”.</li>
</ul>

<h3 id="45-incremental-strategy-ì „ëµì„-ìœ„í•œ-where-statementì™€-variables-ê´€ë¦¬">4.5. Incremental Strategy ì „ëµì„ ìœ„í•œ Where Statementì™€ Variables ê´€ë¦¬</h3>

<p><code class="language-plaintext highlighter-rouge">dbt run</code>ì„ ì‹¤í–‰í•˜ëŠ” ê³¼ì •ì—ì„œ í•œ ê°€ì§€ ë‚œì ì´ ìˆì—ˆìŠµë‹ˆë‹¤. Google Analytics 4 Export TablesëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ìŠ¤íŠ¸ë¦¬ë°ìœ¼ë¡œ Near real-timeìœ¼ë¡œ ì ì¬ë˜ì§€ë§Œ, ì¼ë¶€ ì¹¼ëŸ¼ë“¤ì˜ ê²½ìš° ì‹¤ì‹œê°„ìœ¼ë¡œ ìˆ˜ì§‘ë˜ì§€ ì•Šê±°ë‚˜, í˜¹ì€ ê°’ ë³€ë™ì´ ë°œìƒí•˜ê±°ë“ ìš”. ê° date íŒŒí‹°ì…˜ í…Œì´ë¸”ì´ ìµœì¢…ì ìœ¼ë¡œ ì™„ì„±ë  ë•Œê¹Œì§€ëŠ” ì•ˆì •ì ìœ¼ë¡œ 3ì¼ ì •ë„ ì†Œìš”ë˜ëŠ” ê²ƒì„ í™•ì¸í–ˆìŠµë‹ˆë‹¤.</p>

<p>ì´ë¡œ ì¸í•´, dbtë¥¼ í†µí•´ ë°ì´í„° ì›¨ì–´í•˜ìš°ìŠ¤ ì—…ë°ì´íŠ¸ ì£¼ê¸°ì¸ 1ì‹œê°„ì„ ìœ ì§€í•˜ì—¬ ë°ì´í„° ìµœì‹ ì„±ì„ ìœ ì§€í•˜ê¸°ë€ ì‰½ì§€ ì•Šì•˜ì£ . ì• ì´ˆì— ì†ŒìŠ¤ í…Œì´ë¸”ì—ì„œ ë¶ˆê·œì¹™ì ì¸ ë³€ë™ì´ ë°œìƒí•˜ë‹ˆê¹Œìš”. ì´ëŸ° ìƒí™©ì—ì„œ ìµœì„ ì˜ ë°©ë²•ì€ â€œë³€ë™ì´ ë°œìƒí•œâ€ date íŒŒí‹°ì…˜ í…Œì´ë¸”ë“¤ì„ ì¶”ë ¤ë‚¸ í›„, ì´ë¥¼ ë°”íƒ•ìœ¼ë¡œ dbtê°€ ì²˜ë¦¬í•´ì•¼ í•  í…Œì´ë¸” ë¦¬ìŠ¤íŠ¸ë¥¼ Variablesë¡œ ë¨¹ì—¬ì£¼ëŠ” ë°©ë²•ì´ì—ˆìŠµë‹ˆë‹¤. ì¦‰, ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.</p>

<p>(1) ê° ëª¨ë¸ì˜ Where Statement</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">...</span>
<span class="k">FROM</span>
    <span class="p">{{</span> <span class="k">source</span><span class="p">(</span><span class="s1">'ga4'</span><span class="p">,</span> <span class="s1">'events_intraday'</span><span class="p">)</span> <span class="p">}}</span>
<span class="k">WHERE</span>
    <span class="n">event_date</span> <span class="k">IS</span> <span class="k">NOT</span> <span class="k">NULL</span>
    <span class="k">AND</span> <span class="n">event_timestamp</span> <span class="k">IS</span> <span class="k">NOT</span> <span class="k">NULL</span>
    <span class="k">AND</span> <span class="n">event_name</span> <span class="k">IS</span> <span class="k">NOT</span> <span class="k">NULL</span>
    <span class="c1">-- (1) ë³€ìˆ˜ ë°˜ì˜ (Start Date &amp; End Date): í•´ë‹¹ ì¼ì íŒŒí‹°ì…˜ í…Œì´ë¸”ë§Œ ì½ì–´ì˜´</span>
    <span class="p">{</span><span class="o">%</span> <span class="n">if</span> <span class="n">var</span><span class="p">(</span><span class="s1">'start_date'</span><span class="p">,</span> <span class="k">None</span><span class="p">)</span> <span class="k">is</span> <span class="k">not</span> <span class="k">none</span> <span class="k">and</span> <span class="n">var</span><span class="p">(</span><span class="s1">'end_date'</span><span class="p">,</span> <span class="k">None</span><span class="p">)</span> <span class="k">is</span> <span class="k">not</span> <span class="k">none</span> <span class="o">%</span><span class="p">}</span>
    <span class="k">AND</span> <span class="n">_table_suffix</span> <span class="k">BETWEEN</span> <span class="s1">''</span> <span class="k">AND</span> <span class="s1">''</span>
    <span class="p">{</span><span class="o">%</span> <span class="n">endif</span> <span class="o">%</span><span class="p">}</span>
    <span class="c1">-- (2) ë³€ìˆ˜ ë°˜ì˜ (table_suffixes): ìµœê·¼ Orchestration ì‹¤í–‰ ì‹œì  ì´í›„ ì—…ë°ì´íŠ¸ëœ í…Œì´ë¸”ë§Œ ì½ì–´ì˜´</span>
    <span class="p">{</span><span class="o">%</span> <span class="n">if</span> <span class="n">var</span><span class="p">(</span><span class="nv">"table_suffixes"</span><span class="p">,</span> <span class="k">None</span><span class="p">)</span> <span class="k">is</span> <span class="k">not</span> <span class="k">none</span> <span class="o">%</span><span class="p">}</span>
    <span class="k">AND</span> <span class="n">_table_suffix</span> <span class="k">IN</span> <span class="p">(</span><span class="s1">'{{ var("table_suffixes") }}'</span><span class="p">)</span>
    <span class="p">{</span><span class="o">%</span> <span class="n">endif</span> <span class="o">%</span><span class="p">}</span>
</code></pre></div></div>

<p>(2) <code class="language-plaintext highlighter-rouge">dbt_project.yml</code> íŒŒì¼ì˜ Variables</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">...</span>
<span class="c1"># Variables</span>
<span class="na">vars</span><span class="pi">:</span>
  <span class="na">start_date</span><span class="pi">:</span> <span class="c1"># D'CENT App GA4 Export Table Start Date (Default: None)</span>
  <span class="na">end_date</span><span class="pi">:</span> <span class="c1"># D'CENT App GA4 Export Table End Date (Default: None)</span>
  <span class="na">table_suffixes</span><span class="pi">:</span> <span class="c1"># D'CENT App GA4 Export Table Suffixes (Default: None)</span>
<span class="nn">...</span>
</code></pre></div></div>

<hr />

<h1 id="5-ê²°ê³¼">5. ê²°ê³¼</h1>

<h3 id="51-ì¿¼ë¦¬-ì†ë„-í–¥ìƒ-ë°-ë¹„ìš©-ê°ì†Œ">5.1. ì¿¼ë¦¬ ì†ë„ í–¥ìƒ ë° ë¹„ìš© ê°ì†Œ</h3>

<p>Redash ë“±ì„ í†µí•œ ì¿¼ë¦¬ ì‹¤í–‰ ì‹œê°„ì´ í¬ê²Œ ê°ì†Œí–ˆìŠµë‹ˆë‹¤. ê¸°ì¡´ì—ëŠ” ì¿¼ë¦¬ ì‹¤í–‰ì´ 15ì´ˆ ì´ìƒ ì†Œìš”ë˜ì—ˆì§€ë§Œ, ë°ì´í„° ì›¨ì–´í•˜ìš°ìŠ¤ ì ìš© í›„ ê³ ì‘ 5ì´ˆ ë‚´ì— ì™„ë£Œë©ë‹ˆë‹¤.</p>

<h3 id="52-ì¡°ì§ì˜-ë°ì´í„°-ì ‘ê·¼ì„±-í–¥ìƒ6">5.2. ì¡°ì§ì˜ ë°ì´í„° ì ‘ê·¼ì„± í–¥ìƒ6</h3>

<p>dbt Docsë¥¼ í˜¸ìŠ¤íŒ…í•˜ì—¬ ì•„ë˜ì™€ ê°™ì´ ê° í…Œì´ë¸” ëª…ì„¸ì„œë¥¼ ëˆ„êµ¬ë‚˜ ì‰½ê²Œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì¦‰, ì‚¬ë‚´ êµ¬ì„±ì›ë“¤ì´ ì‰½ê³  ì¼ê´€ì ì¸ ìƒí™©ì—ì„œ ì‰½ê²Œ ì¿¼ë¦¬ë¥¼ ì‘ì„±í•´ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì¡°ì§ì˜ ë°ì´í„° ì ‘ê·¼ì„±ì´ í–¥ìƒëœ ê²ƒì…ë‹ˆë‹¤.</p>

<p><img src="/assets/2024-11-03-implementing-data-warehouse-ga4/8.webp" alt="" /></p>
<blockquote>
  <p><code class="language-plaintext highlighter-rouge">mart_snp_dau</code> í…Œì´ë¸” ëª…ì„¸ì„œ ì‚¬ë¡€ (ì¼ë³„ ì‚¬ìš©ì ìˆ˜, ì‹ ê·œ ì‚¬ìš©ì ìˆ˜, ê¸°ì¡´ ì‚¬ìš©ì ìˆ˜, ì´ ì„¸ì…˜ ìˆ˜, ì´ ì„¸ì…˜ ì‹œê°„)</p>
</blockquote>

<hr />

<h1 id="6-ë‚˜ê°€ëŠ”-ê¸€">6. ë‚˜ê°€ëŠ” ê¸€</h1>

<p>ë°ì´í„° ì›¨ì–´í•˜ìš°ìŠ¤ì™€ ê° ë°ì´í„° ë§ˆíŠ¸ë¥¼ êµ¬ì¶•í•˜ëŠ” ì¼ì€ ê³ ë˜ê¸°ë„ í•˜ì§€ë§Œ, ìƒë‹¹íˆ ë³´ëŒ ìˆëŠ” ì¼ì´ê¸°ë„ í•©ë‹ˆë‹¤. ì•ë‹¨ì—ì„œ ì¡°ê¸ˆì´ë¼ë„ í—í´ì–´ì§€ë©´ ì¡°ì§ì—ì„œ í™œìš©í•˜ëŠ” ë°ì´í„° ìˆ˜ì¹˜ì— ì‹¬ê°í•œ ì˜¤ë¥˜ê°€ ìƒê¸°ë¯€ë¡œ ê¸°ë³¸ì ìœ¼ë¡œ ë¶€ë‹´ì´ í° ê³¼ì—…ì´ê¸°ë„ í•©ë‹ˆë‹¤. íŠ¹íˆ, ì €ëŠ” ì•„ì´ì˜¤íŠ¸ëŸ¬ìŠ¤íŠ¸ì—ì„œ ë°ì´í„°ë¥¼ í™€ë¡œ ì±…ì„ì§€ê³  ìˆê¸° ë•Œë¬¸ì—, ìŠ¤ìŠ¤ë¡œì˜ ì‹¤ìˆ˜ë‚˜ ì˜¤ë¥˜ê°€ ìƒê¸°ë©´ ì´ë¥¼ í”¼ë“œë°±í•  ìˆ˜ ìˆëŠ” ë¶„ì´ ì—†ì–´ìš”. ê·¸ë˜ì„œ ì…€í”„ ì‘ì—… í›„ ì…€í”„ í”¼ë“œë°± ì‹œê°„ì„ ê°€ì§€ë©°, ë³µìˆ˜ ê°œì˜ ìì•„ë¥¼ ë‘ë©´ì„œ ì¼ì„ í•˜ê¸°ë„ í•´ìš”.ğŸ™„</p>

<p>í•˜ì§€ë§Œ ë°ì´í„° ì›¨ì–´í•˜ìš°ìŠ¤ë¥¼ í†µí•´ ë’·ë‹¨ì—ì„œ ë™ë£Œë“¤ì´ ë°ì´í„°ë¥¼ ì‰½ê³  í¸í•˜ê²Œ í™•ì¸í•˜ëŠ” ëª¨ìŠµì„ ë³´ë©´ ìƒë‹¹íˆ ë¿Œë“¯í•˜ê³ , ê·¸ë§Œí¼ ë°ì´í„°ì— ëŒ€í•œ ì˜¤ë„ˆì‹­ì´ ì»¤ì§‘ë‹ˆë‹¤. ê·¸ì— ë”°ë¼ ì¡°ì§ì˜ ë°ì´í„° ê¸°ë°˜ ì˜ì‚¬ê²°ì •ì´ ì œëŒ€ë¡œ ì´ë£¨ì–´ì ¸ê°€ëŠ” ëª¨ìŠµì— ë”ìš± ì• ì°©ì´ ë§ì•„ì§€ê¸°ë„ í•˜êµ¬ìš”.</p>

<p>ì•ìœ¼ë¡œëŠ” í”„ë¡œë•íŠ¸ ë‚´ë¶€ ë°ì´í„°ê°€ ì•„ë‹ˆë¼, í”„ë¡œë•íŠ¸ ì™¸ë¶€ ë°ì´í„°ë¥¼ í™œìš©í•˜ëŠ” í™˜ê²½ì— ì§‘ì¤‘í•´ë³´ë ¤ê³  í•©ë‹ˆë‹¤. ì´ë¥¼ í†µí•´ í”„ë¡œë•íŠ¸ì˜ ë‚´/ì™¸ë¶€ ë°ì´í„°ë¥¼ í•¨ê»˜ í™œìš©í•  ìˆ˜ ìˆëŠ” í™˜ê²½ì´ ì´ë£¨ì–´ì§€ê¸¸ ë°”ë¼ë´…ë‹ˆë‹¤.</p>

<hr />

<h2 id="published-by-joshua-kim"><em>Published by</em> Joshua Kim</h2>

<p><img src="/assets/profile/joshua-profile.png" alt="Joshua Kim" /></p>]]></content><author><name></name></author><category term="Language (Korean)" /><category term="Article (Project)" /><category term="Level (2. Intermediate)" /><category term="Field (Analytics Engineering)" /><category term="Skills (SQL)" /><category term="Skills (dbt)" /><summary type="html"><![CDATA[â€œì´ ê¸€ì€ Google Analytics 4(GA4) ë°ì´í„°ë¥¼ íš¨ìœ¨ì ìœ¼ë¡œ í™œìš©í•˜ê¸° ìœ„í•´ ë°ì´í„° ì›¨ì–´í•˜ìš°ìŠ¤ë¥¼ êµ¬ì¶•í•œ ê³¼ì •ê³¼ ê²°ê³¼ë¥¼ ê³µìœ í•˜ëŠ” í›„ê¸°ì…ë‹ˆë‹¤. ê¸°ì¡´ì—ëŠ” GA4 Export Tableì— ì§ì ‘ ì¿¼ë¦¬ë¥¼ ì‹¤í–‰í•˜ëŠ” ë°©ì‹ì´ì—ˆì§€ë§Œ, ìŠ¤í‚¤ë§ˆ ë³µì¡ì„±, ëŠë¦° ì¿¼ë¦¬ ì‹¤í–‰ ì‹œê°„, ë†’ì€ ë¹„ìš© ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ ë°ì´í„° ë§ˆíŠ¸ë¥¼ êµ¬ì„±í•˜ê³ , dbtë¥¼ í™œìš©í•œ Incremental Strategyë¥¼ ì ìš©í•˜ì—¬ ì„±ëŠ¥ì„ ìµœì í™”í–ˆìŠµë‹ˆë‹¤. ê·¸ ê²°ê³¼, ì¿¼ë¦¬ ì†ë„ê°€ íšê¸°ì ìœ¼ë¡œ í–¥ìƒë˜ê³  ë¹„ìš©ì´ ì ˆê°ë˜ì—ˆìœ¼ë©°, ì¡°ì§ ë‚´ ë°ì´í„° ì ‘ê·¼ì„±ì´ ë†’ì•„ì ¸ ë³´ë‹¤ íš¨ìœ¨ì ì¸ ë°ì´í„° í™œìš©ì´ ê°€ëŠ¥í•´ì¡ŒìŠµë‹ˆë‹¤.â€]]></summary></entry><entry><title type="html">GA4-based Data Warehouse Implementation Review</title><link href="http://localhost:4000/implementing-data-warehouse-ga4-en/" rel="alternate" type="text/html" title="GA4-based Data Warehouse Implementation Review" /><published>2024-11-03T00:00:00+09:00</published><updated>2024-11-03T00:00:00+09:00</updated><id>http://localhost:4000/implementing-data-warehouse-ga4-en</id><content type="html" xml:base="http://localhost:4000/implementing-data-warehouse-ga4-en/"><![CDATA[<blockquote>
  <p>â€œThis article shares the process and outcomes of building a data warehouse to efficiently utilize Google Analytics 4 (GA4) data. Previously, queries were executed directly on the GA4 Export Table, but issues such as schema complexity, slow query execution times, and high costs necessitated a transition to a data mart. By implementing an Incremental Strategy using dbt, we optimized performance, resulting in significantly improved query speeds, reduced costs, and enhanced data accessibility within the organization, enabling more efficient data utilization.â€</p>
</blockquote>

<hr />

<h1 id="table-of-contents">Table of Contents</h1>
<ol>
  <li>Introduction</li>
  <li>Diagnosing the Problem
    <ul>
      <li>2.1. Complex Schema of the Source Table</li>
      <li>2.2. Slow Query Execution Time and High Query Costs</li>
    </ul>
  </li>
  <li>Solution: Building a Data Warehouse
    <ul>
      <li>3.1. Simplified Schema for Each Data Mart Table</li>
      <li>3.2. Faster Query Execution and Reduced Costs</li>
    </ul>
  </li>
  <li>Implementation of the Data Warehouse
    <ul>
      <li>4.1. Data Lineage Preview of the Data Warehouse</li>
      <li>4.2. Creating the <code class="language-plaintext highlighter-rouge">core_fct_events</code> Table Model</li>
      <li>4.3. Creating Event-Specific Table Models</li>
      <li>4.4. Creating the <code class="language-plaintext highlighter-rouge">core_dim_users</code> Table Model</li>
      <li>4.5. Managing Where Statements and Variables for Incremental Strategy</li>
    </ul>
  </li>
  <li>Results
    <ul>
      <li>5.1. Improved Query Speed and Reduced Costs</li>
      <li>5.2. Enhanced Organizational Data Accessibility</li>
    </ul>
  </li>
  <li>Conclusion</li>
</ol>

<hr />

<h1 id="1-introduction">1. Introduction</h1>

<p><img src="/assets/2024-11-03-implementing-data-warehouse-ga4/1.webp" alt="" /></p>
<blockquote>
  <p>Simplified IoTrust Data Pipeline</p>
</blockquote>

<p>Our company operates the B2C product Dâ€™Cent Wallet and the B2B2C product Wepen Wallet. Among them, the Dâ€™Cent Wallet primarily loads data into BigQuery via Google Analytics 4!</p>

<p>Many startups directly execute queries on the Google Analytics 4 Export Table stored in BigQuery. However, this â€œsource table-dependentâ€ query execution approach can lead to significant issues over time, including increased query costs and execution times.</p>

<p>To overcome this, I implemented a â€œrarely seenâ€ GA4-based data warehouse structure. This article shares my experience with this approach.</p>

<hr />

<h1 id="2-diagnosing-the-problem">2. Diagnosing the Problem</h1>

<h3 id="21-complex-schema-of-the-source-table">2.1. Complex Schema of the Source Table</h3>

<p>The Google Analytics 4 Export Table streamed to BigQuery is designed with flexible structural expansion in mind. As a result, event parameters and purchase product information are stored in RECORD types. This design choice by Google leverages a columnar database structure to reduce storage costs.</p>

<p>For example, <code class="language-plaintext highlighter-rouge">event_params</code> is stored in a key-value format similar to JSON, making it challenging for those unfamiliar with this structure to write queries.</p>

<p><img src="/assets/2024-11-03-implementing-data-warehouse-ga4/2.webp" alt="" /></p>
<blockquote>
  <p>GA4 Source Table Schema (Public Sample Table)</p>
</blockquote>

<p><img src="/assets/2024-11-03-implementing-data-warehouse-ga4/3.webp" alt="" /></p>
<blockquote>
  <p>GA4 Source Table Preview (Public Sample Table)</p>
</blockquote>

<p>Even extracting a simple page visit count requires writing a complex query, as shown below. This poses a steep learning curve for new users.</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span>
    <span class="n">event_date</span><span class="p">,</span>
    <span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="n">ga_session_id</span><span class="p">)</span> <span class="k">AS</span> <span class="n">sessions_cnt</span><span class="p">,</span>
    <span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="n">user_pseudo_id</span><span class="p">)</span> <span class="k">AS</span> <span class="n">users_cnt</span>
<span class="k">FROM</span>
    <span class="nv">`events_*`</span>
<span class="k">WHERE</span>
    <span class="n">_table_suffix</span> <span class="k">BETWEEN</span> <span class="s1">'20240101'</span> <span class="k">AND</span> <span class="s1">'20241231'</span>
    <span class="k">AND</span> <span class="n">event_name</span> <span class="o">=</span> <span class="s1">'page_view'</span>
    <span class="k">AND</span> <span class="p">(</span><span class="k">SELECT</span> <span class="n">value</span><span class="p">.</span><span class="n">string_value</span> <span class="k">FROM</span> <span class="k">UNNEST</span> <span class="p">(</span><span class="n">event_params</span><span class="p">)</span> <span class="k">WHERE</span> <span class="k">key</span> <span class="o">=</span> <span class="s1">'page_location'</span><span class="p">)</span> <span class="k">LIKE</span> <span class="s1">'%store.dcentwallet.com/pages/dcent-biometric-crypto-wallet%'</span>
<span class="k">GROUP</span> <span class="k">BY</span>
    <span class="mi">1</span>
<span class="k">ORDER</span> <span class="k">BY</span>
    <span class="mi">1</span>
<span class="p">;</span>
</code></pre></div></div>

<p>A simplified table schema is needed to allow users to write queries more easily.</p>

<h3 id="22-slow-query-execution-time-and-high-query-costs">2.2. Slow Query Execution Time and High Query Costs</h3>

<p>Executing queries directly on the source table becomes increasingly inefficient over time, leading to slow execution times and rapidly rising query costs.</p>

<p>For non-technical colleagues who only consume dashboards, long update times significantly hinder data usability. A somewhat extreme quote captures this challenge well:</p>

<blockquote>
  <p>â€œIf a dashboard update takes longer than 5 seconds, marketers and designers will immediately disengage. Optimizing queries is critical to maintaining data usability.â€</p>
</blockquote>

<hr />

<h1 id="3-solution-building-a-data-warehouse">3. Solution: Building a Data Warehouse</h1>

<p><img src="/assets/2024-11-03-implementing-data-warehouse-ga4/4.webp" alt="" /></p>
<blockquote>
  <p><a href="https://ardas-it.com/benefits-of-enterprise-data-warehouse">Benefits of Enterprise Data Warehouse</a></p>
</blockquote>

<p>Implementing a data warehouse dramatically resolves the aforementioned issues.</p>

<h3 id="31-simplified-schema-for-each-data-mart-table">3.1. Simplified Schema for Each Data Mart Table</h3>

<p>By simplifying the structure of each data mart and its tables, colleagues can execute queries with ease. This reduces dependence on data analysts and analytics engineers, creating a self-service environment for data queries.</p>

<h3 id="32-faster-query-execution-and-reduced-costs">3.2. Faster Query Execution and Reduced Costs</h3>

<p>Data mart tables are structured with only the necessary columns and rows, making them significantly smaller than source tables. Running queries on data marts results in drastically improved execution times and lower costs.</p>

<hr />

<h1 id="4-implementation-of-the-data-warehouse">4. Implementation of the Data Warehouse</h1>

<h3 id="41-data-lineage-preview-of-the-data-warehouse">4.1. Data Lineage Preview of the Data Warehouse</h3>

<p>The core layer of the Dâ€™Cent App data warehouse is structured as follows, forming a star schema from the source tables <code class="language-plaintext highlighter-rouge">ga4.events</code> and <code class="language-plaintext highlighter-rouge">ga4.events_intraday</code>.</p>

<p><img src="/assets/2024-11-03-implementing-data-warehouse-ga4/5.webp" alt="" /></p>
<blockquote>
  <p>Partial View of Dâ€™Cent App Data Warehouse Data Lineage</p>
</blockquote>

<h3 id="42-creating-the-core_fct_events-table-model">4.2. Creating the <code class="language-plaintext highlighter-rouge">core_fct_events</code> Table Model</h3>

<p>The foundational fact table, containing all recorded events, was created while excluding unique event parameters. The goal was to include as much information as possible.</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span>
    <span class="k">DISTINCT</span>

    <span class="n">PARSE_DATE</span><span class="p">(</span><span class="s1">'%Y%m%d'</span><span class="p">,</span> <span class="n">event_date</span><span class="p">)</span> <span class="k">AS</span> <span class="nb">date</span><span class="p">,</span>
    <span class="nb">DATETIME</span><span class="p">(</span><span class="n">TIMESTAMP_MICROS</span><span class="p">(</span><span class="n">event_timestamp</span><span class="p">),</span> <span class="s1">'Asia/Seoul'</span><span class="p">)</span> <span class="k">AS</span> <span class="nb">datetime</span><span class="p">,</span>

    <span class="n">COALESCE</span><span class="p">(</span><span class="n">user_pseudo_id</span><span class="p">,</span> <span class="s1">'UNK'</span><span class="p">)</span> <span class="k">AS</span> <span class="n">user_pseudo_id</span><span class="p">,</span>
    <span class="n">COALESCE</span><span class="p">((</span><span class="k">SELECT</span> <span class="n">value</span><span class="p">.</span><span class="n">int_value</span> <span class="k">FROM</span> <span class="k">UNNEST</span> <span class="p">(</span><span class="n">event_params</span><span class="p">)</span> <span class="k">WHERE</span> <span class="k">key</span> <span class="o">=</span> <span class="s1">'ga_session_id'</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">AS</span> <span class="n">ga_session_id</span><span class="p">,</span>
    <span class="n">COALESCE</span><span class="p">((</span><span class="k">SELECT</span> <span class="n">value</span><span class="p">.</span><span class="n">int_value</span> <span class="k">FROM</span> <span class="k">UNNEST</span> <span class="p">(</span><span class="n">event_params</span><span class="p">)</span> <span class="k">WHERE</span> <span class="k">key</span> <span class="o">=</span> <span class="s1">'ga_session_number'</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">AS</span> <span class="n">ga_session_number</span><span class="p">,</span>

    <span class="n">event_name</span><span class="p">,</span>
    
    <span class="n">COALESCE</span><span class="p">(</span><span class="n">device</span><span class="p">.</span><span class="n">web_info</span><span class="p">.</span><span class="n">hostname</span><span class="p">,</span> <span class="s1">'UNK'</span><span class="p">)</span> <span class="k">AS</span> <span class="n">hostname</span><span class="p">,</span>
    <span class="n">COALESCE</span><span class="p">((</span><span class="k">SELECT</span> <span class="n">value</span><span class="p">.</span><span class="n">string_value</span> <span class="k">FROM</span> <span class="k">UNNEST</span> <span class="p">(</span><span class="n">event_params</span><span class="p">)</span> <span class="k">WHERE</span> <span class="k">key</span> <span class="o">=</span> <span class="s1">'page_location'</span><span class="p">),</span> <span class="s1">'UNK'</span><span class="p">)</span> <span class="k">AS</span> <span class="n">page_location_full</span><span class="p">,</span>        
    <span class="n">COALESCE</span><span class="p">((</span><span class="k">SELECT</span>  <span class="k">FROM</span> <span class="k">UNNEST</span> <span class="p">(</span><span class="n">event_params</span><span class="p">)</span> <span class="k">WHERE</span> <span class="k">key</span> <span class="o">=</span> <span class="s1">'page_location'</span><span class="p">),</span> <span class="s1">'UNK'</span><span class="p">)</span> <span class="k">AS</span> <span class="n">page_location</span><span class="p">,</span>
    <span class="n">COALESCE</span><span class="p">((</span><span class="k">SELECT</span> <span class="n">value</span><span class="p">.</span><span class="n">string_value</span> <span class="k">FROM</span> <span class="k">UNNEST</span> <span class="p">(</span><span class="n">event_params</span><span class="p">)</span> <span class="k">WHERE</span> <span class="k">key</span> <span class="o">=</span> <span class="s1">'page_title'</span><span class="p">),</span> <span class="s1">'UNK'</span><span class="p">)</span> <span class="k">AS</span> <span class="n">page_title</span><span class="p">,</span>

    <span class="n">COALESCE</span><span class="p">(</span>
        <span class="k">LOWER</span><span class="p">((</span><span class="k">SELECT</span> <span class="n">value</span><span class="p">.</span><span class="n">string_value</span> <span class="k">FROM</span> <span class="k">UNNEST</span> <span class="p">(</span><span class="n">user_properties</span><span class="p">)</span> <span class="k">WHERE</span> <span class="k">key</span> <span class="o">=</span> <span class="s1">'xxx'</span><span class="p">)),</span>
        <span class="k">LOWER</span><span class="p">(</span><span class="k">CAST</span><span class="p">((</span><span class="k">SELECT</span> <span class="n">value</span><span class="p">.</span><span class="n">double_value</span> <span class="k">FROM</span> <span class="k">UNNEST</span> <span class="p">(</span><span class="n">user_properties</span><span class="p">)</span> <span class="k">WHERE</span> <span class="k">key</span> <span class="o">=</span> <span class="s1">'xxx'</span><span class="p">)</span> <span class="k">AS</span> <span class="n">STRING</span><span class="p">)),</span>
        <span class="k">LOWER</span><span class="p">(</span><span class="k">CAST</span><span class="p">((</span><span class="k">SELECT</span> <span class="n">value</span><span class="p">.</span><span class="n">float_value</span> <span class="k">FROM</span> <span class="k">UNNEST</span> <span class="p">(</span><span class="n">user_properties</span><span class="p">)</span> <span class="k">WHERE</span> <span class="k">key</span> <span class="o">=</span> <span class="s1">'xxx'</span><span class="p">)</span> <span class="k">AS</span> <span class="n">STRING</span><span class="p">)),</span>
        <span class="k">LOWER</span><span class="p">(</span><span class="k">CAST</span><span class="p">((</span><span class="k">SELECT</span> <span class="n">value</span><span class="p">.</span><span class="n">int_value</span> <span class="k">FROM</span> <span class="k">UNNEST</span> <span class="p">(</span><span class="n">user_properties</span><span class="p">)</span> <span class="k">WHERE</span> <span class="k">key</span> <span class="o">=</span> <span class="s1">'xxx'</span><span class="p">)</span> <span class="k">AS</span> <span class="n">STRING</span><span class="p">)),</span>
        <span class="s1">'UNK'</span>
    <span class="p">)</span> <span class="k">AS</span> <span class="n">xxx</span><span class="p">,</span>

    <span class="n">COALESCE</span><span class="p">(</span><span class="n">platform</span><span class="p">,</span> <span class="s1">'UNK'</span><span class="p">)</span> <span class="k">AS</span> <span class="n">platform</span><span class="p">,</span>
    <span class="n">COALESCE</span><span class="p">(</span><span class="n">device</span><span class="p">.</span><span class="n">operating_system</span><span class="p">,</span> <span class="s1">'UNK'</span><span class="p">)</span> <span class="k">AS</span> <span class="n">device_os</span><span class="p">,</span>
    <span class="n">COALESCE</span><span class="p">(</span><span class="n">device</span><span class="p">.</span><span class="n">category</span><span class="p">,</span> <span class="s1">'UNK'</span><span class="p">)</span> <span class="k">AS</span> <span class="n">device_category</span><span class="p">,</span>
    <span class="n">COALESCE</span><span class="p">(</span><span class="n">app_info</span><span class="p">.</span><span class="k">version</span><span class="p">,</span> <span class="s1">'UNK'</span><span class="p">)</span> <span class="k">AS</span> <span class="n">app_version</span><span class="p">,</span>

    <span class="k">CASE</span>
        <span class="k">WHEN</span> <span class="n">geo</span><span class="p">.</span><span class="n">continent</span> <span class="k">IS</span> <span class="k">NULL</span> <span class="k">THEN</span> <span class="s1">'UNK'</span>
        <span class="k">WHEN</span> <span class="n">geo</span><span class="p">.</span><span class="n">continent</span> <span class="o">=</span> <span class="s1">''</span> <span class="k">THEN</span> <span class="s1">'UNK'</span>
        <span class="k">WHEN</span> <span class="n">geo</span><span class="p">.</span><span class="n">continent</span> <span class="o">=</span> <span class="s1">'(not set)'</span> <span class="k">THEN</span> <span class="s1">'UNK'</span>
        <span class="k">ELSE</span> <span class="n">geo</span><span class="p">.</span><span class="n">continent</span>
    <span class="k">END</span> <span class="k">AS</span> <span class="n">continent</span><span class="p">,</span>
    <span class="k">CASE</span>
        <span class="k">WHEN</span> <span class="n">geo</span><span class="p">.</span><span class="n">country</span> <span class="k">IS</span> <span class="k">NULL</span> <span class="k">THEN</span> <span class="s1">'UNK'</span>
        <span class="k">WHEN</span> <span class="n">geo</span><span class="p">.</span><span class="n">country</span> <span class="o">=</span> <span class="s1">''</span> <span class="k">THEN</span> <span class="s1">'UNK'</span>
        <span class="k">WHEN</span> <span class="n">geo</span><span class="p">.</span><span class="n">country</span> <span class="o">=</span> <span class="s1">'(not set)'</span> <span class="k">THEN</span> <span class="s1">'UNK'</span>
        <span class="k">ELSE</span> <span class="n">geo</span><span class="p">.</span><span class="n">country</span>
    <span class="k">END</span> <span class="k">AS</span> <span class="n">country</span><span class="p">,</span>

    <span class="n">COALESCE</span><span class="p">(</span><span class="n">traffic_source</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">'UNK'</span><span class="p">)</span> <span class="k">AS</span> <span class="n">first_utm_campaign</span><span class="p">,</span>
    <span class="n">COALESCE</span><span class="p">(</span><span class="n">traffic_source</span><span class="p">.</span><span class="n">medium</span><span class="p">,</span> <span class="s1">'UNK'</span><span class="p">)</span> <span class="k">AS</span> <span class="n">first_utm_medium</span><span class="p">,</span>
    <span class="n">COALESCE</span><span class="p">(</span><span class="n">traffic_source</span><span class="p">.</span><span class="k">source</span><span class="p">,</span> <span class="s1">'UNK'</span><span class="p">)</span> <span class="k">AS</span> <span class="n">first_utm_source</span><span class="p">,</span>

    <span class="n">COALESCE</span><span class="p">((</span><span class="k">SELECT</span> <span class="n">value</span><span class="p">.</span><span class="n">string_value</span> <span class="k">FROM</span> <span class="k">UNNEST</span> <span class="p">(</span><span class="n">event_params</span><span class="p">)</span> <span class="k">WHERE</span> <span class="k">key</span> <span class="o">=</span> <span class="s1">'campaign_id'</span><span class="p">),</span> <span class="s1">'UNK'</span><span class="p">)</span> <span class="k">AS</span> <span class="n">event_utm_campaign_id</span><span class="p">,</span>
    <span class="n">COALESCE</span><span class="p">((</span><span class="k">SELECT</span> <span class="n">value</span><span class="p">.</span><span class="n">string_value</span> <span class="k">FROM</span> <span class="k">UNNEST</span> <span class="p">(</span><span class="n">event_params</span><span class="p">)</span> <span class="k">WHERE</span> <span class="k">key</span> <span class="o">=</span> <span class="s1">'campaign'</span><span class="p">),</span> <span class="s1">'UNK'</span><span class="p">)</span> <span class="k">AS</span> <span class="n">event_utm_campaign</span><span class="p">,</span>
    <span class="n">COALESCE</span><span class="p">((</span><span class="k">SELECT</span> <span class="n">value</span><span class="p">.</span><span class="n">string_value</span> <span class="k">FROM</span> <span class="k">UNNEST</span> <span class="p">(</span><span class="n">event_params</span><span class="p">)</span> <span class="k">WHERE</span> <span class="k">key</span> <span class="o">=</span> <span class="s1">'medium'</span><span class="p">),</span> <span class="s1">'UNK'</span><span class="p">)</span> <span class="k">AS</span> <span class="n">event_utm_medium</span><span class="p">,</span>
    <span class="n">COALESCE</span><span class="p">((</span><span class="k">SELECT</span> <span class="n">value</span><span class="p">.</span><span class="n">string_value</span> <span class="k">FROM</span> <span class="k">UNNEST</span> <span class="p">(</span><span class="n">event_params</span><span class="p">)</span> <span class="k">WHERE</span> <span class="k">key</span> <span class="o">=</span> <span class="s1">'source'</span><span class="p">),</span> <span class="s1">'UNK'</span><span class="p">)</span> <span class="k">AS</span> <span class="n">event_utm_source</span><span class="p">,</span>
    <span class="n">COALESCE</span><span class="p">((</span><span class="k">SELECT</span> <span class="n">value</span><span class="p">.</span><span class="n">string_value</span> <span class="k">FROM</span> <span class="k">UNNEST</span> <span class="p">(</span><span class="n">event_params</span><span class="p">)</span> <span class="k">WHERE</span> <span class="k">key</span> <span class="o">=</span> <span class="s1">'term'</span><span class="p">),</span> <span class="s1">'UNK'</span><span class="p">)</span> <span class="k">AS</span> <span class="n">event_utm_term</span><span class="p">,</span>
    <span class="n">COALESCE</span><span class="p">((</span><span class="k">SELECT</span> <span class="n">value</span><span class="p">.</span><span class="n">string_value</span> <span class="k">FROM</span> <span class="k">UNNEST</span> <span class="p">(</span><span class="n">event_params</span><span class="p">)</span> <span class="k">WHERE</span> <span class="k">key</span> <span class="o">=</span> <span class="s1">'content'</span><span class="p">),</span> <span class="s1">'UNK'</span><span class="p">)</span> <span class="k">AS</span> <span class="n">event_utm_content</span><span class="p">,</span>
    <span class="p">...</span>
<span class="k">FROM</span>
    
<span class="k">WHERE</span>
    <span class="n">event_date</span> <span class="k">IS</span> <span class="k">NOT</span> <span class="k">NULL</span>
    <span class="k">AND</span> <span class="n">event_timestamp</span> <span class="k">IS</span> <span class="k">NOT</span> <span class="k">NULL</span>
    <span class="k">AND</span> <span class="n">event_name</span> <span class="k">IS</span> <span class="k">NOT</span> <span class="k">NULL</span>
    <span class="p">...</span>
</code></pre></div></div>

<p>(1) In the GA4 Export Table, identical events are often collected twice in succession for unknown reasons. This issue occurs frequently, particularly depending on the structure of the appâ€™s development source code. Since this can lead to data distortion during the aggregation process, we ensured that duplicates are always removed using DISTINCT, even at the cost of additional computation.</p>

<p>(2) To simplify model queries, we used Select Subqueries with UNNEST for event parameters and user properties.</p>

<p>(3) We established the following null-handling rules to prevent data distortion during the aggregation process:</p>

<ul>
  <li>String: â€œUNKâ€ (unknown)</li>
  <li>Number: -1</li>
  <li>Date: â€œ1900-01-01â€</li>
</ul>

<p>(4) Rows without <code class="language-plaintext highlighter-rouge">event_date</code>, <code class="language-plaintext highlighter-rouge">event_timestamp</code>, or <code class="language-plaintext highlighter-rouge">event_name</code> values were excluded from the model. If any of these three values are unknown, they provide no meaningful value as data.</p>

<p>(5) Handling the <code class="language-plaintext highlighter-rouge">page_location</code> field is time-consuming for query writers due to varying query elements in page URLs. To address this, we defined a custom dbt macro function named <code class="language-plaintext highlighter-rouge">clean_url</code> to ensure a clean and standardized output.</p>

<ul>
  <li>Example of the <code class="language-plaintext highlighter-rouge">clean_url</code> macro:</li>
</ul>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="o">%</span> <span class="n">macro</span> <span class="n">clean_url</span><span class="p">(</span><span class="k">column_name</span><span class="p">)</span> <span class="o">%</span><span class="p">}</span>

    <span class="k">REPLACE</span><span class="p">(</span>
        <span class="n">REGEXP_REPLACE</span><span class="p">(</span>
            <span class="n">REGEXP_REPLACE</span><span class="p">(</span>
                <span class="k">LOWER</span><span class="p">({{</span> <span class="k">column_name</span> <span class="p">}}),</span>
                <span class="n">r</span><span class="s1">'(</span><span class="se">\?</span><span class="s1">.*)$'</span><span class="p">,</span>
                <span class="s1">''</span>
            <span class="p">),</span>
            <span class="n">r</span><span class="s1">'/$'</span><span class="p">,</span>
            <span class="s1">''</span>
        <span class="p">),</span>
        <span class="s1">'https://'</span><span class="p">,</span>
        <span class="s1">''</span>
    <span class="p">)</span>

<span class="p">{</span><span class="o">%</span> <span class="n">endmacro</span> <span class="o">%</span><span class="p">}</span>
</code></pre></div></div>

<h3 id="43-creating-event-specific-table-models">4.3. Creating Event-Specific Table Models</h3>

<p>As previously mentioned, each event has a completely different parameter structure. We needed to build independent event parameter information for each event. If the organizationâ€™s event taxonomy changes and new parameters are collected, applying these changes to the entire data warehouse would significantly increase query costs. By managing event-specific models, we ensured that only the necessary event-specific tables are affected, minimizing the impact of changes in the source table.</p>

<p>For example, the following model query defines <code class="language-plaintext highlighter-rouge">core_fct_evt_click_tab</code>, which includes only the <code class="language-plaintext highlighter-rouge">click_tab</code> event and the <code class="language-plaintext highlighter-rouge">to_tab_name</code> parameter.</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span>
    <span class="k">DISTINCT</span>

    <span class="n">PARSE_DATE</span><span class="p">(</span><span class="s1">'%Y%m%d'</span><span class="p">,</span> <span class="n">event_date</span><span class="p">)</span> <span class="k">AS</span> <span class="nb">date</span><span class="p">,</span>
    <span class="nb">DATETIME</span><span class="p">(</span><span class="n">TIMESTAMP_MICROS</span><span class="p">(</span><span class="n">event_timestamp</span><span class="p">),</span> <span class="s1">'Asia/Seoul'</span><span class="p">)</span> <span class="k">AS</span> <span class="nb">datetime</span><span class="p">,</span>

    <span class="n">COALESCE</span><span class="p">(</span><span class="n">user_pseudo_id</span><span class="p">,</span> <span class="s1">'UNK'</span><span class="p">)</span> <span class="k">AS</span> <span class="n">user_pseudo_id</span><span class="p">,</span>
    <span class="n">COALESCE</span><span class="p">((</span><span class="k">SELECT</span> <span class="n">value</span><span class="p">.</span><span class="n">int_value</span> <span class="k">FROM</span> <span class="k">UNNEST</span> <span class="p">(</span><span class="n">event_params</span><span class="p">)</span> <span class="k">WHERE</span> <span class="k">key</span> <span class="o">=</span> <span class="s1">'ga_session_id'</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">AS</span> <span class="n">ga_session_id</span><span class="p">,</span>
    <span class="n">COALESCE</span><span class="p">((</span><span class="k">SELECT</span> <span class="n">value</span><span class="p">.</span><span class="n">int_value</span> <span class="k">FROM</span> <span class="k">UNNEST</span> <span class="p">(</span><span class="n">event_params</span><span class="p">)</span> <span class="k">WHERE</span> <span class="k">key</span> <span class="o">=</span> <span class="s1">'ga_session_number'</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">AS</span> <span class="n">ga_session_number</span><span class="p">,</span>

    <span class="n">COALESCE</span><span class="p">(</span><span class="n">device</span><span class="p">.</span><span class="n">web_info</span><span class="p">.</span><span class="n">hostname</span><span class="p">,</span> <span class="s1">'UNK'</span><span class="p">)</span> <span class="k">AS</span> <span class="n">hostname</span><span class="p">,</span>
    <span class="n">COALESCE</span><span class="p">((</span><span class="k">SELECT</span> <span class="n">value</span><span class="p">.</span><span class="n">string_value</span> <span class="k">FROM</span> <span class="k">UNNEST</span> <span class="p">(</span><span class="n">event_params</span><span class="p">)</span> <span class="k">WHERE</span> <span class="k">key</span> <span class="o">=</span> <span class="s1">'page_location'</span><span class="p">),</span> <span class="s1">'UNK'</span><span class="p">)</span> <span class="k">AS</span> <span class="n">page_location_full</span><span class="p">,</span>        
    <span class="n">COALESCE</span><span class="p">((</span><span class="k">SELECT</span> <span class="p">{{</span> <span class="n">clean_url</span><span class="p">(</span><span class="s1">'value.string_value'</span><span class="p">)</span> <span class="p">}}</span> <span class="k">FROM</span> <span class="k">UNNEST</span> <span class="p">(</span><span class="n">event_params</span><span class="p">)</span> <span class="k">WHERE</span> <span class="k">key</span> <span class="o">=</span> <span class="s1">'page_location'</span><span class="p">),</span> <span class="s1">'UNK'</span><span class="p">)</span> <span class="k">AS</span> <span class="n">page_location</span><span class="p">,</span>
    <span class="n">COALESCE</span><span class="p">((</span><span class="k">SELECT</span> <span class="n">value</span><span class="p">.</span><span class="n">string_value</span> <span class="k">FROM</span> <span class="k">UNNEST</span> <span class="p">(</span><span class="n">event_params</span><span class="p">)</span> <span class="k">WHERE</span> <span class="k">key</span> <span class="o">=</span> <span class="s1">'page_title'</span><span class="p">),</span> <span class="s1">'UNK'</span><span class="p">)</span> <span class="k">AS</span> <span class="n">page_title</span><span class="p">,</span>

    <span class="n">COALESCE</span><span class="p">((</span><span class="k">SELECT</span> <span class="p">{{</span> <span class="n">clean_url</span><span class="p">(</span><span class="s1">'value.string_value'</span><span class="p">)</span> <span class="p">}}</span> <span class="k">FROM</span> <span class="k">UNNEST</span> <span class="p">(</span><span class="n">event_params</span><span class="p">)</span> <span class="k">WHERE</span> <span class="k">key</span> <span class="o">=</span> <span class="s1">'to_tab_name'</span><span class="p">),</span> <span class="s1">'UNK'</span><span class="p">)</span> <span class="k">AS</span> <span class="n">to_tab_name</span><span class="p">,</span>
    <span class="p">...</span>
<span class="k">FROM</span>
    <span class="p">{{</span> <span class="k">source</span><span class="p">(</span><span class="s1">'ga4'</span><span class="p">,</span> <span class="s1">'events'</span><span class="p">)</span> <span class="p">}}</span>
<span class="k">WHERE</span>
    <span class="n">event_date</span> <span class="k">IS</span> <span class="k">NOT</span> <span class="k">NULL</span>
    <span class="k">AND</span> <span class="n">event_timestamp</span> <span class="k">IS</span> <span class="k">NOT</span> <span class="k">NULL</span>
    <span class="k">AND</span> <span class="n">event_name</span> <span class="o">=</span> <span class="s1">'click_tab'</span>
    <span class="p">...</span>
</code></pre></div></div>

<p>(1) We did not collect detailed columns such as Geo, Demographic, and Tech data. From a Star Schema perspective, managing these through <code class="language-plaintext highlighter-rouge">core_fct_events</code> and <code class="language-plaintext highlighter-rouge">core_dim_users</code> tables via JOIN operations is a more optimal approach.</p>

<p>(2) We created dozens of event-specific model queries in this manner.</p>

<p><img src="site.baseurl/assets/2024-11-03-implementing-data-warehouse-ga4/6.webp" alt="Data Lineage" /></p>
<blockquote>
  <p>A section of the Dâ€™CENT App Data Warehouse Data Lineage</p>
</blockquote>

<p>Meanwhile, the configuration for <code class="language-plaintext highlighter-rouge">core_fct_events</code> and each event-specific model is structured as follows:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">version</span><span class="pi">:</span> <span class="s">xxx</span>

<span class="na">models</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">core_fct_events</span>
    <span class="na">description</span><span class="pi">:</span> <span class="s">Main event table</span>
    <span class="na">meta</span><span class="pi">:</span>
      <span class="na">owner</span><span class="pi">:</span> <span class="s">Joshua Kim</span>
    <span class="na">config</span><span class="pi">:</span>
      <span class="na">tags</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">core"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">fact"</span><span class="pi">]</span>
      <span class="na">materialized</span><span class="pi">:</span> <span class="s">incremental</span>
      <span class="na">incremental_strategy</span><span class="pi">:</span> <span class="s">insert_overwrite</span>
      <span class="na">on_schema_change</span><span class="pi">:</span> <span class="s">append_new_columns</span>
      <span class="na">partition_by</span><span class="pi">:</span>
        <span class="na">field</span><span class="pi">:</span> <span class="s">date</span>
        <span class="na">data_type</span><span class="pi">:</span> <span class="s">date</span>
        <span class="na">granularity</span><span class="pi">:</span> <span class="s">day</span>
      <span class="na">time_ingestion_partitioning</span><span class="pi">:</span> <span class="kc">true</span>
      <span class="na">require_partition_filter</span><span class="pi">:</span> <span class="kc">true</span>
      <span class="na">copy_partitions</span><span class="pi">:</span> <span class="kc">true</span>
    <span class="na">columns</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">date</span>
        <span class="na">description</span><span class="pi">:</span> <span class="s">Event occurrence date (NOT NULL)</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">datetime</span>
        <span class="na">description</span><span class="pi">:</span> <span class="s">Event occurrence timestamp (NOT NULL)</span>
      <span class="s">...</span>

</code></pre></div></div>

<p>(1) The <code class="language-plaintext highlighter-rouge">date</code> column was set as the partitioning key.</p>

<p>(2) Queries were required to include a partition filter on <code class="language-plaintext highlighter-rouge">date</code> (<strong>require_partition_filter</strong>) to prevent full table scans and reduce query execution costs.</p>

<p>(3) The materialization strategy was set to Incremental (Insert Overwrite).</p>

<ul>
  <li>The Dâ€™CENT App data warehouse updates every hour. Each incremental update checks whether the source table for each <code class="language-plaintext highlighter-rouge">date</code> partition has been updated and applies only the updated partitions.</li>
  <li>In BigQueryâ€™s <code class="language-plaintext highlighter-rouge">date</code> partition environment, using Insert Overwrite removes all data for a specific <code class="language-plaintext highlighter-rouge">date</code> partition before reinserting the updated data. This allows for a stable update strategy without complex incremental logic in dbt models.</li>
</ul>

<h3 id="44-creating-the-core_dim_users-table-model">4.4. Creating the <code class="language-plaintext highlighter-rouge">core_dim_users</code> Table Model</h3>

<p>The <code class="language-plaintext highlighter-rouge">core_dim_users</code> table serves as a user dimension table, containing user attributes associated with <code class="language-plaintext highlighter-rouge">user_pseudo_id</code>, which is shared among fact tables in the Star Schema.</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">WITH</span>
<span class="n">CTE_raw</span> <span class="k">AS</span> <span class="p">(</span>
    <span class="k">SELECT</span>
        <span class="n">user_pseudo_id</span><span class="p">,</span>
        <span class="n">event_timestamp</span><span class="p">,</span>
        <span class="n">user_first_touch_timestamp</span><span class="p">,</span>
        <span class="p">...</span>
        <span class="n">geo</span><span class="p">.</span><span class="n">country</span><span class="p">,</span>
        <span class="p">...</span>
    <span class="k">FROM</span>
        <span class="p">{{</span> <span class="k">source</span><span class="p">(</span><span class="s1">'ga4'</span><span class="p">,</span> <span class="s1">'events'</span><span class="p">)</span> <span class="p">}}</span>
    <span class="k">WHERE</span>
        <span class="n">user_pseudo_id</span> <span class="k">IS</span> <span class="k">NOT</span> <span class="k">NULL</span>
        <span class="p">...</span>
<span class="p">),</span>

<span class="n">CTE_latest</span> <span class="k">AS</span> <span class="p">(</span>
    <span class="k">SELECT</span>
        <span class="n">user_pseudo_id</span><span class="p">,</span>
        <span class="n">event_timestamp</span><span class="p">,</span>
        <span class="n">COALESCE</span><span class="p">(</span><span class="nb">DATE</span><span class="p">(</span><span class="n">TIMESTAMP_MICROS</span><span class="p">(</span><span class="n">LAST_VALUE</span><span class="p">(</span><span class="n">user_first_touch_timestamp</span> <span class="k">IGNORE</span> <span class="n">NULLS</span><span class="p">)</span> <span class="n">OVER</span> <span class="n">w</span><span class="p">),</span> <span class="s1">'Asia/Seoul'</span><span class="p">),</span> <span class="nb">DATE</span><span class="p">(</span><span class="s1">'1900-01-01 00:00:00'</span><span class="p">,</span> <span class="s1">'Asia/Seoul'</span><span class="p">))</span> <span class="k">AS</span> <span class="n">user_first_touch_date</span><span class="p">,</span>
        <span class="n">COALESCE</span><span class="p">(</span><span class="nb">DATETIME</span><span class="p">(</span><span class="n">TIMESTAMP_MICROS</span><span class="p">(</span><span class="n">LAST_VALUE</span><span class="p">(</span><span class="n">user_first_touch_timestamp</span> <span class="k">IGNORE</span> <span class="n">NULLS</span><span class="p">)</span> <span class="n">OVER</span> <span class="n">w</span><span class="p">),</span> <span class="s1">'Asia/Seoul'</span><span class="p">),</span> <span class="nb">DATETIME</span><span class="p">(</span><span class="s1">'1900-01-01 00:00:00'</span><span class="p">,</span> <span class="s1">'Asia/Seoul'</span><span class="p">))</span> <span class="k">AS</span> <span class="n">user_first_touch_datetime</span><span class="p">,</span>
        
        <span class="k">CASE</span>
            <span class="k">WHEN</span> <span class="n">LAST_VALUE</span><span class="p">(</span><span class="n">country</span> <span class="k">IGNORE</span> <span class="n">NULLS</span><span class="p">)</span> <span class="n">OVER</span> <span class="n">w</span> <span class="k">IS</span> <span class="k">NULL</span> <span class="k">THEN</span> <span class="s1">'UNK'</span>
            <span class="k">WHEN</span> <span class="n">LAST_VALUE</span><span class="p">(</span><span class="n">country</span> <span class="k">IGNORE</span> <span class="n">NULLS</span><span class="p">)</span> <span class="n">OVER</span> <span class="n">w</span> <span class="o">=</span> <span class="s1">''</span> <span class="k">THEN</span> <span class="s1">'UNK'</span>
            <span class="k">WHEN</span> <span class="n">LAST_VALUE</span><span class="p">(</span><span class="n">country</span> <span class="k">IGNORE</span> <span class="n">NULLS</span><span class="p">)</span> <span class="n">OVER</span> <span class="n">w</span> <span class="o">=</span> <span class="s1">'(not set)'</span> <span class="k">THEN</span> <span class="s1">'UNK'</span>
            <span class="k">ELSE</span> <span class="n">LAST_VALUE</span><span class="p">(</span><span class="n">country</span> <span class="k">IGNORE</span> <span class="n">NULLS</span><span class="p">)</span> <span class="n">OVER</span> <span class="n">w</span>
        <span class="k">END</span> <span class="k">AS</span> <span class="n">country</span><span class="p">,</span>

        <span class="n">ROW_NUMBER</span><span class="p">()</span> <span class="n">OVER</span> <span class="p">(</span><span class="k">PARTITION</span> <span class="k">BY</span> <span class="n">user_pseudo_id</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">event_timestamp</span> <span class="k">DESC</span><span class="p">)</span> <span class="k">AS</span> <span class="n">row_num</span>
    <span class="k">FROM</span>
        <span class="n">CTE_raw</span>
    <span class="k">WINDOW</span> <span class="n">w</span> 
        <span class="k">AS</span> <span class="p">(</span><span class="k">PARTITION</span> <span class="k">BY</span> <span class="n">user_pseudo_id</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">event_timestamp</span> <span class="k">ROWS</span> <span class="k">BETWEEN</span> <span class="n">UNBOUNDED</span> <span class="k">PRECEDING</span> <span class="k">AND</span> <span class="n">UNBOUNDED</span> <span class="k">FOLLOWING</span><span class="p">)</span>    
<span class="p">)</span>

<span class="k">SELECT</span>
    <span class="o">*</span> <span class="k">EXCEPT</span> <span class="p">(</span><span class="n">event_timestamp</span><span class="p">,</span> <span class="n">row_num</span><span class="p">)</span>
<span class="k">FROM</span>
    <span class="n">CTE_latest</span>
<span class="k">WHERE</span>
    <span class="n">row_num</span> <span class="o">=</span> <span class="mi">1</span>
</code></pre></div></div>

<p>(1) The main query flow follows these steps:</p>

<ul>
  <li>First, the source table retrieves all user information.</li>
  <li>Then, the most recent information is inserted into the existing table using Insert Overwrite.</li>
</ul>

<p>(2) We implemented Slowly Changing Dimension (SCD) Type 1, updating user attributes without maintaining historical records. While we considered SCD Type 3 for tracking historical changes, we decided against it due to:</p>

<ul>
  <li>The organizationâ€™s insufficient data literacy to justify tracking user history.</li>
  <li>The high query costs associated with SCD Type 3.</li>
</ul>

<p><img src="/assets/2024-11-03-implementing-data-warehouse-ga4/7.webp" alt="" /></p>
<blockquote>
  <p><a href="https://www.bps-corp.com/post/so-what-are-slowly-changing-dimensions-scd">What are Slowly Changing Dimensions (SCD)?</a></p>
</blockquote>

<p>Meanwhile, the configuration of the <code class="language-plaintext highlighter-rouge">core_dim_users</code> model is structured as follows:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">version</span><span class="pi">:</span> <span class="m">1</span>

<span class="na">models</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">core_dim_users</span>
    <span class="na">description</span><span class="pi">:</span> <span class="s">User Dimension í…Œì´ë¸”</span>
    <span class="na">meta</span><span class="pi">:</span>
      <span class="na">owner</span><span class="pi">:</span> <span class="s">Joshua Kim</span>
    <span class="na">config</span><span class="pi">:</span>
      <span class="na">tags</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">core"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">dim"</span><span class="pi">]</span>
      <span class="na">materialized</span><span class="pi">:</span> <span class="s">incremental</span>
      <span class="na">incremental_strategy</span><span class="pi">:</span> <span class="s">merge</span>
      <span class="na">unique_key</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">user_pseudo_id"</span><span class="pi">]</span>
      <span class="na">cluster_by</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">user_pseudo_id"</span><span class="pi">]</span>
      <span class="na">on_schema_change</span><span class="pi">:</span> <span class="s">append_new_columns</span>
    <span class="na">columns</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">user_pseudo_id</span>
        <span class="na">description</span><span class="pi">:</span> <span class="s">User Identifier (PK)</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">user_first_touch_date</span>
        <span class="na">description</span><span class="pi">:</span> <span class="s">The date when the user first opened the app or visited the website. (NULL=1900-01-01)</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">user_first_touch_datetime</span>
        <span class="na">description</span><span class="pi">:</span> <span class="s">The timestamp when the user first opened the app or visited the website. (NULL=1900-01-01 00:00:00)</span>
      <span class="s">...</span>
</code></pre></div></div>

<p>(1) By clustering based on <code class="language-plaintext highlighter-rouge">user_pseudo_id</code> (<strong>cluster_by</strong>), we enable faster retrieval of dimension data during JOIN operations in the future.</p>

<p>(2) The materialization strategy is set to Incremental (Merge).</p>

<ul>
  <li>The Incremental approach is applied, with <code class="language-plaintext highlighter-rouge">user_pseudo_id</code> as the unique key, ensuring that any changes in user information columns are merged accordingly. This results in a table structured as an SCD Type 1 model, where only the most recent user information is retained.</li>
</ul>

<h3 id="45-managing-where-statements-and-variables-for-the-incremental-strategy">4.5. Managing Where Statements and Variables for the Incremental Strategy</h3>

<p>One challenge encountered during the <code class="language-plaintext highlighter-rouge">dbt run</code> execution process was that Google Analytics 4 Export Tables are ingested in near real-time through streaming. However, certain columns are not collected in real-time, or their values may fluctuate. We observed that it takes approximately three days for each date-partitioned table to be fully completed.</p>

<p>Due to this, maintaining a one-hour update cycle for the data warehouse via dbt to ensure data freshness was challenging. Since the source table experiences irregular updates, the best approach was to identify date-partitioned tables where changes occurred and use them as variables for dbt processing. This approach can be summarized as follows:</p>

<p>(1) Where Statement for Each Model</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">...</span>
<span class="k">FROM</span>
    <span class="p">{{</span> <span class="k">source</span><span class="p">(</span><span class="s1">'ga4'</span><span class="p">,</span> <span class="s1">'events_intraday'</span><span class="p">)</span> <span class="p">}}</span>
<span class="k">WHERE</span>
    <span class="n">event_date</span> <span class="k">IS</span> <span class="k">NOT</span> <span class="k">NULL</span>
    <span class="k">AND</span> <span class="n">event_timestamp</span> <span class="k">IS</span> <span class="k">NOT</span> <span class="k">NULL</span>
    <span class="k">AND</span> <span class="n">event_name</span> <span class="k">IS</span> <span class="k">NOT</span> <span class="k">NULL</span>
    <span class="c1">-- (1) Applying Variables (Start Date &amp; End Date): Reads only the relevant date-partitioned tables</span>
    <span class="p">{</span><span class="o">%</span> <span class="n">if</span> <span class="n">var</span><span class="p">(</span><span class="s1">'start_date'</span><span class="p">,</span> <span class="k">None</span><span class="p">)</span> <span class="k">is</span> <span class="k">not</span> <span class="k">none</span> <span class="k">and</span> <span class="n">var</span><span class="p">(</span><span class="s1">'end_date'</span><span class="p">,</span> <span class="k">None</span><span class="p">)</span> <span class="k">is</span> <span class="k">not</span> <span class="k">none</span> <span class="o">%</span><span class="p">}</span>
    <span class="k">AND</span> <span class="n">_table_suffix</span> <span class="k">BETWEEN</span> <span class="s1">''</span> <span class="k">AND</span> <span class="s1">''</span>
    <span class="p">{</span><span class="o">%</span> <span class="n">endif</span> <span class="o">%</span><span class="p">}</span>
    <span class="c1">-- (2) Applying Variables (table_suffixes): Reads only tables updated since the last orchestration run</span>
    <span class="p">{</span><span class="o">%</span> <span class="n">if</span> <span class="n">var</span><span class="p">(</span><span class="nv">"table_suffixes"</span><span class="p">,</span> <span class="k">None</span><span class="p">)</span> <span class="k">is</span> <span class="k">not</span> <span class="k">none</span> <span class="o">%</span><span class="p">}</span>
    <span class="k">AND</span> <span class="n">_table_suffix</span> <span class="k">IN</span> <span class="p">(</span><span class="s1">'{{ var("table_suffixes") }}'</span><span class="p">)</span>
    <span class="p">{</span><span class="o">%</span> <span class="n">endif</span> <span class="o">%</span><span class="p">}</span>
</code></pre></div></div>

<p>(2) Variables in the <code class="language-plaintext highlighter-rouge">dbt_project.yml</code> File</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">...</span>
<span class="c1"># Variables</span>
<span class="na">vars</span><span class="pi">:</span>
  <span class="na">start_date</span><span class="pi">:</span> <span class="c1"># D'CENT App GA4 Export Table Start Date (Default: None)</span>
  <span class="na">end_date</span><span class="pi">:</span> <span class="c1"># D'CENT App GA4 Export Table End Date (Default: None)</span>
  <span class="na">table_suffixes</span><span class="pi">:</span> <span class="c1"># D'CENT App GA4 Export Table Suffixes (Default: None)</span>
<span class="nn">...</span>
</code></pre></div></div>

<hr />

<h1 id="5-results">5. Results</h1>

<h3 id="51-improved-query-performance-and-cost-reduction">5.1. Improved Query Performance and Cost Reduction</h3>

<p>Query execution times in Redash and other BI tools have significantly decreased. Previously, queries took over 15 seconds to execute, but after integrating the data warehouse, execution now completes within just 5 seconds.</p>

<h3 id="52-enhanced-data-accessibility-for-the-organization">5.2. Enhanced Data Accessibility for the Organization</h3>

<p>By hosting dbt Docs, anyone can easily access table specifications, as shown below. This enables internal team members to write queries in a more structured and consistent manner, improving overall data accessibility within the organization.</p>

<p><img src="/assets/2024-11-03-implementing-data-warehouse-ga4/8.webp" alt="" /></p>
<blockquote>
  <p>Example of <code class="language-plaintext highlighter-rouge">mart_snp_dau</code> table documentation (Daily Active Users, New Users, Returning Users, Total Sessions, Total Session Duration)</p>
</blockquote>

<hr />

<h1 id="6-conclusion">6. Conclusion</h1>

<p>Building a data warehouse and its associated data marts is a challenging yet highly rewarding task. Even minor issues at the early stages can lead to significant errors in the data used across the organization, making this a highly responsible role. Since I am solely responsible for data management at IoTrust, there is no one to provide feedback on my mistakes. As a result, I adopt a self-review process, essentially working with multiple versions of myself.ğŸ™„</p>

<p>However, seeing my colleagues access and utilize data easily through the data warehouse is incredibly fulfilling. It strengthens my sense of ownership over data, and I become even more invested in ensuring that the organizationâ€™s data-driven decision-making is executed properly.</p>

<p>Moving forward, I plan to focus not just on internal product data but also on leveraging external product data. My goal is to create an environment where both internal and external data can be utilized together to drive better insights.</p>

<hr />

<h2 id="published-by-joshua-kim"><em>Published by</em> Joshua Kim</h2>

<p><img src="/assets/profile/joshua-profile.png" alt="Joshua Kim" /></p>]]></content><author><name></name></author><category term="Language (English)" /><category term="Article (Project)" /><category term="Level (2. Intermediate)" /><category term="Field (Analytics Engineering)" /><category term="Skills (SQL)" /><category term="Skills (dbt)" /><summary type="html"><![CDATA[â€œThis article shares the process and outcomes of building a data warehouse to efficiently utilize Google Analytics 4 (GA4) data. Previously, queries were executed directly on the GA4 Export Table, but issues such as schema complexity, slow query execution times, and high costs necessitated a transition to a data mart. By implementing an Incremental Strategy using dbt, we optimized performance, resulting in significantly improved query speeds, reduced costs, and enhanced data accessibility within the organization, enabling more efficient data utilization.â€]]></summary></entry><entry><title type="html">dbt Docs ì‚¬ë‚´ ê³µìœ  ë°©ë²• (ì‚¬ì´íŠ¸ í˜¸ìŠ¤íŒ… í›„ê¸°)</title><link href="http://localhost:4000/dbt-docs-site-hosting-ko/" rel="alternate" type="text/html" title="dbt Docs ì‚¬ë‚´ ê³µìœ  ë°©ë²• (ì‚¬ì´íŠ¸ í˜¸ìŠ¤íŒ… í›„ê¸°)" /><published>2024-09-21T00:00:00+09:00</published><updated>2024-09-21T00:00:00+09:00</updated><id>http://localhost:4000/dbt-docs-site-hosting-ko</id><content type="html" xml:base="http://localhost:4000/dbt-docs-site-hosting-ko/"><![CDATA[<blockquote>
  <p>â€œì‚¬ë‚´ì—ì„œ dbt Docsë¥¼ í™œìš©í•˜ì—¬ ë°ì´í„° ì›¨ì–´í•˜ìš°ìŠ¤ ë¬¸ì„œí™”ë¥¼ ìë™í™”í•˜ê³  ì´ë¥¼ í†µí•´ ì‚¬ë‚´ ë°ì´í„° ì ‘ê·¼ì„±ê³¼ íš¨ìœ¨ì„±ì„ ë†’ì´ê¸° ìœ„í•œ ì‘ì—…ì„ ìˆ˜í–‰í–ˆìŠµë‹ˆë‹¤. íŠ¹íˆ, dbtì˜ ìë™ ë¬¸ì„œí™” ê¸°ëŠ¥ì„ í™œìš©í•´ í…Œì´ë¸” ê°„ ì˜ì¡´ì„± ë° ëª…ì„¸ì„œë¥¼ ìµœì‹ í™”í•¨ìœ¼ë¡œì¨ ë°ì´í„° í™œìš©ì˜ ì •í™•ì„±ê³¼ ì†ë„ë¥¼ ê°œì„ í–ˆìŠµë‹ˆë‹¤. ì´ë¥¼ ìœ„í•´ VM ì¸ìŠ¤í„´ìŠ¤ì—ì„œ dbt Docsë¥¼ í˜¸ìŠ¤íŒ…í•˜ê³  ì‚¬ë‚´ IP ë²”ìœ„ ë‚´ êµ¬ì„±ì›ë“¤ì´ ì ‘ê·¼í•  ìˆ˜ ìˆë„ë¡ ë°©í™”ë²½ ì„¤ì •ì„ ì¶”ê°€í•˜ëŠ” ë“±ì˜ ê¸°ìˆ ì  ë¬¸ì œë¥¼ í•´ê²°í•˜ë©° ì„±ê³µì ìœ¼ë¡œ ì‹œìŠ¤í…œì„ êµ¬ì¶•í–ˆìŠµë‹ˆë‹¤.â€</p>
</blockquote>

<hr />

<h1 id="ëª©ì°¨">ëª©ì°¨</h1>
<ol>
  <li>dbt Docsë€ ë¬´ì—‡ì¸ê°€?</li>
  <li>ë°°ê²½</li>
  <li>ëª©í‘œ</li>
  <li>ì§„í–‰ ê³¼ì •</li>
  <li>ê²°ë¡ </li>
</ol>

<hr />

<h1 id="1-dbt-docsë€-ë¬´ì—‡ì¸ê°€">1. dbt Docsë€ ë¬´ì—‡ì¸ê°€?</h1>

<p><a href="https://www.getdbt.com/">dbt</a>ëŠ” ELT íŒŒì´í”„ë¼ì¸ì˜ Transformation ë‹¨ê³„ì— íŠ¹í™”ëœ ìë™í™” í”„ë ˆì„ì›Œí¬ë¡œ, Data Analystì™€ Analytics Engineer ë¶„ë“¤ì„ ì¤‘ì‹¬ìœ¼ë¡œ ë„ë¦¬ ì‚¬ìš©ë©ë‹ˆë‹¤.</p>

<p><img src="/assets/2024-09-21-dbt-docs-site-hosting/1.webp" alt="" />
<img src="/assets/2024-09-21-dbt-docs-site-hosting/2.webp" alt="" /></p>

<p>dbtëŠ” í…Œì´ë¸” ê°„ì˜ ì˜ì¡´ ê´€ê³„ë¥¼ ë°”íƒ•ìœ¼ë¡œ Data Lineageë¥¼ ë¶„ì„í•˜ê³ , ê·¸ ê²°ê³¼ë¥¼ DAG (Directed Acyclic Graph) í˜•íƒœë¡œ ì»´íŒŒì¼í•˜ì—¬ ì „ì²´ Transformation ê³¼ì •ì„ ìë™ìœ¼ë¡œ ì‹¤í–‰í•´ì¤ë‹ˆë‹¤. ì´ë¥¼ í†µí•´ ë°ì´í„° ì›¨ì–´í•˜ìš°ìŠ¤ì˜ Orchestration ê´€ë¦¬ë¥¼ ë³´ë‹¤ íš¨ìœ¨ì ìœ¼ë¡œ ì§„í–‰í•  ìˆ˜ ìˆëŠ”ë°ìš”. dbtì˜ ê°€ì¥ í° ì¥ì  ì¤‘ í•˜ë‚˜ëŠ” â€œìë™ ë¬¸ì„œí™”â€ ê¸°ëŠ¥ì…ë‹ˆë‹¤.</p>

<p>(1) <strong>Lineage Graph</strong>: í…Œì´ë¸” ê°„ì˜ ì˜ì¡´ì„±ì„ ì‹œê°ì ìœ¼ë¡œ ë³´ì—¬ì£¼ì–´, ìœ ì§€ë³´ìˆ˜ ì‘ì—…ì‹œ ì˜í–¥ì„ ë°›ëŠ” í…Œì´ë¸”ë“¤ì„ í•œ ëˆˆì— íŒŒì•…í•  ìˆ˜ ìˆë„ë¡ ë„ì™€ì¤ë‹ˆë‹¤.</p>

<p><img src="/assets/2024-09-21-dbt-docs-site-hosting/3.webp" alt="" /></p>

<p>(2) <strong>ëª…ì„¸ì„œ í™•ì¸</strong>: ê° í…Œì´ë¸”ê³¼ ì»¬ëŸ¼ì˜ Description ë“± ì„¸ë¶€ì ì¸ ëª…ì„¸ì„œë¥¼ ì‰½ê²Œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<p><img src="/assets/2024-09-21-dbt-docs-site-hosting/4.gif" alt="" />
<img src="/assets/2024-09-21-dbt-docs-site-hosting/5.gif" alt="" /></p>

<p>dbt DocsëŠ” ë°ì´í„°íŒ€ì˜ ì£¼ìš” Pain Pointë¥¼ í•´ê²°í•˜ëŠ” ë° í° ë„ì›€ì´ ë©ë‹ˆë‹¤. ë§ì€ ê¸°ì—…ì´ ë°ì´í„° í™œìš©ë„ë¥¼ ë†’ì´ê¸° ìœ„í•´ ë°ì´í„° ì›¨ì–´í•˜ìš°ìŠ¤ë¥¼ ë„ì…í•˜ì§€ë§Œ, ìˆ˜ë§ì€ ë°ì´í„° ë§ˆíŠ¸ì™€ í…Œì´ë¸” êµ¬ì¡°ë¡œ ì¸í•´ í˜¼ë€ìŠ¤ëŸ¬ì›Œ ì‚¬ë‚´ êµ¬ì„±ì›ë“¤ì˜ ì ‘ê·¼ì„±ì´ ë–¨ì–´ì§€ëŠ” ì•„ì´ëŸ¬ë‹ˆí•œ ìƒí™©ì— ì‰½ê²Œ ì§ë©´í•˜ê³¤ í•©ë‹ˆë‹¤. íŠ¹íˆ í”„ë¡œë•íŠ¸ì˜ ê¸‰ì„±ì¥ì— ë”°ë¼ ì¡°ì§ì˜ ë°ì´í„° ì˜ì¡´ë„ê°€ ë†’ì•„ì§€ë©´, ë°ì´í„° ì›¨ì–´í•˜ìš°ìŠ¤ì˜ ë¹Œë”© ì†ë„ì— ì§‘ì¤‘í•˜ëŠë¼ í’ˆì§ˆ, ì •í•©ì„±, ì ‘ê·¼ì„±, ëª…ì„¸ì„œ ì‘ì„± ê´€ë¦¬ë¥¼ ìœ ì§€í•˜ê¸°ê°€ ì–´ë ¤ì›Œì§€ê¸°ë„ ì‰½ìŠµë‹ˆë‹¤.</p>

<p>dbtëŠ” ë°ì´í„° ì›¨ì–´í•˜ìš°ìŠ¤ ì „ì²´ì˜ ëª…ì„¸ë¥¼ ìë™ìœ¼ë¡œ ë¬¸ì„œí™”í•´ ì´ëŸ¬í•œ ë¬¸ì œë¥¼ í•´ê²°í•˜ë©°, ë°ì´í„°ì˜ í’ˆì§ˆê³¼ í™œìš©ì„±ì„ ë†’ì´ëŠ” ì¤‘ìš”í•œ ì—­í• ì„ í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.</p>

<hr />

<h1 id="2-ë°°ê²½">2. ë°°ê²½</h1>

<p>ì €ëŠ” ì‚¬ë‚´ì—ì„œ ì¿¼ë¦¬ ì‘ì„± ì—­ëŸ‰ì„ ê°–ì¶˜ êµ¬ì„±ì› ë¶„ë“¤ì´ í…Œì´ë¸”ê³¼ Lineage ë¬¸ì„œë¥¼ í™•ì¸í•˜ì—¬ Redash ëŒ€ì‹œë³´ë“œë¥¼ ì§ì ‘ ë§Œë“¤ ìˆ˜ ìˆëŠ” í™˜ê²½ì„ ì œê³µí•˜ê³ ì í–ˆìŠµë‹ˆë‹¤. ì¦‰, ë°ì´í„° ì›¨ì–´í•˜ìš°ìŠ¤ ë¬¸ì„œí™”ê°€ í•„ìš”í–ˆë˜ ê²ƒì´ì£ . êµ¬ê¸€ ì‹œíŠ¸ë‚˜ ë…¸ì…˜ í˜ì´ì§€ ë“±ì„ í™œìš©í•˜ëŠ” ê²ƒë„ ê³ ë ¤í•´ë´¤ì§€ë§Œ, ì• ë„ë¦¬í‹±ìŠ¤ ì—”ì§€ë‹ˆì–´ë§ ì‘ì—…ê³¼ ë¬¸ì„œí™” ì‘ì—…ì´ ë¶„ë¦¬ë˜ë©´ ë‹¤ìŒê³¼ ê°™ì€ ë¬¸ì œê°€ ë°œìƒí•  ìˆ˜ ìˆë‹¤ëŠ” ë…¸íŒŒì‹¬ì´ ë“¤ì—ˆìŠµë‹ˆë‹¤.</p>

<ul>
  <li>ë°ì´í„° ë§ˆíŠ¸ ìƒì„±ê³¼ ë¬¸ì„œí™” ì‚¬ì´ì˜ Latencyë¡œ ì¸í•´ ì»¤ë®¤ë‹ˆì¼€ì´ì…˜ ì†ë„ê°€ ì €í•˜ë  ìˆ˜ ìˆë‹¤.</li>
  <li>ê°œë³„ì ì¸ ë¬¸ì„œí™” ì‘ì—… ì¤‘ íœ´ë¨¼ ì—ëŸ¬ê°€ ë°œìƒí•˜ì—¬ ë¶€ì •í™•í•œ ì¿¼ë¦¬ ê²°ê³¼ë¥¼ ë‚³ì„ ìˆ˜ ìˆë‹¤.</li>
</ul>

<p>ë”°ë¼ì„œ ì €ëŠ” ë¬¸ì„œí™” í™˜ê²½ì´ ì• ë„ë¦¬í‹±ìŠ¤ ì—”ì§€ë‹ˆì–´ë§ ë³¸ì—°ì˜ ì‘ì—…ê³¼ ë¶„ë¦¬ë˜ì–´ ì´ì¤‘ìœ¼ë¡œ ì§„í–‰ë˜ëŠ” ê²ƒì€ ê²°ì½” ë°”ëŒì§í•˜ì§€ ì•Šë‹¤ê³  íŒë‹¨í–ˆìœ¼ë©°, ë°˜ë³µì ì¸ ì‘ì—… ë£¨í‹´ì„ ì¤„ì„ìœ¼ë¡œì¨ ë” ì¤‘ìš”í•œ ê°€ì¹˜ë¥¼ ì°½ì¶œí•˜ëŠ” ë° ì‹œê°„ì„ ì“°ê³  ì‹¶ì—ˆìŠµë‹ˆë‹¤.</p>

<hr />

<h1 id="3-ëª©í‘œ">3. ëª©í‘œ</h1>

<p>dbt Docs ê¸°ëŠ¥ì„ í†µí•´ ì‚¬ë‚´ êµ¬ì„±ì› ë¶„ë“¤ì´ dbt í”„ë¡œì íŠ¸ ë²„ì „ ì—…ë°ì´íŠ¸ ì¦‰ì‹œ ìµœì‹  ëª…ì„¸ë¥¼ í™•ì¸í•  ìˆ˜ ìˆëŠ” Docs ì‚¬ì´íŠ¸ë¥¼ í˜¸ìŠ¤íŒ…í•˜ëŠ” ê²ƒì´ ì´ë²ˆ ì‘ì—…ì˜ ëª©í‘œì˜€ìŠµë‹ˆë‹¤.</p>

<hr />

<h1 id="4-ì§„í–‰-ê³¼ì •">4. ì§„í–‰ ê³¼ì •</h1>

<h3 id="41-dbt-í”„ë¡œì íŠ¸-ê´€ë¦¬-í˜„í™©">4.1. dbt í”„ë¡œì íŠ¸ ê´€ë¦¬ í˜„í™©</h3>

<p>BigQuery í”„ë¡œì íŠ¸ ë‚´ì—ì„œ ì†ŒìŠ¤ í…Œì´ë¸”ë“¤ì„ Core Layer, Mart Layerë¡œ ë³€í™˜í•˜ëŠ” ì‘ì—…ì„ ì‹¤í–‰í•˜ê³  ìˆìŠµë‹ˆë‹¤.</p>

<p><img src="/assets/2024-09-21-dbt-docs-site-hosting/6.webp" alt="" /></p>

<p>ëª¨ë“  Transformation ê³¼ì •ì€ dbt í”„ë¡œì íŠ¸ë¥¼ í†µí•´ Google Cloudì˜ VM Instance ë‚´ì—ì„œ ì£¼ê¸°ì ìœ¼ë¡œ ì‹¤í–‰ë˜ê³  ìˆìŠµë‹ˆë‹¤.</p>

<p><img src="/assets/2024-09-21-dbt-docs-site-hosting/7.webp" alt="" /></p>

<h3 id="42-ë¡œì»¬-í˜¸ìŠ¤íŒ…ì˜-ë¬¸ì œì ">4.2. ë¡œì»¬ í˜¸ìŠ¤íŒ…ì˜ ë¬¸ì œì </h3>

<p>ì—¬íƒ€ í”„ë ˆì„ì›Œí¬ì™€ ë§ˆì°¬ê°€ì§€ë¡œ, dbt Docsë¥¼ í˜¸ìŠ¤íŒ…í•  ê²½ìš° ê¸°ë³¸ì ìœ¼ë¡œ í•´ë‹¹ Host Machineì—ì„œë§Œ ì ‘ì†ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤. ì¦‰, dbt í”„ë¡œì íŠ¸ê°€ ìˆëŠ” VM Instanceì—ì„œ ì ‘ì†í•˜ê±°ë‚˜, í˜¹ì€ SSH Keyë¥¼ ì‚¬ìš©í•´ Remote ì—°ê²°ëœ Local Machineì—ì„œë§Œ ì ‘ì†í•  ìˆ˜ ìˆëŠ” ê²ƒì…ë‹ˆë‹¤.</p>

<p><img src="/assets/2024-09-21-dbt-docs-site-hosting/8.webp" alt="" /></p>

<p>í•˜ì§€ë§Œ ì‚¬ë‚´ êµ¬ì„±ì›ë“¤ë„ ì ‘ì†í•  ìˆ˜ ìˆëŠ” í™˜ê²½ì„ ë§ˆë ¨í•´ì•¼ í–ˆìŠµë‹ˆë‹¤. ì¦‰, SSH Keyê°€ ì—†ì§€ë§Œ ë™ì¼í•œ IP ì£¼ì†Œ ë²”ìœ„ ë‚´ì—ì„œ ì ‘ì†í•˜ëŠ” ê° Machineì—ì„œ dbt Docs ì‚¬ì´íŠ¸ì— ì ‘ì†í•  ìˆ˜ ìˆë„ë¡ ì§€ì›í•´ì•¼ í–ˆë˜ ê²ƒì´ì£ .</p>

<p><img src="/assets/2024-09-21-dbt-docs-site-hosting/9.webp" alt="" /></p>

<h3 id="43-dbt-docs-í˜¸ìŠ¤íŒ…-ì‹œì‘í•˜ê¸°">4.3. dbt Docs í˜¸ìŠ¤íŒ… ì‹œì‘í•˜ê¸°</h3>

<p>ë‹¤ìŒì€ ì‚¬ë‚´ êµ¬ì„±ì›ë“¤ì˜ ì ‘ì† í™˜ê²½ì„ ë§ˆë ¨í•˜ê¸° ìœ„í•´ ì„¤ì •í•œ ë‹¨ê³„ë“¤ì…ë‹ˆë‹¤.</p>

<p>(1) <code class="language-plaintext highlighter-rouge">tmux</code> ì„¸ì…˜ ìƒì„±</p>

<p><code class="language-plaintext highlighter-rouge">tmux</code>ë¥¼ í†µí•´ VM Instanceì—ì„œ dbt Docs í˜¸ìŠ¤íŒ…ì„ ìœ ì§€í•˜ëŠ” ë…ë¦½ ì„¸ì…˜ì„ ë§Œë“¤ì—ˆìŠµë‹ˆë‹¤.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   tmux new <span class="nt">-s</span> dbt_docs <span class="c"># dbt_docs ì´ë¦„ì˜ ì„¸ì…˜ì„ ìƒì„±í•©ë‹ˆë‹¤.</span>
   tmux attach <span class="nt">-t</span> dbt_docs <span class="c"># dbt_docs ì„¸ì…˜ì— Attachí•©ë‹ˆë‹¤.</span>
</code></pre></div></div>

<p>(2) ì‚¬ì´íŠ¸ ë¹Œë“œ</p>

<p>dbt í”„ë¡œì íŠ¸ì˜ íŒŒì¼ë“¤ì„ ì»´íŒŒì¼í•˜ì—¬ Docs ì‚¬ì´íŠ¸ë¥¼ ë¹Œë“œí–ˆìŠµë‹ˆë‹¤.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   <span class="nb">source </span>dbt-venv/bin/activate <span class="c"># Python Virtual Environment í™œì„±í™”</span>
   <span class="nb">export </span><span class="nv">DBT_PROFILES_DIR</span><span class="o">=</span><span class="s2">"path/to/profiles.yml"</span> <span class="c"># DBT_PROFILES_DIR í™˜ê²½ë³€ìˆ˜ ì •ì˜</span>
   dbt docs generate <span class="nt">--target</span> prod <span class="c"># prod ìŠ¤í‚¤ë§ˆ ê¸°ì¤€ìœ¼ë¡œ dbt Docs ë¹Œë“œí•˜ê¸°</span>
</code></pre></div></div>

<p>(3) ì‚¬ì´íŠ¸ í˜¸ìŠ¤íŒ… ì‹œì‘</p>

<p>Docs ì‚¬ì´íŠ¸ í˜¸ìŠ¤íŒ…ì„ ì‹œì‘í•œ í›„, í•´ë‹¹ ì„¸ì…˜ìœ¼ë¡œë¶€í„° Detachí•˜ì—¬ ë¹ ì ¸ë‚˜ì™”ìŠµë‹ˆë‹¤.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   dbt docs serve <span class="nt">--host</span> 0.0.0.0 <span class="nt">--port</span> 8080 <span class="c"># host ë„ë©”ì¸ê³¼ portë¥¼ íŒŒë¼ë¯¸í„°ë¡œ ëª…ì‹œí•˜ê¸°</span>
</code></pre></div></div>

<p>(4) VM Instance ì„¤ì •</p>

<p>VM Instanceì˜ External IPë¥¼ í™•ì¸í•˜ê³ , ìˆ˜ì • í˜ì´ì§€ì—ì„œ Network Tagë¥¼ ì¶”ê°€í–ˆìŠµë‹ˆë‹¤.</p>

<p><img src="/assets/2024-09-21-dbt-docs-site-hosting/10.webp" alt="" />
<img src="/assets/2024-09-21-dbt-docs-site-hosting/11.webp" alt="" /></p>

<p>(5) VPC ë°©í™”ë²½ ê·œì¹™ ì¶”ê°€</p>

<p>Firewall policies ì½˜ì†”ì— ë“¤ì–´ê°€ì„œ VPC fire rulesë¥¼ ë‹¤ìŒê³¼ ê°™ì´ ì¶”ê°€í–ˆìŠµë‹ˆë‹¤.</p>

<ul>
  <li><strong>ë°©í–¥</strong>: ì¸ê·¸ë ˆìŠ¤ (Ingress)</li>
  <li><strong>ì†ŒìŠ¤ IPv4 ë²”ìœ„</strong>: ì‚¬ë‚´ IPv4 ë²”ìœ„ (CIDR í˜•ì‹)</li>
  <li><strong>íƒ€ê²Ÿ Tags</strong>: ë°©ê¸ˆ ì „ VM Instanceì— ì¶”ê°€í•œ Network Tag (dbt-docs-serve)</li>
  <li><strong>í”„ë¡œí† ì½œ ë° í¬íŠ¸</strong>: ë°©ê¸ˆ ì „ í˜¸ìŠ¤íŒ…í•œ dbt Docsì˜ Port (8080)</li>
</ul>

<p>(6) ì ‘ì† ì£¼ì†Œ</p>

<p>ì´ì œ ì‚¬ë‚´ IPv4 ë²”ìœ„ ë‚´ì—ì„œ ë‹¤ìŒ ì£¼ì†Œë¡œ ì ‘ì†í•˜ë©´ ë©ë‹ˆë‹¤.</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">http://{VM Instanceì˜ External IP}:8080</code></li>
</ul>

<p>(7) êµ¬ì„±ëœ í™˜ê²½ì„ ìš”ì•½í•˜ë©´ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.</p>

<blockquote>
  <p>â€œì‚¬ë‚´ IPv4 ë²”ìœ„ ë‚´ì—ì„œ VM ì¸ìŠ¤í„´ìŠ¤ì˜ External IP ì£¼ì†Œì— Port 8080ìœ¼ë¡œ ì ‘ì†í•˜ë©´, í˜¸ìŠ¤íŒ… ì¤‘ì¸ dbt Docs ì‚¬ì´íŠ¸ê°€ ë¡œë“œë©ë‹ˆë‹¤!â€</p>
</blockquote>

<p><img src="/assets/2024-09-21-dbt-docs-site-hosting/12.webp" alt="" /></p>

<hr />

<h1 id="5-ê²°ë¡ ">5. ê²°ë¡ </h1>

<p>dbt Docs ì‚¬ì´íŠ¸ ë§í¬ë¥¼ ìŠ¬ë™ ì±„ë„ì— ê³ ì •(Pin)í•˜ì—¬ êµ¬ì„±ì› ë¶„ë“¤ì´ ì¶”í›„ í¸ë¦¬í•˜ê²Œ ì ‘ì†í•˜ì‹¤ ìˆ˜ ìˆë„ë¡ ì„¤ì •í–ˆìŠµë‹ˆë‹¤. ì•ìœ¼ë¡œ ê¸°ì—…ê³¼ í”„ë¡œë•íŠ¸ê°€ ì„±ì¥í•¨ì— ë”°ë¼ ë°ì´í„° í™œìš©ì˜ ìˆ˜ìš”ëŠ” ì§€ì†ì ìœ¼ë¡œ ì»¤ì§ˆ ê²ƒì…ë‹ˆë‹¤. dbtì˜ â€œìë™ ë¬¸ì„œí™”â€ ê¸°ëŠ¥ì„ í†µí•´ ë¬¸ì„œí™” ë¦¬ì†ŒìŠ¤ë¥¼ ì ˆê°í•˜ê³ , ë°ì´í„° ë³¸ì—°ì˜ ì—…ë¬´ íš¨ìœ¨ì„±ì„ ë†’ì¼ ìˆ˜ ìˆì„ ê²ƒì…ë‹ˆë‹¤.</p>

<hr />

<h2 id="published-by-joshua-kim"><em>Published by</em> Joshua Kim</h2>

<p><img src="/assets/profile/joshua-profile.png" alt="Joshua Kim" /></p>]]></content><author><name></name></author><category term="Language (Korean)" /><category term="Article (Issue Resolution)" /><category term="Level (1. Beginner)" /><category term="Field (Analytics Engineering)" /><category term="Skills (Linux)" /><summary type="html"><![CDATA[â€œì‚¬ë‚´ì—ì„œ dbt Docsë¥¼ í™œìš©í•˜ì—¬ ë°ì´í„° ì›¨ì–´í•˜ìš°ìŠ¤ ë¬¸ì„œí™”ë¥¼ ìë™í™”í•˜ê³  ì´ë¥¼ í†µí•´ ì‚¬ë‚´ ë°ì´í„° ì ‘ê·¼ì„±ê³¼ íš¨ìœ¨ì„±ì„ ë†’ì´ê¸° ìœ„í•œ ì‘ì—…ì„ ìˆ˜í–‰í–ˆìŠµë‹ˆë‹¤. íŠ¹íˆ, dbtì˜ ìë™ ë¬¸ì„œí™” ê¸°ëŠ¥ì„ í™œìš©í•´ í…Œì´ë¸” ê°„ ì˜ì¡´ì„± ë° ëª…ì„¸ì„œë¥¼ ìµœì‹ í™”í•¨ìœ¼ë¡œì¨ ë°ì´í„° í™œìš©ì˜ ì •í™•ì„±ê³¼ ì†ë„ë¥¼ ê°œì„ í–ˆìŠµë‹ˆë‹¤. ì´ë¥¼ ìœ„í•´ VM ì¸ìŠ¤í„´ìŠ¤ì—ì„œ dbt Docsë¥¼ í˜¸ìŠ¤íŒ…í•˜ê³  ì‚¬ë‚´ IP ë²”ìœ„ ë‚´ êµ¬ì„±ì›ë“¤ì´ ì ‘ê·¼í•  ìˆ˜ ìˆë„ë¡ ë°©í™”ë²½ ì„¤ì •ì„ ì¶”ê°€í•˜ëŠ” ë“±ì˜ ê¸°ìˆ ì  ë¬¸ì œë¥¼ í•´ê²°í•˜ë©° ì„±ê³µì ìœ¼ë¡œ ì‹œìŠ¤í…œì„ êµ¬ì¶•í–ˆìŠµë‹ˆë‹¤.â€]]></summary></entry><entry><title type="html">How to Share dbt Docs Internally (Site Hosting Review)</title><link href="http://localhost:4000/dbt-docs-site-hosting-en/" rel="alternate" type="text/html" title="How to Share dbt Docs Internally (Site Hosting Review)" /><published>2024-09-21T00:00:00+09:00</published><updated>2024-09-21T00:00:00+09:00</updated><id>http://localhost:4000/dbt-docs-site-hosting-en</id><content type="html" xml:base="http://localhost:4000/dbt-docs-site-hosting-en/"><![CDATA[<blockquote>
  <p>â€œI worked on automating data warehouse documentation using dbt Docs within the company, aiming to improve internal data accessibility and efficiency. Specifically, I utilized dbtâ€™s automated documentation feature to keep dependencies between tables and specifications up to date, thereby improving the accuracy and speed of data usage. I successfully built the system by resolving technical issues, such as hosting dbt Docs on a VM instance and adding firewall settings to allow internal team members to access it within the companyâ€™s IP range.â€</p>
</blockquote>

<hr />

<h1 id="table-of-contents">Table of Contents</h1>
<ol>
  <li>What is dbt Docs?</li>
  <li>Background</li>
  <li>Objective</li>
  <li>Process</li>
  <li>Conclusion</li>
</ol>

<hr />

<h1 id="1-what-is-dbt-docs">1. What is dbt Docs?</h1>

<p><a href="https://www.getdbt.com/">dbt</a> is an automation framework specialized in the transformation phase of the ELT pipeline, widely used by data analysts and analytics engineers.</p>

<p><img src="/assets/2024-09-21-dbt-docs-site-hosting/1.webp" alt="" />
<img src="/assets/2024-09-21-dbt-docs-site-hosting/2.webp" alt="" /></p>

<p>dbt analyzes data lineage based on table dependencies and compiles it into a DAG (Directed Acyclic Graph) to automatically execute the entire transformation process. This enables more efficient orchestration management of data warehouses. One of dbtâ€™s key strengths is its â€œautomated documentationâ€ feature.</p>

<p>(1) <strong>Lineage Graph</strong>: Visually displays table dependencies, allowing you to easily identify the tables affected during maintenance tasks.</p>

<p><img src="/assets/2024-09-21-dbt-docs-site-hosting/3.webp" alt="" /></p>

<p>(2) <strong>View Specifications</strong>: Easily check detailed specifications, such as descriptions of each table and column.</p>

<p><img src="/assets/2024-09-21-dbt-docs-site-hosting/4.gif" alt="" />
<img src="/assets/2024-09-21-dbt-docs-site-hosting/5.gif" alt="" /></p>

<p>dbt Docs is highly effective in addressing major pain points for data teams. While many companies adopt data warehouses to enhance data utilization, they often face the ironic situation where the complexity of numerous data marts and table structures reduces internal accessibility. As the organizationâ€™s dependence on data increases with the rapid growth of its products, maintaining quality, accuracy, accessibility, and documentation can become increasingly difficult.</p>

<p>dbt solves this problem by automatically documenting the entire data warehouse, playing a key role in improving data quality and usability.</p>

<hr />

<h1 id="2-background">2. Background</h1>

<p>I wanted to provide an environment where internal members with query-writing skills could view table and lineage documentation and directly create Redash dashboards. In other words, data warehouse documentation was necessary. Although I considered using Google Sheets or Notion pages, I was concerned that separating analytics engineering and documentation tasks could lead to the following issues:</p>

<ul>
  <li>Communication could slow down due to latency between data mart creation and documentation.</li>
  <li>Human error during individual documentation could result in inaccurate query outcomes.</li>
</ul>

<p>Thus, I concluded that it was not ideal for the documentation environment to be separated from the core analytics engineering work. I wanted to reduce repetitive tasks and spend more time creating value in more critical areas.</p>

<hr />

<h1 id="3-objective">3. Objective</h1>

<p>The goal of this project was to host a dbt Docs site where internal members could check the latest specifications as soon as the dbt project version was updated.</p>

<hr />

<h1 id="4-process">4. Process</h1>

<h3 id="41-current-dbt-project-management">4.1. Current dbt Project Management</h3>

<p>Iâ€™ve been working on converting source tables into Core Layer and Mart Layer within the BigQuery project.</p>

<p><img src="/assets/2024-09-21-dbt-docs-site-hosting/6.webp" alt="" /></p>

<p>All transformation processes are periodically executed via a dbt project on a Google Cloud VM instance.</p>

<p><img src="/assets/2024-09-21-dbt-docs-site-hosting/7.webp" alt="" /></p>

<h3 id="42-issues-with-local-hosting">4.2. Issues with Local Hosting</h3>

<p>As with other frameworks, hosting dbt Docs is, by default, only accessible from the host machine. In other words, you can only access it from the VM instance where the dbt project is located or from a locally connected machine via SSH.</p>

<p><img src="/assets/2024-09-21-dbt-docs-site-hosting/8.webp" alt="" /></p>

<p>However, I needed to create an environment where internal members could also access it. In short, I had to allow machines within the same IP range, but without SSH keys, to access the dbt Docs site.</p>

<p><img src="/assets/2024-09-21-dbt-docs-site-hosting/9.webp" alt="" /></p>

<h3 id="43-starting-dbt-docs-hosting">4.3. Starting dbt Docs Hosting</h3>

<p>Here are the steps I followed to set up the internal access environment:</p>

<p>(1) Create a <code class="language-plaintext highlighter-rouge">tmux</code> session</p>

<p>I used <code class="language-plaintext highlighter-rouge">tmux</code> to create an independent session on the VM instance to maintain the dbt Docs hosting.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   tmux new <span class="nt">-s</span> dbt_docs <span class="c"># Create a session named dbt_docs</span>
   tmux attach <span class="nt">-t</span> dbt_docs <span class="c"># Attach to the dbt_docs session</span>
</code></pre></div></div>

<p>(2) Build the site</p>

<p>I compiled the dbt project files to build the Docs site.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   <span class="nb">source </span>dbt-venv/bin/activate <span class="c"># Activate Python Virtual Environment</span>
   <span class="nb">export </span><span class="nv">DBT_PROFILES_DIR</span><span class="o">=</span><span class="s2">"path/to/profiles.yml"</span> <span class="c"># Define the DBT_PROFILES_DIR environment variable</span>
   dbt docs generate <span class="nt">--target</span> prod <span class="c"># Build dbt Docs based on the prod schema</span>
</code></pre></div></div>

<p>(3) Start hosting the site</p>

<p>I started hosting the Docs site and detached from the session.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   dbt docs serve <span class="nt">--host</span> 0.0.0.0 <span class="nt">--port</span> 8080 <span class="c"># Specify the host domain and port as parameters</span>
</code></pre></div></div>

<p>(4) Set up the VM Instance</p>

<p>I checked the VM instanceâ€™s external IP and added a network tag on the modification page.</p>

<p><img src="/assets/2024-09-21-dbt-docs-site-hosting/10.webp" alt="" />
<img src="/assets/2024-09-21-dbt-docs-site-hosting/11.webp" alt="" /></p>

<p>(5) Add VPC firewall rules</p>

<p>I went to the firewall policies console and added VPC firewall rules as follows:</p>

<ul>
  <li><strong>Direction</strong>: Ingress</li>
  <li><strong>Source IPv4 Range</strong>: Internal IPv4 range (CIDR format)</li>
  <li><strong>Target Tags</strong>: The network tag added to the VM instance earlier (dbt-docs-serve)</li>
  <li><strong>Protocol and Port</strong>: Port for the dbt Docs hosting (8080)</li>
</ul>

<p>(6) Access address</p>

<p>Now, from within the internal IPv4 range, you can access the site via the following address:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">http://{VM Instanceì˜ External IP}:8080</code></li>
</ul>

<p>(7) In summary, the configured environment is as follows:</p>

<blockquote>
  <p>â€œWithin the internal IPv4 range, you can access the hosted dbt Docs site by connecting to the VM instanceâ€™s external IP address on port 8080!â€</p>
</blockquote>

<p><img src="/assets/2024-09-21-dbt-docs-site-hosting/12.webp" alt="" /></p>

<hr />

<h1 id="5-conclusion">5. Conclusion</h1>

<p>I pinned the dbt Docs site link in the Slack channel to allow team members to easily access it later. As the company and product continue to grow, the demand for data utilization will increase. By leveraging dbtâ€™s â€œautomated documentationâ€ feature, we can save documentation resources and enhance the efficiency of data-related tasks.</p>

<hr />

<h2 id="published-by-joshua-kim"><em>Published by</em> Joshua Kim</h2>

<p><img src="/assets/profile/joshua-profile.png" alt="Joshua Kim" /></p>]]></content><author><name></name></author><category term="Language (English)" /><category term="Article (Issue Resolution)" /><category term="Level (1. Beginner)" /><category term="Field (Analytics Engineering)" /><category term="Skills (Linux)" /><summary type="html"><![CDATA[â€œI worked on automating data warehouse documentation using dbt Docs within the company, aiming to improve internal data accessibility and efficiency. Specifically, I utilized dbtâ€™s automated documentation feature to keep dependencies between tables and specifications up to date, thereby improving the accuracy and speed of data usage. I successfully built the system by resolving technical issues, such as hosting dbt Docs on a VM instance and adding firewall settings to allow internal team members to access it within the companyâ€™s IP range.â€]]></summary></entry><entry><title type="html">Dramatic Increase in E-commerce Conversion Rates</title><link href="http://localhost:4000/how-we-dramatically-improved-conversion-rates-en/" rel="alternate" type="text/html" title="Dramatic Increase in E-commerce Conversion Rates" /><published>2024-08-29T00:00:00+09:00</published><updated>2024-08-29T00:00:00+09:00</updated><id>http://localhost:4000/how-we-dramatically-improved-conversion-rates-en</id><content type="html" xml:base="http://localhost:4000/how-we-dramatically-improved-conversion-rates-en/"><![CDATA[<blockquote>
  <p>â€œBy analyzing the data of new visitors that increased due to external factors, I achieved a significant rise in purchase conversion rates. The data revealed a substantial increase in the number of new visitors and their purchasing intent, but also identified a high dropout rate at the payment stage. Based on the hypothesis that the inconvenience in the payment process was the main cause, I introduced PayPal Express Checkout to enhance user experience. As a result, the payment conversion rate increased by 32%p, reaching a much higher level than before, and this improvement has been sustained. This demonstrates effective problem-solving and performance enhancement based on data analysis.â€</p>
</blockquote>

<hr />

<table>
  <thead>
    <tr>
      <th><strong>Performance Summary</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>- Conversion Rate (<code class="language-plaintext highlighter-rouge">add_payment_info</code> â†’ <code class="language-plaintext highlighter-rouge">purchase</code>): 32%p â†‘</td>
    </tr>
  </tbody>
</table>

<hr />

<h1 id="table-of-contents">Table of Contents</h1>
<ol>
  <li>STAR Summary</li>
  <li>Situation</li>
  <li>Tasks</li>
  <li>Actions</li>
  <li>Results</li>
</ol>

<hr />

<h1 id="1-star-summary">1. STAR Summary</h1>

<h3 id="situation">Situation</h3>
<ul>
  <li>In 2023, our company experienced <strong>an unexpected increase in sales</strong> due to a major competitor, who holds the largest market share globally, becoming embroiled in business controversy.</li>
  <li>As a result, there was a surge in new visitors to our online store, which was identified as a phenomenon driven by changes in the external market, rather than the outcome of our internal marketing efforts.</li>
  <li>As a data analyst, I proactively monitored the data to deeply analyze these unusual market movements, focusing particularly on <strong>the acquisition channels and purchasing behavior patterns of new visitors.</strong></li>
</ul>

<h3 id="tasks">Tasks</h3>
<ul>
  <li>In the context of a surge in new visitors, I discovered <strong>a high dropout rate in the payment process.</strong></li>
  <li>A detailed analysis of the dropout points at each stage of the purchase funnel revealed that many customers were <strong>abandoning their processes after entering their payment information.</strong></li>
  <li>Recognizing that <strong>UX in the payment process</strong> significantly affects purchase conversion, I identified a need to improve the user experience by clearly defining the problem.</li>
  <li>Additionally, I concluded that the decline in conversion rates might be related to the natural increase in organic user acquisition due to external factors and changes in user segments.</li>
</ul>

<h3 id="actions">Actions</h3>
<ul>
  <li>Based on the identified problem, I shared it with internal stakeholders and discussed several action plans to improve the payment process.</li>
  <li>As a result of the discussions, we decided to <strong>first introduce the easy payment service, PayPal Express Checkout</strong>, to reduce the dropout rate in the payment process.</li>
  <li>This was deemed the most realistic and effective solution to streamline the payment steps and provide a convenient payment experience to users, thereby increasing conversion rates.</li>
  <li>After implementing this feature, I focused on minimizing user discomfort during the payment process and enhancing security trustworthiness, thereby improving UX.</li>
</ul>

<h3 id="results">Results</h3>
<ul>
  <li>After introducing the PayPal Express Checkout feature, the dropout issue during the payment process significantly improved, and <strong>the conversion rate from <code class="language-plaintext highlighter-rouge">add_payment_info</code> to <code class="language-plaintext highlighter-rouge">purchase</code> increased by 32 percentage points compared to before.</strong></li>
  <li>This action not only restored the conversion rate to its original level by simplifying the payment process and improving the user experience but <strong>also maintained a high level to this day</strong>.</li>
  <li>This result demonstrates that diversifying payment options and introducing easy payment methods are effective strategies, showing that problem-solving based on data analysis has had a positive impact on sales performance.</li>
</ul>

<hr />

<h1 id="2-situation">2. Situation</h1>
<blockquote>
  <ul>
    <li>In 2023, our company experienced <strong>an unexpected increase in sales</strong> due to a major competitor, who holds the largest market share globally, becoming embroiled in business controversy.</li>
    <li>As a result, there was a surge in new visitors to our online store, which was identified as a phenomenon driven by changes in the external market, rather than the outcome of our internal marketing efforts.</li>
    <li>As a data analyst, I proactively monitored the data to deeply analyze these unusual market movements, focusing particularly on <strong>the acquisition channels and purchasing behavior patterns of new visitors.</strong></li>
  </ul>
</blockquote>

<h3 id="detailed-situation">Detailed Situation</h3>
<ul>
  <li>In 2023, a competitor with the top market share globally became heavily embroiled in business controversy, resulting in a windfall for our company, with a significant increase in sales on our own website. This was due to external market influences rather than the results of our internal marketing efforts.</li>
  <li>As a data analyst, I also wanted to deeply monitor and follow up on this â€œ<strong>abnormal phenomenon caused by unusual market flows.</strong>â€</li>
</ul>

<h3 id="data-follow-up">Data Follow-up</h3>

<ol>
  <li>The number of new visitors surged.
    <details>
<summary>View Query</summary>
<div>
        <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   <span class="k">WITH</span>
   <span class="n">CTE_raw</span> <span class="k">AS</span> <span class="p">(</span>
      <span class="k">SELECT</span>
         <span class="n">event_date</span><span class="p">,</span>
         <span class="n">user_pseudo_id</span><span class="p">,</span>
         <span class="p">(</span><span class="k">SELECT</span> <span class="n">value</span><span class="p">.</span><span class="n">int_value</span> <span class="k">FROM</span> <span class="k">UNNEST</span> <span class="p">(</span><span class="n">event_params</span><span class="p">)</span> <span class="k">WHERE</span> <span class="k">key</span> <span class="o">=</span> <span class="s1">'ga_session_number'</span><span class="p">)</span> <span class="k">AS</span> <span class="n">ga_session_number</span>
      <span class="k">FROM</span> <span class="nv">`project_id.dataset_id.events_*`</span>
      <span class="k">WHERE</span>
         <span class="n">_table_suffix</span> <span class="k">BETWEEN</span> <span class="n">FORMAT_DATE</span><span class="p">(</span><span class="s1">'%Y%m%d'</span><span class="p">,</span> <span class="s1">'START DATE'</span><span class="p">)</span> <span class="k">AND</span> <span class="n">FORMAT_DATE</span><span class="p">(</span><span class="s1">'%Y%m%d'</span><span class="p">,</span> <span class="s1">'END DATE'</span><span class="p">)</span>
   <span class="p">),</span>

   <span class="n">CTE_users_min_gsn</span> <span class="k">AS</span> <span class="p">(</span>
      <span class="k">SELECT</span>
         <span class="n">event_date</span><span class="p">,</span>
         <span class="n">user_pseudo_id</span><span class="p">,</span>
         <span class="k">MIN</span><span class="p">(</span><span class="n">ga_session_number</span><span class="p">)</span> <span class="k">AS</span> <span class="n">min_gsn</span>
      <span class="k">FROM</span>
         <span class="n">CTE_raw</span>
      <span class="k">GROUP</span> <span class="k">BY</span>
         <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span>
   <span class="p">)</span>

   <span class="k">SELECT</span>
      <span class="n">event_date</span><span class="p">,</span>
      <span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="n">user_pseudo_id</span><span class="p">)</span> <span class="k">AS</span> <span class="n">users_cnt</span>
   <span class="k">FROM</span>
      <span class="n">CTE_users_min_gsn</span>
   <span class="k">WHERE</span>
      <span class="n">min_gsn</span> <span class="o">=</span> <span class="mi">1</span>
   <span class="k">GROUP</span> <span class="k">BY</span>
      <span class="mi">1</span>
   <span class="k">ORDER</span> <span class="k">BY</span>
      <span class="mi">1</span>
</code></pre></div>        </div>
      </div>
</details>
    <p><img src="/assets/2024-08-29-how-we-dramatically-improved-conversion-rates/1.png" alt="" /></p>
  </li>
  <li>These visitors primarily entered through organic traffic and from the United States.
    <ul>
      <li>Number of New Users (by Country)
        <details>
 <summary>View Query</summary>
 <div>
            <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="k">WITH</span>
 <span class="n">CTE_raw</span> <span class="k">AS</span> <span class="p">(</span>
    <span class="k">SELECT</span>
       <span class="n">event_date</span><span class="p">,</span>
       <span class="n">user_pseudo_id</span><span class="p">,</span>
       <span class="p">(</span><span class="k">SELECT</span> <span class="n">value</span><span class="p">.</span><span class="n">int_value</span> <span class="k">FROM</span> <span class="k">UNNEST</span> <span class="p">(</span><span class="n">event_params</span><span class="p">)</span> <span class="k">WHERE</span> <span class="k">key</span> <span class="o">=</span> <span class="s1">'ga_session_number'</span><span class="p">)</span> <span class="k">AS</span> <span class="n">ga_session_number</span><span class="p">,</span>
       <span class="n">geo</span><span class="p">.</span><span class="n">country</span>
    <span class="k">FROM</span> <span class="nv">`project_id.dataset_id.events_*`</span>
    <span class="k">WHERE</span>
       <span class="n">_table_suffix</span> <span class="k">BETWEEN</span> <span class="n">FORMAT_DATE</span><span class="p">(</span><span class="s1">'%Y%m%d'</span><span class="p">,</span> <span class="s1">'START DATE'</span><span class="p">)</span> <span class="k">AND</span> <span class="n">FORMAT_DATE</span><span class="p">(</span><span class="s1">'%Y%m%d'</span><span class="p">,</span> <span class="s1">'END DATE'</span><span class="p">)</span>
 <span class="p">),</span>

 <span class="n">CTE_users_min_gsn</span> <span class="k">AS</span> <span class="p">(</span>
    <span class="k">SELECT</span>
       <span class="n">event_date</span><span class="p">,</span>
       <span class="n">user_pseudo_id</span><span class="p">,</span>
       <span class="n">country</span><span class="p">,</span>
       <span class="k">MIN</span><span class="p">(</span><span class="n">ga_session_number</span><span class="p">)</span> <span class="k">AS</span> <span class="n">min_gsn</span>
    <span class="k">FROM</span>
       <span class="n">CTE_raw</span>
    <span class="k">GROUP</span> <span class="k">BY</span>
       <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span>
 <span class="p">),</span>

 <span class="n">CTE_top20_countries</span> <span class="k">AS</span> <span class="p">(</span>
    <span class="k">SELECT</span>
       <span class="n">country</span><span class="p">,</span>
       <span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="n">user_pseudo_id</span><span class="p">)</span> <span class="k">AS</span> <span class="n">users_cnt</span>
    <span class="k">FROM</span>
       <span class="n">CTE_users_min_gsn</span>
    <span class="k">WHERE</span>
       <span class="n">min_gsn</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">GROUP</span> <span class="k">BY</span>
       <span class="mi">1</span>
    <span class="k">ORDER</span> <span class="k">BY</span>
       <span class="mi">2</span> <span class="k">DESC</span>
    <span class="k">LIMIT</span>
       <span class="mi">20</span>
 <span class="p">),</span>

 <span class="n">CTE_result</span> <span class="k">AS</span> <span class="p">(</span>
    <span class="k">SELECT</span>
       <span class="n">event_date</span><span class="p">,</span>
       <span class="k">CASE</span>
             <span class="k">WHEN</span> <span class="n">country</span> <span class="k">IN</span> <span class="p">(</span><span class="k">SELECT</span> <span class="n">country</span> <span class="k">FROM</span> <span class="n">CTE_top20_countries</span><span class="p">)</span> <span class="k">THEN</span> <span class="n">country</span>
             <span class="k">ELSE</span> <span class="s1">'(Others)'</span>
       <span class="k">END</span> <span class="k">AS</span> <span class="n">country</span><span class="p">,</span>
       <span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="n">user_pseudo_id</span><span class="p">)</span> <span class="k">AS</span> <span class="n">users_cnt</span>
    <span class="k">FROM</span>
       <span class="n">CTE_users_min_gsn</span>
    <span class="k">WHERE</span>
       <span class="n">min_gsn</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">GROUP</span> <span class="k">BY</span>
       <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span>
 <span class="p">)</span>

 <span class="k">SELECT</span>
    <span class="o">*</span>
 <span class="k">FROM</span>
    <span class="n">CTE_result</span>
 <span class="k">ORDER</span> <span class="k">BY</span>
    <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span> <span class="k">DESC</span>
</code></pre></div>            </div>
          </div>
 </details>
        <p><img src="/assets/2024-08-29-how-we-dramatically-improved-conversion-rates/3.png" alt="" /></p>
      </li>
      <li>Number of New Users (by First UTM Parameters)
        <details>
 <summary>View Query</summary>
 <div>
            <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="k">WITH</span>
 <span class="n">CTE_raw</span> <span class="k">AS</span> <span class="p">(</span>
    <span class="k">SELECT</span>
       <span class="n">event_date</span><span class="p">,</span>
       <span class="n">user_pseudo_id</span><span class="p">,</span>
       <span class="p">(</span><span class="k">SELECT</span> <span class="n">value</span><span class="p">.</span><span class="n">int_value</span> <span class="k">FROM</span> <span class="k">UNNEST</span> <span class="p">(</span><span class="n">event_params</span><span class="p">)</span> <span class="k">WHERE</span> <span class="k">key</span> <span class="o">=</span> <span class="s1">'ga_session_number'</span><span class="p">)</span> <span class="k">AS</span> <span class="n">ga_session_number</span><span class="p">,</span>
       <span class="n">traffic_source</span><span class="p">.</span><span class="n">name</span> <span class="k">AS</span> <span class="n">first_campaign</span><span class="p">,</span>
       <span class="n">traffic_source</span><span class="p">.</span><span class="n">medium</span> <span class="k">AS</span> <span class="n">first_medium</span><span class="p">,</span>
       <span class="n">traffic_source</span><span class="p">.</span><span class="k">source</span> <span class="k">AS</span> <span class="n">first_source</span>
    <span class="k">FROM</span> <span class="nv">`project_id.dataset_id.events_*`</span>
    <span class="k">WHERE</span>
       <span class="n">_table_suffix</span> <span class="k">BETWEEN</span> <span class="n">FORMAT_DATE</span><span class="p">(</span><span class="s1">'%Y%m%d'</span><span class="p">,</span> <span class="s1">'START DATE'</span><span class="p">)</span> <span class="k">AND</span> <span class="n">FORMAT_DATE</span><span class="p">(</span><span class="s1">'%Y%m%d'</span><span class="p">,</span> <span class="s1">'END DATE'</span><span class="p">)</span>
 <span class="p">),</span>

 <span class="n">CTE_users_min_gsn</span> <span class="k">AS</span> <span class="p">(</span>
    <span class="k">SELECT</span>
       <span class="n">event_date</span><span class="p">,</span>
       <span class="n">user_pseudo_id</span><span class="p">,</span>
       <span class="n">first_campaign</span><span class="p">,</span>
       <span class="n">first_medium</span><span class="p">,</span>
       <span class="n">first_source</span><span class="p">,</span>
       <span class="k">MIN</span><span class="p">(</span><span class="n">ga_session_number</span><span class="p">)</span> <span class="k">AS</span> <span class="n">min_gsn</span>
    <span class="k">FROM</span>
       <span class="n">CTE_raw</span>
    <span class="k">GROUP</span> <span class="k">BY</span>
       <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span>
 <span class="p">),</span>

 <span class="n">CTE_top20_utms</span> <span class="k">AS</span> <span class="p">(</span>
    <span class="k">SELECT</span>
       <span class="n">COALESCE</span><span class="p">(</span><span class="n">first_campaign</span><span class="p">,</span> <span class="s1">'(Unknown)'</span><span class="p">)</span> <span class="o">||</span> <span class="s1">' &gt; '</span> <span class="o">||</span> <span class="n">COALESCE</span><span class="p">(</span><span class="n">first_medium</span><span class="p">,</span> <span class="s1">'(Unknown)'</span><span class="p">)</span> <span class="o">||</span> <span class="s1">' &gt; '</span> <span class="o">||</span> <span class="n">COALESCE</span><span class="p">(</span><span class="n">first_source</span><span class="p">,</span> <span class="s1">'(Unknown)'</span><span class="p">)</span> <span class="k">AS</span> <span class="n">utm</span><span class="p">,</span>
       <span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="n">user_pseudo_id</span><span class="p">)</span> <span class="k">AS</span> <span class="n">users_cnt</span>
    <span class="k">FROM</span>
       <span class="n">CTE_users_min_gsn</span>
    <span class="k">WHERE</span>
       <span class="n">min_gsn</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">GROUP</span> <span class="k">BY</span>
       <span class="mi">1</span>
    <span class="k">ORDER</span> <span class="k">BY</span>
       <span class="mi">2</span> <span class="k">DESC</span>
    <span class="k">LIMIT</span>
       <span class="mi">20</span>
 <span class="p">),</span>

 <span class="n">CTE_result</span> <span class="k">AS</span> <span class="p">(</span>
    <span class="k">SELECT</span>
       <span class="n">event_date</span><span class="p">,</span>
       <span class="k">CASE</span>
             <span class="k">WHEN</span> <span class="n">COALESCE</span><span class="p">(</span><span class="n">first_campaign</span><span class="p">,</span> <span class="s1">'(Unknown)'</span><span class="p">)</span> <span class="o">||</span> <span class="s1">' &gt; '</span> <span class="o">||</span> <span class="n">COALESCE</span><span class="p">(</span><span class="n">first_medium</span><span class="p">,</span> <span class="s1">'(Unknown)'</span><span class="p">)</span> <span class="o">||</span> <span class="s1">' &gt; '</span> <span class="o">||</span> <span class="n">COALESCE</span><span class="p">(</span><span class="n">first_source</span><span class="p">,</span> <span class="s1">'(Unknown)'</span><span class="p">)</span> <span class="k">IN</span> <span class="p">(</span><span class="k">SELECT</span> <span class="n">utm</span> <span class="k">FROM</span> <span class="n">CTE_top20_utms</span><span class="p">)</span> <span class="k">THEN</span> <span class="n">COALESCE</span><span class="p">(</span><span class="n">first_campaign</span><span class="p">,</span> <span class="s1">'(Unknown)'</span><span class="p">)</span> <span class="o">||</span> <span class="s1">' &gt; '</span> <span class="o">||</span> <span class="n">COALESCE</span><span class="p">(</span><span class="n">first_medium</span><span class="p">,</span> <span class="s1">'(Unknown)'</span><span class="p">)</span> <span class="o">||</span> <span class="s1">' &gt; '</span> <span class="o">||</span> <span class="n">COALESCE</span><span class="p">(</span><span class="n">first_source</span><span class="p">,</span> <span class="s1">'(Unknown)'</span><span class="p">)</span>
             <span class="k">ELSE</span> <span class="s1">'(Others)'</span>
       <span class="k">END</span> <span class="k">AS</span> <span class="n">utm</span><span class="p">,</span>
       <span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="n">user_pseudo_id</span><span class="p">)</span> <span class="k">AS</span> <span class="n">users_cnt</span>
    <span class="k">FROM</span>
       <span class="n">CTE_users_min_gsn</span>
    <span class="k">WHERE</span>
       <span class="n">min_gsn</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">GROUP</span> <span class="k">BY</span>
       <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span>
 <span class="p">)</span>

 <span class="k">SELECT</span>
    <span class="o">*</span>
 <span class="k">FROM</span>
    <span class="n">CTE_result</span>
 <span class="k">ORDER</span> <span class="k">BY</span>
    <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span> <span class="k">DESC</span>
</code></pre></div>            </div>
          </div>
 </details>
        <p><img src="/assets/2024-08-29-how-we-dramatically-improved-conversion-rates/4.png" alt="" /></p>
      </li>
    </ul>
  </li>
  <li>The purchasing intent of new visitors was significantly higher than in the past.
    <details>
<summary>View Query</summary>
<div>
        <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   <span class="k">WITH</span>
   <span class="n">CTE_raw</span> <span class="k">AS</span> <span class="p">(</span>
      <span class="k">SELECT</span>
         <span class="n">event_date</span><span class="p">,</span>
         <span class="n">user_pseudo_id</span><span class="p">,</span>
         <span class="p">(</span><span class="k">SELECT</span> <span class="n">value</span><span class="p">.</span><span class="n">int_value</span> <span class="k">FROM</span> <span class="k">UNNEST</span> <span class="p">(</span><span class="n">event_params</span><span class="p">)</span> <span class="k">WHERE</span> <span class="k">key</span> <span class="o">=</span> <span class="s1">'ga_session_number'</span><span class="p">)</span> <span class="k">AS</span> <span class="n">ga_session_number</span><span class="p">,</span>
         <span class="n">event_name</span>
      <span class="k">FROM</span> <span class="nv">`project_id.dataset_id.events_*`</span>
      <span class="k">WHERE</span>
         <span class="n">_table_suffix</span> <span class="k">BETWEEN</span> <span class="n">FORMAT_DATE</span><span class="p">(</span><span class="s1">'%Y%m%d'</span><span class="p">,</span> <span class="s1">'START DATE'</span><span class="p">)</span> <span class="k">AND</span> <span class="n">FORMAT_DATE</span><span class="p">(</span><span class="s1">'%Y%m%d'</span><span class="p">,</span> <span class="s1">'END DATE'</span><span class="p">)</span>
   <span class="p">),</span>

<span class="n">CTE_users</span> <span class="k">AS</span> <span class="p">(</span>
   <span class="k">SELECT</span>
      <span class="n">event_date</span><span class="p">,</span>
      <span class="n">user_pseudo_id</span><span class="p">,</span>
      <span class="n">event_name</span><span class="p">,</span>
      <span class="k">MIN</span><span class="p">(</span><span class="n">ga_session_number</span><span class="p">)</span> <span class="k">AS</span> <span class="n">min_gsn</span>
   <span class="k">FROM</span>
      <span class="n">CTE_raw</span>
   <span class="k">GROUP</span> <span class="k">BY</span>
      <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span>
<span class="p">),</span>

<span class="n">CTE_new_users</span> <span class="k">AS</span> <span class="p">(</span>
   <span class="k">SELECT</span>
      <span class="n">event_date</span><span class="p">,</span>
      <span class="n">user_pseudo_id</span>
   <span class="k">FROM</span>
      <span class="n">CTE_users</span>
   <span class="k">WHERE</span>
      <span class="n">min_gsn</span> <span class="o">=</span> <span class="mi">1</span>
<span class="p">)</span>

<span class="k">SELECT</span>
   <span class="n">U</span><span class="p">.</span><span class="n">event_date</span><span class="p">,</span>
   <span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="n">NU</span><span class="p">.</span><span class="n">user_pseudo_id</span><span class="p">)</span> <span class="k">AS</span> <span class="n">new_users_cnt</span><span class="p">,</span>
   <span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="k">CASE</span> <span class="k">WHEN</span> <span class="n">U</span><span class="p">.</span><span class="n">event_name</span> <span class="o">=</span> <span class="s1">'view_item'</span> <span class="k">THEN</span> <span class="n">NU</span><span class="p">.</span><span class="n">user_pseudo_id</span> <span class="k">END</span><span class="p">)</span> <span class="k">AS</span> <span class="n">new_users_cnt_view_item</span><span class="p">,</span>
   <span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="k">CASE</span> <span class="k">WHEN</span> <span class="n">U</span><span class="p">.</span><span class="n">event_name</span> <span class="o">=</span> <span class="s1">'begin_checkout'</span> <span class="k">THEN</span> <span class="n">NU</span><span class="p">.</span><span class="n">user_pseudo_id</span> <span class="k">END</span><span class="p">)</span> <span class="k">AS</span> <span class="n">new_users_cnt_begin_checkout</span>    
<span class="k">FROM</span>
   <span class="n">CTE_users</span> <span class="n">U</span>
<span class="k">LEFT</span> <span class="k">JOIN</span> 
   <span class="n">CTE_new_users</span> <span class="n">NU</span>
   <span class="k">ON</span> <span class="n">U</span><span class="p">.</span><span class="n">event_date</span> <span class="o">=</span> <span class="n">NU</span><span class="p">.</span><span class="n">event_date</span>
   <span class="k">AND</span> <span class="n">U</span><span class="p">.</span><span class="n">user_pseudo_id</span> <span class="o">=</span> <span class="n">NU</span><span class="p">.</span><span class="n">user_pseudo_id</span>
<span class="k">GROUP</span> <span class="k">BY</span>
   <span class="mi">1</span>
<span class="k">ORDER</span> <span class="k">BY</span>
   <span class="mi">1</span>
</code></pre></div>        </div>
      </div>
</details>
    <p><img src="/assets/2024-08-29-how-we-dramatically-improved-conversion-rates/2.png" alt="" /></p>
  </li>
</ol>

<h3 id="problem-discovery">Problem Discovery</h3>

<ol>
  <li>However, there was a sharp increase in dropout rates in the payment process after completing the purchase-related information such as shipping address, email, and contact information.
    <details>
<summary>View Query</summary>
<div>
        <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   <span class="k">WITH</span>
   <span class="n">CTE_raw</span> <span class="k">AS</span> <span class="p">(</span>
      <span class="k">SELECT</span>
         <span class="n">event_date</span><span class="p">,</span>
         <span class="n">user_pseudo_id</span><span class="p">,</span>
         <span class="n">event_name</span>
      <span class="k">FROM</span> <span class="nv">`project_id.dataset_id.events_*`</span>
      <span class="k">WHERE</span>
         <span class="n">_table_suffix</span> <span class="k">BETWEEN</span> <span class="n">FORMAT_DATE</span><span class="p">(</span><span class="s1">'%Y%m%d'</span><span class="p">,</span> <span class="s1">'START DATE'</span><span class="p">)</span> <span class="k">AND</span> <span class="n">FORMAT_DATE</span><span class="p">(</span><span class="s1">'%Y%m%d'</span><span class="p">,</span> <span class="s1">'END DATE'</span><span class="p">)</span>
   <span class="p">),</span>

   <span class="n">CTE_funnel</span> <span class="k">AS</span> <span class="p">(</span>
      <span class="k">SELECT</span>
         <span class="n">event_date</span><span class="p">,</span>
         <span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="n">user_pseudo_id</span><span class="p">)</span> <span class="k">AS</span> <span class="n">all_users_cnt</span><span class="p">,</span>
         <span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="k">CASE</span> <span class="k">WHEN</span> <span class="n">event_name</span> <span class="o">=</span> <span class="s1">'view_item'</span> <span class="k">THEN</span> <span class="n">user_pseudo_id</span> <span class="k">END</span><span class="p">)</span> <span class="k">AS</span> <span class="n">view_item_users_cnt</span><span class="p">,</span>
         <span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="k">CASE</span> <span class="k">WHEN</span> <span class="n">event_name</span> <span class="o">=</span> <span class="s1">'begin_checkout'</span> <span class="k">THEN</span> <span class="n">user_pseudo_id</span> <span class="k">END</span><span class="p">)</span> <span class="k">AS</span> <span class="n">begin_checkout_users_cnt</span><span class="p">,</span>
         <span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="k">CASE</span> <span class="k">WHEN</span> <span class="n">event_name</span> <span class="o">=</span> <span class="s1">'add_payment_info'</span> <span class="k">THEN</span> <span class="n">user_pseudo_id</span> <span class="k">END</span><span class="p">)</span> <span class="k">AS</span> <span class="n">add_payment_info_users_cnt</span><span class="p">,</span>
         <span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="k">CASE</span> <span class="k">WHEN</span> <span class="n">event_name</span> <span class="o">=</span> <span class="s1">'purchase'</span> <span class="k">THEN</span> <span class="n">user_pseudo_id</span> <span class="k">END</span><span class="p">)</span> <span class="k">AS</span> <span class="n">purchase_users_cnt</span>
      <span class="k">FROM</span>
         <span class="n">CTE_raw</span>
      <span class="k">GROUP</span> <span class="k">BY</span>
         <span class="mi">1</span>
   <span class="p">),</span>

   <span class="n">CTE_result</span> <span class="k">AS</span> <span class="p">(</span>
      <span class="k">SELECT</span>
         <span class="n">event_date</span><span class="p">,</span>
         <span class="n">SAFE_DIVIDE</span><span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="n">all_users_cnt</span><span class="p">,</span> <span class="n">all_users_cnt</span><span class="p">)</span> <span class="k">AS</span> <span class="n">all_users_cvr</span><span class="p">,</span>
         <span class="n">SAFE_DIVIDE</span><span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="n">view_item_users_cnt</span><span class="p">,</span> <span class="n">all_users_cnt</span><span class="p">)</span> <span class="k">AS</span> <span class="n">view_item_cvr</span><span class="p">,</span>
         <span class="n">SAFE_DIVIDE</span><span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="n">begin_checkout_users_cnt</span><span class="p">,</span> <span class="n">all_users_cnt</span><span class="p">)</span> <span class="k">AS</span> <span class="n">begin_checkout_cvr</span><span class="p">,</span>
         <span class="n">SAFE_DIVIDE</span><span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="n">add_payment_info_users_cnt</span><span class="p">,</span> <span class="n">all_users_cnt</span><span class="p">)</span> <span class="k">AS</span> <span class="n">add_payment_info_cvr</span><span class="p">,</span>
         <span class="n">SAFE_DIVIDE</span><span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="n">purchase_users_cnt</span><span class="p">,</span> <span class="n">all_users_cnt</span><span class="p">)</span> <span class="k">AS</span> <span class="n">purchase_cvr</span>
      <span class="k">FROM</span>
         <span class="n">CTE_funnel</span>
      <span class="k">ORDER</span> <span class="k">BY</span>
         <span class="mi">1</span>
   <span class="p">)</span>

   <span class="k">SELECT</span>
      <span class="o">*</span>
   <span class="k">FROM</span>
      <span class="n">CTE_result</span>
   <span class="k">ORDER</span> <span class="k">BY</span>
      <span class="mi">1</span>
</code></pre></div>        </div>
      </div>
</details>
    <p><img src="/assets/2024-08-29-how-we-dramatically-improved-conversion-rates/5.png" alt="" /></p>

    <ul>
      <li>The major events in the purchase conversion stages were as follows:
        <ul>
          <li><code class="language-plaintext highlighter-rouge">view_item</code>: Viewing the item page.</li>
          <li><code class="language-plaintext highlighter-rouge">begin_checkout</code>: Starting the purchase process.</li>
          <li><code class="language-plaintext highlighter-rouge">add_payment_info</code>: Completing the entry of purchase-related information such as shipping address, email, and contact information, the nproceeding to the payment process.</li>
          <li><code class="language-plaintext highlighter-rouge">purchase</code>: Completing the final payment and vewing the Thank you page.</li>
        </ul>
      </li>
      <li>Among these four stages, it was confirmed that there was a drop in conversion rates at the point of moving from <code class="language-plaintext highlighter-rouge">add_payment_info</code> to <code class="language-plaintext highlighter-rouge">purchase</code>.</li>
    </ul>
  </li>
</ol>

<hr />

<h1 id="3-tasks">3. Tasks</h1>
<blockquote>
  <ul>
    <li>In the context of a surge in new visitors, I discovered <strong>a high dropout rate in the payment process.</strong></li>
    <li>A detailed analysis of the dropout points at each stage of the purchase funnel revealed that many customers were <strong>abandoning their processes after entering their payment information.</strong></li>
    <li>Recognizing that <strong>UX in the payment process</strong> significantly affects purchase conversion, I identified a need to improve the user experience by clearly defining the problem.</li>
    <li>Additionally, I concluded that the decline in conversion rates might be related to the natural increase in organic user acquisition due to external factors and changes in user segments.</li>
  </ul>
</blockquote>

<h3 id="clarifying-the-problem">Clarifying the Problem</h3>

<ol>
  <li>There was a need to improve the UX of the payment process.
    <ul>
      <li>An analysis of the points with high dropout rates in the purchase funnel revealed that many customers were abandoning their carts in the payment process, even after completing the entry of purchase-related information such as shipping address, email, and contact information.</li>
      <li><strong>Given that they had completed such a cumbersome process of entering purchase information, they must have been in a state of â€œhigh purchase intent,â€ yet a significant number still abandoned their carts.</strong></li>
      <li>This suggested a high possibility that <strong>the dissatisfaction with the payment process was strong enough to undermine the purchase intent itself.</strong></li>
    </ul>
  </li>
  <li>Specifically, the dropout rate was very high at the following stage:
    <ul>
      <li>The UI below appears right after the <code class="language-plaintext highlighter-rouge">add_payment_info</code> event occurs during the payment process by the payment gateway provider.</li>
      <li>Users were not completing the payment and abandoning their carts during this process.
<img src="/assets/2024-08-29-how-we-dramatically-improved-conversion-rates/6.png" alt="" /></li>
    </ul>
  </li>
  <li>The user segments of incoming visitors had changed.
    <ul>
      <li>
        <p>If the conversion rate suddenly diverges from the past without any changes to the website UI, it was determined that this was due to changes in user segments.</p>

        <ul>
          <li>
            <p>This was because it was primarily â€œ<strong>natural inflow</strong>â€ caused by market influences, rather than the â€œ<strong>artificial inflow</strong>â€ that previously visited in response to marketing activities.
 <img src="/assets/2024-08-29-how-we-dramatically-improved-conversion-rates/4.png" alt="" /></p>
          </li>
          <li>
            <p>It was due to the nature/behavior pattern with high purchase intent compared to the past (significantly increased <strong>item page view rate</strong> compared to before).
 <img src="/assets/2024-08-29-how-we-dramatically-improved-conversion-rates/2.png" alt="" /></p>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ol>

<hr />

<h1 id="4-actions">4. Actions</h1>
<blockquote>
  <ul>
    <li>Based on the identified problem, I shared it with internal stakeholders and discussed several action plans to improve the payment process.</li>
    <li>As a result of the discussions, we decided to <strong>first introduce the easy payment service, PayPal Express Checkout</strong>, to reduce the dropout rate in the payment process.</li>
    <li>This was deemed the most realistic and effective solution to streamline the payment steps and provide a convenient payment experience to users, thereby increasing conversion rates.</li>
    <li>After implementing this feature, I focused on minimizing user discomfort during the payment process and enhancing security trustworthiness, thereby improving UX.</li>
  </ul>
</blockquote>

<h3 id="internal-sharing">Internal Sharing</h3>
<ul>
  <li>I clarified the problem and shared the details with internal stakeholders, and many expressed agreement with the issue.</li>
  <li>Eventually, I held a meeting with executives and marketing team members to <strong>discuss possible action plans</strong> to address the issue.
 <img src="/assets/2024-08-29-how-we-dramatically-improved-conversion-rates/7-eng.png" alt="" /></li>
</ul>

<h3 id="limitations-of-data-analysis">Limitations of Data Analysis</h3>
<ul>
  <li>Unfortunately, the user behavior that occurred between the <code class="language-plaintext highlighter-rouge">add_payment_info</code> event and the <code class="language-plaintext highlighter-rouge">purchase</code> event could not be confirmed through the data.
    <ul>
      <li>This was because, under the plan for the e-commerce platform we were using, only basic GA4 event collection was possible as we couldnâ€™t insert GTM custom event triggers into the source code.</li>
    </ul>
  </li>
  <li>Therefore, it was not possible to explain the specific cause of this problem solely with data.</li>
  <li><strong>Therefore, moving forward, the intuitive judgment of internal stakeholders with insight into domestic and overseas markets became important.</strong></li>
</ul>

<h3 id="hypothesis-establishment">Hypothesis Establishment</h3>

<ol>
  <li>After deep discussions, the following opinions were shared:
    <ul>
      <li><strong>Hypothesis 1</strong>: â€œWe need to diversify payment methods. Potential customers might have abandoned their carts because they couldnâ€™t find their preferred payment method.â€</li>
      <li><strong>Hypothesis 2</strong>: â€œHow about adding an easy payment service? It could quickly complete the payment before the purchase intent declines.â€</li>
      <li><strong>Hypothesis 3</strong>: â€œConsider supporting cryptocurrency payment methods. Given the characteristics of our customers, it could be highly preferred.â€</li>
      <li><strong>Hypothesis 4</strong>: â€œImproving the UI of the payment gatewayâ€™s payment process might also be a good idea.â€</li>
    </ul>
  </li>
  <li>Among these, we decided to first test â€œ<strong>adding an easy payment service</strong>â€.
    <ul>
      <li>This was considered the most feasible action in terms of implementation costs, market insights, etc.</li>
    </ul>
  </li>
  <li>Final Hypothesis Establishment
    <blockquote>
      <p>â€œ<strong>Introducing the PayPal Express Checkout feature will increase the conversion rate in the payment process!</strong>â€</p>
    </blockquote>
  </li>
</ol>

<h3 id="action-implementation">Action Implementation</h3>

<ol>
  <li>
    <p><strong>PayPal Express Checkout</strong> is a feature that allows customers to quickly complete a payment using information already stored through PayPal login, without needing to individually enter their shipping address, email, contact information, or even credit card details.</p>
  </li>
  <li>In fact, our company had already offered PayPal as a payment method through the linked payment gateway, but it was suspected that this caused the following inconveniences:
    <ul>
      <li>â€œIt was only displayed as one of several options, so it might not have been easily noticeable.â€</li>
      <li>â€œAfter entering shipping, email, and contact information, prompting for PayPal login again might have been perceived as an unnecessary waste of time.â€
<img src="/assets/2024-08-29-how-we-dramatically-improved-conversion-rates/6.png" alt="" /></li>
    </ul>
  </li>
  <li>Therefore, the PayPal Express Checkout feature was considered a UX improvement method for the following reasons:
    <ul>
      <li><strong>It supports easy payments by shortening the customerâ€™s purchase conversion steps.</strong></li>
      <li><strong>It enhances trust in security by eliminating the need to enter personal information individually.</strong>
<img src="/assets/2024-08-29-how-we-dramatically-improved-conversion-rates/8.png" alt="" /></li>
    </ul>
  </li>
</ol>

<hr />

<h1 id="5-results">5. Results</h1>
<blockquote>
  <ul>
    <li>After introducing the PayPal Express Checkout feature, the dropout issue during the payment process significantly improved, and <strong>the conversion rate from <code class="language-plaintext highlighter-rouge">add_payment_info</code> to <code class="language-plaintext highlighter-rouge">purchase</code> increased by 32 percentage points compared to before.</strong></li>
    <li>This action not only restored the conversion rate to its original level by simplifying the payment process and improving the user experience but <strong>also maintained a high level to this day</strong>.</li>
    <li>This result demonstrates that diversifying payment options and introducing easy payment methods are effective strategies, showing that problem-solving based on data analysis has had a positive impact on sales performance.</li>
  </ul>
</blockquote>

<h3 id="results-1">Results</h3>

<ul>
  <li>After executing the action, <strong>the conversion rate at the point of moving from <code class="language-plaintext highlighter-rouge">add_payment_info</code> to <code class="language-plaintext highlighter-rouge">purchase</code> not only recovered to its original state but also reached a much higher level than before.</strong></li>
  <li>As of the end of August 2023, it continues to maintain a high conversion rate.
    <details>
 <summary>View Query</summary>
 <div>
        <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">WITH</span>
    <span class="n">CTE_raw</span> <span class="k">AS</span> <span class="p">(</span>
       <span class="k">SELECT</span>
          <span class="n">event_date</span><span class="p">,</span>
          <span class="n">user_pseudo_id</span><span class="p">,</span>
          <span class="n">event_name</span>
       <span class="k">FROM</span> <span class="nv">`project_id.dataset_id.events_*`</span>
       <span class="k">WHERE</span>
          <span class="n">_table_suffix</span> <span class="k">BETWEEN</span> <span class="n">FORMAT_DATE</span><span class="p">(</span><span class="s1">'%Y%m%d'</span><span class="p">,</span> <span class="s1">'START DATE'</span><span class="p">)</span> <span class="k">AND</span> <span class="n">FORMAT_DATE</span><span class="p">(</span><span class="s1">'%Y%m%d'</span><span class="p">,</span> <span class="s1">'END DATE'</span><span class="p">)</span>
    <span class="p">),</span>

    <span class="n">CTE_funnel</span> <span class="k">AS</span> <span class="p">(</span>
       <span class="k">SELECT</span>
          <span class="n">event_date</span><span class="p">,</span>
          <span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="n">user_pseudo_id</span><span class="p">)</span> <span class="k">AS</span> <span class="n">all_users_cnt</span><span class="p">,</span>
          <span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="k">CASE</span> <span class="k">WHEN</span> <span class="n">event_name</span> <span class="o">=</span> <span class="s1">'view_item'</span> <span class="k">THEN</span> <span class="n">user_pseudo_id</span> <span class="k">END</span><span class="p">)</span> <span class="k">AS</span> <span class="n">view_item_users_cnt</span><span class="p">,</span>
          <span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="k">CASE</span> <span class="k">WHEN</span> <span class="n">event_name</span> <span class="o">=</span> <span class="s1">'begin_checkout'</span> <span class="k">THEN</span> <span class="n">user_pseudo_id</span> <span class="k">END</span><span class="p">)</span> <span class="k">AS</span> <span class="n">begin_checkout_users_cnt</span><span class="p">,</span>
          <span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="k">CASE</span> <span class="k">WHEN</span> <span class="n">event_name</span> <span class="o">=</span> <span class="s1">'add_payment_info'</span> <span class="k">THEN</span> <span class="n">user_pseudo_id</span> <span class="k">END</span><span class="p">)</span> <span class="k">AS</span> <span class="n">add_payment_info_users_cnt</span><span class="p">,</span>
          <span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="k">CASE</span> <span class="k">WHEN</span> <span class="n">event_name</span> <span class="o">=</span> <span class="s1">'purchase'</span> <span class="k">THEN</span> <span class="n">user_pseudo_id</span> <span class="k">END</span><span class="p">)</span> <span class="k">AS</span> <span class="n">purchase_users_cnt</span>
       <span class="k">FROM</span>
          <span class="n">CTE_raw</span>
       <span class="k">GROUP</span> <span class="k">BY</span>
          <span class="mi">1</span>
    <span class="p">),</span>

    <span class="n">CTE_result</span> <span class="k">AS</span> <span class="p">(</span>
       <span class="k">SELECT</span>
          <span class="n">event_date</span><span class="p">,</span>
          <span class="n">SAFE_DIVIDE</span><span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="n">all_users_cnt</span><span class="p">,</span> <span class="n">all_users_cnt</span><span class="p">)</span> <span class="k">AS</span> <span class="n">all_users_cvr</span><span class="p">,</span>
          <span class="n">SAFE_DIVIDE</span><span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="n">view_item_users_cnt</span><span class="p">,</span> <span class="n">all_users_cnt</span><span class="p">)</span> <span class="k">AS</span> <span class="n">view_item_cvr</span><span class="p">,</span>
          <span class="n">SAFE_DIVIDE</span><span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="n">begin_checkout_users_cnt</span><span class="p">,</span> <span class="n">all_users_cnt</span><span class="p">)</span> <span class="k">AS</span> <span class="n">begin_checkout_cvr</span><span class="p">,</span>
          <span class="n">SAFE_DIVIDE</span><span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="n">add_payment_info_users_cnt</span><span class="p">,</span> <span class="n">all_users_cnt</span><span class="p">)</span> <span class="k">AS</span> <span class="n">add_payment_info_cvr</span><span class="p">,</span>
          <span class="n">SAFE_DIVIDE</span><span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="n">purchase_users_cnt</span><span class="p">,</span> <span class="n">all_users_cnt</span><span class="p">)</span> <span class="k">AS</span> <span class="n">purchase_cvr</span>
       <span class="k">FROM</span>
          <span class="n">CTE_funnel</span>
       <span class="k">ORDER</span> <span class="k">BY</span>
          <span class="mi">1</span>
    <span class="p">)</span>

    <span class="k">SELECT</span>
       <span class="o">*</span>
    <span class="k">FROM</span>
       <span class="n">CTE_result</span>
    <span class="k">ORDER</span> <span class="k">BY</span>
       <span class="mi">1</span>
</code></pre></div>        </div>
      </div>
 </details>
    <p><img src="/assets/2024-08-29-how-we-dramatically-improved-conversion-rates/9.png" alt="" /></p>
  </li>
</ul>

<h3 id="impact">Impact</h3>

<ul>
  <li>After implementing the action, <strong>the conversion rate at the point of moving from <code class="language-plaintext highlighter-rouge">add_payment_info</code> to <code class="language-plaintext highlighter-rouge">purchase</code> increased by 32 percentage points compared to before.</strong>
    <details>
 <summary>View Query</summary>
 <div>
        <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">WITH</span>
    <span class="n">CTE_raw</span> <span class="k">AS</span> <span class="p">(</span>
       <span class="k">SELECT</span>
          <span class="n">event_date</span><span class="p">,</span>
          <span class="n">user_pseudo_id</span><span class="p">,</span>
          <span class="n">event_name</span>
       <span class="k">FROM</span> <span class="nv">`project_id.dataset_id.events_*`</span>
       <span class="k">WHERE</span>
          <span class="n">_table_suffix</span> <span class="k">BETWEEN</span> <span class="n">FORMAT_DATE</span><span class="p">(</span><span class="s1">'%Y%m%d'</span><span class="p">,</span> <span class="s1">'START DATE'</span><span class="p">)</span> <span class="k">AND</span> <span class="n">FORMAT_DATE</span><span class="p">(</span><span class="s1">'%Y%m%d'</span><span class="p">,</span> <span class="s1">'END DATE'</span><span class="p">)</span>
    <span class="p">),</span>

    <span class="n">CTE_funnel</span> <span class="k">AS</span> <span class="p">(</span>
       <span class="k">SELECT</span>
          <span class="k">CASE</span>
                <span class="k">WHEN</span> <span class="n">event_date</span> <span class="o">&lt;=</span> <span class="s1">'YYYY-MM-DD'</span> <span class="k">THEN</span> <span class="s1">'AS-IS'</span>
                <span class="k">ELSE</span> <span class="s1">'TO-BE'</span>
          <span class="k">END</span> <span class="k">AS</span> <span class="n">period</span><span class="p">,</span>
          <span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="n">user_pseudo_id</span><span class="p">)</span> <span class="k">AS</span> <span class="n">all_users_cnt</span><span class="p">,</span>
          <span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="k">CASE</span> <span class="k">WHEN</span> <span class="n">event_name</span> <span class="o">=</span> <span class="s1">'view_item'</span> <span class="k">THEN</span> <span class="n">user_pseudo_id</span> <span class="k">END</span><span class="p">)</span> <span class="k">AS</span> <span class="n">view_item_users_cnt</span><span class="p">,</span>
          <span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="k">CASE</span> <span class="k">WHEN</span> <span class="n">event_name</span> <span class="o">=</span> <span class="s1">'begin_checkout'</span> <span class="k">THEN</span> <span class="n">user_pseudo_id</span> <span class="k">END</span><span class="p">)</span> <span class="k">AS</span> <span class="n">begin_checkout_users_cnt</span><span class="p">,</span>
          <span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="k">CASE</span> <span class="k">WHEN</span> <span class="n">event_name</span> <span class="o">=</span> <span class="s1">'add_payment_info'</span> <span class="k">THEN</span> <span class="n">user_pseudo_id</span> <span class="k">END</span><span class="p">)</span> <span class="k">AS</span> <span class="n">add_payment_info_users_cnt</span><span class="p">,</span>
          <span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="k">CASE</span> <span class="k">WHEN</span> <span class="n">event_name</span> <span class="o">=</span> <span class="s1">'purchase'</span> <span class="k">THEN</span> <span class="n">user_pseudo_id</span> <span class="k">END</span><span class="p">)</span> <span class="k">AS</span> <span class="n">purchase_users_cnt</span>
       <span class="k">FROM</span>
          <span class="n">CTE_raw</span>
       <span class="k">GROUP</span> <span class="k">BY</span>
          <span class="mi">1</span>
    <span class="p">),</span>

    <span class="n">CTE_result</span> <span class="k">AS</span> <span class="p">(</span>
       <span class="k">SELECT</span>
          <span class="n">period</span><span class="p">,</span>
          <span class="n">SAFE_DIVIDE</span><span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="n">purchase_users_cnt</span><span class="p">,</span> <span class="n">add_payment_info_users_cnt</span><span class="p">)</span> <span class="k">AS</span> <span class="n">purchase_cvr</span>
       <span class="k">FROM</span>
          <span class="n">CTE_funnel</span>
    <span class="p">)</span>

    <span class="k">SELECT</span>
       <span class="o">*</span>
    <span class="k">FROM</span>
       <span class="n">CTE_result</span>
    <span class="k">ORDER</span> <span class="k">BY</span>
       <span class="mi">1</span>
</code></pre></div>        </div>
      </div>
 </details>
    <p><img src="/assets/2024-08-29-how-we-dramatically-improved-conversion-rates/10.png" alt="" /></p>
  </li>
</ul>

<hr />

<h2 id="published-by-joshua-kim"><em>Published by</em> Joshua Kim</h2>

<p><img src="/assets/profile/joshua-profile.png" alt="Joshua Kim" /></p>]]></content><author><name></name></author><category term="Language (English)" /><category term="Article (Project)" /><category term="Level (1. Beginner)" /><category term="Field (Data Analysis)" /><category term="Skills (SQL)" /><summary type="html"><![CDATA[â€œBy analyzing the data of new visitors that increased due to external factors, I achieved a significant rise in purchase conversion rates. The data revealed a substantial increase in the number of new visitors and their purchasing intent, but also identified a high dropout rate at the payment stage. Based on the hypothesis that the inconvenience in the payment process was the main cause, I introduced PayPal Express Checkout to enhance user experience. As a result, the payment conversion rate increased by 32%p, reaching a much higher level than before, and this improvement has been sustained. This demonstrates effective problem-solving and performance enhancement based on data analysis.â€]]></summary></entry><entry><title type="html">êµ¬ë§¤ ì „í™˜ìœ¨ ê¸‰ìƒìŠ¹ í›„ê¸°</title><link href="http://localhost:4000/how-we-dramatically-improved-conversion-rates-ko/" rel="alternate" type="text/html" title="êµ¬ë§¤ ì „í™˜ìœ¨ ê¸‰ìƒìŠ¹ í›„ê¸°" /><published>2024-08-29T00:00:00+09:00</published><updated>2024-08-29T00:00:00+09:00</updated><id>http://localhost:4000/how-we-dramatically-improved-conversion-rates-ko</id><content type="html" xml:base="http://localhost:4000/how-we-dramatically-improved-conversion-rates-ko/"><![CDATA[<blockquote>
  <p>â€œì™¸ë¶€ ìš”ì¸ìœ¼ë¡œ ì¸í•´ ì¦ê°€í•œ ì‹ ê·œ ë°©ë¬¸ì ë°ì´í„°ë¥¼ ë¶„ì„í•˜ì—¬ êµ¬ë§¤ ì „í™˜ìœ¨ì˜ ê¸‰ìƒìŠ¹ì„ ë‹¬ì„±í–ˆìŠµë‹ˆë‹¤. ë°ì´í„°ë¥¼ í†µí•´ ì‹ ê·œ ë°©ë¬¸ì ìˆ˜ì™€ ì´ë“¤ì˜ êµ¬ë§¤ ì˜í–¥ì´ í¬ê²Œ ì¦ê°€í–ˆìŒì„ ë°œê²¬í–ˆì§€ë§Œ, ê²°ì œ ë‹¨ê³„ì—ì„œ ì´íƒˆë¥ ì´ ë†’ë‹¤ëŠ” ë¬¸ì œë¥¼ íŒŒì•…í–ˆìŠµë‹ˆë‹¤. ì´ì— ê²°ì œ ê³¼ì •ì˜ ë¶ˆí¸í•¨ì´ ì£¼ìš” ì›ì¸ì„ì„ ê°€ì„¤ë¡œ ì„¤ì •í•˜ê³ , PayPal Express Checkoutì„ ë„ì…í•˜ì—¬ ì‚¬ìš©ì ê²½í—˜ì„ ê°œì„ í–ˆìŠµë‹ˆë‹¤. ê·¸ ê²°ê³¼, ê²°ì œ ì „í™˜ìœ¨ì´ 32%p ìƒìŠ¹í•˜ì—¬ ì´ì „ë³´ë‹¤ í›¨ì”¬ ë†’ì€ ìˆ˜ì¤€ì„ ê¸°ë¡í–ˆìœ¼ë©°, ì´ëŠ” ì§€ì†ì ìœ¼ë¡œ ìœ ì§€ë˜ê³  ìˆìŠµë‹ˆë‹¤. ì´ë¥¼ í†µí•´ ë¶„ì„ ê¸°ë°˜ì˜ ë¬¸ì œ í•´ê²°ê³¼ ì„±ê³¼ í–¥ìƒì„ ì´ë¤„ëƒˆìŠµë‹ˆë‹¤.â€</p>
</blockquote>

<hr />

<table>
  <thead>
    <tr>
      <th><strong>Performance Summary</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>- ì „í™˜ìœ¨ (<code class="language-plaintext highlighter-rouge">add_payment_info</code> â†’ <code class="language-plaintext highlighter-rouge">purchase</code>): 32%p â†‘</td>
    </tr>
  </tbody>
</table>

<hr />

<h1 id="ëª©ì°¨">ëª©ì°¨</h1>
<ol>
  <li>STAR Summary</li>
  <li>Situation</li>
  <li>Tasks</li>
  <li>Actions</li>
  <li>Results</li>
</ol>

<hr />

<h1 id="1-star-summary">1. STAR Summary</h1>

<h3 id="situation">Situation</h3>
<ul>
  <li>2023ë…„, ê¸€ë¡œë²Œ ì‹œì¥ ì ìœ ìœ¨ 1ìœ„ì˜ ê²½ìŸì‚¬ê°€ ì‚¬ì—…ì  ë…¼ë€ì— íœ˜ë§ë¦¬ë©´ì„œ ë‹¹ì‚¬ëŠ” <strong>ì˜ˆìƒì¹˜ ëª»í•œ ë§¤ì¶œ ì¦ê°€</strong>ë¥¼ ê²½í—˜í•˜ê²Œ ë˜ì—ˆìŠµë‹ˆë‹¤.</li>
  <li>ì´ë¡œ ì¸í•´ ìì‚¬ëª°ì˜ ì‹ ê·œ ë°©ë¬¸ìê°€ ê¸‰ì¦í–ˆìœ¼ë©°, ì´ëŠ” ë‹¹ì‚¬ ë‚´ë¶€ ë§ˆì¼€íŒ… í™œë™ì˜ ê²°ê³¼ê°€ ì•„ë‹Œ ì™¸ë¶€ ì‹œì¥ ë³€í™”ì— ë”°ë¥¸ í˜„ìƒìœ¼ë¡œ íŒŒì•…ë˜ì—ˆìŠµë‹ˆë‹¤.</li>
  <li>ë°ì´í„° ë¶„ì„ê°€ë¡œì„œ ì €ëŠ” ì´ëŸ¬í•œ ë¹„ì •ìƒì ì¸ ì‹œì¥ ì›€ì§ì„ì„ ê¹Šì´ ìˆê²Œ ë¶„ì„í•˜ê¸° ìœ„í•´ ìë°œì ìœ¼ë¡œ ë°ì´í„° ëª¨ë‹ˆí„°ë§ì„ í–ˆê³ , íŠ¹íˆ <strong>ì‹ ê·œ ë°©ë¬¸ìë“¤ì˜ ìœ ì… ê²½ë¡œì™€ êµ¬ë§¤ í–‰ë™ íŒ¨í„´</strong>ì„ ì§‘ì¤‘ì ìœ¼ë¡œ ì¶”ì í–ˆìŠµë‹ˆë‹¤.</li>
</ul>

<h3 id="tasks">Tasks</h3>
<ul>
  <li>ì‹ ê·œ ë°©ë¬¸ì ìˆ˜ê°€ ê¸‰ì¦í•œ ìƒí™©ì—ì„œ <strong>ê²°ì œ í”„ë¡œì„¸ìŠ¤ì˜ ì´íƒˆë¥ ì´ ë†’ë‹¤ëŠ” ë¬¸ì œ</strong>ë¥¼ ë°œê²¬í–ˆìŠµë‹ˆë‹¤.</li>
  <li>êµ¬ì²´ì ìœ¼ë¡œ êµ¬ë§¤ í¼ë„ì˜ ê° ë‹¨ê³„ì—ì„œ ì´íƒˆ ì§€ì ì„ ë¶„ì„í•œ ê²°ê³¼, ë§ì€ ê³ ê°ë“¤ì´ <strong>êµ¬ë§¤ ì •ë³´ë¥¼ ì…ë ¥í•œ í›„ ê²°ì œ ë‹¨ê³„ì—ì„œ ì´íƒˆ</strong>í•˜ëŠ” ê²ƒìœ¼ë¡œ ë‚˜íƒ€ë‚¬ìŠµë‹ˆë‹¤.</li>
  <li>íŠ¹íˆ, <strong>ê²°ì œ ê³¼ì •ì—ì„œì˜ UX</strong>ê°€ êµ¬ë§¤ ì „í™˜ì— í° ì˜í–¥ì„ ë¯¸ì¹œë‹¤ëŠ” ì ì„ ì¸ì§€í•˜ê³ , ë¬¸ì œë¥¼ ëª…í™•íˆ í•˜ì—¬ ì‚¬ìš©ì ê²½í—˜ì„ ê°œì„ í•  í•„ìš”ê°€ ìˆì—ˆìŠµë‹ˆë‹¤.</li>
  <li>ë˜í•œ, ì´ë²ˆ ì „í™˜ìœ¨ ì €í•˜ëŠ” ì™¸ë¶€ ìš”ì¸ì— ì˜í•œ ìì—°ì  ìœ ì… ì‚¬ìš©ì ì¦ê°€ì™€ ì„¸ê·¸ë¨¼íŠ¸ ë³€í™”ì™€ ê´€ë ¨ì´ ìˆì„ ê²ƒìœ¼ë¡œ íŒë‹¨í–ˆìŠµë‹ˆë‹¤.</li>
</ul>

<h3 id="actions">Actions</h3>
<ul>
  <li>ë°œê²¬ëœ ë¬¸ì œë¥¼ ë°”íƒ•ìœ¼ë¡œ ê²°ì œ í”„ë¡œì„¸ìŠ¤ ê°œì„ ì„ ìœ„í•´ ì‚¬ë‚´ êµ¬ì„±ì›ë“¤ê³¼ ë¬¸ì œë¥¼ ê³µìœ í•˜ê³ , ì—¬ëŸ¬ ê°€ì§€ ì•¡ì…˜ í”Œëœì„ ë…¼ì˜í–ˆìŠµë‹ˆë‹¤.</li>
  <li>ë…¼ì˜ ê²°ê³¼, ê²°ì œ í”„ë¡œì„¸ìŠ¤ì—ì„œì˜ ì´íƒˆë¥ ì„ ë‚®ì¶”ê¸° ìœ„í•´ ìš°ì„ ì ìœ¼ë¡œ <strong>ê°„í¸ ê²°ì œ ì„œë¹„ìŠ¤ì¸ PayPal Express Checkout ê¸°ëŠ¥ì„ ë„ì…</strong>í•˜ê¸°ë¡œ ê²°ì •í–ˆìŠµë‹ˆë‹¤.</li>
  <li>ì´ëŠ” ê²°ì œ ë‹¨ê³„ë¥¼ ë‹¨ì¶•í•˜ê³  ì‚¬ìš©ìì—ê²Œ í¸ë¦¬í•œ ê²°ì œ ê²½í—˜ì„ ì œê³µí•˜ì—¬ ì „í™˜ìœ¨ì„ ë†’ì¼ ìˆ˜ ìˆëŠ” ê°€ì¥ í˜„ì‹¤ì ì´ê³  íš¨ìœ¨ì ì¸ ë°©ì•ˆìœ¼ë¡œ íŒë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.</li>
  <li>ì´í›„ í•´ë‹¹ ê¸°ëŠ¥ì„ ì ìš©í•˜ì—¬ ì‚¬ìš©ìì˜ ê²°ì œ ê³¼ì •ì—ì„œ ë¶ˆí¸í•¨ì„ ìµœì†Œí™”í•˜ê³  ë³´ì•ˆ ì‹ ë¢°ë„ë¥¼ ë†’ì´ëŠ” ë“± UX ê°œì„ ì„ ì¶”ì§„í–ˆìŠµë‹ˆë‹¤.</li>
</ul>

<h3 id="results">Results</h3>
<ul>
  <li>PayPal Express Checkout ê¸°ëŠ¥ ë„ì… í›„, ê²°ì œ ê³¼ì •ì—ì„œ ì´íƒˆí•˜ë˜ ë¬¸ì œê°€ í¬ê²Œ ê°œì„ ë˜ì–´ <strong><code class="language-plaintext highlighter-rouge">add_payment_info</code>ì—ì„œ <code class="language-plaintext highlighter-rouge">purchase</code>ë¡œ ë„˜ì–´ê°€ëŠ” ì „í™˜ìœ¨ì´ ì´ì „ë³´ë‹¤ 32%p ìƒìŠ¹</strong>í–ˆìŠµë‹ˆë‹¤.</li>
  <li>ì´ ì¡°ì¹˜ëŠ” ê²°ì œ í”„ë¡œì„¸ìŠ¤ë¥¼ ê°„ì†Œí™”í•˜ê³  ì‚¬ìš©ì ê²½í—˜ì„ í–¥ìƒì‹œì¼œ ì „í™˜ìœ¨ì„ ì›ìƒíƒœë¡œ íšŒë³µì‹œì¼°ì„ ë¿ë§Œ ì•„ë‹ˆë¼, <strong>í˜„ì¬ê¹Œì§€ë„ ë†’ì€ ìˆ˜ì¤€ì„ ìœ ì§€</strong>í•˜ê³  ìˆìŠµë‹ˆë‹¤.</li>
  <li>ì´ ê²°ê³¼ëŠ” ê²°ì œ ì˜µì…˜ì˜ ë‹¤ì–‘í™”ì™€ ê°„í¸ ê²°ì œ ë„ì…ì´ íš¨ê³¼ì ì¸ ì „ëµì„ì„ ì…ì¦í•˜ë©°, ë¶„ì„ì„ ë°”íƒ•ìœ¼ë¡œ í•œ ë¬¸ì œ í•´ê²°ì´ ë§¤ì¶œ ì„±ê³¼ì— ê¸ì •ì ì¸ ì˜í–¥ì„ ë¯¸ì³¤ìŠµë‹ˆë‹¤.</li>
</ul>

<hr />

<h1 id="2-situation">2. Situation</h1>
<blockquote>
  <ul>
    <li>2023ë…„, ê¸€ë¡œë²Œ ì‹œì¥ ì ìœ ìœ¨ 1ìœ„ì˜ ê²½ìŸì‚¬ê°€ ì‚¬ì—…ì  ë…¼ë€ì— íœ˜ë§ë¦¬ë©´ì„œ ë‹¹ì‚¬ëŠ” <strong>ì˜ˆìƒì¹˜ ëª»í•œ ë§¤ì¶œ ì¦ê°€</strong>ë¥¼ ê²½í—˜í•˜ê²Œ ë˜ì—ˆìŠµë‹ˆë‹¤.</li>
    <li>ì´ë¡œ ì¸í•´ ìì‚¬ëª°ì˜ ì‹ ê·œ ë°©ë¬¸ìê°€ ê¸‰ì¦í–ˆìœ¼ë©°, ì´ëŠ” ë‹¹ì‚¬ ë‚´ë¶€ ë§ˆì¼€íŒ… í™œë™ì˜ ê²°ê³¼ê°€ ì•„ë‹Œ ì™¸ë¶€ ì‹œì¥ ë³€í™”ì— ë”°ë¥¸ í˜„ìƒìœ¼ë¡œ íŒŒì•…ë˜ì—ˆìŠµë‹ˆë‹¤.</li>
    <li>ë°ì´í„° ë¶„ì„ê°€ë¡œì„œ ì €ëŠ” ì´ëŸ¬í•œ ë¹„ì •ìƒì ì¸ ì‹œì¥ ì›€ì§ì„ì„ ê¹Šì´ ìˆê²Œ ë¶„ì„í•˜ê¸° ìœ„í•´ ìë°œì ìœ¼ë¡œ ë°ì´í„° ëª¨ë‹ˆí„°ë§ì„ í–ˆê³ , íŠ¹íˆ <strong>ì‹ ê·œ ë°©ë¬¸ìë“¤ì˜ ìœ ì… ê²½ë¡œì™€ êµ¬ë§¤ í–‰ë™ íŒ¨í„´</strong>ì„ ì§‘ì¤‘ì ìœ¼ë¡œ ì¶”ì í–ˆìŠµë‹ˆë‹¤.</li>
  </ul>
</blockquote>

<h3 id="êµ¬ì²´ì ì¸-ìƒí™©">êµ¬ì²´ì ì¸ ìƒí™©</h3>
<ul>
  <li>2023ë…„, ê¸€ë¡œë²Œ ì‹œì¥ ì ìœ ìœ¨ TOP1ì¸ ëª¨ ê²½ìŸì‚¬ê°€ ì‚¬ì—…ì  ë…¼ë€ì— í¬ê²Œ íœ©ì‹¸ì´ë©´ì„œ ë‹¹ì‚¬ê°€ ë°˜ì‚¬ì´ìµ ìˆ˜í˜œë¥¼ ì…ì–´ ìì‚¬ëª° ë§¤ì¶œì´ ê¸‰ì¦í•˜ê³  ìˆì—ˆìŠµë‹ˆë‹¤. ì´ëŠ” ë‚´ë¶€ì ì¸ ë§ˆì¼€íŒ… í™œë™ì˜ ê²°ê³¼ê°€ ì•„ë‹Œ, ì‹œì¥ ìì²´ì˜ ì™¸ë¶€ ì˜í–¥ ë•ë¶„ì´ì—ˆìŠµë‹ˆë‹¤.</li>
  <li>ë°ì´í„° ë¶„ì„ê°€ì˜€ë˜ ì € ì—­ì‹œ â€œ<strong>í”ì¹˜ ì•Šì€ ì‹œì¥ì˜ íë¦„ìœ¼ë¡œ ì¸í•œ ì´ìƒ í˜„ìƒ</strong>â€œì„ ê¹Šì´ ëª¨ë‹ˆí„°ë§í•´ë³´ê³  ì‹¶ì–´ ìë°œì ìœ¼ë¡œ í•¨ê»˜ ë°ì´í„°ë¥¼ íŒ”ë¡œì—…í–ˆìŠµë‹ˆë‹¤.</li>
</ul>

<h3 id="ë°ì´í„°-íŒ”ë¡œì—…">ë°ì´í„° íŒ”ë¡œì—…</h3>

<ol>
  <li>ì‹ ê·œ ë°©ë¬¸ì ìˆ˜ê°€ ê¸‰ì¦í–ˆìŠµë‹ˆë‹¤.
    <details>
<summary>View Query</summary>
<div>
        <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   <span class="k">WITH</span>
   <span class="n">CTE_raw</span> <span class="k">AS</span> <span class="p">(</span>
      <span class="k">SELECT</span>
         <span class="n">event_date</span><span class="p">,</span>
         <span class="n">user_pseudo_id</span><span class="p">,</span>
         <span class="p">(</span><span class="k">SELECT</span> <span class="n">value</span><span class="p">.</span><span class="n">int_value</span> <span class="k">FROM</span> <span class="k">UNNEST</span> <span class="p">(</span><span class="n">event_params</span><span class="p">)</span> <span class="k">WHERE</span> <span class="k">key</span> <span class="o">=</span> <span class="s1">'ga_session_number'</span><span class="p">)</span> <span class="k">AS</span> <span class="n">ga_session_number</span>
      <span class="k">FROM</span> <span class="nv">`project_id.dataset_id.events_*`</span>
      <span class="k">WHERE</span>
         <span class="n">_table_suffix</span> <span class="k">BETWEEN</span> <span class="n">FORMAT_DATE</span><span class="p">(</span><span class="s1">'%Y%m%d'</span><span class="p">,</span> <span class="s1">'START DATE'</span><span class="p">)</span> <span class="k">AND</span> <span class="n">FORMAT_DATE</span><span class="p">(</span><span class="s1">'%Y%m%d'</span><span class="p">,</span> <span class="s1">'END DATE'</span><span class="p">)</span>
   <span class="p">),</span>

   <span class="n">CTE_users_min_gsn</span> <span class="k">AS</span> <span class="p">(</span>
      <span class="k">SELECT</span>
         <span class="n">event_date</span><span class="p">,</span>
         <span class="n">user_pseudo_id</span><span class="p">,</span>
         <span class="k">MIN</span><span class="p">(</span><span class="n">ga_session_number</span><span class="p">)</span> <span class="k">AS</span> <span class="n">min_gsn</span>
      <span class="k">FROM</span>
         <span class="n">CTE_raw</span>
      <span class="k">GROUP</span> <span class="k">BY</span>
         <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span>
   <span class="p">)</span>

   <span class="k">SELECT</span>
      <span class="n">event_date</span><span class="p">,</span>
      <span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="n">user_pseudo_id</span><span class="p">)</span> <span class="k">AS</span> <span class="n">users_cnt</span>
   <span class="k">FROM</span>
      <span class="n">CTE_users_min_gsn</span>
   <span class="k">WHERE</span>
      <span class="n">min_gsn</span> <span class="o">=</span> <span class="mi">1</span>
   <span class="k">GROUP</span> <span class="k">BY</span>
      <span class="mi">1</span>
   <span class="k">ORDER</span> <span class="k">BY</span>
      <span class="mi">1</span>
</code></pre></div>        </div>
      </div>
</details>
    <p><img src="/assets/2024-08-29-how-we-dramatically-improved-conversion-rates/1.png" alt="" /></p>
  </li>
  <li>ì´ë“¤ì€ ì£¼ë¡œ ë¯¸êµ­ê³¼ Organic íŠ¸ë˜í”½ì„ í†µí•´ ìœ ì…ë˜ì—ˆìŠµë‹ˆë‹¤.
    <ul>
      <li>ì‹ ê·œ ë°©ë¬¸ì ìˆ˜ (êµ­ê°€ë³„ ë¶„ë¥˜)
        <details>
 <summary>View Query</summary>
 <div>
            <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="k">WITH</span>
 <span class="n">CTE_raw</span> <span class="k">AS</span> <span class="p">(</span>
    <span class="k">SELECT</span>
       <span class="n">event_date</span><span class="p">,</span>
       <span class="n">user_pseudo_id</span><span class="p">,</span>
       <span class="p">(</span><span class="k">SELECT</span> <span class="n">value</span><span class="p">.</span><span class="n">int_value</span> <span class="k">FROM</span> <span class="k">UNNEST</span> <span class="p">(</span><span class="n">event_params</span><span class="p">)</span> <span class="k">WHERE</span> <span class="k">key</span> <span class="o">=</span> <span class="s1">'ga_session_number'</span><span class="p">)</span> <span class="k">AS</span> <span class="n">ga_session_number</span><span class="p">,</span>
       <span class="n">geo</span><span class="p">.</span><span class="n">country</span>
    <span class="k">FROM</span> <span class="nv">`project_id.dataset_id.events_*`</span>
    <span class="k">WHERE</span>
       <span class="n">_table_suffix</span> <span class="k">BETWEEN</span> <span class="n">FORMAT_DATE</span><span class="p">(</span><span class="s1">'%Y%m%d'</span><span class="p">,</span> <span class="s1">'START DATE'</span><span class="p">)</span> <span class="k">AND</span> <span class="n">FORMAT_DATE</span><span class="p">(</span><span class="s1">'%Y%m%d'</span><span class="p">,</span> <span class="s1">'END DATE'</span><span class="p">)</span>
 <span class="p">),</span>

 <span class="n">CTE_users_min_gsn</span> <span class="k">AS</span> <span class="p">(</span>
    <span class="k">SELECT</span>
       <span class="n">event_date</span><span class="p">,</span>
       <span class="n">user_pseudo_id</span><span class="p">,</span>
       <span class="n">country</span><span class="p">,</span>
       <span class="k">MIN</span><span class="p">(</span><span class="n">ga_session_number</span><span class="p">)</span> <span class="k">AS</span> <span class="n">min_gsn</span>
    <span class="k">FROM</span>
       <span class="n">CTE_raw</span>
    <span class="k">GROUP</span> <span class="k">BY</span>
       <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span>
 <span class="p">),</span>

 <span class="n">CTE_top20_countries</span> <span class="k">AS</span> <span class="p">(</span>
    <span class="k">SELECT</span>
       <span class="n">country</span><span class="p">,</span>
       <span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="n">user_pseudo_id</span><span class="p">)</span> <span class="k">AS</span> <span class="n">users_cnt</span>
    <span class="k">FROM</span>
       <span class="n">CTE_users_min_gsn</span>
    <span class="k">WHERE</span>
       <span class="n">min_gsn</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">GROUP</span> <span class="k">BY</span>
       <span class="mi">1</span>
    <span class="k">ORDER</span> <span class="k">BY</span>
       <span class="mi">2</span> <span class="k">DESC</span>
    <span class="k">LIMIT</span>
       <span class="mi">20</span>
 <span class="p">),</span>

 <span class="n">CTE_result</span> <span class="k">AS</span> <span class="p">(</span>
    <span class="k">SELECT</span>
       <span class="n">event_date</span><span class="p">,</span>
       <span class="k">CASE</span>
             <span class="k">WHEN</span> <span class="n">country</span> <span class="k">IN</span> <span class="p">(</span><span class="k">SELECT</span> <span class="n">country</span> <span class="k">FROM</span> <span class="n">CTE_top20_countries</span><span class="p">)</span> <span class="k">THEN</span> <span class="n">country</span>
             <span class="k">ELSE</span> <span class="s1">'(Others)'</span>
       <span class="k">END</span> <span class="k">AS</span> <span class="n">country</span><span class="p">,</span>
       <span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="n">user_pseudo_id</span><span class="p">)</span> <span class="k">AS</span> <span class="n">users_cnt</span>
    <span class="k">FROM</span>
       <span class="n">CTE_users_min_gsn</span>
    <span class="k">WHERE</span>
       <span class="n">min_gsn</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">GROUP</span> <span class="k">BY</span>
       <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span>
 <span class="p">)</span>

 <span class="k">SELECT</span>
    <span class="o">*</span>
 <span class="k">FROM</span>
    <span class="n">CTE_result</span>
 <span class="k">ORDER</span> <span class="k">BY</span>
    <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span> <span class="k">DESC</span>
</code></pre></div>            </div>
          </div>
 </details>
        <p><img src="/assets/2024-08-29-how-we-dramatically-improved-conversion-rates/3.png" alt="" /></p>
      </li>
      <li>ì‹ ê·œ ë°©ë¬¸ì ìˆ˜ (First UTM Parametersë³„ ë¶„ë¥˜)
        <details>
 <summary>View Query</summary>
 <div>
            <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="k">WITH</span>
 <span class="n">CTE_raw</span> <span class="k">AS</span> <span class="p">(</span>
    <span class="k">SELECT</span>
       <span class="n">event_date</span><span class="p">,</span>
       <span class="n">user_pseudo_id</span><span class="p">,</span>
       <span class="p">(</span><span class="k">SELECT</span> <span class="n">value</span><span class="p">.</span><span class="n">int_value</span> <span class="k">FROM</span> <span class="k">UNNEST</span> <span class="p">(</span><span class="n">event_params</span><span class="p">)</span> <span class="k">WHERE</span> <span class="k">key</span> <span class="o">=</span> <span class="s1">'ga_session_number'</span><span class="p">)</span> <span class="k">AS</span> <span class="n">ga_session_number</span><span class="p">,</span>
       <span class="n">traffic_source</span><span class="p">.</span><span class="n">name</span> <span class="k">AS</span> <span class="n">first_campaign</span><span class="p">,</span>
       <span class="n">traffic_source</span><span class="p">.</span><span class="n">medium</span> <span class="k">AS</span> <span class="n">first_medium</span><span class="p">,</span>
       <span class="n">traffic_source</span><span class="p">.</span><span class="k">source</span> <span class="k">AS</span> <span class="n">first_source</span>
    <span class="k">FROM</span> <span class="nv">`project_id.dataset_id.events_*`</span>
    <span class="k">WHERE</span>
       <span class="n">_table_suffix</span> <span class="k">BETWEEN</span> <span class="n">FORMAT_DATE</span><span class="p">(</span><span class="s1">'%Y%m%d'</span><span class="p">,</span> <span class="s1">'START DATE'</span><span class="p">)</span> <span class="k">AND</span> <span class="n">FORMAT_DATE</span><span class="p">(</span><span class="s1">'%Y%m%d'</span><span class="p">,</span> <span class="s1">'END DATE'</span><span class="p">)</span>
 <span class="p">),</span>

 <span class="n">CTE_users_min_gsn</span> <span class="k">AS</span> <span class="p">(</span>
    <span class="k">SELECT</span>
       <span class="n">event_date</span><span class="p">,</span>
       <span class="n">user_pseudo_id</span><span class="p">,</span>
       <span class="n">first_campaign</span><span class="p">,</span>
       <span class="n">first_medium</span><span class="p">,</span>
       <span class="n">first_source</span><span class="p">,</span>
       <span class="k">MIN</span><span class="p">(</span><span class="n">ga_session_number</span><span class="p">)</span> <span class="k">AS</span> <span class="n">min_gsn</span>
    <span class="k">FROM</span>
       <span class="n">CTE_raw</span>
    <span class="k">GROUP</span> <span class="k">BY</span>
       <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span>
 <span class="p">),</span>

 <span class="n">CTE_top20_utms</span> <span class="k">AS</span> <span class="p">(</span>
    <span class="k">SELECT</span>
       <span class="n">COALESCE</span><span class="p">(</span><span class="n">first_campaign</span><span class="p">,</span> <span class="s1">'(Unknown)'</span><span class="p">)</span> <span class="o">||</span> <span class="s1">' &gt; '</span> <span class="o">||</span> <span class="n">COALESCE</span><span class="p">(</span><span class="n">first_medium</span><span class="p">,</span> <span class="s1">'(Unknown)'</span><span class="p">)</span> <span class="o">||</span> <span class="s1">' &gt; '</span> <span class="o">||</span> <span class="n">COALESCE</span><span class="p">(</span><span class="n">first_source</span><span class="p">,</span> <span class="s1">'(Unknown)'</span><span class="p">)</span> <span class="k">AS</span> <span class="n">utm</span><span class="p">,</span>
       <span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="n">user_pseudo_id</span><span class="p">)</span> <span class="k">AS</span> <span class="n">users_cnt</span>
    <span class="k">FROM</span>
       <span class="n">CTE_users_min_gsn</span>
    <span class="k">WHERE</span>
       <span class="n">min_gsn</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">GROUP</span> <span class="k">BY</span>
       <span class="mi">1</span>
    <span class="k">ORDER</span> <span class="k">BY</span>
       <span class="mi">2</span> <span class="k">DESC</span>
    <span class="k">LIMIT</span>
       <span class="mi">20</span>
 <span class="p">),</span>

 <span class="n">CTE_result</span> <span class="k">AS</span> <span class="p">(</span>
    <span class="k">SELECT</span>
       <span class="n">event_date</span><span class="p">,</span>
       <span class="k">CASE</span>
             <span class="k">WHEN</span> <span class="n">COALESCE</span><span class="p">(</span><span class="n">first_campaign</span><span class="p">,</span> <span class="s1">'(Unknown)'</span><span class="p">)</span> <span class="o">||</span> <span class="s1">' &gt; '</span> <span class="o">||</span> <span class="n">COALESCE</span><span class="p">(</span><span class="n">first_medium</span><span class="p">,</span> <span class="s1">'(Unknown)'</span><span class="p">)</span> <span class="o">||</span> <span class="s1">' &gt; '</span> <span class="o">||</span> <span class="n">COALESCE</span><span class="p">(</span><span class="n">first_source</span><span class="p">,</span> <span class="s1">'(Unknown)'</span><span class="p">)</span> <span class="k">IN</span> <span class="p">(</span><span class="k">SELECT</span> <span class="n">utm</span> <span class="k">FROM</span> <span class="n">CTE_top20_utms</span><span class="p">)</span> <span class="k">THEN</span> <span class="n">COALESCE</span><span class="p">(</span><span class="n">first_campaign</span><span class="p">,</span> <span class="s1">'(Unknown)'</span><span class="p">)</span> <span class="o">||</span> <span class="s1">' &gt; '</span> <span class="o">||</span> <span class="n">COALESCE</span><span class="p">(</span><span class="n">first_medium</span><span class="p">,</span> <span class="s1">'(Unknown)'</span><span class="p">)</span> <span class="o">||</span> <span class="s1">' &gt; '</span> <span class="o">||</span> <span class="n">COALESCE</span><span class="p">(</span><span class="n">first_source</span><span class="p">,</span> <span class="s1">'(Unknown)'</span><span class="p">)</span>
             <span class="k">ELSE</span> <span class="s1">'(Others)'</span>
       <span class="k">END</span> <span class="k">AS</span> <span class="n">utm</span><span class="p">,</span>
       <span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="n">user_pseudo_id</span><span class="p">)</span> <span class="k">AS</span> <span class="n">users_cnt</span>
    <span class="k">FROM</span>
       <span class="n">CTE_users_min_gsn</span>
    <span class="k">WHERE</span>
       <span class="n">min_gsn</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">GROUP</span> <span class="k">BY</span>
       <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span>
 <span class="p">)</span>

 <span class="k">SELECT</span>
    <span class="o">*</span>
 <span class="k">FROM</span>
    <span class="n">CTE_result</span>
 <span class="k">ORDER</span> <span class="k">BY</span>
    <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span> <span class="k">DESC</span>
</code></pre></div>            </div>
          </div>
 </details>
        <p><img src="/assets/2024-08-29-how-we-dramatically-improved-conversion-rates/4.png" alt="" /></p>
      </li>
    </ul>
  </li>
  <li>ì‹ ê·œ ë°©ë¬¸ìë“¤ì˜ êµ¬ë§¤ ì˜í–¥ì€ ê³¼ê±°ì— ë¹„í•´ ë§¤ìš° ë†’ì€ í¸ì´ì—ˆìŠµë‹ˆë‹¤.
    <details>
<summary>View Query</summary>
<div>
        <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   <span class="k">WITH</span>
   <span class="n">CTE_raw</span> <span class="k">AS</span> <span class="p">(</span>
      <span class="k">SELECT</span>
         <span class="n">event_date</span><span class="p">,</span>
         <span class="n">user_pseudo_id</span><span class="p">,</span>
         <span class="p">(</span><span class="k">SELECT</span> <span class="n">value</span><span class="p">.</span><span class="n">int_value</span> <span class="k">FROM</span> <span class="k">UNNEST</span> <span class="p">(</span><span class="n">event_params</span><span class="p">)</span> <span class="k">WHERE</span> <span class="k">key</span> <span class="o">=</span> <span class="s1">'ga_session_number'</span><span class="p">)</span> <span class="k">AS</span> <span class="n">ga_session_number</span><span class="p">,</span>
         <span class="n">event_name</span>
      <span class="k">FROM</span> <span class="nv">`project_id.dataset_id.events_*`</span>
      <span class="k">WHERE</span>
         <span class="n">_table_suffix</span> <span class="k">BETWEEN</span> <span class="n">FORMAT_DATE</span><span class="p">(</span><span class="s1">'%Y%m%d'</span><span class="p">,</span> <span class="s1">'START DATE'</span><span class="p">)</span> <span class="k">AND</span> <span class="n">FORMAT_DATE</span><span class="p">(</span><span class="s1">'%Y%m%d'</span><span class="p">,</span> <span class="s1">'END DATE'</span><span class="p">)</span>
   <span class="p">),</span>

<span class="n">CTE_users</span> <span class="k">AS</span> <span class="p">(</span>
   <span class="k">SELECT</span>
      <span class="n">event_date</span><span class="p">,</span>
      <span class="n">user_pseudo_id</span><span class="p">,</span>
      <span class="n">event_name</span><span class="p">,</span>
      <span class="k">MIN</span><span class="p">(</span><span class="n">ga_session_number</span><span class="p">)</span> <span class="k">AS</span> <span class="n">min_gsn</span>
   <span class="k">FROM</span>
      <span class="n">CTE_raw</span>
   <span class="k">GROUP</span> <span class="k">BY</span>
      <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span>
<span class="p">),</span>

<span class="n">CTE_new_users</span> <span class="k">AS</span> <span class="p">(</span>
   <span class="k">SELECT</span>
      <span class="n">event_date</span><span class="p">,</span>
      <span class="n">user_pseudo_id</span>
   <span class="k">FROM</span>
      <span class="n">CTE_users</span>
   <span class="k">WHERE</span>
      <span class="n">min_gsn</span> <span class="o">=</span> <span class="mi">1</span>
<span class="p">)</span>

<span class="k">SELECT</span>
   <span class="n">U</span><span class="p">.</span><span class="n">event_date</span><span class="p">,</span>
   <span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="n">NU</span><span class="p">.</span><span class="n">user_pseudo_id</span><span class="p">)</span> <span class="k">AS</span> <span class="n">new_users_cnt</span><span class="p">,</span>
   <span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="k">CASE</span> <span class="k">WHEN</span> <span class="n">U</span><span class="p">.</span><span class="n">event_name</span> <span class="o">=</span> <span class="s1">'view_item'</span> <span class="k">THEN</span> <span class="n">NU</span><span class="p">.</span><span class="n">user_pseudo_id</span> <span class="k">END</span><span class="p">)</span> <span class="k">AS</span> <span class="n">new_users_cnt_view_item</span><span class="p">,</span>
   <span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="k">CASE</span> <span class="k">WHEN</span> <span class="n">U</span><span class="p">.</span><span class="n">event_name</span> <span class="o">=</span> <span class="s1">'begin_checkout'</span> <span class="k">THEN</span> <span class="n">NU</span><span class="p">.</span><span class="n">user_pseudo_id</span> <span class="k">END</span><span class="p">)</span> <span class="k">AS</span> <span class="n">new_users_cnt_begin_checkout</span>    
<span class="k">FROM</span>
   <span class="n">CTE_users</span> <span class="n">U</span>
<span class="k">LEFT</span> <span class="k">JOIN</span> 
   <span class="n">CTE_new_users</span> <span class="n">NU</span>
   <span class="k">ON</span> <span class="n">U</span><span class="p">.</span><span class="n">event_date</span> <span class="o">=</span> <span class="n">NU</span><span class="p">.</span><span class="n">event_date</span>
   <span class="k">AND</span> <span class="n">U</span><span class="p">.</span><span class="n">user_pseudo_id</span> <span class="o">=</span> <span class="n">NU</span><span class="p">.</span><span class="n">user_pseudo_id</span>
<span class="k">GROUP</span> <span class="k">BY</span>
   <span class="mi">1</span>
<span class="k">ORDER</span> <span class="k">BY</span>
   <span class="mi">1</span>
</code></pre></div>        </div>
      </div>
</details>
    <p><img src="/assets/2024-08-29-how-we-dramatically-improved-conversion-rates/2.png" alt="" /></p>
  </li>
</ol>

<h3 id="ë¬¸ì œ-ë°œê²¬">ë¬¸ì œ ë°œê²¬</h3>

<ol>
  <li>ê·¸ëŸ¬ë‚˜, ë°°ì†¡ì§€+ì´ë©”ì¼+ì—°ë½ì²˜ ë“± êµ¬ë§¤ ê´€ë ¨ ì •ë³´ ì…ë ¥ì„ ì™„ë£Œí•œ í›„ ê²°ì œ í”„ë¡œì„¸ìŠ¤ ìƒì—ì„œì˜ ì´íƒˆë¥ ì´ ê¸‰ê²©íˆ ë†’ì•„ì¡ŒìŠµë‹ˆë‹¤.
    <details>
<summary>View Query</summary>
<div>
        <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   <span class="k">WITH</span>
   <span class="n">CTE_raw</span> <span class="k">AS</span> <span class="p">(</span>
      <span class="k">SELECT</span>
         <span class="n">event_date</span><span class="p">,</span>
         <span class="n">user_pseudo_id</span><span class="p">,</span>
         <span class="n">event_name</span>
      <span class="k">FROM</span> <span class="nv">`project_id.dataset_id.events_*`</span>
      <span class="k">WHERE</span>
         <span class="n">_table_suffix</span> <span class="k">BETWEEN</span> <span class="n">FORMAT_DATE</span><span class="p">(</span><span class="s1">'%Y%m%d'</span><span class="p">,</span> <span class="s1">'START DATE'</span><span class="p">)</span> <span class="k">AND</span> <span class="n">FORMAT_DATE</span><span class="p">(</span><span class="s1">'%Y%m%d'</span><span class="p">,</span> <span class="s1">'END DATE'</span><span class="p">)</span>
   <span class="p">),</span>

   <span class="n">CTE_funnel</span> <span class="k">AS</span> <span class="p">(</span>
      <span class="k">SELECT</span>
         <span class="n">event_date</span><span class="p">,</span>
         <span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="n">user_pseudo_id</span><span class="p">)</span> <span class="k">AS</span> <span class="n">all_users_cnt</span><span class="p">,</span>
         <span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="k">CASE</span> <span class="k">WHEN</span> <span class="n">event_name</span> <span class="o">=</span> <span class="s1">'view_item'</span> <span class="k">THEN</span> <span class="n">user_pseudo_id</span> <span class="k">END</span><span class="p">)</span> <span class="k">AS</span> <span class="n">view_item_users_cnt</span><span class="p">,</span>
         <span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="k">CASE</span> <span class="k">WHEN</span> <span class="n">event_name</span> <span class="o">=</span> <span class="s1">'begin_checkout'</span> <span class="k">THEN</span> <span class="n">user_pseudo_id</span> <span class="k">END</span><span class="p">)</span> <span class="k">AS</span> <span class="n">begin_checkout_users_cnt</span><span class="p">,</span>
         <span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="k">CASE</span> <span class="k">WHEN</span> <span class="n">event_name</span> <span class="o">=</span> <span class="s1">'add_payment_info'</span> <span class="k">THEN</span> <span class="n">user_pseudo_id</span> <span class="k">END</span><span class="p">)</span> <span class="k">AS</span> <span class="n">add_payment_info_users_cnt</span><span class="p">,</span>
         <span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="k">CASE</span> <span class="k">WHEN</span> <span class="n">event_name</span> <span class="o">=</span> <span class="s1">'purchase'</span> <span class="k">THEN</span> <span class="n">user_pseudo_id</span> <span class="k">END</span><span class="p">)</span> <span class="k">AS</span> <span class="n">purchase_users_cnt</span>
      <span class="k">FROM</span>
         <span class="n">CTE_raw</span>
      <span class="k">GROUP</span> <span class="k">BY</span>
         <span class="mi">1</span>
   <span class="p">),</span>

   <span class="n">CTE_result</span> <span class="k">AS</span> <span class="p">(</span>
      <span class="k">SELECT</span>
         <span class="n">event_date</span><span class="p">,</span>
         <span class="n">SAFE_DIVIDE</span><span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="n">all_users_cnt</span><span class="p">,</span> <span class="n">all_users_cnt</span><span class="p">)</span> <span class="k">AS</span> <span class="n">all_users_cvr</span><span class="p">,</span>
         <span class="n">SAFE_DIVIDE</span><span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="n">view_item_users_cnt</span><span class="p">,</span> <span class="n">all_users_cnt</span><span class="p">)</span> <span class="k">AS</span> <span class="n">view_item_cvr</span><span class="p">,</span>
         <span class="n">SAFE_DIVIDE</span><span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="n">begin_checkout_users_cnt</span><span class="p">,</span> <span class="n">all_users_cnt</span><span class="p">)</span> <span class="k">AS</span> <span class="n">begin_checkout_cvr</span><span class="p">,</span>
         <span class="n">SAFE_DIVIDE</span><span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="n">add_payment_info_users_cnt</span><span class="p">,</span> <span class="n">all_users_cnt</span><span class="p">)</span> <span class="k">AS</span> <span class="n">add_payment_info_cvr</span><span class="p">,</span>
         <span class="n">SAFE_DIVIDE</span><span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="n">purchase_users_cnt</span><span class="p">,</span> <span class="n">all_users_cnt</span><span class="p">)</span> <span class="k">AS</span> <span class="n">purchase_cvr</span>
      <span class="k">FROM</span>
         <span class="n">CTE_funnel</span>
      <span class="k">ORDER</span> <span class="k">BY</span>
         <span class="mi">1</span>
   <span class="p">)</span>

   <span class="k">SELECT</span>
      <span class="o">*</span>
   <span class="k">FROM</span>
      <span class="n">CTE_result</span>
   <span class="k">ORDER</span> <span class="k">BY</span>
      <span class="mi">1</span>
</code></pre></div>        </div>
      </div>
</details>
    <p><img src="/assets/2024-08-29-how-we-dramatically-improved-conversion-rates/5.png" alt="" /></p>

    <ul>
      <li>êµ¬ë§¤ ì „í™˜ ë‹¨ê³„ì˜ ì£¼ìš” ì´ë²¤íŠ¸ëŠ” ë‹¤ìŒê³¼ ê°™ì•˜ìŠµë‹ˆë‹¤.
        <ul>
          <li><code class="language-plaintext highlighter-rouge">view_item</code>: ì•„ì´í…œ í˜ì´ì§€ë¥¼ ì¡°íšŒí•œë‹¤.</li>
          <li><code class="language-plaintext highlighter-rouge">begin_checkout</code>: êµ¬ë§¤ë¥¼ ì‹œì‘í•œë‹¤.</li>
          <li><code class="language-plaintext highlighter-rouge">add_payment_info</code>: ë°°ì†¡ì§€, ì´ë©”ì¼, ì—°ë½ì²˜ ë“± êµ¬ë§¤ ê´€ë ¨ ì •ë³´ ì…ë ¥ì„ ì™„ë£Œí•œ í›„ ê²°ì œ í”„ë¡œì„¸ìŠ¤ë¡œ ë„˜ì–´ê°„ë‹¤.</li>
          <li><code class="language-plaintext highlighter-rouge">purchase</code>: ìµœì¢… ê²°ì œë¥¼ ì™„ë£Œí•œ í›„ Thank You í˜ì´ì§€ë¥¼ ì¡°íšŒí•œë‹¤.</li>
        </ul>
      </li>
      <li>ìœ„ ë„¤ ë‹¨ê³„ ì¤‘, <code class="language-plaintext highlighter-rouge">add_payment_info</code>ë¡œë¶€í„° <code class="language-plaintext highlighter-rouge">purchase</code>ë¡œ ë„˜ì–´ê°€ëŠ” ì§€ì ì—ì„œ ì „í™˜ìœ¨ì´ ì˜¤íˆë ¤ ê°ì†Œí•˜ê³  ìˆìŒì„ í™•ì¸í•˜ê²Œ ëœ ê²ƒì…ë‹ˆë‹¤.</li>
    </ul>
  </li>
</ol>

<hr />

<h1 id="3-tasks">3. Tasks</h1>
<blockquote>
  <ul>
    <li>ì‹ ê·œ ë°©ë¬¸ì ìˆ˜ê°€ ê¸‰ì¦í•œ ìƒí™©ì—ì„œ <strong>ê²°ì œ í”„ë¡œì„¸ìŠ¤ì˜ ì´íƒˆë¥ ì´ ë†’ë‹¤ëŠ” ë¬¸ì œ</strong>ë¥¼ ë°œê²¬í–ˆìŠµë‹ˆë‹¤.</li>
    <li>êµ¬ì²´ì ìœ¼ë¡œ êµ¬ë§¤ í¼ë„ì˜ ê° ë‹¨ê³„ì—ì„œ ì´íƒˆ ì§€ì ì„ ë¶„ì„í•œ ê²°ê³¼, ë§ì€ ê³ ê°ë“¤ì´ <strong>êµ¬ë§¤ ì •ë³´ë¥¼ ì…ë ¥í•œ í›„ ê²°ì œ ë‹¨ê³„ì—ì„œ ì´íƒˆ</strong>í•˜ëŠ” ê²ƒìœ¼ë¡œ ë‚˜íƒ€ë‚¬ìŠµë‹ˆë‹¤.</li>
    <li>íŠ¹íˆ, <strong>ê²°ì œ ê³¼ì •ì—ì„œì˜ UX</strong>ê°€ êµ¬ë§¤ ì „í™˜ì— í° ì˜í–¥ì„ ë¯¸ì¹œë‹¤ëŠ” ì ì„ ì¸ì§€í•˜ê³ , ë¬¸ì œë¥¼ ëª…í™•íˆ í•˜ì—¬ ì‚¬ìš©ì ê²½í—˜ì„ ê°œì„ í•  í•„ìš”ê°€ ìˆì—ˆìŠµë‹ˆë‹¤.</li>
    <li>ë˜í•œ, ì´ë²ˆ ì „í™˜ìœ¨ ì €í•˜ëŠ” ì™¸ë¶€ ìš”ì¸ì— ì˜í•œ ìì—°ì  ìœ ì… ì‚¬ìš©ì ì¦ê°€ì™€ ì„¸ê·¸ë¨¼íŠ¸ ë³€í™”ì™€ ê´€ë ¨ì´ ìˆì„ ê²ƒìœ¼ë¡œ íŒë‹¨í–ˆìŠµë‹ˆë‹¤.</li>
  </ul>
</blockquote>

<h3 id="ë¬¸ì œ-êµ¬ì²´í™”">ë¬¸ì œ êµ¬ì²´í™”</h3>

<ol>
  <li>ê²°ì œ í”„ë¡œì„¸ìŠ¤ì˜ UX ê°œì„ ì´ í•„ìš”í–ˆìŠµë‹ˆë‹¤.
    <ul>
      <li>êµ¬ë§¤ í¼ë„ì—ì„œ ì´íƒˆë¥ ì´ ë†’ì€ ì§€ì ì„ ë¶„ì„í•œ ê²°ê³¼, ë§ì€ ê³ ê°ë“¤ì´ ë°°ì†¡ì§€, ì´ë©”ì¼, ì—°ë½ì²˜ ë“± êµ¬ë§¤ ì •ë³´ë¥¼ ì…ë ¥í–ˆìŒì—ë„ ë¶ˆêµ¬í•˜ê³  ê²°ì œ í”„ë¡œì„¸ìŠ¤ ìƒì—ì„œ í¬ê²Œ ì´íƒˆí•˜ëŠ” ê²ƒìœ¼ë¡œ ë‚˜íƒ€ë‚¬ìŠµë‹ˆë‹¤.</li>
      <li><strong>ìƒë‹¹íˆ ì„±ê°€ì‹  êµ¬ë§¤ ì •ë³´ ì…ë ¥ ê³¼ì •ê¹Œì§€ ì™„ë£Œí–ˆë‹¤ë©´, â€œêµ¬ë§¤ ì˜í–¥â€ì´ ë§¤ìš° ë†’ì€ ì‹¬ë¦¬ ìƒíƒœì˜€ì„ í…ë°, ìƒë‹¹ìˆ˜ê°€ ì´íƒˆí•˜ê³  ë§Œ ê²ƒì…ë‹ˆë‹¤.</strong></li>
      <li>ì´ëŠ” <strong>êµ¬ë§¤ ì˜í–¥ ìì²´ë¥¼ í”ë“¤ì–´ ë†“ì„ ë§Œí•œ ê²°ì œ í”„ë¡œì„¸ìŠ¤ ë¶ˆë§Œì¡±</strong>ì„ ëŠê¼ˆì„ ê°€ëŠ¥ì„±ì´ ì»¸ì„ ê²ƒì…ë‹ˆë‹¤.</li>
    </ul>
  </li>
  <li>êµ¬ì²´ì ìœ¼ë¡œëŠ” ë‹¤ìŒ ê³¼ì •ì—ì„œ ì´íƒˆë¥ ì´ ë§¤ìš° ë†’ì•˜ìŠµë‹ˆë‹¤.
    <ul>
      <li>ì•„ë˜ UIëŠ” <code class="language-plaintext highlighter-rouge">add_payment_info</code> ì´ë²¤íŠ¸ ë°œìƒ ì§í›„ ë‚˜íƒ€ë‚˜ëŠ” PGì‚¬ì˜ ê²°ì œ í”„ë¡œì„¸ìŠ¤ì…ë‹ˆë‹¤.</li>
      <li>ì´ í”„ë¡œì„¸ìŠ¤ ê³¼ì •ì—ì„œ ê²°ì œë¥¼ ì™„ë£Œí•˜ì§€ ëª»í•˜ê³  ì´íƒˆí•˜ê³  ìˆì—ˆë˜ ê²ƒì…ë‹ˆë‹¤.
<img src="/assets/2024-08-29-how-we-dramatically-improved-conversion-rates/6.png" alt="" /></li>
    </ul>
  </li>
  <li>ìœ ì… ì‚¬ìš©ì ì„¸ê·¸ë¨¼íŠ¸ê°€ ë³€í–ˆìŠµë‹ˆë‹¤.
    <ul>
      <li>
        <p>ì›¹ì‚¬ì´íŠ¸ UIì—ëŠ” ë³€ë™ì´ ì „í˜€ ì—†ì—ˆëŠ”ë°ë„ ë¶ˆêµ¬í•˜ê³  ì „í™˜ìœ¨ì´ ê°‘ìê¸° ì´ì „ê³¼ ê´´ë¦¬ëœë‹¤ë©´ ì„¸ê·¸ë¨¼íŠ¸ì˜ ë³€ë™ ë•Œë¬¸ì¸ ê²ƒìœ¼ë¡œ íŒë‹¨í–ˆìŠµë‹ˆë‹¤.</p>

        <ul>
          <li>
            <p>ê·¸ë™ì•ˆ ë§ˆì¼€íŒ… ìœ ì… í™œë™ì— ë°˜ì‘í•˜ì—¬ ë°©ë¬¸í•œ â€œ<strong>ì¸ìœ„ì  ìœ ì…</strong>â€œì´ ì•„ë‹ˆë¼, ì´ë²¤ì—ëŠ” ì‹œì¥ì˜ ì˜í–¥ìœ¼ë¡œ ì¸í•´ Organicí•˜ê²Œ ë°©ë¬¸í•œ â€œ<strong>ìì—°ì  ìœ ì…</strong>â€œì´ ì£¼ë¥¼ ì´ë£¨ì—ˆê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.
 <img src="/assets/2024-08-29-how-we-dramatically-improved-conversion-rates/4.png" alt="" /></p>
          </li>
          <li>
            <p>êµ¬ë§¤ ì˜í–¥ ìì²´ê°€ ê³¼ê±°ì— ë¹„í•´ ë†’ì€ ì†ì„±/í–‰ë™ íŒ¨í„´ì„ ì§€ë…”ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤. (ì´ì „ë³´ë‹¤ í™•ì—°íˆ ë†’ì•„ì§„ <strong>ì•„ì´í…œ í˜ì´ì§€ ì¡°íšŒìœ¨</strong>)
 <img src="/assets/2024-08-29-how-we-dramatically-improved-conversion-rates/2.png" alt="" /></p>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ol>

<hr />

<h1 id="4-actions">4. Actions</h1>
<blockquote>
  <ul>
    <li>ë°œê²¬ëœ ë¬¸ì œë¥¼ ë°”íƒ•ìœ¼ë¡œ ê²°ì œ í”„ë¡œì„¸ìŠ¤ ê°œì„ ì„ ìœ„í•´ ì‚¬ë‚´ êµ¬ì„±ì›ë“¤ê³¼ ë¬¸ì œë¥¼ ê³µìœ í•˜ê³ , ì—¬ëŸ¬ ê°€ì§€ ì•¡ì…˜ í”Œëœì„ ë…¼ì˜í–ˆìŠµë‹ˆë‹¤.</li>
    <li>ë…¼ì˜ ê²°ê³¼, ê²°ì œ í”„ë¡œì„¸ìŠ¤ì—ì„œì˜ ì´íƒˆë¥ ì„ ë‚®ì¶”ê¸° ìœ„í•´ ìš°ì„ ì ìœ¼ë¡œ <strong>ê°„í¸ ê²°ì œ ì„œë¹„ìŠ¤ì¸ PayPal Express Checkout ê¸°ëŠ¥ì„ ë„ì…</strong>í•˜ê¸°ë¡œ ê²°ì •í–ˆìŠµë‹ˆë‹¤.</li>
    <li>ì´ëŠ” ê²°ì œ ë‹¨ê³„ë¥¼ ë‹¨ì¶•í•˜ê³  ì‚¬ìš©ìì—ê²Œ í¸ë¦¬í•œ ê²°ì œ ê²½í—˜ì„ ì œê³µí•˜ì—¬ ì „í™˜ìœ¨ì„ ë†’ì¼ ìˆ˜ ìˆëŠ” ê°€ì¥ í˜„ì‹¤ì ì´ê³  íš¨ìœ¨ì ì¸ ë°©ì•ˆìœ¼ë¡œ íŒë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.</li>
    <li>ì´í›„ í•´ë‹¹ ê¸°ëŠ¥ì„ ì ìš©í•˜ì—¬ ì‚¬ìš©ìì˜ ê²°ì œ ê³¼ì •ì—ì„œ ë¶ˆí¸í•¨ì„ ìµœì†Œí™”í•˜ê³  ë³´ì•ˆ ì‹ ë¢°ë„ë¥¼ ë†’ì´ëŠ” ë“± UX ê°œì„ ì„ ì¶”ì§„í–ˆìŠµë‹ˆë‹¤.</li>
  </ul>
</blockquote>

<h3 id="ì‚¬ë‚´-ê³µìœ ">ì‚¬ë‚´ ê³µìœ </h3>
<ul>
  <li>ë¬¸ì œë¥¼ êµ¬ì²´í™”í•˜ì—¬ ìš°ì„  ì‚¬ë‚´ êµ¬ì„±ì› ë¶„ë“¤ê»˜ í•´ë‹¹ ë‚´ìš©ì„ ê³µìœ  ë“œë ¸ê³ , ë§ì€ ë¶„ë“¤ê»˜ì„œ ì´ ë¬¸ì œì— ëŒ€í•´ ê³µê°ì„ í‘œí˜„í•´ì£¼ì…¨ìŠµë‹ˆë‹¤.</li>
  <li>ê²°êµ­, ì„ì› ë¶„ë“¤ ë° ë§ˆì¼€íŒ… íŒ€ì› ë¶„ë“¤ê³¼ í•¨ê»˜ ë¯¸íŒ…ì„ í•˜ì—¬ ë¬¸ì œë¥¼ ê°œì„ í•  ë§Œí•œ <strong>ì•¡ì…˜ í”Œëœì„ ë…¼ì˜</strong>í•˜ê¸° ì‹œì‘í–ˆìŠµë‹ˆë‹¤.
 <img src="/assets/2024-08-29-how-we-dramatically-improved-conversion-rates/7.png" alt="" /></li>
</ul>

<h3 id="ë°ì´í„°-ë¶„ì„ì˜-í•œê³„">ë°ì´í„° ë¶„ì„ì˜ í•œê³„</h3>
<ul>
  <li>ì•ˆíƒ€ê¹ê²Œë„, <code class="language-plaintext highlighter-rouge">add_payment_info</code> ì´ë²¤íŠ¸ì™€ <code class="language-plaintext highlighter-rouge">purchase</code> ì´ë²¤íŠ¸ ì‚¬ì´ì— ë°œìƒí•œ ì‚¬ìš©ì í–‰ë™ê¹Œì§€ëŠ” ë°ì´í„°ë¡œ í™•ì¸í•  ìˆ˜ ì—†ì—ˆìŠµë‹ˆë‹¤.
    <ul>
      <li>ë‹¹ì‚¬ê°€ ì‚¬ìš© ì¤‘ì¸ ì´ì»¤ë¨¸ìŠ¤ í”Œë«í¼ì˜ Plan í•˜ì—ì„œëŠ” ì†ŒìŠ¤ì½”ë“œì— GTM ì»¤ìŠ¤í…€ ì´ë²¤íŠ¸ íŠ¸ë¦¬ê±°ë¥¼ ì‚½ì…í•  ìˆ˜ ì—†ì—ˆê¸° ë•Œë¬¸ì— ê¸°ë³¸ì ì¸ GA4 ì´ë²¤íŠ¸ ìˆ˜ì§‘ë§Œ ê°€ëŠ¥í–ˆê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.</li>
    </ul>
  </li>
  <li>ë”°ë¼ì„œ ë‹¨ìˆœíˆ ë°ì´í„°ë§Œìœ¼ë¡œëŠ” ì´ ë¬¸ì œì˜ êµ¬ì²´ì ì¸ ì›ì¸ì„ í•´ëª…í•  ìˆ˜ ì—†ì—ˆìŠµë‹ˆë‹¤.</li>
  <li><strong>ê·¸ë˜ì„œ ì§€ê¸ˆë¶€í„°ëŠ” êµ­ë‚´/í•´ì™¸ ì‹œì¥ì— ëŒ€í•œ ì•ˆëª©ì´ ë†’ì€ ì‚¬ë‚´ êµ¬ì„±ì› ë¶„ë“¤ì˜ ì§ê´€ì  íŒë‹¨ì´ ì¤‘ìš”í•´ì§€ê¸° ì‹œì‘í–ˆìŠµë‹ˆë‹¤.</strong></li>
</ul>

<h3 id="ê°€ì„¤-ì„¤ì •">ê°€ì„¤ ì„¤ì •</h3>

<ol>
  <li>ê¹Šì€ ë…¼ì˜ ëì—, ë‹¤ìŒê³¼ ê°™ì€ ì˜ê²¬ë“¤ì´ ê³µìœ ë˜ì—ˆìŠµë‹ˆë‹¤.
    <ul>
      <li><strong>ê°€ì„¤ 1</strong>: â€œê²°ì œ ìˆ˜ë‹¨ì„ ë‹¤ì–‘í™”í•´ì•¼ ë¼ìš”. ì ì¬ êµ¬ë§¤ ê³ ê°ì´ ìì‹ ì´ ì›í•˜ëŠ” ê²°ì œ ìˆ˜ë‹¨ì„ ì°¾ì§€ ëª»í•´ ì´íƒˆí–ˆì„ ê°€ëŠ¥ì„±ì´ í´ ê±°ì˜ˆìš”.â€</li>
      <li><strong>ê°€ì„¤ 2</strong>: â€œê°„í¸ ê²°ì œ ì„œë¹„ìŠ¤ë¥¼ ì¶”ê°€í•˜ëŠ” ê±´ ì–´ë•Œìš”? êµ¬ë§¤ ì˜í–¥ì´ ì¤„ì–´ë“¤ê¸° ì „ì— ë¹ ë¥´ê²Œ ê²°ì œê°€ ë§ˆë¬´ë¦¬ë  ìˆ˜ ìˆì„ ê±°ì˜ˆìš”.â€</li>
      <li><strong>ê°€ì„¤ 3</strong>: â€œê°€ìƒìì‚° ê²°ì œ ë°©ì‹ì„ ì§€ì›í•˜ëŠ” ê²ƒë„ ê³ ë ¤í•´ë´ìš”. ìš°ë¦¬ ê³ ê°ë“¤ì˜ íŠ¹ì„±ìƒ ì„ í˜¸ë„ê°€ ë†’ì„ ê²ƒ ê°™ê±°ë“ ìš”.â€</li>
      <li><strong>ê°€ì„¤ 4</strong>: â€œPGì‚¬ì˜ ê²°ì œ í”„ë¡œì„¸ìŠ¤ UIë¥¼ ê°œì„ í•´ë³´ëŠ” ê²ƒë„ ì¢‹ì„ ê²ƒ ê°™ì•„ìš”.â€</li>
    </ul>
  </li>
  <li>ì´ ì¤‘, â€œ<strong>ê°„í¸ ê²°ì œ ì„œë¹„ìŠ¤ ì¶”ê°€í•˜ê¸°</strong>â€œë¥¼ ìš°ì„ ì ìœ¼ë¡œ í…ŒìŠ¤íŠ¸í•˜ê¸°ë¡œ ê²°ì •í–ˆìŠµë‹ˆë‹¤.
    <ul>
      <li>ì‹¤í–‰ ë¹„ìš©, ì‹œì¥ì— ëŒ€í•œ ì•ˆëª© ë“± ì¸¡ë©´ì—ì„œ í˜„ì‹¤ì ìœ¼ë¡œ ê°€ì¥ ë°”ëŒì§í•œ ì•¡ì…˜ì´ë¼ê³  ëŠê¼ˆê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.</li>
    </ul>
  </li>
  <li>ìµœì¢… ê°€ì„¤ ìˆ˜ë¦½
    <blockquote>
      <p>â€œ<strong>PayPal Express Checkout ê¸°ëŠ¥ì„ ë„ì…í•˜ë©´ ê²°ì œ í”„ë¡œì„¸ìŠ¤ ìƒì—ì„œì˜ ì „í™˜ìœ¨ì´ ë†’ì•„ì§ˆ ê²ƒì´ë‹¤!</strong>â€</p>
    </blockquote>
  </li>
</ol>

<h3 id="ì•¡ì…˜-ì‹¤í–‰">ì•¡ì…˜ ì‹¤í–‰</h3>

<ol>
  <li>
    <p><strong>PayPal Express Checkout</strong>ì€ ê³ ê°ì´ ë°°ì†¡ì§€, ì´ë©”ì¼, ì—°ë½ì²˜ëŠ” ë¬¼ë¡ , ì‹ ìš©ì¹´ë“œ ì •ë³´ ì¡°ì°¨ë„ ì¼ì¼ì´ ì…ë ¥í•˜ì§€ ì•Šì€ ìƒíƒœì—ì„œ, PayPal ë¡œê·¸ì¸ì„ í†µí•´ ê¸°ì¡´ì— ì €ì¥ëœ ì •ë³´ë¥¼ í† ëŒ€ë¡œ ë¹ ë¥´ê²Œ ê²°ì œí•  ìˆ˜ ìˆëŠ” ê¸°ëŠ¥ì…ë‹ˆë‹¤.</p>
  </li>
  <li>ì‚¬ì‹¤ ë‹¹ì‚¬ëŠ” ì—°ë™ëœ PGì‚¬ë¥¼ í†µí•´ ì´ë¯¸ PayPalì„ ê²°ì œ ìˆ˜ë‹¨ì„ ì œê³µí•˜ê³  ìˆì—ˆì§€ë§Œ, ë‹¤ìŒê³¼ ê°™ì€ ë¶ˆí¸í•¨ì„ ì´ˆë˜í•˜ê³  ìˆì—ˆë˜ ê²ƒìœ¼ë¡œ ì¶”ì¸¡í–ˆìŠµë‹ˆë‹¤.
    <ul>
      <li>â€œì—¬ëŸ¬ ê°€ì§€ ì˜µì…˜ ì¤‘ í•˜ë‚˜ë¡œë§Œ í‘œì‹œë˜ì–´ ìˆìœ¼ë¯€ë¡œ ëˆˆì— ì˜ ë„ì§€ ì•Šì•˜ì„ ê²ƒì´ë‹¤.â€</li>
      <li>â€œì´ë¯¸ ë°°ì†¡ì§€, ì´ë©”ì¼, ì—°ë½ì²˜ ì •ë³´ë¥¼ ì…ë ¥í–ˆëŠ”ë° ë‹¤ì‹œ í•œ ë²ˆ PayPal ë¡œê·¸ì¸ì„ ìœ ë„í•˜ëŠ” ê²ƒì´ ë¶ˆí•„ìš”í•œ ì‹œê°„ ë‚­ë¹„ë¡œ ëŠê»´ì¡Œì„ ê²ƒì´ë‹¤.â€
<img src="/assets/2024-08-29-how-we-dramatically-improved-conversion-rates/6.png" alt="" /></li>
    </ul>
  </li>
  <li>ë”°ë¼ì„œ PayPal Express Checkout ê¸°ëŠ¥ì„ ë‹¤ìŒì˜ ì¸¡ë©´ì—ì„œ UX í–¥ìƒ ë°©ë²•ì´ë¼ê³  ìƒê°í•˜ê²Œ ë˜ì—ˆìŠµë‹ˆë‹¤.
    <ul>
      <li><strong>ê³ ê°ì˜ êµ¬ë§¤ ì „í™˜ ë‹¨ê³„ë¥¼ ë‹¨ì¶•í•˜ì—¬ ê°„í¸í•œ ê²°ì œë¥¼ ì§€ì›í•œë‹¤.</strong></li>
      <li><strong>ê°œì¸ì •ë³´ë¥¼ ì¼ì¼ì´ ì…ë ¥í•˜ì§€ ì•Šì•„ë„ ë˜ë¯€ë¡œ, ë³´ì•ˆì— ëŒ€í•œ ì‹ ë¢°ë„ë¥¼ ë†’ì¸ë‹¤.</strong>
<img src="/assets/2024-08-29-how-we-dramatically-improved-conversion-rates/8.png" alt="" /></li>
    </ul>
  </li>
</ol>

<hr />

<h1 id="5-results">5. Results</h1>
<blockquote>
  <ul>
    <li>PayPal Express Checkout ê¸°ëŠ¥ ë„ì… í›„, ê²°ì œ ê³¼ì •ì—ì„œ ì´íƒˆí•˜ë˜ ë¬¸ì œê°€ í¬ê²Œ ê°œì„ ë˜ì–´ <strong><code class="language-plaintext highlighter-rouge">add_payment_info</code>ì—ì„œ <code class="language-plaintext highlighter-rouge">purchase</code>ë¡œ ë„˜ì–´ê°€ëŠ” ì „í™˜ìœ¨ì´ ì´ì „ë³´ë‹¤ 32%p ìƒìŠ¹</strong>í–ˆìŠµë‹ˆë‹¤.</li>
    <li>ì´ ì¡°ì¹˜ëŠ” ê²°ì œ í”„ë¡œì„¸ìŠ¤ë¥¼ ê°„ì†Œí™”í•˜ê³  ì‚¬ìš©ì ê²½í—˜ì„ í–¥ìƒì‹œì¼œ ì „í™˜ìœ¨ì„ ì›ìƒíƒœë¡œ íšŒë³µì‹œì¼°ì„ ë¿ë§Œ ì•„ë‹ˆë¼, <strong>í˜„ì¬ê¹Œì§€ë„ ë†’ì€ ìˆ˜ì¤€ì„ ìœ ì§€</strong>í•˜ê³  ìˆìŠµë‹ˆë‹¤.</li>
    <li>ì´ ê²°ê³¼ëŠ” ê²°ì œ ì˜µì…˜ì˜ ë‹¤ì–‘í™”ì™€ ê°„í¸ ê²°ì œ ë„ì…ì´ íš¨ê³¼ì ì¸ ì „ëµì„ì„ ì…ì¦í•˜ë©°, ë¶„ì„ì„ ë°”íƒ•ìœ¼ë¡œ í•œ ë¬¸ì œ í•´ê²°ì´ ë§¤ì¶œ ì„±ê³¼ì— ê¸ì •ì ì¸ ì˜í–¥ì„ ë¯¸ì³¤ìŠµë‹ˆë‹¤.</li>
  </ul>
</blockquote>

<h3 id="ê²°ê³¼">ê²°ê³¼</h3>

<ul>
  <li>í•´ë‹¹ ì•¡ì…˜ì„ ì‹¤í–‰í•œ í›„, <strong><code class="language-plaintext highlighter-rouge">add_payment_info</code>ë¡œë¶€í„° <code class="language-plaintext highlighter-rouge">purchase</code>ë¡œ ë„˜ì–´ê°€ëŠ” ì§€ì ì˜ ì „í™˜ìœ¨ì€ ì›ìƒíƒœë¡œ íšŒë³µë˜ì—ˆì„ ë¿ë§Œ ì•„ë‹ˆë¼ ì´ì „ë³´ë‹¤ í›¨ì”¬ ë†’ì€ ìˆ˜ì¤€ì„ ê¸°ë¡í–ˆìŠµë‹ˆë‹¤.</strong></li>
  <li>2023ë…„ 8ì›”ë§ í˜„ì¬ê¹Œì§€ë„ ì—¬ì „íˆ ë†’ì€ ì „í™˜ìœ¨ ìˆ˜ì¤€ì„ ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤.
    <details>
 <summary>View Query</summary>
 <div>
        <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">WITH</span>
    <span class="n">CTE_raw</span> <span class="k">AS</span> <span class="p">(</span>
       <span class="k">SELECT</span>
          <span class="n">event_date</span><span class="p">,</span>
          <span class="n">user_pseudo_id</span><span class="p">,</span>
          <span class="n">event_name</span>
       <span class="k">FROM</span> <span class="nv">`project_id.dataset_id.events_*`</span>
       <span class="k">WHERE</span>
          <span class="n">_table_suffix</span> <span class="k">BETWEEN</span> <span class="n">FORMAT_DATE</span><span class="p">(</span><span class="s1">'%Y%m%d'</span><span class="p">,</span> <span class="s1">'START DATE'</span><span class="p">)</span> <span class="k">AND</span> <span class="n">FORMAT_DATE</span><span class="p">(</span><span class="s1">'%Y%m%d'</span><span class="p">,</span> <span class="s1">'END DATE'</span><span class="p">)</span>
    <span class="p">),</span>

    <span class="n">CTE_funnel</span> <span class="k">AS</span> <span class="p">(</span>
       <span class="k">SELECT</span>
          <span class="n">event_date</span><span class="p">,</span>
          <span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="n">user_pseudo_id</span><span class="p">)</span> <span class="k">AS</span> <span class="n">all_users_cnt</span><span class="p">,</span>
          <span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="k">CASE</span> <span class="k">WHEN</span> <span class="n">event_name</span> <span class="o">=</span> <span class="s1">'view_item'</span> <span class="k">THEN</span> <span class="n">user_pseudo_id</span> <span class="k">END</span><span class="p">)</span> <span class="k">AS</span> <span class="n">view_item_users_cnt</span><span class="p">,</span>
          <span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="k">CASE</span> <span class="k">WHEN</span> <span class="n">event_name</span> <span class="o">=</span> <span class="s1">'begin_checkout'</span> <span class="k">THEN</span> <span class="n">user_pseudo_id</span> <span class="k">END</span><span class="p">)</span> <span class="k">AS</span> <span class="n">begin_checkout_users_cnt</span><span class="p">,</span>
          <span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="k">CASE</span> <span class="k">WHEN</span> <span class="n">event_name</span> <span class="o">=</span> <span class="s1">'add_payment_info'</span> <span class="k">THEN</span> <span class="n">user_pseudo_id</span> <span class="k">END</span><span class="p">)</span> <span class="k">AS</span> <span class="n">add_payment_info_users_cnt</span><span class="p">,</span>
          <span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="k">CASE</span> <span class="k">WHEN</span> <span class="n">event_name</span> <span class="o">=</span> <span class="s1">'purchase'</span> <span class="k">THEN</span> <span class="n">user_pseudo_id</span> <span class="k">END</span><span class="p">)</span> <span class="k">AS</span> <span class="n">purchase_users_cnt</span>
       <span class="k">FROM</span>
          <span class="n">CTE_raw</span>
       <span class="k">GROUP</span> <span class="k">BY</span>
          <span class="mi">1</span>
    <span class="p">),</span>

    <span class="n">CTE_result</span> <span class="k">AS</span> <span class="p">(</span>
       <span class="k">SELECT</span>
          <span class="n">event_date</span><span class="p">,</span>
          <span class="n">SAFE_DIVIDE</span><span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="n">all_users_cnt</span><span class="p">,</span> <span class="n">all_users_cnt</span><span class="p">)</span> <span class="k">AS</span> <span class="n">all_users_cvr</span><span class="p">,</span>
          <span class="n">SAFE_DIVIDE</span><span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="n">view_item_users_cnt</span><span class="p">,</span> <span class="n">all_users_cnt</span><span class="p">)</span> <span class="k">AS</span> <span class="n">view_item_cvr</span><span class="p">,</span>
          <span class="n">SAFE_DIVIDE</span><span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="n">begin_checkout_users_cnt</span><span class="p">,</span> <span class="n">all_users_cnt</span><span class="p">)</span> <span class="k">AS</span> <span class="n">begin_checkout_cvr</span><span class="p">,</span>
          <span class="n">SAFE_DIVIDE</span><span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="n">add_payment_info_users_cnt</span><span class="p">,</span> <span class="n">all_users_cnt</span><span class="p">)</span> <span class="k">AS</span> <span class="n">add_payment_info_cvr</span><span class="p">,</span>
          <span class="n">SAFE_DIVIDE</span><span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="n">purchase_users_cnt</span><span class="p">,</span> <span class="n">all_users_cnt</span><span class="p">)</span> <span class="k">AS</span> <span class="n">purchase_cvr</span>
       <span class="k">FROM</span>
          <span class="n">CTE_funnel</span>
       <span class="k">ORDER</span> <span class="k">BY</span>
          <span class="mi">1</span>
    <span class="p">)</span>

    <span class="k">SELECT</span>
       <span class="o">*</span>
    <span class="k">FROM</span>
       <span class="n">CTE_result</span>
    <span class="k">ORDER</span> <span class="k">BY</span>
       <span class="mi">1</span>
</code></pre></div>        </div>
      </div>
 </details>
    <p><img src="/assets/2024-08-29-how-we-dramatically-improved-conversion-rates/9.png" alt="" /></p>
  </li>
</ul>

<h3 id="íš¨ê³¼">íš¨ê³¼</h3>

<ul>
  <li>í•´ë‹¹ ì•¡ì…˜ì„ ì‹¤í–‰í•œ í›„, <strong><code class="language-plaintext highlighter-rouge">add_payment_info</code>ë¡œë¶€í„° <code class="language-plaintext highlighter-rouge">purchase</code>ë¡œ ë„˜ì–´ê°€ëŠ” ì§€ì ì˜ ì „í™˜ìœ¨ì€ ê¸°ì¡´ì— ë¹„í•´ 32%p ìƒìŠ¹í–ˆìŠµë‹ˆë‹¤.</strong>
    <details>
 <summary>View Query</summary>
 <div>
        <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">WITH</span>
    <span class="n">CTE_raw</span> <span class="k">AS</span> <span class="p">(</span>
       <span class="k">SELECT</span>
          <span class="n">event_date</span><span class="p">,</span>
          <span class="n">user_pseudo_id</span><span class="p">,</span>
          <span class="n">event_name</span>
       <span class="k">FROM</span> <span class="nv">`project_id.dataset_id.events_*`</span>
       <span class="k">WHERE</span>
          <span class="n">_table_suffix</span> <span class="k">BETWEEN</span> <span class="n">FORMAT_DATE</span><span class="p">(</span><span class="s1">'%Y%m%d'</span><span class="p">,</span> <span class="s1">'START DATE'</span><span class="p">)</span> <span class="k">AND</span> <span class="n">FORMAT_DATE</span><span class="p">(</span><span class="s1">'%Y%m%d'</span><span class="p">,</span> <span class="s1">'END DATE'</span><span class="p">)</span>
    <span class="p">),</span>

    <span class="n">CTE_funnel</span> <span class="k">AS</span> <span class="p">(</span>
       <span class="k">SELECT</span>
          <span class="k">CASE</span>
                <span class="k">WHEN</span> <span class="n">event_date</span> <span class="o">&lt;=</span> <span class="s1">'YYYY-MM-DD'</span> <span class="k">THEN</span> <span class="s1">'AS-IS'</span>
                <span class="k">ELSE</span> <span class="s1">'TO-BE'</span>
          <span class="k">END</span> <span class="k">AS</span> <span class="n">period</span><span class="p">,</span>
          <span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="n">user_pseudo_id</span><span class="p">)</span> <span class="k">AS</span> <span class="n">all_users_cnt</span><span class="p">,</span>
          <span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="k">CASE</span> <span class="k">WHEN</span> <span class="n">event_name</span> <span class="o">=</span> <span class="s1">'view_item'</span> <span class="k">THEN</span> <span class="n">user_pseudo_id</span> <span class="k">END</span><span class="p">)</span> <span class="k">AS</span> <span class="n">view_item_users_cnt</span><span class="p">,</span>
          <span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="k">CASE</span> <span class="k">WHEN</span> <span class="n">event_name</span> <span class="o">=</span> <span class="s1">'begin_checkout'</span> <span class="k">THEN</span> <span class="n">user_pseudo_id</span> <span class="k">END</span><span class="p">)</span> <span class="k">AS</span> <span class="n">begin_checkout_users_cnt</span><span class="p">,</span>
          <span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="k">CASE</span> <span class="k">WHEN</span> <span class="n">event_name</span> <span class="o">=</span> <span class="s1">'add_payment_info'</span> <span class="k">THEN</span> <span class="n">user_pseudo_id</span> <span class="k">END</span><span class="p">)</span> <span class="k">AS</span> <span class="n">add_payment_info_users_cnt</span><span class="p">,</span>
          <span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="k">CASE</span> <span class="k">WHEN</span> <span class="n">event_name</span> <span class="o">=</span> <span class="s1">'purchase'</span> <span class="k">THEN</span> <span class="n">user_pseudo_id</span> <span class="k">END</span><span class="p">)</span> <span class="k">AS</span> <span class="n">purchase_users_cnt</span>
       <span class="k">FROM</span>
          <span class="n">CTE_raw</span>
       <span class="k">GROUP</span> <span class="k">BY</span>
          <span class="mi">1</span>
    <span class="p">),</span>

    <span class="n">CTE_result</span> <span class="k">AS</span> <span class="p">(</span>
       <span class="k">SELECT</span>
          <span class="n">period</span><span class="p">,</span>
          <span class="n">SAFE_DIVIDE</span><span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="n">purchase_users_cnt</span><span class="p">,</span> <span class="n">add_payment_info_users_cnt</span><span class="p">)</span> <span class="k">AS</span> <span class="n">purchase_cvr</span>
       <span class="k">FROM</span>
          <span class="n">CTE_funnel</span>
    <span class="p">)</span>

    <span class="k">SELECT</span>
       <span class="o">*</span>
    <span class="k">FROM</span>
       <span class="n">CTE_result</span>
    <span class="k">ORDER</span> <span class="k">BY</span>
       <span class="mi">1</span>
</code></pre></div>        </div>
      </div>
 </details>
    <p><img src="/assets/2024-08-29-how-we-dramatically-improved-conversion-rates/10.png" alt="" /></p>
  </li>
</ul>

<hr />

<h2 id="published-by-joshua-kim"><em>Published by</em> Joshua Kim</h2>

<p><img src="/assets/profile/joshua-profile.png" alt="Joshua Kim" /></p>]]></content><author><name></name></author><category term="Language (Korean)" /><category term="Article (Project)" /><category term="Level (1. Beginner)" /><category term="Field (Data Analysis)" /><category term="Skills (SQL)" /><summary type="html"><![CDATA[â€œì™¸ë¶€ ìš”ì¸ìœ¼ë¡œ ì¸í•´ ì¦ê°€í•œ ì‹ ê·œ ë°©ë¬¸ì ë°ì´í„°ë¥¼ ë¶„ì„í•˜ì—¬ êµ¬ë§¤ ì „í™˜ìœ¨ì˜ ê¸‰ìƒìŠ¹ì„ ë‹¬ì„±í–ˆìŠµë‹ˆë‹¤. ë°ì´í„°ë¥¼ í†µí•´ ì‹ ê·œ ë°©ë¬¸ì ìˆ˜ì™€ ì´ë“¤ì˜ êµ¬ë§¤ ì˜í–¥ì´ í¬ê²Œ ì¦ê°€í–ˆìŒì„ ë°œê²¬í–ˆì§€ë§Œ, ê²°ì œ ë‹¨ê³„ì—ì„œ ì´íƒˆë¥ ì´ ë†’ë‹¤ëŠ” ë¬¸ì œë¥¼ íŒŒì•…í–ˆìŠµë‹ˆë‹¤. ì´ì— ê²°ì œ ê³¼ì •ì˜ ë¶ˆí¸í•¨ì´ ì£¼ìš” ì›ì¸ì„ì„ ê°€ì„¤ë¡œ ì„¤ì •í•˜ê³ , PayPal Express Checkoutì„ ë„ì…í•˜ì—¬ ì‚¬ìš©ì ê²½í—˜ì„ ê°œì„ í–ˆìŠµë‹ˆë‹¤. ê·¸ ê²°ê³¼, ê²°ì œ ì „í™˜ìœ¨ì´ 32%p ìƒìŠ¹í•˜ì—¬ ì´ì „ë³´ë‹¤ í›¨ì”¬ ë†’ì€ ìˆ˜ì¤€ì„ ê¸°ë¡í–ˆìœ¼ë©°, ì´ëŠ” ì§€ì†ì ìœ¼ë¡œ ìœ ì§€ë˜ê³  ìˆìŠµë‹ˆë‹¤. ì´ë¥¼ í†µí•´ ë¶„ì„ ê¸°ë°˜ì˜ ë¬¸ì œ í•´ê²°ê³¼ ì„±ê³¼ í–¥ìƒì„ ì´ë¤„ëƒˆìŠµë‹ˆë‹¤.â€]]></summary></entry></feed>