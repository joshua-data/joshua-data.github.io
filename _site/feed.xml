<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="4.3.2">Jekyll</generator><link href="http://localhost:4000/feed.xml" rel="self" type="application/atom+xml" /><link href="http://localhost:4000/" rel="alternate" type="text/html" /><updated>2023-12-13T15:06:17+09:00</updated><id>http://localhost:4000/feed.xml</id><title type="html">Joshua Kim</title><subtitle>Data Analyst</subtitle><entry><title type="html">ë°ì´í„° ë¶„ì„ê°€ì˜ SQL ìµœì í™” ì¼ê¸°: Static vs. Rolling Stickiness</title><link href="http://localhost:4000/static-vs-rolling-stickiness/" rel="alternate" type="text/html" title="ë°ì´í„° ë¶„ì„ê°€ì˜ SQL ìµœì í™” ì¼ê¸°: Static vs. Rolling Stickiness" /><published>2023-11-19T00:00:00+09:00</published><updated>2023-11-19T00:00:00+09:00</updated><id>http://localhost:4000/static-vs-rolling-stickiness</id><content type="html" xml:base="http://localhost:4000/static-vs-rolling-stickiness/"><![CDATA[<blockquote>
  <p>ëŒ€ê³ ê° ì„œë¹™ì„ ìœ„í•´ ì—„ì²­ë‚˜ê²Œ í° ì‚¬ì´ì¦ˆì˜ ì†ŒìŠ¤ í…Œì´ë¸”ë¡œë¶€í„° ìµœì í™”ëœ ë°ì´í„° ë§ˆíŠ¸ ì„¤ê³„ ê³ ë¯¼ì„ ë§ì´ í•˜ê³  ìˆëŠ” ë§Œí¼, Stickiness ì§€í‘œ ì‚¬ë¡€ë¥¼ ì¤‘ì‹¬ìœ¼ë¡œ SQL ì„±ëŠ¥ì— ëŒ€í•œ ì´ì•¼ê¸°ë¥¼ ë“¤ë ¤ë“œë¦¬ê² ìŠµë‹ˆë‹¤.</p>
</blockquote>

<h3 id="contents">CONTENTS</h3>
<ol>
  <li>ë“¤ì–´ê°€ëŠ” ê¸€</li>
  <li>Rolling MAU vs. 30ì¼ ì´ë™í‰ê· ì„ </li>
  <li>Static MAU</li>
  <li>Stickiness ì§€í‘œ</li>
  <li>Rolling Stickiness</li>
  <li>Static Stickiness</li>
  <li>Data Martë¥¼ í†µí•´ Rolling MAU ë„ì…í•˜ê¸°</li>
  <li>ê²°ë¡ : Query Cost vs Data Freshness</li>
</ol>

<hr />

<h3 id="disclaimer">DISCLAIMER</h3>
<blockquote>
  <p>ë³¸ ìë£ŒëŠ” ì‘ì„±ì ë³¸ì¸ì˜ ê²¬í•´ì¼ ë¿ì´ë©°, ì‹¤ì œ ë°ì´í„°ë² ì´ìŠ¤ì˜ í™˜ê²½ì— ë”°ë¼ ì í•©í•˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ë¯¸ì§€ ì¶œì²˜ë¥¼ ì œì™¸í•œ ëª¨ë“  ì¿¼ë¦¬ë¬¸ê³¼ ë‚´ìš©ì€ ë³¸ì¸ì˜ ê²½í—˜ì— ì˜í•´ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤. ì‘ì„±ëœ ì¿¼ë¦¬ë¬¸ì€ ìƒ˜í”Œë¡œ ì‘ì„±í•œ ê²ƒì´ë©°, ë³¸ì¸ì˜ ê³¼ê±° ë° í˜„ì¬ ì¬ì§ íšŒì‚¬ì˜ ì—…ë¬´ í˜„í™©ê³¼ ë¬´ê´€í•©ë‹ˆë‹¤.</p>
</blockquote>

<h1 id="1-ë“¤ì–´ê°€ëŠ”-ê¸€">1. ë“¤ì–´ê°€ëŠ” ê¸€</h1>

<p><img src="/assets/2023-11-19-static-vs-rolling-stickiness/unfinished-work.webp" alt="" /></p>
<blockquote>
  <p><a href="https://datasciencedojo.com/blog/data-science-memes/">Source</a></p>
</blockquote>

<p>ì•ˆë…•í•˜ì„¸ìš”. ì €ëŠ” ìœ„ ì•„ì´ ì²˜ëŸ¼ ë°ì´í„° ë¶„ì„ê°€ë¡œ ê·¼ë¬´í•˜ê³  ìˆëŠ” Joshuaë¼ê³  í•©ë‹ˆë‹¤.</p>

<p>ì €ëŠ” ì¼ë°˜ì ì¸ B2C ê¸°ì—…ì—ì„œ ë°ì´í„° ë¶„ì„ê°€ë¡œ ê·¼ë¬´í•˜ë©°, GA4, Amplitude, BigQuery, Redash ë“±ì„ í™œìš©í•˜ì—¬ A/B í…ŒìŠ¤íŠ¸, ì§€í‘œ ëª¨ë‹ˆí„°ë§ ë“±ì„ ìˆ˜í–‰í•˜ë©° íšŒì‚¬ì˜ ë“±ëŒ€ ì—­í• ì„ í•˜ë©° ì§€ëƒˆìŠµë‹ˆë‹¤. ë‹¤ë¥¸ ë¶„ë“¤ê³¼ ë¹„ìŠ·í•œ ì—­í• ì„ ìˆ˜í–‰í–ˆë˜ ê²ƒì´ì£ .</p>

<p>ë˜í•œ GA4, Amplitude ë“±ê³¼ ê°™ì€ B2B ë°ì´í„° ë¶„ì„ í”Œë«í¼ ì„œë¹„ìŠ¤ë¥¼ ë§Œë“œëŠ” ê²½í—˜ë„ ì‚´ì§ í–ˆëŠ”ë°ìš”. ê·¸ëŸ¬ë‹¤ë³´ë‹ˆ ì €ì˜ R&amp;Rì€ ì„œë¹„ìŠ¤ ìì²´ì˜ ë°ì´í„° ë¶„ì„ ì—…ë¬´ ì™¸ì—ë„, ê³ ê°ë“¤ì—ê²Œ ë°ì´í„°ë¥¼ ì„œë¹™í•˜ê¸° ìœ„í•œ ë°ì´í„° ë§ˆíŠ¸ ì„¤ê³„ì™€ ìµœì í™” ì—…ë¬´ì— ì§‘ì¤‘ë˜ê¸°ë„ í–ˆìŠµë‹ˆë‹¤. ì œ íƒ€ì´í‹€ì„ ë©‹ìˆê²Œ ê°€ê³µí•˜ë©´ ìµœê·¼ì— ë– ì˜¤ë¥´ëŠ” í¬ì§€ì…˜ì¸ Analytics Engineer, ë°˜ìª½ ì§œë¦¬ ë°ì´í„° ì—”ì§€ë‹ˆì–´, ì•„ë‹ˆë©´ ëŒ€ì¶© ì¿¼ë¦¬ ë¨¸ì‹  í˜¹ì€ ë¶„ì§€ë‹ˆì–´(?)ì¸ ê²ƒ ê°™ê¸°ë„ í•©ë‹ˆë‹¤. ğŸ˜…</p>

<p>ì•„ë¬´íŠ¼ ëŒ€ê³ ê° ì„œë¹™ì„ ìœ„í•´ ì—„ì²­ë‚˜ê²Œ í° ì‚¬ì´ì¦ˆì˜ ì†ŒìŠ¤ í…Œì´ë¸”ë¡œë¶€í„° ìµœì í™”ëœ ë°ì´í„° ë§ˆíŠ¸ ì„¤ê³„ ê³ ë¯¼ì„ ë§ì´ í•˜ê³  ìˆëŠ” ë§Œí¼, Stickiness ì§€í‘œ ì‚¬ë¡€ë¥¼ ì¤‘ì‹¬ìœ¼ë¡œ SQL ì„±ëŠ¥ì— ëŒ€í•œ ì´ì•¼ê¸°ë¥¼ ë“¤ë ¤ë“œë¦¬ê² ìŠµë‹ˆë‹¤.</p>

<p>(SQL ì „ë¬¸ê°€ ë¶„ë“¤ì´ ë§ì´ ê³„ì‹œëŠ” ë§Œí¼, ì œ ê¸€ì„ ë¹„íŒì ìœ¼ë¡œ ê³ ì°°í•´ì£¼ì‹œë©´ ê°ì‚¬í•˜ê² ìŠµë‹ˆë‹¤! ğŸ˜„)</p>

<h1 id="2-rolling-mau-vs-30ì¼-ì´ë™í‰ê· ì„ ">2. Rolling MAU vs. 30ì¼ ì´ë™í‰ê· ì„ </h1>

<p>Rolling MAUë€ ë§ˆì¹˜ 30ì¼ ì´ë™í‰ê· ì„  ì¸ë””ì¼€ì´í„° ë“±ê³¼ ìœ ì‚¬í•˜ê²Œ, ê° ì‹œì ë§ˆë‹¤ ìµœê·¼ 30ì¼ ë™ì•ˆì˜ MAUë¥¼ ì¸¡ì •í•˜ëŠ” ì§€í‘œì…ë‹ˆë‹¤. ì•„ë˜ GA4ì˜ ë¦¬í¬íŠ¸ëŠ” WAUì™€ MAUë¥¼ ëª¨ë‘ Rolling ë°©ì‹ìœ¼ë¡œ ì§‘ê³„í•˜ê³  ìˆëŠ” ëŒ€í‘œì ì¸ ì‚¬ë¡€ë¼ê³  í•  ìˆ˜ ìˆì„ ê²ƒ ê°™ì•„ì„œ ê°€ì ¸ì™€ë´¤ì–´ìš”!</p>

<p><img src="/assets/2023-11-19-static-vs-rolling-stickiness/user-activity-over-time.webp" alt="" /></p>
<blockquote>
  <p><a href="https://measureschool.com/ga4-active-users/">Source</a></p>
</blockquote>

<p>í•˜ì§€ë§Œ, 30ì¼ ì´ë™í‰ê· ì„  ì¸ë””ì¼€ì´í„°ì™€ Rolling MAUì˜ ì—°ì‚° ë°©ì‹ì—ëŠ” ì¤‘ëŒ€í•œ ì°¨ì´ì ì´ ìˆìŠµë‹ˆë‹¤.</p>

<p><img src="/assets/2023-11-19-static-vs-rolling-stickiness/trading-view.webp" alt="" /></p>
<blockquote>
  <p><a href="https://www.tradingwithrayner.com/20-30-day-moving-average/">Source</a></p>
</blockquote>

<p>ë¨¼ì € 30ì¼ ì´ë™í‰ê· ì„ ì„ SQLìŠ¤ëŸ½ê²Œ ì‘ì„±í•´ë³¸ë‹¤ë©´, ë‹¨ìˆœíˆ  <code class="language-plaintext highlighter-rouge">AVG Window Functions</code>ë¥¼ í†µí•´ ì¦‰ê°ì ìœ¼ë¡œ ì—°ì‚°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. Window FunctionsëŠ” ì´ë¯¸ ì¶œë ¥ëœ  <code class="language-plaintext highlighter-rouge">price</code>  ì¹¼ëŸ¼ ìì²´ë¥¼ í†µí•´ ì—°ì‚°í•˜ë¯€ë¡œ,  <code class="language-plaintext highlighter-rouge">daily_prices</code>  í…Œì´ë¸”ì„ ì¤‘ë³µìœ¼ë¡œ ë¶ˆëŸ¬ì˜¤ì§€ ì•Šì•„ ì—°ì‚°ëŸ‰ì´ ê¸°í•˜ê¸‰ìˆ˜ì ìœ¼ë¡œ ì¦ê°€í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">WITH</span>
<span class="n">CTE_ma_30d</span> <span class="k">AS</span> <span class="p">(</span>
   <span class="k">SELECT</span>
      <span class="nb">date</span><span class="p">,</span>
      <span class="n">price</span><span class="p">,</span>
      <span class="k">AVG</span><span class="p">(</span><span class="n">price</span><span class="p">)</span> <span class="n">OVER</span> <span class="p">(</span>
         <span class="k">ORDER</span> <span class="k">BY</span> <span class="nb">date</span>
         <span class="k">ROWS</span> <span class="k">BETWEEN</span> <span class="mi">29</span> <span class="k">PRECEDING</span> <span class="k">AND</span> <span class="k">CURRENT</span> <span class="k">ROW</span>
      <span class="p">)</span> <span class="k">AS</span> <span class="n">ma_30d</span>
   <span class="k">FROM</span>
      <span class="n">daily_prices</span>
   <span class="k">ORDER</span> <span class="k">BY</span>
      <span class="mi">1</span>
<span class="p">)</span>
<span class="k">SELECT</span>
   <span class="o">*</span>
<span class="k">FROM</span>
   <span class="n">CTE_ma_30d</span>
<span class="p">;</span>
</code></pre></div></div>

<p>ë°˜ë©´, Rolling MAUì˜ ì—°ì‚° ë°©ì‹ì€ ì¤‘ëŒ€í•œ ë¬¸ì œì ì´ ìˆìŠµë‹ˆë‹¤. ì¦‰, Window Functionsë¥¼ í†µí•´ ì—°ì‚°í•˜ëŠ” ê²ƒì´ ì–´ë µë‹¤ëŠ” ì ì…ë‹ˆë‹¤. ì•„ë˜ ì¿¼ë¦¬ë¬¸ì„ ì‚´í´ë³´ë©´,  <code class="language-plaintext highlighter-rouge">SELECT Statement</code>  ë‚´ ì„œë¸Œì¿¼ë¦¬ë¥¼ í†µí•´ Outer Tableì˜ ê°  <code class="language-plaintext highlighter-rouge">date</code>ë§ˆë‹¤ ì¼ì¼ì´ Inner Tableì˜ ê°€ë³€ì ì¸ ê¸°ê°„ë§ˆë‹¤ ëª¨ë“   <code class="language-plaintext highlighter-rouge">user_id</code>  ê³ ìœ ê°’ ê°œìˆ˜ë¥¼  <code class="language-plaintext highlighter-rouge">COUNT</code>í•˜ê²Œ ë©ë‹ˆë‹¤. ì¦‰,  <code class="language-plaintext highlighter-rouge">session_starts</code>  í…Œì´ë¸” ë‚´ì˜  <code class="language-plaintext highlighter-rouge">date</code>  ê³ ìœ ê°’ ê°œìˆ˜ê°€ 365ê°œë¼ë©´, ê°  <code class="language-plaintext highlighter-rouge">rolling_mau</code>  ì¹¼ëŸ¼ì˜ ê°’ì„ ê³„ì‚°í•˜ê¸° ìœ„í•´ì„œëŠ” ë™ì¼í•œ í…Œì´ë¸”ì„ 365ë²ˆì´ë‚˜ ë©”ëª¨ë¦¬ì— ì˜¬ë ¤ì•¼ í•˜ëŠ” ê²ƒì´ì£ .</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">WITH</span>
<span class="n">CTE_rolling_mau</span> <span class="k">AS</span> <span class="p">(</span>
   <span class="k">SELECT</span>
      <span class="n">MAIN</span><span class="p">.</span><span class="nb">date</span><span class="p">,</span>
      <span class="p">(</span>
         <span class="k">SELECT</span>
            <span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="n">user_id</span><span class="p">)</span>
         <span class="k">FROM</span>
            <span class="n">session_starts</span> <span class="n">SUB</span>
         <span class="k">WHERE</span>
            <span class="n">DATE_ADD</span><span class="p">(</span><span class="s1">'DAY'</span><span class="p">,</span> <span class="o">-</span><span class="mi">29</span><span class="p">,</span> <span class="n">MAIN</span><span class="p">.</span><span class="nb">date</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">SUB</span><span class="p">.</span><span class="nb">date</span>
            <span class="k">AND</span> <span class="n">SUB</span><span class="p">.</span><span class="nb">date</span> <span class="o">&lt;=</span> <span class="n">MAIN</span><span class="p">.</span><span class="nb">date</span>
      <span class="p">)</span> <span class="k">AS</span> <span class="n">rolling_mau</span>
   <span class="k">FROM</span>
      <span class="n">session_starts</span> <span class="n">MAIN</span>
   <span class="k">GROUP</span> <span class="k">BY</span>
      <span class="mi">1</span>
   <span class="k">ORDER</span> <span class="k">BY</span>
      <span class="mi">1</span>
<span class="p">)</span>
<span class="k">SELECT</span>
   <span class="o">*</span>
<span class="k">FROM</span>
   <span class="n">CTE_rolling_mau</span>
<span class="p">;</span>
</code></pre></div></div>

<p>ê²°êµ­, 30ì¼ ì´ë™í‰ê· ì„ ê³¼ ë‹¬ë¦¬ Rolling MAUì˜ ê²½ìš° ë‹¨ìˆœí•œ ì§‘ê³„ë¡œ ê°€ëŠ¥í•œ ì˜ì—­ì´ ì•„ë‹ˆë¼,  <code class="language-plaintext highlighter-rouge">COUNT(DISTINCT user_id)</code>ë¥¼ ìˆ˜í–‰í•˜ê¸° ìœ„í•œ í…Œì´ë¸” ì¬íƒìƒ‰ì´ ê° Rowë§ˆë‹¤ ì¤‘ë³µ ë°œìƒí•´ì•¼ í•˜ëŠ” ì˜ì—­ì…ë‹ˆë‹¤. ë”°ë¼ì„œ ì´ëŠ” ì¿¼ë¦¬ë¬¸ì˜ ì„±ëŠ¥ê³¼ ë¹„ìš© ê´€ë¦¬ì— ë§¤ìš° ë¶€ì •ì ì¸ ì˜í–¥ì„ ë¼ì¹˜ê²Œ ë©ë‹ˆë‹¤.</p>

<h1 id="3-static-mau">3. Static MAU</h1>

<p>Static MAUëŠ” ì œê°€ ì§ì ‘ ë§ˆìŒëŒ€ë¡œ ì§€ì–´ë³¸ ìš©ì–´ì¸ë°ìš”. ğŸ˜… Rolling MAUì—ì„œ ê²ªì€ ë¬¸ì œì ì— ëŒ€í•´ ë‹¤ìŒê³¼ ê°™ì€ ë°©ì‹ìœ¼ë¡œ íƒ€í˜‘ì„ í•´ë´¤ìŠµë‹ˆë‹¤.</p>

<p><img src="/assets/2023-11-19-static-vs-rolling-stickiness/cat.webp" alt="" /></p>
<blockquote>
  <p><a href="https://www.reddit.com/r/ProgrammerHumor/comments/szxooa/the_difference_between_dynamic_vs_static_ip/?rdt=33714">Source</a></p>
</blockquote>

<p><strong>â€œì–´ì©” ìˆ˜ ì—†ë„¤. ê·¸ëŸ¼, MAUëŠ” Rolling ë°©ì‹ì´ ì•„ë‹Œ ê° ì›” ë³„ë¡œ Staticí•˜ê²Œ ì§‘ê³„í•´ë³´ì!â€</strong></p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">WITH</span>
<span class="n">CTE_static_mau</span> <span class="k">AS</span> <span class="p">(</span>
   <span class="k">SELECT</span>
      <span class="n">DATE_TRUNC</span><span class="p">(</span><span class="s1">'MONTH'</span><span class="p">,</span> <span class="nb">date</span><span class="p">)</span> <span class="k">AS</span> <span class="k">month</span><span class="p">,</span>
      <span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="n">user_id</span><span class="p">)</span> <span class="k">AS</span> <span class="n">static_mau</span>
   <span class="k">FROM</span>
      <span class="n">session_starts</span>
   <span class="k">GROUP</span> <span class="k">BY</span>
      <span class="mi">1</span>
   <span class="k">ORDER</span> <span class="k">BY</span>
      <span class="mi">1</span>
<span class="p">)</span>
<span class="k">SELECT</span>
   <span class="o">*</span>
<span class="k">FROM</span>
   <span class="n">CTE_static_mau</span>
<span class="p">;</span>
</code></pre></div></div>

<p>Static MAUëŠ” Rolling MAUì— ë¹„í•´ ë‹¤ìŒê³¼ ê°™ì€ ì¥/ë‹¨ì ì´ ì¡´ì¬í•  ê²ƒ ê°™ìŠµë‹ˆë‹¤.</p>
<ul>
  <li><strong>ì¥ì </strong>: ì¿¼ë¦¬ ë¹„ìš©ì´ í¬ê²Œ ì ˆê°ë˜ê³  ì—°ì‚° ì†ë„ê°€ ë¹¨ë¼ì§‘ë‹ˆë‹¤.</li>
  <li><strong>ë‹¨ì </strong>: ì¿¼ë¦¬ê°€ ì‹¤í–‰ë˜ëŠ” ì‹œì  ë‹¹ì›”ì˜ ê²½ìš°, ì›”ë§ì´ ë„ë˜í•˜ê¸° ì „ê¹Œì§€ëŠ” MAUê°€ ê³¼ì†Œí‰ê°€ë˜ì–´ ë°ì´í„° ë¶„ì„ì˜ Freshnessê°€ ì €í•˜ë©ë‹ˆë‹¤. ì¦‰, ì˜¤ëŠ˜ì´ 1ì›” 2ì¼ì´ë¼ë©´ 1ì›”ì˜ MAUëŠ” 1ì›” 1ì¼ë¶€í„° 1ì›” 2ì¼ê¹Œì§€ë§Œ ì§‘ê³„ë˜ê² ì£ .</li>
</ul>

<h1 id="4-stickiness-ì§€í‘œ">4. Stickiness ì§€í‘œ</h1>

<p>í•œí¸, í”íˆ <code class="language-plaintext highlighter-rouge">DAUâ—MAU</code>ë¡œ í‘œí˜„ë˜ëŠ” Stickiness(ì‚¬ìš©ì ê³ ì°©ë„)ë¥¼ ì¸¡ì •í•˜ëŠ” ê²½ìš°ì—ëŠ” Staticê³¼ Rolling ë°©ì‹ ì‚¬ì´ì˜ ê³ ë¯¼ì´ ë”ìš± ê¹Šì–´ì§€ê²Œ ë©ë‹ˆë‹¤.</p>

<p>Stickiness ì§€í‘œëŠ” í† ìŠ¤, Instagram, YouTube, TikTok, ë¸”ë¼ì¸ë“œ ë“± í™œì„± ì‚¬ìš©ìë“¤ì´ ìŠµê´€ì ìœ¼ë¡œ ì•±ì— ë°©ë¬¸í•¨ìœ¼ë¡œì¨ ê´‘ê³  ë…¸ì¶œ íš¨ê³¼ ë“±ì„ ê·¹ëŒ€í™”í•´ì•¼ í•˜ëŠ” ì„œë¹„ìŠ¤ì—ì„œ ë§¤ìš° ì¤‘ìš”í•œ ì§€í‘œì…ë‹ˆë‹¤. ë‚˜ì˜ê²Œ ë§í•˜ë©´, ì‚¬ìš©ìì˜ ì¤‘ë…ë„ë¥¼ íŒŒì•…í•˜ê¸° ìœ„í•œ ì§€í‘œì¸ ê²ƒì´ì£ . ğŸ˜‚</p>

<p><img src="/assets/2023-11-19-static-vs-rolling-stickiness/facebook.webp" alt="" /></p>
<blockquote>
  <p><a href="https://velog.io/@datarian/retention4">Source</a></p>
</blockquote>

<h1 id="5-rolling-stickiness">5. Rolling Stickiness</h1>

<p>Stickinessë„ ë§ˆì°¬ê°€ì§€ë¡œ, Rolling Stickinessì™€ Static Stickinessë¡œ êµ¬ë¶„í•˜ì—¬ ì—°ì‚°í•  ìˆ˜ ìˆëŠ”ë°ìš”. (Static Stickinessë„ ì œê°€ ë§ˆìŒëŒ€ë¡œ ì§€ì–´ë³¸ ìš©ì–´ì…ë‹ˆë‹¤.) ë¨¼ì € Rolling Stickiness ì§€í‘œ ì‚°ì¶œì„ ìœ„í•œ ì¿¼ë¦¬ë¬¸ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.
(ì°¸ê³ ë¡œ, ë¶„ëª¨ê°€ 0ì´ ë˜ëŠ” ì¼€ì´ìŠ¤ì˜ ê²½ìš°, 0ìœ¼ë¡œ ë°˜í™˜ë˜ë„ë¡  <code class="language-plaintext highlighter-rouge">COALSECE(TRY(â€¦), 0)</code> í•¨ìˆ˜ë¥¼ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤. í˜¼ë™ì´ ì—†ìœ¼ì‹œê¸¸ ë°”ë„ê²Œìš”! ğŸ™ƒ)</p>

<p>ì´ ê²½ìš° Rolling MAU ì—°ì‚° ë°©ì‹ê³¼ ë§ˆì°¬ê°€ì§€ë¡œ, Outer Tableì˜ ê°  <code class="language-plaintext highlighter-rouge">date</code>ë§ˆë‹¤ ì¼ì¼ì´ Inner Tableì˜ ëª¨ë“   <code class="language-plaintext highlighter-rouge">user_id</code>  ê³ ìœ ê°’ ê°œìˆ˜ë¥¼  <code class="language-plaintext highlighter-rouge">COUNT</code>í•˜ê²Œ ë©ë‹ˆë‹¤. ì¦‰, ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ê³¼ íŠ¸ë˜í”½ ìˆ˜ì¤€ì´ ê¸‰ê²©í•˜ê²Œ ìƒìŠ¹í•  ê²ƒì…ë‹ˆë‹¤.</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">WITH</span>
<span class="n">CTE_rolling_stickiness</span> <span class="k">AS</span> <span class="p">(</span>
   <span class="k">SELECT</span>
      <span class="n">MAIN</span><span class="p">.</span><span class="nb">date</span><span class="p">,</span>
      <span class="n">COALESCE</span><span class="p">(</span>
         <span class="n">TRY</span><span class="p">(</span>
            <span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="n">user_id</span><span class="p">)</span>
            <span class="o">/</span>
            <span class="p">(</span>
               <span class="k">SELECT</span>
                  <span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="n">user_id</span><span class="p">)</span>
               <span class="k">FROM</span>
                  <span class="n">session_start</span> <span class="n">SUB</span>
               <span class="k">WHERE</span>
                  <span class="n">DATE_ADD</span><span class="p">(</span><span class="s1">'DAY'</span><span class="p">,</span> <span class="o">-</span><span class="mi">29</span><span class="p">,</span> <span class="n">MAIN</span><span class="p">.</span><span class="nb">date</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">SUB</span><span class="p">.</span><span class="nb">date</span>
                  <span class="k">AND</span> <span class="n">SUB</span><span class="p">.</span><span class="nb">date</span> <span class="o">&lt;=</span> <span class="n">MAIN</span><span class="p">.</span><span class="nb">date</span>
            <span class="p">)</span>
         <span class="p">),</span>
         <span class="mi">0</span>
      <span class="p">)</span> <span class="k">AS</span> <span class="n">rolling_stickiness</span>
   <span class="k">FROM</span>
      <span class="n">session_starts</span> <span class="n">MAIN</span>
   <span class="k">GROUP</span> <span class="k">BY</span>
      <span class="mi">1</span>
   <span class="k">ORDER</span> <span class="k">BY</span>
      <span class="mi">1</span>
<span class="p">)</span>
<span class="k">SELECT</span>
   <span class="o">*</span>
<span class="k">FROM</span>
   <span class="n">CTE_rolling_stickiness</span>
<span class="p">;</span>
</code></pre></div></div>

<h1 id="6-static-stickiness">6. Static Stickiness</h1>

<p>ê·¸ëŸ¬ë‚˜ Static Stickiness ë°©ì‹ìœ¼ë¡œ ì ‘ê·¼í•  ê²½ìš° ì¿¼ë¦¬ë¬¸ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤. DAUì™€ Static MAUë¥¼ Inline Viewë¡œ ë¨¼ì € ê³„ì‚°í•œ í›„, ê° ì¼ì ë³„  <code class="language-plaintext highlighter-rouge">dau</code>ë¥¼ ê³ ì •ëœ ì›”ì˜  <code class="language-plaintext highlighter-rouge">mau</code>ë¡œ ë‚˜ëˆ„ì–´ì£¼ëŠ” ë°©ì‹ì…ë‹ˆë‹¤. ì´ ê²½ìš°, ì¿¼ë¦¬ ë¹„ìš©ê³¼ ì—°ì‚° ì†ë„ë¥¼ í¬ê²Œ ê°œì„ í•  ìˆ˜ ìˆê²Œ ë©ë‹ˆë‹¤.</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">WITH</span>
<span class="n">CTE_dau</span> <span class="k">AS</span> <span class="p">(</span>
   <span class="k">SELECT</span>
      <span class="nb">date</span><span class="p">,</span>
      <span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="n">user_id</span><span class="p">)</span> <span class="k">AS</span> <span class="n">dau</span>
   <span class="k">FROM</span>
      <span class="n">session_starts</span>
   <span class="k">GROUP</span> <span class="k">BY</span>
      <span class="mi">1</span>
<span class="p">),</span>
<span class="n">CTE_static_mau</span> <span class="k">AS</span> <span class="p">(</span>
   <span class="k">SELECT</span>
      <span class="n">DATE_TRUNC</span><span class="p">(</span><span class="s1">'MONTH'</span><span class="p">,</span> <span class="nb">date</span><span class="p">)</span> <span class="k">AS</span> <span class="k">month</span><span class="p">,</span>
      <span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="n">user_id</span><span class="p">)</span> <span class="k">AS</span> <span class="n">static_mau</span>
   <span class="k">FROM</span>
      <span class="n">session_starts</span>
   <span class="k">GROUP</span> <span class="k">BY</span>
      <span class="mi">1</span>
<span class="p">),</span>
<span class="n">CTE_static_stickiness</span> <span class="k">AS</span> <span class="p">(</span>
   <span class="k">SELECT</span>
      <span class="n">dau</span><span class="p">.</span><span class="nb">date</span><span class="p">,</span>
      <span class="n">COALESCE</span><span class="p">(</span>
         <span class="n">TRY</span><span class="p">(</span><span class="n">dau</span><span class="p">.</span><span class="n">dau</span> <span class="o">/</span> <span class="n">static_mau</span><span class="p">.</span><span class="n">static_mau</span><span class="p">),</span>
         <span class="mi">0</span>
      <span class="p">)</span> <span class="k">AS</span> <span class="n">static_stickiness</span>
   <span class="k">FROM</span>
      <span class="n">dau</span>
   <span class="k">LEFT</span> <span class="k">JOIN</span>
      <span class="n">static_mau</span>
      <span class="k">ON</span> <span class="n">DATE_TRUNC</span><span class="p">(</span><span class="s1">'MONTH'</span><span class="p">,</span> <span class="n">dau</span><span class="p">.</span><span class="nb">date</span><span class="p">)</span> <span class="o">=</span> <span class="n">static_mau</span><span class="p">.</span><span class="k">month</span>
   <span class="k">ORDER</span> <span class="k">BY</span>
      <span class="mi">1</span>
<span class="p">)</span>
<span class="k">SELECT</span>
   <span class="o">*</span>
<span class="k">FROM</span>
   <span class="n">CTE_static_stickiness</span>
<span class="p">;</span>
</code></pre></div></div>

<p>ë¬¼ë¡ , Static StickinessëŠ” Rolling Stickinessì— ë¹„í•´ ë‹¤ìŒê³¼ ê°™ì€ ì¥/ë‹¨ì ì´ ì¡´ì¬í•©ë‹ˆë‹¤.</p>
<ul>
  <li><strong>ì¥ì </strong>: ì¿¼ë¦¬ ë¹„ìš©ì´ í¬ê²Œ ì ˆê°ë˜ê³  ì—°ì‚° ì†ë„ê°€ ë¹¨ë¼ì§‘ë‹ˆë‹¤.</li>
  <li><strong>ë‹¨ì </strong>: ë‹¹ì›”ì˜ ê²½ìš°, ì›”ë§ì´ ë„ë˜í•˜ê¸° ì „ê¹Œì§€ëŠ” MAUê°€ ê³¼ì†Œí‰ê°€ë˜ì–´ Stickinessê°€ ë¹„ì •ìƒì ìœ¼ë¡œ ë†’ì€ ê°’ìœ¼ë¡œ ì¸¡ì •ë©ë‹ˆë‹¤. ì¦‰, ì˜¤ëŠ˜ì´ 1ì›” 1ì¼ì´ë¼ë©´,  <code class="language-plaintext highlighter-rouge">DAU=MAU</code>  ì´ë¯€ë¡œ  <code class="language-plaintext highlighter-rouge">Stickiness=100%</code>ì¸ ë§ë„ ì•ˆë˜ëŠ” ìˆ˜ì¹˜ê°€ ëŒ€ì‹œë³´ë“œì— í‘œì‹œë  ê²ƒì…ë‹ˆë‹¤.ğŸ˜¨</li>
</ul>

<p><code class="language-plaintext highlighter-rouge">Stickiness=100%</code>  ë¡œ í‘œí˜„ë˜ë©´, ì‚¬ë‚´ êµ¬ì„±ì›ë“¤ì—ê²Œ ì˜ëª»ëœ ì˜ì‚¬ê²°ì •ì˜ ê·¼ê±°ë¥¼ ì „ë‹¬í•˜ê²Œ ë  ìœ„í—˜ì„±ì´ ì¡´ì¬í•©ë‹ˆë‹¤. ë”°ë¼ì„œ, Static Stickiness ë°©ì‹ì„ ì‚¬ë‚´ì— ë„ì…í•˜ê²Œ ë  ê²½ìš°, ë§¤ì›” ì´ˆ ìì •ì—ë§Œ Appendingë˜ë„ë¡ í•˜ëŠ” ìŠ¤ì¼€ì¤„ë§ì„ ë‘ì–´ì•¼ í•  ê²ƒì…ë‹ˆë‹¤. ì¦‰, 1ì›” 1ì¼ë¶€í„° 1ì›” 31ì¼ê¹Œì§€ì˜ Stickiness ì§€í‘œëŠ” 2ì›” 1ì¼ì´ ë˜ì–´ì•¼ë§Œ ëŒ€ì‹œë³´ë“œì— í‘œí˜„ë˜ëŠ” ê²ƒì´ì£ . ê·¸ë ‡ë‹¤ë©´, Stickiness ì§€í‘œëŠ” ìµœëŒ€ 30ì¼ ì´ìƒ ì§€ì—°ë˜ì–´ ì„œë¹„ìŠ¤ì˜ ì‹ ì†í•œ Action Itemì„ ì‹¤í–‰í•˜ê¸°ê°€ ì–´ë ¤ì›Œì§ˆ ê²ƒì…ë‹ˆë‹¤. StickinessëŠ” Data Freshnessê°€ ì¤‘ìš”í•œ ì§€í‘œ ì¤‘ í•˜ë‚˜ì¸ë°ë„ ë¶ˆêµ¬í•˜ê³  ë§ì´ì£ .</p>

<h1 id="7-data-martë¥¼-í†µí•´-rolling-mau-ë„ì…í•˜ê¸°">7. Data Martë¥¼ í†µí•´ Rolling MAU ë„ì…í•˜ê¸°</h1>

<p>ê·¸ëŸ¬ë©´ ëŒ€ì•ˆì´ ì—†ì„ê¹Œìš”? ì—†ìœ¼ë©´ ì œê°€ ì´ ê¸€ì„ ì•ˆ ì¼ê² ì£ .ğŸ¤­ Data Mart ë‚´ì— Incremental Strategyë¥¼ ì ìš©í•œ <code class="language-plaintext highlighter-rouge">rolling_mau</code>  í…Œì´ë¸” ìŠ¤ì¼€ì¤„ë§ì„ êµ¬ì¶•í•œë‹¤ë©´ ì•ì„œ ì–¸ê¸‰í•œ Rolling Stickinessì˜ ì¹˜ëª…ì ì¸ ë‹¨ì ì„ ê°œì„ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê°€ë ¹, ë‹¤ìŒê³¼ ê°™ì´ ë§¤ì¼ ìì •ì— Appendingë˜ëŠ”  <code class="language-plaintext highlighter-rouge">fact_rolling_mau</code>  í…Œì´ë¸”ì„ ìƒì„±í•œë‹¤ê³  ê°€ì •í•´ë³´ê² ìŠµë‹ˆë‹¤.</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">WITH</span>
<span class="n">fact_rolling_mau</span> <span class="k">AS</span> <span class="p">(</span>
   <span class="k">SELECT</span>
      <span class="n">DATE_ADD</span><span class="p">(</span><span class="s1">'DAY'</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="k">CURRENT_DATE</span><span class="p">)</span> <span class="k">AS</span> <span class="nb">date</span><span class="p">,</span>
      <span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="n">user_id</span><span class="p">)</span> <span class="k">AS</span> <span class="n">rolling_mau</span>
   <span class="k">FROM</span>
      <span class="n">session_starts</span>
   <span class="k">WHERE</span>
      <span class="n">DATE_ADD</span><span class="p">(</span><span class="s1">'DAY'</span><span class="p">,</span> <span class="o">-</span><span class="mi">30</span><span class="p">,</span> <span class="k">CURRENT_DATE</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="nb">date</span>
      <span class="k">AND</span> <span class="nb">date</span> <span class="o">&lt;=</span> <span class="n">DATE_ADD</span><span class="p">(</span><span class="s1">'DAY'</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="k">CURRENT_DATE</span><span class="p">)</span>
<span class="p">)</span>
<span class="k">SELECT</span>
   <span class="o">*</span>
<span class="k">FROM</span>
   <span class="n">fact_rolling_mau</span>
<span class="p">;</span>
</code></pre></div></div>

<p>ì¦‰ ë‹¤ìŒê³¼ ê°™ì´,  <code class="language-plaintext highlighter-rouge">fact_rolling_mau</code>  í…Œì´ë¸”ì€ ì¤‘ë³µ ì—°ì‚° ë¬¸ì œë¥¼ ë²—ì–´ë‚œ ì±„ ë§¤ì¼ ìƒˆë¡œìš´  <code class="language-plaintext highlighter-rouge">rolling_mau</code>  ê°’ì„ ì—…ë°ì´íŠ¸í•˜ê²Œ ë©ë‹ˆë‹¤.</p>

<table>
  <thead>
    <tr>
      <th><strong>date</strong></th>
      <th><strong>rolling_mau</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>2023-01-01</td>
      <td>100,000</td>
    </tr>
    <tr>
      <td>2023-01-01</td>
      <td>101,000</td>
    </tr>
    <tr>
      <td>â€¦</td>
      <td>â€¦</td>
    </tr>
    <tr>
      <td>2023-01-01</td>
      <td>99,700</td>
    </tr>
    <tr>
      <td>2023-01-01</td>
      <td>110,000</td>
    </tr>
    <tr>
      <td>â€¦</td>
      <td>â€¦</td>
    </tr>
  </tbody>
</table>

<p>ì´ì œ ì´ë¯¸ ìƒì„±ëœ  <code class="language-plaintext highlighter-rouge">fact_rolling_mau</code>  í…Œì´ë¸”ì„ í†µí•´ Rolling Stickinessë¥¼ ê³„ì‚°í•˜ëŠ” ì¿¼ë¦¬ë¬¸ì„ ì‘ì„±í•˜ë©´ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">WITH</span>
<span class="n">CTE_dau</span> <span class="k">AS</span> <span class="p">(</span>
   <span class="k">SELECT</span>
      <span class="nb">date</span><span class="p">,</span>
      <span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="n">user_id</span><span class="p">)</span> <span class="k">AS</span> <span class="n">dau</span>
   <span class="k">FROM</span>
      <span class="n">session_starts</span>
   <span class="k">GROUP</span> <span class="k">BY</span>
      <span class="mi">1</span>
<span class="p">),</span>
<span class="n">CTE_rolling_stickiness</span> <span class="k">AS</span> <span class="p">(</span>
   <span class="k">SELECT</span>
      <span class="n">dau</span><span class="p">.</span><span class="nb">date</span><span class="p">,</span>
      <span class="n">COALESCE</span><span class="p">(</span>
         <span class="n">TRY</span><span class="p">(</span><span class="n">dau</span><span class="p">.</span><span class="n">dau</span> <span class="o">/</span> <span class="n">fact_rolling_mau</span><span class="p">.</span><span class="n">rolling_mau</span><span class="p">),</span>
         <span class="mi">0</span>
      <span class="p">)</span> <span class="k">AS</span> <span class="n">rolling_stickiness</span>
   <span class="k">FROM</span>
      <span class="n">CTE_dau</span>
   <span class="k">LEFT</span> <span class="k">JOIN</span>
      <span class="n">fact_rolling_mau</span>
      <span class="k">ON</span> <span class="n">dau</span><span class="p">.</span><span class="nb">date</span> <span class="o">=</span> <span class="n">rolling_mau</span><span class="p">.</span><span class="nb">date</span>
   <span class="k">ORDER</span> <span class="k">BY</span>
      <span class="mi">1</span>
<span class="p">)</span>
<span class="k">SELECT</span>
   <span class="o">*</span>
<span class="k">FROM</span>
   <span class="n">CTE_rolling_stickiness</span>
<span class="p">;</span>
</code></pre></div></div>

<h1 id="8-ê²°ë¡ -query-cost-vs-data-freshness">8. ê²°ë¡ : Query Cost vs Data Freshness</h1>

<p>ê²°êµ­ Rolling MAU, Rolling Stickiness ì§€í‘œì— ëŒ€í•œ ì´ì•¼ê¸°ë¥¼ ë‹¤ë£¨ë‹¤ë³´ë‹ˆ ìì—°ìŠ¤ëŸ½ê²Œ Data Martì˜ í•„ìš”ì„±ìœ¼ë¡œ ê·€ê²°ë˜ëŠ” ê²ƒ ê°™ìŠµë‹ˆë‹¤. Data MartëŠ” ë‹¨ìˆœíˆ ì¿¼ë¦¬ ê²°ê³¼ì˜ ì •í™•ì„±ì´ë‚˜ ì¼ê´€ì„±ë§Œì„ ìœ„í•´ í•„ìš”í•œ ê²ƒì´ ì•„ë‹ˆë¼, ì´ì²˜ëŸ¼ Query Cost vs Data Freshness ì‚¬ì´ì˜ ìƒì¶© ê´€ê³„ë¥¼ ê·¹ë³µí•˜ê¸° ìœ„í•´ì„œë„ í•„ìš”í•˜ë‹¤ê³  í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. íŠ¹íˆ, ì„œë¹„ìŠ¤ì˜ ì‚¬ìš© ê·œëª¨ì— ë”°ë¼ ì†ŒìŠ¤ í…Œì´ë¸”ì˜ ì‚¬ì´ì¦ˆê°€ ë°©ëŒ€í•´ì§ˆìˆ˜ë¡ Data Martì˜ í™œìš©ì€ í•„ìˆ˜ì ì¼ ê²ƒì…ë‹ˆë‹¤. ë¶€ì¡±í•œ ê¸€ì„ ì½ì–´ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤!</p>

<hr />

<h2 id="published-by-joshua-kim"><em>Published by</em> Joshua Kim</h2>
<p><img src="/assets/profile/joshua-profile.png" alt="Joshua Kim" /></p>]]></content><author><name></name></author><category term="korean" /><category term="data_analytics" /><category term="sql" /><category term="date_warehouse" /><summary type="html"><![CDATA[ëŒ€ê³ ê° ì„œë¹™ì„ ìœ„í•´ ì—„ì²­ë‚˜ê²Œ í° ì‚¬ì´ì¦ˆì˜ ì†ŒìŠ¤ í…Œì´ë¸”ë¡œë¶€í„° ìµœì í™”ëœ ë°ì´í„° ë§ˆíŠ¸ ì„¤ê³„ ê³ ë¯¼ì„ ë§ì´ í•˜ê³  ìˆëŠ” ë§Œí¼, Stickiness ì§€í‘œ ì‚¬ë¡€ë¥¼ ì¤‘ì‹¬ìœ¼ë¡œ SQL ì„±ëŠ¥ì— ëŒ€í•œ ì´ì•¼ê¸°ë¥¼ ë“¤ë ¤ë“œë¦¬ê² ìŠµë‹ˆë‹¤.]]></summary></entry><entry><title type="html">Near Protocol: Account Model and Transaction Story</title><link href="http://localhost:4000/near-protocol/" rel="alternate" type="text/html" title="Near Protocol: Account Model and Transaction Story" /><published>2023-11-18T00:00:00+09:00</published><updated>2023-11-18T00:00:00+09:00</updated><id>http://localhost:4000/near-protocol</id><content type="html" xml:base="http://localhost:4000/near-protocol/"><![CDATA[<blockquote>
  <p>Dive into the intricate world of blockchain with Joshua. Uncover the complexities of Near Protocolâ€™s account model, transaction stories, and personal insights. This article offers a captivating exploration of addresses, private keys, and the execution flow of transactions, providing a unique perspective on user experience and protocol design. Join me on this insightful journey, backed by personal research and a wealth of references from the blockchain realm.</p>
</blockquote>

<h3 id="contents">CONTENTS</h3>
<ol>
  <li>Account Model Story
    <ul>
      <li>1.1. Addresses</li>
      <li>1.2. Private Keys</li>
      <li>1.3. A Sample UX Case</li>
    </ul>
  </li>
  <li>Transaction Story
    <ul>
      <li>2.1. Transactions</li>
      <li>2.2. Actions</li>
      <li>2.3. Receipts</li>
      <li>2.4. A Sample Transactions Case</li>
    </ul>
  </li>
  <li>Personal Thoughts</li>
  <li>References</li>
</ol>

<hr />

<h3 id="disclaimer">DISCLAIMER</h3>
<blockquote>
  <p>This material is based on personal research and study; therefore, it may contain factual errors and cannot be relied upon for critical decision-making. Additionally, the opinions in the material are purely subjective and have no connection to any past or current companies that I have worked at.</p>
</blockquote>

<h1 id="1-account-model-story">1. Account Model Story</h1>

<p><img src="/assets/2023-11-18-near-protocol/account-model-story.webp" alt="" /></p>
<blockquote>
  <p><a href="https://docs.near.org/concepts/basics/accounts/model">Source</a></p>
</blockquote>

<h2 id="11-addresses">1.1. Addresses</h2>

<h3 id="there-are-two-types-of-accounts">There are Two Types of Accounts.</h3>

<p><strong>1. Named Account</strong></p>
<ul>
  <li>i.e.,  <code class="language-plaintext highlighter-rouge">alice.near</code>,  <code class="language-plaintext highlighter-rouge">bob.near</code>,  <code class="language-plaintext highlighter-rouge">usa.near</code>,  <code class="language-plaintext highlighter-rouge">texas.usa.near</code></li>
  <li>Formatically Same as DNS</li>
  <li>ğŸ™†ğŸ»â€â™‚ï¸  <code class="language-plaintext highlighter-rouge">usa.near</code>  â†’  <code class="language-plaintext highlighter-rouge">texas.usa.near</code>  can be created.</li>
  <li>ğŸ™…ğŸ»â€â™‚ï¸  <code class="language-plaintext highlighter-rouge">usa.near</code>  â†’  <code class="language-plaintext highlighter-rouge">texas.uk.near</code>  can NOT be created.</li>
</ul>

<p><strong>2. Implicit Account</strong></p>
<ul>
  <li>i.e.,  <code class="language-plaintext highlighter-rouge">98793cd91a3f870fb126f662858[...]</code></li>
  <li>Formatically Similar to the Traditional Way to Create Addresses such as Bitcoin and Ethereum (64 letters)</li>
</ul>

<h3 id="personal-thoughts">Personal Thoughts</h3>

<p><strong>1. Named Account</strong></p>
<ul>
  <li>Improves the end-user UX of the product because itâ€™s easy to memorize!</li>
  <li>While ENS is executed at the  <strong>contract layer</strong>, Nearâ€™s Named Account is executed at the  <strong>protocol layer</strong>.</li>
</ul>

<p><strong>2. Implicit Account</strong></p>
<ul>
  <li>For user groups that want to maintain pseudonymization!</li>
  <li>For developers accustomed to traditional address systems, especially hardware wallet service companies</li>
</ul>

<h2 id="12-private-keys">1.2. Private Keys</h2>

<h3 id="there-are-two-types-of-private-keys">There are Two Types of Private Keys.</h3>

<p><img src="/assets/2023-11-18-near-protocol/private-keys.webp" alt="" /></p>
<blockquote>
  <p><a href="https://www.vitalpoint.ai/understanding-near-keys/">Source</a></p>
</blockquote>

<p><strong>1. Full Access Key</strong></p>
<blockquote>
  <p><strong>The address can be used to sign transactions of all types.</strong></p>
</blockquote>

<ul>
  <li>The 8 Types of Transactions (<code class="language-plaintext highlighter-rouge">Transaction Actions</code>)
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Transfer</span><span class="p">,</span> <span class="c1"># Transfer Tokens  
</span><span class="n">CreateAccount</span><span class="p">,</span> <span class="c1"># Create Accounts  
</span><span class="n">DeleteAccount</span><span class="p">,</span> <span class="c1"># Delete Accounts  
</span><span class="n">DeployContract</span><span class="p">,</span> <span class="c1"># Deploy Contracts  
</span><span class="n">FunctionCall</span><span class="p">,</span> <span class="c1"># Call Functions of Contracts  
</span><span class="n">Stake</span><span class="p">,</span> <span class="c1"># Staking  
</span><span class="n">AddKey</span><span class="p">,</span> <span class="c1"># Add Keys  
</span><span class="n">DeleteKey</span> <span class="c1"># Delete Keys
</span></code></pre></div>    </div>
  </li>
</ul>

<p><strong>2. Function Call Key</strong></p>
<blockquote>
  <p><strong>The address can be used to sign the following restricted transactions.</strong></p>
</blockquote>

<ul>
  <li>Transactions are restricted to  <strong>specific function(s)</strong>  within  <strong>a specific contract</strong>.</li>
  <li>Sending Native Token, $NEAR, is NOT possible.
    <ul>
      <li>Gas Fees can be paid, however.</li>
      <li>Of course, if you set it so that you canâ€™t even pay Gas Fees, only functions related to View methods can be called.</li>
    </ul>
  </li>
  <li>Purpose of Using Function Call Keys
    <ul>
      <li>By passing it to the dAppâ€™s client, creating an environment where the dApp can immediately invoke contract calls with limited permissions.</li>
    </ul>
  </li>
</ul>

<h3 id="parameters">Parameters</h3>

<p><strong>1. Full Access Key</strong></p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">pub</span> <span class="kr">enum</span> <span class="nx">AccessKeyPermission</span> <span class="p">{</span>  
    <span class="nc">FunctionCall</span><span class="p">(</span><span class="nx">FunctionCallPermission</span><span class="p">),</span>  
    <span class="nx">FullAccess</span><span class="p">,</span>  
<span class="p">}</span>
</code></pre></div></div>

<p><strong>2. Function Call Key</strong></p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">pub</span> <span class="nx">struct</span> <span class="nx">FunctionCallPermission</span> <span class="p">{</span>  
    <span class="nx">pub</span> <span class="nx">receiver_id</span><span class="p">:</span> <span class="nx">AccountId</span><span class="p">,</span> <span class="c1">// a Specific Contract  </span>
    <span class="nx">pub</span> <span class="nx">method_names</span><span class="p">:</span> <span class="nx">Vec</span><span class="o">&lt;</span><span class="nb">String</span><span class="o">&gt;</span><span class="p">,</span> <span class="c1">// Specific Functions  </span>
    <span class="nx">pub</span> <span class="nx">allowance</span><span class="p">:</span> <span class="nx">Option</span><span class="o">&lt;</span><span class="nx">Balance</span><span class="o">&gt;</span><span class="p">,</span> <span class="c1">// Max Gas Fee Payment Amount  </span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="locked-account">Locked Account</h3>
<ul>
  <li>Simply remove all keys through the transaction of the  <code class="language-plaintext highlighter-rouge">DeleteKey</code>  action.</li>
  <li>No one will be able to control the account.</li>
  <li>In other words, after deploying the smart contract account itself, it can be made fully decentralized, allowing only internal transactions to occur.</li>
</ul>

<h2 id="13-a-sample-ux-case">1.3. A Sample UX Case</h2>

<h3 id="typical-dapp-transaction-signing-architecture">Typical dApp Transaction Signing Architecture</h3>

<p><img src="/assets/2023-11-18-near-protocol/Typical dApp Transaction Signing Architecture.webp" alt="" /></p>
<blockquote>
  <p><a href="https://docs.near.org/concepts/web3/near">Source</a></p>
</blockquote>

<ul>
  <li>To execute a specific transaction within the dApp, the user must undergo repeated redirection between the wallet and the client.</li>
  <li><strong>Advantage</strong>: Excellent  <strong>security</strong>  as the private key is not exposed to the client.</li>
  <li><strong>Disadvantage</strong>: Repeated redirections can be annoying for  <strong>users</strong>.</li>
</ul>

<h3 id="dapp-transaction-signing-architecture-using-function-call-key">dApp Transaction Signing Architecture Using Function Call Key</h3>
<blockquote>
  <p>It is possible to address the Disadvantage without significantly compromising the Advantage.</p>
</blockquote>

<p><strong>1. Add Key</strong></p>

<p><img src="/assets/2023-11-18-near-protocol/add-key.webp" alt="" /></p>
<blockquote>
  <p><a href="https://docs.near.org/concepts/web3/near">Source</a></p>
</blockquote>

<p><strong>2. Call a Specific Function within a dAppâ€™s Contract</strong></p>

<p><img src="/assets/2023-11-18-near-protocol/call a specific function within a dapps contract.webp" alt="" /></p>
<blockquote>
  <p><a href="https://docs.near.org/concepts/web3/near">Source</a></p>
</blockquote>

<h1 id="2-transaction-story">2. Transaction Story</h1>

<p><strong>Overall Execution Flow of the Transactions</strong></p>

<p><img src="/assets/2023-11-18-near-protocol/transaction-story.webp" alt="" /></p>
<blockquote>
  <p><a href="https://www.youtube.com/@NEARProtocol">Source</a></p>
</blockquote>

<p><strong>Important Terms</strong></p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">Transaction</code></li>
  <li><code class="language-plaintext highlighter-rouge">Action</code></li>
  <li><code class="language-plaintext highlighter-rouge">Receipt</code></li>
</ul>

<h2 id="21-transactions">2.1. Transactions</h2>
<p><strong>A Transaction is:</strong></p>
<ul>
  <li>a set of  <code class="language-plaintext highlighter-rouge">actions</code>  that need to be performed on the receiving account.</li>
  <li>ğŸ™…ğŸ»â€â™‚ï¸ In other words, a transaction is NOT the atomic unit driving state changes in Near Blockchain.</li>
</ul>

<h2 id="22-actions">2.2. Actions</h2>
<p><strong>An Action is:</strong></p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">the unit of work</code>  that the virtual machine needs to process through a transaction.</li>
  <li>There are a total of 8 types recognizable by the Near Protocol. (You have already checked them above!)</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Transfer</span><span class="p">,</span> <span class="c1"># Transfer Tokens  
</span><span class="n">CreateAccount</span><span class="p">,</span> <span class="c1"># Create Accounts  
</span><span class="n">DeleteAccount</span><span class="p">,</span> <span class="c1"># Delete Accounts  
</span><span class="n">DeployContract</span><span class="p">,</span> <span class="c1"># Deploy Contracts  
</span><span class="n">FunctionCall</span><span class="p">,</span> <span class="c1"># Call Functions of Contracts  
</span><span class="n">Stake</span><span class="p">,</span> <span class="c1"># Staking  
</span><span class="n">AddKey</span><span class="p">,</span> <span class="c1"># Add Keys  
</span><span class="n">DeleteKey</span> <span class="c1"># Delete Keys
</span></code></pre></div></div>

<h2 id="23-receipts">2.3. Receipts</h2>
<p><strong>A Receipt is:</strong></p>
<ul>
  <li>the smallest unit executed by the virtual machine, in other words,  <code class="language-plaintext highlighter-rouge">the execution object</code>.</li>
</ul>

<h2 id="24-a-sample-transaction-case">2.4. A Sample Transaction Case</h2>

<h3 id="a-randomly-chosen-transaction-case">A Randomly Chosen Transaction Case</h3>

<p><strong>1. A Transaction Sending 0.02 NEAR</strong></p>

<p><img src="/assets/2023-11-18-near-protocol/A Transaction Sending 0.02 NEAR.webp" alt="" /></p>
<blockquote>
  <p><a href="https://nearblocks.io/txns/6aqjvabatzFkvoBzYmnpEZbAfnLbGo6PsUM6WdpUYxmG#">Source</a></p>
</blockquote>

<p><strong>2. Receipt Executions - (1) TRANSFER Action</strong></p>

<p><img src="/assets/2023-11-18-near-protocol/Receipt Executions TRANSFER Action.webp" alt="" /></p>
<blockquote>
  <p><a href="https://nearblocks.io/txns/6aqjvabatzFkvoBzYmnpEZbAfnLbGo6PsUM6WdpUYxmG#">Source</a></p>
</blockquote>

<p><strong>2. Receipt Executions - (2) Receiving a Refund for the difference between Gas Limit and Gas Used</strong></p>

<p><img src="/assets/2023-11-18-near-protocol/Receipt Executions Receiving a Refund for the difference between Gas Limit and Gas Used.webp" alt="" /></p>
<blockquote>
  <p><a href="https://nearblocks.io/txns/6aqjvabatzFkvoBzYmnpEZbAfnLbGo6PsUM6WdpUYxmG#">Source</a></p>
</blockquote>

<h1 id="3-personal-thoughts">3. Personal Thoughts</h1>

<h3 id="1-protocolized-address-system-for-dns">1. Protocolized Address System for DNS</h3>

<p>It seems that the computational burden on nodes has been compromised to become a user-friendly blockchain. (Due to the increased size of dtypeâ€¦)</p>
<ul>
  <li>Wouldnâ€™t there be a slowdown and an increase in gas fees then?</li>
  <li>It seems that this has been addressed by dividing a block into multiple chunks to create the block.</li>
  <li>Let me study deeper when I have more expertise to check out if there are any potential security drawbacks of this approach. ğŸ˜</li>
</ul>

<p><img src="/assets/2023-11-18-near-protocol/nightshade.webp" alt="" /></p>
<blockquote>
  <p><a href="https://near.org/papers/nightshade">Source</a></p>
</blockquote>

<h3 id="2-key-generation-structure-for-dapp-end-user-ux">2. Key Generation Structure for dApp End-User UX</h3>

<p>Of course, in the initial Add Key situation, wallet redirection still occurs, so it may not be possible to completely alleviate user confusion.</p>
<ul>
  <li>ğŸ—£ï¸<strong>Picky Users (say, Joshua)</strong>: â€œEarlier, my signature was required, but why are you executing things now without it?â€ ğŸ˜ ğŸ˜¡</li>
</ul>

<p><img src="/assets/2023-11-18-near-protocol/add-key.webp" alt="" /></p>
<blockquote>
  <p><a href="https://docs.near.org/concepts/web3/near">Source</a></p>
</blockquote>

<h1 id="4-references">4. References</h1>
<ul>
  <li><strong>Near</strong>  <strong>Whitepaper</strong>:  <a href="https://near.org/papers/nightshade">https://near.org/papers/nightshade</a></li>
  <li><strong>Near Official Docs</strong>:  <a href="https://docs.near.org/">https://docs.near.org</a></li>
  <li><strong>Near Official Dev Docs</strong>:  <a href="https://nomicon.io/">https://nomicon.io</a></li>
  <li><strong>Near Official YouTube Channel</strong>:  <a href="https://www.youtube.com/@NEARProtocol">https://www.youtube.com/@NEARProtocol</a></li>
  <li><strong>Blockchain Explorer (Nearblocks)</strong>:  <a href="https://nearblocks.io/">https://nearblocks.io</a></li>
  <li><strong>Vital Point AI Content</strong>:  <a href="https://www.vitalpoint.ai/understanding-near-keys">https://www.vitalpoint.ai/understanding-near-keys</a></li>
</ul>

<p><img src="/assets/2023-11-18-near-protocol/near-logo.webp" alt="" /></p>

<hr />

<h2 id="published-by-joshua-kim"><em>Published by</em> Joshua Kim</h2>
<p><img src="/assets/profile/joshua-profile.png" alt="Joshua Kim" /></p>]]></content><author><name></name></author><category term="english" /><category term="blockchain" /><summary type="html"><![CDATA[Dive into the intricate world of blockchain with Joshua. Uncover the complexities of Near Protocolâ€™s account model, transaction stories, and personal insights. This article offers a captivating exploration of addresses, private keys, and the execution flow of transactions, providing a unique perspective on user experience and protocol design. Join me on this insightful journey, backed by personal research and a wealth of references from the blockchain realm.]]></summary></entry><entry><title type="html">Intro to Encoding &amp;amp; Decoding Ethereum Contract Functions</title><link href="http://localhost:4000/encoding-and-decoding-ethereum-contract-functions/" rel="alternate" type="text/html" title="Intro to Encoding &amp;amp; Decoding Ethereum Contract Functions" /><published>2023-10-16T00:00:00+09:00</published><updated>2023-10-16T00:00:00+09:00</updated><id>http://localhost:4000/encoding-and-decoding-ethereum-contract-functions</id><content type="html" xml:base="http://localhost:4000/encoding-and-decoding-ethereum-contract-functions/"><![CDATA[<blockquote>
  <p>In this article, I will briefly explore the Ethereum ABI Specification and show you how to decode contract functions when conducting on-chain data analysis. Additionally, I will demonstrate a simple data extraction and analysis case about â€œWho are the Top 10 Recipients of USDT approve Functions?â€ using DuneSQL while handling ABIs.</p>
</blockquote>

<h3 id="contents">CONTENTS</h3>
<ol>
  <li>Argument Types Key Content
    <ul>
      <li>1.1. Elementary Types</li>
      <li>1.2. Fixed-size Types</li>
      <li>1.3. Dynamic-size Types</li>
    </ul>
  </li>
  <li>Key Points of Argument Padding to 32 Bytes Rules</li>
  <li>A Contract Example
    <ul>
      <li>3.1. How to Call <code class="language-plaintext highlighter-rouge">baz(uint32 x, bool y)</code></li>
      <li>3.2. How to Call <code class="language-plaintext highlighter-rouge">bar(bytes3[2])</code></li>
      <li>3.3. How to Call <code class="language-plaintext highlighter-rouge">sam(bytes, bool, uint[])</code></li>
    </ul>
  </li>
  <li>Case Study: Who are the Top 10 Recipients of USDT <code class="language-plaintext highlighter-rouge">approve</code> Functions?
    <ul>
      <li>4.1. Function Selector</li>
      <li>4.2. Extract only the transactions that have called the <code class="language-plaintext highlighter-rouge">approve</code> function on the USDT Contract.</li>
      <li>4.3. Extract the first argument value, <code class="language-plaintext highlighter-rouge">address</code>, from the functions.</li>
      <li>4.4. Now, aggregate the number of unique addresses that executed <code class="language-plaintext highlighter-rouge">approve</code> function, grouped by each <code class="language-plaintext highlighter-rouge">approve</code> recipient, over the past week.</li>
      <li>4.5. Label the <code class="language-plaintext highlighter-rouge">approve</code> recipient addresses based on Dune Tables regarding â€œaddress labelingâ€.</li>
      <li>4.6. The Final Query Results</li>
    </ul>
  </li>
  <li>Letâ€™s Conclude!</li>
  <li>References</li>
</ol>

<hr />

<h1 id="1-argument-types-key-content">1. Argument Types Key Content</h1>

<p>Before diving into the Ethereum ABI specification, letâ€™s take a quick look at the argument data types of Ethereum contracts. Ethereum contract functions can have various parameter data types, and among them, I have listed some of the important types and summarize their key characteristics.</p>

<h2 id="11-elementary-types">1.1. Elementary Types</h2>

<p><code class="language-plaintext highlighter-rouge">uint</code></p>
<ul>
  <li>Same as  <code class="language-plaintext highlighter-rouge">uint256</code>,</li>
  <li>which means it should be considered as  <code class="language-plaintext highlighter-rouge">uint256</code>  type during encoding.</li>
</ul>

<p><code class="language-plaintext highlighter-rouge">int</code></p>
<ul>
  <li>Same as  <code class="language-plaintext highlighter-rouge">int256</code>,</li>
  <li>which means it should be considered as  <code class="language-plaintext highlighter-rouge">int256</code>  type during encoding.</li>
</ul>

<p><code class="language-plaintext highlighter-rouge">bool</code></p>
<ul>
  <li>Same as  <code class="language-plaintext highlighter-rouge">uint8</code>,</li>
  <li>which means only 0 or 1 can be assigned to it.</li>
</ul>

<p><code class="language-plaintext highlighter-rouge">bytes{n}</code></p>
<ul>
  <li>Binary type with a length of n bytes (0 &lt; n â‰¤ 32)</li>
</ul>

<h2 id="12-fixed-size-types">1.2. Fixed-size Types</h2>

<p><code class="language-plaintext highlighter-rouge">{type_name}[{n}]</code></p>
<ul>
  <li>An array with n elements (n â‰¥ 0)</li>
</ul>

<h2 id="13-dynamic-size-types">1.3. Dynamic-size Types</h2>

<p><code class="language-plaintext highlighter-rouge">bytes</code></p>
<ul>
  <li>Binary type with a dynamic length of bytes</li>
</ul>

<p><code class="language-plaintext highlighter-rouge">string</code></p>
<ul>
  <li>A dynamically sized string (assuming itâ€™s UTF-8 encoded)</li>
</ul>

<p><code class="language-plaintext highlighter-rouge">{type_name}[]</code></p>
<ul>
  <li>An array with a dynamic number of elements</li>
</ul>

<h1 id="2-key-points-of-argument-padding-to-32-bytes-rules">2. Key Points of Argument Padding to 32 Bytes Rules</h1>

<p>When calling Ethereum contract functions, you need to encode each argument and input them concatenated. In this process, there are rules regarding â€œlength.â€ To avoid confusion, Iâ€™ve summarized the key rules for you in advance.</p>

<p><code class="language-plaintext highlighter-rouge">uint{n}</code></p>
<ul>
  <li>Padding with preceding 0 to achieve a length of 32 bytes</li>
</ul>

<p><code class="language-plaintext highlighter-rouge">int{n}</code></p>
<ul>
  <li>Padding with preceding 0 to achieve a length of 32 bytes</li>
</ul>

<p><code class="language-plaintext highlighter-rouge">bytes{n}</code></p>
<ul>
  <li>Padding with trailing 0 to achieve a length of 32 bytes</li>
</ul>

<h1 id="3-a-contract-example">3. A Contract Example</h1>

<p>The following example has been taken from  <a href="https://docs.soliditylang.org/en/develop/abi-spec.html#examples">Contract ABI Specification Docs</a>. Let me explain this in simpler terms.</p>

<p><strong>Given the Contract:</strong></p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">pragma</span> <span class="nx">solidity</span> <span class="o">^</span><span class="mf">0.4</span><span class="p">.</span><span class="mi">16</span><span class="p">;</span>  
  
<span class="nx">contract</span> <span class="nx">Foo</span> <span class="p">{</span>  
  <span class="kd">function</span> <span class="nf">baz</span><span class="p">(</span><span class="nx">uint32</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">bool</span> <span class="nx">y</span><span class="p">)</span> <span class="kr">public</span> <span class="nx">pure</span> <span class="nf">returns </span><span class="p">(</span><span class="nx">bool</span> <span class="nx">r</span><span class="p">)</span> <span class="p">{</span> <span class="nx">r</span> <span class="o">=</span> <span class="nx">x</span> <span class="o">&gt;</span> <span class="mi">32</span> <span class="o">||</span> <span class="nx">y</span><span class="p">;</span> <span class="p">}</span>  
  <span class="kd">function</span> <span class="nf">bar</span><span class="p">(</span><span class="nx">bytes3</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="kr">public</span> <span class="nx">pure</span> <span class="p">{}</span>  
  <span class="kd">function</span> <span class="nf">sam</span><span class="p">(</span><span class="nx">bytes</span><span class="p">,</span> <span class="nx">bool</span><span class="p">,</span> <span class="nx">uint</span><span class="p">[])</span> <span class="kr">public</span> <span class="nx">pure</span> <span class="p">{}</span>  
<span class="p">}</span>
</code></pre></div></div>

<h2 id="31-how-to-call-bazuint32-x-bool-y">3.1. How to Call <code class="language-plaintext highlighter-rouge">baz(uint32 x, bool y)</code></h2>

<p>Letâ€™s say youâ€™re calling the function in the format of:  <code class="language-plaintext highlighter-rouge">baz(69, true)</code></p>

<p><strong>Function Selector</strong></p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">baz(uint32,bool)</code>  â†’ Keccak-256 Hash
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mh">0xcdcd77c0992ec5bbfc459984220f8c45084cc24d9b6efed1fae540db8de801d2</span>
</code></pre></div>    </div>
  </li>
  <li>Slice the left 4 bytes.
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mh">0xcdcd77c0</span>
</code></pre></div>    </div>
  </li>
</ul>

<p><strong>Parameter 1:</strong>  <code class="language-plaintext highlighter-rouge">69</code></p>
<ul>
  <li>Convert it to hexadecimal.
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mh">0x45</span>
</code></pre></div>    </div>
  </li>
  <li>Left pad it to a length of 32 bytes.
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mh">0x0000000000000000000000000000000000000000000000000000000000000045</span>
</code></pre></div>    </div>
  </li>
</ul>

<p><strong>Parameter 2:</strong>  <code class="language-plaintext highlighter-rouge">true</code></p>
<ul>
  <li>Convert it to uint8.
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mi">1</span>
</code></pre></div>    </div>
  </li>
  <li>Left pad it to a length of 32 bytes.
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mh">0x0000000000000000000000000000000000000000000000000000000000000001</span>
</code></pre></div>    </div>
  </li>
</ul>

<p><strong>The Final Encoding with Concatenating All</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mh">0xcdcd77c0</span> <span class="c1"># Function Selector  
</span><span class="mh">0x0000000000000000000000000000000000000000000000000000000000000045</span> <span class="c1"># 69  
</span><span class="mh">0x0000000000000000000000000000000000000000000000000000000000000001</span> <span class="c1"># true  
</span>  
<span class="c1"># Concat  
</span><span class="mh">0xdcdcd77c000000000000000000000000000000000000000000000000000000000000000450000000000000000000000000000000000000000000000000000000000000001</span>
</code></pre></div></div>

<h2 id="32-how-to-call-barbytes32">3.2. How to Call <code class="language-plaintext highlighter-rouge">bar(bytes3[2])</code></h2>

<p>Letâ€™s say youâ€™re calling the function in the format of:  <code class="language-plaintext highlighter-rouge">baz("abc", "def")</code></p>

<p><strong>Function Selector</strong></p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">bar(bytes3[2])</code>  â†’ Keccak-256 Hash
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mh">0xfce353f601a3db60cb33e4b6ef4f91e4465eaf93c292b64fcde1bf4ba6819b6a</span>
</code></pre></div>    </div>
  </li>
  <li>Slice the left 4 bytes.
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mh">0xfce353f6</span>
</code></pre></div>    </div>
  </li>
</ul>

<p><strong>Parameter 1:</strong>  <code class="language-plaintext highlighter-rouge">â€œabcâ€</code></p>
<ul>
  <li>Convert it to utf-8 bytes (<a href="https://onlinetools.com/utf8/convert-utf8-to-bytes">String to UTF-8 Bytes Convertor</a>)
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mi">616263</span>
</code></pre></div>    </div>
  </li>
  <li>Right pad it to a length of 32 bytes.
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mh">0x6162630000000000000000000000000000000000000000000000000000000000</span>
</code></pre></div>    </div>
  </li>
</ul>

<p><strong>Parameter 2</strong>:  <code class="language-plaintext highlighter-rouge">â€œdefâ€</code></p>
<ul>
  <li>Convert it to utf-8 bytes (<a href="https://onlinetools.com/utf8/convert-utf8-to-bytes">String to UTF-8 Bytes Convertor</a>)
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mi">646566</span>
</code></pre></div>    </div>
  </li>
  <li>Right pad it to a length of 32 bytes.
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mh">0x6465660000000000000000000000000000000000000000000000000000000000</span>
</code></pre></div>    </div>
  </li>
</ul>

<p><strong>The Final Encoding with Concatenating All</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mh">0xfce353f6</span> <span class="c1"># Function Selector  
</span><span class="mi">6162630000000000000000000000000000000000000000000000000000000000</span> <span class="c1"># "abc"  
</span><span class="mi">6465660000000000000000000000000000000000000000000000000000000000</span> <span class="c1"># "def"  
</span>  
<span class="c1"># Concat  
</span><span class="mh">0xfce353f661626300000000000000000000000000000000000000000000000000000000006465660000000000000000000000000000000000000000000000000000000000</span>
</code></pre></div></div>

<h2 id="33-how-to-call-sambytes-bool-uint">3.3. How to Call <code class="language-plaintext highlighter-rouge">sam(bytes, bool, uint[])</code></h2>

<p>Letâ€™s say youâ€™re calling the function in the format of:  <code class="language-plaintext highlighter-rouge">sam(â€œdaveâ€, true, [1, 2, 3])</code></p>

<p><strong>Function Selector</strong></p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">sam(bytes,bool,uint256[])</code>  â†’ Keccak-256 Hash</li>
  <li>Note that  <code class="language-plaintext highlighter-rouge">uint</code>  is replaced with its canonical representation  <code class="language-plaintext highlighter-rouge">uint256</code>.
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mh">0xa5643bf27e2786816613d3eeb0b62650200b5a98766dfcfd4428f296fb56d043</span>
</code></pre></div>    </div>
  </li>
  <li>Slice the left 4 bytes.
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mh">0xa5643bf2</span>
</code></pre></div>    </div>
  </li>
</ul>

<p><strong>Parameters</strong></p>
<ul>
  <li>In the order of: â€œ<strong>iLoc &gt; Len &gt; Value</strong>â€</li>
</ul>

<p><img src="/assets/2023-10-16-encoding-and-decoding-ethereum-contract-functions/parameters.webp" alt="" /></p>
<blockquote>
  <p>made by Joshua</p>
</blockquote>

<p><strong>The Final Encoding with Concatenating All</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mh">0xa5643bf2</span> <span class="c1"># Function Selector  
</span>  
<span class="mh">0x0000000000000000000000000000000000000000000000000000000000000060</span> <span class="c1"># 1st Param iLoc : 96 bytes  
</span><span class="mh">0x0000000000000000000000000000000000000000000000000000000000000001</span> <span class="c1"># 2nd Param Value : true   
</span><span class="mh">0x00000000000000000000000000000000000000000000000000000000000000a0</span> <span class="c1"># 3rd Param iLoc : 160 bytes  
</span><span class="mh">0x0000000000000000000000000000000000000000000000000000000000000004</span> <span class="c1"># 1st Param Len : 4 bytes  
</span><span class="mh">0x6461766500000000000000000000000000000000000000000000000000000000</span> <span class="c1"># 1sst Param Value : "dave"  
</span><span class="mh">0x0000000000000000000000000000000000000000000000000000000000000003</span> <span class="c1"># 3rd Params Len : 3 items  
</span><span class="mh">0x0000000000000000000000000000000000000000000000000000000000000001</span> <span class="c1"># 3rd Param Value (item 0) : 1  
</span><span class="mh">0x0000000000000000000000000000000000000000000000000000000000000002</span> <span class="c1"># 3rd Param Value (item 1) : 2  
</span><span class="mh">0x0000000000000000000000000000000000000000000000000000000000000003</span> <span class="c1"># 3rd Param Value (item 2) : 3  
</span>  
<span class="c1"># Concat  
</span><span class="mh">0xa5643bf20000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000000464617665000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000003</span>
</code></pre></div></div>

<h1 id="4-case-study-who-are-the-top-10-recipients-of-usdt-approve-functions">4. Case Study: Who are the Top 10 Recipients of USDT <code class="language-plaintext highlighter-rouge">approve</code> Functions?</h1>

<p>According to  <a href="https://docs.openzeppelin.com/contracts/2.x/api/token/erc20">ERC-20 Interface</a>, it is possible to delegate the permission to use a specific token (the authority to transfer the token, specifically) to a particular account using the <code class="language-plaintext highlighter-rouge">approve</code> function. This permission is frequently requested, particularly in DeFi platforms. In this case study, I aim to aggregate and analyze the top 10 accounts that people commonly delegate their USDT through <code class="language-plaintext highlighter-rouge">approve</code> function.</p>

<h2 id="41-function-selector">4.1. Function Selector</h2>

<ul>
  <li><code class="language-plaintext highlighter-rouge">approve(address,uint256)</code>  â†’ Keccak-256 Hash
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mh">0x095ea7b334ae44009aa867bfb386f5c3b4b443ac6f0ee573fa91c4608fbadfba</span>
</code></pre></div>    </div>
  </li>
  <li>Slice the left 4 bytes.
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mh">0x095ea7b3</span>
</code></pre></div>    </div>
  </li>
</ul>

<h2 id="42-extract-only-the-transactions-that-have-called-the-approve-function-on-the-usdt-contract">4.2. Extract only the transactions that have called the <code class="language-plaintext highlighter-rouge">approve</code> function on the USDT Contract.</h2>

<ul>
  <li>For more info about <code class="language-plaintext highlighter-rouge">BYTEARRAY_STARTS_WITH</code> Function, click  <a href="https://dune.com/docs/query/DuneSQL-reference/Functions-and-operators/varbinary/#bytearray_starts_with">here</a>.</li>
</ul>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span>  
    <span class="o">*</span>  
<span class="k">FROM</span>  
    <span class="n">ethereum</span><span class="p">.</span><span class="n">transactions</span>  
<span class="k">WHERE</span>  
    <span class="nv">"to"</span> <span class="o">=</span> <span class="mi">0</span><span class="n">xdAC17F958D2ee523a2206206994597C13D831ec7</span> <span class="c1">-- USDT ERC-20 Contract  </span>
    <span class="k">AND</span> <span class="n">BYTEARRAY_STARTS_WITH</span><span class="p">(</span><span class="k">data</span><span class="p">,</span> <span class="mi">0</span><span class="n">x095ea7b3</span><span class="p">)</span> <span class="c1">-- approve(address,uint256) Function Call</span>
</code></pre></div></div>

<h2 id="43-extract-the-first-argument-value-address-from-the-functions">4.3. Extract the first argument value, <code class="language-plaintext highlighter-rouge">address</code>, from the functions.</h2>

<ul>
  <li>For more info about <code class="language-plaintext highlighter-rouge">BYTEARRAY_SUBSTRING</code> Function, click  <a href="https://dune.com/docs/query/DuneSQL-reference/Functions-and-operators/varbinary/#bytearray_substring">here</a>.</li>
</ul>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span>  
    <span class="n">BYTEARRAY_SUBSTRING</span><span class="p">(</span>  
        <span class="n">BYTEARRAY_SUBSTRING</span><span class="p">(</span><span class="k">data</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">32</span><span class="p">),</span>  
        <span class="mi">13</span><span class="p">,</span>  
        <span class="mi">20</span>  
    <span class="p">)</span> <span class="k">AS</span> <span class="n">approved_to</span>  
<span class="k">FROM</span>  
    <span class="n">ethereum</span><span class="p">.</span><span class="n">transactions</span>  
<span class="k">WHERE</span>  
    <span class="nv">"to"</span> <span class="o">=</span> <span class="mi">0</span><span class="n">xdAC17F958D2ee523a2206206994597C13D831ec7</span> <span class="c1">-- USDT ERC-20 Contract  </span>
    <span class="k">AND</span> <span class="n">BYTEARRAY_STARTS_WITH</span><span class="p">(</span><span class="k">data</span><span class="p">,</span> <span class="mi">0</span><span class="n">x095ea7b3</span><span class="p">)</span> <span class="c1">-- approve(address,uint256) Function Call</span>
</code></pre></div></div>

<h2 id="44-now-aggregate-the-number-of-unique-addresses-that-executed-approve-function-grouped-by-each-approve-recipient-over-the-past-week">4.4. Now, aggregate the number of unique addresses that executed <code class="language-plaintext highlighter-rouge">approve</code> function, grouped by each <code class="language-plaintext highlighter-rouge">approve</code> recipient, over the past week.</h2>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span>  
    <span class="n">BYTEARRAY_SUBSTRING</span><span class="p">(</span>  
        <span class="n">BYTEARRAY_SUBSTRING</span><span class="p">(</span><span class="k">data</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">32</span><span class="p">),</span>  
        <span class="mi">13</span><span class="p">,</span>  
        <span class="mi">20</span>  
    <span class="p">)</span> <span class="k">AS</span> <span class="n">approved_to</span><span class="p">,</span>  
    <span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="nv">"from"</span><span class="p">)</span> <span class="k">AS</span> <span class="n">approved_from_cnt</span>  
<span class="k">FROM</span>  
    <span class="n">ethereum</span><span class="p">.</span><span class="n">transactions</span>  
<span class="k">WHERE</span>  
    <span class="k">CAST</span><span class="p">(</span><span class="n">block_date</span> <span class="k">AS</span> <span class="nb">DATE</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">DATE_ADD</span><span class="p">(</span><span class="s1">'DAY'</span><span class="p">,</span> <span class="o">-</span><span class="mi">7</span><span class="p">,</span> <span class="k">CURRENT_DATE</span><span class="p">)</span> <span class="c1">-- Recent 7 Days  </span>
    <span class="k">AND</span> <span class="nv">"to"</span> <span class="o">=</span> <span class="mi">0</span><span class="n">xdAC17F958D2ee523a2206206994597C13D831ec7</span> <span class="c1">-- USDT ERC-20 Contract  </span>
    <span class="k">AND</span> <span class="n">BYTEARRAY_STARTS_WITH</span><span class="p">(</span><span class="k">data</span><span class="p">,</span> <span class="mi">0</span><span class="n">x095ea7b3</span><span class="p">)</span> <span class="c1">-- approve(address,uint256) Function Call  </span>
<span class="k">GROUP</span> <span class="k">BY</span>  
    <span class="mi">1</span>
</code></pre></div></div>

<h2 id="45-label-the-approve-recipient-addresses-based-on-dune-tables-regarding-address-labeling">4.5. Label the <code class="language-plaintext highlighter-rouge">approve</code> recipient addresses based on Dune Tables regarding â€œaddress labelingâ€.</h2>

<ul>
  <li>Looking at the original address values alone does not provide any meaningful information, as yâ€™all know here.</li>
</ul>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">WITH</span>  
<span class="n">CTE_approves</span> <span class="k">AS</span> <span class="p">(</span>  
    <span class="k">SELECT</span>  
        <span class="n">BYTEARRAY_SUBSTRING</span><span class="p">(</span>  
            <span class="n">BYTEARRAY_SUBSTRING</span><span class="p">(</span><span class="k">data</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">32</span><span class="p">),</span>  
            <span class="mi">13</span><span class="p">,</span>  
            <span class="mi">20</span>  
        <span class="p">)</span> <span class="k">AS</span> <span class="n">approved_to</span><span class="p">,</span>  
        <span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="nv">"from"</span><span class="p">)</span> <span class="k">AS</span> <span class="n">approved_from_cnt</span>  
    <span class="k">FROM</span>  
        <span class="n">ethereum</span><span class="p">.</span><span class="n">transactions</span>  
    <span class="k">WHERE</span>  
        <span class="k">CAST</span><span class="p">(</span><span class="n">block_date</span> <span class="k">AS</span> <span class="nb">DATE</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">DATE_ADD</span><span class="p">(</span><span class="s1">'DAY'</span><span class="p">,</span> <span class="o">-</span><span class="mi">7</span><span class="p">,</span> <span class="k">CURRENT_DATE</span><span class="p">)</span> <span class="c1">-- Recent 7 Days  </span>
        <span class="k">AND</span> <span class="nv">"to"</span> <span class="o">=</span> <span class="mi">0</span><span class="n">xdAC17F958D2ee523a2206206994597C13D831ec7</span> <span class="c1">-- USDT ERC-20 Contract  </span>
        <span class="k">AND</span> <span class="n">BYTEARRAY_STARTS_WITH</span><span class="p">(</span><span class="k">data</span><span class="p">,</span> <span class="mi">0</span><span class="n">x095ea7b3</span><span class="p">)</span> <span class="c1">-- approve(address,uint256) Function Call  </span>
    <span class="k">GROUP</span> <span class="k">BY</span>  
        <span class="mi">1</span>  
<span class="p">)</span>  
  
<span class="k">SELECT</span>  
    <span class="n">MAIN</span><span class="p">.</span><span class="n">approved_to</span><span class="p">,</span>  
    <span class="n">COALESCE</span><span class="p">(</span>  
        <span class="n">SUB1</span><span class="p">.</span><span class="n">dex_name</span> <span class="o">||</span> <span class="s1">' - '</span> <span class="o">||</span> <span class="n">SUB1</span><span class="p">.</span><span class="n">distinct_name</span><span class="p">,</span>  
        <span class="n">SUB2</span><span class="p">.</span><span class="n">project</span> <span class="o">||</span> <span class="s1">' - '</span> <span class="o">||</span> <span class="n">SUB2</span><span class="p">.</span><span class="n">project_type</span><span class="p">,</span>  
        <span class="n">SUB3</span><span class="p">.</span><span class="n">bridge_name</span> <span class="o">||</span> <span class="s1">' - '</span> <span class="o">||</span> <span class="n">SUB3</span><span class="p">.</span><span class="n">description</span><span class="p">,</span>  
        <span class="n">SUB4</span><span class="p">.</span><span class="n">cex_name</span> <span class="o">||</span> <span class="s1">' - '</span> <span class="o">||</span> <span class="n">SUB4</span><span class="p">.</span><span class="n">distinct_name</span><span class="p">,</span>  
        <span class="s1">'Unknown'</span>  
    <span class="p">)</span> <span class="k">AS</span> <span class="n">name</span><span class="p">,</span>  
    <span class="n">MAIN</span><span class="p">.</span><span class="n">approved_from_cnt</span> <span class="k">AS</span> <span class="n">addresses_cnt</span>  
<span class="k">FROM</span>  
    <span class="n">CTE_approves</span> <span class="n">MAIN</span>  
<span class="k">LEFT</span> <span class="k">JOIN</span>  
    <span class="n">addresses_ethereum</span><span class="p">.</span><span class="n">dex</span> <span class="n">SUB1</span> <span class="c1">-- DEX named addresses  </span>
    <span class="k">ON</span> <span class="n">MAIN</span><span class="p">.</span><span class="n">approved_to</span> <span class="o">=</span> <span class="n">SUB1</span><span class="p">.</span><span class="n">address</span>  
<span class="k">LEFT</span> <span class="k">JOIN</span>  
    <span class="n">addresses_ethereum</span><span class="p">.</span><span class="n">defi</span> <span class="n">SUB2</span> <span class="c1">-- DeFi named addresses  </span>
    <span class="k">ON</span> <span class="n">MAIN</span><span class="p">.</span><span class="n">approved_to</span> <span class="o">=</span> <span class="n">SUB2</span><span class="p">.</span><span class="n">address</span>  
<span class="k">LEFT</span> <span class="k">JOIN</span>  
    <span class="n">addresses_ethereum</span><span class="p">.</span><span class="n">bridges</span> <span class="n">SUB3</span> <span class="c1">-- Bridge named addresses  </span>
    <span class="k">ON</span> <span class="n">MAIN</span><span class="p">.</span><span class="n">approved_to</span> <span class="o">=</span> <span class="n">SUB3</span><span class="p">.</span><span class="n">address</span>  
<span class="k">LEFT</span> <span class="k">JOIN</span>  
    <span class="n">addresses_ethereum</span><span class="p">.</span><span class="n">cex</span> <span class="n">SUB4</span> <span class="c1">-- CEX named addresses  </span>
    <span class="k">ON</span> <span class="n">MAIN</span><span class="p">.</span><span class="n">approved_to</span> <span class="o">=</span> <span class="n">SUB4</span><span class="p">.</span><span class="n">address</span>  
<span class="k">ORDER</span> <span class="k">BY</span>  
    <span class="mi">3</span> <span class="k">DESC</span>  
<span class="k">LIMIT</span>  
    <span class="mi">10</span>  
<span class="p">;</span>
</code></pre></div></div>

<h2 id="46-the-final-query-results">4.6. The Final Query Results</h2>

<p><img src="/assets/2023-10-16-encoding-and-decoding-ethereum-contract-functions/query-results.webp" alt="" /></p>
<blockquote>
  <p>Dune Analytics</p>
</blockquote>

<h1 id="5-lets-conclude">5. Letâ€™s Conclude!</h1>

<p>So far, we have delved into <strong>the Ethereumâ€™s ABI Specification</strong>, learned how data is encoded when transactions call contract functions, and understood how to extract meaningful insights by decoding specific function names and arguments from Ethereum transactions data.</p>

<p>In fact, Dune Analytics, Etherscan, and many other on-chain data platforms all incorporate these decoding processes internally.</p>

<p>Hopefully this article will serve as an excellent foundation for your future, more detailed and complex on-chain data analysis endeavors.</p>

<h1 id="6-references">6. References</h1>

<ul>
  <li><a href="https://docs.soliditylang.org/en/develop/abi-spec.html#function-selector-and-argument-encoding">Contract ABI Specification</a></li>
  <li><a href="https://docs.openzeppelin.com/contracts/4.x/api/token/erc721">OpenZeppelin Docs</a></li>
  <li><a href="https://dune.com/joshua_web3">Dune Analytics</a></li>
</ul>

<hr />

<h2 id="published-by-joshua-kim"><em>Published by</em> Joshua Kim</h2>
<p><img src="/assets/profile/joshua-profile.png" alt="Joshua Kim" /></p>]]></content><author><name></name></author><category term="english" /><category term="blockchain" /><category term="on_chain_data" /><category term="sql" /><summary type="html"><![CDATA[In this article, I will briefly explore the Ethereum ABI Specification and show you how to decode contract functions when conducting on-chain data analysis. Additionally, I will demonstrate a simple data extraction and analysis case about â€œWho are the Top 10 Recipients of USDT approve Functions?â€ using DuneSQL while handling ABIs.]]></summary></entry><entry><title type="html">Finding all NFTs (ERC721) held by an address (feat. Dune Analytics)</title><link href="http://localhost:4000/finding-nfts/" rel="alternate" type="text/html" title="Finding all NFTs (ERC721) held by an address (feat. Dune Analytics)" /><published>2023-10-08T00:00:00+09:00</published><updated>2023-10-08T00:00:00+09:00</updated><id>http://localhost:4000/finding-nfts</id><content type="html" xml:base="http://localhost:4000/finding-nfts/"><![CDATA[<blockquote>
  <p>Embark on a journey through blockchain data with Joshua. Explore the intricacies of smart contracts, ERC721, and data analysis techniques. Joshuaâ€™s expertise shines as he guides you through interpreting transfer events using tools like Dune Analytics. Donâ€™t miss the case study featuring Binance 7 EOA addresses. Verify insights with Etherscan for a deeper understanding of on-chain data architecture.</p>
</blockquote>

<h3 id="contents">CONTENTS</h3>
<ol>
  <li>Contract = Functions + Events</li>
  <li>ERC721 Interface</li>
  <li>Summary: From Collecting Transfer Events To Calculating Wallet Balance</li>
  <li>Step by Step
    <ul>
      <li>4.1ï¸. Collect All Transfer Events.</li>
      <li>4.2ï¸. Filter Out the Most Recent Transfer Events for Each Token.</li>
      <li>4.3. Filter the Results to Show Only Those Related to the Specific Address.</li>
      <li>4.4ï¸. Determine the Acquisition Price of the Tokens and Label the Contracts.</li>
    </ul>
  </li>
  <li>Case Study</li>
  <li>References</li>
</ol>

<hr />

<h1 id="1-contract--functions--events">1. Contract = Functions + Events</h1>

<p><img src="/assets/2023-10-08-finding-nfts/flowchart.webp" alt="" /></p>

<h3 id="functions"><code class="language-plaintext highlighter-rouge">Functions</code></h3>
<p>When you call a <code class="language-plaintext highlighter-rouge">function</code>:</p>
<ul>
  <li>
    <ol>
      <li>it returns a value, or</li>
    </ol>
  </li>
  <li>
    <ol>
      <li>it trigers an event. (= emits an event.)</li>
    </ol>
  </li>
</ul>

<h3 id="events"><code class="language-plaintext highlighter-rouge">Events</code></h3>
<p>WHen an <code class="language-plaintext highlighter-rouge">event</code> is emitted:</p>
<ul>
  <li>
    <ol>
      <li>it creates and. broadcasts a TX message, then</li>
    </ol>
  </li>
  <li>
    <ol>
      <li>the TX message leads to state change of Ethereum.</li>
    </ol>
  </li>
</ul>

<h1 id="2-erc721-interface">2. ERC721 Interface</h1>

<h3 id="functions-1"><code class="language-plaintext highlighter-rouge">Functions</code></h3>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">balanceOf</span><span class="p">(</span><span class="n">owner</span><span class="p">):</span>  
    <span class="k">return</span> <span class="sh">"</span><span class="s">Number of Tokens held by the Owner</span><span class="sh">'</span><span class="s">s Account</span><span class="sh">"</span>  
<span class="k">def</span> <span class="nf">ownerOf</span><span class="p">(</span><span class="n">tokenId</span><span class="p">):</span>  
    <span class="k">return</span> <span class="sh">"</span><span class="s">Owner</span><span class="sh">'</span><span class="s">s Address holding the Token</span><span class="sh">"</span>  
<span class="k">def</span> <span class="nf">transferFrom</span><span class="p">(</span><span class="k">from</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="n">tokenId</span><span class="p">):</span>  
    <span class="n">emit</span> <span class="n">Transfer</span>  
<span class="k">def</span> <span class="nf">approve</span><span class="p">(</span><span class="n">to</span><span class="p">,</span> <span class="n">tokenId</span><span class="p">):</span>  
    <span class="n">emit</span> <span class="n">Approval</span>  
<span class="bp">...</span>
</code></pre></div></div>

<h3 id="events-1"><code class="language-plaintext highlighter-rouge">Events</code></h3>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">event</span> <span class="nc">Transfer</span><span class="p">(</span><span class="k">from</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="n">tokenId</span><span class="p">):</span>  
    <span class="c1">#  "tokenId" token is transferred from "from" to "to".  
</span><span class="n">event</span> <span class="nc">Approval</span><span class="p">(</span><span class="n">owner</span><span class="p">,</span> <span class="n">approved</span><span class="p">,</span> <span class="n">tokenId</span><span class="p">):</span>  
    <span class="c1"># "owner" enables "approved" to manage the "tokenId" token.  
</span><span class="bp">...</span>
</code></pre></div></div>

<h1 id="3-summary-from-collecting-transfer-events-to-calculating-wallet-balance">3. Summary: From Collecting Transfer Events To Calculating Wallet Balance</h1>

<h3 id="collect-all-events-involving--david">Collect All Events Involving  <code class="language-plaintext highlighter-rouge">David</code>.</h3>

<p><strong>Transfer Event #1:</strong></p>
<ul>
  <li>from = â€œJoshuaâ€</li>
  <li>to = â€œDavidâ€</li>
  <li>tokenId = <code class="language-plaintext highlighter-rouge">1234</code></li>
</ul>

<p><strong>Transfer Event #2:</strong></p>
<ul>
  <li>from = â€œAngelaâ€</li>
  <li>to = â€œDavidâ€</li>
  <li>tokenId = <code class="language-plaintext highlighter-rouge">5678</code></li>
</ul>

<p><strong>Transfer Event #3:</strong></p>
<ul>
  <li>from = â€œDavidâ€</li>
  <li>to = â€œAngelaâ€</li>
  <li>tokenId = <code class="language-plaintext highlighter-rouge">1234</code></li>
</ul>

<h3 id="then-sum-up-all-the-events-to-determine-wallet-balance">Then Sum Up All the Events to Determine Wallet Balance.</h3>

<p><strong>Tokens List â€œDavidâ€ currently owns:</strong></p>
<ul>
  <li>tokenId = <code class="language-plaintext highlighter-rouge">5678</code></li>
</ul>

<h1 id="4-step-by-step">4. Step by Step</h1>

<h2 id="41ï¸-collect-all-transfer-events">4.1ï¸. Collect All Transfer Events.</h2>

<p><img src="/assets/2023-10-08-finding-nfts/erc721-evt_Transfer.webp" alt="" /></p>
<blockquote>
  <p>Dune Analytics</p>
</blockquote>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">WITH</span>  
<span class="n">CTE_all_transfers</span> <span class="k">AS</span> <span class="p">(</span>  
    <span class="k">SELECT</span>  
        <span class="n">contract_address</span><span class="p">,</span>  
        <span class="n">tokenId</span><span class="p">,</span>  
        <span class="n">evt_tx_hash</span><span class="p">,</span>  
        <span class="nv">"to"</span><span class="p">,</span>  
        <span class="n">ROW_NUMBER</span><span class="p">()</span> <span class="n">OVER</span> <span class="p">(</span>  
            <span class="k">PARTITION</span> <span class="k">BY</span> <span class="n">contract_address</span><span class="p">,</span> <span class="n">tokenId</span>  
            <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">evt_block_number</span> <span class="k">DESC</span><span class="p">,</span> <span class="n">evt_index</span> <span class="k">DESC</span>  
        <span class="p">)</span> <span class="k">AS</span> <span class="n">recent_idx</span>  
    <span class="k">FROM</span>  
        <span class="n">erc721_ethereum</span><span class="p">.</span><span class="n">evt_Transfer</span>  
    <span class="k">WHERE</span>  
        <span class="n">contract_address</span> <span class="k">IS</span> <span class="k">NOT</span> <span class="k">NULL</span>  
<span class="p">),</span>
</code></pre></div></div>

<p><strong>Query Results</strong></p>

<table>
  <thead>
    <tr>
      <th><strong>contract_address</strong></th>
      <th><strong>tokenId</strong></th>
      <th><strong>evt_tx_hash</strong></th>
      <th><strong>to</strong></th>
      <th><strong>recent_idx</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">0x0000...8e25</code></td>
      <td>106</td>
      <td><code class="language-plaintext highlighter-rouge">0xc8c0...4e4c</code></td>
      <td><code class="language-plaintext highlighter-rouge">0x826e...1ff3</code></td>
      <td>2</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">0x0000...8e25</code></td>
      <td>113</td>
      <td><code class="language-plaintext highlighter-rouge">0xcd01...66a2</code></td>
      <td><code class="language-plaintext highlighter-rouge">0xc412...0620</code></td>
      <td>2</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">0x0000...8e25</code></td>
      <td>118</td>
      <td><code class="language-plaintext highlighter-rouge">0x28dd...6e20</code></td>
      <td><code class="language-plaintext highlighter-rouge">0x4d98...e5a8</code></td>
      <td>2</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">0x0000...b183</code></td>
      <td>3</td>
      <td><code class="language-plaintext highlighter-rouge">0xd503...672a</code></td>
      <td><code class="language-plaintext highlighter-rouge">0x8636...a5e9</code></td>
      <td>2</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">0x0000...b183</code></td>
      <td>13</td>
      <td><code class="language-plaintext highlighter-rouge">0x3cc9...4121</code></td>
      <td><code class="language-plaintext highlighter-rouge">0x47a1...c78a</code></td>
      <td>2</td>
    </tr>
  </tbody>
</table>

<h2 id="42ï¸-filter-out-the-most-recent-transfer-events-for-each-token">4.2ï¸. Filter Out the Most Recent Transfer Events for Each Token.</h2>
<blockquote>
  <p>So that we can see who owns the tokens at the moment!</p>
</blockquote>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">CTE_last_transfers</span> <span class="k">AS</span> <span class="p">(</span>  
    <span class="k">SELECT</span>  
        <span class="o">*</span>  
    <span class="k">FROM</span>  
        <span class="n">CTE_all_transfers</span>  
    <span class="k">WHERE</span>  
        <span class="n">recent_idx</span> <span class="o">=</span> <span class="mi">1</span>  
<span class="p">),</span>
</code></pre></div></div>

<p><strong>Query Results</strong></p>

<table>
  <thead>
    <tr>
      <th><strong>contract_address</strong></th>
      <th><strong>tokenId</strong></th>
      <th><strong>evt_tx_hash</strong></th>
      <th><strong>to</strong></th>
      <th><strong>recent_idx</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">0x0000...8e25</code></td>
      <td>0</td>
      <td><code class="language-plaintext highlighter-rouge">0xfa58...164a</code></td>
      <td><code class="language-plaintext highlighter-rouge">0x0000...5e92</code></td>
      <td>1</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">0x0000...8e25</code></td>
      <td>1</td>
      <td><code class="language-plaintext highlighter-rouge">0x0595...c802</code></td>
      <td><code class="language-plaintext highlighter-rouge">0x0000...5e92</code></td>
      <td>1</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">0x0000...8e25</code></td>
      <td>2</td>
      <td><code class="language-plaintext highlighter-rouge">0x0595...c802</code></td>
      <td><code class="language-plaintext highlighter-rouge">0x0000...5e92</code></td>
      <td>1</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">0x0000...8e25</code></td>
      <td>3</td>
      <td><code class="language-plaintext highlighter-rouge">0x0595...c802</code></td>
      <td><code class="language-plaintext highlighter-rouge">0x0000...5e92</code></td>
      <td>1</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">0x0000...8e25</code></td>
      <td>4</td>
      <td><code class="language-plaintext highlighter-rouge">0x0595...c802</code></td>
      <td><code class="language-plaintext highlighter-rouge">0x0000...5e92</code></td>
      <td>1</td>
    </tr>
  </tbody>
</table>

<h2 id="43-filter-the-results-to-show-only-those-related-to-the-specific-address">4.3. Filter the Results to Show Only Those Related to the Specific Address.</h2>
<blockquote>
  <p>So that we can see all the tokens that the address owns at the moment.</p>
</blockquote>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">CTE_last_transfers_cohort</span> <span class="k">AS</span> <span class="p">(</span>  
    <span class="k">SELECT</span>  
        <span class="o">*</span>  
    <span class="k">FROM</span>  
        <span class="n">CTE_last_transfers</span>  
    <span class="k">WHERE</span>  
        <span class="nv">"to"</span> <span class="o">=</span>   
<span class="p">),</span>
</code></pre></div></div>

<p><strong>Query Results</strong></p>

<table>
  <thead>
    <tr>
      <th><strong>contract_address</strong></th>
      <th><strong>tokenId</strong></th>
      <th><strong>evt_tx_hash</strong></th>
      <th><strong>to</strong></th>
      <th><strong>recent_idx</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">0x0000...8e25</code></td>
      <td>0</td>
      <td><code class="language-plaintext highlighter-rouge">0xfa58...164a</code></td>
      <td><code class="language-plaintext highlighter-rouge">0x0000...5e92</code></td>
      <td>1</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">0x0000...8e25</code></td>
      <td>1</td>
      <td><code class="language-plaintext highlighter-rouge">0x0595...c802</code></td>
      <td><code class="language-plaintext highlighter-rouge">0x0000...5e92</code></td>
      <td>1</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">0x0000...8e25</code></td>
      <td>2</td>
      <td><code class="language-plaintext highlighter-rouge">0x0595...c802</code></td>
      <td><code class="language-plaintext highlighter-rouge">0x0000...5e92</code></td>
      <td>1</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">0x0000...8e25</code></td>
      <td>3</td>
      <td><code class="language-plaintext highlighter-rouge">0x0595...c802</code></td>
      <td><code class="language-plaintext highlighter-rouge">0x0000...5e92</code></td>
      <td>1</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">0x0000...8e25</code></td>
      <td>4</td>
      <td><code class="language-plaintext highlighter-rouge">0x0595...c802</code></td>
      <td><code class="language-plaintext highlighter-rouge">0x0000...5e92</code></td>
      <td>1</td>
    </tr>
  </tbody>
</table>

<h2 id="44ï¸-determine-the-acquisition-price-of-the-tokens-and-label-the-contracts">4.4ï¸. Determine the Acquisition Price of the Tokens and Label the Contracts.</h2>

<p><strong>Determine the Acquisition Price of the Tokens.</strong></p>

<p><img src="/assets/2023-10-08-finding-nfts/flowchart.webp" alt="" /></p>

<ul>
  <li><strong>JOIN <code class="language-plaintext highlighter-rouge">hash</code> with <code class="language-plaintext highlighter-rouge">evt_tx_hash</code> and SELECT <code class="language-plaintext highlighter-rouge">value</code>.</strong></li>
</ul>

<p><img src="/assets/2023-10-08-finding-nfts/ethereum.transactions.webp" alt="" /></p>
<blockquote>
  <p>Dune Analytics</p>
</blockquote>

<p><strong>Label the Contracts.</strong></p>

<p><img src="/assets/2023-10-08-finding-nfts/label-the-contracts.webp" alt="" /></p>
<blockquote>
  <p>Dune Analytics</p>
</blockquote>

<ul>
  <li><strong>JOIN <code class="language-plaintext highlighter-rouge">contract_address</code> with <code class="language-plaintext highlighter-rouge">contract_address</code> and SELECT <code class="language-plaintext highlighter-rouge">name</code>.</strong></li>
</ul>

<p><img src="/assets/2023-10-08-finding-nfts/tokens.nft.webp" alt="" /></p>
<blockquote>
  <p>Dune Analytics</p>
</blockquote>

<p><strong>Final Query to Wrap Up</strong></p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">CTE_summary</span> <span class="k">AS</span> <span class="p">(</span>  
    <span class="k">SELECT</span>  
        <span class="n">LABELS</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>  
        <span class="n">TRANSFERS</span><span class="p">.</span><span class="n">contract_address</span><span class="p">,</span>  
        <span class="n">TRANSFERS</span><span class="p">.</span><span class="n">tokenId</span><span class="p">,</span>  
        <span class="n">TXS</span><span class="p">.</span><span class="n">value</span> <span class="o">/</span> <span class="mi">1</span><span class="n">e18</span> <span class="k">AS</span> <span class="n">acquisition_cost</span>  
    <span class="k">FROM</span>  
        <span class="n">CTE_last_transfers_cohort</span> <span class="n">TRANSFERS</span>  
    <span class="k">LEFT</span> <span class="k">JOIN</span>  
        <span class="n">ethereum</span><span class="p">.</span><span class="n">transactions</span> <span class="n">TXS</span>  
        <span class="k">ON</span> <span class="n">TRANSFERS</span><span class="p">.</span><span class="n">evt_tx_hash</span> <span class="o">=</span> <span class="n">TXS</span><span class="p">.</span><span class="n">hash</span>  
    <span class="k">LEFT</span> <span class="k">JOIN</span>  
        <span class="n">tokens</span><span class="p">.</span><span class="n">nft</span> <span class="n">LABELS</span>  
        <span class="k">ON</span> <span class="n">TRANSFERS</span><span class="p">.</span><span class="n">contract_address</span> <span class="o">=</span> <span class="n">LABELS</span><span class="p">.</span><span class="n">contract_address</span>  
            <span class="k">AND</span> <span class="n">LABELS</span><span class="p">.</span><span class="n">blockchain</span> <span class="o">=</span> <span class="s1">'ethereum'</span>  
<span class="p">)</span>
<span class="k">SELECT</span>
    <span class="o">*</span>
<span class="k">FROM</span>
    <span class="n">CTE_summary</span>
<span class="p">;</span>
</code></pre></div></div>

<h1 id="5-case-study">5. Case Study</h1>

<h3 id="binance-7--eoa-address"><code class="language-plaintext highlighter-rouge">Binance 7</code>  EOA Address</h3>
<blockquote>
  <p>â˜ï¸ <code class="language-plaintext highlighter-rouge">0xBE0eB53F46cd790Cd13851d5EFf43D12404d33E8</code></p>
</blockquote>

<h3 id="query-results">Query Results</h3>

<p><img src="/assets/2023-10-08-finding-nfts/query-results.webp" alt="" /></p>
<blockquote>
  <p>ğŸŸ   <a href="https://dune.com/joshua_web3/blpas-sample-dashboard?address_t7a5e7=0xBE0eB53F46cd790Cd13851d5EFf43D12404d33E8">dune.com/joshua_web3</a></p>
</blockquote>

<h3 id="check-it-out-with--etherscan--just-in-case-its-not-been-correctly-queried">Check it out with  <code class="language-plaintext highlighter-rouge">Etherscan</code>  just in case itâ€™s not been correctly queried.</h3>

<ul>
  <li>Holders of  <code class="language-plaintext highlighter-rouge">Documenta X by Vuk Cosic</code></li>
</ul>

<p><img src="/assets/2023-10-08-finding-nfts/etherscan-documenta.webp" alt="" /></p>
<blockquote>
  <p>Etherscan</p>
</blockquote>

<ul>
  <li>Holders of  <code class="language-plaintext highlighter-rouge">New World Babies</code></li>
</ul>

<p><img src="/assets/2023-10-08-finding-nfts/etherscan-new-world-babies.webp" alt="" /></p>
<blockquote>
  <p>Etherscan</p>
</blockquote>

<h1 id="6-references">6. References</h1>

<ul>
  <li><a href="https://docs.openzeppelin.com/contracts/4.x/api/token/erc721">OpenZeppelin Docs</a></li>
  <li><a href="https://dune.com/joshua_web3/blpas-sample-dashboard?address_t7a5e7=0xBE0eB53F46cd790Cd13851d5EFf43D12404d33E8">Dune Dashboard</a>  (created by Joshua)</li>
</ul>

<hr />

<h2 id="published-by-joshua-kim"><em>Published by</em> Joshua Kim</h2>
<p><img src="/assets/profile/joshua-profile.png" alt="Joshua Kim" /></p>]]></content><author><name></name></author><category term="english" /><category term="blockchain" /><category term="on_chain_data" /><category term="sql" /><summary type="html"><![CDATA[Embark on a journey through blockchain data with Joshua. Explore the intricacies of smart contracts, ERC721, and data analysis techniques. Joshuaâ€™s expertise shines as he guides you through interpreting transfer events using tools like Dune Analytics. Donâ€™t miss the case study featuring Binance 7 EOA addresses. Verify insights with Etherscan for a deeper understanding of on-chain data architecture.]]></summary></entry><entry><title type="html">OpenSeaì—ì„œ ë°œìƒí•œ íŠ¸ëœì­ì…˜ ë°ì´í„° êµ¬ì¡°</title><link href="http://localhost:4000/opensea-transaction/" rel="alternate" type="text/html" title="OpenSeaì—ì„œ ë°œìƒí•œ íŠ¸ëœì­ì…˜ ë°ì´í„° êµ¬ì¡°" /><published>2023-09-18T00:00:00+09:00</published><updated>2023-09-18T00:00:00+09:00</updated><id>http://localhost:4000/opensea-transaction</id><content type="html" xml:base="http://localhost:4000/opensea-transaction/"><![CDATA[<blockquote>
  <p>ì•ˆë…•í•˜ì„¸ìš”. ì €ëŠ” ë¸”ë¡ì²´ì¸ ê¸°ë°˜ ì„œë¹„ìŠ¤ ê¸°ì—…ì—ì„œ ë°ì´í„° ë¶„ì„ì„ ë‹´ë‹¹í•˜ê³  ìˆëŠ” Joshuaë¼ê³  í•©ë‹ˆë‹¤. ì´ë²ˆ ì•„í‹°í´ì—ì„œëŠ” OpenSeaì—ì„œ NFT Transferê°€ ë°œìƒí–ˆì„ ë•Œ, EVM ê³„ì—´ ë¸”ë¡ì²´ì¸ì˜ ì˜¨ì²´ì¸ ìƒì— ë°ì´í„°ê°€ ì–´ë–¤ ëª¨ìŠµìœ¼ë¡œ ë‚¨ì•„ ìˆëŠ”ì§€ íŒŒí—¤ì³ ë³´ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.</p>
</blockquote>

<h3 id="contents">CONTENTS</h3>
<ol>
  <li>ì˜¤ëŠ˜ì˜ í† í”½</li>
  <li>ë°”ì˜ì‹  ë¶„ë“¤ì„ ìœ„í•œ ë‘ê´„ì‹ ê²°ë¡ </li>
  <li>ìƒì„¸ ë‚´ìš© íŒŒí—¤ì¹˜ê¸°
    <ul>
      <li>3.1. TransactionReceipt</li>
      <li>3.2. OpenSeaì˜ Wyvern ì»¨íŠ¸ë™íŠ¸ë¡œë¶€í„° ë°œìƒí•œ Internal TXs</li>
      <li>3.3. <code class="language-plaintext highlighter-rouge">atomicMatch_</code> í•¨ìˆ˜ë¡œë¶€í„° ë°œìƒí•œ Events</li>
    </ul>
  </li>
  <li>ì •ë¦¬í•˜ê¸°</li>
</ol>

<hr />

<h1 id="1-ì˜¤ëŠ˜ì˜-í† í”½">1. ì˜¤ëŠ˜ì˜ í† í”½</h1>

<p>ë¨¼ì € ì˜¤ëŠ˜ ì‚¬ë¡€ë¡œ ì‚´í´ë³¼ NFTëŠ” <strong>Bored Ape Yacht Club</strong>ì˜ <code class="language-plaintext highlighter-rouge">tokenId</code> = <code class="language-plaintext highlighter-rouge">3238</code>ì¸ NFTì…ë‹ˆë‹¤.</p>

<p><img src="/assets/2023-09-18-opensea-transaction/bayc.webp" alt="" /></p>
<blockquote>
  <p><a href="https://opensea.io/assets/ethereum/0xbc4ca0eda7647a8ab7c2061c2e118a18a936f13d/3238">Source</a></p>
</blockquote>

<p>ì´ NFTì˜ í™œë™ ë‚´ì—­ì„ ë³´ë©´ Transfers íˆìŠ¤í† ë¦¬ê°€ ë§ì´ ë‚¨ì•„ ìˆëŠ”ë°ìš”. ê·¸ ì¤‘ì—ì„œ, <code class="language-plaintext highlighter-rouge">wizmo</code> ê³„ì •ìœ¼ë¡œë¶€í„° <code class="language-plaintext highlighter-rouge">LGHTWRK</code> ê³„ì •ìœ¼ë¡œì˜ Transfer ë‚´ì—­ì„ ëœ¯ì–´ë³´ë„ë¡ í• ê²Œìš”.</p>

<p><img src="/assets/2023-09-18-opensea-transaction/bayc-transfers.webp" alt="" /></p>
<blockquote>
  <p><a href="https://opensea.io/assets/ethereum/0xbc4ca0eda7647a8ab7c2061c2e118a18a936f13d/3238">Source</a></p>
</blockquote>

<p>ì´ Transfer ë‚´ì—­ì˜ ìš°ì¸¡ ë°”ë¡œê°€ê¸° ë²„íŠ¼ì„ í´ë¦­í•˜ë©´ ì•„ë˜ì™€ ê°™ì´ Etherscanì˜ <code class="language-plaintext highlighter-rouge">Transaction Receipt</code> í˜ì´ì§€ê°€ íŒì—…í•©ë‹ˆë‹¤. í•˜ì§€ë§Œ ì•ˆíƒ€ê¹ê²Œë„ ì¼ë°˜ì ì¸ ETH ì†¡ê¸ˆê³¼ ë‹¬ë¦¬, íŠ¸ëœì­ì…˜ì´ ìƒë‹¹íˆ ë‚œí•´í•˜ì—¬ ë„ëŒ€ì²´ ì–´ë–¤ êµ¬ì¡°ì™€ ì ˆì°¨ë¥¼ í†µí•´ ì‹¤í–‰ëœ ê²ƒì¸ì§€ ì•Œê¸°ë€ ì°¸ ì–´ë ¤ì›Œìš”. íŠ¹íˆ, ë¸”ë¡ì²´ì¸ ì´ˆì‹¬ìë¼ë©´ ë”ìš± ë‚œê°í•˜ê² ì£ .</p>

<p><img src="/assets/2023-09-18-opensea-transaction/etherscan-overview.webp" alt="" /></p>
<blockquote>
  <p><a href="https://etherscan.io/tx/0xe769c002eb1a13e9384d8b62270c963188a686068f2833a9c1b07b160468e80c">Source</a></p>
</blockquote>

<h1 id="2-ë°”ì˜ì‹ -ë¶„ë“¤ì„-ìœ„í•œ-ë‘ê´„ì‹-ê²°ë¡ ">2. ë°”ì˜ì‹  ë¶„ë“¤ì„ ìœ„í•œ ë‘ê´„ì‹ ê²°ë¡ </h1>

<blockquote>
  <p><strong><code class="language-plaintext highlighter-rouge">wizmo</code>ì˜ NFT ê²½ë§¤ì— ëŒ€í•˜ì—¬ <code class="language-plaintext highlighter-rouge">LGHTWRK</code>ì˜ Offerê°€ ìˆ˜ë½ë˜ì–´, <code class="language-plaintext highlighter-rouge">wizmo</code>ê°€ <code class="language-plaintext highlighter-rouge">LGHTWRK</code>ì—ê²Œ NFTë¥¼ ì „ì†¡í•˜ëŠ” ê±°ë˜ê°€ ì„±ì‚¬ë˜ì—ˆë‹¤.</strong></p>
</blockquote>

<p><img src="/assets/2023-09-18-opensea-transaction/flowchart.webp" alt="" /></p>
<blockquote>
  <p>Joshuaê°€ ì‘ì„±í•œ Flowchart</p>
</blockquote>

<h1 id="3-ìƒì„¸-ë‚´ìš©-íŒŒí—¤ì¹˜ê¸°">3. ìƒì„¸ ë‚´ìš© íŒŒí—¤ì¹˜ê¸°</h1>

<h2 id="31-transactionreceipt">3.1. TransactionReceipt</h2>

<p>ìš°ì„ , í¬ê²Œ ë‹¤ìŒê³¼ ê°™ì€ ë‚´ìš©ì„ ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<table>
  <thead>
    <tr>
      <th><strong>íŒŒë¼ë¯¸í„°</strong></th>
      <th><strong>ê°’</strong></th>
      <th><strong>ì°¸ê³ ë‚´ìš©</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><strong>from</strong></td>
      <td>0x869câ€¦Bf89</td>
      <td><code class="language-plaintext highlighter-rouge">LGHTWRK</code>ì˜ ì£¼ì†Œ</td>
    </tr>
    <tr>
      <td><strong>to</strong></td>
      <td>0x7Be8â€¦D12b</td>
      <td><code class="language-plaintext highlighter-rouge">OpenSea: Wyvern Exchange v1</code>ì˜ ì£¼ì†Œ</td>
    </tr>
    <tr>
      <td><strong>value</strong></td>
      <td>2.1000 ETH</td>
      <td>0.1050 ETH + 1.9950 ETH</td>
    </tr>
    <tr>
      <td><strong>tx fee</strong></td>
      <td>0.0084 ETH</td>
      <td>-</td>
    </tr>
    <tr>
      <td><strong>data</strong></td>
      <td><code class="language-plaintext highlighter-rouge">atomicMatch_</code></td>
      <td>í•¨ìˆ˜ í˜¸ì¶œ</td>
    </tr>
  </tbody>
</table>

<p>ì¦‰, ì´ íŠ¸ëœì­ì…˜ì˜ ê¸°ë³¸ ê³¨ê²©ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.</p>
<blockquote>
  <p><strong><code class="language-plaintext highlighter-rouge">LGHTWRK</code>ë¡œë¶€í„° <code class="language-plaintext highlighter-rouge">OpenSeaì˜ Wyvern ì»¨íŠ¸ë™íŠ¸</code>ë¥¼ í–¥í•´ <code class="language-plaintext highlighter-rouge">2.1000</code> ETHë¥¼ ì†¡ê¸ˆí•¨ê³¼ ë™ì‹œì— í•´ë‹¹ ì»¨íŠ¸ë™íŠ¸ì˜ ABIì— ì •ì˜ë˜ì–´ ìˆëŠ”  <code class="language-plaintext highlighter-rouge">atomicMatch_</code>  í•¨ìˆ˜ë¥¼ ì‹¤í–‰í•˜ëŠ” ê²ƒì„ ëª©í‘œë¡œ í•œë‹¤.</strong></p>
</blockquote>

<p>ì°¸ê³ ë¡œ, ì œê°€ <code class="language-plaintext highlighter-rouge">2.1000</code> ETHë¥¼ <code class="language-plaintext highlighter-rouge">0.1050</code> ETH + <code class="language-plaintext highlighter-rouge">1.9950</code> ETH ë¡œ ìª¼ê°œì–´ í‘œí˜„í–ˆëŠ”ë°ìš”. ì œê°€ ì™œ ê·¸ë¬ì„ê¹Œìš”? ë°”ë¡œ ì•„ë˜ë¥¼ ë³´ì‹œì£ .</p>

<h2 id="32-openseaì˜-wyvern-ì»¨íŠ¸ë™íŠ¸ë¡œë¶€í„°-ë°œìƒí•œ-internal-txs">3.2. OpenSeaì˜ Wyvern ì»¨íŠ¸ë™íŠ¸ë¡œë¶€í„° ë°œìƒí•œ Internal TXs</h2>

<p><code class="language-plaintext highlighter-rouge">LGHTWRK</code>ê°€ <code class="language-plaintext highlighter-rouge">OpenSeaì˜ Wyvern ì»¨íŠ¸ë™íŠ¸</code>ë¥¼ í–¥í•´ ì†¡ê¸ˆí•˜ê²Œ ë˜ë©´ì„œ, ì»¨íŠ¸ë™íŠ¸ë¡œë¶€í„° ì´ 2ê°œì˜ íŠ¸ëœì­ì…˜ì´ íŒŒìƒì ìœ¼ë¡œ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë°”ë¡œ, NFTë¥¼ êµ¬ë§¤í•˜ê³  ì‹¶ì€ <code class="language-plaintext highlighter-rouge">LGHTWRK</code>ê°€ OpenSeaì— ìˆ˜ìˆ˜ë£Œë¥¼ ë‚©ë¶€í•˜ê³ , NFT ì†Œìœ ìì¸ <code class="language-plaintext highlighter-rouge">wizmo</code>ì—ê²Œ ì œì‹œí•œ ê°€ê²©ì„ ì§€ë¶ˆí•´ì•¼ í•˜ëŠ” ë‚´ìš©ì¸ ê²ƒì´ì£ .</p>

<p><strong>1. <code class="language-plaintext highlighter-rouge">OpenSeaì˜ Wyvern ì»¨íŠ¸ë™íŠ¸</code>ê°€  <code class="language-plaintext highlighter-rouge">OpenSea ìˆ˜ìˆ˜ë£Œ ì „ìš© EOA</code>ì— <code class="language-plaintext highlighter-rouge">0.1050</code> ETHë¥¼ ì†¡ê¸ˆí•œë‹¤.</strong></p>
<ul>
  <li><strong>from</strong>  = 0x7Be8â€¦D12b (<code class="language-plaintext highlighter-rouge">OpenSea: Wyvern Exchange v1</code>)</li>
  <li><strong>to</strong>  = 0x5b32â€¦1073 (<code class="language-plaintext highlighter-rouge">OpenSea: Wallet</code>)</li>
</ul>

<p><strong>2. <code class="language-plaintext highlighter-rouge">OpenSeaì˜ Wyvern ì»¨íŠ¸ë™íŠ¸</code>ê°€  <code class="language-plaintext highlighter-rouge">wizmo</code>ì—ê²Œ <code class="language-plaintext highlighter-rouge">1.9950</code> ETHë¥¼ ì†¡ê¸ˆí•œë‹¤.</strong></p>
<ul>
  <li><strong>from</strong>  = 0x7Be8â€¦D12b (<code class="language-plaintext highlighter-rouge">OpenSea: Wyvern Exchange v1</code>)</li>
  <li><strong>to</strong>  = 0xc4CBâ€¦9B26 (<code class="language-plaintext highlighter-rouge">wizmo</code>)</li>
</ul>

<p>ì°¸ê³ ë¡œ, Etherscanì˜ Transaction Receipt í˜ì´ì§€ì—ì„œ <strong>Internal Txns íƒ­</strong>ì„ í´ë¦­í•˜ë©´ ìœ„ ë‚´ìš©ì„ í™•ì¸í•˜ì‹¤ ìˆ˜ ìˆëŠ”ë°ìš”. ë¸”ë¡ì²´ì¸ ë°ì´í„° ì¸¡ë©´ì—ì„œëŠ” ì´ëŸ¬í•œ <strong>Internal TX</strong>ë¥¼ í”íˆ <code class="language-plaintext highlighter-rouge">Trace</code>ë¼ê³ ë„ í‘œí˜„í•©ë‹ˆë‹¤.</p>

<p><img src="/assets/2023-09-18-opensea-transaction/ethersacn-internal-tx.webp" alt="" /></p>
<blockquote>
  <p><a href="https://etherscan.io/tx/0xe769c002eb1a13e9384d8b62270c963188a686068f2833a9c1b07b160468e80c#internal">Source</a></p>
</blockquote>

<h2 id="33-atomicmatch_-í•¨ìˆ˜ë¡œë¶€í„°-ë°œìƒí•œ-events">3.3. <code class="language-plaintext highlighter-rouge">atomicMatch_</code> í•¨ìˆ˜ë¡œë¶€í„° ë°œìƒí•œ Events</h2>

<p><code class="language-plaintext highlighter-rouge">OpenSeaì˜ Wyvern ì»¨íŠ¸ë™íŠ¸</code>ì—ê²Œ Input Dataë¡œ ì ì–´ì¤€  <strong>_atomicMatch__</strong>  í•¨ìˆ˜ë¥¼ í†µí•´,  <code class="language-plaintext highlighter-rouge">OpenSeaì˜ Wyvern ì»¨íŠ¸ë™íŠ¸</code>  ì—ì„œëŠ” ì´ 3ê°œì˜ Eventsê°€ ë°œìƒ(emit)í•˜ê²Œ ë©ë‹ˆë‹¤.</p>

<p>ì‚¬ì‹¤, <strong>_atomicMatch__</strong> í•¨ìˆ˜ë¥¼ í†µí•´ ì–´ë–¤ Eventsê°€ ì‹¤í–‰ë˜ëŠ”ì§€ ëª…í™•í•˜ê²Œ ì•Œê¸° ìœ„í•´ì„œëŠ” ì•„ë˜ì™€ ê°™ì´  <code class="language-plaintext highlighter-rouge">OpenSeaì˜ Wyvern ì»¨íŠ¸ë™íŠ¸</code>ì˜ ì½”ë“œë¥¼ ë¶„ì„í•´ì•¼ í•˜ëŠ”ë°ìš”. ì´ê²ƒê¹Œì§€ ì‚´í´ë³´ë ¤ë©´ ë¶„ëŸ‰ì´ ë„ˆë¬´ ê¸¸ì–´ì§ˆ ê²ƒ ê°™ìœ¼ë‹ˆ, ì˜¤ëŠ˜ì€ ìƒëµí• ê²Œìš”.</p>

<p><img src="/assets/2023-09-18-opensea-transaction/etherscan-source-code.webp" alt="" /></p>
<blockquote>
  <p><a href="https://etherscan.io/address/0x7be8076f4ea4a4ad08075c2508e481d6c946d12b#code">Source</a></p>
</blockquote>

<p><strong>1. Approval ì´ë²¤íŠ¸</strong></p>
<ul>
  <li>ERC-721 ABIì˜ <code class="language-plaintext highlighter-rouge">Approval</code> ì´ë²¤íŠ¸ì™€ íŒŒë¼ë¯¸í„° êµ¬ì¡°ê°€ ë˜‘ê°™ìŠµë‹ˆë‹¤. ERC-721 ABIì˜ <code class="language-plaintext highlighter-rouge">Approval</code> ì´ë²¤íŠ¸ëŠ” â€œíŠ¹ì • Addressê°€ ì†Œìœ ìë¥¼ ëŒ€ì‹ í•˜ì—¬ NFTë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ê¶Œí•œì„ ì£¼ê²ŒëŠ”â€ ê²ƒì„ ì˜ë¯¸í•©ë‹ˆë‹¤.</li>
  <li>Approval ì´ë²¤íŠ¸ëŠ” ERC-721 ABIì˜ <code class="language-plaintext highlighter-rouge">approve</code> í•¨ìˆ˜ë¥¼ í†µí•´ ë°œìƒí•˜ê²Œ ë˜ëŠ”ë°, ì´ë²ˆ ì•„í‹°í´ì—ì„œ ì†Œê°œ ë“œë¦¬ê³  ìˆëŠ” íŠ¸ëœì­ì…˜ì—ì„œëŠ” approve í•¨ìˆ˜ê°€ ì‹¤í–‰ëœ ì ì´ ì—†ëŠ” ê²ƒìœ¼ë¡œ ë³´ì•„, ì•„ë§ˆ ì†Œìœ ìì¸  <code class="language-plaintext highlighter-rouge">wizmo</code>ê°€ ìì‹ ì˜ NFTë¥¼ ê²½ë§¤ì— ì˜¬ë¦° ì‹œì ì— ì˜¤í”„ì²´ì¸ ìƒì—ì„œ Signedëœ íŠ¸ëœì­ì…˜ ë©”ì‹œì§€ë¥¼ ë³¸ íŠ¸ëœì­ì…˜ê³¼ ë¬¶ìŒ ë‹¨ìœ„ë¡œ ë¸Œë¡œë“œìºìŠ¤íŠ¸í–ˆê¸° ë•Œë¬¸ì´ì§€ ì•Šì„ê¹Œ ì¶”ì¸¡í•´ë´…ë‹ˆë‹¤.</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">owner</span> <span class="o">=</span> <span class="mh">0xc4cb</span><span class="err">â€¦</span><span class="mi">9</span><span class="n">b26</span> <span class="c1"># wizmo
</span><span class="n">approved</span> <span class="o">=</span> <span class="mh">0x0000</span><span class="err">â€¦</span><span class="mi">0000</span>  
<span class="n">tokenId</span> <span class="o">=</span> <span class="mi">3238</span>
</code></pre></div></div>

<p><strong>2. Transfer ì´ë²¤íŠ¸</strong></p>
<ul>
  <li>NFTì˜ ì†Œìœ ê¶Œì´ <code class="language-plaintext highlighter-rouge">wizmo</code>ë¡œë¶€í„° <code class="language-plaintext highlighter-rouge">LGHTWRK</code>ë¡œ ë„˜ì–´ê°€ê²Œ ë˜ëŠ” ì´ë²¤íŠ¸ì…ë‹ˆë‹¤.</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">from</span> <span class="o">=</span> <span class="mh">0xc4cb</span><span class="err">â€¦</span><span class="mi">9</span><span class="n">b26</span> <span class="c1"># wizmo  
</span><span class="n">to</span> <span class="o">=</span> <span class="mh">0x869c</span><span class="err">â€¦</span><span class="n">bf89</span> <span class="c1"># LGHTWRK
</span><span class="n">tokenId</span> <span class="o">=</span> <span class="mi">3238</span>
</code></pre></div></div>

<p><strong>3. OrdersMatched ì´ë²¤íŠ¸</strong></p>
<ul>
  <li>ì •í™•íˆ ì–´ë–¤ ê²ƒì„ ì˜ë¯¸í•˜ëŠ”ì§€ ì•Œê¸° ìœ„í•´ì„œëŠ”  <code class="language-plaintext highlighter-rouge">OpenSeaì˜ Wyvern ì»¨íŠ¸ë™íŠ¸</code>  ì˜ ì½”ë“œë¥¼ ë¶„ì„í•´ì•¼ í•˜ê² ì§€ë§Œ, ìš°ì„  ê²½ë§¤ë¥¼ í†µí•´ ì„±ì‚¬ëœ ê±°ë˜ ë‚´ì—­ì´ ê¸°ë¡ëœ ê²ƒì´ë¼ê³  ìƒê°í•˜ê³  ë„˜ì–´ê°€ë´…ì‹œë‹¤.</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">maker</span> <span class="o">=</span> <span class="mh">0xc4cb</span><span class="err">â€¦</span><span class="mi">9</span><span class="n">b26</span> <span class="c1"># wizmo (OpenSea ê²½ë§¤ ì‹œì¥ì˜ Maker)
</span><span class="n">taker</span> <span class="o">=</span> <span class="mh">0x869c</span><span class="err">â€¦</span><span class="n">bf89</span> <span class="c1"># LGHTWRK (OpenSea ê²½ë§¤ ì‹œì¥ì˜ Taker)
</span><span class="n">metadata</span> <span class="o">=</span> <span class="mh">0x0000</span><span class="err">â€¦</span><span class="mi">0000</span> <span class="c1"># data  
</span><span class="n">buyHash</span> <span class="o">=</span> <span class="mi">0000</span><span class="err">â€¦</span><span class="mi">0000</span>  
<span class="n">sellHash</span> <span class="o">=</span> <span class="n">A7B1</span><span class="err">â€¦</span><span class="mi">297</span><span class="n">F</span>  
<span class="n">price</span> <span class="o">=</span> <span class="mf">2.1000</span> <span class="c1"># ETH
</span></code></pre></div></div>

<h1 id="4-ì •ë¦¬í•˜ê¸°">4. ì •ë¦¬í•˜ê¸°</h1>

<p>ì§€ê¸ˆê¹Œì§€ ê°€ë²¼ìš´ ë§ˆìŒìœ¼ë¡œ(?) ì•„ë˜ ë‚´ìš©ì„ ë°ì´í„°ì ìœ¼ë¡œ ëœ¯ì–´ë³´ì•˜ìŠµë‹ˆë‹¤.</p>

<blockquote>
  <p><strong><code class="language-plaintext highlighter-rouge">wizmo</code>ì˜ NFT ê²½ë§¤ì— ëŒ€í•˜ì—¬ <code class="language-plaintext highlighter-rouge">LGHTWRK</code>ì˜ Offerê°€ ìˆ˜ë½ë˜ì–´, <code class="language-plaintext highlighter-rouge">wizmo</code>ê°€ <code class="language-plaintext highlighter-rouge">LGHTWRK</code>ì—ê²Œ NFTë¥¼ ì „ì†¡í•˜ëŠ” ê±°ë˜ê°€ ì„±ì‚¬ë˜ì—ˆë‹¤.</strong></p>
</blockquote>

<p><img src="/assets/2023-09-18-opensea-transaction/flowchart.webp" alt="" /></p>
<blockquote>
  <p>Joshuaê°€ ì‘ì„±í•œ Flowchart</p>
</blockquote>

<p>ETH, ERC-20ì˜ ì†¡ê¸ˆê³¼ ë‹¬ë¦¬, ERC-721ì€ ì¢€ ë” ë‹¤ì–‘í•œ ë©”íƒ€ë°ì´í„°ë¥¼ ì§€ë‹ˆê³  ìˆê³ , ì‹¬ì§€ì–´ OpenSeaëŠ” ìì²´ì ìœ¼ë¡œ ì»¨íŠ¸ë™íŠ¸ë¥¼ êµ¬í˜„í•˜ì—¬ ERC-721 í† í°ì˜ ê²½ë§¤ê°€ ìë™ìœ¼ë¡œ ì„±ì‚¬ë  ìˆ˜ ìˆë„ë¡ í”„ë¡œí† ì½œì„ êµ¬í˜„í–ˆìŠµë‹ˆë‹¤. <code class="language-plaintext highlighter-rouge">OpenSeaì˜ Wyvern ì»¨íŠ¸ë™íŠ¸</code>ëŠ” ì‚¬ì‹¤ ìµœê·¼ì—ëŠ” ì‚¬ìš© ë¹ˆë„ê°€ ì¤„ì–´ë“¤ê²Œ ë˜ì—ˆëŠ”ë°ìš”. ê·¸ëŸ¼ì—ë„ ë¶ˆêµ¬í•˜ê³ , OpenSeaì™€ ê°™ì€ NFT Marketplaceì—ì„œ ë°œìƒí•œ NFT ë§¤ë§¤ ê³¼ì •ì´ ì˜¨ì²´ì¸ ìƒì— ì–´ë–»ê²Œ ê¸°ë¡ë˜ì–´ ìˆëŠ”ì§€ ì¡°íšŒí•˜ê¸°ì— ì¢‹ì€ ì˜ˆì‹œë¼ê³  ìƒê°í•©ë‹ˆë‹¤.</p>

<p>ì°¸ê³ ë¡œ, OpenSeaëŠ” ê²½ë§¤ ê³¼ì •ì˜ ê° íŠ¹ì • í–‰ìœ„ê°€ ë°œìƒí•  ë•Œë§ˆë‹¤ ë§¤ë²ˆ ì˜¨ì²´ì¸ ìƒì— ê¸°ë¡í•˜ëŠ” ê²ƒì´ ì•„ë‹ˆë¼, ì˜¤í”„ì²´ì¸ ìƒì—ì„œ ì„œëª…ì´ ì™„ë£Œëœ íŠ¸ëœì­ì…˜ ë©”ì‹œì§€ë¥¼ ë³´ê´€í•˜ê³  ìˆë‹¤ê°€, í•œêº¼ë²ˆì— Bulk ë‹¨ìœ„ë¡œ ì˜¨ì²´ì¸ ìƒì— ë©”ì‹œì§€ë¥¼ ë¸Œë¡œë“œìºìŠ¤íŠ¸í•˜ëŠ” ë°©ì‹ì„ ì‚¬ìš©í•˜ê³¤ í•©ë‹ˆë‹¤. ì´ëŠ” ìµœì¢… ì‚¬ìš©ì ì¸¡ë©´ì—ì„œ TX Feeì˜ ë¶€ë‹´ì„ ì¤„ì—¬ ì‚¬ì—…ì˜ P&amp;Lì„ ìµœì í™”í•˜ê¸° ìœ„í•œ ì‘ì—…ìœ¼ë¡œ ë³´ì´ì§€ë§Œ, ë¸”ë¡ì²´ì¸ì˜ íŠ¸ë¦´ë ˆë§ˆ í•­ëª© ì¤‘ í•˜ë‚˜ì¸ â€œíƒˆì¤‘ì•™í™”â€ í›¼ì† ë…¼ë€ì˜ ì—¬ì§€ê°€ ìˆì–´ ë³´ì´ê¸°ë„ í•©ë‹ˆë‹¤.</p>

<p>ì½ì–´ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤.</p>

<hr />

<h2 id="published-by-joshua-kim"><em>Published by</em> Joshua Kim</h2>
<p><img src="/assets/profile/joshua-profile.png" alt="Joshua Kim" /></p>]]></content><author><name></name></author><category term="korean" /><category term="blockchain" /><category term="on_chain_data" /><summary type="html"><![CDATA[ì•ˆë…•í•˜ì„¸ìš”. ì €ëŠ” ë¸”ë¡ì²´ì¸ ê¸°ë°˜ ì„œë¹„ìŠ¤ ê¸°ì—…ì—ì„œ ë°ì´í„° ë¶„ì„ì„ ë‹´ë‹¹í•˜ê³  ìˆëŠ” Joshuaë¼ê³  í•©ë‹ˆë‹¤. ì´ë²ˆ ì•„í‹°í´ì—ì„œëŠ” OpenSeaì—ì„œ NFT Transferê°€ ë°œìƒí–ˆì„ ë•Œ, EVM ê³„ì—´ ë¸”ë¡ì²´ì¸ì˜ ì˜¨ì²´ì¸ ìƒì— ë°ì´í„°ê°€ ì–´ë–¤ ëª¨ìŠµìœ¼ë¡œ ë‚¨ì•„ ìˆëŠ”ì§€ íŒŒí—¤ì³ ë³´ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.]]></summary></entry><entry><title type="html">ë°ì´í„° ë¶„ì„ê°€ì˜ íŒŒì´ì¬ í´ë¼ì´ì–¸íŠ¸ ê°œë°œê¸° feat. pyinstaller</title><link href="http://localhost:4000/pyinstaller/" rel="alternate" type="text/html" title="ë°ì´í„° ë¶„ì„ê°€ì˜ íŒŒì´ì¬ í´ë¼ì´ì–¸íŠ¸ ê°œë°œê¸° feat. pyinstaller" /><published>2023-07-15T00:00:00+09:00</published><updated>2023-07-15T00:00:00+09:00</updated><id>http://localhost:4000/pyinstaller</id><content type="html" xml:base="http://localhost:4000/pyinstaller/"><![CDATA[<blockquote>
  <p>íŒŒì´ì¬ íŒŒì¼ì„ ì‹¤í–‰í•˜ê¸° ìœ„í•´ì„œëŠ” íŒŒì´ì¬ì˜ High-level ì–¸ì–´ë¥¼ Low-levelë¡œ ë³€í™˜í•´ì£¼ëŠ” <strong>Interpreter</strong>ê°€ í•„ìš”í•˜ê³ , ë˜ íŒŒì´ì¬ íŒŒì¼ ë‚´ì—ì„œ Loadí•´ì•¼ í•˜ëŠ” <strong>ëª¨ë“ˆ</strong> ì—­ì‹œ í•¨ê»˜ ì‚¬ì „ì— ì„¤ì¹˜ë˜ì–´ì•¼ í•˜ëŠ”ë°ìš”.  <code class="language-plaintext highlighter-rouge">pyinstaller</code>ëŠ” ì´ëŸ¬í•œ Interpreterì™€ ëª¨ë“ˆì„ í•¨ê»˜ ë™ë´‰í•œ ì±„ë¡œ íŒŒì´ì¬ íŒŒì¼ì„ íŒ¨í‚¤ì§•í•˜ì—¬ í•˜ë‚˜ì˜ ì‹¤í–‰ íŒŒì¼ë¡œ ë§Œë“¤ì–´ì£¼ëŠ” ì—­í• ì„ í•˜ëŠ” ê²ƒì´ì£ .</p>
</blockquote>

<h3 id="contents">CONTENTS</h3>
<ol>
  <li>ë°ì´í„° ë¶„ì„ê°€ë¡œ ì‚´ì•„ê°€ë©°</li>
  <li>ëˆ„ì›Œì„œ ë–¡ ë¨¹ë“¯ ì—…ë¬´ ìë™í™”ë¥¼ ê²½í—˜í•˜ì‹¤ ìˆ˜ ìˆë„ë¡ í•˜ë ¤ë©´ ì–´ë–»ê²Œ í•´ì•¼ í• ê¹Œìš”?</li>
  <li>íŒŒì´ì¬ ì„¤ì¹˜ì™€ ì‹¤í–‰ ë°©ë²•ì„ ëª¨ë¥´ë”ë¼ë„ <code class="language-plaintext highlighter-rouge">pyinstaller</code> í•˜ë‚˜ë©´ ëª¨ë“  ê²ƒì´ ê°€ëŠ¥í•´ìš”!</li>
  <li><code class="language-plaintext highlighter-rouge">.ipynb</code> íŒŒì¼ì„ <code class="language-plaintext highlighter-rouge">.exe</code> íŒŒì¼ë¡œ ë§Œë“œëŠ” ë°©ë²•</li>
  <li>ë°ì´í„° ë¶„ì„ê°€ê°€ ê°–ì¶”ì–´ì•¼ í•˜ëŠ” ì¤‘ìš”í•œ íƒœë„, â€œë– ë¨¹ì—¬ ë“œë¦¬ê¸°â€</li>
</ol>

<hr />

<h1 id="1-ë°ì´í„°-ë¶„ì„ê°€ë¡œ-ì‚´ì•„ê°€ë©°">1. ë°ì´í„° ë¶„ì„ê°€ë¡œ ì‚´ì•„ê°€ë©°</h1>

<p><img src="/assets/2023-07-15-pyinstaller/milk.png" alt="" /></p>

<p>ì €ëŠ” ë¸”ë¡ì²´ì¸ ì§€ê°‘ ê¸°ì—…ì—ì„œ ë°ì´í„° ë¶„ì„ê°€ë¡œ ê·¼ë¬´í•˜ê³  ìˆëŠ” Joshuaë¼ê³  í•©ë‹ˆë‹¤. ì›ë˜ ì´ ì—…ê³„ì—ì„œ ë‹¤ë¥¸ í¬ì§€ì…˜ìœ¼ë¡œ ê·¼ë¬´í•˜ê³  ìˆì—ˆì§€ë§Œ, ë¨¸ì‹ ëŸ¬ë‹ê³¼ ë¹…ë°ì´í„°ì— ëŒ€í•œ ì²œëª…(?)ê³¼ ê°™ì€ ê¹Šì€ í¥ë¯¸ë¥¼ ëŠë¼ê²Œ ë˜ì–´ ì§ì¥ê³¼ AI ëŒ€í•™ì› ìƒí™œì„ 2ë…„ ë™ì•ˆ ë³‘í–‰í•´ì™”ëŠ”ë°ìš”. ì •ë§ ê°ì‚¬í•˜ê²Œë„ ëŒ€í•™ì›ì„ ì˜ ì¡¸ì—…í•˜ê³ , ì§€ê¸ˆ íšŒì‚¬ì—ì„œ ë°ì´í„° ë¶„ì„ê°€ í¬ì§€ì…˜ìœ¼ë¡œ ê·¼ë¬´í•˜ê²Œ ëœì§€ 1ë…„ì´ ë„˜ì–´ê°€ê³  ìˆìŠµë‹ˆë‹¤.</p>

<p>í›Œë¥­í•˜ì‹ , ê·¸ë¦¬ê³  ì¸ê°„ì ì¸ ë™ë£Œ ë¶„ë“¤ê³¼ í•¨ê»˜ ë§¤ì¼ ì¹˜ì—´í•˜ê²Œ í”„ë¡œë•íŠ¸ì— ëŒ€í•´ ê³ ë¯¼í•˜ê³  ìˆëŠ”ë°ìš”. íŠ¹íˆ, í•œ ë¶„, í•œ ë¶„ê³¼ ì´ì•¼ê¸°ë¥¼ í•˜ê±°ë‚˜ í˜‘ì—…ì„ í•˜ë‹¤ë³´ë©´ ì œê²Œ ë§ì€ ìê·¹ì„ ì•Œê²Œ ëª¨ë¥´ê²Œ ì£¼ì‹œê¸°ë„ í•˜ê³ , ìŠ¤ìŠ¤ë¡œë„ ì„±ì¥ ìš•êµ¬ê°€ ëŠì„ ì—†ì´ ì¼ì–´ë‚˜ê¸°ë„ í•œë‹µë‹ˆë‹¤. (ì…ì‚¬ ë‹¹ì‹œì—ë„ ê·¸ë ‡ê³ , 1ë…„ì´ ì§€ë‚œ ì§€ê¸ˆë„ ê·¸ ê°ì •ì´ ì˜¤ë¡¯ì´ ìœ ì§€ë˜ê³  ìˆì–´ìš”.)</p>

<p><strong>ë¨¸ë¦¬ë¡œ ê¸°ì–µí•˜ê³  ìˆëŠ” ì„ ë°° ë™ë£Œ ë¶„ë“¤ì˜ ì–´ë¡ ëª¨ìŒ</strong></p>
<blockquote>
  <p>â€œì¡°ê¸‰í•œ ë§ˆìŒìœ¼ë¡œ ì—…ë¬´ë¥¼ í•˜ê²Œ ë˜ë©´ ë‚˜ì¤‘ì— ì–´ë–¤ ëª¨ìŠµìœ¼ë¡œë“  ì‚¬ê³ ê°€ ë‚  ìˆ˜ ìˆë‹¤. í•­ìƒ ì°¨ê·¼ì°¨ê·¼ ê¸°ì´ˆì— ì¶©ì‹¤í•˜ëŠ” ê²Œ ì¤‘ìš”í•´ìš”.â€
â€œ3ë…„ í›„, 5ë…„ í›„ì˜ ë¯¸ë˜ë¥¼ ì¢…ì¢… ê·¸ë ¤ë³´ë©° ì»¤ë¦¬ì–´ ë°©í–¥ì„ ì ê²€í•´ë³´ëŠ” ê²Œ ë˜ê²Œ ì¤‘ìš”í•´ìš”.â€
â€œì €ëŠ” ë‚˜ì´ê°€ ë“¤ìˆ˜ë¡ ë§ì„ í•˜ê±°ë‚˜ ê¸€ì„ ì“°ëŠ” ë“± í‘œí˜„í•˜ëŠ” ê²Œ ë¶€ë‹´ìŠ¤ëŸ¬ì›Œì ¸ìš”. ë‚´ê°€ ì•Œê³  ëŠë¼ëŠ” ê²ƒì´ í‹€ë¦´ ìˆ˜ë„ ìˆìœ¼ë‹ˆê¹Œìš”.â€</p>
</blockquote>

<p>ì´ëŸ° ë™ë£Œ ë¶„ë“¤ê³¼ í•¨ê»˜, ê·¸ë¦¬ê³  ì„±ì¥ ê°€ëŠ¥ì„±ì´ ë¬´ê¶ë¬´ì§„í•œ ë¸”ë¡ì²´ì¸ ë„ë©”ì¸ ì†ì—ì„œ ë§¤ì¼ ë°¤ ì´ë¶ˆì„ ë®ìœ¼ë©° â€œ<strong>ë‚˜ëŠ” ê¼­ ì›”ë“œ í´ë˜ìŠ¤ê°€ ë  ê±°ì•¼</strong>â€ë¼ëŠ” ìƒê°ì„ í•˜ë©° ì§€ë‚´ê³  ìˆì–´ìš”.</p>

<p>ë°ì´í„° ë¶„ì„ê°€ì˜ ë©”ì¸ ì—…ë¬´ì— ëŒ€í•œ ì´ì•¼ê¸°ëŠ” ë‹¤ìŒ ì•„í‹°í´ì—ì„œ ë˜ ì „ë‹¬í•´ë“œë¦¬ë„ë¡ í•˜ê³ , ì˜¤ëŠ˜ì€ ì¡°ê¸ˆ í¬ê·€í•œ(?) ìŠ¤í† ë¦¬ë¥¼ ì „ë‹¬í•´ë“œë¦¬ê³ ì í•©ë‹ˆë‹¤.</p>

<p>ê°€ë” ëª‡ëª‡ ë™ë£Œ ë¶„ë“¤ì´ ì œê²Œ ì´ëŸ° ë§ì”€ì„ í•˜ì‹¤ ë•Œê°€ ë§ì•„ìš”.</p>
<blockquote>
  <p>â€œJoshuaë‹˜ì€ ë°ì´í„° ë¶„ì„ê°€ì¸ë° ì™œ ê°œë°œì„ í•˜ê³  ê³„ì„¸ìš”?â€</p>
</blockquote>

<p>ê·¸ëŸ´ ë•Œë§ˆë‹¤ ì €ëŠ” ì´ë ‡ê²Œ ë‹µë³€ ë“œë¦¬ê³¤ í•©ë‹ˆë‹¤.</p>
<blockquote>
  <p>â€œì €.. ì €ëŠ” ë‹¨ì§€ ë°ì´í„° ì¶”ì¶œê³¼ ê°€ê³µ ë•Œë¬¸ì— ì½”ë“œë¥¼ ì§œê³  ìˆëŠ” ê±´ë°ìš”? ê°œë°œ ì˜ ëª°ë¼ìš”^^;;;;;â€</p>
</blockquote>

<p>ë¬¼ë¡  ì‹œê°„ì´ íë¥´ë©°, í”„ë¡ íŠ¸ì—”ë“œì™€ ë°±ì—”ë“œ ê°œë°œë„ ë°ì´í„° í¬ë¡¤ë§ê³¼ ê°€ê³µì˜ í”„ë¡œì„¸ìŠ¤ë„ ì§€ë‹ˆê³  ìˆì–´ì„œ ìƒë‹¹íˆ ìœ ì‚¬í•œ ì‘ì—…ì´ ë§ë‹¤ëŠ” ì‚¬ì‹¤ì„ ì´í•´í•˜ê²Œ ë˜ì–´ ì§€ê¸ˆì€ ì‚´ì§ ì¸ì •ì„ í•˜ê³  ìˆì–´ìš”. (ê·¸ëŸ¼ì—ë„ ë¶ˆêµ¬í•˜ê³  ë°ì´í„° ë¶„ì„ì€ ê²°ì´ ì¢€ ë‹¤ë¥´ë‹¤êµ¬ìš”!ğŸ˜†)</p>

<p>ì•„ë¬´íŠ¼, ì´ë²ˆ ì•„í‹°í´ì—ì„œ ì œê°€ ì „ë‹¬í•´ë“œë¦¬ë ¤ëŠ” ë‚´ìš©ì€ â€œ<strong>ë°ì´í„° ë¶„ì„ê°€ë¡œì„œ ë°˜ë“œì‹œ ì•Œ í•„ìš”ëŠ” ì—†ëŠ”, ê·¸ë ‡ì§€ë§Œ ì•Œì•„ë‘ë©´ ì¬ë¯¸ìˆê³  ì“¸ëª¨ ìˆëŠ” í´ë¼ì´ì–¸íŠ¸ ê°œë°œ í›„ê¸°</strong>â€ì…ë‹ˆë‹¤!</p>

<p>ê³°ê³°ì´ ìƒê°í•´ë³´ë©´, í˜„ íšŒì‚¬ì—ì„œ ë°ì´í„° ë¶„ì„ê°€ë¡œì„œ Day-to-day Responsibilitiesê°€ í¬ê²Œ  <strong>ë©”ì¸ ì—…ë¬´</strong>ì™€  <strong>ì„œë¸Œ ì—…ë¬´</strong>  ë‘ ê°€ì§€ë¡œ ì¹´í…Œê³ ë¦¬í™”ë˜ëŠ” ê²ƒ ê°™ì•„ìš”.</p>

<p><strong>| ë©”ì¸ ì—…ë¬´</strong></p>
<ul>
  <li>í•µì‹¬ ì§€í‘œ ëª¨ë‹ˆí„°ë§ì„ ìœ„í•œ ëŒ€ì‹œë³´ë“œ ìƒì„± ë° ê´€ë¦¬</li>
  <li>Ad-hoc ë°ì´í„° ë¶„ì„</li>
  <li>A/B í…ŒìŠ¤íŠ¸ ê²°ê³¼ ë°ì´í„° ë¶„ì„</li>
  <li>ì´ë²¤íŠ¸ ë¡œê·¸ ìŠ¤í‚¤ë§ˆ ì •ì˜</li>
</ul>

<p><strong>| ì„œë¸Œ ì—…ë¬´</strong></p>
<ul>
  <li>API í¬ë¡¤ë§ì„ í†µí•œ ì‹œì¥ ë°ì´í„° ìˆ˜ì§‘ í›„ ë¶„ì„</li>
  <li>ë¸”ë¡ì²´ì¸ ì˜¨ì²´ì¸ ë°ì´í„° ìˆ˜ì§‘ í›„ ë¶„ì„</li>
  <li>ë¸”ë¡ì²´ì¸ ë©”ì¸ë„· ë¦¬ì„œì¹˜</li>
  <li>ê¸°íƒ€ ë“±ë“±</li>
</ul>

<p>íŠ¹íˆ  <strong>ì„œë¸Œ ì—…ë¬´</strong>ëŠ” ë°ì´í„° ë¶„ì„ê°€ë¡œì„œ Must-have ì—…ë¬´ê°€ ì•„ë‹ ìˆ˜ ìˆì§€ë§Œ, ì €ëŠ” ê°œì¸ì ìœ¼ë¡œ ì„œë¸Œ ì—…ë¬´ë¥¼ í•¨ìœ¼ë¡œì¨ íšŒì‚¬ì˜ ì‚¬ì—… ì „ëµê³¼ í”„ë¡œë•íŠ¸ì— ëŒ€í•œ Domain Knowledgeë¥¼ í‚¤ì›Œê°ˆ ìˆ˜ ìˆëŠ” ë§¤ìš° ê°’ì§„ ê²½í—˜ì´ë¼ê³  ìƒê°í•˜ëŠ”ë°ìš”.</p>

<p>ìµœê·¼ì—ëŠ” ì‚¬ë‚´ ì¬ë¬´íŒ€ ë¶„ë“¤ì„ ìœ„í•´ ë‚´ë¶€ìš© íŒŒì´ì¬ ì—…ë¬´ ìë™í™” í´ë¼ì´ì–¸íŠ¸ë¥¼ ê°œë°œí•˜ì—¬ ë°°í¬í•˜ëŠ” ê³¼ì •ì„ ê²ªìœ¼ë©°, ì¬ë¬´íŒ€ ë™ë£Œ ë¶„ë“¤ì´ ì–´ë–¤ ê³ ë¯¼ì„ í•˜ì‹œëŠ”ì§€, ê·¸ë¦¬ê³  ì–´ë–¤ ëª©í‘œì™€ ì—­í• ì„ ìœ„í•´ ìµœì„ ì„ ë‹¤í•˜ê³  ê³„ì‹œëŠ”ì§€ ì§„ë“í•˜ê²Œ ì´í•´í•  ìˆ˜ ìˆì—ˆì–´ìš”.</p>

<h1 id="2-ëˆ„ì›Œì„œ-ë–¡-ë¨¹ë“¯-ì—…ë¬´-ìë™í™”ë¥¼-ê²½í—˜í•˜ì‹¤-ìˆ˜-ìˆë„ë¡-í•˜ë ¤ë©´-ì–´ë–»ê²Œ-í•´ì•¼-í• ê¹Œìš”">2. ëˆ„ì›Œì„œ ë–¡ ë¨¹ë“¯ ì—…ë¬´ ìë™í™”ë¥¼ ê²½í—˜í•˜ì‹¤ ìˆ˜ ìˆë„ë¡ í•˜ë ¤ë©´ ì–´ë–»ê²Œ í•´ì•¼ í• ê¹Œìš”?</h1>

<p><img src="/assets/2023-07-15-pyinstaller/i-dont-know-why.png" alt="" /></p>

<p>íšŒì‚¬ ë‚´ë¶€ìš© ëª©ì ì— ëŒ€í•´ ê³µê°œí•  ìˆ˜ëŠ” ì—†ì§€ë§Œ, ì¬ë¬´íŒ€ ì—…ë¬´ì‹œ ë§¤ë‰´ì–¼í•˜ê²Œ ë°ì´í„°ë¥¼ í™•ì¸í•˜ëŠ” ê²ƒì´ ê±°ì˜ ë¶ˆê°€ëŠ¥í•œ ì—…ë¬´ í¬ì¸íŠ¸ê°€ ìˆì—ˆëŠ”ë°ìš”. ê·¸ ë¶€ë¶„ì„ APIë¥¼ í†µí•´ í¬ë¡¤ë§í•  ìˆ˜ ìˆë„ë¡ íŒŒì´ì¬ ëª¨ë“ˆì„ ë§Œë“¤ ìˆ˜ ìˆê² ë‹¤ëŠ” ìƒê°ì´ ë“¤ì—ˆì–´ìš”.</p>

<p>íŒŒì´ì¬ í¬ë¡¤ëŸ¬ ìì²´ë¥¼ ë§Œë“œëŠ” ê²ƒì€ ì–´ë ¤ìš´ ì¼ì´ ì•„ë‹ˆì—ˆì§€ë§Œ, íŒŒì´ì¬ ì‹¤í–‰ í™˜ê²½ì— ëŒ€í•´ ìƒê°í•´ë³´ë‹ˆ ê³ ë¯¼ì´ ìƒê²¼ì–´ìš”.</p>
<blockquote>
  <p>â€œë°ì´í„° ë¶„ì„ê°€ì™€ ë°±ì—”ë“œ ê°œë°œìì—ê²ŒëŠ” íŒŒì´ì¬ í´ë¼ì´ì–¸íŠ¸ë¥¼ ì„¤ì¹˜í•˜ê³ , ë…¸íŠ¸ë¶ ìƒì—ì„œ ì½”ë“œë¥¼ ì‹¤í–‰í•˜ê±°ë‚˜ ëª…ë ¹ í”„ë¡¬í”„íŠ¸ ìƒì—ì„œ íŒŒì´ì¬ì„ ì‹¤í–‰í•˜ëŠ” ê²Œ ë„ˆë¬´ë‚˜ë„ ìµìˆ™í•œ ì¼ì¸ë°, ì´ê²Œ ê³¼ì—° ì¬ë¬´íŒ€ ë¶„ë“¤ê»˜ë„ ìµìˆ™í•œ ì¼ì¼ê¹Œ?â€</p>
</blockquote>

<p>ë¬¼ë¡ , ì—…ë¬´ ìë™í™”ë¡œ ì¸í•œ ì‹œê°„ ì ˆê° íš¨ê³¼ê°€ íŒŒì´ì¬ ì‹¤í–‰ í™˜ê²½ ì ì‘ ì‹œê°„ë³´ë‹¤ í›¨ì”¬ í¬ë‹¤ë©´ í° ë¬¸ì œê°€ ë˜ì§€ëŠ” ì•Šê² ì§€ë§Œ, ê·¸ëŸ¼ì—ë„ ë¶ˆêµ¬í•˜ê³   <code class="language-plaintext highlighter-rouge">CX(Colleague Experience?)</code>ë¥¼ ê³ ë ¤í•œ ì—…ë¬´ ìë™í™” í™˜ê²½ì„ ì œê³µí•´ë“œë¦¬ê³  ì‹¶ì—ˆê±°ë“ ìš”.</p>

<h1 id="3-íŒŒì´ì¬-ì„¤ì¹˜ì™€-ì‹¤í–‰-ë°©ë²•ì„-ëª¨ë¥´ë”ë¼ë„-pyinstaller-í•˜ë‚˜ë©´-ëª¨ë“ -ê²ƒì´-ê°€ëŠ¥í•´ìš”">3. íŒŒì´ì¬ ì„¤ì¹˜ì™€ ì‹¤í–‰ ë°©ë²•ì„ ëª¨ë¥´ë”ë¼ë„ <code class="language-plaintext highlighter-rouge">pyinstaller</code> í•˜ë‚˜ë©´ ëª¨ë“  ê²ƒì´ ê°€ëŠ¥í•´ìš”!</h1>

<p>ê°œë°œì ì¹œêµ¬ì—ê²Œ ì´ ê³ ë¯¼ì„ í„¸ì–´ë†“ê¸°ë„ í•˜ê³ , ê°œì¸ì ìœ¼ë¡œ êµ¬ê¸€ë§ì„ í•˜ë©´ì„œ ì•Œê²Œ ëœ ê²ƒì€ ë°”ë¡œ  <strong>Python Executable File</strong>ì´ë¼ëŠ” ê°œë…ì´ì—ˆì–´ìš”. ì¦‰, íŒŒì´ì¬ í™˜ê²½ì„ êµ¬ì¶•í•˜ì§€ ì•Šê³ , í˜¹ì€ ëª…ë ¹ í”„ë¡¬í”„íŠ¸ ê°™ì€ í™”ì„± ê°™ì€ í™˜ê²½ì„ ê²½í—˜í•˜ì§€ ì•Šê³ ë„, <code class="language-plaintext highlighter-rouge">.exe</code> í™•ì¥ìì˜ íŒŒì¼ ìì²´ë¥¼ í´ë¦­í•˜ëŠ” ê²ƒë§Œìœ¼ë¡œ ì—…ë¬´ ìë™í™”ê°€ ì§„í–‰ë˜ëŠ” ì‹¤í–‰ íŒŒì¼ì„ ë§Œë“œëŠ” ë°©ë²•ì¸ ê²ƒì´ì£ .</p>

<p><img src="/assets/2023-07-15-pyinstaller/infinite-challenge.jpeg" alt="" /></p>

<p>ì •ë§ ê°ì‚¬í•˜ê²Œë„, íŒŒì´ì¬ì—ëŠ”  <code class="language-plaintext highlighter-rouge">pyinstaller</code>ë¼ëŠ” ëª¨ë“ˆì´ ìˆì–´ìš”.</p>

<p><a href="https://pyinstaller.org/en/stable/">PyInstaller Manual</a>ì— ë”°ë¥´ë©´,  <code class="language-plaintext highlighter-rouge">pyinstaller</code>ëŠ” Python ì• í”Œë¦¬ì¼€ì´ì…˜ ë° ì‹¤í–‰ì— í•„ìš”í•œ ëª¨ë“  í™˜ê²½ì„ í•˜ë‚˜ì˜ íŒ¨í‚¤ì§€ë¡œ ë¬¶ì–´ì¤Œìœ¼ë¡œì¨, ì‚¬ìš©ìê°€ Python Interpreterë‚˜ ëª¨ë“ˆì„ ì„¤ì¹˜í•˜ì§€ ì•Šê³  íŒ¨í‚¤ì§€ ìì²´ë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆë„ë¡ í•´ì£¼ëŠ” ìœ í‹¸ë¦¬í‹°ì…ë‹ˆë‹¤.</p>

<p>íŒŒì´ì¬ íŒŒì¼ì„ ì‹¤í–‰í•˜ê¸° ìœ„í•´ì„œëŠ” íŒŒì´ì¬ì˜ High-level ì–¸ì–´ë¥¼ Low-levelë¡œ ë³€í™˜í•´ì£¼ëŠ” <strong>Interpreter</strong>ê°€ í•„ìš”í•˜ê³ , ë˜ íŒŒì´ì¬ íŒŒì¼ ë‚´ì—ì„œ Loadí•´ì•¼ í•˜ëŠ” <strong>ëª¨ë“ˆ</strong> ì—­ì‹œ í•¨ê»˜ ì‚¬ì „ì— ì„¤ì¹˜ë˜ì–´ì•¼ í•˜ëŠ”ë°ìš”.  <code class="language-plaintext highlighter-rouge">pyinstaller</code>ëŠ” ì´ëŸ¬í•œ Interpreterì™€ ëª¨ë“ˆì„ í•¨ê»˜ ë™ë´‰í•œ ì±„ë¡œ íŒŒì´ì¬ íŒŒì¼ì„ íŒ¨í‚¤ì§•í•˜ì—¬ í•˜ë‚˜ì˜ ì‹¤í–‰ íŒŒì¼ë¡œ ë§Œë“¤ì–´ì£¼ëŠ” ì—­í• ì„ í•˜ëŠ” ê²ƒì´ì£ .</p>

<p><img src="https://miro.medium.com/v2/resize:fit:1400/0*uKgfsMJQvUG5okP2.jpg" alt="" /></p>

<h1 id="4-ipynb-íŒŒì¼ì„-exe-íŒŒì¼ë¡œ-ë§Œë“œëŠ”-ë°©ë²•">4. <code class="language-plaintext highlighter-rouge">.ipynb</code> íŒŒì¼ì„ <code class="language-plaintext highlighter-rouge">.exe</code> íŒŒì¼ë¡œ ë§Œë“œëŠ” ë°©ë²•</h1>

<p>ìš°ì„  ì—…ë¬´ ìë™í™”ì— í•„ìš”í•œ íŒŒì´ì¬ ì½”ë“œë¥¼ Jupyter Notebookìœ¼ë¡œ ì™„ì„±ì„ í•©ë‹ˆë‹¤.</p>

<p><img src="/assets/2023-07-15-pyinstaller/step01.webp" alt="" /></p>

<p>ì‚¬ìš©ìê°€ ì…ë ¥í•œ ì •ìˆ˜ì˜ ì œê³±ê°’ì„ ë¦¬í„´í•´ì£¼ëŠ” ê·€ì—¬ìš´ ì½”ë“œë¥¼ ì ì–´ë´¤ì–´ìš”.</p>

<p><code class="language-plaintext highlighter-rouge">.ipynb</code>ì„ <code class="language-plaintext highlighter-rouge">.py</code> í˜•ì‹ì˜ íŒŒì¼ë¡œ ë³€í™˜í•˜ì—¬ ë‹¤ìš´ë¡œë“œí•©ë‹ˆë‹¤.</p>

<p><img src="/assets/2023-07-15-pyinstaller/step02.webp" alt="" /></p>

<p>ì›í•˜ëŠ” ê²½ë¡œì— .py íŒŒì¼ì„ ì´ë™í•´ì¤ë‹ˆë‹¤.</p>

<p><img src="/assets/2023-07-15-pyinstaller/step03.webp" alt="" /></p>

<p>ì´ì œ  <code class="language-plaintext highlighter-rouge">pyinstaller</code>  ëª¨ë“ˆì„ ì„¤ì¹˜í•˜ê¸° ìœ„í•´ ëª…ë ¹ í”„ë¡¬í”„íŠ¸ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤. (Anaconda Powershell Promptë‚˜ Anaconda Promptê°€ ì•„ë‹Œ, Windows ìì²´ì˜ Command Promptë¥¼ ì˜ë¯¸í•´ìš”.)</p>

<p><img src="/assets/2023-07-15-pyinstaller/step04.webp" alt="" /></p>

<p><code class="language-plaintext highlighter-rouge">pyinstaller</code>  ëª¨ë“ˆ ì„¤ì¹˜ë¥¼ ìœ„í•´  <code class="language-plaintext highlighter-rouge">pip install pyinstaller</code>  ëª…ë ¹ì–´ë¥¼ ì…ë ¥í•´ì¤ë‹ˆë‹¤.</p>

<p><img src="/assets/2023-07-15-pyinstaller/step05.webp" alt="" /></p>

<p>ì´ì œ ëª…ë ¹ í™˜ê²½ì„ <code class="language-plaintext highlighter-rouge">.py</code> íŒŒì¼ì´ ë³´ê´€ë˜ì–´ ìˆëŠ” ë””ë ‰í† ë¦¬ë¡œ ë³€ê²½í•´ì¤ë‹ˆë‹¤.</p>

<p><img src="/assets/2023-07-15-pyinstaller/step06.webp" alt="" /></p>

<p><code class="language-plaintext highlighter-rouge">pyinstaller --onefile joshua_pyinstaller_practice.py</code>  ëª…ë ¹ì–´ë¥¼ í†µí•´ íŒ¨í‚¤ì§•ì„ ì‹œì‘í•©ë‹ˆë‹¤. (onefileì€ í•˜ë‚˜ì˜ íŒŒì¼ë¡œ íŒ¨í‚¤ì§•í•´ì¤˜ì•¼ í•¨ì„ ì˜ë¯¸í•´ìš”!)</p>

<p><img src="/assets/2023-07-15-pyinstaller/step07.webp" alt="" /></p>

<p>ê·¸ëŸ°ë° ê°€ë”(ì•„ë‹ˆ ë§¤ìš° ìì£¼), ì•ˆíƒ€ê¹ê²Œë„ í”„ë¡¬í”„íŠ¸ê°€  <code class="language-plaintext highlighter-rouge">pyinstaller</code>ë¼ëŠ” ëª…ë ¹ì–´ë¥¼ ì œëŒ€ë¡œ ì´í•´í•˜ì§€ ëª»í•˜ëŠ” ê²½ìš°ê°€ ë°œìƒí•´ìš”. ì´ ê²½ìš°, ëŒ€ë¶€ë¶„ ì‹œìŠ¤í…œ í™˜ê²½ ë³€ìˆ˜ë¥¼ í”„ë¡¬í”„íŠ¸ê°€ ëª¨ë¥´ê¸° ë•Œë¬¸ì— ë°œìƒí•©ë‹ˆë‹¤.</p>

<p>Windows Task Barì˜ ê²€ìƒ‰ì°½ì—ì„œ <code class="language-plaintext highlighter-rouge">Environment Variables</code>ë¥¼ ê²€ìƒ‰í•˜ì—¬ ì‹œìŠ¤í…œ í™˜ê²½ ë³€ìˆ˜ ê´€ë¦¬ í˜ì´ì§€ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.</p>

<p><img src="/assets/2023-07-15-pyinstaller/step08.webp" alt="" /></p>

<p>Advanced íƒ­ ë‚´ì˜ Environment Variables ë²„íŠ¼ì„ í´ë¦­í•©ë‹ˆë‹¤.</p>

<p><img src="/assets/2023-07-15-pyinstaller/step09.webp" alt="" /></p>

<p>User variablesì˜ Newë¥¼ í´ë¦­í•©ë‹ˆë‹¤.</p>

<p><img src="/assets/2023-07-15-pyinstaller/step10.webp" alt="" /></p>

<p>ì ì‹œ í™€ë“œí•˜ê³ , íŒŒì´ì¬ì´ ì„¤ì¹˜ë˜ì–´ ìˆëŠ” ê²½ë¡œë¥¼ í™•ì¸í•´ì•¼ í•´ìš”. ì¦‰, íŒŒì´ì¬ì˜ Scripts í´ë”ë¥¼ ì°¾ì•„ì•¼ í•˜ëŠ”ë°ìš”. ë³´í†µ  <code class="language-plaintext highlighter-rouge">Users\AppData\Local\Programs\Python\Python311</code>  ê²½ë¡œì— Scripts í´ë”ê°€ ìˆì–´ìš”.</p>

<p><img src="/assets/2023-07-15-pyinstaller/step11.webp" alt="" /></p>

<p>ê²½ë¡œë¥¼ PATH ì´ë¦„ìœ¼ë¡œ í™˜ê²½ ë³€ìˆ˜ ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€í•´ì£¼ì„¸ìš”.</p>

<p><img src="/assets/2023-07-15-pyinstaller/step12.webp" alt="" /></p>

<p><img src="/assets/2023-07-15-pyinstaller/step13.webp" alt="" /></p>

<p>ì´ëŸ° í™˜ê²½ ì„¤ì •ì´ ë„ˆë¬´ ì–´ë µë‹¤ë©´, ì‚¬ì‹¤  <a href="https://www.python.org/downloads/">Python3 Setup íŒŒì¼</a>ì„ ë‹¤ì‹œ ë‹¤ìš´ë¡œë“œí•˜ì—¬ Modifyí•˜ëŠ” ë°©ë²•ì´ ìˆì–´ìš”. ê·¸ëŸ¼ ìë™ìœ¼ë¡œ í™˜ê²½ ë³€ìˆ˜ ì„¸íŒ…ì„ ì™„ë£Œí•´ì£¼ê±°ë“ ìš”.</p>

<p><img src="/assets/2023-07-15-pyinstaller/step14.webp" alt="" /></p>

<p>Modifyë¥¼ í´ë¦­í•˜ì„¸ìš”.</p>

<p>pip ì²´í¬ ì—¬ë¶€ë¥¼ ë°˜ë“œì‹œ í™•ì¸í•œ í›„ Next ë²„íŠ¼ì„ í´ë¦­í•©ë‹ˆë‹¤.</p>

<p><img src="/assets/2023-07-15-pyinstaller/step15.webp" alt="" /></p>

<p>pipì„ ê¼­ ì²´í¬í•´ì£¼ì„¸ìš”.</p>

<p>Add Python to environment variablesë¥¼ ê¼­ ì²´í¬ í›„ Installì„ ì§„í–‰í•´ì£¼ì„¸ìš”.</p>

<p><img src="/assets/2023-07-15-pyinstaller/step16.webp" alt="" /></p>

<p>ê·¸ëŸ° í›„, Add Python to environment variablesë¥¼ ë°˜ë“œì‹œ ì²´í¬í•´ì£¼ì„¸ìš”.</p>

<p>ì ì´ì œ ë‹¤ì‹œ,  <code class="language-plaintext highlighter-rouge">pyinstaller</code>  íŒ¨í‚¤ì§•ì„ ì‹œì‘í•©ë‹ˆë‹¤.</p>

<p><img src="/assets/2023-07-15-pyinstaller/step17.webp" alt="" /></p>

<p>ë“œë””ì–´ ì„±ê³µí–ˆêµ°ìš”! ğŸ‘</p>

<p><img src="/assets/2023-07-15-pyinstaller/step18.webp" alt="" /></p>

<p><code class="language-plaintext highlighter-rouge">.py</code> íŒŒì¼ì´ ë³´ê´€ë˜ì–´ ìˆëŠ” ê²½ë¡œë¥¼ ì°¾ì•„ê°€ë³´ë©´, ìƒˆë¡œìš´ í´ë”ì™€ íŒŒì¼ë“¤ì´ ìƒì„±ëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ ì¤‘, ìš°ë¦¬ê°€ ë°°í¬í•´ì•¼ í•  ì‹¤í–‰ íŒŒì¼ì€ <code class="language-plaintext highlighter-rouge">dist</code> í´ë”ì— ìˆìœ¼ë‹ˆ, <code class="language-plaintext highlighter-rouge">dist</code> í´ë”ë¥¼ í´ë¦­í•©ë‹ˆë‹¤.</p>

<p><img src="/assets/2023-07-15-pyinstaller/step19.webp" alt="" /></p>

<p><code class="language-plaintext highlighter-rouge">.exe</code> íŒŒì¼ì´ ìƒì„±ì´ ëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. í•œ ë²ˆ ì‹¤í–‰í•´ë³¼ê¹Œìš”?</p>

<p><img src="/assets/2023-07-15-pyinstaller/step20.webp" alt="" /></p>

<p>ì˜ ì‹¤í–‰ë˜ë„¤ìš”!ğŸ˜ƒ</p>

<p><img src="/assets/2023-07-15-pyinstaller/step21.webp" alt="" /></p>

<p><img src="/assets/2023-07-15-pyinstaller/congratulations.jpeg" alt="" /></p>

<p>ì´ì œ ë§ˆì¹˜ í´ë¼ì´ì–¸íŠ¸ í˜•íƒœë¡œ <code class="language-plaintext highlighter-rouge">.exe</code> íŒŒì¼ë§Œ ë°°í¬í•˜ë©´, íŒŒì´ì¬ í™˜ê²½ ì„¤ì¹˜ì— ëŒ€í•œ ë¶€ë‹´ ì—†ì´ë„ ëˆ„êµ¬ë‚˜ í¸ë¦¬í•˜ê²Œ ì›í´ë¦­ ì—…ë¬´ ìë™í™”ë¥¼ ëˆ„ë¦´ ìˆ˜ ìˆë‹µë‹ˆë‹¤!</p>

<h1 id="5--ë°ì´í„°-ë¶„ì„ê°€ê°€-ê°–ì¶”ì–´ì•¼-í•˜ëŠ”-ì¤‘ìš”í•œ-íƒœë„-ë– ë¨¹ì—¬-ë“œë¦¬ê¸°">5.  ë°ì´í„° ë¶„ì„ê°€ê°€ ê°–ì¶”ì–´ì•¼ í•˜ëŠ” ì¤‘ìš”í•œ íƒœë„, â€œë– ë¨¹ì—¬ ë“œë¦¬ê¸°â€</h1>

<p><img src="/assets/2023-07-15-pyinstaller/feeding.png" alt="" /></p>

<p>ì œê°€ íšŒì‚¬ì—ì„œ ë™ë£Œ ë¶„ë“¤ê»˜ ë°˜ ë†ë‹´, ë°˜ ì§„ë‹´ìœ¼ë¡œ ë§ì”€ ë“œë¦¬ëŠ” ìŠ¬ë¡œê±´ì´ ìˆëŠ”ë°ìš”. ë°”ë¡œ â€œ<code class="language-plaintext highlighter-rouge">ë– ë¨¹ì—¬ ë“œë¦´ê²Œìš”</code>â€ë¼ëŠ” í‘œí˜„ì…ë‹ˆë‹¤.</p>

<p>ë°ì´í„°ëŠ” ëŠ˜ ì–´ë µê³ , í•µì‹¬ì„ ê¿°ëš«ì´ëŠ” ë”ìš± ì–´ë ¤ìš´ ê²ƒ ê°™ì•„ìš”. ë°ì´í„° ë¶„ì„ê°€ì—ê²Œë„ ëŠ˜ ì–´ë ¤ìš´ ì¼ì¸ë°, ë‹¤ë¥¸ ë™ë£Œ ë¶„ë“¤ê»˜ëŠ” ì–¼ë§ˆë‚˜ ë” ì–´ë ¤ìš¸ê¹Œìš”.</p>

<p><strong>ë°ì´í„° ë“œë¦¬ë¸ ë¬¸í™”</strong>ë¥¼ ìœ„í•´ í•¨ê»˜ ë°ì´í„°ë¥¼ F/UPí•´ì•¼ í•˜ëŠ” ë™ë£Œ ë¶„ë“¤ì˜ ë¶€ë‹´ì„ ì¡°ê¸ˆì´ë¼ë„ ì¤„ì—¬ë“œë¦¬ëŠ” Softí•œ ì—­ëŸ‰ì´ ë°ì´í„° ë¶„ì„ê°€ì—ê²Œ ìš”êµ¬ë˜ê¸° ë•Œë¬¸ì—, ë– ë¨¹ì—¬ ë“œë¦¬ê¸° ìœ„í•œ ë…¸ë ¥ì„ ì§€ì†ì ìœ¼ë¡œ ì‹¤ì²œí•˜ëŠ” ê²ƒì´ ì •ë§ ì¤‘ìš”í•˜ë‹¤ê³  ìƒê°í•˜ëŠ”ë°ìš”. ê°€ë§Œíˆ ëˆ„ì›Œì„œ ì…ë§Œ ë²Œë¦¬ê³  ê³„ì…”ë„ ë– ë¨¹ì—¬ ë“œë¦´ ìˆ˜ ìˆëŠ”, ê·¸ëŸ° ë°ì´í„° ë¶„ì„ê°€ê°€ ë˜ëŠ” ê²ƒì´ ì œê²ŒëŠ” Midterm ëª©í‘œê°€ ëœ ê²ƒ ê°™ìŠµë‹ˆë‹¤.</p>

<p>ì´ëŸ° ì˜ë¯¸ì—ì„œ ì´ë²ˆ íŒŒì´ì¬ í´ë¼ì´ì–¸íŠ¸ ê°œë°œê¸°ëŠ” ë‹¨ìˆœí•œ ê°œë°œê¸° ì´ìƒìœ¼ë¡œ, ë°ì´í„°ë¥¼ ì—…ë¬´ì— ë¹ ë¥´ê²Œ ë°˜ì˜í•˜ì—¬ Pain Pointë¥¼ ì†ì‰½ê²Œ í•´ê²°í•´ë“œë¦¬ê³ ì ë…¸ë ¥í•´ë³¸ ì €ì˜ â€œ<code class="language-plaintext highlighter-rouge">ë– ë¨¹ì—¬ ë“œë¦´ê²Œìš”</code>â€ í”„ë¡œì íŠ¸ ì¤‘ í•˜ë‚˜ì˜€ìŠµë‹ˆë‹¤.</p>

<p>ë– ë¨¹ì—¬ ë“œë¦¬ê¸°ë„ í•˜ê³ , ì € ë˜í•œ ê·€ì¤‘í•œ ì„œë¸Œ ì§€ì‹ë“¤ì„ í•¨ì–‘í•  ìˆ˜ ìˆì—ˆë˜ ê²ƒ ê°™ì•„ì„œ ì°¸ ë¿Œë“¯í•˜ê¸°ë„ í–ˆì–´ìš”. ì•ìœ¼ë¡œ ë˜ ì–´ë–¤  <strong>ì„œë¸Œ ì—…ë¬´</strong>ë“¤ì´ ì €ë¥¼ ê¸°ë‹¤ë¦¬ê³  ìˆì„ê¹Œìš”? ë¨¼ ì‚°ì„ ë³´ë©° ê¸€ì„ ë§ˆì¹©ë‹ˆë‹¤. ì½ì–´ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤.</p>

<hr />

<h2 id="published-by-joshua-kim"><em>Published by</em> Joshua Kim</h2>
<p><img src="/assets/profile/joshua-profile.png" alt="Joshua Kim" /></p>]]></content><author><name></name></author><category term="korean" /><category term="python" /><summary type="html"><![CDATA[íŒŒì´ì¬ íŒŒì¼ì„ ì‹¤í–‰í•˜ê¸° ìœ„í•´ì„œëŠ” íŒŒì´ì¬ì˜ High-level ì–¸ì–´ë¥¼ Low-levelë¡œ ë³€í™˜í•´ì£¼ëŠ” Interpreterê°€ í•„ìš”í•˜ê³ , ë˜ íŒŒì´ì¬ íŒŒì¼ ë‚´ì—ì„œ Loadí•´ì•¼ í•˜ëŠ” ëª¨ë“ˆ ì—­ì‹œ í•¨ê»˜ ì‚¬ì „ì— ì„¤ì¹˜ë˜ì–´ì•¼ í•˜ëŠ”ë°ìš”. pyinstallerëŠ” ì´ëŸ¬í•œ Interpreterì™€ ëª¨ë“ˆì„ í•¨ê»˜ ë™ë´‰í•œ ì±„ë¡œ íŒŒì´ì¬ íŒŒì¼ì„ íŒ¨í‚¤ì§•í•˜ì—¬ í•˜ë‚˜ì˜ ì‹¤í–‰ íŒŒì¼ë¡œ ë§Œë“¤ì–´ì£¼ëŠ” ì—­í• ì„ í•˜ëŠ” ê²ƒì´ì£ .]]></summary></entry><entry><title type="html">Itâ€™s Harder than You Think to Extract DAU Separating New and Existing Users in BigQuery</title><link href="http://localhost:4000/extract-dau-separating-new-and-existing-users/" rel="alternate" type="text/html" title="Itâ€™s Harder than You Think to Extract DAU Separating New and Existing Users in BigQuery" /><published>2023-06-14T00:00:00+09:00</published><updated>2023-06-14T00:00:00+09:00</updated><id>http://localhost:4000/extract-dau-separating-new-and-existing-users</id><content type="html" xml:base="http://localhost:4000/extract-dau-separating-new-and-existing-users/"><![CDATA[<blockquote>
  <p>In this article, Iâ€™m going to talk about how to extract DAU separating new users and existing users directly from BigQuery. I prepared an insightful example to share some intuition with you, so that you can better understand.</p>
</blockquote>

<h3 id="contents">CONTENTS</h3>
<ol>
  <li>Full BigQuery Codes</li>
  <li>Step by Step</li>
  <li>An Intuitive Example</li>
  <li>Review Full BigQuery Codes</li>
</ol>

<hr />

<p><img src="/assets/2023-06-14-extract-dau-separating-new-and-existing-users/data-pipeline.webp" alt="" /></p>
<blockquote>
  <p>Data pipeline from the website all the way up to Redash</p>
</blockquote>

<h1 id="1-full-bigquery-codes">1. Full BigQuery Codes</h1>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">WITH</span>  
<span class="n">CTE_flattened</span> <span class="k">AS</span> <span class="p">(</span>  
  <span class="c1">-- Confidential  </span>
<span class="p">),</span>  
<span class="n">CTE_users_min_gsn</span> <span class="k">AS</span> <span class="p">(</span>  
    <span class="k">SELECT</span>  
        <span class="n">PARSE_DATE</span><span class="p">(</span><span class="s1">'%Y%m%d'</span><span class="p">,</span> <span class="n">event_date</span><span class="p">)</span> <span class="k">AS</span> <span class="nb">date</span><span class="p">,</span>  
        <span class="n">user_pseudo_id</span><span class="p">,</span>  
        <span class="k">MIN</span><span class="p">(</span><span class="n">ga_session_number</span><span class="p">)</span> <span class="k">AS</span> <span class="n">min_gsn</span>  
    <span class="k">FROM</span>
	    <span class="n">CTE_flattened</span>  
    <span class="k">WHERE</span> 
	    <span class="n">event_name</span> <span class="o">=</span> <span class="s1">'session_start'</span>  
    <span class="k">GROUP</span> <span class="k">BY</span> 
	    <span class="n">event_date</span><span class="p">,</span> <span class="n">user_pseudo_id</span>  
<span class="p">)</span>  
<span class="k">SELECT</span>  
    <span class="nb">date</span><span class="p">,</span>  
    <span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="n">user_pseudo_id</span><span class="p">)</span> <span class="k">AS</span> <span class="n">dau_all</span><span class="p">,</span>  
    <span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="k">CASE</span> <span class="k">WHEN</span> <span class="n">min_gsn</span> <span class="o">&lt;&gt;</span> <span class="mi">1</span> <span class="k">THEN</span> <span class="n">user_pseudo_id</span> <span class="k">END</span><span class="p">)</span> <span class="k">AS</span> <span class="n">dau_existing</span><span class="p">,</span>  
    <span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="k">CASE</span> <span class="k">WHEN</span> <span class="n">min_gsn</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">THEN</span> <span class="n">user_pseudo_id</span> <span class="k">END</span><span class="p">)</span> <span class="k">AS</span> <span class="n">dau_new</span>  
<span class="k">FROM</span>
	<span class="n">CTE_users_min_gsn</span>  
<span class="k">GROUP</span> <span class="k">BY</span> 
	<span class="nb">date</span>  
<span class="k">ORDER</span> <span class="k">BY</span> 
	<span class="nb">date</span>  
<span class="p">;</span>
</code></pre></div></div>

<h1 id="2-step-by-step">2. Step by Step</h1>

<h2 id="21-daily-initial-session-sequence-values">2.1. Daily Initial Session Sequence Values</h2>

<p>First off, extract the <strong>daily initial session sequence values</strong> of all the users triggering <code class="language-plaintext highlighter-rouge">session_start</code>event.</p>
<ul>
  <li>the session sequence values are named <code class="language-plaintext highlighter-rouge">ga_session_number</code>in <a href="https://support.google.com/analytics/answer/7029846?hl=en#zippy=%2Cevent">BigQuery Export Schema of Google Analytics 4</a>.</li>
  <li>When a user(<code class="language-plaintext highlighter-rouge">user_pseudo_id</code>) starts their session for the first time, the  <code class="language-plaintext highlighter-rouge">ga_session_number</code>  in the event parameters equals to <code class="language-plaintext highlighter-rouge">1</code>, and then it increases sequentially each time the user returns and starts the new session again.</li>
</ul>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">CTE_users_min_gsn</span> <span class="k">AS</span> <span class="p">(</span>  
    <span class="k">SELECT</span>  
        <span class="n">PARSE_DATE</span><span class="p">(</span><span class="s1">'%Y%m%d'</span><span class="p">,</span> <span class="n">event_date</span><span class="p">)</span> <span class="k">AS</span> <span class="nb">date</span><span class="p">,</span>  
        <span class="n">user_pseudo_id</span><span class="p">,</span>  
        <span class="k">MIN</span><span class="p">(</span><span class="n">ga_session_number</span><span class="p">)</span> <span class="k">AS</span> <span class="n">min_gsn</span>  
    <span class="k">FROM</span>
	    <span class="n">CTE_flattened</span>
    <span class="k">WHERE</span> 
	    <span class="n">event_name</span> <span class="o">=</span> <span class="s1">'session_start'</span>  
    <span class="k">GROUP</span> <span class="k">BY</span> 
	    <span class="n">event_date</span><span class="p">,</span> <span class="n">user_pseudo_id</span>  
<span class="p">)</span>
</code></pre></div></div>

<h2 id="22-separating-new--existing-users">2.2. Separating New &amp; Existing Users</h2>

<p>For the second step, categorize users as new or existing based on whether the <strong>daily initial session sequence value</strong> is <code class="language-plaintext highlighter-rouge">1</code> or <code class="language-plaintext highlighter-rouge">not</code> on a daily basis.</p>
<ul>
  <li>A user named Joshua, who first visited your website for example, can trigger multiple <code class="language-plaintext highlighter-rouge">session_start</code>events in a single day.</li>
  <li>Even though he returns to the website after his first visit, he should be still regarded as one of the new users when calculating on a daily basis.</li>
  <li>That â€˜s why I mentioned above that you need to extract the <strong>â€œdailyâ€ initial session sequence values</strong> of all the users.</li>
</ul>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span>  
    <span class="nb">date</span><span class="p">,</span>  
    <span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="n">user_pseudo_id</span><span class="p">)</span> <span class="k">AS</span> <span class="n">dau_all</span><span class="p">,</span>  
    <span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="k">CASE</span> <span class="k">WHEN</span> <span class="n">min_gsn</span> <span class="o">&lt;&gt;</span> <span class="mi">1</span> <span class="k">THEN</span> <span class="n">user_pseudo_id</span> <span class="k">END</span><span class="p">)</span> <span class="k">AS</span> <span class="n">dau_existing</span><span class="p">,</span>  
    <span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="k">CASE</span> <span class="k">WHEN</span> <span class="n">min_gsn</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">THEN</span> <span class="n">user_pseudo_id</span> <span class="k">END</span><span class="p">)</span> <span class="k">AS</span> <span class="n">dau_new</span>  
<span class="k">FROM</span>
	<span class="n">CTE_users_min_gsn</span>  
<span class="k">GROUP</span> <span class="k">BY</span> 
	<span class="nb">date</span>  
<span class="k">ORDER</span> <span class="k">BY</span> 
	<span class="nb">date</span>
<span class="p">;</span>
</code></pre></div></div>

<h1 id="3-an-intuitive-example">3. An Intuitive Example</h1>

<table>
  <thead>
    <tr>
      <th>Â </th>
      <th><strong>Jan 1, before noon</strong></th>
      <th><strong>Jan 1, afternoon</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><strong>Joshua</strong></td>
      <td>1st Visit</td>
      <td>2nd Visit</td>
    </tr>
    <tr>
      <td><strong>Shane</strong></td>
      <td>-</td>
      <td>1st Visit</td>
    </tr>
    <tr>
      <td><strong>Chloe</strong></td>
      <td>2nd Visit</td>
      <td>-</td>
    </tr>
    <tr>
      <td><strong>Angela</strong></td>
      <td>1st Visit</td>
      <td>2nd Visit</td>
    </tr>
  </tbody>
</table>

<p>On January 1st, the DAU will be:</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">3 New Users</code> (Joshua, Shane, and Angela)</li>
  <li><code class="language-plaintext highlighter-rouge">1 Existing User</code> (Chloe)</li>
</ul>

<p>Keep in mind that Joshua and Angela are regarded as the new users <strong>in spite of the fact that they made their second visit</strong>.</p>

<h3 id="step-1-identify-the-session-sequence-values-of-all-the-users">STEP 1. Identify the session sequence values of all the users.</h3>

<table>
  <thead>
    <tr>
      <th>Â </th>
      <th><strong>Jan 1, before noon</strong></th>
      <th><strong>Jan 1, afternoon</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><strong>Joshua</strong></td>
      <td><code class="language-plaintext highlighter-rouge">ga_session_number</code> = 1</td>
      <td><code class="language-plaintext highlighter-rouge">ga_session_number</code> = 2</td>
    </tr>
    <tr>
      <td><strong>Shane</strong></td>
      <td>-</td>
      <td><code class="language-plaintext highlighter-rouge">ga_session_number</code> = 1</td>
    </tr>
    <tr>
      <td><strong>Chloe</strong></td>
      <td><code class="language-plaintext highlighter-rouge">ga_session_number</code> = 45</td>
      <td>-</td>
    </tr>
    <tr>
      <td><strong>Angela</strong></td>
      <td><code class="language-plaintext highlighter-rouge">ga_session_number</code> = 1</td>
      <td><code class="language-plaintext highlighter-rouge">ga_session_number</code> = 2</td>
    </tr>
  </tbody>
</table>

<h3 id="step2-aggregate-each-user-with-the-minimum-session-sequence-value">STEP2. Aggregate each user with the minimum session sequence value.</h3>

<table>
  <thead>
    <tr>
      <th>Â </th>
      <th><strong>Jan 1</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><strong>Joshua</strong></td>
      <td><code class="language-plaintext highlighter-rouge">ga_session_number</code> = 1</td>
    </tr>
    <tr>
      <td><strong>Shane</strong></td>
      <td><code class="language-plaintext highlighter-rouge">ga_session_number</code> = 1</td>
    </tr>
    <tr>
      <td><strong>Chloe</strong></td>
      <td><code class="language-plaintext highlighter-rouge">ga_session_number</code> = 45</td>
    </tr>
    <tr>
      <td><strong>Angela</strong></td>
      <td><code class="language-plaintext highlighter-rouge">ga_session_number</code> = 1</td>
    </tr>
  </tbody>
</table>

<h3 id="step-3-classify-each-user-as-a-new-or-existing-user-based-on-whether-or-not-the-minimum-session-sequence-value-equals-to-1">STEP 3. Classify each user as a new or existing user based on whether or not the minimum session sequence value equals to 1.</h3>

<table>
  <thead>
    <tr>
      <th>Â </th>
      <th><strong>Jan 1</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><strong>Joshua</strong></td>
      <td><code class="language-plaintext highlighter-rouge">New User</code></td>
    </tr>
    <tr>
      <td><strong>Shane</strong></td>
      <td><code class="language-plaintext highlighter-rouge">New User</code></td>
    </tr>
    <tr>
      <td><strong>Chloe</strong></td>
      <td><code class="language-plaintext highlighter-rouge">Existing User</code></td>
    </tr>
    <tr>
      <td><strong>Angela</strong></td>
      <td><code class="language-plaintext highlighter-rouge">New User</code></td>
    </tr>
  </tbody>
</table>

<h1 id="4-review-full-bigquery-codes">4. Review Full BigQuery Codes</h1>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">WITH</span>  
<span class="n">CTE_flattened</span> <span class="k">AS</span> <span class="p">(</span>  
  <span class="c1">-- Confidential  </span>
<span class="p">),</span>  
<span class="n">CTE_users_min_gsn</span> <span class="k">AS</span> <span class="p">(</span>  
    <span class="k">SELECT</span>  
        <span class="n">PARSE_DATE</span><span class="p">(</span><span class="s1">'%Y%m%d'</span><span class="p">,</span> <span class="n">event_date</span><span class="p">)</span> <span class="k">AS</span> <span class="nb">date</span><span class="p">,</span>  
        <span class="n">user_pseudo_id</span><span class="p">,</span>  
        <span class="k">MIN</span><span class="p">(</span><span class="n">ga_session_number</span><span class="p">)</span> <span class="k">AS</span> <span class="n">min_gsn</span>  
    <span class="k">FROM</span>
	    <span class="n">CTE_flattened</span>  
    <span class="k">WHERE</span> 
	    <span class="n">event_name</span> <span class="o">=</span> <span class="s1">'session_start'</span>  
    <span class="k">GROUP</span> <span class="k">BY</span> 
	    <span class="n">event_date</span><span class="p">,</span> <span class="n">user_pseudo_id</span>  
<span class="p">)</span>  
<span class="k">SELECT</span>  
    <span class="nb">date</span><span class="p">,</span>  
    <span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="n">user_pseudo_id</span><span class="p">)</span> <span class="k">AS</span> <span class="n">dau_all</span><span class="p">,</span>  
    <span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="k">CASE</span> <span class="k">WHEN</span> <span class="n">min_gsn</span> <span class="o">&lt;&gt;</span> <span class="mi">1</span> <span class="k">THEN</span> <span class="n">user_pseudo_id</span> <span class="k">END</span><span class="p">)</span> <span class="k">AS</span> <span class="n">dau_existing</span><span class="p">,</span>  
    <span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="k">CASE</span> <span class="k">WHEN</span> <span class="n">min_gsn</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">THEN</span> <span class="n">user_pseudo_id</span> <span class="k">END</span><span class="p">)</span> <span class="k">AS</span> <span class="n">dau_new</span>  
<span class="k">FROM</span>
	<span class="n">CTE_users_min_gsn</span>  
<span class="k">GROUP</span> <span class="k">BY</span> 
	<span class="nb">date</span>  
<span class="k">ORDER</span> <span class="k">BY</span> 
	<span class="nb">date</span>  
<span class="p">;</span>
</code></pre></div></div>

<hr />

<h2 id="published-by-joshua-kim"><em>Published by</em> Joshua Kim</h2>
<p><img src="/assets/profile/joshua-profile.png" alt="Joshua Kim" /></p>]]></content><author><name></name></author><category term="english" /><category term="sql" /><category term="data_analytics" /><category term="bigquery" /><summary type="html"><![CDATA[In this article, Iâ€™m going to talk about how to extract DAU separating new users and existing users directly from BigQuery. I prepared an insightful example to share some intuition with you, so that you can better understand.]]></summary></entry><entry><title type="html">Ethereum On-chain Data: DAU, MAU, Stickiness, and Retention</title><link href="http://localhost:4000/ethereum-on-chain-data/" rel="alternate" type="text/html" title="Ethereum On-chain Data: DAU, MAU, Stickiness, and Retention" /><published>2023-05-29T00:00:00+09:00</published><updated>2023-05-29T00:00:00+09:00</updated><id>http://localhost:4000/ethereum-on-chain-data</id><content type="html" xml:base="http://localhost:4000/ethereum-on-chain-data/"><![CDATA[<blockquote>
  <p>In this article, Iâ€™m going to deep dive into Ethereum On-chain Data Analysis not just with the  <strong>DAU</strong>  and  <strong>MAU,</strong> but also with  <strong>Stickiness</strong>, and  <strong>Retention Rate</strong>, which are the basic metrics when it comes to data analysis. Letâ€™s directly dive into it!</p>
</blockquote>

<h3 id="contents">CONTENTS</h3>
<ol>
  <li>Introduction</li>
  <li>DAU, MAU, and Stickiness (All the Transactions)
    <ul>
      <li>2.1.  Ethereum DAU and 30-day Moving MAU</li>
      <li>2.2. Ethereum DAU (by new and existing addresses)</li>
      <li>2.3. Ethereum DAU (by transaction types)</li>
      <li>2.4. Ethereum Stickiness</li>
    </ul>
  </li>
  <li>DAU, MAU, and Stickiness (Contract Call Only)
    <ul>
      <li>3.1. Ethereum DAU and 30-day Moving MAU</li>
      <li>3.2. Ethereum DAU (new and existing addresses)</li>
      <li>3.3. Ethereum DAU (by transaction types)</li>
      <li>3.4. Ethereum Stickiness</li>
    </ul>
  </li>
  <li>Cohord Retention (Contract Call Only)
    <ul>
      <li>4.1. Ethereum Cohort Retention (Since Jan 2023)</li>
      <li>4.2. Ethereum Cohort Retention (Since Jan 2022)</li>
    </ul>
  </li>
  <li>Why the Retention rate was high in May 2023?</li>
  <li>Conclusion</li>
</ol>

<hr />

<h1 id="1-introduction">1. Introduction</h1>

<p>There are already many Ethereum on-chain data analytics platforms such as Messari, Glassnode, and of course, Etherscan.</p>

<p><img src="/assets/2023-05-29-ethereum-on-chain-data/messari.webp" alt="" /></p>
<blockquote>
  <p>Ethereum Daily Number of Active Addresses (Messari)</p>
</blockquote>

<p><img src="/assets/2023-05-29-ethereum-on-chain-data/glassnode.webp" alt="" /></p>
<blockquote>
  <p>Ethereum Daily Number of Active Addresses (Glassnode)</p>
</blockquote>

<p><img src="/assets/2023-05-29-ethereum-on-chain-data/etherscan.webp" alt="" /></p>
<blockquote>
  <p>Ethereum Daily Number of Transactions Broadcasted (Etherscan)</p>
</blockquote>

<p>Unfortunately, The charts above arenâ€™t very helpful if you try to deeply analyze the on-chain data and find a specific action point regarding any blockchain services.</p>

<p>Inthis article, Iâ€™m going to deep dive into Ethereum On-chain Data Analysis not just with the  <strong>DAU</strong>  and  <strong>MAU,</strong> but also with  <strong>Stickiness</strong>, and  <strong>Retention Rate</strong>, which are the most basic metrics when it comes to Data Analysis. Letâ€™s directly dive into it!</p>

<h1 id="2-dau-mau-and-stickiness-all-the-transactions">2. DAU, MAU, and Stickiness (All the Transactions)</h1>

<h2 id="21--ethereum-dau-and-30-day-moving-mau">2.1.  Ethereum DAU and 30-day Moving MAU</h2>

<p>Basically, I am not able to discern any meaningful insights from the chart below as a data analyst.</p>

<p><img src="/assets/2023-05-29-ethereum-on-chain-data/ethereum-dau-mau.webp" alt="" /></p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">WITH</span>  
<span class="n">CTE_raw</span> <span class="k">AS</span> <span class="p">(</span>
    <span class="k">SELECT</span>  
        <span class="n">DATE_TRUNC</span><span class="p">(</span><span class="s1">'DAY'</span><span class="p">,</span> <span class="n">block_time</span><span class="p">)</span> <span class="k">AS</span> <span class="n">block_date</span><span class="p">,</span>  
        <span class="n">block_number</span><span class="p">,</span>  
        <span class="nv">"from"</span> <span class="k">AS</span> <span class="n">from_address</span><span class="p">,</span> <span class="n">nonce</span><span class="p">,</span>  
        <span class="n">success</span><span class="p">,</span> <span class="k">type</span><span class="p">,</span>  
        <span class="n">value</span><span class="p">,</span> <span class="k">data</span>  
    <span class="k">FROM</span> 
	    <span class="n">ethereum</span><span class="p">.</span><span class="n">transactions</span>  
    <span class="k">WHERE</span>  
        <span class="n">block_time</span> <span class="o">&gt;=</span> <span class="nb">TIMESTAMP</span> <span class="s1">'2022-12-01'</span>  
        <span class="k">AND</span> <span class="n">success</span> <span class="o">=</span> <span class="k">true</span>  
<span class="p">),</span>  
<span class="n">CTE_dau_mau</span> <span class="k">AS</span> <span class="p">(</span>
    <span class="k">SELECT</span>  
        <span class="n">block_date</span><span class="p">,</span>  
        <span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="n">from_address</span><span class="p">)</span> <span class="k">AS</span> <span class="n">dau</span><span class="p">,</span>  
        <span class="p">(</span>  
            <span class="k">SELECT</span>
	            <span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="n">from_address</span><span class="p">)</span>  
            <span class="k">FROM</span> 
	            <span class="n">CTE_raw</span> <span class="n">SUB</span>  
            <span class="k">WHERE</span>  
                <span class="n">DATE_ADD</span><span class="p">(</span><span class="s1">'DAY'</span><span class="p">,</span> <span class="o">-</span><span class="mi">29</span><span class="p">,</span> <span class="n">MAIN</span><span class="p">.</span><span class="n">block_date</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">SUB</span><span class="p">.</span><span class="n">block_date</span>  
                <span class="k">AND</span> <span class="n">SUB</span><span class="p">.</span><span class="n">block_date</span> <span class="o">&lt;=</span> <span class="n">DATE_TRUNC</span><span class="p">(</span><span class="s1">'DAY'</span><span class="p">,</span> <span class="n">MAIN</span><span class="p">.</span><span class="n">block_date</span><span class="p">)</span>  
        <span class="p">)</span> <span class="k">AS</span> <span class="n">mau</span>  
    <span class="k">FROM</span>
	    <span class="n">CTE_raw</span> <span class="n">MAIN</span>  
    <span class="k">GROUP</span> <span class="k">BY</span>
	    <span class="n">block_date</span>  
    <span class="k">ORDER</span> <span class="k">BY</span> 
	    <span class="n">block_date</span> <span class="k">DESC</span>  
<span class="p">)</span>  
<span class="k">SELECT</span>
	<span class="o">*</span>  
<span class="k">FROM</span> 
	<span class="n">CTE_dau_mau</span>  
<span class="k">WHERE</span> 
	<span class="n">block_date</span> <span class="o">&gt;=</span> <span class="nb">TIMESTAMP</span> <span class="s1">'2023-01-01'</span>  
<span class="k">ORDER</span> <span class="k">BY</span> 
	<span class="n">block_date</span> <span class="k">DESC</span>  
<span class="p">;</span>
</code></pre></div></div>

<h2 id="22-ethereum-dau-by-new-and-existing-addresses">2.2. Ethereum DAU (by new and existing addresses)</h2>

<p>Here, Iâ€™ve distinguished daily new addresses from existing ones depending on the <strong>Nonce</strong> values.</p>
<ul>
  <li>If a transaction has a nonce of 0, itâ€™s considered to be broadcast by <strong>a new address</strong>.</li>
  <li>On the other hand, if a transaction nonce is not equal to 0, itâ€™s considered to be broadcast by <strong>an existing address</strong>.</li>
</ul>

<p>Despite this analysis, I am still not able to discern any meaningful insights from the chart below.</p>

<p><img src="/assets/2023-05-29-ethereum-on-chain-data/ethereum-dau-new-vs-old.webp" alt="" /></p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">WITH</span>  
<span class="n">CTE_raw</span> <span class="k">AS</span> <span class="p">(</span>
    <span class="k">SELECT</span>  
        <span class="n">DATE_TRUNC</span><span class="p">(</span><span class="s1">'DAY'</span><span class="p">,</span> <span class="n">block_time</span><span class="p">)</span> <span class="k">AS</span> <span class="n">block_date</span><span class="p">,</span>  
        <span class="n">block_number</span><span class="p">,</span>  
        <span class="nv">"from"</span> <span class="k">AS</span> <span class="n">from_address</span><span class="p">,</span>   
        <span class="k">CASE</span>  
            <span class="k">WHEN</span> <span class="n">nonce</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">THEN</span> <span class="s1">'new_address'</span>  
            <span class="k">ELSE</span> <span class="s1">'existing_address'</span>  
        <span class="k">END</span> <span class="k">AS</span> <span class="n">new_existing</span><span class="p">,</span>  
        <span class="n">success</span><span class="p">,</span> <span class="k">type</span><span class="p">,</span>  
        <span class="n">value</span><span class="p">,</span> <span class="k">data</span>  
    <span class="k">FROM</span>
	    <span class="n">ethereum</span><span class="p">.</span><span class="n">transactions</span>  
    <span class="k">WHERE</span>  
        <span class="n">block_time</span> <span class="o">&gt;=</span> <span class="nb">TIMESTAMP</span> <span class="s1">'2022-12-01'</span>  
        <span class="k">AND</span> <span class="n">success</span> <span class="o">=</span> <span class="k">true</span>  
<span class="p">),</span>  
<span class="n">CTE_dnu_mnu</span> <span class="k">AS</span> <span class="p">(</span>
    <span class="k">SELECT</span>  
        <span class="n">block_date</span><span class="p">,</span>  
        <span class="n">new_existing</span><span class="p">,</span>  
        <span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="n">from_address</span><span class="p">)</span> <span class="k">AS</span> <span class="n">dnu</span><span class="p">,</span>  
        <span class="p">(</span>  
            <span class="k">SELECT</span>
	            <span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="n">from_address</span><span class="p">)</span>  
            <span class="k">FROM</span> 
	            <span class="n">CTE_raw</span> <span class="n">SUB</span>  
            <span class="k">WHERE</span>  
                <span class="n">DATE_ADD</span><span class="p">(</span><span class="s1">'DAY'</span><span class="p">,</span> <span class="o">-</span><span class="mi">29</span><span class="p">,</span> <span class="n">MAIN</span><span class="p">.</span><span class="n">block_date</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">SUB</span><span class="p">.</span><span class="n">block_date</span>  
                <span class="k">AND</span> <span class="n">SUB</span><span class="p">.</span><span class="n">block_date</span> <span class="o">&lt;=</span> <span class="n">DATE_TRUNC</span><span class="p">(</span><span class="s1">'DAY'</span><span class="p">,</span> <span class="n">MAIN</span><span class="p">.</span><span class="n">block_date</span><span class="p">)</span>  
        <span class="p">)</span> <span class="k">AS</span> <span class="n">mnu</span>  
    <span class="k">FROM</span>
	    <span class="n">CTE_raw</span> <span class="n">MAIN</span>  
    <span class="k">GROUP</span> <span class="k">BY</span> 
	    <span class="n">block_date</span><span class="p">,</span> <span class="n">new_existing</span>  
    <span class="k">ORDER</span> <span class="k">BY</span> 
	    <span class="n">block_date</span> <span class="k">DESC</span><span class="p">,</span> <span class="n">new_existing</span>  
<span class="p">)</span>  
<span class="k">SELECT</span>
	<span class="o">*</span>  
<span class="k">FROM</span>
	<span class="n">CTE_dnu_mnu</span>  
<span class="k">WHERE</span> 
	<span class="n">block_date</span> <span class="o">&gt;=</span> <span class="nb">TIMESTAMP</span> <span class="s1">'2023-01-01'</span>  
<span class="k">ORDER</span> <span class="k">BY</span> 
	<span class="n">block_date</span> <span class="k">DESC</span>  
<span class="p">;</span>
</code></pre></div></div>

<h2 id="23-ethereum-dau-by-transaction-types">2.3. Ethereum DAU (by transaction types)</h2>

<p>Here, Iâ€™ve distinquished daily new addresses from existing ones depending on the <strong>Nonce</strong> values.</p>
<ul>
  <li>If a transaction has a nonce of 0, itâ€™s considered to be broadcast by <strong>a new address</strong>.</li>
  <li>On the other hand, if a transaction nonce is not equal to 0, itâ€™s considered to be broadcast by <strong>an existing address</strong>.</li>
</ul>

<p>Despite this analysis, I am still not able to discern any meaningful insights from the chart below.</p>

<p>Again, I am still not able to discern any meaningful insights from the chart below.</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">DynamicFee</code> indicates that the transaction has been broadcast in compliance with EIP-1559.</li>
  <li><code class="language-plaintext highlighter-rouge">Legacy</code> signifies that the transaction has been broadcast using the traditional data format.</li>
</ul>

<p><img src="/assets/2023-05-29-ethereum-on-chain-data/ethereum-dau-tx-type.webp" alt="" /></p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">WITH</span>  
<span class="n">CTE_raw</span> <span class="k">AS</span> <span class="p">(</span>
    <span class="k">SELECT</span>  
        <span class="n">DATE_TRUNC</span><span class="p">(</span><span class="s1">'DAY'</span><span class="p">,</span> <span class="n">block_time</span><span class="p">)</span> <span class="k">AS</span> <span class="n">block_date</span><span class="p">,</span>  
        <span class="n">block_number</span><span class="p">,</span>  
        <span class="nv">"from"</span> <span class="k">AS</span> <span class="n">from_address</span><span class="p">,</span> <span class="n">nonce</span><span class="p">,</span>  
        <span class="n">success</span><span class="p">,</span> <span class="k">type</span><span class="p">,</span>  
        <span class="n">value</span><span class="p">,</span> <span class="k">data</span>  
    <span class="k">FROM</span>
	    <span class="n">ethereum</span><span class="p">.</span><span class="n">transactions</span>  
    <span class="k">WHERE</span>  
        <span class="n">block_time</span> <span class="o">&gt;=</span> <span class="nb">TIMESTAMP</span> <span class="s1">'2022-12-01'</span>  
        <span class="k">AND</span> <span class="n">success</span> <span class="o">=</span> <span class="k">true</span>  
<span class="p">),</span>  
<span class="n">CTE_dau_mau</span> <span class="k">AS</span> <span class="p">(</span>   
    <span class="k">SELECT</span>  
        <span class="n">block_date</span><span class="p">,</span> <span class="k">type</span><span class="p">,</span>  
        <span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="n">from_address</span><span class="p">)</span> <span class="k">AS</span> <span class="n">dau</span><span class="p">,</span>  
        <span class="p">(</span>  
            <span class="k">SELECT</span>
	            <span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="n">from_address</span><span class="p">)</span>  
            <span class="k">FROM</span>
	            <span class="n">CTE_raw</span> <span class="n">SUB</span>  
            <span class="k">WHERE</span>  
                <span class="n">DATE_ADD</span><span class="p">(</span><span class="s1">'DAY'</span><span class="p">,</span> <span class="o">-</span><span class="mi">29</span><span class="p">,</span> <span class="n">MAIN</span><span class="p">.</span><span class="n">block_date</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">SUB</span><span class="p">.</span><span class="n">block_date</span>  
                <span class="k">AND</span> <span class="n">SUB</span><span class="p">.</span><span class="n">block_date</span> <span class="o">&lt;=</span> <span class="n">DATE_TRUNC</span><span class="p">(</span><span class="s1">'DAY'</span><span class="p">,</span> <span class="n">MAIN</span><span class="p">.</span><span class="n">block_date</span><span class="p">)</span>  
        <span class="p">)</span> <span class="k">AS</span> <span class="n">mau</span>  
    <span class="k">FROM</span> 
	    <span class="n">CTE_raw</span> <span class="n">MAIN</span>  
    <span class="k">GROUP</span> <span class="k">BY</span> 
	    <span class="n">block_date</span><span class="p">,</span> <span class="k">type</span>  
    <span class="k">ORDER</span> <span class="k">BY</span> 
	    <span class="n">block_date</span> <span class="k">DESC</span><span class="p">,</span> <span class="k">type</span>   
<span class="p">)</span>  
<span class="k">SELECT</span> 
	<span class="o">*</span>  
<span class="k">FROM</span> 
	<span class="n">CTE_dau_mau</span>  
<span class="k">WHERE</span> 
	<span class="n">block_date</span> <span class="o">&gt;=</span> <span class="nb">TIMESTAMP</span> <span class="s1">'2023-01-01'</span>  
<span class="k">ORDER</span> <span class="k">BY</span> 
	<span class="n">block_date</span> <span class="k">DESC</span>  
<span class="p">;</span>
</code></pre></div></div>

<h2 id="24-ethereum-stickiness">2.4. Ethereum Stickiness</h2>

<blockquote>
  <p><strong>Stickiness</strong> is, by definition, the proportion of users who started their sessions on a particular day among all monthly users.</p>
</blockquote>

<p><img src="/assets/2023-05-29-ethereum-on-chain-data/stickiness-formula.webp" alt="" /></p>

<p>For instance, users on various social media platforms like Facebook typically exhibit a significantly high Stickiness Ratio.</p>

<p><img src="/assets/2023-05-29-ethereum-on-chain-data/dau-as-perc-of-mau.webp" alt="" /></p>

<p>When it comes to Ethereum Stickiness, I noticed a potential upward trend since May 2023 in the chart below.</p>

<p><img src="/assets/2023-05-29-ethereum-on-chain-data/ethereum-stickiness.webp" alt="" /></p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">WITH</span>  
<span class="n">CTE_raw</span> <span class="k">AS</span> <span class="p">(</span>
    <span class="k">SELECT</span>  
        <span class="n">DATE_TRUNC</span><span class="p">(</span><span class="s1">'DAY'</span><span class="p">,</span> <span class="n">block_time</span><span class="p">)</span> <span class="k">AS</span> <span class="n">block_date</span><span class="p">,</span>  
        <span class="n">block_number</span><span class="p">,</span>  
        <span class="nv">"from"</span> <span class="k">AS</span> <span class="n">from_address</span><span class="p">,</span> <span class="n">nonce</span><span class="p">,</span>  
        <span class="n">success</span><span class="p">,</span> <span class="k">type</span><span class="p">,</span>  
        <span class="n">value</span><span class="p">,</span> <span class="k">data</span>  
    <span class="k">FROM</span>
	    <span class="n">ethereum</span><span class="p">.</span><span class="n">transactions</span>  
    <span class="k">WHERE</span>  
        <span class="n">block_time</span> <span class="o">&gt;=</span> <span class="nb">TIMESTAMP</span> <span class="s1">'2022-12-01'</span>  
        <span class="k">AND</span> <span class="n">success</span> <span class="o">=</span> <span class="k">true</span>  
<span class="p">),</span>  
<span class="n">CTE_dau_mau</span> <span class="k">AS</span> <span class="p">(</span> 
    <span class="k">SELECT</span>  
        <span class="n">block_date</span><span class="p">,</span>  
        <span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="n">from_address</span><span class="p">)</span> <span class="k">AS</span> <span class="n">dau</span><span class="p">,</span>  
        <span class="p">(</span>  
            <span class="k">SELECT</span>
	            <span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="n">from_address</span><span class="p">)</span>  
            <span class="k">FROM</span>
	            <span class="n">CTE_raw</span> <span class="n">SUB</span>  
            <span class="k">WHERE</span>  
                <span class="n">DATE_ADD</span><span class="p">(</span><span class="s1">'DAY'</span><span class="p">,</span> <span class="o">-</span><span class="mi">29</span><span class="p">,</span> <span class="n">MAIN</span><span class="p">.</span><span class="n">block_date</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">SUB</span><span class="p">.</span><span class="n">block_date</span>  
                <span class="k">AND</span> <span class="n">SUB</span><span class="p">.</span><span class="n">block_date</span> <span class="o">&lt;=</span> <span class="n">DATE_TRUNC</span><span class="p">(</span><span class="s1">'DAY'</span><span class="p">,</span> <span class="n">MAIN</span><span class="p">.</span><span class="n">block_date</span><span class="p">)</span>  
        <span class="p">)</span> <span class="k">AS</span> <span class="n">mau</span>  
    <span class="k">FROM</span>
	    <span class="n">CTE_raw</span> <span class="n">MAIN</span>  
    <span class="k">GROUP</span> <span class="k">BY</span> 
	    <span class="n">block_date</span>  
    <span class="k">ORDER</span> <span class="k">BY</span> 
	    <span class="n">block_date</span> <span class="k">DESC</span>  
<span class="p">),</span>  
<span class="n">CTE_dau_mau_stickiness</span> <span class="k">AS</span> <span class="p">(</span> 
    <span class="k">SELECT</span>  
        <span class="n">block_date</span><span class="p">,</span> <span class="n">dau</span><span class="p">,</span> <span class="n">mau</span><span class="p">,</span>  
        <span class="k">CAST</span><span class="p">(</span><span class="n">dau</span> <span class="k">AS</span> <span class="nb">DOUBLE</span><span class="p">)</span> <span class="o">/</span> <span class="k">CAST</span><span class="p">(</span><span class="n">mau</span> <span class="k">AS</span> <span class="nb">DOUBLE</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">.</span><span class="mi">0</span> <span class="k">AS</span> <span class="n">stickiness</span>  
    <span class="k">FROM</span>
	    <span class="n">CTE_dau_mau</span>  
    <span class="k">WHERE</span>
	    <span class="n">block_date</span> <span class="o">&gt;=</span> <span class="nb">TIMESTAMP</span> <span class="s1">'2023-01-01'</span>  
    <span class="k">ORDER</span> <span class="k">BY</span>
	    <span class="n">block_date</span> <span class="k">DESC</span>  
<span class="p">)</span>  
<span class="k">SELECT</span> 
	<span class="o">*</span> 
<span class="k">FROM</span> 
	<span class="n">CTE_dau_mau_stickiness</span><span class="p">;</span>
</code></pre></div></div>

<h1 id="3--dau-mau-and-stickiness-contract-call-only">3.  DAU, MAU, and Stickiness (Contract Call Only)</h1>

<p>Wait, I overlooked one crucial aspect in all of the above.</p>
<ol>
  <li>The primary essence of the Ethereum Network lies in its functionality as an application platform.</li>
  <li>Consequently, it would be more accurate and insightful to extract transactions data that involves at least one contract call, rather than considering all transactions data.</li>
</ol>

<p>Letâ€™s redraw the same charts, but this time, focusing only on transactions that involve calling a contract.</p>

<h2 id="31-ethereum-dau-and-30-day-moving-mau">3.1. Ethereum DAU and 30-day Moving MAU</h2>

<p><img src="/assets/2023-05-29-ethereum-on-chain-data/ethereum-contract-call-dau-mau.webp" alt="" /></p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">WITH</span>  
<span class="n">CTE_raw</span> <span class="k">AS</span> <span class="p">(</span> 
    <span class="k">SELECT</span>  
        <span class="n">DATE_TRUNC</span><span class="p">(</span><span class="s1">'DAY'</span><span class="p">,</span> <span class="n">block_time</span><span class="p">)</span> <span class="k">AS</span> <span class="n">block_date</span><span class="p">,</span>  
        <span class="n">block_number</span><span class="p">,</span>  
        <span class="nv">"from"</span> <span class="k">AS</span> <span class="n">from_address</span><span class="p">,</span> <span class="n">nonce</span><span class="p">,</span>  
        <span class="n">success</span><span class="p">,</span> <span class="k">type</span><span class="p">,</span>  
        <span class="n">value</span><span class="p">,</span> <span class="k">data</span>  
    <span class="k">FROM</span> 
	    <span class="n">ethereum</span><span class="p">.</span><span class="n">transactions</span>  
    <span class="k">WHERE</span>  
        <span class="n">block_time</span> <span class="o">&gt;=</span> <span class="nb">TIMESTAMP</span> <span class="s1">'2022-12-01'</span>  
        <span class="k">AND</span> <span class="n">success</span> <span class="o">=</span> <span class="k">true</span>  
        <span class="k">AND</span> <span class="k">data</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span><span class="n">x</span>  
<span class="p">),</span>  
<span class="n">CTE_dau_mau</span> <span class="k">AS</span> <span class="p">(</span> 
    <span class="k">SELECT</span>  
        <span class="n">block_date</span><span class="p">,</span>  
        <span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="n">from_address</span><span class="p">)</span> <span class="k">AS</span> <span class="n">dau</span><span class="p">,</span>  
        <span class="p">(</span>  
            <span class="k">SELECT</span> 
	            <span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="n">from_address</span><span class="p">)</span>  
            <span class="k">FROM</span> 
	            <span class="n">CTE_raw</span> <span class="n">SUB</span>  
            <span class="k">WHERE</span>  
                <span class="n">DATE_ADD</span><span class="p">(</span><span class="s1">'DAY'</span><span class="p">,</span> <span class="o">-</span><span class="mi">29</span><span class="p">,</span> <span class="n">MAIN</span><span class="p">.</span><span class="n">block_date</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">SUB</span><span class="p">.</span><span class="n">block_date</span>  
                <span class="k">AND</span> <span class="n">SUB</span><span class="p">.</span><span class="n">block_date</span> <span class="o">&lt;=</span> <span class="n">DATE_TRUNC</span><span class="p">(</span><span class="s1">'DAY'</span><span class="p">,</span> <span class="n">MAIN</span><span class="p">.</span><span class="n">block_date</span><span class="p">)</span>  
        <span class="p">)</span> <span class="k">AS</span> <span class="n">mau</span>  
    <span class="k">FROM</span> 
	    <span class="n">CTE_raw</span> <span class="n">MAIN</span>  
    <span class="k">GROUP</span> <span class="k">BY</span> 
	    <span class="n">block_date</span>  
    <span class="k">ORDER</span> <span class="k">BY</span> 
	    <span class="n">block_date</span> <span class="k">DESC</span>  
<span class="p">)</span>  
<span class="k">SELECT</span> 
	<span class="o">*</span>  
<span class="k">FROM</span> 
	<span class="n">CTE_dau_mau</span>  
<span class="k">WHERE</span> 
	<span class="n">block_date</span> <span class="o">&gt;=</span> <span class="nb">TIMESTAMP</span> <span class="s1">'2023-01-01'</span>  
<span class="k">ORDER</span> <span class="k">BY</span> 
	<span class="n">block_date</span> <span class="k">DESC</span>  
<span class="p">;</span>
</code></pre></div></div>

<h2 id="32-ethereum-dau-new-and-existing-addresses">3.2. Ethereum DAU (new and existing addresses)</h2>

<p><img src="/assets/2023-05-29-ethereum-on-chain-data/ethereum-contract-call-dau-new-vs-old.webp" alt="" /></p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">WITH</span>  
<span class="n">CTE_raw</span> <span class="k">AS</span> <span class="p">(</span> 
    <span class="k">SELECT</span>  
        <span class="n">DATE_TRUNC</span><span class="p">(</span><span class="s1">'DAY'</span><span class="p">,</span> <span class="n">block_time</span><span class="p">)</span> <span class="k">AS</span> <span class="n">block_date</span><span class="p">,</span>  
        <span class="n">block_number</span><span class="p">,</span>  
        <span class="nv">"from"</span> <span class="k">AS</span> <span class="n">from_address</span><span class="p">,</span>   
        <span class="k">CASE</span>  
            <span class="k">WHEN</span> <span class="n">nonce</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">THEN</span> <span class="s1">'new_address'</span>  
            <span class="k">ELSE</span> <span class="s1">'existing_address'</span>  
        <span class="k">END</span> <span class="k">AS</span> <span class="n">new_existing</span><span class="p">,</span>  
        <span class="n">success</span><span class="p">,</span> <span class="k">type</span><span class="p">,</span>  
        <span class="n">value</span><span class="p">,</span> <span class="k">data</span>  
    <span class="k">FROM</span> 
	    <span class="n">ethereum</span><span class="p">.</span><span class="n">transactions</span>  
    <span class="k">WHERE</span>  
        <span class="n">block_time</span> <span class="o">&gt;=</span> <span class="nb">TIMESTAMP</span> <span class="s1">'2022-12-01'</span>  
        <span class="k">AND</span> <span class="n">success</span> <span class="o">=</span> <span class="k">true</span>  
        <span class="k">AND</span> <span class="k">data</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span><span class="n">x</span>  
<span class="p">),</span>  
<span class="n">CTE_dnu_mnu</span> <span class="k">AS</span> <span class="p">(</span>
    <span class="k">SELECT</span>  
        <span class="n">block_date</span><span class="p">,</span>  
        <span class="n">new_existing</span><span class="p">,</span>  
        <span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="n">from_address</span><span class="p">)</span> <span class="k">AS</span> <span class="n">dnu</span><span class="p">,</span>  
        <span class="p">(</span>  
            <span class="k">SELECT</span> 
	            <span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="n">from_address</span><span class="p">)</span>  
            <span class="k">FROM</span> 
	            <span class="n">CTE_raw</span> <span class="n">SUB</span>  
            <span class="k">WHERE</span>  
                <span class="n">DATE_ADD</span><span class="p">(</span><span class="s1">'DAY'</span><span class="p">,</span> <span class="o">-</span><span class="mi">29</span><span class="p">,</span> <span class="n">MAIN</span><span class="p">.</span><span class="n">block_date</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">SUB</span><span class="p">.</span><span class="n">block_date</span>  
                <span class="k">AND</span> <span class="n">SUB</span><span class="p">.</span><span class="n">block_date</span> <span class="o">&lt;=</span> <span class="n">DATE_TRUNC</span><span class="p">(</span><span class="s1">'DAY'</span><span class="p">,</span> <span class="n">MAIN</span><span class="p">.</span><span class="n">block_date</span><span class="p">)</span>  
        <span class="p">)</span> <span class="k">AS</span> <span class="n">mnu</span>  
    <span class="k">FROM</span> 
	    <span class="n">CTE_raw</span> <span class="n">MAIN</span>  
    <span class="k">GROUP</span> <span class="k">BY</span> 
	    <span class="n">block_date</span><span class="p">,</span> <span class="n">new_old</span>  
    <span class="k">ORDER</span> <span class="k">BY</span> 
	    <span class="n">block_date</span> <span class="k">DESC</span><span class="p">,</span> <span class="n">new_old</span>  
<span class="p">)</span>  
<span class="k">SELECT</span> 
	<span class="o">*</span>  
<span class="k">FROM</span> 
	<span class="n">CTE_dnu_mnu</span>  
<span class="k">WHERE</span> 
	<span class="n">block_date</span> <span class="o">&gt;=</span> <span class="nb">TIMESTAMP</span> <span class="s1">'2023-01-01'</span>  
<span class="k">ORDER</span> <span class="k">BY</span> 
	<span class="n">block_date</span> <span class="k">DESC</span>  
<span class="p">;</span>
</code></pre></div></div>

<h2 id="33-ethereum-dau-by-transaction-types">3.3. Ethereum DAU (by transaction types)</h2>

<p><img src="/assets/2023-05-29-ethereum-on-chain-data/ethereum-contract-call-dau-tx-type.webp" alt="" /></p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">WITH</span>  
<span class="n">CTE_raw</span> <span class="k">AS</span> <span class="p">(</span> 
    <span class="k">SELECT</span>  
        <span class="n">DATE_TRUNC</span><span class="p">(</span><span class="s1">'DAY'</span><span class="p">,</span> <span class="n">block_time</span><span class="p">)</span> <span class="k">AS</span> <span class="n">block_date</span><span class="p">,</span>  
        <span class="n">block_number</span><span class="p">,</span>  
        <span class="nv">"from"</span> <span class="k">AS</span> <span class="n">from_address</span><span class="p">,</span> <span class="n">nonce</span><span class="p">,</span>  
        <span class="n">success</span><span class="p">,</span> <span class="k">type</span><span class="p">,</span>  
        <span class="n">value</span><span class="p">,</span> <span class="k">data</span>  
    <span class="k">FROM</span> 
	    <span class="n">ethereum</span><span class="p">.</span><span class="n">transactions</span>  
    <span class="k">WHERE</span>  
        <span class="n">block_time</span> <span class="o">&gt;=</span> <span class="nb">TIMESTAMP</span> <span class="s1">'2022-12-01'</span>  
        <span class="k">AND</span> <span class="n">success</span> <span class="o">=</span> <span class="k">true</span>  
        <span class="k">AND</span> <span class="k">data</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span><span class="n">x</span>  
<span class="p">),</span>  
<span class="n">CTE_dau_mau</span> <span class="k">AS</span> <span class="p">(</span>
    <span class="k">SELECT</span>  
        <span class="n">block_date</span><span class="p">,</span> <span class="k">type</span><span class="p">,</span>  
        <span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="n">from_address</span><span class="p">)</span> <span class="k">AS</span> <span class="n">dau</span><span class="p">,</span>  
        <span class="p">(</span>  
            <span class="k">SELECT</span> 
	            <span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="n">from_address</span><span class="p">)</span>  
            <span class="k">FROM</span> 
	            <span class="n">CTE_raw</span> <span class="n">SUB</span>  
            <span class="k">WHERE</span>  
                <span class="n">DATE_ADD</span><span class="p">(</span><span class="s1">'DAY'</span><span class="p">,</span> <span class="o">-</span><span class="mi">29</span><span class="p">,</span> <span class="n">MAIN</span><span class="p">.</span><span class="n">block_date</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">SUB</span><span class="p">.</span><span class="n">block_date</span>  
                <span class="k">AND</span> <span class="n">SUB</span><span class="p">.</span><span class="n">block_date</span> <span class="o">&lt;=</span> <span class="n">DATE_TRUNC</span><span class="p">(</span><span class="s1">'DAY'</span><span class="p">,</span> <span class="n">MAIN</span><span class="p">.</span><span class="n">block_date</span><span class="p">)</span>  
        <span class="p">)</span> <span class="k">AS</span> <span class="n">mau</span>  
    <span class="k">FROM</span> 
	    <span class="n">CTE_raw</span> <span class="n">MAIN</span>  
    <span class="k">GROUP</span> <span class="k">BY</span> 
	    <span class="n">block_date</span><span class="p">,</span> <span class="k">type</span>  
    <span class="k">ORDER</span> <span class="k">BY</span> 
	    <span class="n">block_date</span> <span class="k">DESC</span><span class="p">,</span> <span class="k">type</span>   
<span class="p">)</span>  
<span class="k">SELECT</span> 
	<span class="o">*</span>  
<span class="k">FROM</span> 
	<span class="n">CTE_dau_mau</span>  
<span class="k">WHERE</span> 
	<span class="n">block_date</span> <span class="o">&gt;=</span> <span class="nb">TIMESTAMP</span> <span class="s1">'2023-01-01'</span>  
<span class="k">ORDER</span> <span class="k">BY</span> 
	<span class="n">block_date</span> <span class="k">DESC</span>  
<span class="p">;</span>
</code></pre></div></div>

<h2 id="34-ethereum-stickiness">3.4. Ethereum Stickiness</h2>

<p>I am even more convinced now that the upward trend I noticed earlier is indeed present here as well.</p>

<p><img src="/assets/2023-05-29-ethereum-on-chain-data/ethereum-contract-call-stickiness.webp" alt="" /></p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">WITH</span>  
<span class="n">CTE_raw</span> <span class="k">AS</span> <span class="p">(</span> 
    <span class="k">SELECT</span>  
        <span class="n">DATE_TRUNC</span><span class="p">(</span><span class="s1">'DAY'</span><span class="p">,</span> <span class="n">block_time</span><span class="p">)</span> <span class="k">AS</span> <span class="n">block_date</span><span class="p">,</span>  
        <span class="n">block_number</span><span class="p">,</span>  
        <span class="nv">"from"</span> <span class="k">AS</span> <span class="n">from_address</span><span class="p">,</span> <span class="n">nonce</span><span class="p">,</span>  
        <span class="n">success</span><span class="p">,</span> <span class="k">type</span><span class="p">,</span>  
        <span class="n">value</span><span class="p">,</span> <span class="k">data</span>  
    <span class="k">FROM</span> 
	    <span class="n">ethereum</span><span class="p">.</span><span class="n">transactions</span>  
    <span class="k">WHERE</span>  
        <span class="n">block_time</span> <span class="o">&gt;=</span> <span class="nb">TIMESTAMP</span> <span class="s1">'2022-12-01'</span>  
        <span class="k">AND</span> <span class="n">success</span> <span class="o">=</span> <span class="k">true</span>  
        <span class="k">AND</span> <span class="k">data</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span><span class="n">x</span>  
<span class="p">),</span>  
<span class="n">CTE_dau_mau</span> <span class="k">AS</span> <span class="p">(</span> 
    <span class="k">SELECT</span>  
        <span class="n">block_date</span><span class="p">,</span>  
        <span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="n">from_address</span><span class="p">)</span> <span class="k">AS</span> <span class="n">dau</span><span class="p">,</span>  
        <span class="p">(</span>  
            <span class="k">SELECT</span> 
	            <span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="n">from_address</span><span class="p">)</span>  
            <span class="k">FROM</span> 
	            <span class="n">CTE_raw</span> <span class="n">SUB</span>  
            <span class="k">WHERE</span>  
                <span class="n">DATE_ADD</span><span class="p">(</span><span class="s1">'DAY'</span><span class="p">,</span> <span class="o">-</span><span class="mi">29</span><span class="p">,</span> <span class="n">MAIN</span><span class="p">.</span><span class="n">block_date</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">SUB</span><span class="p">.</span><span class="n">block_date</span>  
                <span class="k">AND</span> <span class="n">SUB</span><span class="p">.</span><span class="n">block_date</span> <span class="o">&lt;=</span> <span class="n">DATE_TRUNC</span><span class="p">(</span><span class="s1">'DAY'</span><span class="p">,</span> <span class="n">MAIN</span><span class="p">.</span><span class="n">block_date</span><span class="p">)</span>  
        <span class="p">)</span> <span class="k">AS</span> <span class="n">mau</span>  
    <span class="k">FROM</span> 
	    <span class="n">CTE_raw</span> <span class="n">MAIN</span>  
    <span class="k">GROUP</span> <span class="k">BY</span> 
	    <span class="n">block_date</span>  
    <span class="k">ORDER</span> <span class="k">BY</span> 
	    <span class="n">block_date</span> <span class="k">DESC</span>  
<span class="p">),</span>  
<span class="n">CTE_dau_mau_stickiness</span> <span class="k">AS</span> <span class="p">(</span> 
    <span class="k">SELECT</span>  
        <span class="n">block_date</span><span class="p">,</span> <span class="n">dau</span><span class="p">,</span> <span class="n">mau</span><span class="p">,</span>  
        <span class="k">CAST</span><span class="p">(</span><span class="n">dau</span> <span class="k">AS</span> <span class="nb">DOUBLE</span><span class="p">)</span> <span class="o">/</span> <span class="k">CAST</span><span class="p">(</span><span class="n">mau</span> <span class="k">AS</span> <span class="nb">DOUBLE</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">.</span><span class="mi">0</span> <span class="k">AS</span> <span class="n">stickiness</span>  
    <span class="k">FROM</span> 
	    <span class="n">CTE_dau_mau</span>  
    <span class="k">WHERE</span> 
	    <span class="n">block_date</span> <span class="o">&gt;=</span> <span class="nb">TIMESTAMP</span> <span class="s1">'2023-01-01'</span>  
    <span class="k">ORDER</span> <span class="k">BY</span> 
	    <span class="n">block_date</span> <span class="k">DESC</span>  
<span class="p">)</span>  
<span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">CTE_dau_mau_stickiness</span><span class="p">;</span>
</code></pre></div></div>

<h1 id="4--cohord-retention-contract-call-only">4.  Cohord Retention (Contract Call Only)</h1>

<blockquote>
  <p><strong>Retention</strong> is basically an indicator of how many users come back to the platform over time.</p>
</blockquote>

<p><img src="/assets/2023-05-29-ethereum-on-chain-data/amplitude.webp" alt="" /></p>

<p>There are at least three methodologies to measure the Retention rate, but here Iâ€™ll use the Cohort Retention.</p>

<blockquote>
  <p><strong>Cohort Retention</strong> is one method of measuring the Retention trends by dividing it based on the first visit date of the new users.</p>
</blockquote>

<p><img src="/assets/2023-05-29-ethereum-on-chain-data/cohort-table.webp" alt="" /></p>

<h2 id="41-ethereum-cohort-retention-since-jan-2023">4.1. Ethereum Cohort Retention (Since Jan 2023)</h2>

<p>Newe addresses that have called contracts at least once demonstrate a notably high retention rate for at least a couple of weeks.</p>

<p><img src="/assets/2023-05-29-ethereum-on-chain-data/ethereum-cohort-retention-contract-call-only.webp" alt="" /></p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">WITH</span>  
<span class="n">CTE_raw</span> <span class="k">AS</span> <span class="p">(</span> 
    <span class="k">SELECT</span>  
        <span class="n">DATE_TRUNC</span><span class="p">(</span><span class="s1">'DAY'</span><span class="p">,</span> <span class="n">block_time</span><span class="p">)</span> <span class="k">AS</span> <span class="n">block_date</span><span class="p">,</span>  
        <span class="n">block_number</span><span class="p">,</span>  
        <span class="nv">"from"</span> <span class="k">AS</span> <span class="n">from_address</span><span class="p">,</span>   
        <span class="n">nonce</span><span class="p">,</span> <span class="n">success</span><span class="p">,</span> <span class="k">type</span><span class="p">,</span>  
        <span class="n">value</span><span class="p">,</span> <span class="k">data</span>  
    <span class="k">FROM</span> 
	    <span class="n">ethereum</span><span class="p">.</span><span class="n">transactions</span>  
    <span class="k">WHERE</span>  
        <span class="n">block_time</span> <span class="o">&gt;=</span> <span class="nb">TIMESTAMP</span> <span class="s1">'2023-01-01'</span>  
        <span class="k">AND</span> <span class="n">success</span> <span class="o">=</span> <span class="k">true</span>  
        <span class="k">AND</span> <span class="k">data</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span><span class="n">x</span>  
<span class="p">),</span>  
<span class="n">CTE_raw_new</span> <span class="k">AS</span> <span class="p">(</span> 
    <span class="k">SELECT</span> 
	    <span class="o">*</span>   
    <span class="k">FROM</span> 
	    <span class="n">CTE_raw</span>  
    <span class="k">WHERE</span> 
	    <span class="n">from_address</span> <span class="k">IN</span> <span class="p">(</span>  
	        <span class="k">SELECT</span> <span class="k">DISTINCT</span> <span class="n">from_address</span>  
	        <span class="k">FROM</span> <span class="n">CTE_raw</span>  
	        <span class="k">WHERE</span> <span class="n">nonce</span> <span class="o">=</span> <span class="mi">0</span>  
	    <span class="p">)</span>  
<span class="p">),</span>  
<span class="n">CTE_address_date_first</span> <span class="k">AS</span> <span class="p">(</span> 
    <span class="k">SELECT</span>  
        <span class="n">from_address</span><span class="p">,</span>  
        <span class="n">block_date</span> <span class="k">AS</span> <span class="n">active_date</span><span class="p">,</span>  
        <span class="k">MIN</span><span class="p">(</span><span class="n">block_date</span><span class="p">)</span> <span class="n">OVER</span> <span class="p">(</span>
	        <span class="k">PARTITION</span> <span class="k">BY</span> <span class="n">from_address</span>
	        <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">block_date</span>
	        <span class="k">ROWS</span> <span class="k">BETWEEN</span> <span class="n">UNBOUNDED</span> <span class="k">PRECEDING</span> <span class="k">AND</span> <span class="n">UNBOUNDED</span> <span class="k">FOLLOWING</span>
        <span class="p">)</span> <span class="k">AS</span> <span class="n">first_date</span>  
    <span class="k">FROM</span> 
	    <span class="n">CTE_raw_new</span>  
    <span class="k">GROUP</span> <span class="k">BY</span> 
	    <span class="n">from_address</span><span class="p">,</span> <span class="n">block_date</span>  
<span class="p">),</span>  
<span class="n">CTE_address_date_first_length</span> <span class="k">AS</span> <span class="p">(</span> 
    <span class="k">SELECT</span>  
        <span class="n">from_address</span><span class="p">,</span>  
        <span class="n">active_date</span><span class="p">,</span> <span class="n">first_date</span><span class="p">,</span>  
        <span class="n">DATE_DIFF</span><span class="p">(</span><span class="s1">'DAY'</span><span class="p">,</span> <span class="n">first_date</span><span class="p">,</span> <span class="n">active_date</span><span class="p">)</span> <span class="k">AS</span> <span class="k">length</span>  
    <span class="k">FROM</span> 
	    <span class="n">CTE_address_date_first</span>  
<span class="p">),</span>  
<span class="n">CTE_address_date_first_length7d</span> <span class="k">AS</span> <span class="p">(</span> 
    <span class="k">SELECT</span>  
        <span class="n">from_address</span><span class="p">,</span>  
        <span class="k">MAX</span><span class="p">(</span><span class="n">active_date</span><span class="p">)</span> <span class="k">AS</span> <span class="n">active_date</span><span class="p">,</span>  
        <span class="n">DATE_TRUNC</span><span class="p">(</span><span class="s1">'WEEK'</span><span class="p">,</span> <span class="k">MIN</span><span class="p">(</span><span class="n">first_date</span><span class="p">))</span> <span class="k">AS</span> <span class="n">first_week</span><span class="p">,</span>  
        <span class="n">CEIL</span><span class="p">(</span><span class="k">length</span> <span class="o">/</span> <span class="mi">7</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span> <span class="k">AS</span> <span class="k">length</span>  
    <span class="k">FROM</span> 
	    <span class="n">CTE_address_date_first_length</span>  
    <span class="k">GROUP</span> <span class="k">BY</span> 
	    <span class="n">from_address</span><span class="p">,</span> <span class="n">CEIL</span><span class="p">(</span><span class="k">length</span> <span class="o">/</span> <span class="mi">7</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span>  
<span class="p">),</span>  
<span class="n">CTE_final</span> <span class="k">AS</span> <span class="p">(</span>  
    <span class="k">SELECT</span>  
        <span class="n">first_week</span><span class="p">,</span>  
        <span class="k">SUM</span><span class="p">(</span><span class="k">CASE</span> <span class="k">WHEN</span> <span class="k">length</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">THEN</span> <span class="mi">1</span> <span class="k">ELSE</span> <span class="mi">0</span> <span class="k">END</span><span class="p">)</span> <span class="k">AS</span> <span class="n">new_address</span><span class="p">,</span>  
        <span class="k">CAST</span><span class="p">(</span><span class="k">SUM</span><span class="p">(</span><span class="k">CASE</span> <span class="k">WHEN</span> <span class="k">length</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">THEN</span> <span class="mi">1</span> <span class="k">ELSE</span> <span class="mi">0</span> <span class="k">END</span><span class="p">)</span> <span class="k">AS</span> <span class="nb">DOUBLE</span><span class="p">)</span>
        <span class="o">/</span> 
        <span class="k">CAST</span><span class="p">(</span><span class="k">SUM</span><span class="p">(</span><span class="k">CASE</span> <span class="k">WHEN</span> <span class="k">length</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">THEN</span> <span class="mi">1</span> <span class="k">ELSE</span> <span class="mi">0</span> <span class="k">END</span><span class="p">)</span> <span class="k">AS</span> <span class="nb">DOUBLE</span><span class="p">)</span> 
        <span class="o">*</span> <span class="mi">100</span><span class="p">.</span><span class="mi">0</span> <span class="k">AS</span> <span class="n">week_0</span><span class="p">,</span>  
        <span class="k">CAST</span><span class="p">(</span><span class="k">SUM</span><span class="p">(</span><span class="k">CASE</span> <span class="k">WHEN</span> <span class="k">length</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">THEN</span> <span class="mi">1</span> <span class="k">ELSE</span> <span class="mi">0</span> <span class="k">END</span><span class="p">)</span> <span class="k">AS</span> <span class="nb">DOUBLE</span><span class="p">)</span> 
        <span class="o">/</span> 
        <span class="k">CAST</span><span class="p">(</span><span class="k">SUM</span><span class="p">(</span><span class="k">CASE</span> <span class="k">WHEN</span> <span class="k">length</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">THEN</span> <span class="mi">1</span> <span class="k">ELSE</span> <span class="mi">0</span> <span class="k">END</span><span class="p">)</span> <span class="k">AS</span> <span class="nb">DOUBLE</span><span class="p">)</span> 
        <span class="o">*</span> <span class="mi">100</span><span class="p">.</span><span class="mi">0</span> <span class="k">AS</span> <span class="n">week_1</span><span class="p">,</span>  
        <span class="k">CAST</span><span class="p">(</span><span class="k">SUM</span><span class="p">(</span><span class="k">CASE</span> <span class="k">WHEN</span> <span class="k">length</span> <span class="o">=</span> <span class="mi">2</span> <span class="k">THEN</span> <span class="mi">1</span> <span class="k">ELSE</span> <span class="mi">0</span> <span class="k">END</span><span class="p">)</span> <span class="k">AS</span> <span class="nb">DOUBLE</span><span class="p">)</span> 
        <span class="o">/</span> 
        <span class="k">CAST</span><span class="p">(</span><span class="k">SUM</span><span class="p">(</span><span class="k">CASE</span> <span class="k">WHEN</span> <span class="k">length</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">THEN</span> <span class="mi">1</span> <span class="k">ELSE</span> <span class="mi">0</span> <span class="k">END</span><span class="p">)</span> <span class="k">AS</span> <span class="nb">DOUBLE</span><span class="p">)</span> 
        <span class="o">*</span> <span class="mi">100</span><span class="p">.</span><span class="mi">0</span> <span class="k">AS</span> <span class="n">week_2</span><span class="p">,</span>  
        <span class="k">CAST</span><span class="p">(</span><span class="k">SUM</span><span class="p">(</span><span class="k">CASE</span> <span class="k">WHEN</span> <span class="k">length</span> <span class="o">=</span> <span class="mi">3</span> <span class="k">THEN</span> <span class="mi">1</span> <span class="k">ELSE</span> <span class="mi">0</span> <span class="k">END</span><span class="p">)</span> <span class="k">AS</span> <span class="nb">DOUBLE</span><span class="p">)</span> 
        <span class="o">/</span> 
        <span class="k">CAST</span><span class="p">(</span><span class="k">SUM</span><span class="p">(</span><span class="k">CASE</span> <span class="k">WHEN</span> <span class="k">length</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">THEN</span> <span class="mi">1</span> <span class="k">ELSE</span> <span class="mi">0</span> <span class="k">END</span><span class="p">)</span> <span class="k">AS</span> <span class="nb">DOUBLE</span><span class="p">)</span> 
        <span class="o">*</span> <span class="mi">100</span><span class="p">.</span><span class="mi">0</span> <span class="k">AS</span> <span class="n">week_3</span><span class="p">,</span>  
        <span class="k">CAST</span><span class="p">(</span><span class="k">SUM</span><span class="p">(</span><span class="k">CASE</span> <span class="k">WHEN</span> <span class="k">length</span> <span class="o">=</span> <span class="mi">4</span> <span class="k">THEN</span> <span class="mi">1</span> <span class="k">ELSE</span> <span class="mi">0</span> <span class="k">END</span><span class="p">)</span> <span class="k">AS</span> <span class="nb">DOUBLE</span><span class="p">)</span> 
        <span class="o">/</span> <span class="k">CAST</span><span class="p">(</span><span class="k">SUM</span><span class="p">(</span><span class="k">CASE</span> <span class="k">WHEN</span> <span class="k">length</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">THEN</span> <span class="mi">1</span> <span class="k">ELSE</span> <span class="mi">0</span> <span class="k">END</span><span class="p">)</span> <span class="k">AS</span> <span class="nb">DOUBLE</span><span class="p">)</span> 
        <span class="o">*</span> <span class="mi">100</span><span class="p">.</span><span class="mi">0</span> <span class="k">AS</span> <span class="n">week_4</span>  
    <span class="k">FROM</span> 
	    <span class="n">CTE_address_date_first_length7d</span>  
    <span class="k">GROUP</span> <span class="k">BY</span> 
	    <span class="n">first_week</span>  
    <span class="k">ORDER</span> <span class="k">BY</span> 
	    <span class="n">first_week</span>  
<span class="p">)</span>  
<span class="k">SELECT</span> 
	<span class="o">*</span> 
<span class="k">FROM</span> 
	<span class="n">CTE_final</span><span class="p">;</span>
</code></pre></div></div>

<h2 id="42-ethereum-cohort-retention-since-jan-2022">4.2. Ethereum Cohort Retention (Since Jan 2022)</h2>

<p>Letâ€™s repeat the process from above, this time starting from January 2022 for a more convincing analysis.</p>

<p>The retention rate in May 2023 was the second-highest since last year, warranting further analysis.</p>

<p><img src="/assets/2023-05-29-ethereum-on-chain-data/ethereum-cohort-retention-contract-call-only-since-2022.webp" alt="" /></p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">WITH</span>  
<span class="n">CTE_raw</span> <span class="k">AS</span> <span class="p">(</span> 
    <span class="k">SELECT</span>  
        <span class="n">DATE_TRUNC</span><span class="p">(</span><span class="s1">'DAY'</span><span class="p">,</span> <span class="n">block_time</span><span class="p">)</span> <span class="k">AS</span> <span class="n">block_date</span><span class="p">,</span>  
        <span class="n">block_number</span><span class="p">,</span>  
        <span class="nv">"from"</span> <span class="k">AS</span> <span class="n">from_address</span><span class="p">,</span>   
        <span class="n">nonce</span><span class="p">,</span> <span class="n">success</span><span class="p">,</span> <span class="k">type</span><span class="p">,</span>  
        <span class="n">value</span><span class="p">,</span> <span class="k">data</span>  
    <span class="k">FROM</span> 
	    <span class="n">ethereum</span><span class="p">.</span><span class="n">transactions</span>  
    <span class="k">WHERE</span>  
        <span class="n">block_time</span> <span class="o">&gt;=</span> <span class="nb">TIMESTAMP</span> <span class="s1">'2022-01-01'</span>  
        <span class="k">AND</span> <span class="n">success</span> <span class="o">=</span> <span class="k">true</span>  
        <span class="k">AND</span> <span class="k">data</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span><span class="n">x</span>  
<span class="p">),</span>  
<span class="n">CTE_raw_new</span> <span class="k">AS</span> <span class="p">(</span> 
    <span class="k">SELECT</span> 
	    <span class="o">*</span>   
    <span class="k">FROM</span> 
	    <span class="n">CTE_raw</span>  
    <span class="k">WHERE</span> 
	    <span class="n">from_address</span> <span class="k">IN</span> <span class="p">(</span>  
	        <span class="k">SELECT</span> <span class="k">DISTINCT</span> <span class="n">from_address</span>  
	        <span class="k">FROM</span> <span class="n">CTE_raw</span>  
	        <span class="k">WHERE</span> <span class="n">nonce</span> <span class="o">=</span> <span class="mi">0</span>  
	    <span class="p">)</span>  
<span class="p">),</span>  
<span class="n">CTE_address_date_first</span> <span class="k">AS</span> <span class="p">(</span> 
    <span class="k">SELECT</span>  
        <span class="n">from_address</span><span class="p">,</span>  
        <span class="n">block_date</span> <span class="k">AS</span> <span class="n">active_date</span><span class="p">,</span>  
        <span class="k">MIN</span><span class="p">(</span><span class="n">block_date</span><span class="p">)</span> <span class="n">OVER</span> <span class="p">(</span>
	        <span class="k">PARTITION</span> <span class="k">BY</span> <span class="n">from_address</span>
	        <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">block_date</span>
	        <span class="k">ROWS</span> <span class="k">BETWEEN</span> <span class="n">UNBOUNDED</span> <span class="k">PRECEDING</span> <span class="k">AND</span> <span class="n">UNBOUNDED</span> <span class="k">FOLLOWING</span>
        <span class="p">)</span> <span class="k">AS</span> <span class="n">first_date</span>  
    <span class="k">FROM</span> 
	    <span class="n">CTE_raw_new</span>  
    <span class="k">GROUP</span> <span class="k">BY</span> 
	    <span class="n">from_address</span><span class="p">,</span> <span class="n">block_date</span>  
<span class="p">),</span>  
<span class="n">CTE_address_date_first_length</span> <span class="k">AS</span> <span class="p">(</span>   
    <span class="k">SELECT</span>  
        <span class="n">from_address</span><span class="p">,</span>  
        <span class="n">active_date</span><span class="p">,</span> <span class="n">first_date</span><span class="p">,</span>  
        <span class="n">DATE_DIFF</span><span class="p">(</span><span class="s1">'DAY'</span><span class="p">,</span> <span class="n">first_date</span><span class="p">,</span> <span class="n">active_date</span><span class="p">)</span> <span class="k">AS</span> <span class="k">length</span>  
    <span class="k">FROM</span> 
	    <span class="n">CTE_address_date_first</span>  
<span class="p">),</span>  
<span class="n">CTE_address_date_first_length7d</span> <span class="k">AS</span> <span class="p">(</span> 
    <span class="k">SELECT</span>  
        <span class="n">from_address</span><span class="p">,</span>  
        <span class="k">MAX</span><span class="p">(</span><span class="n">active_date</span><span class="p">)</span> <span class="k">AS</span> <span class="n">active_date</span><span class="p">,</span>  
        <span class="n">DATE_TRUNC</span><span class="p">(</span><span class="s1">'WEEK'</span><span class="p">,</span> <span class="k">MIN</span><span class="p">(</span><span class="n">first_date</span><span class="p">))</span> <span class="k">AS</span> <span class="n">first_week</span><span class="p">,</span>  
        <span class="n">CEIL</span><span class="p">(</span><span class="k">length</span> <span class="o">/</span> <span class="mi">7</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span> <span class="k">AS</span> <span class="k">length</span>  
    <span class="k">FROM</span> 
	    <span class="n">CTE_address_date_first_length</span>  
    <span class="k">GROUP</span> <span class="k">BY</span> 
	    <span class="n">from_address</span><span class="p">,</span> <span class="n">CEIL</span><span class="p">(</span><span class="k">length</span> <span class="o">/</span> <span class="mi">7</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span>  
<span class="p">),</span>  
<span class="n">CTE_final</span> <span class="k">AS</span> <span class="p">(</span>  
    <span class="k">SELECT</span>  
        <span class="n">first_week</span><span class="p">,</span>  
        <span class="k">SUM</span><span class="p">(</span><span class="k">CASE</span> <span class="k">WHEN</span> <span class="k">length</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">THEN</span> <span class="mi">1</span> <span class="k">ELSE</span> <span class="mi">0</span> <span class="k">END</span><span class="p">)</span> <span class="k">AS</span> <span class="n">new_address</span><span class="p">,</span>  
        <span class="k">CAST</span><span class="p">(</span><span class="k">SUM</span><span class="p">(</span><span class="k">CASE</span> <span class="k">WHEN</span> <span class="k">length</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">THEN</span> <span class="mi">1</span> <span class="k">ELSE</span> <span class="mi">0</span> <span class="k">END</span><span class="p">)</span> <span class="k">AS</span> <span class="nb">DOUBLE</span><span class="p">)</span> 
        <span class="o">/</span> 
        <span class="k">CAST</span><span class="p">(</span><span class="k">SUM</span><span class="p">(</span><span class="k">CASE</span> <span class="k">WHEN</span> <span class="k">length</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">THEN</span> <span class="mi">1</span> <span class="k">ELSE</span> <span class="mi">0</span> <span class="k">END</span><span class="p">)</span> <span class="k">AS</span> <span class="nb">DOUBLE</span><span class="p">)</span> 
        <span class="o">*</span> <span class="mi">100</span><span class="p">.</span><span class="mi">0</span> <span class="k">AS</span> <span class="n">week_0</span><span class="p">,</span>  
        <span class="k">CAST</span><span class="p">(</span><span class="k">SUM</span><span class="p">(</span><span class="k">CASE</span> <span class="k">WHEN</span> <span class="k">length</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">THEN</span> <span class="mi">1</span> <span class="k">ELSE</span> <span class="mi">0</span> <span class="k">END</span><span class="p">)</span> <span class="k">AS</span> <span class="nb">DOUBLE</span><span class="p">)</span> 
        <span class="o">/</span> 
        <span class="k">CAST</span><span class="p">(</span><span class="k">SUM</span><span class="p">(</span><span class="k">CASE</span> <span class="k">WHEN</span> <span class="k">length</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">THEN</span> <span class="mi">1</span> <span class="k">ELSE</span> <span class="mi">0</span> <span class="k">END</span><span class="p">)</span> <span class="k">AS</span> <span class="nb">DOUBLE</span><span class="p">)</span> 
        <span class="o">*</span> <span class="mi">100</span><span class="p">.</span><span class="mi">0</span> <span class="k">AS</span> <span class="n">week_1</span><span class="p">,</span>  
        <span class="k">CAST</span><span class="p">(</span><span class="k">SUM</span><span class="p">(</span><span class="k">CASE</span> <span class="k">WHEN</span> <span class="k">length</span> <span class="o">=</span> <span class="mi">2</span> <span class="k">THEN</span> <span class="mi">1</span> <span class="k">ELSE</span> <span class="mi">0</span> <span class="k">END</span><span class="p">)</span> <span class="k">AS</span> <span class="nb">DOUBLE</span><span class="p">)</span> 
        <span class="o">/</span> 
        <span class="k">CAST</span><span class="p">(</span><span class="k">SUM</span><span class="p">(</span><span class="k">CASE</span> <span class="k">WHEN</span> <span class="k">length</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">THEN</span> <span class="mi">1</span> <span class="k">ELSE</span> <span class="mi">0</span> <span class="k">END</span><span class="p">)</span> <span class="k">AS</span> <span class="nb">DOUBLE</span><span class="p">)</span> 
        <span class="o">*</span> <span class="mi">100</span><span class="p">.</span><span class="mi">0</span> <span class="k">AS</span> <span class="n">week_2</span><span class="p">,</span>  
        <span class="k">CAST</span><span class="p">(</span><span class="k">SUM</span><span class="p">(</span><span class="k">CASE</span> <span class="k">WHEN</span> <span class="k">length</span> <span class="o">=</span> <span class="mi">3</span> <span class="k">THEN</span> <span class="mi">1</span> <span class="k">ELSE</span> <span class="mi">0</span> <span class="k">END</span><span class="p">)</span> <span class="k">AS</span> <span class="nb">DOUBLE</span><span class="p">)</span> 
        <span class="o">/</span> 
        <span class="k">CAST</span><span class="p">(</span><span class="k">SUM</span><span class="p">(</span><span class="k">CASE</span> <span class="k">WHEN</span> <span class="k">length</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">THEN</span> <span class="mi">1</span> <span class="k">ELSE</span> <span class="mi">0</span> <span class="k">END</span><span class="p">)</span> <span class="k">AS</span> <span class="nb">DOUBLE</span><span class="p">)</span> 
        <span class="o">*</span> <span class="mi">100</span><span class="p">.</span><span class="mi">0</span> <span class="k">AS</span> <span class="n">week_3</span><span class="p">,</span>  
        <span class="k">CAST</span><span class="p">(</span><span class="k">SUM</span><span class="p">(</span><span class="k">CASE</span> <span class="k">WHEN</span> <span class="k">length</span> <span class="o">=</span> <span class="mi">4</span> <span class="k">THEN</span> <span class="mi">1</span> <span class="k">ELSE</span> <span class="mi">0</span> <span class="k">END</span><span class="p">)</span> <span class="k">AS</span> <span class="nb">DOUBLE</span><span class="p">)</span> 
        <span class="o">/</span> 
        <span class="k">CAST</span><span class="p">(</span><span class="k">SUM</span><span class="p">(</span><span class="k">CASE</span> <span class="k">WHEN</span> <span class="k">length</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">THEN</span> <span class="mi">1</span> <span class="k">ELSE</span> <span class="mi">0</span> <span class="k">END</span><span class="p">)</span> <span class="k">AS</span> <span class="nb">DOUBLE</span><span class="p">)</span> 
        <span class="o">*</span> <span class="mi">100</span><span class="p">.</span><span class="mi">0</span> <span class="k">AS</span> <span class="n">week_4</span>  
    <span class="k">FROM</span> 
	    <span class="n">CTE_address_date_first_length7d</span>  
    <span class="k">GROUP</span> <span class="k">BY</span> 
	    <span class="n">first_week</span>  
    <span class="k">ORDER</span> <span class="k">BY</span> 
	    <span class="n">first_week</span>  
<span class="p">)</span>  
<span class="k">SELECT</span> 
	<span class="o">*</span> 
<span class="k">FROM</span> <span class="n">CTE_final</span><span class="p">;</span>
</code></pre></div></div>

<h1 id="5--why-the-retention-rate-was-high-in-may-2023">5.  Why the Retention rate was high in May 2023?</h1>

<p>The significant increase in the retention rate suggests a positive shift in user experience, indicating that users are now having a more positive experience than ever before.</p>

<p><img src="/assets/2023-05-29-ethereum-on-chain-data/ethereum-cohort-retention-contract-call-only-since-2022-2.webp" alt="" /></p>

<p>Now, letâ€™s extract the list of contract addresses that have been called the most by the new addresses from May 1 to May 8, 2023.</p>

<p><img src="/assets/2023-05-29-ethereum-on-chain-data/to-address-rank-2023-05-01-2023-05-08.webp" alt="" /></p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">WITH</span>  
<span class="n">CTE_raw</span> <span class="k">AS</span> <span class="p">(</span> 
    <span class="k">SELECT</span>  
        <span class="n">DATE_TRUNC</span><span class="p">(</span><span class="s1">'DAY'</span><span class="p">,</span> <span class="n">block_time</span><span class="p">)</span> <span class="k">AS</span> <span class="n">block_date</span><span class="p">,</span>  
        <span class="n">block_number</span><span class="p">,</span>  
        <span class="nv">"from"</span> <span class="k">AS</span> <span class="n">from_address</span><span class="p">,</span>   
        <span class="nv">"to"</span> <span class="k">AS</span> <span class="n">to_address</span><span class="p">,</span>  
        <span class="n">nonce</span><span class="p">,</span> <span class="n">success</span><span class="p">,</span> <span class="k">type</span><span class="p">,</span>  
        <span class="n">value</span><span class="p">,</span> <span class="k">data</span>  
    <span class="k">FROM</span> 
	    <span class="n">ethereum</span><span class="p">.</span><span class="n">transactions</span>  
    <span class="k">WHERE</span>  
        <span class="nb">TIMESTAMP</span> <span class="s1">'2023-05-01'</span> <span class="o">&lt;=</span> <span class="n">block_time</span>
        <span class="k">AND</span> <span class="n">block_time</span> <span class="o">&lt;</span> <span class="nb">TIMESTAMP</span> <span class="s1">'2023-05-08'</span>  
        <span class="k">AND</span> <span class="n">success</span> <span class="o">=</span> <span class="k">true</span>  
        <span class="k">AND</span> <span class="k">data</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span><span class="n">x</span>  
<span class="p">),</span>  
<span class="n">CTE_raw_new</span> <span class="k">AS</span> <span class="p">(</span> 
    <span class="k">SELECT</span> 
	    <span class="o">*</span>   
    <span class="k">FROM</span> 
	    <span class="n">CTE_raw</span>  
    <span class="k">WHERE</span> 
	    <span class="n">from_address</span> <span class="k">IN</span> <span class="p">(</span>  
	        <span class="k">SELECT</span> <span class="k">DISTINCT</span> <span class="n">from_address</span>  
	        <span class="k">FROM</span> <span class="n">CTE_raw</span>  
	        <span class="k">WHERE</span> <span class="n">nonce</span> <span class="o">=</span> <span class="mi">0</span>  
	    <span class="p">)</span>  
<span class="p">),</span>  
<span class="n">CTE_ca_new_list</span> <span class="k">AS</span> <span class="p">(</span>  
    <span class="k">SELECT</span>  
        <span class="n">to_address</span><span class="p">,</span>  
        <span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="n">from_address</span><span class="p">)</span> <span class="k">AS</span> <span class="n">address_cnt</span>  
    <span class="k">FROM</span> 
	    <span class="n">CTE_raw_new</span>  
    <span class="k">GROUP</span> <span class="k">BY</span> 
	    <span class="n">to_address</span>  
    <span class="k">ORDER</span> <span class="k">BY</span> 
	    <span class="n">address_cnt</span> <span class="k">DESC</span>  
    <span class="k">LIMIT</span> 
	    <span class="mi">100</span>  
<span class="p">)</span>  
<span class="k">SELECT</span> 
	<span class="o">*</span> 
<span class="k">FROM</span> 
	<span class="n">CTE_ca_new_list</span><span class="p">;</span>
</code></pre></div></div>

<p>Now, letâ€™s identify the top 2 contracts from the table shown below.</p>

<p><strong>Rank 1. Tether USD (USDT) Contract</strong></p>

<p><img src="/assets/2023-05-29-ethereum-on-chain-data/etherscan-usdt.webp" alt="" /></p>

<p>Tether USD (USDT), being a widely traded stablecoin on the Ethereum Network, does not reveal any significant changes in the new user experience.</p>

<p><strong>Rank 2. Uniswap Universal Router Contract</strong></p>

<p><img src="/assets/2023-05-29-ethereum-on-chain-data/etherscan-uniswap.webp" alt="" /></p>

<p><img src="/assets/2023-05-29-ethereum-on-chain-data/universal-router.webp" alt="" /></p>
<blockquote>
  <p><a href="https://blog.uniswap.org/permit2-and-universal-router">Permit2 and Universal Router</a></p>
</blockquote>

<p>Now weâ€™ve idenfified it. The Uniswap Universal Router, introduced in November 2022, has been instrumental in enhancing the positive user experience on the Ethereum Network.</p>

<p><img src="/assets/2023-05-29-ethereum-on-chain-data/universal-router-flowchart.webp" alt="" /></p>
<blockquote>
  <p><a href="https://blog.uniswap.org/permit2-and-universal-router">Permit2 and Universal Router</a></p>
</blockquote>

<p>As demonstrated above, we can execute multiple separate swaps in a single transaction, resulting in lowe gas fees.</p>

<h1 id="6--conclusion">6.  Conclusion</h1>

<ol>
  <li>In May 2023, new addresses exhibit the second-highest retention rate since January 2022.</li>
  <li>This abrupt increase in the retention rate appears to be significantly influenced by the swift and widespread adoption of the Uniswap Universal Router.</li>
</ol>

<hr />

<h2 id="published-by-joshua-kim"><em>Published by</em> Joshua Kim</h2>
<p><img src="/assets/profile/joshua-profile.png" alt="Joshua Kim" /></p>]]></content><author><name></name></author><category term="english" /><category term="sql" /><category term="blockchain" /><category term="on_chain_data" /><category term="data_analytics" /><summary type="html"><![CDATA[In this article, Iâ€™m going to deep dive into Ethereum On-chain Data Analysis not just with the DAU and MAU, but also with Stickiness, and Retention Rate, which are the basic metrics when it comes to data analysis. Letâ€™s directly dive into it!]]></summary></entry><entry><title type="html">Letâ€™s Create the Sankey Chart</title><link href="http://localhost:4000/sankey-chart/" rel="alternate" type="text/html" title="Letâ€™s Create the Sankey Chart" /><published>2023-05-21T00:00:00+09:00</published><updated>2023-05-21T00:00:00+09:00</updated><id>http://localhost:4000/sankey-chart</id><content type="html" xml:base="http://localhost:4000/sankey-chart/"><![CDATA[<blockquote>
  <p>In this article, Iâ€™m going to tell you how you can create the Sankey Chart starting from GA4, BigQuery, and up to Redash.</p>
</blockquote>

<h3 id="contents">CONTENTS</h3>
<ol>
  <li>Introduction</li>
  <li><strong>Flatten</strong> the source table.</li>
  <li>Make sure each <strong>user</strong> and <strong>session</strong> has the same properties(or parameters).</li>
  <li>Delete the consecutive same <strong>page URL duplicates</strong> in the same <code class="language-plaintext highlighter-rouge">session_id</code>.</li>
  <li>Label each pageâ€™s <strong>visiting order number</strong> for each session.</li>
  <li><strong>Categorize</strong> all the pages.</li>
  <li>Pivot each sessionâ€™s journey up to <strong>10 steps</strong>.</li>
  <li>Make the query result compatible with <strong>Redash</strong>.</li>
  <li>Final Result</li>
  <li>Conclusion</li>
</ol>

<hr />

<p><img src="/assets/2023-05-21-sankey-chart/Data Pipeline from the website all the way up to Redash.webp" alt="" /></p>
<blockquote>
  <p>Data Pipeline from the website all the way up to Redash</p>
</blockquote>

<h1 id="1-introduction">1. Introduction</h1>

<h2 id="11-what-is-sankey-chart">1.1. What is Sankey Chart?</h2>

<p><img src="/assets/2023-05-21-sankey-chart/Sankey-Diagram.webp" alt="" /></p>
<blockquote>
  <p><a href="https://www.originlab.com/doc/Origin-Help/Sankey-Diagram">Source</a></p>
</blockquote>

<p><strong>Sankey Chart</strong>, oftentimes also called Sankey Diagram, is a type of flow visualization in which the width of the arrows is proportional to the flow rate of the depicted extensive property. [<a href="https://en.wikipedia.org/wiki/Sankey_diagram">Wikipedia</a>]</p>

<h2 id="12-why-is-sankey-chart-important-in-data-analytics">1.2. Why is Sankey Chart Important in Data Analytics?</h2>

<p>In the Data Analytics world, though, we can figure out how our visitors make their journey throughout our website pages or app screens. With the Sankey Chart, we can apply <strong>our strategies</strong> as shown below.</p>
<ul>
  <li>â€œMany purchasing visitors mainly make a journey starting from <code class="language-plaintext highlighter-rouge">page A</code>, <code class="language-plaintext highlighter-rouge">page B</code>, <code class="language-plaintext highlighter-rouge">page C</code>, and finally make their purchase. Therefore, we might be able to create a CTA button in order to drive the other visitors to this journey, so that we could make our revenue much higher.â€</li>
  <li>â€œ<code class="language-plaintext highlighter-rouge">Page A</code> and <code class="language-plaintext highlighter-rouge">Page B</code> are the points where our visitors bounce off the most. Bet those two pages have some problems in terms of psychology or technology. Letâ€™s now dive into specific user interviews or research to deal with this bounce-off rate.â€</li>
</ul>

<h2 id="13-limitations-of-google-analytics-4">1.3. Limitations of Google Analytics 4</h2>

<p>Although GA4 supports some custom visualizations and you can explore the path analysis to figure out how your visitors take their journey throughout the websites, itâ€™s literally awful and much of a hassle if youâ€™re eager to get some insights regarding that. (See below how awful it is.)</p>

<p><img src="/assets/2023-05-21-sankey-chart/GA4â€™s Path Analysis.webp" alt="" /></p>

<p>Now that hopefully you got deeply understood what is the Sankey Chart and why itâ€™s important in product analytics, itâ€™s time to show you <strong>how to create the Sankey Chart from A to Z</strong>. Letâ€™s directly dive into it!</p>

<h1 id="2-flatten-the-source-table">2. Flatten the source table.</h1>

<p>Although itâ€™s really handy to connect the GA4 events to BigQuery, thereâ€™s a complicated issue hard to handle; Some of the datatypes imported to BigQuery are <code class="language-plaintext highlighter-rouge">STRUCT</code> type. Itâ€™s regarded as an array type, or you can imagine this as a <code class="language-plaintext highlighter-rouge">STRUCT</code> type column that allows each row to have a multiple-dimensional value in it.</p>

<p><img src="/assets/2023-05-21-sankey-chart/address_history.webp" alt="" />
<img src="/assets/2023-05-21-sankey-chart/1. Flatten the Table.webp" alt="" /></p>
<blockquote>
  <p><a href="https://medium.com/google-cloud/how-to-work-with-array-and-structs-in-bigquery-9c0a2ea584a6">Source</a></p>
</blockquote>

<p>You can simply use <code class="language-plaintext highlighter-rouge">UNNEST</code> to flatten each <code class="language-plaintext highlighter-rouge">STRUCT</code> type column in advance of your main query.</p>

<h2 id="21-the-entire-codes">2.1. The Entire Codes</h2>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">WITH</span>
<span class="n">CTE_flattened</span> <span class="k">AS</span> <span class="p">(</span>
	<span class="k">SELECT</span>
		<span class="n">event_date</span><span class="p">,</span>
		<span class="n">event_timestamp</span><span class="p">,</span>
		<span class="n">user_pseudo_id</span><span class="p">,</span>
		<span class="n">ga_session_id</span><span class="p">.</span><span class="n">value</span><span class="p">.</span><span class="n">int_value</span> <span class="k">AS</span> <span class="n">session_id</span><span class="p">,</span>
		<span class="n">ga_session_number</span><span class="p">.</span><span class="n">value</span><span class="p">.</span><span class="n">int_value</span> <span class="k">AS</span> <span class="n">session_number</span><span class="p">,</span>
		<span class="n">event_name</span><span class="p">,</span>
		<span class="n">page_location</span><span class="p">.</span><span class="n">value</span><span class="p">.</span><span class="n">string_value</span> <span class="k">AS</span> <span class="n">page_location</span><span class="p">,</span>
		<span class="n">ecommerce</span><span class="p">.</span><span class="n">purchase_revenue_in_usd</span> <span class="k">AS</span> <span class="n">revenue_usd</span><span class="p">,</span>
		<span class="n">geo</span><span class="p">.</span><span class="n">country</span><span class="p">,</span>
		<span class="n">device</span><span class="p">.</span><span class="n">category</span> <span class="k">AS</span> <span class="n">device</span><span class="p">,</span>
		<span class="n">utm_campaign</span><span class="p">.</span><span class="n">value</span><span class="p">.</span><span class="n">string_value</span> <span class="k">AS</span> <span class="n">utm_campaign</span><span class="p">,</span>  
		<span class="n">utm_medium</span><span class="p">.</span><span class="n">value</span><span class="p">.</span><span class="n">string_value</span> <span class="k">AS</span> <span class="n">utm_medium</span><span class="p">,</span>  
		<span class="n">utm_source</span><span class="p">.</span><span class="n">value</span><span class="p">.</span><span class="n">string_value</span> <span class="k">AS</span> <span class="n">utm_source</span><span class="p">,</span>  
		<span class="n">page_referrer</span><span class="p">.</span><span class="n">value</span><span class="p">.</span><span class="n">string_value</span> <span class="k">AS</span> <span class="n">page_referrer</span>  
	<span class="k">FROM</span>
		<span class="nv">`your_table.events_*`</span>  
	<span class="k">LEFT</span> <span class="k">JOIN</span>
		<span class="k">UNNEST</span> <span class="p">(</span><span class="n">event_params</span><span class="p">)</span> <span class="k">AS</span> <span class="n">ga_session_id</span>
		<span class="k">ON</span> <span class="n">ga_session_id</span><span class="p">.</span><span class="k">key</span> <span class="o">=</span> <span class="s1">'ga_session_id'</span>  
	<span class="k">LEFT</span> <span class="k">JOIN</span>
		<span class="k">UNNEST</span> <span class="p">(</span><span class="n">event_params</span><span class="p">)</span> <span class="k">AS</span> <span class="n">ga_session_number</span>
		<span class="k">ON</span> <span class="n">ga_session_number</span><span class="p">.</span><span class="k">key</span> <span class="o">=</span> <span class="s1">'ga_session_number'</span>  
	<span class="k">LEFT</span> <span class="k">JOIN</span>
		<span class="k">UNNEST</span> <span class="p">(</span><span class="n">event_params</span><span class="p">)</span> <span class="k">AS</span> <span class="n">page_location</span>
		<span class="k">ON</span> <span class="n">page_location</span><span class="p">.</span><span class="k">key</span> <span class="o">=</span> <span class="s1">'page_location'</span>  
	<span class="k">LEFT</span> <span class="k">JOIN</span>
		<span class="k">UNNEST</span> <span class="p">(</span><span class="n">event_params</span><span class="p">)</span> <span class="k">AS</span> <span class="n">utm_campaign</span>
		<span class="k">ON</span> <span class="n">utm_campaign</span><span class="p">.</span><span class="k">key</span> <span class="o">=</span> <span class="s1">'campaign'</span>  
	<span class="k">LEFT</span> <span class="k">JOIN</span>
		<span class="k">UNNEST</span> <span class="p">(</span><span class="n">event_params</span><span class="p">)</span> <span class="k">AS</span> <span class="n">utm_medium</span>
		<span class="k">ON</span> <span class="n">utm_medium</span><span class="p">.</span><span class="k">key</span> <span class="o">=</span> <span class="s1">'medium'</span>  
	<span class="k">LEFT</span> <span class="k">JOIN</span>
		<span class="k">UNNEST</span> <span class="p">(</span><span class="n">event_params</span><span class="p">)</span> <span class="k">AS</span> <span class="n">utm_source</span>
		<span class="k">ON</span> <span class="n">utm_source</span><span class="p">.</span><span class="k">key</span> <span class="o">=</span> <span class="s1">'source'</span>  
	<span class="k">LEFT</span> <span class="k">JOIN</span>
		<span class="k">UNNEST</span> <span class="p">(</span><span class="n">event_params</span><span class="p">)</span> <span class="k">AS</span> <span class="n">page_referrer</span>
		<span class="k">ON</span> <span class="n">page_referrer</span><span class="p">.</span><span class="k">key</span> <span class="o">=</span> <span class="s1">'page_referrer'</span>  
	<span class="k">WHERE</span>  
		<span class="n">_table_suffix</span> <span class="k">BETWEEN</span>
		<span class="n">FORMAT_DATE</span><span class="p">(</span>
			<span class="s1">'%Y%m%d'</span><span class="p">,</span>
			<span class="n">DATE_SUB</span><span class="p">(</span><span class="k">CURRENT_DATE</span><span class="p">(),</span> <span class="n">INTERVAL</span> <span class="mi">90</span> <span class="k">DAY</span><span class="p">)</span>
		<span class="p">)</span>
		<span class="k">AND</span>
		<span class="n">FORMAT_DATE</span><span class="p">(</span>
			<span class="s1">'%Y%m%d'</span><span class="p">,</span>
			<span class="k">CURRENT_DATE</span><span class="p">()</span>
		<span class="p">)</span>
		<span class="k">AND</span> <span class="n">ga_session_number</span><span class="p">.</span><span class="n">value</span><span class="p">.</span><span class="n">int_value</span> <span class="o">=</span> <span class="mi">1</span>  
		<span class="k">AND</span> <span class="n">user_pseudo_id</span> <span class="k">IS</span> <span class="k">NOT</span> <span class="k">NULL</span>  
		<span class="k">AND</span> <span class="n">ga_session_id</span> <span class="k">IS</span> <span class="k">NOT</span> <span class="k">NULL</span>  
<span class="p">),</span>
</code></pre></div></div>

<h2 id="22-detailed-explanation-of-key-codes">2.2. Detailed Explanation of Key Codes</h2>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">LEFT</span> <span class="k">JOIN</span>
	<span class="k">UNNEST</span> <span class="p">(</span><span class="n">event_params</span><span class="p">)</span> <span class="k">AS</span> <span class="n">ga_session_id</span>
	<span class="k">ON</span> <span class="n">ga_session_id</span><span class="p">.</span><span class="k">key</span> <span class="o">=</span> <span class="err">â€˜</span><span class="n">ga_session_id</span><span class="err">â€™</span>
</code></pre></div></div>
<ul>
  <li>Each <code class="language-plaintext highlighter-rouge">event</code> may have <code class="language-plaintext highlighter-rouge">ga_session_id</code> in its parameters, and we have to grab it in order to follow through each user sessionâ€™s journey based on the <code class="language-plaintext highlighter-rouge">ga_session_id</code>.</li>
</ul>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">LEFT</span> <span class="k">JOIN</span>
	<span class="k">UNNEST</span> <span class="p">(</span><span class="n">event_params</span><span class="p">)</span> <span class="k">AS</span> <span class="n">ga_session_number</span>
	<span class="k">ON</span> <span class="n">ga_session_number</span><span class="p">.</span><span class="k">key</span> <span class="o">=</span> <span class="err">â€˜</span><span class="n">ga_session_number</span><span class="err">â€™</span>
</code></pre></div></div>
<ul>
  <li>Each <code class="language-plaintext highlighter-rouge">event</code> may have <code class="language-plaintext highlighter-rouge">ga_session_number</code> in its parameters, and we have to look through it in order to know if each <code class="language-plaintext highlighter-rouge">session</code> is the <strong>first visiting userâ€™s</strong> or <strong>returning userâ€™s</strong> session.</li>
</ul>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">LEFT</span> <span class="k">JOIN</span>
	<span class="k">UNNEST</span> <span class="p">(</span><span class="n">event_params</span><span class="p">)</span> <span class="k">AS</span> <span class="n">page_location</span>
	<span class="k">ON</span> <span class="n">page_location</span><span class="p">.</span><span class="k">key</span> <span class="o">=</span> <span class="err">â€˜</span><span class="n">page_location</span><span class="err">â€™</span>
</code></pre></div></div>
<ul>
  <li>Most of each <code class="language-plaintext highlighter-rouge">event</code> has <code class="language-plaintext highlighter-rouge">page_location</code> in its parameters, and of course, we have to know <code class="language-plaintext highlighter-rouge">page_location</code> in order to follow through with their journey based on the <strong>page URL</strong>.</li>
</ul>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">LEFT</span> <span class="k">JOIN</span>
	<span class="k">UNNEST</span> <span class="p">(</span><span class="n">event_params</span><span class="p">)</span> <span class="k">AS</span> <span class="n">utm_campaign</span>
	<span class="k">ON</span> <span class="n">utm_campaign</span><span class="p">.</span><span class="k">key</span> <span class="o">=</span> <span class="err">â€˜</span><span class="n">campaign</span><span class="err">â€™</span>
</code></pre></div></div>
<ul>
  <li>Many times, each <code class="language-plaintext highlighter-rouge">session</code> has a totally different shape of the journey depending on what kind of <strong>campaign channel</strong> the session has started from. Therefore, letâ€™s also query <code class="language-plaintext highlighter-rouge">utm_campaign</code> just in case.</li>
</ul>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">LEFT</span> <span class="k">JOIN</span>
	<span class="k">UNNEST</span> <span class="p">(</span><span class="n">event_params</span><span class="p">)</span> <span class="k">AS</span> <span class="n">utm_medium</span>
	<span class="k">ON</span> <span class="n">utm_medium</span><span class="p">.</span><span class="k">key</span> <span class="o">=</span> <span class="err">â€˜</span><span class="n">medium</span><span class="err">â€™</span>
</code></pre></div></div>
<ul>
  <li>Many times, each <code class="language-plaintext highlighter-rouge">session</code> has a totally different shape of the journey depending on what kind of <strong>medium channel</strong> the session has started from. Therefore, letâ€™s also query <code class="language-plaintext highlighter-rouge">utm_medium</code> just in case.</li>
</ul>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">LEFT</span> <span class="k">JOIN</span>
	<span class="k">UNNEST</span> <span class="p">(</span><span class="n">event_params</span><span class="p">)</span> <span class="k">AS</span> <span class="n">utm_source</span>
	<span class="k">ON</span> <span class="n">utm_source</span><span class="p">.</span><span class="k">key</span> <span class="o">=</span> <span class="err">â€˜</span><span class="k">source</span><span class="err">â€™</span>
</code></pre></div></div>
<ul>
  <li>Many times, each <code class="language-plaintext highlighter-rouge">session</code> has a totally different shape of the journey depending on what kind of <strong>source channel</strong> the session has started from. Therefore, letâ€™s also query <code class="language-plaintext highlighter-rouge">utm_source</code> just in case.</li>
</ul>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">LEFT</span> <span class="k">JOIN</span>
	<span class="k">UNNEST</span> <span class="p">(</span><span class="n">event_params</span><span class="p">)</span> <span class="k">AS</span> <span class="n">page_referrer</span>
	<span class="k">ON</span> <span class="n">page_referrer</span><span class="p">.</span><span class="k">key</span> <span class="o">=</span> <span class="err">â€˜</span><span class="n">page_referrer</span><span class="err">â€™</span>
</code></pre></div></div>
<ul>
  <li>Many times, each <code class="language-plaintext highlighter-rouge">session</code> has a totally different shape of the journey depending on exactly what <strong>previous page URL</strong> the session has started from. Therefore, letâ€™s also query <code class="language-plaintext highlighter-rouge">page_referrer</code> just in case.</li>
</ul>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">AND</span> <span class="n">ga_session_number</span><span class="p">.</span><span class="n">value</span><span class="p">.</span><span class="n">int_value</span> <span class="o">=</span> <span class="mi">1</span>  
<span class="k">AND</span> <span class="n">user_pseudo_id</span> <span class="k">IS</span> <span class="k">NOT</span> <span class="k">NULL</span>  
<span class="k">AND</span> <span class="n">ga_session_id</span> <span class="k">IS</span> <span class="k">NOT</span> <span class="k">NULL</span>
</code></pre></div></div>
<ul>
  <li>Here, I wanted to know specifically about the <strong>first visiting usersâ€™ journey</strong>, and thatâ€™s why I try to query with <code class="language-plaintext highlighter-rouge">ga_session_number</code> only as <code class="language-plaintext highlighter-rouge">1</code>.</li>
  <li>We basically have to track the <code class="language-plaintext highlighter-rouge">user_pseudo_id</code> and <code class="language-plaintext highlighter-rouge">ga_session_id</code> in order to <strong>make sure each user journey has been there from the same user and same session</strong>. Thatâ€™s why I dropped all the missing <code class="language-plaintext highlighter-rouge">user_pseudo_id</code> and <code class="language-plaintext highlighter-rouge">ga_session_id</code> instances.</li>
</ul>

<h1 id="3-make-sure-each-user-and-session-has-the-same-propertiesor-parameters">3. Make sure each user and session has the same properties(or parameters).</h1>

<p>Sometimes, even though itâ€™s rooted in the same <code class="language-plaintext highlighter-rouge">session_id</code>, some events have their parameters fully, but others donâ€™t. Thatâ€™s why we make duplicates for the parameters throughout the same <code class="language-plaintext highlighter-rouge">user_pseudo_id</code> and <code class="language-plaintext highlighter-rouge">session_id</code>.</p>

<p><img src="/assets/2023-05-21-sankey-chart/ This is a real BigQuery table appended from GA4, and look only one event has the medium value.webp" alt="" /></p>
<blockquote>
  <p>This is a real <strong>BigQuery</strong> table appended from GA4, and you can look only one event has the medium value.</p>
</blockquote>

<h2 id="31-the-entire-codes">3.1. The Entire Codes</h2>

<p>You can use <code class="language-plaintext highlighter-rouge">FIRST_VALUE</code> and <code class="language-plaintext highlighter-rouge">LAST_VALUE</code> functions to make the duplicates.</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">CTE_properties_spread</span> <span class="k">AS</span> <span class="p">(</span>  
    <span class="k">SELECT</span>  
        <span class="n">event_date</span><span class="p">,</span>
        <span class="n">event_timestamp</span><span class="p">,</span>  
        <span class="n">user_pseudo_id</span><span class="p">,</span>
        <span class="n">session_id</span><span class="p">,</span>
        <span class="n">session_number</span><span class="p">,</span>  
        <span class="n">event_name</span><span class="p">,</span> 
        <span class="n">REGEXP_REPLACE</span><span class="p">(</span>
	        <span class="n">REGEXP_REPLACE</span><span class="p">(</span>
		        <span class="k">LOWER</span><span class="p">(</span><span class="n">page_location</span><span class="p">),</span> 
		        <span class="n">r</span><span class="s1">'(</span><span class="se">\?</span><span class="s1">.*)$'</span><span class="p">,</span> <span class="s1">''</span>
	        <span class="p">),</span>
	        <span class="n">r</span><span class="s1">'/$'</span><span class="p">,</span> <span class="s1">''</span>
        <span class="p">)</span> <span class="k">AS</span> <span class="n">page_location</span><span class="p">,</span>
        <span class="n">revenue_usd</span><span class="p">,</span>  
        <span class="n">FIRST_VALUE</span><span class="p">(</span><span class="n">country</span><span class="p">)</span> <span class="n">OVER</span><span class="p">(</span>
	        <span class="k">PARTITION</span> <span class="k">BY</span> <span class="n">user_pseudo_id</span><span class="p">,</span> <span class="n">session_id</span>
	        <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">event_timestamp</span>
        <span class="p">)</span> <span class="k">AS</span> <span class="n">country</span><span class="p">,</span>  
        <span class="n">FIRST_VALUE</span><span class="p">(</span><span class="n">device</span><span class="p">)</span> <span class="n">OVER</span><span class="p">(</span>
	        <span class="k">PARTITION</span> <span class="k">BY</span> <span class="n">user_pseudo_id</span><span class="p">,</span> <span class="n">session_id</span>
	        <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">event_timestamp</span>
        <span class="p">)</span> <span class="k">AS</span> <span class="n">device</span><span class="p">,</span>  
        <span class="n">LAST_VALUE</span><span class="p">(</span><span class="n">utm_campaign</span><span class="p">)</span> <span class="n">OVER</span><span class="p">(</span>
	        <span class="k">PARTITION</span> <span class="k">BY</span> <span class="n">user_pseudo_id</span><span class="p">,</span> <span class="n">session_id</span>
	        <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">event_timestamp</span>
        <span class="p">)</span> <span class="k">AS</span> <span class="n">utm_campaign</span><span class="p">,</span>  
        <span class="n">LAST_VALUE</span><span class="p">(</span><span class="n">utm_medium</span><span class="p">)</span> <span class="n">OVER</span><span class="p">(</span>
	        <span class="k">PARTITION</span> <span class="k">BY</span> <span class="n">user_pseudo_id</span><span class="p">,</span> <span class="n">session_id</span>
	        <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">event_timestamp</span>
        <span class="p">)</span> <span class="k">AS</span> <span class="n">utm_medium</span><span class="p">,</span>  
        <span class="n">LAST_VALUE</span><span class="p">(</span><span class="n">utm_source</span><span class="p">)</span> <span class="n">OVER</span><span class="p">(</span>
	        <span class="k">PARTITION</span> <span class="k">BY</span> <span class="n">user_pseudo_id</span><span class="p">,</span> <span class="n">session_id</span>
	        <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">event_timestamp</span>
        <span class="p">)</span> <span class="k">AS</span> <span class="n">utm_source</span><span class="p">,</span>  
        <span class="n">LAST_VALUE</span><span class="p">(</span>
	        <span class="n">REGEXP_REPLACE</span><span class="p">(</span>
		        <span class="n">REGEXP_REPLACE</span><span class="p">(</span>
			        <span class="k">LOWER</span><span class="p">(</span><span class="n">page_referrer</span><span class="p">),</span> 
			        <span class="n">r</span><span class="s1">'(</span><span class="se">\?</span><span class="s1">.*)$'</span><span class="p">,</span> <span class="s1">''</span>
		        <span class="p">),</span> 
		        <span class="n">r</span><span class="s1">'/$'</span><span class="p">,</span> <span class="s1">''</span>
	        <span class="p">)</span>
        <span class="p">)</span> <span class="n">OVER</span><span class="p">(</span>
	        <span class="k">PARTITION</span> <span class="k">BY</span> <span class="n">user_pseudo_id</span><span class="p">,</span> <span class="n">session_id</span> 
	        <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">event_timestamp</span>
        <span class="p">)</span> <span class="k">AS</span> <span class="n">page_referrer</span>  
    <span class="k">FROM</span>
	    <span class="n">CTE_flattened</span> 
<span class="p">),</span>
</code></pre></div></div>

<h2 id="32-detailed-explanation-of-key-codes">3.2. Detailed Explanation of Key Codes</h2>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">REGEXP_REPLACE</span><span class="p">(</span>
	<span class="n">REGEXP_REPLACE</span><span class="p">(</span>
		<span class="k">LOWER</span><span class="p">(</span><span class="n">page_location</span><span class="p">),</span> 
		<span class="n">r</span><span class="s1">'(</span><span class="se">\?</span><span class="s1">.*)$'</span><span class="p">,</span> <span class="s1">''</span>
	<span class="p">),</span>
	<span class="n">r</span><span class="s1">'/$'</span><span class="p">,</span> <span class="s1">''</span>
<span class="p">)</span> <span class="k">AS</span> <span class="n">page_location</span><span class="p">,</span>
</code></pre></div></div>
<ul>
  <li>Many times, the <strong>page URL</strong> has different shapes even though it drives the visitors to the exact same page.</li>
  <li>The four URLs below have different values, but they direct you to the same Google main page anyways.
    <ul>
      <li><a href="https://google.com/">https://google.com</a></li>
      <li><a href="https://google.com/">https://google.com/</a></li>
      <li><a href="https://google.com?utm_source=medium">https://google.com?utm_source=medium</a></li>
      <li><a href="https://google.com/?utm_source=medium">https://google.com/?utm_source=medium</a></li>
    </ul>
  </li>
  <li>Thatâ€™s why I use the <code class="language-plaintext highlighter-rouge">REGEXP_REPLACE</code> function to <strong>drop the useless letters</strong> in data analytics.</li>
</ul>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">FIRST_VALUE</span><span class="p">(</span><span class="n">country</span><span class="p">)</span> <span class="n">OVER</span><span class="p">(</span>
	<span class="k">PARTITION</span> <span class="k">BY</span> <span class="n">user_pseudo_id</span><span class="p">,</span> <span class="n">session_id</span>
	<span class="k">ORDER</span> <span class="k">BY</span> <span class="n">event_timestamp</span>
<span class="p">)</span> <span class="k">AS</span> <span class="n">country</span>
</code></pre></div></div>
<ul>
  <li>Because of some technical problems, one user and session might have multiple countries. (Iâ€™m guessing some users might have moved overseas, changed IP Address through VPNs, or GA4â€™s tech issue itself.) Regarding this issue, I would make a decision to <strong>grab the very first country value</strong> to know where the <code class="language-plaintext highlighter-rouge">user</code> and <code class="language-plaintext highlighter-rouge">session</code> have started.</li>
  <li>Letâ€™s assume a visitor is aboard a plane, and when he/she starts the session the plane is located in the <strong>US</strong>, but when visiting the following page, the plane has just entered the <strong>Canada</strong> area. In this extreme case, weâ€™d rather think of this visitor as starting from the <strong>US</strong>.</li>
</ul>

<h1 id="4-delete-the-consecutive-same-page-url-duplicates-in-the-same-session_id">4. Delete the consecutive same page URL duplicates in the same <code class="language-plaintext highlighter-rouge">session_id</code>.</h1>

<p>In most cases, if a visitor lands on page A, multiple events can happen.</p>
<ul>
  <li>i.e., <code class="language-plaintext highlighter-rouge">session_start</code>, <code class="language-plaintext highlighter-rouge">page_view</code>, <code class="language-plaintext highlighter-rouge">user_engagement</code>, <code class="language-plaintext highlighter-rouge">scroll</code>, and whatnot</li>
</ul>

<p>We need to delete all the same Page URLs triggered consecutively in one session, but <strong>only with the unique page URL</strong>.</p>

<h2 id="41-the-entire-codes">4.1. The Entire Codes</h2>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">CTE_unique_pages</span> <span class="k">AS</span> <span class="p">(</span>
	<span class="k">SELECT</span>  
        <span class="n">event_date</span><span class="p">,</span> <span class="n">event_timestamp</span><span class="p">,</span>  
        <span class="n">user_pseudo_id</span><span class="p">,</span> <span class="n">session_id</span><span class="p">,</span> <span class="n">session_number</span><span class="p">,</span>  
        <span class="n">event_name</span><span class="p">,</span>  
        <span class="n">page_location</span><span class="p">,</span>          
        <span class="n">LAG</span><span class="p">(</span><span class="n">page_location</span><span class="p">)</span> <span class="n">OVER</span><span class="p">(</span>
	        <span class="k">PARTITION</span> <span class="k">BY</span> <span class="n">user_pseudo_id</span><span class="p">,</span> <span class="n">session_id</span> 
	        <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">event_timestamp</span>
        <span class="p">)</span> <span class="k">AS</span> <span class="n">previous_page_location</span><span class="p">,</span>  
        <span class="n">LEAD</span><span class="p">(</span><span class="n">page_location</span><span class="p">)</span> <span class="n">OVER</span><span class="p">(</span>
	        <span class="k">PARTITION</span> <span class="k">BY</span> <span class="n">user_pseudo_id</span><span class="p">,</span> <span class="n">session_id</span> 
	        <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">event_timestamp</span>
        <span class="p">)</span> <span class="k">AS</span> <span class="n">next_page_location</span><span class="p">,</span>  
        <span class="n">revenue_usd</span><span class="p">,</span>  
        <span class="n">country</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span>  
        <span class="n">utm_campaign</span><span class="p">,</span> <span class="n">utm_medium</span><span class="p">,</span> <span class="n">utm_source</span><span class="p">,</span> <span class="n">page_referrer</span>      
    <span class="k">FROM</span> <span class="p">(</span>  
        <span class="k">SELECT</span>  
            <span class="o">*</span><span class="p">,</span>  
            <span class="k">CASE</span>  
	            <span class="k">WHEN</span> <span class="c1">-- Previous URL IS NULL  </span>
                    <span class="n">previous_page_location</span> <span class="k">IS</span> <span class="k">NULL</span> <span class="k">THEN</span> <span class="s1">'remain'</span>  
                <span class="k">WHEN</span> <span class="c1">-- Previous URL &lt;&gt; Current URL  </span>
                    <span class="n">previous_page_location</span> <span class="o">&lt;&gt;</span> <span class="n">page_location</span> <span class="k">THEN</span> <span class="s1">'remain'</span>  
                <span class="k">WHEN</span> <span class="c1">-- Previous URL = Current URL  </span>
                    <span class="n">previous_page_location</span> <span class="o">=</span> <span class="n">page_location</span> 
                    <span class="k">AND</span> <span class="n">page_location</span> <span class="o">&lt;&gt;</span> <span class="n">next_page_location</span> <span class="k">THEN</span> <span class="s1">'del'</span>  
            <span class="k">END</span> <span class="k">AS</span> <span class="n">remain_or_del</span>  
        <span class="k">FROM</span> <span class="p">(</span>  
            <span class="k">SELECT</span>  
                <span class="n">event_date</span><span class="p">,</span> <span class="n">event_timestamp</span><span class="p">,</span>  
                <span class="n">user_pseudo_id</span><span class="p">,</span> <span class="n">session_id</span><span class="p">,</span> <span class="n">session_number</span><span class="p">,</span>  
                <span class="n">event_name</span><span class="p">,</span>
                <span class="n">page_location</span><span class="p">,</span>          
                <span class="n">LAG</span><span class="p">(</span><span class="n">page_location</span><span class="p">)</span> <span class="n">OVER</span><span class="p">(</span>
	                <span class="k">PARTITION</span> <span class="k">BY</span> <span class="n">user_pseudo_id</span><span class="p">,</span> <span class="n">session_id</span>
	                <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">event_timestamp</span>
                <span class="p">)</span> <span class="k">AS</span> <span class="n">previous_page_location</span><span class="p">,</span>  
                <span class="n">LEAD</span><span class="p">(</span><span class="n">page_location</span><span class="p">)</span> <span class="n">OVER</span><span class="p">(</span>
	                <span class="k">PARTITION</span> <span class="k">BY</span> <span class="n">user_pseudo_id</span><span class="p">,</span> <span class="n">session_id</span> 
	                <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">event_timestamp</span>
                <span class="p">)</span> <span class="k">AS</span> <span class="n">next_page_location</span><span class="p">,</span>  
                <span class="n">revenue_usd</span><span class="p">,</span>  
                <span class="n">country</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span>  
                <span class="n">utm_campaign</span><span class="p">,</span> <span class="n">utm_medium</span><span class="p">,</span> <span class="n">utm_source</span><span class="p">,</span> <span class="n">page_referrer</span>  
            <span class="k">FROM</span> <span class="n">CTE_properties_spread</span>  
        <span class="p">)</span>  
    <span class="p">)</span>  
    <span class="k">WHERE</span>
	    <span class="n">remain_or_del</span> <span class="o">=</span> <span class="s1">'remain'</span>  
    <span class="k">ORDER</span> <span class="k">BY</span> 
	    <span class="n">user_pseudo_id</span><span class="p">,</span> <span class="n">session_id</span><span class="p">,</span> <span class="n">event_timestamp</span>  
<span class="p">),</span>
</code></pre></div></div>

<p>Here in the query above, I used <code class="language-plaintext highlighter-rouge">LAG</code> and <code class="language-plaintext highlighter-rouge">LEAD</code> window functions <strong>to know whether to delete duplicates</strong> based on the previous page URL and the next page URL.</p>

<h1 id="5-label-each-pages-visiting-order-number-for-each-session">5. Label each pageâ€™s visiting order number for each session.</h1>

<p>We can Label <code class="language-plaintext highlighter-rouge">visit_order</code> for each page URL based on the <code class="language-plaintext highlighter-rouge">event_timestamp</code> <strong>in ascending order</strong>.</p>
<ul>
  <li>Here, I used the <code class="language-plaintext highlighter-rouge">ROW_NUMBER</code> window function to do it.</li>
</ul>

<h2 id="51-the-entire-codes">5.1. The Entire Codes</h2>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">CTE_visit_orders</span> <span class="k">AS</span> <span class="p">(</span>  
    <span class="k">SELECT</span>  
        <span class="n">event_date</span><span class="p">,</span> <span class="n">event_timestamp</span><span class="p">,</span>  
        <span class="n">user_pseudo_id</span><span class="p">,</span> <span class="n">session_id</span><span class="p">,</span>  
        <span class="n">page_location</span><span class="p">,</span>
        <span class="n">ROW_NUMBER</span><span class="p">()</span> <span class="n">OVER</span><span class="p">(</span>
	        <span class="k">PARTITION</span> <span class="k">BY</span> <span class="n">user_pseudo_id</span><span class="p">,</span> <span class="n">session_id</span> 
	        <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">event_timestamp</span>
        <span class="p">)</span> <span class="k">AS</span> <span class="n">visit_order</span><span class="p">,</span>  
        <span class="n">country</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span>  
        <span class="n">utm_campaign</span><span class="p">,</span> <span class="n">utm_medium</span><span class="p">,</span> <span class="n">utm_source</span><span class="p">,</span> <span class="n">page_referrer</span>  
    <span class="k">FROM</span>
	    <span class="n">CTE_unique_pages</span>  
    <span class="k">ORDER</span> <span class="k">BY</span> 
	    <span class="n">user_pseudo_id</span><span class="p">,</span> <span class="n">session_id</span><span class="p">,</span> <span class="n">visit_order</span>  
<span class="p">),</span>
</code></pre></div></div>

<h1 id="6-categorize-all-the-pages">6. Categorize all the pages.</h1>

<p>The page URL itself looks dirty since itâ€™s not that human-readable, so here I wanted to <strong>categorize all the pages</strong> existing in the whole domain to <strong>make them literally human-readable</strong>.</p>

<h2 id="61-the-entire-codes">6.1. The Entire Codes</h2>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">CTE_page_groups</span> <span class="k">AS</span> <span class="p">(</span>  
    <span class="k">SELECT</span>  
        <span class="n">event_date</span><span class="p">,</span> <span class="n">event_timestamp</span><span class="p">,</span>  
        <span class="n">user_pseudo_id</span><span class="p">,</span> <span class="n">session_id</span><span class="p">,</span>  
        <span class="n">page_location</span><span class="p">,</span>   
        <span class="k">CASE</span>  
            <span class="k">WHEN</span> <span class="n">page_location</span> <span class="o">=</span> <span class="s1">'https://google.com'</span> <span class="k">THEN</span> <span class="s1">'Google Home'</span>  
            <span class="k">WHEN</span> <span class="n">page_location</span> <span class="o">=</span> <span class="s1">'https://google.com/joshua'</span> <span class="k">THEN</span> <span class="s1">'Joshua Intro'</span>  
            <span class="k">WHEN</span> <span class="n">page_location</span> <span class="o">=</span> <span class="s1">'https://google.com/andrew'</span> <span class="k">THEN</span> <span class="s1">'Andrew Intro'</span>  
            <span class="k">WHEN</span> <span class="n">page_location</span> <span class="o">=</span> <span class="s1">'https://google.com/amber'</span> <span class="k">THEN</span> <span class="s1">'Amber Intro'</span>  
            <span class="k">WHEN</span> <span class="n">CONTAINS_SUBSTR</span><span class="p">(</span><span class="n">page_location</span><span class="p">,</span> <span class="s1">'https://google.com/policy'</span><span class="p">)</span> <span class="o">=</span> <span class="k">True</span> <span class="k">THEN</span> <span class="s1">'Policy Pages'</span>  
            <span class="k">WHEN</span> <span class="n">CONTAINS_SUBSTR</span><span class="p">(</span><span class="n">page_location</span><span class="p">,</span> <span class="s1">'https://google.com/events'</span><span class="p">)</span> <span class="o">=</span> <span class="k">True</span> <span class="k">THEN</span> <span class="s1">'Event Pages'</span>  
            <span class="k">ELSE</span> <span class="s1">'ETC'</span>  
        <span class="k">END</span> <span class="k">AS</span> <span class="n">page_group</span><span class="p">,</span>  
        <span class="n">visit_order</span><span class="p">,</span>  
        <span class="n">country</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span>  
        <span class="n">utm_campaign</span><span class="p">,</span> <span class="n">utm_medium</span><span class="p">,</span> <span class="n">utm_source</span><span class="p">,</span> <span class="n">page_referrer</span>  
    <span class="k">FROM</span>
	    <span class="n">CTE_visit_orders</span>
    <span class="k">ORDER</span> <span class="k">BY</span> 
	    <span class="n">user_pseudo_id</span><span class="p">,</span> <span class="n">session_id</span><span class="p">,</span> <span class="n">visit_order</span>  
<span class="p">),</span>
</code></pre></div></div>

<h1 id="7-pivot-each-sessions-journey-up-to-10-steps">7. Pivot each sessionâ€™s journey up to 10 steps.</h1>

<h2 id="71-the-entire-codes">7.1. The Entire Codes</h2>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">CTE_journeys</span> <span class="k">AS</span> <span class="p">(</span>  
    <span class="k">SELECT</span>  
        <span class="n">user_pseudo_id</span><span class="p">,</span> <span class="n">session_id</span><span class="p">,</span>
        <span class="n">country</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> 
        <span class="n">utm_campaign</span><span class="p">,</span> <span class="n">utm_medium</span><span class="p">,</span> <span class="n">utm_source</span><span class="p">,</span> <span class="n">page_referrer</span><span class="p">,</span>  
        <span class="k">MAX</span><span class="p">((</span><span class="k">SELECT</span> <span class="n">page_group</span> <span class="k">FROM</span> <span class="n">CTE_page_groups</span> <span class="n">SUB</span>  
            <span class="k">WHERE</span> <span class="n">MAIN</span><span class="p">.</span><span class="n">user_pseudo_id</span> <span class="o">=</span> <span class="n">SUB</span><span class="p">.</span><span class="n">user_pseudo_id</span> <span class="k">AND</span> <span class="n">MAIN</span><span class="p">.</span><span class="n">session_id</span> <span class="o">=</span> <span class="n">SUB</span><span class="p">.</span><span class="n">session_id</span> <span class="k">AND</span> <span class="n">visit_order</span> <span class="o">=</span> <span class="mi">1</span><span class="p">))</span> <span class="k">AS</span> <span class="n">step01</span><span class="p">,</span>  
        <span class="k">MAX</span><span class="p">((</span><span class="k">SELECT</span> <span class="n">page_group</span> <span class="k">FROM</span> <span class="n">CTE_page_groups</span> <span class="n">SUB</span>  
            <span class="k">WHERE</span> <span class="n">MAIN</span><span class="p">.</span><span class="n">user_pseudo_id</span> <span class="o">=</span> <span class="n">SUB</span><span class="p">.</span><span class="n">user_pseudo_id</span> <span class="k">AND</span> <span class="n">MAIN</span><span class="p">.</span><span class="n">session_id</span> <span class="o">=</span> <span class="n">SUB</span><span class="p">.</span><span class="n">session_id</span> <span class="k">AND</span> <span class="n">visit_order</span> <span class="o">=</span> <span class="mi">2</span><span class="p">))</span> <span class="k">AS</span> <span class="n">step02</span><span class="p">,</span>  
        <span class="k">MAX</span><span class="p">((</span><span class="k">SELECT</span> <span class="n">page_group</span> <span class="k">FROM</span> <span class="n">CTE_page_groups</span> <span class="n">SUB</span>  
            <span class="k">WHERE</span> <span class="n">MAIN</span><span class="p">.</span><span class="n">user_pseudo_id</span> <span class="o">=</span> <span class="n">SUB</span><span class="p">.</span><span class="n">user_pseudo_id</span> <span class="k">AND</span> <span class="n">MAIN</span><span class="p">.</span><span class="n">session_id</span> <span class="o">=</span> <span class="n">SUB</span><span class="p">.</span><span class="n">session_id</span> <span class="k">AND</span> <span class="n">visit_order</span> <span class="o">=</span> <span class="mi">3</span><span class="p">))</span> <span class="k">AS</span> <span class="n">step03</span><span class="p">,</span>  
        <span class="k">MAX</span><span class="p">((</span><span class="k">SELECT</span> <span class="n">page_group</span> <span class="k">FROM</span> <span class="n">CTE_page_groups</span> <span class="n">SUB</span>  
            <span class="k">WHERE</span> <span class="n">MAIN</span><span class="p">.</span><span class="n">user_pseudo_id</span> <span class="o">=</span> <span class="n">SUB</span><span class="p">.</span><span class="n">user_pseudo_id</span> <span class="k">AND</span> <span class="n">MAIN</span><span class="p">.</span><span class="n">session_id</span> <span class="o">=</span> <span class="n">SUB</span><span class="p">.</span><span class="n">session_id</span> <span class="k">AND</span> <span class="n">visit_order</span> <span class="o">=</span> <span class="mi">4</span><span class="p">))</span> <span class="k">AS</span> <span class="n">step04</span><span class="p">,</span>  
        <span class="k">MAX</span><span class="p">((</span><span class="k">SELECT</span> <span class="n">page_group</span> <span class="k">FROM</span> <span class="n">CTE_page_groups</span> <span class="n">SUB</span>  
            <span class="k">WHERE</span> <span class="n">MAIN</span><span class="p">.</span><span class="n">user_pseudo_id</span> <span class="o">=</span> <span class="n">SUB</span><span class="p">.</span><span class="n">user_pseudo_id</span> <span class="k">AND</span> <span class="n">MAIN</span><span class="p">.</span><span class="n">session_id</span> <span class="o">=</span> <span class="n">SUB</span><span class="p">.</span><span class="n">session_id</span> <span class="k">AND</span> <span class="n">visit_order</span> <span class="o">=</span> <span class="mi">5</span><span class="p">))</span> <span class="k">AS</span> <span class="n">step05</span><span class="p">,</span>          
        <span class="k">MAX</span><span class="p">((</span><span class="k">SELECT</span> <span class="n">page_group</span> <span class="k">FROM</span> <span class="n">CTE_page_groups</span> <span class="n">SUB</span>  
            <span class="k">WHERE</span> <span class="n">MAIN</span><span class="p">.</span><span class="n">user_pseudo_id</span> <span class="o">=</span> <span class="n">SUB</span><span class="p">.</span><span class="n">user_pseudo_id</span> <span class="k">AND</span> <span class="n">MAIN</span><span class="p">.</span><span class="n">session_id</span> <span class="o">=</span> <span class="n">SUB</span><span class="p">.</span><span class="n">session_id</span> <span class="k">AND</span> <span class="n">visit_order</span> <span class="o">=</span> <span class="mi">6</span><span class="p">))</span> <span class="k">AS</span> <span class="n">step06</span><span class="p">,</span>  
        <span class="k">MAX</span><span class="p">((</span><span class="k">SELECT</span> <span class="n">page_group</span> <span class="k">FROM</span> <span class="n">CTE_page_groups</span> <span class="n">SUB</span>  
            <span class="k">WHERE</span> <span class="n">MAIN</span><span class="p">.</span><span class="n">user_pseudo_id</span> <span class="o">=</span> <span class="n">SUB</span><span class="p">.</span><span class="n">user_pseudo_id</span> <span class="k">AND</span> <span class="n">MAIN</span><span class="p">.</span><span class="n">session_id</span> <span class="o">=</span> <span class="n">SUB</span><span class="p">.</span><span class="n">session_id</span> <span class="k">AND</span> <span class="n">visit_order</span> <span class="o">=</span> <span class="mi">7</span><span class="p">))</span> <span class="k">AS</span> <span class="n">step07</span><span class="p">,</span>  
        <span class="k">MAX</span><span class="p">((</span><span class="k">SELECT</span> <span class="n">page_group</span> <span class="k">FROM</span> <span class="n">CTE_page_groups</span> <span class="n">SUB</span>  
            <span class="k">WHERE</span> <span class="n">MAIN</span><span class="p">.</span><span class="n">user_pseudo_id</span> <span class="o">=</span> <span class="n">SUB</span><span class="p">.</span><span class="n">user_pseudo_id</span> <span class="k">AND</span> <span class="n">MAIN</span><span class="p">.</span><span class="n">session_id</span> <span class="o">=</span> <span class="n">SUB</span><span class="p">.</span><span class="n">session_id</span> <span class="k">AND</span> <span class="n">visit_order</span> <span class="o">=</span> <span class="mi">8</span><span class="p">))</span> <span class="k">AS</span> <span class="n">step08</span><span class="p">,</span>  
        <span class="k">MAX</span><span class="p">((</span><span class="k">SELECT</span> <span class="n">page_group</span> <span class="k">FROM</span> <span class="n">CTE_page_groups</span> <span class="n">SUB</span>  
            <span class="k">WHERE</span> <span class="n">MAIN</span><span class="p">.</span><span class="n">user_pseudo_id</span> <span class="o">=</span> <span class="n">SUB</span><span class="p">.</span><span class="n">user_pseudo_id</span> <span class="k">AND</span> <span class="n">MAIN</span><span class="p">.</span><span class="n">session_id</span> <span class="o">=</span> <span class="n">SUB</span><span class="p">.</span><span class="n">session_id</span> <span class="k">AND</span> <span class="n">visit_order</span> <span class="o">=</span> <span class="mi">9</span><span class="p">))</span> <span class="k">AS</span> <span class="n">step09</span><span class="p">,</span>  
        <span class="k">MAX</span><span class="p">((</span><span class="k">SELECT</span> <span class="n">page_group</span> <span class="k">FROM</span> <span class="n">CTE_page_groups</span> <span class="n">SUB</span>  
            <span class="k">WHERE</span> <span class="n">MAIN</span><span class="p">.</span><span class="n">user_pseudo_id</span> <span class="o">=</span> <span class="n">SUB</span><span class="p">.</span><span class="n">user_pseudo_id</span> <span class="k">AND</span> <span class="n">MAIN</span><span class="p">.</span><span class="n">session_id</span> <span class="o">=</span> <span class="n">SUB</span><span class="p">.</span><span class="n">session_id</span> <span class="k">AND</span> <span class="n">visit_order</span> <span class="o">=</span> <span class="mi">10</span><span class="p">))</span> <span class="k">AS</span> <span class="n">step10</span>  
    <span class="k">FROM</span> <span class="n">CTE_page_groups</span> <span class="n">MAIN</span>  
    <span class="k">GROUP</span> <span class="k">BY</span>
        <span class="n">user_pseudo_id</span><span class="p">,</span> <span class="n">session_id</span><span class="p">,</span> 
        <span class="n">country</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> 
        <span class="n">utm_campaign</span><span class="p">,</span> <span class="n">utm_medium</span><span class="p">,</span> <span class="n">utm_source</span><span class="p">,</span> <span class="n">page_referrer</span>  
    <span class="k">ORDER</span> <span class="k">BY</span>  
        <span class="n">step01</span><span class="p">,</span> <span class="n">step02</span><span class="p">,</span> <span class="n">step03</span><span class="p">,</span> <span class="n">step04</span><span class="p">,</span> <span class="n">step05</span><span class="p">,</span> 
        <span class="n">step06</span><span class="p">,</span> <span class="n">step07</span><span class="p">,</span> <span class="n">step08</span><span class="p">,</span> <span class="n">step09</span><span class="p">,</span> <span class="n">step10</span>  
<span class="p">),</span>
</code></pre></div></div>

<h1 id="8-make-the-query-result-compatible-with-redash">8. Make the query result compatible with Redash.</h1>

<p>Since <strong>Redash Sankey Chart</strong> has its expected framework and naming rules of the query result, we need to make the final query result in order to fit the rule.</p>

<p><img src="/assets/2023-05-21-sankey-chart/Redash Sankey Visualizationâ€™s Constraints.webp" alt="" /></p>
<blockquote>
  <p>Redash Sankey Chartâ€™s Constraints</p>
</blockquote>

<h2 id="81-the-entire-codes">8.1. The Entire Codes</h2>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span>  
    <span class="n">step01</span> <span class="k">AS</span> <span class="n">stage1</span><span class="p">,</span>
    <span class="n">step02</span> <span class="k">AS</span> <span class="n">stage2</span><span class="p">,</span> 
    <span class="n">step03</span> <span class="k">AS</span> <span class="n">stage3</span><span class="p">,</span> 
    <span class="n">step04</span> <span class="k">AS</span> <span class="n">stage4</span><span class="p">,</span> 
    <span class="n">step05</span> <span class="k">AS</span> <span class="n">stage5</span><span class="p">,</span>  
    <span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">AS</span> <span class="n">value</span>  
<span class="k">FROM</span> 
	<span class="n">CTE_sankey</span>  
<span class="k">GROUP</span> <span class="k">BY</span> 
	<span class="n">step01</span><span class="p">,</span> <span class="n">step02</span><span class="p">,</span> <span class="n">step03</span><span class="p">,</span> <span class="n">step04</span><span class="p">,</span> <span class="n">step05</span>  
<span class="k">HAVING</span> 
	<span class="n">step01</span> <span class="o">=</span> <span class="s1">'Google Home'</span> 
	<span class="k">AND</span> <span class="n">value</span> <span class="o">&gt;=</span> <span class="mi">100</span>  
<span class="k">ORDER</span> <span class="k">BY</span> 
	<span class="n">value</span> <span class="k">DESC</span>
<span class="p">;</span>
</code></pre></div></div>

<h2 id="82-detailed-explanation-of-key-codes">8.2. Detailed Explanation of Key Codes</h2>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">HAVING</span>
	<span class="n">step01</span> <span class="o">=</span> <span class="err">â€˜</span><span class="n">Google</span> <span class="n">Home</span><span class="err">â€™</span> 
	<span class="k">AND</span> <span class="n">value</span> <span class="o">&gt;=</span> <span class="mi">100</span>
</code></pre></div></div>

<ul>
  <li>I just wanted to see how the users make their journey who is <strong>starting from Google Home</strong>.</li>
  <li>To make the visualization look simple and not distracting, I ordered the query to show me <strong>the types of user journeys of at least 100 users</strong>.</li>
</ul>

<h1 id="9-final-result">9. Final Result</h1>

<p><img src="/assets/2023-05-21-sankey-chart/Redash returns this kind of Sankey Chart.webp" alt="" /></p>
<blockquote>
  <p>Redash returns this kind of Sankey Chart.</p>
</blockquote>

<h1 id="10-conclusion">10. Conclusion</h1>

<ul>
  <li><strong>Redash Sankey Chart</strong> is much more valuable specifically when you try to figure out how the users make their journey depending on their countries, devices, UTM parameters, referrer pages, and stuff like that.</li>
  <li>Itâ€™s superbly complicated to query, but once you make the whole framework queries to return the Sankey table, I believe you can generate more value to do as many actions as possible which wouldnâ€™t have been possible to do before.</li>
  <li>Nevertheless, <strong>Redash Sankey Chart</strong> only supports up to <code class="language-plaintext highlighter-rouge">5 steps</code>, which by that means if your website or app has too many pages and screens, it wouldnâ€™t be enough to look through only 5 steps.</li>
</ul>

<hr />

<h2 id="published-by-joshua-kim"><em>Published by</em> Joshua Kim</h2>
<p><img src="/assets/profile/joshua-profile.png" alt="Joshua Kim" /></p>]]></content><author><name></name></author><category term="english" /><category term="sql" /><category term="bigquery" /><category term="redash" /><category term="data_visualization" /><summary type="html"><![CDATA[In this article, Iâ€™m going to tell you how you can create the Sankey Chart starting from GA4, BigQuery, and up to Redash.]]></summary></entry><entry><title type="html">íšŒê·€ ëª¨ë¸ì´ í’€ ìˆ˜ ì—†ëŠ” ë¬¸ì œ</title><link href="http://localhost:4000/when-regression-does-not-work/" rel="alternate" type="text/html" title="íšŒê·€ ëª¨ë¸ì´ í’€ ìˆ˜ ì—†ëŠ” ë¬¸ì œ" /><published>2022-12-25T00:00:00+09:00</published><updated>2022-12-25T00:00:00+09:00</updated><id>http://localhost:4000/when-regression-does-not-work</id><content type="html" xml:base="http://localhost:4000/when-regression-does-not-work/"><![CDATA[<blockquote>
  <p>ì´ë²ˆ ì•„í‹°í´ì—ì„œëŠ” íšŒê·€ëª¨ë¸(Regression Model)ì´ ì–´ë–¤ ê²½ìš°ì— ì €ì¡°í•œ ì„±ê³¼ë¥¼ ë‚´ëŠ”ì§€, ë” ë‚˜ì•„ê°€ Datasetì´ ì–´ë–¤ íŠ¹ì„±ì„ ì§€ë‹ ë•Œ íšŒê·€ëª¨ë¸ë¡œ í•´ë‹¹ ë¬¸ì œë¥¼ í’€ì–´ë‚¼ ìˆ˜ ì—†ëŠ”ì§€ í•„ìê°€ ê²½í—˜í•œ ë°”ë¥¼ ì„œìˆ í•´ë³´ê³ ì í•œë‹¤.</p>
</blockquote>

<h3 id="contents">CONTENTS</h3>
<ol>
  <li>Introduction</li>
  <li>í”„ë¡œì íŠ¸ ë°°ê²½ê³¼ ì£¼ì œ
    <ul>
      <li>2.1. ì—°êµ¬ ì£¼ì œ</li>
      <li>2.2. ì‚°ì—… í˜„í™© ë° ì—°êµ¬ ëª©ì </li>
      <li>2.3. ì—°êµ¬ ë¬¸ì œ ë° ì‹¤í—˜ ì •ì˜</li>
    </ul>
  </li>
  <li>ë°ì´í„° ì†Œê°œì™€ ë³€ìˆ˜ ì •ì˜
    <ul>
      <li>3.1. ë°ì´í„° í†ºì•„ë³´ê¸°</li>
      <li>3.2. 122,400ê°œì˜ ì¸ìŠ¤í„´ìŠ¤ë¡œ êµ¬ì„±ëœ ë°ì´í„°</li>
      <li>3.3. ë³€ìˆ˜ ì •ì˜</li>
    </ul>
  </li>
  <li>Data Preprocessing &amp; EDA
    <ul>
      <li>4.1. ë³€ìˆ˜ëª… Renaming</li>
      <li>4.2. Data Preprocessing</li>
      <li>4.3. EDA</li>
    </ul>
  </li>
  <li>Modeling
    <ul>
      <li>5.1. Simple Linear Regression (v1)</li>
      <li>5.2. Simple Linear Regression (v2) â€” â€œdayâ€ ë³€ìˆ˜ ì œì™¸</li>
      <li>5.3. Polynomial Regression (v1) â€” â€œdegree=2â€</li>
      <li>5.4. Polynomial Regression (v2) â€” â€œdegree=3â€</li>
      <li>5.5. Polynomial Regression (v3) â€” â€œdegree=4â€</li>
      <li>5.6. Polynomial Regression (v4) â€” â€œdegree=5â€</li>
    </ul>
  </li>
  <li>Conclusion
    <ul>
      <li>6.1. Regression Model ì™¸ì˜ ëª¨ë¸ì´ í•„ìš”í•˜ë‹¤!</li>
      <li>6.2. Regression Modelì´ í•´ë‹¹ Dataset í•™ìŠµì— ì ì ˆí•œ ëª¨ë¸ì´ ì•„ë‹˜ì„ íŒŒì•…í•˜ëŠ” ë°©ë²•ì€?</li>
    </ul>
  </li>
</ol>

<hr />

<p><img src="/assets/2022-12-25-when-regression-does-not-work/calculator.webp" alt="" /></p>

<h1 id="1-introduction">1. Introduction</h1>

<p>ë¨¸ì‹ ëŸ¬ë‹ê³¼ ë”¥ëŸ¬ë‹ ì•Œê³ ë¦¬ì¦˜ì„ ê³µë¶€í•˜ì‹  ë¶„ë“¤ì´ë¼ë©´ ëˆ„êµ¬ë‚˜ ì•„ëŠ” ì´ì•¼ê¸°ì´ì§€ë§Œ, ë°ì´í„° ì‚¬ì´ì–¸ìŠ¤ì—ì„œ ê°€ì¥ ì¤‘ìš”í•œ ì§€ì¹¨ì´ ìˆë‹¤.</p>

<blockquote>
  <p>â€œì–´ëŠ íŠ¹ì • ëª¨ë¸ì´ ëª¨ë“  ê²½ìš°ì— í•­ìƒ ìš°ì›”í•œ í¼í¬ë¨¼ìŠ¤ë¥¼ ì§€ë‹ˆì§€ ì•ŠëŠ”ë‹¤.â€</p>
</blockquote>

<p>ì¦‰, ì•„ë¬´ë¦¬ ë³µì¡í•˜ê³  ì¸ê¸°ê°€ ë§ì€ ëª¨ë¸ì´ë”ë¼ë„ ë°ì´í„°ì…‹ì˜ íŠ¹ì„±ì— ë”°ë¼ ìš°ì›”í•œ Metricì„ ë‚³ì„ ìˆ˜ë„ ìˆê³ , í˜¹ì€ ì €ì¡°í•œ Metricì„ ë‚³ì„ ìˆ˜ë„ ìˆë‹¤. (ê·¸ë˜ì„œ ëª¨ë¸ë§ ì‘ì—…ì—ì„œ ê°€ì¥ ì¤‘ìš”í•œ ê²ƒì€ ë‹¤ë¦„ ì•„ë‹Œ, Datasetì— ëŒ€í•œ ì´í•´ì´ê¸°ë„ í•˜ë‹¤.)</p>

<p>ì´ë²ˆ ì•„í‹°í´ì—ì„œëŠ” íšŒê·€ëª¨ë¸(Regression Model)ì´ ì–´ë–¤ ê²½ìš°ì— ì €ì¡°í•œ ì„±ê³¼ë¥¼ ë‚´ëŠ”ì§€, ë” ë‚˜ì•„ê°€ Datasetì´ ì–´ë–¤ íŠ¹ì„±ì„ ì§€ë‹ ë•Œ íšŒê·€ëª¨ë¸ë¡œ í•´ë‹¹ ë¬¸ì œë¥¼ í’€ì–´ë‚¼ ìˆ˜ ì—†ëŠ”ì§€ í•„ìê°€ ê²½í—˜í•œ ë°”ë¥¼ ì„œìˆ í•´ë³´ê³ ì í•œë‹¤.</p>

<p>íšŒê·€ëª¨ë¸ í•™ìŠµ ì‹¤í—˜ì„ í•˜ë‹¤ê°€ ìš°ì—°íˆ ì§ê´€ì ìœ¼ë¡œ ì•Œê²Œ ëœ ì¶”ì¸¡ì„± ê²°ë¡ ì´ì—ˆì§€ë§Œ, í†µê³„í•™ êµìˆ˜ë‹˜ìœ¼ë¡œë¶€í„° íƒ€ë‹¹ì„±ì„ ì¸ì • ë°›ì•˜ê¸° ë•Œë¬¸ì— ë³¸ ë‚´ìš©ì€ ì¶©ë¶„íˆ ê³µê°œí•´ë„ ë˜ë¦¬ë¼ ìƒê°í•œë‹¤. (êµìˆ˜ë‹˜, ì‚¬ë‘í•©ë‹ˆë‹¤.)</p>

<h1 id="2-í”„ë¡œì íŠ¸-ë°°ê²½ê³¼-ì£¼ì œ">2. í”„ë¡œì íŠ¸ ë°°ê²½ê³¼ ì£¼ì œ</h1>

<h2 id="21-ì—°êµ¬-ì£¼ì œ">2.1. ì—°êµ¬ ì£¼ì œ</h2>

<blockquote>
  <p>â€œê¸°ìƒ ì •ë³´ë¥¼ í†µí•œ ì „ë ¥ ì‚¬ìš©ëŸ‰ ì˜ˆì¸¡ ëª¨ë¸ êµ¬ì¶•í•˜ê¸°â€</p>
</blockquote>

<h2 id="22-ì‚°ì—…-í˜„í™©-ë°-ì—°êµ¬-ëª©ì ">2.2. ì‚°ì—… í˜„í™© ë° ì—°êµ¬ ëª©ì </h2>

<h3 id="1-í•œêµ­ì˜-ì „ë ¥-ì‚¬ìš©ëŸ‰ì€-ë§¤í•´-ì¦ê°€í•˜ëŠ”-ì¶”ì„¸">(1) í•œêµ­ì˜ ì „ë ¥ ì‚¬ìš©ëŸ‰ì€ ë§¤í•´ ì¦ê°€í•˜ëŠ” ì¶”ì„¸</h3>
<ul>
  <li>30ë…„ ì „ ëŒ€ë¹„ 5ë°° ì´ìƒ ë†’ì•„ì§„ ìˆ˜ì¤€</li>
</ul>

<p><img src="/assets/2022-12-25-when-regression-does-not-work/korea.webp" alt="" /></p>
<blockquote>
  <p><a href="https://yearbook.enerdata.co.kr/electricity/electricity-domestic-consumption-data.html">electricity domestic consumption data</a></p>
</blockquote>

<h3 id="2-í•œêµ­ì˜-ì „ê¸°ë£ŒëŠ”-oecd-íšŒì›êµ­ë“¤ì˜-50ì—-ë¯¸ì¹˜ì§€-ëª»í• -ì •ë„ë¡œ-ì €ë ´í•œ-ìˆ˜ì¤€">(2) í•œêµ­ì˜ ì „ê¸°ë£ŒëŠ” OECD íšŒì›êµ­ë“¤ì˜ 50%ì— ë¯¸ì¹˜ì§€ ëª»í•  ì •ë„ë¡œ ì €ë ´í•œ ìˆ˜ì¤€</h3>
<ul>
  <li>ì „ë ¥ ì‚¬ìš©ëŸ‰ì€ ì¦ê°€í•˜ëŠ” ë°˜ë©´, ìƒëŒ€ì ìœ¼ë¡œ ë‚®ê²Œ ì±…ì •ëœ ì „ê¸°ë£Œ ìˆ˜ì¤€</li>
  <li>ì—ë„ˆì§€ ë¹„ìš© ëª¨ë‹ˆí„°ë§ &amp; ì˜ˆì¸¡ ì„œë¹„ìŠ¤ë¥¼ ë„ì…í•˜ì—¬ ì‹œì¥ê²½ìŸë ¥ í™•ë³´ì˜ í•„ìš”ì„±</li>
</ul>

<p><img src="/assets/2022-12-25-when-regression-does-not-work/countries.webp" alt="" /></p>
<blockquote>
  <p><a href="https://home.kepco.co.kr/kepco/EB/A/htmlView/EBAAHP007.do">OECD íšŒì›êµ­ì˜ ê°€ì •ìš© &amp; ì‚°ì—…ìš© ì „ê¸°ìš”ê¸ˆ</a></p>
</blockquote>

<h3 id="3-í•œêµ­ì˜-ì „ë ¥-ì‚¬ìš©ëŸ‰ì€-ì—¬ë¦„ì² -ì¦ê°€í•˜ëŠ”-ê³„ì ˆì -ì£¼ê¸°ì„±ì´-ì¡´ì¬í•¨">(3) í•œêµ­ì˜ ì „ë ¥ ì‚¬ìš©ëŸ‰ì€ ì—¬ë¦„ì²  ì¦ê°€í•˜ëŠ” ê³„ì ˆì  ì£¼ê¸°ì„±ì´ ì¡´ì¬í•¨</h3>
<ul>
  <li>ê³µê¸‰ëŸ‰ ì¡°ì ˆì´ ì‰½ì§€ ì•Šì€ ë„ë©”ì¸ íŠ¹ì„±ì„ ê³ ë ¤í–ˆì„ ë•Œ, ì „ë ¥ ì‚¬ìš©ëŸ‰ì„ ì˜ˆì¸¡í•˜ì—¬ íš¨ìœ¨ì ì¸ ì—ë„ˆì§€ ê´€ë¦¬ ë°©ì•ˆ ë„ì…ì˜ í•„ìš”ì„±</li>
</ul>

<p><img src="/assets/2022-12-25-when-regression-does-not-work/monthly.webp" alt="" /></p>
<blockquote>
  <p><a href="https://epsis.kpx.or.kr/epsisnew/selectEkgeEpsAepChart.do?menuId=030200">ì›”ë³„ í‰ê·  ìµœëŒ€ì „ë ¥</a></p>
</blockquote>

<h2 id="23-ì—°êµ¬-ë¬¸ì œ-ë°-ì‹¤í—˜-ì •ì˜">2.3. ì—°êµ¬ ë¬¸ì œ ë° ì‹¤í—˜ ì •ì˜</h2>

<blockquote>
  <p>â€œê¸°ìƒ ë°ì´í„°ë¥¼ í†µí•´ <strong>ì „ë ¥ì‚¬ìš©ëŸ‰</strong> ì˜ˆì¸¡ ëª¨ë¸ì„ ì„¤ê³„í•˜ê³ ì í•œë‹¤.â€</p>
</blockquote>

<pre><code class="language-plain">	ì „ë ¥ì‚¬ìš©ëŸ‰ ~ ê¸°ì˜¨  
	ì „ë ¥ì‚¬ìš©ëŸ‰ ~ í’ì†  
	ì „ë ¥ì‚¬ìš©ëŸ‰ ~ ìŠµë„  
	ì „ë ¥ì‚¬ìš©ëŸ‰ ~ ê°•ìˆ˜ëŸ‰  
	ì „ë ¥ì‚¬ìš©ëŸ‰ ~ ì¼ì¡°  
	ì „ë ¥ì‚¬ìš©ëŸ‰ ~ (ê±´ë¬¼ ë‚´) ë¹„ì „ê¸°ëƒ‰ë°©ì„¤ë¹„ìš´ì˜ ì—¬ë¶€  
	ì „ë ¥ì‚¬ìš©ëŸ‰ ~ (ê±´ë¬¼ ë‚´) íƒœì–‘ê´‘ ë³´ìœ  ì—¬ë¶€
</code></pre>

<h1 id="3-ë°ì´í„°-ì†Œê°œì™€-ë³€ìˆ˜-ì •ì˜">3. ë°ì´í„° ì†Œê°œì™€ ë³€ìˆ˜ ì •ì˜</h1>

<h2 id="31-ë°ì´í„°-í†ºì•„ë³´ê¸°">3.1. ë°ì´í„° í†ºì•„ë³´ê¸°</h2>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="n">df</span><span class="p">.</span><span class="n">head</span><span class="p">()</span>
</code></pre></div></div>
<p><img src="/assets/2022-12-25-when-regression-does-not-work/df.head().webp" alt="" /></p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="n">df</span><span class="p">.</span><span class="n">tail</span><span class="p">()</span>
</code></pre></div></div>
<p><img src="/assets/2022-12-25-when-regression-does-not-work/df.tail().webp" alt="" /></p>

<h2 id="32-122400ê°œì˜-ì¸ìŠ¤í„´ìŠ¤ë¡œ-êµ¬ì„±ëœ-ë°ì´í„°">3.2. 122,400ê°œì˜ ì¸ìŠ¤í„´ìŠ¤ë¡œ êµ¬ì„±ëœ ë°ì´í„°</h2>

<ul>
  <li>60ê°œì˜ ê±´ë¬¼ë³„ (<code class="language-plaintext highlighter-rouge">num</code>)ë¡œ êµ¬ì„±</li>
  <li>2020ë…„ 6ì›” 1ì¼ë¶€í„° 2020ë…„ 8ì›” 24ì¼ê¹Œì§€ì˜ ì—”ì§€ë‹ˆì–´ë§ ë°ì´í„°ë¡œ êµ¬ì„±</li>
  <li>ì¸¡ì • ë°ì´í„°ì˜ Unit: 1ì‹œê°„</li>
</ul>

<h2 id="33-ë³€ìˆ˜-ì •ì˜">3.3. ë³€ìˆ˜ ì •ì˜</h2>

<table>
  <thead>
    <tr>
      <th><strong>ë³€ìˆ˜</strong></th>
      <th><strong>ì„¤ëª…</strong></th>
      <th><strong>ë³€ìˆ˜ íƒ€ì…</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">num</code></td>
      <td>ê±´ë¬¼ë²ˆí˜¸ (1&lt;= Integer &lt;= 60)</td>
      <td><code class="language-plaintext highlighter-rouge">x</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">date_time</code></td>
      <td>YYYY-MM-DD HH</td>
      <td><code class="language-plaintext highlighter-rouge">x</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">ì „ë ¥ì‚¬ìš©ëŸ‰(kWh)</code></td>
      <td>ì „ë ¥ì‚¬ìš©ëŸ‰ (í‚¬ë¡œì™€íŠ¸ì‹œ)</td>
      <td><code class="language-plaintext highlighter-rouge">y</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">ê¸°ì˜¨(Â°C)</code></td>
      <td>ì„­ì”¨ ê¸°ì˜¨ (Celsius Degree)</td>
      <td><code class="language-plaintext highlighter-rouge">x</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">í’ì†(m/s)</code></td>
      <td>í’ì† (ì´ˆë‹¹ ë¯¸í„° ì†ë„)</td>
      <td><code class="language-plaintext highlighter-rouge">x</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">ìŠµë„(%)</code></td>
      <td>ìŠµë„</td>
      <td><code class="language-plaintext highlighter-rouge">x</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">ê°•ìˆ˜ëŸ‰(mm)</code></td>
      <td>ê°•ìˆ˜ëŸ‰</td>
      <td><code class="language-plaintext highlighter-rouge">x</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">ì¼ì¡°(hr)</code></td>
      <td>1ì‹œê°„ ì¤‘ ì¼ì¡°ëŸ‰ì´ ì¡´ì¬í•œ ì‹œê°„ (0.0 &lt;= Float &lt;= 1.0)</td>
      <td><code class="language-plaintext highlighter-rouge">x</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">ë¹„ì „ê¸°ëƒ‰ë°©ì„¤ë¹„ìš´ì˜</code></td>
      <td>ìš´ì˜ ì—¬ë¶€ Boolean í‘œí˜„ (0: False, 1: True)</td>
      <td><code class="language-plaintext highlighter-rouge">x</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">íƒœì–‘ê´‘ë³´ìœ </code></td>
      <td>ë³´ìœ  ì—¬ë¶€ Boolean í‘œí˜„ (0: False, 1: True)</td>
      <td><code class="language-plaintext highlighter-rouge">x</code></td>
    </tr>
  </tbody>
</table>

<h1 id="4-data-preprocessing--eda">4. Data Preprocessing &amp; EDA</h1>

<h2 id="41-ë³€ìˆ˜ëª…-renaming">4.1. ë³€ìˆ˜ëª… Renaming</h2>

<table>
  <thead>
    <tr>
      <th>AS-IS</th>
      <th>TO-BE</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">num</code></td>
      <td><code class="language-plaintext highlighter-rouge">building_num</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">date_time</code></td>
      <td><code class="language-plaintext highlighter-rouge">date_time</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">ì „ë ¥ì‚¬ìš©ëŸ‰(kWh)</code></td>
      <td><code class="language-plaintext highlighter-rouge">target</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">ê¸°ì˜¨(Â°C)</code></td>
      <td><code class="language-plaintext highlighter-rouge">temp_celsius</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">í’ì†(m/s)</code></td>
      <td><code class="language-plaintext highlighter-rouge">wind_speed</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">ìŠµë„(%)</code></td>
      <td><code class="language-plaintext highlighter-rouge">humidity</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">ê°•ìˆ˜ëŸ‰(mm)</code></td>
      <td><code class="language-plaintext highlighter-rouge">rain</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">ì¼ì¡°(hr)</code></td>
      <td><code class="language-plaintext highlighter-rouge">sunshine</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">ë¹„ì „ê¸°ëƒ‰ë°©ì„¤ë¹„ìš´ì˜</code></td>
      <td><code class="language-plaintext highlighter-rouge">nature_ac</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">íƒœì–‘ê´‘ë³´ìœ </code></td>
      <td><code class="language-plaintext highlighter-rouge">sunpower</code></td>
    </tr>
  </tbody>
</table>

<blockquote>
  <p>ê³ í†µìŠ¤ëŸ¬ìš´ í•œê¸€ ì¸ì½”ë”© ë¬¸ì œëŠ” ì–¸ì œ ì–´ë””ì—ì„œ í„°ì§ˆì§€ ëª¨ë¥¸ë‹¤.</p>
</blockquote>

<h2 id="42-data-preprocessing">4.2. Data Preprocessing</h2>

<h3 id="1-target-ì „ë ¥ì‚¬ìš©ëŸ‰">(1) <code class="language-plaintext highlighter-rouge">target</code> (ì „ë ¥ì‚¬ìš©ëŸ‰)</h3>

<ul>
  <li><code class="language-plaintext highlighter-rouge">target</code>ì˜ ë¶„í¬: â€œPositive Skewnessâ€ (ì–‘ì˜ ì™œë„, ì˜¤ë¥¸ìª½ ê¼¬ë¦¬ê°€ ê¸¸ë‹¤.)</li>
  <li>Model Fittingì˜ íš¨ê³¼ë¥¼ í–¥ìƒì‹œí‚¤ê¸° ìœ„í•´, ë‹¤ìŒê³¼ ê°™ì´ ë³€í™˜í•˜ì.</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="c1"># Trainí•  ë•Œ  
</span>	<span class="n">target</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">target</span><span class="p">)</span>  
	<span class="c1"># Predictí•  ë•Œ  
</span>	<span class="n">target</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">exp</span><span class="p">(</span><span class="n">target</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
</code></pre></div></div>

<p><strong>[ë³€í™˜ ì „] Distribution of Target Values</strong>
<img src="/assets/2022-12-25-when-regression-does-not-work/ë³€í™˜ ì „- Distribution of Target Values.webp" alt="" /></p>
<blockquote>
  <p>ì´ëŸ¬í•œ ë¶„í¬ëŠ” ìì—°í˜„ìƒê³¼ ì‚¬íšŒí˜„ìƒì—ì„œ í”íˆ ë‚˜íƒ€ë‚˜ëŠ”ë°, Modelì˜ Overfitting ë¬¸ì œì— ë§¤ìš° ì·¨ì•½í•˜ë‹¤.</p>
</blockquote>

<p><strong>[ë³€í™˜ í›„] Distribution of Target Values</strong>
<img src="/assets/2022-12-25-when-regression-does-not-work/ë³€í™˜ í›„- Distribution of Target Values.webp" alt="" /></p>
<blockquote>
  <p>Gotcha! ì–´ëŠ ì •ë„ ì •ê·œì„±ì„ í™•ë³´í–ˆêµ°â€¦</p>
</blockquote>

<h3 id="2-building_num-ê±´ë¬¼ë²ˆí˜¸">(2) <code class="language-plaintext highlighter-rouge">building_num</code> (ê±´ë¬¼ë²ˆí˜¸)</h3>

<ul>
  <li>Integer Type (1 â‰¤ <code class="language-plaintext highlighter-rouge">building_num</code> â‰¤ 60)</li>
  <li>ë„ë©”ì¸ ì§€ì‹ì„ ê³ ë ¤í–ˆì„ ë•Œ, ê±´ë¬¼ ë³„ë¡œ ì „ë ¥ ì„¤ê³„ íŒŒì´í”„ë¼ì¸, ê±´ë¬¼ì˜ ìœ„ì¹˜ ë“±ì— ë”°ë¼ ì „ë ¥ì‚¬ìš©ëŸ‰ì´ êµ­ì§€ì ìœ¼ë¡œ í° ì°¨ì´ê°€ ë°œìƒí•  ê²ƒì´ë‹¤.</li>
</ul>

<p><strong>ê° 60ê°œ building_numë³„ Distribution of Target Values</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="k">if</span> <span class="n">skewness</span> <span class="o">&gt;=</span> <span class="mf">1.5</span><span class="p">:</span>  
	<span class="n">color</span> <span class="o">=</span> <span class="sh">'</span><span class="s">red</span><span class="sh">'</span>  
	<span class="k">elif</span> <span class="n">skewness</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">1.5</span><span class="p">:</span>  
	<span class="n">color</span> <span class="o">=</span> <span class="sh">'</span><span class="s">blue</span><span class="sh">'</span>  
	<span class="k">else</span><span class="p">:</span>  
	<span class="n">color</span> <span class="o">=</span> <span class="sh">'</span><span class="s">grey</span><span class="sh">'</span>
</code></pre></div></div>
<p><img src="/assets/2022-12-25-when-regression-does-not-work/ê° 60ê°œ building_numë³„ Distribution of Target Values.webp" alt="" /></p>

<p><strong>1ë¶€í„° 60ê¹Œì§€ëŠ” Ordinalì´ë¼ê¸°ë³´ë‹¤ëŠ”, Cardinalí•œ Labelì´ë¯€ë¡œ, ëª¨ë¸ì´ ê°’ì˜ ìš°ì—´ì´ ìˆëŠ” ê²ƒìœ¼ë¡œ ì˜¤í•´í•  ìˆ˜ ìˆë‹¤. ê·¸ë˜ì„œ One Hot Encodingì„ í†µí•´ ê° <code class="language-plaintext highlighter-rouge">building_num</code>ì„ dummyí™”í•˜ë„ë¡ í•œë‹¤.</strong></p>

<p><img src="/assets/2022-12-25-when-regression-does-not-work/building_num.webp" alt="" /></p>
<blockquote>
  <p><code class="language-plaintext highlighter-rouge">building_num</code>ì´ ì‚¬ë¼ì§€ê³ , <code class="language-plaintext highlighter-rouge">building_#</code>ì˜ <strong>Scarse Vectors</strong>ë¡œ ëŒ€ì²´ë˜ì—ˆë‹¤.</p>
</blockquote>

<h3 id="3-date_time-yyyy-mm-dd-hh">(3) <code class="language-plaintext highlighter-rouge">date_time</code> (YYYY-MM-DD HH)</h3>

<ul>
  <li>YYYY-MM-DD HH í¬ë§·ì´ String data typeìœ¼ë¡œ ë˜ì–´ ìˆìœ¼ë¯€ë¡œ, ì´ë¥¼ ë³€í™˜í•´ì•¼ í•œë‹¤.</li>
  <li><code class="language-plaintext highlighter-rouge">Year</code>, <code class="language-plaintext highlighter-rouge">Month</code>, <code class="language-plaintext highlighter-rouge">Day</code>, <code class="language-plaintext highlighter-rouge">Hour</code>: ê¸°ìƒ í˜¹ì€ ê¸°í›„ í˜„ìƒê³¼ ìƒê´€ì„±ì´ ìˆëŠ” ì •ë³´</li>
  <li>Day of Week (DoW): <code class="language-plaintext highlighter-rouge">date_time</code>ì—ëŠ” ì§ì ‘ì ìœ¼ë¡œ í‘œê¸°ë˜ì–´ ìˆì§€ ì•Šìœ¼ë‚˜, ì „ë ¥ì‚¬ìš©ëŸ‰ì˜ ì£¼ê¸°ì„±ì„ ì§€ë‹ˆê³  ìˆëŠ” ì •ë³´ì´ë¯€ë¡œ ìƒˆë¡­ê²Œ ìƒì„±í•˜ë„ë¡ í•œë‹¤.</li>
  <li>ë³¸ Datasetì—ì„œëŠ” <code class="language-plaintext highlighter-rouge">Year</code>ê°€ â€˜2020â€™ í•œ ê°€ì§€ë§Œ ì¡´ì¬í•˜ë¯€ë¡œ, <code class="language-plaintext highlighter-rouge">Year</code> ë³€ìˆ˜ëŠ” ì‚­ì œí•˜ë„ë¡ í•œë‹¤.</li>
</ul>

<p><strong>ë³€í™˜ ê²°ê³¼</strong></p>

<p><img src="/assets/2022-12-25-when-regression-does-not-work/date_time.webp" alt="" /></p>
<blockquote>
  <p><code class="language-plaintext highlighter-rouge">date_time</code>ì€ ì‚¬ë¼ì§€ê³ , <code class="language-plaintext highlighter-rouge">month</code>, <code class="language-plaintext highlighter-rouge">day</code>, <code class="language-plaintext highlighter-rouge">hour</code>, <code class="language-plaintext highlighter-rouge">dow</code>ê°€ ìƒì„±ë˜ì—ˆë‹¤.</p>
</blockquote>

<h2 id="43-eda">4.3. EDA</h2>

<h3 id="1-correlation-coefficient-ìƒê´€ê³„ìˆ˜">(1) Correlation Coefficient (ìƒê´€ê³„ìˆ˜)</h3>

<p><strong>Heat Map</strong></p>

<p><img src="/assets/2022-12-25-when-regression-does-not-work/heat-map.webp" alt="" /></p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">humidity</code>(ìŠµë„) ~ <code class="language-plaintext highlighter-rouge">temp_celsius</code>(ì„­ì”¨ì˜¨ë„)
    <ul>
      <li>ìƒê´€ê³„ìˆ˜: <code class="language-plaintext highlighter-rouge">-0.5091</code></li>
      <li>ì•½í•œ ìŒì˜ ìƒê´€ê´€ê³„ë¥¼ ê°€ì§„ë‹¤ê³  ë³´ëŠ” ê²ƒì´ ë§ì•„ë³´ì¸ë‹¤.</li>
    </ul>
  </li>
</ul>

<p><img src="/assets/2022-12-25-when-regression-does-not-work/humidity(ìŠµë„) ~ temp_celsius(ì„­ì”¨ì˜¨ë„).webp" alt="" /></p>
<blockquote>
  <p>humidity(ìŠµë„) ~ temp_celsius(ì„­ì”¨ì˜¨ë„)</p>
</blockquote>

<ul>
  <li><code class="language-plaintext highlighter-rouge">sunshine</code>(ì¼ì¡°) ~ <code class="language-plaintext highlighter-rouge">temp_celsius</code>(ì„­ì”¨ì˜¨ë„)
    <ul>
      <li>ìƒê´€ê³„ìˆ˜: <code class="language-plaintext highlighter-rouge">+0.5157</code></li>
      <li>ì•½í•œ ì–‘ì˜ ìƒê´€ê´€ê³„ë¥¼ ê°€ì§„ë‹¤ê³  ë³´ëŠ” ê²ƒì´ ë§ì•„ë³´ì¸ë‹¤.</li>
      <li>í•˜ë‚˜ëŠ” categorical, ë‹¤ë¥¸ í•˜ë‚˜ëŠ” numeric ì´ë¯€ë¡œ ë‘˜ ì¤‘ í•˜ë‚˜ë¥¼ dropí•  ìˆ˜ ì—†ë‹¤.</li>
    </ul>
  </li>
</ul>

<p><img src="/assets/2022-12-25-when-regression-does-not-work/sunshine(ì¼ì¡°) ~ temp_celsius(ì„­ì”¨ì˜¨ë„).webp" alt="" /></p>
<blockquote>
  <p>sunshine(ì¼ì¡°) ~ temp_celsius(ì„­ì”¨ì˜¨ë„)</p>
</blockquote>

<ul>
  <li><code class="language-plaintext highlighter-rouge">sunshine</code>(ì¼ì¡°) ~ <code class="language-plaintext highlighter-rouge">humidity</code>(ìŠµë„)
    <ul>
      <li>ìƒê´€ê³„ìˆ˜: <code class="language-plaintext highlighter-rouge">-0.6276</code></li>
      <li>ì•½í•œ ìŒì˜ ìƒê´€ê´€ê³„ë¥¼ ê°€ì§„ë‹¤ê³  ë³´ëŠ” ê²ƒì´ ë§ì•„ë³´ì¸ë‹¤.</li>
      <li>í•˜ë‚˜ëŠ” categorical, ë‹¤ë¥¸ í•˜ë‚˜ëŠ” numeric ì´ë¯€ë¡œ ë‘˜ ì¤‘ í•˜ë‚˜ë¥¼ dropí•  ìˆ˜ ì—†ë‹¤.</li>
    </ul>
  </li>
</ul>

<p><img src="/assets/2022-12-25-when-regression-does-not-work/sunshine(ì¼ì¡°) ~ humidity(ìŠµë„).webp" alt="" /></p>
<blockquote>
  <p>sunshine(ì¼ì¡°) ~ humidity(ìŠµë„)</p>
</blockquote>

<h3 id="2-pairplot">(2) Pairplot</h3>

<p><strong><code class="language-plaintext highlighter-rouge">building_{##}</code> ë³€ìˆ˜ë“¤ì„ ì œì™¸í•œ ì±„ visualize pairplot</strong></p>

<p><img src="/assets/2022-12-25-when-regression-does-not-work/pairplot.webp" alt="" /></p>
<blockquote>
  <p>íŠ¹ì • í•˜ë‚˜ì˜ ë…ë¦½ë³€ìˆ˜ê°€ Targetì— ì ˆëŒ€ì ì¸ ìƒê´€ê´€ê³„ë¥¼ ê°€ì§€ëŠ” ê²ƒì´ ê´€ì¸¡ë˜ì§€ ì•ŠëŠ”ë‹¤.</p>
</blockquote>

<h3 id="3-ê°-ë…ë¦½ë³€ìˆ˜ë“¤ì˜-distribution-of-values">(3) ê° ë…ë¦½ë³€ìˆ˜ë“¤ì˜ Distribution of Values</h3>

<p><strong><code class="language-plaintext highlighter-rouge">temp_celsius</code> (ì„­ì”¨ì˜¨ë„)</strong></p>
<ul>
  <li>ë¹„ì„ í˜• ë³€í™˜ ë¶ˆí•„ìš”</li>
</ul>

<p><img src="/assets/2022-12-25-when-regression-does-not-work/temp_celsius (ì„­ì”¨ì˜¨ë„).webp" alt="" /></p>
<blockquote>
  <p>AS-IS</p>
</blockquote>

<p><strong><code class="language-plaintext highlighter-rouge">wind_speed</code> (í’ì†)</strong></p>
<ul>
  <li>log ë³€í™˜ í•„ìš”</li>
</ul>

<p><img src="/assets/2022-12-25-when-regression-does-not-work/wind_speed (í’ì†)-before-log.webp" alt="" /></p>
<blockquote>
  <p>AS-IS</p>
</blockquote>

<p><img src="/assets/2022-12-25-when-regression-does-not-work/wind_speed (í’ì†)-after-log.webp" alt="" /></p>
<blockquote>
  <p>TO-BE</p>
</blockquote>

<p><strong><code class="language-plaintext highlighter-rouge">humidity</code> (ìŠµë„)</strong></p>
<ul>
  <li>square root ë³€í™˜ í•„ìš”</li>
</ul>

<p><img src="/assets/2022-12-25-when-regression-does-not-work/humidity (ìŠµë„)-before-sqr.webp" alt="" /></p>
<blockquote>
  <p>AS-IS</p>
</blockquote>

<p><img src="/assets/2022-12-25-when-regression-does-not-work/humidity (ìŠµë„)-after-sqr.webp" alt="" /></p>
<blockquote>
  <p>TO-BE</p>
</blockquote>

<p><strong><code class="language-plaintext highlighter-rouge">rain</code> (ê°•ìˆ˜ëŸ‰)</strong></p>
<ul>
  <li>log ë³€í™˜ í•„ìš”</li>
</ul>

<p><img src="/assets/2022-12-25-when-regression-does-not-work/rain (ê°•ìˆ˜ëŸ‰)-before-log.webp" alt="" /></p>
<blockquote>
  <p>AS-IS</p>
</blockquote>

<p><img src="/assets/2022-12-25-when-regression-does-not-work/rain (ê°•ìˆ˜ëŸ‰)-after-log.webp" alt="" /></p>
<blockquote>
  <p>TO-BE</p>
</blockquote>

<h3 id="4-ë‹¤ì¤‘ê³µì„ ì„±multi-collinearity-í™•ì¸">(4) ë‹¤ì¤‘ê³µì„ ì„±(Multi-collinearity) í™•ì¸</h3>

<p><strong>VIF â‰¥ 10 ì— í•´ë‹¹í•˜ëŠ” ë…ë¦½ë³€ìˆ˜ëŠ” í•™ìŠµì‹œ ì œì™¸í•˜ë„ë¡ í•œë‹¤.</strong></p>

<ul>
  <li><strong>â€œVariance Inflation Factors (ë¶„ì‚°íŒ½ì°½ìš”ì¸)â€ë€?</strong>
    <blockquote>
      <p>íŠ¹ì • ë³€ìˆ˜ì™€ ì´ë¯¸ ë†’ì€ ìƒê´€ê´€ê³„ë¥¼ ê°€ì§ìœ¼ë¡œì¨, ëª¨ë¸ì˜ Overfittingì— ì˜í–¥ì„ ë¼ì¹  ìˆ˜ ìˆëŠ”ì§€ë¥¼ ì¸¡ì •í•˜ëŠ” ì§€í‘œ
ì¼ë°˜ì ìœ¼ë¡œ VIF &gt;= 5ì¸ ê²½ìš°ëŠ” warning ì‹ í˜¸, VIF &gt;=10ì¸ ê²½ìš°ëŠ” ì‚­ì œ í•„ìš” ì‹ í˜¸</p>
    </blockquote>
  </li>
</ul>

<p><img src="/assets/2022-12-25-when-regression-does-not-work/vif.webp" alt="" /></p>
<blockquote>
  <p><code class="language-plaintext highlighter-rouge">nature_ac</code>, <code class="language-plaintext highlighter-rouge">sunpower</code>ëŠ” ê° <code class="language-plaintext highlighter-rouge">building_##</code>ì˜ ë³€ìˆ˜ì™€ ë§¤ìš° ë†’ì€ ìƒê´€ê´€ê³„ë¥¼ ê°€ì§€ê¸° ë•Œë¬¸ì— <strong>VIF = Infinite</strong>ì¸ ê²°ê³¼ë¥¼ í™•ì¸í•  ìˆ˜ ìˆì—ˆë‹¤.</p>
</blockquote>

<h3 id="5-outliers-handling">(5) Outliers Handling</h3>

<blockquote>
  <p>â€œí‰ê· ê°’ìœ¼ë¡œë¶€í„° <strong>3 Sigma</strong> ì´ìƒ í¸ì°¨ê°€ ë°œìƒí•˜ëŠ” ì¸ìŠ¤í„´ìŠ¤ë¥¼ ëª¨ë‘ ì‚­ì œí•˜ë„ë¡ í•œë‹¤.â€</p>
</blockquote>

<p><strong>Box Plot of <code class="language-plaintext highlighter-rouge">temp_celsius</code></strong>
<img src="/assets/2022-12-25-when-regression-does-not-work/Box Plot of temp_celsius.webp" alt="" /></p>
<blockquote>
  <p>Box Plot of <code class="language-plaintext highlighter-rouge">temp_celsius</code></p>
</blockquote>

<p><strong>Box Plot of <code class="language-plaintext highlighter-rouge">wind_speed</code></strong>
<img src="/assets/2022-12-25-when-regression-does-not-work/Box Plot of wind_speed.webp" alt="" /></p>
<blockquote>
  <p>Box Plot of <code class="language-plaintext highlighter-rouge">wind_speed</code></p>
</blockquote>

<p><strong>Box Plot of <code class="language-plaintext highlighter-rouge">humidity</code></strong>
<img src="/assets/2022-12-25-when-regression-does-not-work/Box Plot of humidity.webp" alt="" /></p>
<blockquote>
  <p>Box Plot of <code class="language-plaintext highlighter-rouge">humidity</code></p>
</blockquote>

<p><strong>Box Plot of <code class="language-plaintext highlighter-rouge">rain</code></strong>
<img src="/assets/2022-12-25-when-regression-does-not-work/Box Plot of rain.webp" alt="" /></p>
<blockquote>
  <p>Box Plot of <code class="language-plaintext highlighter-rouge">rain</code></p>
</blockquote>

<p><strong>Box Plot of <code class="language-plaintext highlighter-rouge">sunshine</code></strong>
<img src="/assets/2022-12-25-when-regression-does-not-work/Box Plot of sunshine.webp" alt="" /></p>
<blockquote>
  <p>Box Plot of <code class="language-plaintext highlighter-rouge">sunshine</code></p>
</blockquote>

<p><strong>Box Plot of <code class="language-plaintext highlighter-rouge">month</code>, <code class="language-plaintext highlighter-rouge">day</code>, <code class="language-plaintext highlighter-rouge">hour</code>, and <code class="language-plaintext highlighter-rouge">dow</code></strong></p>
<ul>
  <li>date_time í˜•ì‹ìœ¼ë¡œ ì´ë¯¸ outliers ì—†ì´ ê³¨ê³ ë£¨ ë¶„í¬ë˜ì–´ ìˆìœ¼ë¯€ë¡œ, Outliers Handling ë¶ˆí•„ìš”</li>
</ul>

<p><strong>â€œStandardScaler ëª¨ë“ˆì„ ì‚¬ìš©í•˜ì—¬ ëª¨ë“  ë…ë¦½ë³€ìˆ˜ë“¤ì„ ì •ê·œí™”í•œë‹¤.â€</strong>
<img src="/assets/2022-12-25-when-regression-does-not-work/Box Plot of month, day, hour, and dow.webp" alt="" /></p>
<blockquote>
  <p><code class="language-plaintext highlighter-rouge">mean = 0</code>, <code class="language-plaintext highlighter-rouge">std = 1</code>ì˜ <strong>í‘œì¤€ì •ê·œë¶„í¬</strong>ë¡œ ë³€í™˜</p>
</blockquote>

<ul>
  <li>â€œ<code class="language-plaintext highlighter-rouge">-3 â‰¤ Scaled Value â‰¤ +3</code>ì´ ì•„ë‹Œ Featureê°€ 1ê°œë¼ë„ ì¡´ì¬í•˜ëŠ” ì¸ìŠ¤í„´ìŠ¤ì˜ ê°œìˆ˜â€
    <ul>
      <li>5,589ê°œ (ì•½ <code class="language-plaintext highlighter-rouge">4.57%</code>)</li>
      <li>ì´ ì •ë„ì˜ ë°ì´í„° ì†ì‹¤ì´ë¼ë©´, ì˜¤íˆë ¤ ì œê±°ë¥¼ í•˜ëŠ” ê²ƒì´ Trainingì— ìœ ìµí•œ ê²°ê³¼ë¥¼ ë‚³ì„ ê²ƒì´ë‹¤.</li>
    </ul>
  </li>
</ul>

<p><strong>Pair Plot (After Removing All the Outliers)</strong>
<img src="/assets/2022-12-25-when-regression-does-not-work/Pair Plot (After Removing All the Outliers).webp" alt="" /></p>
<blockquote>
  <p>ë°ì´í„°ì˜ êµ­ì§€ì ì¸ ê²½í–¥ì„±ì´ ìƒë‹¹ ë¶€ë¶„ ì œê±°ê°€ ë˜ì—ˆë‹¤.</p>
</blockquote>

<h1 id="5-modeling">5. Modeling</h1>

<h2 id="51-simple-linear-regression-v1">5.1. Simple Linear Regression (v1)</h2>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="n">lr</span> <span class="o">=</span> <span class="nc">LinearRegression</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>  
	<span class="n">lr</span><span class="p">.</span><span class="nf">fit</span><span class="p">(</span><span class="n">data_input</span><span class="p">,</span> <span class="n">data_target</span><span class="p">)</span>  
	<span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">R-squared:</span><span class="sh">'</span><span class="p">,</span> <span class="n">lr</span><span class="p">.</span><span class="nf">score</span><span class="p">(</span><span class="n">data_input</span><span class="p">,</span> <span class="n">data_target</span><span class="p">).</span><span class="nf">round</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
</code></pre></div></div>

<h3 id="1-target-ì”ì°¨-ë¶„ì„">(1) Target ì”ì°¨ ë¶„ì„</h3>
<p><img src="/assets/2022-12-25-when-regression-does-not-work/Simple Linear Regression (v1)-Target ì”ì°¨ë¶„ì„.webp" alt="" /></p>
<blockquote>
  <p>[Residuals Plot] ì”ì°¨ê°€ íŠ¹ì • íŒ¨í„´ ì—†ì´ ì •ê·œì„±ì„ ì˜ ë”°ë¥´ê³  ìˆëŠ” ê²ƒ ê°™ì€ë°?</p>
</blockquote>

<h3 id="2-ê°-ë…ë¦½ë³€ìˆ˜-ì”ì°¨ë¶„ì„">(2) ê° ë…ë¦½ë³€ìˆ˜ ì”ì°¨ë¶„ì„</h3>

<blockquote>
  <p>ì˜¤ì°¨í•­ì˜ ì´ë¶„ì‚°ì„±(heteroscedasticity) ì—†ì´, <strong>ì”ì°¨ê°€ ì •ê·œë¶„í¬ë¥¼ ê°€ì¥ ì˜ ë”°ë¥´ê³  ìˆë‹¤.</strong>
ë”°ë¼ì„œ Polynomial or Logarithmì„ ì¦‰ê° ì ìš©í•´ì•¼ í•œë‹¤ê¸°ë³´ë‹¤, Regression Model ìì²´ì˜ ì„±ëŠ¥ì´ ì•ˆ ì¢‹ë‹¤ëŠ” ê²ƒì„ ì˜ë¯¸í•œë‹¤.</p>
</blockquote>

<p><img src="/assets/2022-12-25-when-regression-does-not-work/Simple Linear Regression (v1)-ê° ë…ë¦½ë³€ìˆ˜ ì”ì°¨ë¶„ì„.webp" alt="" /></p>
<blockquote>
  <p>[Residuals Plot] ì”ì°¨ê°€ íŠ¹ì • íŒ¨í„´ ì—†ì´ ì •ê·œì„±ì„ ì˜ ë”°ë¥´ê³  ìˆëŠ” ê²ƒ ê°™ì€ë°?</p>
</blockquote>

<p><img src="/assets/2022-12-25-when-regression-does-not-work/Simple Linear Regression (v1)-qq plot.webp" alt="" /></p>
<blockquote>
  <p>[QQ Plot] ì”ì°¨ì˜ ë¶„í¬ê°€ ì •ê·œë¶„í¬ì— ê°€ì¥ ê°€ê¹ë„¤?</p>
</blockquote>

<h3 id="3-model-summary">(3) Model Summary</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="n">model</span> <span class="o">=</span> <span class="n">smf</span><span class="p">.</span><span class="nf">ols</span><span class="p">(</span>  
	<span class="sh">'</span><span class="s">target</span><span class="sh">'</span> <span class="o">+</span> <span class="sh">'</span><span class="s"> ~ </span><span class="sh">'</span> <span class="o">+</span> <span class="sh">'</span><span class="s"> + </span><span class="sh">'</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">data_input</span><span class="p">.</span><span class="n">columns</span><span class="p">),</span>  
	<span class="n">data</span> <span class="o">=</span> <span class="n">data_df</span>  
	<span class="p">).</span><span class="nf">fit</span><span class="p">()</span>
</code></pre></div></div>
<blockquote>
  <p><strong>F-testì˜ <code class="language-plaintext highlighter-rouge">p-value â‰¤ 0.05</code></strong>: ì ì–´ë„ í•˜ë‚˜ì˜ ë…ë¦½ë³€ìˆ˜ê°€ ì¢…ì†ë³€ìˆ˜ì™€ ìƒê´€ê´€ê³„ê°€ ìˆë‹¤ëŠ” ì•„ì£¼ ê°•í•œ ê·¼ê±°ê°€ ìˆë‹¤.<br />
<strong>R-squared</strong>: ì§€ë‚˜ì¹˜ê²Œ ë‚®ì•„ì„œ ë³¸ ëª¨ë¸ì˜ ì„¤ëª…ë ¥ì´ <code class="language-plaintext highlighter-rouge">7.80%</code> ë°–ì— ì—†ë‹¤.</p>
</blockquote>

<h3 id="4-modelì˜-train-result--ìœ ì˜ì„±-ì§€í‘œ">(4) Modelì˜ Train Result &amp; ìœ ì˜ì„± ì§€í‘œ</h3>

<p><img src="/assets/2022-12-25-when-regression-does-not-work/Simple Linear Regression (v1)-result1.webp" alt="" /></p>

<blockquote>
  <p><code class="language-plaintext highlighter-rouge">day</code> ë³€ìˆ˜ <strong>T-testì˜ <code class="language-plaintext highlighter-rouge">p-value â‰¥ 0.05</code></strong>: ì œê±°í•˜ì—¬ Refit Model í•„ìš”ì„±ì´ ìˆë‹¤.</p>
</blockquote>

<h3 id="5-ë…ë¦½ë³€ìˆ˜ë³„-train-result--ìœ ì˜ì„±-ì§€í‘œ">(5) ë…ë¦½ë³€ìˆ˜ë³„ Train Result &amp; ìœ ì˜ì„± ì§€í‘œ</h3>

<p><img src="/assets/2022-12-25-when-regression-does-not-work/Simple Linear Regression (v1)-result2.webp" alt="" /></p>

<h2 id="52-simple-linear-regression-v2--day-ë³€ìˆ˜-ì œì™¸">5.2. Simple Linear Regression (v2) â€” â€œdayâ€ ë³€ìˆ˜ ì œì™¸</h2>

<h3 id="1-model-summary">(1) Model Summary</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="n">model</span> <span class="o">=</span> <span class="n">smf</span><span class="p">.</span><span class="nf">ols</span><span class="p">(</span>  
	    <span class="sh">'</span><span class="s">target</span><span class="sh">'</span> <span class="o">+</span> <span class="sh">'</span><span class="s"> ~ </span><span class="sh">'</span> <span class="o">+</span> <span class="sh">'</span><span class="s"> + </span><span class="sh">'</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">data_input</span><span class="p">.</span><span class="n">columns</span><span class="p">.</span><span class="nf">drop</span><span class="p">([</span><span class="sh">'</span><span class="s">day</span><span class="sh">'</span><span class="p">])),</span>  
	    <span class="n">data</span> <span class="o">=</span> <span class="n">data_df</span>  
	<span class="p">).</span><span class="nf">fit</span><span class="p">()</span>
</code></pre></div></div>
<blockquote>
  <p><strong>F-testì˜ <code class="language-plaintext highlighter-rouge">p-value â‰¤ 0.05</code></strong>: ì ì–´ë„ í•˜ë‚˜ì˜ ë…ë¦½ë³€ìˆ˜ê°€ ì¢…ì†ë³€ìˆ˜ì™€ ìƒê´€ê´€ê³„ê°€ ìˆë‹¤ëŠ” ì•„ì£¼ ê°•í•œ ê·¼ê±°ê°€ ìˆë‹¤.<br />
<strong>R-squared</strong>: ì§€ë‚˜ì¹˜ê²Œ ë‚®ì•„ì„œ ë³¸ ëª¨ë¸ì˜ ì„¤ëª…ë ¥ì´ <code class="language-plaintext highlighter-rouge">7.80%</code> ë°–ì— ì—†ë‹¤.</p>
</blockquote>

<h3 id="2-modelì˜-train-result--ìœ ì˜ì„±-ì§€í‘œ">(2) Modelì˜ Train Result &amp; ìœ ì˜ì„± ì§€í‘œ</h3>

<p><img src="/assets/2022-12-25-when-regression-does-not-work/Simple Linear Regression (v2)-result1.webp" alt="" /></p>
<blockquote>
  <p>ëª¨ë“  ë³€ìˆ˜ê°€ T-testë¥¼ í†µê³¼í•œë‹¤. (<strong>Confidence Level = <code class="language-plaintext highlighter-rouge">95%</code></strong>)</p>
</blockquote>

<h3 id="3-ë…ë¦½ë³€ìˆ˜ë³„-train-result--ìœ ì˜ì„±-ì§€í‘œ">(3) ë…ë¦½ë³€ìˆ˜ë³„ Train Result &amp; ìœ ì˜ì„± ì§€í‘œ</h3>

<p><img src="/assets/2022-12-25-when-regression-does-not-work/Simple Linear Regression (v2)-result2.webp" alt="" /></p>
<blockquote>
  <p><code class="language-plaintext highlighter-rouge">day</code> ë³€ìˆ˜ë¥¼ ì œì™¸í–ˆìŒì—ë„ ë¶ˆêµ¬í•˜ê³ , ëª¨ë¸ì˜ ì„¤ëª…ë ¥ì´ ì „í˜€ ê°œì„ ë˜ì§€ ì•ŠëŠ”ë‹¤.
ë”°ë¼ì„œ, ë³¸ Datasetì—ì„œëŠ” <strong>Simple Linear Regressionì˜ Training Capacity ìì²´ê°€ ë§¤ìš° ë‚®ì€ ì˜ë¯¸</strong>ë¡œ ì´í•´ëœë‹¤.</p>
</blockquote>

<h2 id="53-polynomial-regression-v1--degree2">5.3. Polynomial Regression (v1) â€” â€œdegree=2â€</h2>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="n">poly</span> <span class="o">=</span> <span class="nc">PolynomialFeatures</span><span class="p">(</span><span class="n">degree</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>  
	<span class="n">poly</span><span class="p">.</span><span class="nf">fit</span><span class="p">(</span><span class="n">data_input</span><span class="p">)</span>  
	<span class="n">data_input_poly</span> <span class="o">=</span> <span class="n">poly</span><span class="p">.</span><span class="nf">transform</span><span class="p">(</span><span class="n">data_input</span><span class="p">)</span>  
	  
	<span class="n">lr</span> <span class="o">=</span> <span class="nc">LinearRegression</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>  
	<span class="n">lr</span><span class="p">.</span><span class="nf">fit</span><span class="p">(</span><span class="n">data_input_poly</span><span class="p">,</span> <span class="n">data_target</span><span class="p">)</span>  
	<span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">R-squared:</span><span class="sh">'</span><span class="p">,</span> <span class="n">lr</span><span class="p">.</span><span class="nf">score</span><span class="p">(</span><span class="n">data_input_poly</span><span class="p">,</span> <span class="n">data_target</span><span class="p">).</span><span class="nf">round</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>  
	<span class="c1"># &gt; R-squared: 0.1127
</span></code></pre></div></div>

<h3 id="1-ì”ì°¨ë¶„ì„">(1) ì”ì°¨ë¶„ì„</h3>

<p><img src="/assets/2022-12-25-when-regression-does-not-work/Polynomial Regression (v1)-ì”ì°¨ë¶„ì„.webp" alt="" /></p>
<blockquote>
  <p>Polynomial Regression (v1) â€” â€œdegree=2â€</p>
</blockquote>

<h2 id="54-polynomial-regression-v2--degree3">5.4. Polynomial Regression (v2) â€” â€œdegree=3â€</h2>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="n">poly</span> <span class="o">=</span> <span class="nc">PolynomialFeatures</span><span class="p">(</span><span class="n">degree</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>  
	<span class="n">poly</span><span class="p">.</span><span class="nf">fit</span><span class="p">(</span><span class="n">data_input</span><span class="p">)</span>  
	<span class="n">data_input_poly</span> <span class="o">=</span> <span class="n">poly</span><span class="p">.</span><span class="nf">transform</span><span class="p">(</span><span class="n">data_input</span><span class="p">)</span>  
	  
	<span class="n">lr</span> <span class="o">=</span> <span class="nc">LinearRegression</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>  
	<span class="n">lr</span><span class="p">.</span><span class="nf">fit</span><span class="p">(</span><span class="n">data_input_poly</span><span class="p">,</span> <span class="n">data_target</span><span class="p">)</span>  
	<span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">R-squared:</span><span class="sh">'</span><span class="p">,</span> <span class="n">lr</span><span class="p">.</span><span class="nf">score</span><span class="p">(</span><span class="n">data_input_poly</span><span class="p">,</span> <span class="n">data_target</span><span class="p">).</span><span class="nf">round</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>  
	<span class="c1"># &gt; R-squared: 0.1362
</span></code></pre></div></div>

<h3 id="1-ì”ì°¨ë¶„ì„-1">(1) ì”ì°¨ë¶„ì„</h3>

<p><img src="/assets/2022-12-25-when-regression-does-not-work/Polynomial Regression (v2)-ì”ì°¨ë¶„ì„.webp" alt="" /></p>
<blockquote>
  <p>Polynomial Regression (v2) â€” â€œdegree=3â€</p>
</blockquote>

<h2 id="55-polynomial-regression-v3--degree4">5.5. Polynomial Regression (v3) â€” â€œdegree=4â€</h2>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="n">poly</span> <span class="o">=</span> <span class="nc">PolynomialFeatures</span><span class="p">(</span><span class="n">degree</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>  
	<span class="n">poly</span><span class="p">.</span><span class="nf">fit</span><span class="p">(</span><span class="n">data_input</span><span class="p">)</span>  
	<span class="n">data_input_poly</span> <span class="o">=</span> <span class="n">poly</span><span class="p">.</span><span class="nf">transform</span><span class="p">(</span><span class="n">data_input</span><span class="p">)</span>  
	  
	<span class="n">lr</span> <span class="o">=</span> <span class="nc">LinearRegression</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>  
	<span class="n">lr</span><span class="p">.</span><span class="nf">fit</span><span class="p">(</span><span class="n">data_input_poly</span><span class="p">,</span> <span class="n">data_target</span><span class="p">)</span>  
	<span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">R-squared:</span><span class="sh">'</span><span class="p">,</span> <span class="n">lr</span><span class="p">.</span><span class="nf">score</span><span class="p">(</span><span class="n">data_input_poly</span><span class="p">,</span> <span class="n">data_target</span><span class="p">).</span><span class="nf">round</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>  
	<span class="c1"># &gt; R-squared: 0.1597
</span></code></pre></div></div>

<h3 id="1-ì”ì°¨ë¶„ì„-2">(1) ì”ì°¨ë¶„ì„</h3>

<p><img src="/assets/2022-12-25-when-regression-does-not-work/Polynomial Regression (v3)-ì”ì°¨ë¶„ì„.webp" alt="" /></p>
<blockquote>
  <p>Polynomial Regression (v3) â€” â€œdegree=4â€</p>
</blockquote>

<h2 id="56-polynomial-regression-v4--degree5">5.6. Polynomial Regression (v4) â€” â€œdegree=5â€</h2>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="n">poly</span> <span class="o">=</span> <span class="nc">PolynomialFeatures</span><span class="p">(</span><span class="n">degree</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>  
	<span class="n">poly</span><span class="p">.</span><span class="nf">fit</span><span class="p">(</span><span class="n">data_input</span><span class="p">)</span>  
	<span class="n">data_input_poly</span> <span class="o">=</span> <span class="n">poly</span><span class="p">.</span><span class="nf">transform</span><span class="p">(</span><span class="n">data_input</span><span class="p">)</span>  
	  
	<span class="n">lr</span> <span class="o">=</span> <span class="nc">LinearRegression</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>  
	<span class="n">lr</span><span class="p">.</span><span class="nf">fit</span><span class="p">(</span><span class="n">data_input_poly</span><span class="p">,</span> <span class="n">data_target</span><span class="p">)</span>  
	<span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">R-squared:</span><span class="sh">'</span><span class="p">,</span> <span class="n">lr</span><span class="p">.</span><span class="nf">score</span><span class="p">(</span><span class="n">data_input_poly</span><span class="p">,</span> <span class="n">data_target</span><span class="p">).</span><span class="nf">round</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>  
	<span class="c1"># &gt; R-squared: 0.1806
</span></code></pre></div></div>

<h3 id="1-ì”ì°¨ë¶„ì„-3">(1) ì”ì°¨ë¶„ì„</h3>

<p><img src="/assets/2022-12-25-when-regression-does-not-work/Polynomial Regression (v4)-ì”ì°¨ë¶„ì„.webp" alt="" /></p>
<blockquote>
  <p>Polynomial Regression (v4) â€” â€œdegree=5â€</p>
</blockquote>

<h1 id="6-conclusion">6. Conclusion</h1>

<h2 id="61-regression-model-ì™¸ì˜-ëª¨ë¸ì´-í•„ìš”í•˜ë‹¤">6.1. Regression Model ì™¸ì˜ ëª¨ë¸ì´ í•„ìš”í•˜ë‹¤!</h2>

<h3 id="1-modeling-results">(1) Modeling Results</h3>

<table>
  <thead>
    <tr>
      <th><strong>íšŒê·€ ëª¨ë¸</strong></th>
      <th><strong>íŠ¹ì´ì‚¬í•­</strong></th>
      <th><strong>R-squared</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Simple Linear Regression</td>
      <td>ëª¨ë“  ë…ë¦½ë³€ìˆ˜ í¬í•¨</td>
      <td><code class="language-plaintext highlighter-rouge">0.0780</code></td>
    </tr>
    <tr>
      <td>Simple Linear Regression</td>
      <td><code class="language-plaintext highlighter-rouge">day</code> ë…ë¦½ë³€ìˆ˜ ì œì™¸</td>
      <td><code class="language-plaintext highlighter-rouge">0.0780</code></td>
    </tr>
    <tr>
      <td>Polynomial Regression</td>
      <td>Up to 2nd Degree</td>
      <td><code class="language-plaintext highlighter-rouge">0.1127</code></td>
    </tr>
    <tr>
      <td>Polynomial Regression</td>
      <td>Up to 3rd Degree</td>
      <td><code class="language-plaintext highlighter-rouge">0.1362</code></td>
    </tr>
    <tr>
      <td>Polynomial Regression</td>
      <td>Up to 4th Degree</td>
      <td><code class="language-plaintext highlighter-rouge">0.1597</code></td>
    </tr>
    <tr>
      <td>Polynomial Regression</td>
      <td>Up to 5th Degree</td>
      <td><code class="language-plaintext highlighter-rouge">0.1806</code></td>
    </tr>
  </tbody>
</table>

<blockquote>
  <p>ì•„ë¬´ë¦¬ Capacityë¥¼ ë†’ì—¬ë„ ëª¨ë¸ì˜ ì„¤ëª…ë ¥ì´ ê·¹ì ìœ¼ë¡œ ê°œì„ ë˜ì§€ ì•Šì•˜ë‹¤!</p>
</blockquote>

<h3 id="2-model-capacity">(2) Model Capacity</h3>

<ul>
  <li><strong>Model Capacityë€?</strong>
    <blockquote>
      <p><strong>ëª¨ë¸ ìš©ëŸ‰</strong>: ë‹¤ì–‘í•œ ì°¨ì›ì˜ ê´€ê³„ì„±ì„ í•™ìŠµí•  ìˆ˜ ìˆëŠ” ëŠ¥ë ¥ (The ability to fit a variety of functions)
ğŸŒ ê°„ë‹¨íˆ, ëª¨ë¸ì˜ í•™ìŠµ ê°€ëŠ¥ ì°¨ìˆ˜(ì°¨ì›)ë¡œ ë¶ˆë¦¬ê¸°ë„ í•¨</p>
    </blockquote>
  </li>
  <li><strong>Models with Low Capacity</strong>: í•™ìŠµ ìì²´ê°€ ì–´ë ¤ì›Œì§„ë‹¤. (<code class="language-plaintext highlighter-rouge">Underfitting</code> ë¬¸ì œ)</li>
  <li>
    <p><strong>Models with High Capacity</strong>: Memory Effectì˜ ë¶€ì •ì  íš¨ê³¼ê°€ ë°œìƒí•œë‹¤. (<code class="language-plaintext highlighter-rouge">Overfitting</code> ë¬¸ì œ)</p>
  </li>
  <li><strong>Tree</strong>, <strong>Ensemble</strong>, <strong>Time-series</strong> ê³„ì—´ì˜ ML ëª¨ë¸ë“¤ì„ í†µí•´ ì ‘ê·¼í•˜ëŠ” ê²ƒì´ ì ì ˆí•´ ë³´ì¸ë‹¤.</li>
</ul>

<p><img src="/assets/2022-12-25-when-regression-does-not-work/dacon.webp" alt="" /></p>
<blockquote>
  <p><a href="https://dacon.io/competitions/official/235736/data">ì‚¬ì‹¤ ì´ Datasetì€ Daconì—ì„œ ê°€ì ¸ì™”ëŠ”ë°, Regression Modelë¡œ ì ‘ê·¼í•˜ëŠ” ì‚¬ëŒë“¤ì€ ë‹¨ í•œ ëª…ë„ ì—†ì—ˆë‹¤.</a></p>
</blockquote>

<h2 id="62-regression-modelì´-í•´ë‹¹-dataset-í•™ìŠµì—-ì ì ˆí•œ-ëª¨ë¸ì´-ì•„ë‹˜ì„-íŒŒì•…í•˜ëŠ”-ë°©ë²•ì€">6.2. Regression Modelì´ í•´ë‹¹ Dataset í•™ìŠµì— ì ì ˆí•œ ëª¨ë¸ì´ ì•„ë‹˜ì„ íŒŒì•…í•˜ëŠ” ë°©ë²•ì€?</h2>

<h3 id="1-simple-linear-regressionì˜-ì”ì°¨ê°€-ì´ë¶„ì‚°ì„±-ì—†ì´-ì •ê·œì„±ì„-ë§¤ìš°-ì˜-ë”°ë¥´ëŠ”ë°ë„-r-squared-ê°’ì´-ë§¤ìš°-ì €ì¡°í•˜ë‹¤">(1) Simple Linear Regressionì˜ ì”ì°¨ê°€ ì´ë¶„ì‚°ì„± ì—†ì´ ì •ê·œì„±ì„ ë§¤ìš° ì˜ ë”°ë¥´ëŠ”ë°ë„, <code class="language-plaintext highlighter-rouge">R-squared</code> ê°’ì´ ë§¤ìš° ì €ì¡°í•˜ë‹¤.</h3>

<p><strong>Simple Linear Regression: Target ì”ì°¨ ë¶„ì„</strong>
<img src="/assets/2022-12-25-when-regression-does-not-work/Simple Linear Regression (v1)-Target ì”ì°¨ë¶„ì„.webp" alt="" /></p>

<p><strong>Simple Linear Regression: Target QQ Plot</strong>
<img src="/assets/2022-12-25-when-regression-does-not-work/Simple Linear Regression (v1)-qq plot.webp" alt="" /></p>

<h3 id="2-polynomial-regressionì˜-degreeë¥¼-ë†’ì—¬ë„-ì”ì°¨-ìì²´ê°€-ê°œì„ ë˜ì§€-ì•ŠëŠ”ë‹¤">(2) Polynomial Regressionì˜ <code class="language-plaintext highlighter-rouge">Degree</code>ë¥¼ ë†’ì—¬ë„ ì”ì°¨ ìì²´ê°€ ê°œì„ ë˜ì§€ ì•ŠëŠ”ë‹¤.</h3>

<p><strong><code class="language-plaintext highlighter-rouge">Degree=2</code>ì¸ Polynomial Regressionì˜ ê° ë…ë¦½ë³€ìˆ˜ë³„ ì”ì°¨</strong>
<img src="/assets/2022-12-25-when-regression-does-not-work/Polynomial Regression (v1)-ì”ì°¨ë¶„ì„.webp" alt="" /></p>

<p><strong><code class="language-plaintext highlighter-rouge">Degree=5</code>ì¸ Polynomial Regressionì˜ ê° ë…ë¦½ë³€ìˆ˜ë³„ ì”ì°¨</strong>
<img src="/assets/2022-12-25-when-regression-does-not-work/Polynomial Regression (v4)-ì”ì°¨ë¶„ì„.webp" alt="" /></p>

<hr />

<h2 id="published-by-joshua-kim"><em>Published by</em> Joshua Kim</h2>
<p><img src="/assets/profile/joshua-profile.png" alt="Joshua Kim" /></p>]]></content><author><name></name></author><category term="korean" /><category term="machine_learning" /><category term="statistics" /><category term="python" /><summary type="html"><![CDATA[ì´ë²ˆ ì•„í‹°í´ì—ì„œëŠ” íšŒê·€ëª¨ë¸(Regression Model)ì´ ì–´ë–¤ ê²½ìš°ì— ì €ì¡°í•œ ì„±ê³¼ë¥¼ ë‚´ëŠ”ì§€, ë” ë‚˜ì•„ê°€ Datasetì´ ì–´ë–¤ íŠ¹ì„±ì„ ì§€ë‹ ë•Œ íšŒê·€ëª¨ë¸ë¡œ í•´ë‹¹ ë¬¸ì œë¥¼ í’€ì–´ë‚¼ ìˆ˜ ì—†ëŠ”ì§€ í•„ìê°€ ê²½í—˜í•œ ë°”ë¥¼ ì„œìˆ í•´ë³´ê³ ì í•œë‹¤.]]></summary></entry></feed>