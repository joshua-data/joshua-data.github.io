<!DOCTYPE html>
<html>
  <head>

  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-K04Y972F7E"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-K04Y972F7E');
  </script>

  <!-- Google Adsense -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3596487245525606"
    crossorigin="anonymous">
  </script>

  <title>IP 주소-국가 매핑 쿼리 최적화 – Joshua Kim – Analytics Engineer | Data Analyst</title>

      <meta charset="utf-8" />
    <meta content='text/html; charset=utf-8' http-equiv='Content-Type'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0'>

    
    <meta name="description" content="
  “데이터 웨어하우스에서 IP 주소를 사용해 사용자의 국가 정보를 매핑하는 작업을 최적화하였습니다. 기존 방식은 연산 시간이 길어 비효율적이었으나, 새로운 접근 방식을 통해 쿼리 실행 시간을 90% 감소시켰습니다.”

" />
    <meta property="og:description" content="
  “데이터 웨어하우스에서 IP 주소를 사용해 사용자의 국가 정보를 매핑하는 작업을 최적화하였습니다. 기존 방식은 연산 시간이 길어 비효율적이었으나, 새로운 접근 방식을 통해 쿼리 실행 시간을 90% 감소시켰습니다.”

" />
    
    <meta name="author" content="Joshua Kim" />

    
    <meta property="og:title" content="IP 주소-국가 매핑 쿼리 최적화" />
    <meta property="twitter:title" content="IP 주소-국가 매핑 쿼리 최적화" />
    
  <!-- Async font loading -->
<script>
  window.WebFontConfig = {
      custom: {
          families: ['Spoqa Han Sans:100,300,400,700'],
          urls: ['https://spoqa.github.io/spoqa-han-sans/css/SpoqaHanSans-kr.css']
      },
      timeout: 60000
  };
  (function(d) {
      var wf = d.createElement('script'), s = d.scripts[0];
      wf.src = 'https://ajax.googleapis.com/ajax/libs/webfont/1.5.18/webfont.js';
      s.parentNode.insertBefore(wf, s);
  })(document);
</script>


  

  <!--[if lt IE 9]>
    <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->

  <link rel="stylesheet" type="text/css" href="/style.css" />
  <link rel="alternate" type="application/rss+xml" title="Joshua Kim - Analytics Engineer | Data Analyst" href="/feed.xml" />

  <link rel="apple-touch-icon" sizes="57x57" href="/assets/logo/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/assets/logo/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/assets/logo/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/assets/logo/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/assets/logo/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/assets/logo/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/assets/logo/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/assets/logo/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/assets/logo/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192"  href="/assets/logo/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/logo/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/assets/logo/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/assets/logo/favicon-16x16.png">
  <link rel="manifest" href="/manifest.json">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="/ms-icon-144x144.png">
  <meta name="theme-color" content="#ffffff">

  <!-- Created with Jekyll Now - http://github.com/barryclark/jekyll-now -->
</head>

  <body>      

    <div class="wrapper-masthead">
  <div class="container">
    <header class="masthead clearfix">
      
        <a href="/" class="site-avatar"><img src="https://avatars.githubusercontent.com/u/144670043?v=4" /></a>
      

      <div class="site-info">
        <h1 class="site-name"><a href="/">Joshua Kim</a></h1>
        <p class="site-description">Analytics Engineer | Data Analyst</p>
      </div>

      <nav>
        
        
        <a href="/about">About</a>
        
        
        
        <a href="/">Articles</a>
        
        
        
        <a href="/archive">Archive</a>
        
        
        
        <a href="/tags">Tags</a>
        
        
      </nav>
    </header>
  </div>
</div>

    <div id="main" role="main" class="container">
      <article class="post">
  <h1>IP 주소-국가 매핑 쿼리 최적화</h1>

  <div>
    <span class="date">
      2024-05-19
    </span>

    <ul class="tag">
      
      <li>
        <a href="http://localhost:4000/tags#Language (Korean)">
          Language (Korean)
        </a>
      </li>
      
      <li>
        <a href="http://localhost:4000/tags#Article (Issue Resolution)">
          Article (Issue Resolution)
        </a>
      </li>
      
      <li>
        <a href="http://localhost:4000/tags#Level (Advanced)">
          Level (Advanced)
        </a>
      </li>
      
      <li>
        <a href="http://localhost:4000/tags#Field (Analytics Engineering)">
          Field (Analytics Engineering)
        </a>
      </li>
      
      <li>
        <a href="http://localhost:4000/tags#Skills (SQL)">
          Skills (SQL)
        </a>
      </li>
      
    </ul>
  </div>

  <div class="entry">
    <blockquote>
  <p>“데이터 웨어하우스에서 IP 주소를 사용해 사용자의 국가 정보를 매핑하는 작업을 최적화하였습니다. 기존 방식은 연산 시간이 길어 비효율적이었으나, 새로운 접근 방식을 통해 쿼리 실행 시간을 90% 감소시켰습니다.”</p>
</blockquote>

<hr />

<table>
  <thead>
    <tr>
      <th><strong>Performance Summary</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>- 쿼리 실행 시간: <code class="language-plaintext highlighter-rouge">100분</code> → <code class="language-plaintext highlighter-rouge">10분</code></td>
    </tr>
  </tbody>
</table>

<hr />

<h1 id="목차">목차</h1>
<ol>
  <li>STAR Summary</li>
  <li>Situation</li>
  <li>Tasks</li>
  <li>Actions</li>
  <li>Results</li>
</ol>

<hr />

<h1 id="1-star-summary">1. STAR Summary</h1>

<h3 id="situation">Situation</h3>
<ul>
  <li>글로벌 서비스를 운영하는 환경에서 사용자의 접속 IP 주소를 기반으로 국가 정보를 매핑해야 했습니다. PostgreSQL을 사용하여 이 작업을 수행했으나, 기존 접근 방식으로 인해 성능 저하 문제가 발생했습니다. 기존 쿼리로는 너무 많은 시간이 소요되었으며, 이는 데이터 웨어하우스 운영에 큰 부담을 주고 있었습니다.</li>
</ul>

<h3 id="tasks">Tasks</h3>
<ul>
  <li>기존의 IP 주소 매핑 쿼리를 최적화하여 처리 시간을 대폭 줄이는 것이 목표였습니다. 이 작업을 통해 Transformation 과정의 효율성을 높여, 더 나은 데이터 웨어하우스 성능을 달성해야 했습니다. 구체적으로는 IP 주소 매핑 시 연산 과정을 최적화하고, JOIN 조건의 효율성을 높이는 것이 핵심 과제였습니다.</li>
</ul>

<h3 id="actions">Actions</h3>

<ol>
  <li><strong>기존 접근 방식 분석</strong>
    <ul>
      <li>기존 쿼리에서 <code class="language-plaintext highlighter-rouge">&lt;&lt;=</code> 연산자를 사용하여 CIDR 네트워크에 IP 주소를 매핑하는 방법을 사용했습니다. 이는 성능 저하의 주요 원인으로 파악되었습니다.</li>
    </ul>
  </li>
  <li><strong>새로운 테이블 생성</strong>
    <ul>
      <li>기존 테이블을 가공하여 <code class="language-plaintext highlighter-rouge">dim_ips_countries</code> 테이블을 생성했습니다.
        <ul>
          <li>이 테이블은 <code class="language-plaintext highlighter-rouge">start_ip</code>와 <code class="language-plaintext highlighter-rouge">end_ip</code> 칼럼을 가지고 있습니다.</li>
          <li>비교 연산의 효율성을 위해 IP 주소를 BIGINT 타입으로 변환했습니다.</li>
        </ul>
      </li>
    </ul>
  </li>
  <li><strong>Index 생성</strong>
    <ul>
      <li><code class="language-plaintext highlighter-rouge">start_ip</code>와 <code class="language-plaintext highlighter-rouge">end_ip</code> 칼럼을 Index로 생성하여 검색 성능을 극대화했습니다.</li>
    </ul>
  </li>
  <li><strong>쿼리 최적화</strong>
    <ul>
      <li>기존의 <code class="language-plaintext highlighter-rouge">&lt;&lt;=</code> 연산자를 <code class="language-plaintext highlighter-rouge">BETWEEN</code> 연산자로 대체하여, IP 주소 비교 작업을 단순화하고 경량화된 연산을 수행하도록 쿼리를 재구성했습니다.</li>
    </ul>
  </li>
</ol>

<h3 id="results">Results</h3>
<ul>
  <li>최적화된 쿼리를 통해 실행 시간이 90% 대폭 감소하여 데이터 웨어하우스 성능 향상을 가져왔습니다.</li>
</ul>

<hr />

<h1 id="2-situation">2. Situation</h1>

<blockquote>
  <ul>
    <li>글로벌 서비스를 운영하는 환경에서 사용자의 접속 IP 주소를 기반으로 국가 정보를 매핑해야 했습니다. PostgreSQL을 사용하여 이 작업을 수행했으나, 기존 접근 방식으로 인해 성능 저하 문제가 발생했습니다. 기존 쿼리로는 너무 많은 시간이 소요되었으며, 이는 데이터 웨어하우스 운영에 큰 부담을 주고 있었습니다.</li>
  </ul>
</blockquote>

<h3 id="문제-요약">문제 요약</h3>
<ul>
  <li>글로벌 서비스를 운영하는 환경에서 사용자들이 접속할 때마다 수집되는 IP 주소를 지리 정보인 국가로 매핑하는 작업이 필요했습니다. 이를 위해 PostgreSQL의 CIDR 연산자를 사용하여 IP 주소를 국가명과 매핑하는 테이블을 구성했지만, 기존 방식은 매우 비효율적이었습니다.</li>
</ul>

<h3 id="구체적인-문제-상황">구체적인 문제 상황</h3>
<ul>
  <li><code class="language-plaintext highlighter-rouge">src_sessions</code> 테이블의 <code class="language-plaintext highlighter-rouge">session_ip</code> 칼럼을 <code class="language-plaintext highlighter-rouge">src_cidrs_countries</code> 테이블의 <code class="language-plaintext highlighter-rouge">cidr</code> 칼럼에 매핑하여 <code class="language-plaintext highlighter-rouge">fct_sessions</code> 테이블을 생성하는 작업이 핵심 문제였습니다.</li>
  <li>기존 쿼리는 <code class="language-plaintext highlighter-rouge">&lt;&lt;=</code> 연산자를 사용하여 IP 주소가 특정 CIDR 네트워크에 포함되는지를 확인하는 방식으로 이루어졌습니다. 그러나 이 방법은 대규모 데이터 처리 시 성능 문제가 발생하여, 쿼리 실행 시간이 지나치게 많이 소요되었습니다. 이는 데이터 웨어하우스의 성능을 저하시키고, 운영에 심각한 지장을 초래했습니다.</li>
</ul>

<hr />

<h1 id="3-tasks">3. Tasks</h1>
<blockquote>
  <ul>
    <li>기존의 IP 주소 매핑 쿼리를 최적화하여 처리 시간을 대폭 줄이는 것이 목표였습니다. 이 작업을 통해 Transformation 과정의 효율성을 높여, 더 나은 데이터 웨어하우스 성능을 달성해야 했습니다. 구체적으로는 IP 주소 매핑 시 연산 과정을 최적화하고, JOIN 조건의 효율성을 높이는 것이 핵심 과제였습니다.</li>
  </ul>
</blockquote>

<h3 id="주어진-과제"><strong>주어진 과제</strong></h3>
<ul>
  <li>기존의 비효율적인 쿼리 실행 시간을 대폭 줄이는 것이었습니다.</li>
</ul>

<h5 id="1-데이터-처리-속도-향상"><strong>1. 데이터 처리 속도 향상</strong></h5>
<ul>
  <li>실행 시간을 줄여 데이터 처리 효율성을 높이고, 서비스 운영에 방해가 되지 않도록 하는 것</li>
</ul>

<h5 id="2-쿼리-최적화"><strong>2. 쿼리 최적화</strong></h5>
<ul>
  <li>IP 주소와 국가 정보의 매핑 작업을 보다 효율적으로 수행할 수 있는 최적화된 쿼리 구조를 설계하고 구현하는 것</li>
</ul>

<h5 id="3-시스템-성능-개선"><strong>3. 시스템 성능 개선</strong></h5>
<ul>
  <li>데이터 웨어하우스의 전반적인 성능을 개선하여 미래의 데이터 확장 및 증가에도 대응할 수 있는 기반을 마련하는 것</li>
</ul>

<hr />

<h1 id="4-actions">4. Actions</h1>

<blockquote>
  <ol>
    <li><strong>기존 접근 방식 분석</strong>
      <ul>
        <li>기존 쿼리에서 <code class="language-plaintext highlighter-rouge">&lt;&lt;=</code> 연산자를 사용하여 CIDR 네트워크에 IP 주소를 매핑하는 방법을 사용했습니다. 이는 성능 저하의 주요 원인으로 파악되었습니다.</li>
      </ul>
    </li>
    <li><strong>새로운 테이블 생성</strong>
      <ul>
        <li>기존 테이블을 가공하여 <code class="language-plaintext highlighter-rouge">dim_ips_countries</code> 테이블을 생성했습니다.</li>
      </ul>
      <ul>
        <li>이 테이블은 <code class="language-plaintext highlighter-rouge">start_ip</code>와 <code class="language-plaintext highlighter-rouge">end_ip</code> 칼럼을 가지고 있습니다.</li>
        <li>비교 연산의 효율성을 위해 IP 주소를 BIGINT 타입으로 변환했습니다.</li>
      </ul>
    </li>
    <li><strong>Index 생성</strong>
      <ul>
        <li><code class="language-plaintext highlighter-rouge">start_ip</code>와 <code class="language-plaintext highlighter-rouge">end_ip</code> 칼럼을 Index로 생성하여 검색 성능을 극대화했습니다.</li>
      </ul>
    </li>
    <li><strong>쿼리 최적화</strong>
      <ul>
        <li>기존의 <code class="language-plaintext highlighter-rouge">&lt;&lt;=</code> 연산자를 <code class="language-plaintext highlighter-rouge">BETWEEN</code> 연산자로 대체하여, IP 주소 비교 작업을 단순화하고 경량화된 연산을 수행하도록 쿼리를 재구성했습니다.</li>
      </ul>
    </li>
  </ol>
</blockquote>

<h3 id="1-기존-접근-방식-분석">1. 기존 접근 방식 분석</h3>
<p><img src="/assets/2024-05-19-ip-address-to-country/1.webp" alt="" /></p>

<p><strong>(STEP 1)</strong> <code class="language-plaintext highlighter-rouge">src_cidrs_countries</code> 테이블에 Index를 생성합니다.</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">src_sessions</code> 테이블과 JOIN시 <code class="language-plaintext highlighter-rouge">cidr</code> 칼럼을 빈번하게 스캔해야 하므로, 이를 Index로 생성했습니다.
    <details>
<summary>View code</summary>
<div>
        <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">CREATE</span> <span class="k">INDEX</span> <span class="n">idx_cidr</span> <span class="k">ON</span> <span class="n">src_cidrs_countries</span> <span class="p">(</span><span class="n">cidr</span><span class="p">);</span>
</code></pre></div>        </div>
      </div>
</details>
  </li>
</ul>

<p><strong>(STEP 2)</strong> <code class="language-plaintext highlighter-rouge">src_cidrs_countries</code> 테이블과 <code class="language-plaintext highlighter-rouge">src_sessions</code> 테이블을 JOIN한 <code class="language-plaintext highlighter-rouge">fct_sessions</code> 테이블을 생성했습니다.</p>
<ul>
  <li>JOIN 과정에서 <code class="language-plaintext highlighter-rouge">&lt;&lt;=</code> 연산자를 사용했습니다.</li>
  <li>그러나 이 연산자는 CIDR 타입 간의 비교를 수행하는 데 연산 비용이 높아, 대규모 데이터 처리 시 성능 저하의 원인이 되었습니다.
    <details>
<summary>View code</summary>
<div>
        <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">fct_sessions</span> <span class="k">AS</span>
    <span class="k">SELECT</span>
      <span class="n">S</span><span class="p">.</span><span class="n">session_id</span><span class="p">,</span>
      <span class="n">S</span><span class="p">.</span><span class="n">user_id</span><span class="p">,</span>
      <span class="k">C</span><span class="p">.</span><span class="n">country</span>
    <span class="k">FROM</span>
      <span class="n">src_sessions</span> <span class="n">S</span>
    <span class="k">LEFT</span> <span class="k">JOIN</span>
      <span class="n">src_cidrs_countries</span> <span class="k">C</span>
      <span class="k">ON</span> <span class="n">S</span><span class="p">.</span><span class="n">session_ip</span><span class="p">::</span><span class="n">INET</span> <span class="o">&lt;&lt;=</span> <span class="k">C</span><span class="p">.</span><span class="n">cidr</span><span class="p">;</span>
</code></pre></div>        </div>
      </div>
</details>
  </li>
</ul>

<h3 id="2-새로운-테이블-생성">2. <strong>새로운 테이블 생성</strong></h3>
<p><img src="/assets/2024-05-19-ip-address-to-country/2.webp" alt="" /></p>

<ul>
  <li>기존의 <code class="language-plaintext highlighter-rouge">src_cidrs_countries</code> 테이블을 가공하여 <code class="language-plaintext highlighter-rouge">dim_ips_countries</code> 테이블을 새롭게 설계했습니다. 이 테이블에 CIDR 연산을 최소화하기 위해 각 CIDR 값에 대해 IP 주소 범위를 나타내는 <code class="language-plaintext highlighter-rouge">start_ip</code>와 <code class="language-plaintext highlighter-rouge">end_ip</code> 칼럼을 추가했습니다.</li>
  <li>IP 주소를 BIGINT 타입으로 변환하여 저장함으로써, 연산 속도를 크게 향상시켰습니다. <code class="language-plaintext highlighter-rouge">start_ip</code>와 <code class="language-plaintext highlighter-rouge">end_ip</code>는 CIDR 범위 내에서 가장 낮은 IP와 가장 높은 IP를 나타내며, 이를 통해 CIDR 네트워크 내 IP 주소 확인 작업을 단순화했습니다.</li>
</ul>

<details>
<summary>View code</summary>
<div>
    <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">dim_ips_countries</span> <span class="k">AS</span>
    <span class="k">SELECT</span>
      <span class="n">cidr</span><span class="p">,</span>
      <span class="p">(</span><span class="s1">'x'</span> <span class="o">||</span> 
      <span class="n">LPAD</span><span class="p">(</span><span class="n">TO_HEX</span><span class="p">((</span><span class="n">SPLIT_PART</span><span class="p">(</span><span class="k">HOST</span><span class="p">(</span><span class="n">cidr</span><span class="p">),</span> <span class="s1">'.'</span><span class="p">,</span> <span class="mi">1</span><span class="p">)::</span><span class="nb">INTEGER</span><span class="p">)),</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">'0'</span><span class="p">)</span> <span class="o">||</span>
      <span class="n">LPAD</span><span class="p">(</span><span class="n">TO_HEX</span><span class="p">((</span><span class="n">SPLIT_PART</span><span class="p">(</span><span class="k">HOST</span><span class="p">(</span><span class="n">cidr</span><span class="p">),</span> <span class="s1">'.'</span><span class="p">,</span> <span class="mi">2</span><span class="p">)::</span><span class="nb">INTEGER</span><span class="p">)),</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">'0'</span><span class="p">)</span> <span class="o">||</span>
      <span class="n">LPAD</span><span class="p">(</span><span class="n">TO_HEX</span><span class="p">((</span><span class="n">SPLIT_PART</span><span class="p">(</span><span class="k">HOST</span><span class="p">(</span><span class="n">cidr</span><span class="p">),</span> <span class="s1">'.'</span><span class="p">,</span> <span class="mi">3</span><span class="p">)::</span><span class="nb">INTEGER</span><span class="p">)),</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">'0'</span><span class="p">)</span> <span class="o">||</span>
      <span class="n">LPAD</span><span class="p">(</span><span class="n">TO_HEX</span><span class="p">((</span><span class="n">SPLIT_PART</span><span class="p">(</span><span class="k">HOST</span><span class="p">(</span><span class="n">cidr</span><span class="p">),</span> <span class="s1">'.'</span><span class="p">,</span> <span class="mi">4</span><span class="p">)::</span><span class="nb">INTEGER</span><span class="p">)),</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">'0'</span><span class="p">)</span>
      <span class="p">)::</span><span class="nb">BIT</span><span class="p">(</span><span class="mi">32</span><span class="p">)::</span><span class="nb">BIGINT</span> <span class="k">AS</span> <span class="n">start_ip</span><span class="p">,</span>
      <span class="p">(</span><span class="s1">'x'</span> <span class="o">||</span>
      <span class="n">LPAD</span><span class="p">(</span><span class="n">TO_HEX</span><span class="p">((</span><span class="n">SPLIT_PART</span><span class="p">(</span><span class="k">HOST</span><span class="p">(</span><span class="n">BROADCAST</span><span class="p">(</span><span class="n">cidr</span><span class="p">)),</span> <span class="s1">'.'</span><span class="p">,</span> <span class="mi">1</span><span class="p">)::</span><span class="nb">INTEGER</span><span class="p">)),</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">'0'</span><span class="p">)</span> <span class="o">||</span>
      <span class="n">LPAD</span><span class="p">(</span><span class="n">TO_HEX</span><span class="p">((</span><span class="n">SPLIT_PART</span><span class="p">(</span><span class="k">HOST</span><span class="p">(</span><span class="n">BROADCAST</span><span class="p">(</span><span class="n">cidr</span><span class="p">)),</span> <span class="s1">'.'</span><span class="p">,</span> <span class="mi">2</span><span class="p">)::</span><span class="nb">INTEGER</span><span class="p">)),</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">'0'</span><span class="p">)</span> <span class="o">||</span>
      <span class="n">LPAD</span><span class="p">(</span><span class="n">TO_HEX</span><span class="p">((</span><span class="n">SPLIT_PART</span><span class="p">(</span><span class="k">HOST</span><span class="p">(</span><span class="n">BROADCAST</span><span class="p">(</span><span class="n">cidr</span><span class="p">)),</span> <span class="s1">'.'</span><span class="p">,</span> <span class="mi">3</span><span class="p">)::</span><span class="nb">INTEGER</span><span class="p">)),</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">'0'</span><span class="p">)</span> <span class="o">||</span>
      <span class="n">LPAD</span><span class="p">(</span><span class="n">TO_HEX</span><span class="p">((</span><span class="n">SPLIT_PART</span><span class="p">(</span><span class="k">HOST</span><span class="p">(</span><span class="n">BROADCAST</span><span class="p">(</span><span class="n">cidr</span><span class="p">)),</span> <span class="s1">'.'</span><span class="p">,</span> <span class="mi">4</span><span class="p">)::</span><span class="nb">INTEGER</span><span class="p">)),</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">'0'</span><span class="p">)</span>
      <span class="p">)::</span><span class="nb">BIT</span><span class="p">(</span><span class="mi">32</span><span class="p">)::</span><span class="nb">BIGINT</span> <span class="k">AS</span> <span class="n">end_ip</span><span class="p">,</span>				
      <span class="n">country</span>
    <span class="k">FROM</span>
      <span class="n">src_cidrs_countries</span><span class="p">;</span>
</code></pre></div>    </div>
  </div>
</details>

<h3 id="3-index-생성">3. <strong>Index 생성</strong></h3>

<ul>
  <li><code class="language-plaintext highlighter-rouge">src_sessions</code> 테이블과 JOIN시 <code class="language-plaintext highlighter-rouge">start_ip</code> 및 <code class="language-plaintext highlighter-rouge">end_ip</code> 칼럼을 빈번하게 스캔해야 하므로, 이 2개 칼럼을 Index로 생성했습니다.</li>
  <li>이 Index는 IP 주소 범위 내에서 효율적으로 값을 찾을 수 있도록 설계되었으며, JOIN 연산 시 빠른 검색이 가능하게 되었습니다.
    <details>
<summary>View code</summary>
<div>
        <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">CREATE</span> <span class="k">INDEX</span> <span class="n">idx_ip_range</span> <span class="k">ON</span> <span class="n">dim_ips_countries</span> <span class="p">(</span><span class="n">start_ip</span><span class="p">,</span> <span class="n">end_ip</span><span class="p">);</span>
</code></pre></div>        </div>
      </div>
</details>
  </li>
</ul>

<h3 id="4-쿼리-최적화">4. <strong>쿼리 최적화</strong></h3>

<ul>
  <li>기존의 <code class="language-plaintext highlighter-rouge">&lt;&lt;=</code> 연산자를 <code class="language-plaintext highlighter-rouge">BETWEEN</code> 연산자로 대체하여, IP 주소 비교 작업을 단순화하고 경량화된 연산을 수행하도록 쿼리를 재구성했습니다.</li>
  <li><code class="language-plaintext highlighter-rouge">src_sessions</code> 테이블의 <code class="language-plaintext highlighter-rouge">session_ip</code> 칼럼도 CIDR에서 IP 주소를 추출한 후 BIGINT 타입으로 변환하여 <code class="language-plaintext highlighter-rouge">dim_ips_countries</code> 테이블의 <code class="language-plaintext highlighter-rouge">start_ip</code>와 <code class="language-plaintext highlighter-rouge">end_ip</code> 칼럼과 비교했습니다.
    <details>
<summary>View code</summary>
<div>
        <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">fct_sessions</span> <span class="k">AS</span>
    <span class="k">SELECT</span>
    <span class="n">S</span><span class="p">.</span><span class="n">session_id</span><span class="p">,</span>
    <span class="n">S</span><span class="p">.</span><span class="n">user_id</span><span class="p">,</span>
    <span class="k">C</span><span class="p">.</span><span class="n">country</span>
  <span class="k">FROM</span> <span class="p">(</span>
    <span class="k">SELECT</span>
      <span class="n">session_id</span><span class="p">,</span>
      <span class="n">user_id</span><span class="p">,</span>
      <span class="p">(</span><span class="s1">'x'</span> <span class="o">||</span>
      <span class="n">LPAD</span><span class="p">(</span><span class="n">TO_HEX</span><span class="p">((</span><span class="n">SPLIT_PART</span><span class="p">(</span><span class="k">HOST</span><span class="p">(</span><span class="n">session_ip</span><span class="p">::</span><span class="n">INET</span><span class="p">),</span> <span class="s1">'.'</span><span class="p">,</span> <span class="mi">1</span><span class="p">)::</span><span class="nb">INTEGER</span><span class="p">)),</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">'0'</span><span class="p">)</span> <span class="o">||</span>
      <span class="n">LPAD</span><span class="p">(</span><span class="n">TO_HEX</span><span class="p">((</span><span class="n">SPLIT_PART</span><span class="p">(</span><span class="k">HOST</span><span class="p">(</span><span class="n">session_ip</span><span class="p">::</span><span class="n">INET</span><span class="p">),</span> <span class="s1">'.'</span><span class="p">,</span> <span class="mi">2</span><span class="p">)::</span><span class="nb">INTEGER</span><span class="p">)),</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">'0'</span><span class="p">)</span> <span class="o">||</span>
      <span class="n">LPAD</span><span class="p">(</span><span class="n">TO_HEX</span><span class="p">((</span><span class="n">SPLIT_PART</span><span class="p">(</span><span class="k">HOST</span><span class="p">(</span><span class="n">session_ip</span><span class="p">::</span><span class="n">INET</span><span class="p">),</span> <span class="s1">'.'</span><span class="p">,</span> <span class="mi">3</span><span class="p">)::</span><span class="nb">INTEGER</span><span class="p">)),</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">'0'</span><span class="p">)</span> <span class="o">||</span>
      <span class="n">LPAD</span><span class="p">(</span><span class="n">TO_HEX</span><span class="p">((</span><span class="n">SPLIT_PART</span><span class="p">(</span><span class="k">HOST</span><span class="p">(</span><span class="n">session_ip</span><span class="p">::</span><span class="n">INET</span><span class="p">),</span> <span class="s1">'.'</span><span class="p">,</span> <span class="mi">4</span><span class="p">)::</span><span class="nb">INTEGER</span><span class="p">)),</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">'0'</span><span class="p">)</span>                
      <span class="p">)::</span><span class="nb">BIT</span><span class="p">(</span><span class="mi">32</span><span class="p">)::</span><span class="nb">BIGINT</span> <span class="k">AS</span> <span class="n">session_ip</span>
    <span class="k">FROM</span>
      <span class="n">src_sessions</span>
  <span class="p">)</span> <span class="n">S</span>
  <span class="k">LEFT</span> <span class="k">JOIN</span>
    <span class="n">src_cidrs_countries</span> <span class="k">C</span>
    <span class="k">ON</span> <span class="n">S</span><span class="p">.</span><span class="n">session_ip</span> <span class="k">BETWEEN</span> <span class="k">C</span><span class="p">.</span><span class="n">start_ip</span> <span class="k">AND</span> <span class="k">C</span><span class="p">.</span><span class="n">end_ip</span><span class="p">;</span>
</code></pre></div>        </div>
      </div>
</details>
  </li>
</ul>

<hr />

<h1 id="5-results">5. Results</h1>
<blockquote>
  <ul>
    <li>최적화된 쿼리를 통해 실행 시간이 90% 대폭 감소하여 데이터 웨어하우스 성능 향상을 가져왔습니다.</li>
  </ul>
</blockquote>

<h3 id="1-긍정적인-결과">1. 긍정적인 결과</h3>

<ul>
  <li>최적화된 접근 방식을 통해 쿼리 실행 시간이 기존 100x시간에서 약 10x시간으로 감소하였습니다. 이는 실행 시간의 약 90%를 줄인 결과로, 데이터 처리 속도와 시스템 성능이 크게 개선되었습니다. 특히, 신규 접근 방식은 대규모 데이터 처리 시에도 안정적인 성능을 유지할 수 있도록 하였으며, 향후 데이터 증가에도 유연하게 대응할 수 있는 기반을 마련했습니다.</li>
  <li>이 최적화 작업은 데이터 웨어하우스의 효율성을 극대화하여 운영 비용을 절감하고, 더 나은 데이터 분석과 서비스 제공이 가능하도록 했습니다. 결과적으로, 시스템의 전반적인 성능이 크게 향상되었으며, 이로 인해 회사의 데이터 운영 전략에 중요한 기여를 할 수 있었습니다.</li>
</ul>

<h3 id="2-교훈">2. 교훈</h3>

<ul>
  <li>아래 그림과 같이, SQL의 JOIN은 Nested Loop 탐색 과정이 일어나므로 가장 면밀하게 검토해야 할 부분이었습니다.
<img src="/assets/2024-05-19-ip-address-to-country/3.webp" alt="" /></li>
</ul>

<h5 id="tip-1-join의-조건-역할을-하는-칼럼은-최대한-가벼운-타입을-지녀야-한다">(TIP 1) JOIN의 조건 역할을 하는 칼럼은 최대한 가벼운 타입을 지녀야 한다.</h5>
<ul>
  <li>기존 접근 방식에서는 <code class="language-plaintext highlighter-rouge">cidr</code> 칼럼이 CIDR 타입이었으나, 신규 접근 방식에서는 이를 BIGINT로 Parse하여 타입을 경량화시켰습니다.</li>
</ul>

<h5 id="tip-2-join의-조건-역할을-하는-연산자는-최대한-가벼운-과정이-되어야-한다">(TIP 2) JOIN의 조건 역할을 하는 연산자는 최대한 가벼운 과정이 되어야 한다.</h5>
<ul>
  <li>기존 접근 방식에서는 <code class="language-plaintext highlighter-rouge">&gt;&gt;=</code>라는 다소 무거운 연산자를 사용했으나, 신규 접근 방식에서는 이를 <code class="language-plaintext highlighter-rouge">BETWEEN</code> 연산자를 사용하여 부담을 줄였습니다.</li>
</ul>

<hr />

<h2 id="published-by-joshua-kim"><em>Published by</em> Joshua Kim</h2>
<p><img src="/assets/profile/joshua-profile.png" alt="Joshua Kim" /></p>

  </div>

  <div class="pagination">
    
      <span class="prev" >
          <a href="http://localhost:4000/ip-address-to-country-en/">
            &#xE000; IP Address-Country Mapping Query Optimization
          </a>
      </span>
    
    
      <span class="next" >
          <a href="http://localhost:4000/rolling-mau-en/">
            Rolling MAU Query Optimization &#xE001;
          </a>
      </span>
    
  </div>

  <script type="text/javascript"
  src="https://unpkg.com/mermaid@10.6.1/dist/mermaid.min.js">
</script>
<script>
$(document).ready(function() {
    mermaid.initialize({
        theme: 'forest'
    });
});
</script>
  
</article>

    </div>

    <div class="wrapper-footer">
      <div class="container">
        <footer class="footer">
          <!-- Refer to https://codepen.io/ruandre/pen/howFi -->
<ul class="svg-icon">

  

  

  

  

  

  
  <li><a href="https://github.com/joshua-data" class="icon-13 github" title="GitHub"><svg viewBox="0 0 512 512"><path d="M256 70.7c-102.6 0-185.9 83.2-185.9 185.9 0 82.1 53.3 151.8 127.1 176.4 9.3 1.7 12.3-4 12.3-8.9V389.4c-51.7 11.3-62.5-21.9-62.5-21.9 -8.4-21.5-20.6-27.2-20.6-27.2 -16.9-11.5 1.3-11.3 1.3-11.3 18.7 1.3 28.5 19.2 28.5 19.2 16.6 28.4 43.5 20.2 54.1 15.4 1.7-12 6.5-20.2 11.8-24.9 -41.3-4.7-84.7-20.6-84.7-91.9 0-20.3 7.3-36.9 19.2-49.9 -1.9-4.7-8.3-23.6 1.8-49.2 0 0 15.6-5 51.1 19.1 14.8-4.1 30.7-6.2 46.5-6.3 15.8 0.1 31.7 2.1 46.6 6.3 35.5-24 51.1-19.1 51.1-19.1 10.1 25.6 3.8 44.5 1.8 49.2 11.9 13 19.1 29.6 19.1 49.9 0 71.4-43.5 87.1-84.9 91.7 6.7 5.8 12.8 17.1 12.8 34.4 0 24.9 0 44.9 0 51 0 4.9 3 10.7 12.4 8.9 73.8-24.6 127-94.3 127-176.4C441.9 153.9 358.6 70.7 256 70.7z"/></svg><!--[if lt IE 9]><em>GitHub</em><![endif]--></a></li>
  

  

  

  
  <li><a href="https://www.linkedin.com/in/joshuajsk" class="icon-17 linkedin" title="LinkedIn"><svg viewBox="0 0 512 512"><path d="M186.4 142.4c0 19-15.3 34.5-34.2 34.5 -18.9 0-34.2-15.4-34.2-34.5 0-19 15.3-34.5 34.2-34.5C171.1 107.9 186.4 123.4 186.4 142.4zM181.4 201.3h-57.8V388.1h57.8V201.3zM273.8 201.3h-55.4V388.1h55.4c0 0 0-69.3 0-98 0-26.3 12.1-41.9 35.2-41.9 21.3 0 31.5 15 31.5 41.9 0 26.9 0 98 0 98h57.5c0 0 0-68.2 0-118.3 0-50-28.3-74.2-68-74.2 -39.6 0-56.3 30.9-56.3 30.9v-25.2H273.8z"/></svg><!--[if lt IE 9]><em>LinkedIn</em><![endif]--></a></li>
  

  

  
  <li><a href="/feed.xml" class="icon-21 rss" title="RSS"><svg viewBox="0 0 512 512"><path d="M201.8 347.2c0 20.3-16.5 36.8-36.8 36.8 -20.3 0-36.8-16.5-36.8-36.8s16.5-36.8 36.8-36.8C185.3 310.4 201.8 326.8 201.8 347.2zM128.2 204.7v54.5c68.5 0.7 124 56.3 124.7 124.7h54.5C306.7 285.3 226.9 205.4 128.2 204.7zM128.2 166.6c57.9 0.3 112.3 22.9 153.2 63.9 41 41 63.7 95.5 63.9 153.5h54.5c-0.3-149.9-121.7-271.4-271.6-271.9V166.6L128.2 166.6z"/></svg><!--[if lt IE 9]><em>RSS</em><![endif]--></a></li>
  

  

  

  

  

</ul>



<div class="footer-wrapper">
    <p>Joshua Kim</p>
    <a href="https://hits.seeyoufarm.com"><img src="https://hits.seeyoufarm.com/api/count/incr/badge.svg?url=https%3A%2F%2Fjoshua-data.github.io&count_bg=%2379C83D&title_bg=%23555555&icon=ghostery.svg&icon_color=%23E7E7E7&title=hits&edge_flat=false"/></a>
</div>

        </footer>
      </div>
    </div>

    

  </body>
</html>
