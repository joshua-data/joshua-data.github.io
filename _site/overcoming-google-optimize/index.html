<!DOCTYPE html>
<html>
  <head>

  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-K04Y972F7E"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-K04Y972F7E');
  </script>

  <title>Harnessing the Power of BigQuery and Python: Overcoming Google Optimize A/B Testing Limitations – Joshua Kim – Analytics Engineer | Data Analyst</title>

      <meta charset="utf-8" />
    <meta content='text/html; charset=utf-8' http-equiv='Content-Type'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0'>

    
    <meta name="description" content="
  By connecting to BigQuery (where the experiment data is loaded) from Python and creating automated code, the analysis time can be significantly reduced, and it becomes easier to quickly determine the direction for further analysis when needed.

" />
    <meta property="og:description" content="
  By connecting to BigQuery (where the experiment data is loaded) from Python and creating automated code, the analysis time can be significantly reduced, and it becomes easier to quickly determine the direction for further analysis when needed.

" />
    
    <meta name="author" content="Joshua Kim" />

    
    <meta property="og:title" content="Harnessing the Power of BigQuery and Python: Overcoming Google Optimize A/B Testing Limitations" />
    <meta property="twitter:title" content="Harnessing the Power of BigQuery and Python: Overcoming Google Optimize A/B Testing Limitations" />
    
  <!-- Async font loading -->
<script>
  window.WebFontConfig = {
      custom: {
          families: ['Spoqa Han Sans:100,300,400,700'],
          urls: ['https://spoqa.github.io/spoqa-han-sans/css/SpoqaHanSans-kr.css']
      },
      timeout: 60000
  };
  (function(d) {
      var wf = d.createElement('script'), s = d.scripts[0];
      wf.src = 'https://ajax.googleapis.com/ajax/libs/webfont/1.5.18/webfont.js';
      s.parentNode.insertBefore(wf, s);
  })(document);
</script>


  

  <!--[if lt IE 9]>
    <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->

  <link rel="stylesheet" type="text/css" href="/style.css" />
  <link rel="alternate" type="application/rss+xml" title="Joshua Kim - Analytics Engineer | Data Analyst" href="/feed.xml" />

  <link rel="apple-touch-icon" sizes="57x57" href="/assets/logo/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/assets/logo/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/assets/logo/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/assets/logo/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/assets/logo/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/assets/logo/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/assets/logo/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/assets/logo/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/assets/logo/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192"  href="/assets/logo/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/logo/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/assets/logo/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/assets/logo/favicon-16x16.png">
  <link rel="manifest" href="/manifest.json">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="/ms-icon-144x144.png">
  <meta name="theme-color" content="#ffffff">

  <!-- Created with Jekyll Now - http://github.com/barryclark/jekyll-now -->
</head>

  <body>      

    <div class="wrapper-masthead">
  <div class="container">
    <header class="masthead clearfix">
      
        <a href="/" class="site-avatar"><img src="https://avatars.githubusercontent.com/u/144670043?v=4" /></a>
      

      <div class="site-info">
        <h1 class="site-name"><a href="/">Joshua Kim</a></h1>
        <p class="site-description">Analytics Engineer | Data Analyst</p>
      </div>

      <nav>
        
        
        <a href="/about">About</a>
        
        
        
        <a href="/">Articles</a>
        
        
        
        <a href="/archive">Archive</a>
        
        
        
        <a href="/tags">Tags</a>
        
        
      </nav>
    </header>
  </div>
</div>

    <div id="main" role="main" class="container">
      <article class="post">
  <h1>Harnessing the Power of BigQuery and Python: Overcoming Google Optimize A/B Testing Limitations</h1>

  <div>
    <span class="date">
      2023-06-04
    </span>

    <ul class="tag">
      
      <li>
        <a href="http://localhost:4000/tags#Language (English)">
          Language (English)
        </a>
      </li>
      
      <li>
        <a href="http://localhost:4000/tags#Article (Issue Resolution)">
          Article (Issue Resolution)
        </a>
      </li>
      
      <li>
        <a href="http://localhost:4000/tags#Level (2. Intermediate)">
          Level (2. Intermediate)
        </a>
      </li>
      
      <li>
        <a href="http://localhost:4000/tags#Field (Data Analysis)">
          Field (Data Analysis)
        </a>
      </li>
      
      <li>
        <a href="http://localhost:4000/tags#Skills (Python)">
          Skills (Python)
        </a>
      </li>
      
      <li>
        <a href="http://localhost:4000/tags#Skills (SQL)">
          Skills (SQL)
        </a>
      </li>
      
    </ul>
  </div>

  <div class="entry">
    <blockquote>
  <p>By connecting to BigQuery (where the experiment data is loaded) from Python and creating automated code, the analysis time can be significantly reduced, and it becomes easier to quickly determine the direction for further analysis when needed.</p>
</blockquote>

<h3 id="contents">CONTENTS</h3>
<ol>
  <li>Introduction
    <ul>
      <li>1.1. Why I Think of Google Optimize as Risky</li>
      <li>1.2. Google Analytics 4 May Offer Improvements in This Regard, But It Can be Quite Cumbersome.</li>
      <li>1.3. How Your A/B Test Data is Loaded Into BigQuery</li>
    </ul>
  </li>
  <li>To Connect Python with BigQuery
    <ul>
      <li>2.1. Load Libraries</li>
      <li>2.2. Connect to Bigquery</li>
      <li>2.3. Enter the Basic Experiment Info</li>
    </ul>
  </li>
  <li>Extracting Data
    <ul>
      <li>3.1. Purchase Conversion Rate</li>
      <li>3.2. Purchase Conversion Rate (by Country)</li>
      <li>3.3. Average Revenue per User</li>
      <li>3.4. Average Revenue per User (by Country)</li>
      <li>3.5. Other Aspects?</li>
    </ul>
  </li>
  <li>Start to Analyze Statistically
    <ul>
      <li>4.1. Purchase Conversion Rate</li>
      <li>4.2. Average Revenue per User</li>
      <li>4.3. Conversion Rate &amp; Average Revenue per User (by Country)</li>
    </ul>
  </li>
  <li>To Recap</li>
</ol>

<hr />

<h1 id="tldr">TL;DR</h1>

<p>The dashboard of Google Optimize presents an excessively one-dimensional view when analyzing A/B tests, making it very risky to base service decisions solely on this.</p>
<ul>
  <li>Even if A/B testing may lead to the conclusion of maintaining option A across all user aspects, there can be cases within specific subgroups where the conclusion may favor option B. Unfortunately, Google Optimize does not provide such detailed analysis tools.</li>
  <li>Google Optimize allows for setting a maximum of three goals, which include metrics such as purchase conversion rate and specific button click-through rate. However, to comprehensively examine actions on the following pages or retention rates, it is necessary to consider them all together. Unfortunately, Google Optimize does not provide such functionality.</li>
  <li>There is indeed a valid concern regarding Google Optimize accurately measuring goal achievement if a user executes multiple sessions and makes a purchase in the last session while bypassing the experiment assignment page. It is questionable whether Google Optimize can accurately attribute this conversion as goal achievement.</li>
</ul>

<p>While Google Analytics 4’s Explore feature provides a UI for in-depth analysis of experiment results, it can be quite cumbersome and time-consuming to manually check and explore the results every time.</p>

<p>Therefore, by connecting to BigQuery (where the experiment data is loaded) from Python and creating automated code, the analysis time can be significantly reduced, and it becomes easier to quickly determine the direction for further analysis when needed.</p>

<p><strong>⚠️Amber Alert!</strong>  ️</p>

<blockquote>
  <p>“Google Optimize and Optimize 360 will no longer be available after September 30, 2023. Your experiments and personalizations can continue to run until that date. Any experiments and personalizations still active on that date will end.</p>

  <p>We launched Google Optimize over 5 years ago to enable businesses of all sizes to easily test and improve your user experiences. We remain committed to enabling businesses of all sizes to improve your user experiences and are investing in third-party A/B testing integrations for Google Analytics 4.”</p>
</blockquote>

<p>by  <a href="https://support.google.com/optimize/answer/12979939?hl=en">Google Resource Hub</a></p>

<h1 id="1-introduction">1. Introduction</h1>

<h2 id="11-why-i-think-of-google-optimize-as-risky">1.1. Why I Think of Google Optimize as Risky</h2>

<p>A/B testing is one of the most important growth methodologies in growth hacking. However, unfortunately, many startups do not have an independent A/B testing environment. As a result, many companies utilize A/B testing tools such as Amplitude’s Experiment feature, Optimizely, and Google’s Optimize. In the case of Google Optimize, which I am most familiar with, as shown in the image below, it only displays analysis results in a simple one-dimensional view.</p>

<p><img src="/assets/2023-06-04-overcoming-google-optimize/google-optimize.webp" alt="" /></p>
<blockquote>
  <p>Is that enough to analyze for your A/B test, indeed?</p>
</blockquote>

<p>Deriving A/B test results solely based on such one-dimensional outcomes can pose significant risks.</p>

<p>Especially according to Chapter 6 of  <a href="https://www.oreilly.com/library/view/product-analytics-applied/9780135258644/">Product Analytics by Joanne Rodrigues</a>, the following pitfalls can occur in A/B testing:</p>

<ol>
  <li>Even if there is no significant difference between the experimental group and the control group, there may be significant differences among specific subgroups, such as gender group, age group, country group, etc.</li>
  <li>In terms of CTR (Click-through rate), Group A may be less than B. However, in terms of subsequent page actions or retention, Group A may be greater than B, as well.</li>
</ol>

<p>Additionally, based on my personal investigation, there seemed to be a limitation where users who were assigned to the A/B test, ended their session normally, and made a purchase through a different path rather than the experimental exposure page, did not appear properly on the Google Optimize dashboard.</p>

<p>In conclusion, it feels difficult to trust the Google Optimize dashboard, and relying on it to brief analysis results seems prone to errors.</p>

<h2 id="12-google-analytics-4-may-offer-improvements-in-this-regard-but-it-can-be-quite-cumbersome">1.2. Google Analytics 4 May Offer Improvements in This Regard, But It Can be Quite Cumbersome.</h2>

<p>Experiment data from Google Optimize is transferred to Google Analytics 4, and when pre-defined audience settings are in place, it allows for the exploration of users from various perspectives within the Explore feature.</p>

<p><img src="/assets/2023-06-04-overcoming-google-optimize/ga4-explore.webp" alt="" /></p>
<blockquote>
  <p>Imagine that you click and drag here and there every time you should analyze a series of A/B tests.</p>
</blockquote>

<p>However, repeatedly using such exploration features and finding insights within specific subgroups can be very time-consuming. While this level of analysis may be sufficient when conducting A/B tests only once, it becomes time-consuming when the tests need to be repeated multiple times.</p>

<h2 id="13-how-your-ab-test-data-is-loaded-into-bigquery">1.3. How Your A/B Test Data is Loaded Into BigQuery</h2>

<p>In the environment of our company where we conduct A/B tests at least once a week, I have decided to create an automated analysis tool using BigQuery and Python to minimize the time spent on A/B test analysis.</p>

<p>The flow of A/B test data executed in Google Optimize is roughly as follows:</p>

<p><img src="/assets/2023-06-04-overcoming-google-optimize/flowchart.webp" alt="" /></p>
<blockquote>
  <p>The flow of A/B test data executed in Google Optimize</p>
</blockquote>

<p>The  <code class="language-plaintext highlighter-rouge">experiment_impression</code>  event generated in Google Analytics 4 is loaded into BigQuery as follows.</p>

<p>Event Parameters of <code class="language-plaintext highlighter-rouge">experiment_impression</code></p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">experiment_id</code>: It signifies which experiment the user was exposed to. (You can find the unique ID of each experiment on the Google Optimize management page.)</li>
  <li><code class="language-plaintext highlighter-rouge">variant_id</code>: It signifies which group the user was assigned to within that experiment. It is represented by values in the format of  <code class="language-plaintext highlighter-rouge">experiment_id.{index}</code>, where 0, 1, 2, etc., indicate assignment to Group A, Group B, Group C, and so on in sequential order.</li>
</ul>

<p><img src="/assets/2023-06-04-overcoming-google-optimize/bigquery.webp" alt="" /></p>
<blockquote>
  <p>The <code class="language-plaintext highlighter-rouge">experiment_impression</code> event and its parameters in BigQuery</p>
</blockquote>

<h1 id="2-to-connect-python-with-bigquery">2. To Connect Python with BigQuery</h1>

<h2 id="21-load-libraries">2.1. Load Libraries</h2>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">### Basics
</span><span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="n">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="kn">import</span> <span class="n">warnings</span>
<span class="n">warnings</span><span class="p">.</span><span class="nf">filterwarnings</span><span class="p">(</span><span class="sh">'</span><span class="s">ignore</span><span class="sh">'</span><span class="p">)</span>

<span class="c1">### Connector to BigQuery
</span><span class="kn">from</span> <span class="n">google.cloud</span> <span class="kn">import</span> <span class="n">bigquery</span>
<span class="kn">from</span> <span class="n">google.oauth2</span> <span class="kn">import</span> <span class="n">service_account</span>

<span class="c1">### A/B Test Analytics Libraries
</span><span class="kn">import</span> <span class="n">scipy.stats</span> <span class="k">as</span> <span class="n">stats</span>
<span class="kn">from</span> <span class="n">scipy.stats</span> <span class="kn">import</span> <span class="n">chi2_contingency</span>
<span class="kn">from</span> <span class="n">statsmodels.stats</span> <span class="kn">import</span> <span class="n">proportion</span>

<span class="c1">### Data Viz
</span><span class="kn">import</span> <span class="n">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">import</span> <span class="n">seaborn</span> <span class="k">as</span> <span class="n">sns</span>
<span class="o">%</span><span class="n">matplotlib</span> <span class="n">inline</span>
</code></pre></div></div>

<h2 id="22-connect-to-bigquery">2.2. Connect to Bigquery</h2>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">FOLDERPATH</span> <span class="o">=</span> <span class="sh">'</span><span class="s">/xxxxxxxxxxxxxxxxxx/config</span><span class="sh">'</span>  
<span class="n">KEY_NAME</span> <span class="o">=</span> <span class="sh">'</span><span class="s">xxxxxxxxxxxxxxxxx.json</span><span class="sh">'</span>  
<span class="n">KEY_PATH</span> <span class="o">=</span> <span class="n">FOLDERPATH</span> <span class="o">+</span> <span class="sh">'</span><span class="s">/</span><span class="sh">'</span> <span class="o">+</span> <span class="n">KEY_NAME</span>  

<span class="n">CREDENTIALS</span> <span class="o">=</span> <span class="n">service_account</span><span class="p">.</span><span class="n">Credentials</span><span class="p">.</span><span class="nf">from_service_account_file</span><span class="p">(</span><span class="n">KEY_PATH</span><span class="p">)</span>  
  
<span class="n">client</span> <span class="o">=</span> <span class="n">bigquery</span><span class="p">.</span><span class="nc">Client</span><span class="p">(</span>  
    <span class="n">credentials</span> <span class="o">=</span> <span class="n">CREDENTIALS</span><span class="p">,</span>  
    <span class="n">project</span> <span class="o">=</span> <span class="n">CREDENTIALS</span><span class="p">.</span><span class="n">project_id</span>  
<span class="p">)</span>
</code></pre></div></div>

<p>To connect with BigQuery, you need to create a service account within your BigQuery project and obtain the necessary credentials.</p>

<p>For detailed instructions, please refer to  <a href="https://cloud.google.com/bigquery/docs/authentication/service-account-file?hl=en#python">this guide</a>. It provides step-by-step instructions on how to create a service account and obtain the required credentials for accessing BigQuery.</p>

<h2 id="23-enter-the-basic-experiment-info">2.3. Enter the Basic Experiment Info</h2>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">EXPERIMENT_ID</span> <span class="o">=</span> <span class="sh">'</span><span class="s">abc123ABC123</span><span class="sh">'</span>  
<span class="n">START_DATE</span><span class="p">,</span> <span class="n">END_DATE</span> <span class="o">=</span> <span class="sh">'</span><span class="s">2023-01-01</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">2023-01-31</span><span class="sh">'</span>  
<span class="n">CONFIDENCE_LEVEL</span> <span class="o">=</span> <span class="mf">0.95</span>  
<span class="n">ALPHA</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">CONFIDENCE_LEVEL</span>
</code></pre></div></div>

<p>Please provide the  <code class="language-plaintext highlighter-rouge">EXPERIMENT_ID</code>  of the Google Optimize experiment you wish to analyze.</p>

<p>Please enter the experiment duration by specifying the  <code class="language-plaintext highlighter-rouge">START_DATE</code>  and  <code class="language-plaintext highlighter-rouge">END_DATE</code>  in the format of YYYY-MM-DD.</p>
<ul>
  <li>Note: It typically takes around 1.5 days for all data to be transferred from Google Optimize to GA4 and then to BigQuery. Therefore, it is recommended to wait for approximately 1–2 days after the experiment ends before starting the analysis. This will allow sufficient time for the data to be fully available for analysis.</li>
</ul>

<h1 id="3-extracting-data">3. Extracting Data</h1>

<h2 id="31-purchase-conversion-rate">3.1. Purchase Conversion Rate</h2>

<p><strong>Full Codes</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">SQL</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"""</span><span class="s">  
  
WITH  
CTE_raw AS (  
    SELECT
        *  
    FROM 
        `xxxxxxxxxxxxxxxxxxxx.events_*`  
    WHERE  
        _table_suffix BETWEEN 
            FORMAT_DATE(</span><span class="sh">'</span><span class="s">%Y%m%d</span><span class="sh">'</span><span class="s">, </span><span class="sh">'</span><span class="si">{</span><span class="n">START_DATE</span><span class="si">}</span><span class="sh">'</span><span class="s">) 
            AND FORMAT_DATE(</span><span class="sh">'</span><span class="s">%Y%m%d</span><span class="sh">'</span><span class="s">, </span><span class="sh">'</span><span class="si">{</span><span class="n">END_DATE</span><span class="si">}</span><span class="sh">'</span><span class="s">)  
        AND user_pseudo_ID IS NOT NULL  
),  

CTE_users_assigned AS (  
    SELECT  
        user_pseudo_id,  
        CASE  
            WHEN ENDS_WITH(assigned_params.value.string_value, </span><span class="sh">'</span><span class="s">.0</span><span class="sh">'</span><span class="s">) THEN </span><span class="sh">'</span><span class="s">A</span><span class="sh">'</span><span class="s">  
            WHEN ENDS_WITH(assigned_params.value.string_value, </span><span class="sh">'</span><span class="s">.1</span><span class="sh">'</span><span class="s">) THEN </span><span class="sh">'</span><span class="s">B</span><span class="sh">'</span><span class="s">  
        END AS test_group,  
        MIN(event_timestamp) AS assigned_timestamp  
    FROM
        CTE_raw  
    CROSS JOIN 
        UNNEST (event_params) AS assigned_params  
    WHERE  
        event_name = </span><span class="sh">'</span><span class="s">experiment_impression</span><span class="sh">'</span><span class="s">  
        AND assigned_params.key = </span><span class="sh">'</span><span class="s">variant_id</span><span class="sh">'</span><span class="s">  
        AND STARTS_WITH(assigned_params.value.string_value, </span><span class="sh">'</span><span class="si">{</span><span class="n">EXPERIMENT_ID</span><span class="si">}</span><span class="sh">'</span><span class="s">) = True  
    GROUP BY 
        test_group, user_pseudo_id  
    ORDER BY 
        test_group, user_pseudo_id  
),  

CTE_users_purchased AS (  
    SELECT  
        user_pseudo_id,  
        event_timestamp AS purchase_timestamp   
    FROM 
        CTE_raw  
    WHERE  
        event_name = </span><span class="sh">'</span><span class="s">purchase</span><span class="sh">'</span><span class="s">  
    ORDER BY  
        purchase_timestamp, user_pseudo_id  
),  

CTE_users_purchased_assigned_only AS (  
    SELECT  
        DISTINCT A.user_pseudo_id  
    FROM 
        CTE_users_purchased A  
    LEFT JOIN 
        CTE_users_assigned B  
        ON A.user_pseudo_id = B.user_pseudo_id  
        AND A.purchase_timestamp &gt;= B.assigned_timestamp  
    WHERE  
        B.user_pseudo_id IS NOT NULL
        AND B.assigned_timestamp IS NOT NULL  
    ORDER BY 
        user_pseudo_id  
),  

CTE_users_purchase_cvr_group AS (  
    SELECT  
        A.user_pseudo_id,  
        A.test_group,  
        CASE  
            WHEN B.user_pseudo_id IS NOT NULL THEN 1  
            ELSE 0  
        END AS purchase  
    FROM 
        CTE_users_assigned A  
    LEFT JOIN 
        CTE_users_purchased_assigned_only B  
        ON A.user_pseudo_id = B.user_pseudo_id  
    ORDER BY 
        A.test_group, purchase DESC, A.user_pseudo_id      
)  

SELECT 
    * 
FROM 
    CTE_users_purchase_cvr_group
;
  
</span><span class="sh">"""</span>  

<span class="n">results</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="nf">query</span><span class="p">(</span><span class="n">SQL</span><span class="p">)</span>  
<span class="n">purchase_cvr_df</span> <span class="o">=</span> <span class="n">results</span><span class="p">.</span><span class="nf">to_dataframe</span><span class="p">()</span>
</code></pre></div></div>

<p>Feeling overwhelmed by all the code snippets? Don’t worry. I’ll guide you through each code snippet and explain what it means.</p>

<p><strong>1. Extract all events that occurred during the experiment period.</strong></p>
<ul>
  <li>Since  <code class="language-plaintext highlighter-rouge">START_DATE</code>  and  <code class="language-plaintext highlighter-rouge">END_DATE</code>  have already been defined earlier, let’s input the variables themselves.</li>
</ul>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">WITH</span>  
<span class="n">CTE_raw</span> <span class="k">AS</span> <span class="p">(</span>  
    <span class="k">SELECT</span>
        <span class="o">*</span>  
    <span class="k">FROM</span> 
        <span class="nv">`xxxxxxxxxxxxxxxxxxxx.events_*`</span>  
    <span class="k">WHERE</span>  
        <span class="n">_table_suffix</span> <span class="k">BETWEEN</span> 
            <span class="n">FORMAT_DATE</span><span class="p">(</span><span class="s1">'%Y%m%d'</span><span class="p">,</span> <span class="s1">'{START_DATE}'</span><span class="p">)</span> 
            <span class="k">AND</span> <span class="n">FORMAT_DATE</span><span class="p">(</span><span class="s1">'%Y%m%d'</span><span class="p">,</span> <span class="s1">'{END_DATE}'</span><span class="p">)</span>  
        <span class="k">AND</span> <span class="n">user_pseudo_ID</span> <span class="k">IS</span> <span class="k">NOT</span> <span class="k">NULL</span>  
<span class="p">),</span>
</code></pre></div></div>

<p><strong>2. Extract information on which group each user was assigned to in the experiment and when they were initially assigned.</strong></p>
<ul>
  <li>Reason for including the initially assigned timestamp (<code class="language-plaintext highlighter-rouge">assigned_timestamp</code>) in the extraction: It is important to understand what actions users take after being assigned to the experiment, focusing on the actions that occur after the assignment. By excluding the pre-assignment actions, we establish a foundation for observing the causal relationship in A/B testing. Therefore, it is crucial to only observe the actions taken after the experiment assignment.</li>
</ul>

<table>
  <thead>
    <tr>
      <th><strong>Example Results</strong></th>
      <th> </th>
      <th> </th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Joshua</td>
      <td>A</td>
      <td>2023-01-02</td>
    </tr>
    <tr>
      <td>Meghan</td>
      <td>B</td>
      <td>2023-01-05</td>
    </tr>
    <tr>
      <td>Andrew</td>
      <td>A</td>
      <td>2023-01-04</td>
    </tr>
    <tr>
      <td>…</td>
      <td>…</td>
      <td>…</td>
    </tr>
  </tbody>
</table>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">CTE_users_assigned</span> <span class="k">AS</span> <span class="p">(</span>  
    <span class="k">SELECT</span>  
        <span class="n">user_pseudo_id</span><span class="p">,</span>  
        <span class="k">CASE</span>  
            <span class="k">WHEN</span> <span class="n">ENDS_WITH</span><span class="p">(</span><span class="n">assigned_params</span><span class="p">.</span><span class="n">value</span><span class="p">.</span><span class="n">string_value</span><span class="p">,</span> <span class="s1">'.0'</span><span class="p">)</span> <span class="k">THEN</span> <span class="s1">'A'</span>  
            <span class="k">WHEN</span> <span class="n">ENDS_WITH</span><span class="p">(</span><span class="n">assigned_params</span><span class="p">.</span><span class="n">value</span><span class="p">.</span><span class="n">string_value</span><span class="p">,</span> <span class="s1">'.1'</span><span class="p">)</span> <span class="k">THEN</span> <span class="s1">'B'</span>  
        <span class="k">END</span> <span class="k">AS</span> <span class="n">test_group</span><span class="p">,</span>  
        <span class="k">MIN</span><span class="p">(</span><span class="n">event_timestamp</span><span class="p">)</span> <span class="k">AS</span> <span class="n">assigned_timestamp</span>  
    <span class="k">FROM</span>
        <span class="n">CTE_raw</span>  
    <span class="k">CROSS</span> <span class="k">JOIN</span> 
        <span class="k">UNNEST</span> <span class="p">(</span><span class="n">event_params</span><span class="p">)</span> <span class="k">AS</span> <span class="n">assigned_params</span>  
    <span class="k">WHERE</span>  
        <span class="n">event_name</span> <span class="o">=</span> <span class="s1">'experiment_impression'</span>  
        <span class="k">AND</span> <span class="n">assigned_params</span><span class="p">.</span><span class="k">key</span> <span class="o">=</span> <span class="s1">'variant_id'</span>  
        <span class="k">AND</span> <span class="n">STARTS_WITH</span><span class="p">(</span><span class="n">assigned_params</span><span class="p">.</span><span class="n">value</span><span class="p">.</span><span class="n">string_value</span><span class="p">,</span> <span class="s1">'{EXPERIMENT_ID}'</span><span class="p">)</span> <span class="o">=</span> <span class="k">True</span>  
    <span class="k">GROUP</span> <span class="k">BY</span> 
        <span class="n">test_group</span><span class="p">,</span> <span class="n">user_pseudo_id</span>  
    <span class="k">ORDER</span> <span class="k">BY</span> 
        <span class="n">test_group</span><span class="p">,</span> <span class="n">user_pseudo_id</span>  
<span class="p">),</span> 
</code></pre></div></div>

<p><strong>3. Extract all users who completed a purchase during the experiment period.</strong></p>
<ul>
  <li>This is still prior to extracting only the users exposed to the experiment. Don’t worry, we’ll get there.</li>
</ul>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">CTE_users_purchased</span> <span class="k">AS</span> <span class="p">(</span>  
    <span class="k">SELECT</span>  
        <span class="n">user_pseudo_id</span><span class="p">,</span>  
        <span class="n">event_timestamp</span> <span class="k">AS</span> <span class="n">purchase_timestamp</span>   
    <span class="k">FROM</span> 
        <span class="n">CTE_raw</span>  
    <span class="k">WHERE</span>  
        <span class="n">event_name</span> <span class="o">=</span> <span class="s1">'purchase'</span>  
    <span class="k">ORDER</span> <span class="k">BY</span>  
        <span class="n">purchase_timestamp</span><span class="p">,</span> <span class="n">user_pseudo_id</span>  
<span class="p">),</span>  
</code></pre></div></div>

<p><strong>4. Re-extract only the users exposed to the experiment from <code class="language-plaintext highlighter-rouge">CTE_users_purchased</code>.</strong></p>

<ul>
  <li><strong>Condition 1)</strong> The  <code class="language-plaintext highlighter-rouge">user_pseudo_id</code>  must match the assigned  <code class="language-plaintext highlighter-rouge">user_pseudo_id</code>  in the experiment.</li>
  <li><strong>Condition 2)</strong> The  <code class="language-plaintext highlighter-rouge">assigned_timestamp</code>  in the experiment must be earlier than the  <code class="language-plaintext highlighter-rouge">purchase_timestamp</code>.</li>
</ul>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">CTE_users_purchased_assigned_only</span> <span class="k">AS</span> <span class="p">(</span>  
    <span class="k">SELECT</span>  
        <span class="k">DISTINCT</span> <span class="n">A</span><span class="p">.</span><span class="n">user_pseudo_id</span>  
    <span class="k">FROM</span> 
        <span class="n">CTE_users_purchased</span> <span class="n">A</span>  
    <span class="k">LEFT</span> <span class="k">JOIN</span> 
        <span class="n">CTE_users_assigned</span> <span class="n">B</span>  
        <span class="k">ON</span> <span class="n">A</span><span class="p">.</span><span class="n">user_pseudo_id</span> <span class="o">=</span> <span class="n">B</span><span class="p">.</span><span class="n">user_pseudo_id</span>  
        <span class="k">AND</span> <span class="n">A</span><span class="p">.</span><span class="n">purchase_timestamp</span> <span class="o">&gt;=</span> <span class="n">B</span><span class="p">.</span><span class="n">assigned_timestamp</span>  
    <span class="k">WHERE</span>  
        <span class="n">B</span><span class="p">.</span><span class="n">user_pseudo_id</span> <span class="k">IS</span> <span class="k">NOT</span> <span class="k">NULL</span>
        <span class="k">AND</span> <span class="n">B</span><span class="p">.</span><span class="n">assigned_timestamp</span> <span class="k">IS</span> <span class="k">NOT</span> <span class="k">NULL</span>  
    <span class="k">ORDER</span> <span class="k">BY</span> 
        <span class="n">user_pseudo_id</span>  
<span class="p">),</span>  
</code></pre></div></div>

<p><strong>5. Extract the assigned group and the purchase conversion of the users assigned to the experiment simultaneously.</strong></p>

<table>
  <thead>
    <tr>
      <th><strong>Example Results</strong></th>
      <th> </th>
      <th> </th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Joshua</td>
      <td>A</td>
      <td>1</td>
    </tr>
    <tr>
      <td>Meghan</td>
      <td>B</td>
      <td>0</td>
    </tr>
    <tr>
      <td>Andrew</td>
      <td>A</td>
      <td>1</td>
    </tr>
    <tr>
      <td>…</td>
      <td>…</td>
      <td>…</td>
    </tr>
  </tbody>
</table>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">CTE_users_purchase_cvr_group</span> <span class="k">AS</span> <span class="p">(</span>  
    <span class="k">SELECT</span>  
        <span class="n">A</span><span class="p">.</span><span class="n">user_pseudo_id</span><span class="p">,</span>  
        <span class="n">A</span><span class="p">.</span><span class="n">test_group</span><span class="p">,</span>  
        <span class="k">CASE</span>  
            <span class="k">WHEN</span> <span class="n">B</span><span class="p">.</span><span class="n">user_pseudo_id</span> <span class="k">IS</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">THEN</span> <span class="mi">1</span>  
            <span class="k">ELSE</span> <span class="mi">0</span>  
        <span class="k">END</span> <span class="k">AS</span> <span class="n">purchase</span>  
    <span class="k">FROM</span> 
        <span class="n">CTE_users_assigned</span> <span class="n">A</span>  
    <span class="k">LEFT</span> <span class="k">JOIN</span> 
        <span class="n">CTE_users_purchased_assigned_only</span> <span class="n">B</span>  
        <span class="k">ON</span> <span class="n">A</span><span class="p">.</span><span class="n">user_pseudo_id</span> <span class="o">=</span> <span class="n">B</span><span class="p">.</span><span class="n">user_pseudo_id</span>  
    <span class="k">ORDER</span> <span class="k">BY</span> 
        <span class="n">A</span><span class="p">.</span><span class="n">test_group</span><span class="p">,</span> <span class="n">purchase</span> <span class="k">DESC</span><span class="p">,</span> <span class="n">A</span><span class="p">.</span><span class="n">user_pseudo_id</span>      
<span class="p">)</span>

<span class="k">SELECT</span> 
    <span class="o">*</span> 
<span class="k">FROM</span> 
    <span class="n">CTE_users_purchase_cvr_group</span>
<span class="p">;</span>
</code></pre></div></div>

<p><strong>6. Store the final extracted table as a Pandas DataFrame named <code class="language-plaintext highlighter-rouge">purchase_cvr_df</code>.</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">results</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="nf">query</span><span class="p">(</span><span class="n">SQL</span><span class="p">)</span>  
<span class="n">purchase_cvr_df</span> <span class="o">=</span> <span class="n">results</span><span class="p">.</span><span class="nf">to_dataframe</span><span class="p">()</span>
</code></pre></div></div>

<h2 id="32-purchase-conversion-rate-by-country">3.2. Purchase Conversion Rate (by Country)</h2>

<p><strong>Full Codes</strong></p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">WITH</span>  
<span class="n">CTE_raw</span> <span class="k">AS</span> <span class="p">(</span>  
    <span class="k">SELECT</span> 
    <span class="o">*</span>  
    <span class="k">FROM</span> 
        <span class="nv">`xxxxxxxxxxxxxxxxxxxx.events_*`</span>  
    <span class="k">WHERE</span>  
        <span class="n">_table_suffix</span> <span class="k">BETWEEN</span> 
            <span class="n">FORMAT_DATE</span><span class="p">(</span><span class="s1">'%Y%m%d'</span><span class="p">,</span> <span class="s1">'{START_DATE}'</span><span class="p">)</span> 
            <span class="k">AND</span> <span class="n">FORMAT_DATE</span><span class="p">(</span><span class="s1">'%Y%m%d'</span><span class="p">,</span> <span class="s1">'{END_DATE}'</span><span class="p">)</span>  
        <span class="k">AND</span> <span class="n">user_pseudo_ID</span> <span class="k">IS</span> <span class="k">NOT</span> <span class="k">NULL</span>  
<span class="p">),</span>  

<span class="n">CTE_users_assigned</span> <span class="k">AS</span> <span class="p">(</span>  
    <span class="k">SELECT</span>  
        <span class="n">user_pseudo_id</span><span class="p">,</span>  
        <span class="n">geo</span><span class="p">.</span><span class="n">country</span><span class="p">,</span>  
        <span class="k">CASE</span>  
            <span class="k">WHEN</span> <span class="n">ENDS_WITH</span><span class="p">(</span><span class="n">assigned_params</span><span class="p">.</span><span class="n">value</span><span class="p">.</span><span class="n">string_value</span><span class="p">,</span> <span class="s1">'.0'</span><span class="p">)</span> <span class="k">THEN</span> <span class="s1">'A'</span>  
            <span class="k">WHEN</span> <span class="n">ENDS_WITH</span><span class="p">(</span><span class="n">assigned_params</span><span class="p">.</span><span class="n">value</span><span class="p">.</span><span class="n">string_value</span><span class="p">,</span> <span class="s1">'.1'</span><span class="p">)</span> <span class="k">THEN</span> <span class="s1">'B'</span>  
        <span class="k">END</span> <span class="k">AS</span> <span class="n">test_group</span><span class="p">,</span>  
        <span class="k">MIN</span><span class="p">(</span><span class="n">event_timestamp</span><span class="p">)</span> <span class="k">AS</span> <span class="n">assigned_timestamp</span>  
    <span class="k">FROM</span> 
        <span class="n">CTE_raw</span>  
    <span class="k">CROSS</span> <span class="k">JOIN</span> 
        <span class="k">UNNEST</span> <span class="p">(</span><span class="n">event_params</span><span class="p">)</span> <span class="k">AS</span> <span class="n">assigned_params</span>  
    <span class="k">WHERE</span>  
        <span class="n">event_name</span> <span class="o">=</span> <span class="s1">'experiment_impression'</span>  
        <span class="k">AND</span> <span class="n">assigned_params</span><span class="p">.</span><span class="k">key</span> <span class="o">=</span> <span class="s1">'variant_id'</span>  
        <span class="k">AND</span> <span class="n">STARTS_WITH</span><span class="p">(</span><span class="n">assigned_params</span><span class="p">.</span><span class="n">value</span><span class="p">.</span><span class="n">string_value</span><span class="p">,</span> <span class="s1">'{EXPERIMENT_ID}'</span><span class="p">)</span> <span class="o">=</span> <span class="k">True</span>  
    <span class="k">GROUP</span> <span class="k">BY</span> 
        <span class="n">test_group</span><span class="p">,</span> <span class="n">geo</span><span class="p">.</span><span class="n">country</span><span class="p">,</span> <span class="n">user_pseudo_id</span>  
    <span class="k">ORDER</span> <span class="k">BY</span> 
        <span class="n">test_group</span><span class="p">,</span> <span class="n">geo</span><span class="p">.</span><span class="n">country</span><span class="p">,</span> <span class="n">user_pseudo_id</span>  
<span class="p">),</span>  

<span class="n">CTE_users_purchased</span> <span class="k">AS</span> <span class="p">(</span>  
    <span class="k">SELECT</span>  
        <span class="n">user_pseudo_id</span><span class="p">,</span>  
        <span class="n">geo</span><span class="p">.</span><span class="n">country</span><span class="p">,</span>  
        <span class="n">event_timestamp</span> <span class="k">AS</span> <span class="n">purchase_timestamp</span>  
    <span class="k">FROM</span> 
        <span class="n">CTE_raw</span>  
    <span class="k">WHERE</span>  
        <span class="n">event_name</span> <span class="o">=</span> <span class="s1">'purchase'</span>  
    <span class="k">ORDER</span> <span class="k">BY</span> 
        <span class="n">purchase_timestamp</span><span class="p">,</span> <span class="n">geo</span><span class="p">.</span><span class="n">country</span><span class="p">,</span> <span class="n">user_pseudo_id</span>  
<span class="p">),</span>  

<span class="n">CTE_users_purchased_assigned_only</span> <span class="k">AS</span> <span class="p">(</span>  
    <span class="k">SELECT</span>  
        <span class="k">DISTINCT</span> <span class="n">A</span><span class="p">.</span><span class="n">user_pseudo_id</span><span class="p">,</span> <span class="n">A</span><span class="p">.</span><span class="n">country</span>  
    <span class="k">FROM</span> 
        <span class="n">CTE_users_purchased</span> <span class="n">A</span>  
    <span class="k">LEFT</span> <span class="k">JOIN</span> 
        <span class="n">CTE_users_assigned</span> <span class="n">B</span>  
        <span class="k">ON</span> <span class="n">A</span><span class="p">.</span><span class="n">user_pseudo_id</span> <span class="o">=</span> <span class="n">B</span><span class="p">.</span><span class="n">user_pseudo_id</span>  
        <span class="k">AND</span> <span class="n">A</span><span class="p">.</span><span class="n">country</span> <span class="o">=</span> <span class="n">B</span><span class="p">.</span><span class="n">country</span>  
        <span class="k">AND</span> <span class="n">A</span><span class="p">.</span><span class="n">purchase_timestamp</span> <span class="o">&gt;=</span> <span class="n">B</span><span class="p">.</span><span class="n">assigned_timestamp</span>  
    <span class="k">WHERE</span>  
        <span class="n">B</span><span class="p">.</span><span class="n">user_pseudo_id</span> <span class="k">IS</span> <span class="k">NOT</span> <span class="k">NULL</span> 
        <span class="k">AND</span> <span class="n">B</span><span class="p">.</span><span class="n">assigned_timestamp</span> <span class="k">IS</span> <span class="k">NOT</span> <span class="k">NULL</span>  
    <span class="k">ORDER</span> <span class="k">BY</span> 
        <span class="n">A</span><span class="p">.</span><span class="n">country</span><span class="p">,</span> <span class="n">user_pseudo_id</span>  
<span class="p">),</span>  

<span class="n">CTE_users_purchase_cvr_group</span> <span class="k">AS</span> <span class="p">(</span>  
    <span class="k">SELECT</span>  
        <span class="n">A</span><span class="p">.</span><span class="n">user_pseudo_id</span><span class="p">,</span>  
        <span class="n">A</span><span class="p">.</span><span class="n">country</span><span class="p">,</span>  
        <span class="n">A</span><span class="p">.</span><span class="n">test_group</span><span class="p">,</span>  
        <span class="k">CASE</span>  
            <span class="k">WHEN</span> <span class="n">B</span><span class="p">.</span><span class="n">user_pseudo_id</span> <span class="k">IS</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">THEN</span> <span class="mi">1</span>  
            <span class="k">ELSE</span> <span class="mi">0</span>  
        <span class="k">END</span> <span class="k">AS</span> <span class="n">purchase</span>  
    <span class="k">FROM</span> 
        <span class="n">CTE_users_assigned</span> <span class="n">A</span>  
    <span class="k">LEFT</span> <span class="k">JOIN</span> 
        <span class="n">CTE_users_purchased_assigned_only</span> <span class="n">B</span>  
        <span class="k">ON</span> <span class="n">A</span><span class="p">.</span><span class="n">user_pseudo_id</span> <span class="o">=</span> <span class="n">B</span><span class="p">.</span><span class="n">user_pseudo_id</span>  
        <span class="k">AND</span> <span class="n">A</span><span class="p">.</span><span class="n">country</span> <span class="o">=</span> <span class="n">B</span><span class="p">.</span><span class="n">country</span>   
    <span class="k">ORDER</span> <span class="k">BY</span> 
        <span class="n">A</span><span class="p">.</span><span class="n">test_group</span><span class="p">,</span> <span class="n">purchase</span> <span class="k">DESC</span><span class="p">,</span> <span class="n">A</span><span class="p">.</span><span class="n">user_pseudo_id</span>  
<span class="p">)</span>  

<span class="k">SELECT</span> 
    <span class="o">*</span> 
<span class="k">FROM</span> 
    <span class="n">CTE_users_purchase_cvr_group</span>
<span class="p">;</span>
</code></pre></div></div>

<p>Everything is the same as I have guided you previously, except for the <code class="language-plaintext highlighter-rouge">geo.country</code> for grouping the users by their countries.</p>

<h2 id="33-average-revenue-per-user">3.3. Average Revenue per User</h2>

<p><strong>Full Codes</strong></p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SQL</span> <span class="o">=</span> <span class="nv">"</span><span class="se">""</span><span class="nv">

WITH  
CTE_raw AS (  
    SELECT 
        *  
    FROM 
        `xxxxxxxxxxxxxxxxxxxx.events_*`  
    WHERE  
        _table_suffix BETWEEN 
            FORMAT_DATE('%Y%m%d', '{START_DATE}') 
            AND FORMAT_DATE('%Y%m%d', '{END_DATE}')  
        AND user_pseudo_ID IS NOT NULL  
),  

CTE_users_assigned AS (  
    SELECT  
        user_pseudo_id,  
        CASE  
            WHEN ENDS_WITH(assigned_params.value.string_value, '.0') THEN 'A'  
            WHEN ENDS_WITH(assigned_params.value.string_value, '.1') THEN 'B'  
        END AS test_group,  
        MIN(event_timestamp) AS assigned_timestamp  
    FROM 
        CTE_raw  
    CROSS JOIN 
        UNNEST (event_params) AS assigned_params  
    WHERE  
        event_name = 'experiment_impression'  
        AND assigned_params.key = 'variant_id'  
        AND STARTS_WITH(assigned_params.value.string_value, '{EXPERIMENT_ID}') = True  
    GROUP BY 
        test_group, user_pseudo_id  
    ORDER BY 
        test_group, user_pseudo_id  
),  

CTE_txids_revenue AS (  
    SELECT  
        ecommerce.transaction_id AS txid,  
        user_pseudo_id,  
        event_timestamp AS purchase_timestamp,  
        ecommerce.purchase_revenue_in_usd AS revenue  
    FROM 
        CTE_raw  
    WHERE  
        event_name = 'purchase'  
    ORDER BY 
        revenue DESC, txid, user_pseudo_id  
),  

CTE_txids_revenue_assigned_only AS (  
    SELECT  
        A.txid,  
        A.user_pseudo_id,  
        A.purchase_timestamp,  
        A.revenue  
    FROM 
        CTE_txids_revenue A  
    LEFT JOIN 
        CTE_users_assigned B  
        ON A.user_pseudo_id = B.user_pseudo_id  
        AND A.purchase_timestamp &gt;= B.assigned_timestamp  
    WHERE  
        B.user_pseudo_id IS NOT NULL 
        AND B.assigned_timestamp IS NOT NULL  
),  

CTE_users_revenue AS (  
    SELECT  
        user_pseudo_id,  
        SUM(revenue) AS revenue_usd  
    FROM 
        CTE_txids_revenue_assigned_only  
    GROUP BY 
        user_pseudo_id  
    ORDER BY 
        revenue_usd DESC  
),  

CTE_users_arpu_group AS (  
    SELECT  
        A.user_pseudo_id,  
        A.test_group,  
        CASE  
            WHEN B.revenue_usd IS NOT NULL THEN B.revenue_usd  
            ELSE 0  
        END AS revenue_usd  
    FROM 
        CTE_users_assigned A  
    LEFT JOIN 
        CTE_users_revenue B  
        ON A.user_pseudo_id = B.user_pseudo_id  
    ORDER BY 
        A.test_group, B.revenue_usd DESC, A.user_pseudo_id  
)  

SELECT 
    * 
FROM 
    CTE_users_arpu_group
;

</span><span class="se">""</span><span class="nv">"</span>

<span class="n">results</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">query</span><span class="p">(</span><span class="k">SQL</span><span class="p">)</span>  
<span class="n">arpu_df</span> <span class="o">=</span> <span class="n">results</span><span class="p">.</span><span class="n">to_dataframe</span><span class="p">()</span>
</code></pre></div></div>

<p>Feeling overwhelmed by all the code snippets? Don’t worry. I’ll guide you through each code snippet and explain what it means.</p>

<p><strong>1. Extract all events that occurred during the experiment period.</strong></p>
<ul>
  <li>This is the same as we already discussed earlier in the <strong>“Purchase Conversion Rate”</strong>.</li>
</ul>

<p><strong>2. Extract information on which group each user was assigned to in the experiment and when they were initially assigned.</strong></p>
<ul>
  <li>This is the same as we already discussed earlier in the <strong>“Purchase Conversion Rate”</strong>.</li>
</ul>

<p><strong>3. Extract the <code class="language-plaintext highlighter-rouge">transaction_id</code>, <code class="language-plaintext highlighter-rouge">user_pseudo_id</code>, <code class="language-plaintext highlighter-rouge">purchase_timestamp</code>, and <code class="language-plaintext highlighter-rouge">revenue</code> for each transaction during the experiment period.</strong></p>
<ul>
  <li>This is still prior to extracting only the users exposed to the experiment. Don’t worry, we’ll get there.</li>
</ul>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">CTE_txids_revenue</span> <span class="k">AS</span> <span class="p">(</span>  
    <span class="k">SELECT</span>  
        <span class="n">ecommerce</span><span class="p">.</span><span class="n">transaction_id</span> <span class="k">AS</span> <span class="n">txid</span><span class="p">,</span>  
        <span class="n">user_pseudo_id</span><span class="p">,</span>  
        <span class="n">event_timestamp</span> <span class="k">AS</span> <span class="n">purchase_timestamp</span><span class="p">,</span>  
        <span class="n">ecommerce</span><span class="p">.</span><span class="n">purchase_revenue_in_usd</span> <span class="k">AS</span> <span class="n">revenue</span>  
    <span class="k">FROM</span> 
        <span class="n">CTE_raw</span>  
    <span class="k">WHERE</span>  
        <span class="n">event_name</span> <span class="o">=</span> <span class="s1">'purchase'</span>  
    <span class="k">ORDER</span> <span class="k">BY</span> 
        <span class="n">revenue</span> <span class="k">DESC</span><span class="p">,</span> <span class="n">txid</span><span class="p">,</span> <span class="n">user_pseudo_id</span>  
<span class="p">),</span>  
</code></pre></div></div>

<p><strong>4. Re-extract only the users’ transactions exposed to the experiment from <code class="language-plaintext highlighter-rouge">CTE_txids_revenue</code>.</strong></p>
<ul>
  <li><strong>Condition 1)</strong> The  <code class="language-plaintext highlighter-rouge">user_pseudo_id</code>  must match the assigned  <code class="language-plaintext highlighter-rouge">user_pseudo_id</code>  in the experiment.</li>
  <li><strong>Condition 2)</strong> The  <code class="language-plaintext highlighter-rouge">assigned_timestamp</code>  in the experiment must be earlier than the  <code class="language-plaintext highlighter-rouge">purchase_timestamp</code>.</li>
</ul>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">CTE_txids_revenue_assigned_only</span> <span class="k">AS</span> <span class="p">(</span>  
    <span class="k">SELECT</span>  
        <span class="n">A</span><span class="p">.</span><span class="n">txid</span><span class="p">,</span>  
        <span class="n">A</span><span class="p">.</span><span class="n">user_pseudo_id</span><span class="p">,</span>  
        <span class="n">A</span><span class="p">.</span><span class="n">purchase_timestamp</span><span class="p">,</span>  
        <span class="n">A</span><span class="p">.</span><span class="n">revenue</span>  
    <span class="k">FROM</span> 
        <span class="n">CTE_txids_revenue</span> <span class="n">A</span>  
    <span class="k">LEFT</span> <span class="k">JOIN</span> 
        <span class="n">CTE_users_assigned</span> <span class="n">B</span>  
        <span class="k">ON</span> <span class="n">A</span><span class="p">.</span><span class="n">user_pseudo_id</span> <span class="o">=</span> <span class="n">B</span><span class="p">.</span><span class="n">user_pseudo_id</span>  
        <span class="k">AND</span> <span class="n">A</span><span class="p">.</span><span class="n">purchase_timestamp</span> <span class="o">&gt;=</span> <span class="n">B</span><span class="p">.</span><span class="n">assigned_timestamp</span>  
    <span class="k">WHERE</span>  
        <span class="n">B</span><span class="p">.</span><span class="n">user_pseudo_id</span> <span class="k">IS</span> <span class="k">NOT</span> <span class="k">NULL</span> 
        <span class="k">AND</span> <span class="n">B</span><span class="p">.</span><span class="n">assigned_timestamp</span> <span class="k">IS</span> <span class="k">NOT</span> <span class="k">NULL</span>  
<span class="p">),</span>  
</code></pre></div></div>

<p><strong>5. Represent the data at the user level instead of the transaction ID level.</strong></p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">CTE_users_revenue</span> <span class="k">AS</span> <span class="p">(</span>  
    <span class="k">SELECT</span>  
        <span class="n">user_pseudo_id</span><span class="p">,</span>  
        <span class="k">SUM</span><span class="p">(</span><span class="n">revenue</span><span class="p">)</span> <span class="k">AS</span> <span class="n">revenue_usd</span>  
    <span class="k">FROM</span> 
        <span class="n">CTE_txids_revenue_assigned_only</span>  
    <span class="k">GROUP</span> <span class="k">BY</span> 
        <span class="n">user_pseudo_id</span>  
    <span class="k">ORDER</span> <span class="k">BY</span> 
        <span class="n">revenue_usd</span> <span class="k">DESC</span>  
<span class="p">),</span>  
</code></pre></div></div>

<p><strong>6. Extract the assigned group and purchase amount of the users assigned to the experiment in a single query.</strong></p>

<table>
  <thead>
    <tr>
      <th><strong>Example Results</strong></th>
      <th> </th>
      <th> </th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Joshua</td>
      <td>A</td>
      <td>$100</td>
    </tr>
    <tr>
      <td>Meghan</td>
      <td>B</td>
      <td>$200</td>
    </tr>
    <tr>
      <td>Andrew</td>
      <td>A</td>
      <td>$300</td>
    </tr>
    <tr>
      <td>…</td>
      <td>…</td>
      <td>…</td>
    </tr>
  </tbody>
</table>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">CTE_users_arpu_group</span> <span class="k">AS</span> <span class="p">(</span>  
    <span class="k">SELECT</span>  
        <span class="n">A</span><span class="p">.</span><span class="n">user_pseudo_id</span><span class="p">,</span>  
        <span class="n">A</span><span class="p">.</span><span class="n">test_group</span><span class="p">,</span>  
        <span class="k">CASE</span>  
            <span class="k">WHEN</span> <span class="n">B</span><span class="p">.</span><span class="n">revenue_usd</span> <span class="k">IS</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">THEN</span> <span class="n">B</span><span class="p">.</span><span class="n">revenue_usd</span>  
            <span class="k">ELSE</span> <span class="mi">0</span>  
        <span class="k">END</span> <span class="k">AS</span> <span class="n">revenue_usd</span>  
    <span class="k">FROM</span> 
        <span class="n">CTE_users_assigned</span> <span class="n">A</span>  
    <span class="k">LEFT</span> <span class="k">JOIN</span> 
        <span class="n">CTE_users_revenue</span> <span class="n">B</span>  
        <span class="k">ON</span> <span class="n">A</span><span class="p">.</span><span class="n">user_pseudo_id</span> <span class="o">=</span> <span class="n">B</span><span class="p">.</span><span class="n">user_pseudo_id</span>  
    <span class="k">ORDER</span> <span class="k">BY</span> 
        <span class="n">A</span><span class="p">.</span><span class="n">test_group</span><span class="p">,</span> <span class="n">B</span><span class="p">.</span><span class="n">revenue_usd</span> <span class="k">DESC</span><span class="p">,</span> <span class="n">A</span><span class="p">.</span><span class="n">user_pseudo_id</span>  
<span class="p">)</span>  

<span class="k">SELECT</span> 
    <span class="o">*</span> 
<span class="k">FROM</span> 
    <span class="n">CTE_users_arpu_group</span>
<span class="p">;</span>
</code></pre></div></div>

<p><strong>7. Store the final extracted table as a Pandas DataFrame named <code class="language-plaintext highlighter-rouge">arpu_df</code>.</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">results</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="nf">query</span><span class="p">(</span><span class="n">SQL</span><span class="p">)</span>  
<span class="n">arpu_df</span> <span class="o">=</span> <span class="n">results</span><span class="p">.</span><span class="nf">to_dataframe</span><span class="p">()</span>
</code></pre></div></div>

<h2 id="34-average-revenue-per-user-by-country">3.4. Average Revenue per User (by Country)</h2>

<p><strong>Full Codes</strong></p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">WITH</span>  
<span class="n">CTE_raw</span> <span class="k">AS</span> <span class="p">(</span>  
    <span class="k">SELECT</span> 
        <span class="o">*</span>  
    <span class="k">FROM</span> 
        <span class="nv">`xxxxxxxxxxxxxxxxxxxx.events_*`</span>  
    <span class="k">WHERE</span>  
        <span class="n">_table_suffix</span> <span class="k">BETWEEN</span> 
            <span class="n">FORMAT_DATE</span><span class="p">(</span><span class="s1">'%Y%m%d'</span><span class="p">,</span> <span class="s1">'{START_DATE}'</span><span class="p">)</span> 
            <span class="k">AND</span> <span class="n">FORMAT_DATE</span><span class="p">(</span><span class="s1">'%Y%m%d'</span><span class="p">,</span> <span class="s1">'{END_DATE}'</span><span class="p">)</span>  
        <span class="k">AND</span> <span class="n">user_pseudo_ID</span> <span class="k">IS</span> <span class="k">NOT</span> <span class="k">NULL</span>  
<span class="p">),</span>  

<span class="n">CTE_users_assigned</span> <span class="k">AS</span> <span class="p">(</span>  
    <span class="k">SELECT</span>  
        <span class="n">user_pseudo_id</span><span class="p">,</span>  
        <span class="n">geo</span><span class="p">.</span><span class="n">country</span><span class="p">,</span>  
        <span class="k">CASE</span>  
            <span class="k">WHEN</span> <span class="n">ENDS_WITH</span><span class="p">(</span><span class="n">assigned_params</span><span class="p">.</span><span class="n">value</span><span class="p">.</span><span class="n">string_value</span><span class="p">,</span> <span class="s1">'.0'</span><span class="p">)</span> <span class="k">THEN</span> <span class="s1">'A'</span>  
            <span class="k">WHEN</span> <span class="n">ENDS_WITH</span><span class="p">(</span><span class="n">assigned_params</span><span class="p">.</span><span class="n">value</span><span class="p">.</span><span class="n">string_value</span><span class="p">,</span> <span class="s1">'.1'</span><span class="p">)</span> <span class="k">THEN</span> <span class="s1">'B'</span>  
        <span class="k">END</span> <span class="k">AS</span> <span class="n">test_group</span><span class="p">,</span>  
        <span class="k">MIN</span><span class="p">(</span><span class="n">event_timestamp</span><span class="p">)</span> <span class="k">AS</span> <span class="n">assigned_timestamp</span>  
    <span class="k">FROM</span> 
        <span class="n">CTE_raw</span>  
    <span class="k">CROSS</span> <span class="k">JOIN</span> 
        <span class="k">UNNEST</span> <span class="p">(</span><span class="n">event_params</span><span class="p">)</span> <span class="k">AS</span> <span class="n">assigned_params</span>  
    <span class="k">WHERE</span>  
        <span class="n">event_name</span> <span class="o">=</span> <span class="s1">'experiment_impression'</span>  
        <span class="k">AND</span> <span class="n">assigned_params</span><span class="p">.</span><span class="k">key</span> <span class="o">=</span> <span class="s1">'variant_id'</span>  
        <span class="k">AND</span> <span class="n">STARTS_WITH</span><span class="p">(</span><span class="n">assigned_params</span><span class="p">.</span><span class="n">value</span><span class="p">.</span><span class="n">string_value</span><span class="p">,</span> <span class="s1">'{EXPERIMENT_ID}'</span><span class="p">)</span> <span class="o">=</span> <span class="k">True</span>  
    <span class="k">GROUP</span> <span class="k">BY</span> 
        <span class="n">test_group</span><span class="p">,</span> <span class="n">geo</span><span class="p">.</span><span class="n">country</span><span class="p">,</span> <span class="n">user_pseudo_id</span>  
    <span class="k">ORDER</span> <span class="k">BY</span> 
        <span class="n">test_group</span><span class="p">,</span> <span class="n">geo</span><span class="p">.</span><span class="n">country</span><span class="p">,</span> <span class="n">user_pseudo_id</span>  
<span class="p">),</span>

<span class="n">CTE_txids_revenue</span> <span class="k">AS</span> <span class="p">(</span>  
    <span class="k">SELECT</span>  
        <span class="n">ecommerce</span><span class="p">.</span><span class="n">transaction_id</span> <span class="k">AS</span> <span class="n">txid</span><span class="p">,</span>  
        <span class="n">user_pseudo_id</span><span class="p">,</span>  
        <span class="n">geo</span><span class="p">.</span><span class="n">country</span><span class="p">,</span>  
        <span class="n">event_timestamp</span> <span class="k">AS</span> <span class="n">purchase_timestamp</span><span class="p">,</span>  
        <span class="n">ecommerce</span><span class="p">.</span><span class="n">purchase_revenue_in_usd</span> <span class="k">AS</span> <span class="n">revenue</span>  
    <span class="k">FROM</span> 
        <span class="n">CTE_raw</span>  
    <span class="k">WHERE</span>  
        <span class="n">event_name</span> <span class="o">=</span> <span class="s1">'purchase'</span>  
    <span class="k">ORDER</span> <span class="k">BY</span> 
        <span class="n">revenue</span> <span class="k">DESC</span><span class="p">,</span> <span class="n">txid</span><span class="p">,</span> <span class="n">user_pseudo_id</span>  
<span class="p">),</span>  

<span class="n">CTE_txids_revenue_assigned_only</span> <span class="k">AS</span> <span class="p">(</span>  
    <span class="k">SELECT</span>  
        <span class="n">A</span><span class="p">.</span><span class="n">txid</span><span class="p">,</span>  
        <span class="n">A</span><span class="p">.</span><span class="n">user_pseudo_id</span><span class="p">,</span>  
        <span class="n">A</span><span class="p">.</span><span class="n">country</span><span class="p">,</span>  
        <span class="n">A</span><span class="p">.</span><span class="n">purchase_timestamp</span><span class="p">,</span>  
        <span class="n">A</span><span class="p">.</span><span class="n">revenue</span>  
    <span class="k">FROM</span> 
        <span class="n">CTE_txids_revenue</span> <span class="n">A</span>  
    <span class="k">LEFT</span> <span class="k">JOIN</span> 
        <span class="n">CTE_users_assigned</span> <span class="n">B</span>  
        <span class="k">ON</span> <span class="n">A</span><span class="p">.</span><span class="n">user_pseudo_id</span> <span class="o">=</span> <span class="n">B</span><span class="p">.</span><span class="n">user_pseudo_id</span>  
        <span class="k">AND</span> <span class="n">A</span><span class="p">.</span><span class="n">country</span> <span class="o">=</span> <span class="n">B</span><span class="p">.</span><span class="n">country</span>  
        <span class="k">AND</span> <span class="n">A</span><span class="p">.</span><span class="n">purchase_timestamp</span> <span class="o">&gt;=</span> <span class="n">B</span><span class="p">.</span><span class="n">assigned_timestamp</span>  
    <span class="k">WHERE</span>  
        <span class="n">B</span><span class="p">.</span><span class="n">user_pseudo_id</span> <span class="k">IS</span> <span class="k">NOT</span> <span class="k">NULL</span> 
        <span class="k">AND</span> <span class="n">B</span><span class="p">.</span><span class="n">assigned_timestamp</span> <span class="k">IS</span> <span class="k">NOT</span> <span class="k">NULL</span>  
<span class="p">),</span>  

<span class="n">CTE_users_revenue</span> <span class="k">AS</span> <span class="p">(</span>  
    <span class="k">SELECT</span>  
        <span class="n">user_pseudo_id</span><span class="p">,</span>  
        <span class="n">country</span><span class="p">,</span>  
        <span class="k">SUM</span><span class="p">(</span><span class="n">revenue</span><span class="p">)</span> <span class="k">AS</span> <span class="n">revenue_usd</span>  
    <span class="k">FROM</span> 
        <span class="n">CTE_txids_revenue_assigned_only</span>  
    <span class="k">GROUP</span> <span class="k">BY</span> 
        <span class="n">country</span><span class="p">,</span> <span class="n">user_pseudo_id</span>  
    <span class="k">ORDER</span> <span class="k">BY</span> 
        <span class="n">revenue_usd</span> <span class="k">DESC</span>  
<span class="p">),</span>

<span class="n">CTE_users_arpu_group</span> <span class="k">AS</span> <span class="p">(</span>  
    <span class="k">SELECT</span>  
        <span class="n">A</span><span class="p">.</span><span class="n">user_pseudo_id</span><span class="p">,</span>  
        <span class="n">A</span><span class="p">.</span><span class="n">country</span><span class="p">,</span>  
        <span class="n">A</span><span class="p">.</span><span class="n">test_group</span><span class="p">,</span>  
        <span class="k">CASE</span>  
            <span class="k">WHEN</span> <span class="n">B</span><span class="p">.</span><span class="n">revenue_usd</span> <span class="k">IS</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">THEN</span> <span class="n">B</span><span class="p">.</span><span class="n">revenue_usd</span>  
            <span class="k">ELSE</span> <span class="mi">0</span>  
        <span class="k">END</span> <span class="k">AS</span> <span class="n">revenue_usd</span>  
    <span class="k">FROM</span> 
        <span class="n">CTE_users_assigned</span> <span class="n">A</span>  
    <span class="k">LEFT</span> <span class="k">JOIN</span> 
        <span class="n">CTE_users_revenue</span> <span class="n">B</span>  
        <span class="k">ON</span> <span class="n">A</span><span class="p">.</span><span class="n">user_pseudo_id</span> <span class="o">=</span> <span class="n">B</span><span class="p">.</span><span class="n">user_pseudo_id</span>  
        <span class="k">AND</span> <span class="n">A</span><span class="p">.</span><span class="n">country</span> <span class="o">=</span> <span class="n">B</span><span class="p">.</span><span class="n">country</span>  
    <span class="k">ORDER</span> <span class="k">BY</span> 
        <span class="n">A</span><span class="p">.</span><span class="n">test_group</span><span class="p">,</span> <span class="n">B</span><span class="p">.</span><span class="n">revenue_usd</span> <span class="k">DESC</span><span class="p">,</span> <span class="n">A</span><span class="p">.</span><span class="n">user_pseudo_id</span>  
<span class="p">)</span>  

<span class="k">SELECT</span> 
    <span class="o">*</span> 
<span class="k">FROM</span> 
    <span class="n">CTE_users_arpu_group</span>
<span class="p">;</span>
</code></pre></div></div>

<p>Everything is the same as I have guided you previously, except for the  <code class="language-plaintext highlighter-rouge">geo.country</code>  for grouping the users by their countries.</p>

<h2 id="35-other-aspects">3.5. Other Aspects?</h2>

<p>For the sake of brevity, I will omit the details regarding device-specific goal achievement and CTR for different buttons, as they are not significantly different from the provided SQL queries.</p>

<h1 id="4-start-to-analyze-statistically">4. Start to Analyze Statistically</h1>

<h2 id="41-purchase-conversion-rate">4.1. Purchase Conversion Rate</h2>

<p><strong>1. Did the data meet the assumptions prior to the analysis of A/B Test?</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">na</span> <span class="o">=</span> <span class="n">purchase_cvr_df</span><span class="p">.</span><span class="nf">groupby</span><span class="p">(</span><span class="sh">'</span><span class="s">test_group</span><span class="sh">'</span><span class="p">)[</span><span class="sh">'</span><span class="s">user_pseudo_id</span><span class="sh">'</span><span class="p">].</span><span class="nf">count</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>  
<span class="n">nb</span> <span class="o">=</span> <span class="n">purchase_cvr_df</span><span class="p">.</span><span class="nf">groupby</span><span class="p">(</span><span class="sh">'</span><span class="s">test_group</span><span class="sh">'</span><span class="p">)[</span><span class="sh">'</span><span class="s">user_pseudo_id</span><span class="sh">'</span><span class="p">].</span><span class="nf">count</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>  
<span class="nf">print</span><span class="p">(</span><span class="n">na</span><span class="p">,</span> <span class="n">nb</span><span class="p">)</span>

<span class="n">na</span> <span class="o">=</span> <span class="n">purchase_cvr_df</span><span class="p">.</span><span class="nf">groupby</span><span class="p">(</span><span class="sh">'</span><span class="s">test_group</span><span class="sh">'</span><span class="p">)[</span><span class="sh">'</span><span class="s">user_pseudo_id</span><span class="sh">'</span><span class="p">].</span><span class="nf">count</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>  
<span class="n">nb</span> <span class="o">=</span> <span class="n">purchase_cvr_df</span><span class="p">.</span><span class="nf">groupby</span><span class="p">(</span><span class="sh">'</span><span class="s">test_group</span><span class="sh">'</span><span class="p">)[</span><span class="sh">'</span><span class="s">user_pseudo_id</span><span class="sh">'</span><span class="p">].</span><span class="nf">count</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>  
  
<span class="n">xa</span> <span class="o">=</span> <span class="n">purchase_cvr_df</span><span class="p">.</span><span class="nf">groupby</span><span class="p">(</span><span class="sh">'</span><span class="s">test_group</span><span class="sh">'</span><span class="p">)[</span><span class="sh">'</span><span class="s">purchase</span><span class="sh">'</span><span class="p">].</span><span class="nf">sum</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>  
<span class="n">xb</span> <span class="o">=</span> <span class="n">purchase_cvr_df</span><span class="p">.</span><span class="nf">groupby</span><span class="p">(</span><span class="sh">'</span><span class="s">test_group</span><span class="sh">'</span><span class="p">)[</span><span class="sh">'</span><span class="s">purchase</span><span class="sh">'</span><span class="p">].</span><span class="nf">sum</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>  
  
<span class="n">pa</span> <span class="o">=</span> <span class="n">xa</span> <span class="o">/</span> <span class="n">na</span>  
<span class="n">pb</span> <span class="o">=</span> <span class="n">xb</span> <span class="o">/</span> <span class="n">nb</span>  
  
<span class="nf">if </span><span class="p">(</span><span class="n">na</span> <span class="o">*</span> <span class="n">pa</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">na</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">pa</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">nb</span> <span class="o">*</span> <span class="n">pb</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">nb</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">pb</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">):</span>  
    <span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">Did not meet the assumptions!</span><span class="sh">'</span><span class="p">)</span>  
<span class="k">else</span><span class="p">:</span>  
    <span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">Met the assumptions!</span><span class="sh">'</span><span class="p">)</span>
</code></pre></div></div>

<p><strong>2. Start to Analyze.</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">z_result</span> <span class="o">=</span> <span class="n">proportion</span><span class="p">.</span><span class="nf">proportions_ztest</span><span class="p">(</span>  
    <span class="n">count</span> <span class="o">=</span> <span class="p">[</span><span class="n">xa</span><span class="p">,</span> <span class="n">xb</span><span class="p">],</span>  
    <span class="n">nobs</span> <span class="o">=</span> <span class="p">[</span><span class="n">na</span><span class="p">,</span> <span class="n">nb</span><span class="p">],</span>  
    <span class="n">alternative</span> <span class="o">=</span> <span class="sh">'</span><span class="s">smaller</span><span class="sh">'</span> <span class="c1"># two-sided, smaller, larger  
</span><span class="p">)</span>  
<span class="n">z</span><span class="p">,</span> <span class="n">p_value</span> <span class="o">=</span> <span class="n">z_result</span>  
  
<span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">The results of the A/B test are as follows. (Confidence Level:</span><span class="sh">'</span><span class="p">,</span> <span class="sa">f</span><span class="sh">'</span><span class="si">{</span><span class="nf">str</span><span class="p">(</span><span class="n">CONFIDENCE_LEVEL</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span><span class="si">}</span><span class="s">%)</span><span class="sh">'</span><span class="p">)</span>  
  
<span class="k">if</span> <span class="n">p_value</span> <span class="o">&lt;</span> <span class="n">ALPHA</span><span class="p">:</span>  
  <span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">&gt; The null hypothesis can be rejected. (A &lt; B)</span><span class="sh">'</span><span class="p">)</span>   
<span class="k">else</span><span class="p">:</span>  
  <span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">&gt; The null hypothesis can not be rejected. (A &gt;= B)</span><span class="sh">'</span><span class="p">)</span>  
  
<span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">=====================================</span><span class="sh">'</span><span class="p">)</span>  
  
<span class="p">(</span><span class="n">a_lower</span><span class="p">,</span> <span class="n">b_lower</span><span class="p">),</span> <span class="p">(</span><span class="n">a_upper</span><span class="p">,</span> <span class="n">b_upper</span><span class="p">)</span> <span class="o">=</span> <span class="n">proportion</span><span class="p">.</span><span class="nf">proportion_confint</span><span class="p">(</span>  
    <span class="p">[</span><span class="n">xa</span><span class="p">,</span> <span class="n">xb</span><span class="p">],</span>  
    <span class="n">nobs</span> <span class="o">=</span> <span class="p">[</span><span class="n">na</span><span class="p">,</span> <span class="n">nb</span><span class="p">],</span>  
    <span class="n">alpha</span> <span class="o">=</span> <span class="n">ALPHA</span>  
<span class="p">)</span>  
  
<span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">'</span><span class="s">p-value = </span><span class="si">{</span><span class="n">p_value</span><span class="si">:</span><span class="p">.</span><span class="mi">4</span><span class="n">f</span><span class="si">}</span><span class="sh">'</span><span class="p">)</span>  
<span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">&gt; Conversion Rate of Group A:</span><span class="sh">'</span><span class="p">,</span> <span class="sa">f</span><span class="sh">'</span><span class="si">{</span><span class="n">pa</span> <span class="o">*</span> <span class="mi">100</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s">%</span><span class="sh">'</span><span class="p">,</span> <span class="sa">f</span><span class="sh">'</span><span class="s">(</span><span class="si">{</span><span class="nf">str</span><span class="p">(</span><span class="n">CONFIDENCE_LEVEL</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span><span class="si">}</span><span class="s">% Confidence Interval: </span><span class="si">{</span><span class="n">a_lower</span> <span class="o">*</span> <span class="mi">100</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s">% ~ </span><span class="si">{</span><span class="n">a_upper</span> <span class="o">*</span> <span class="mi">100</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s">%)</span><span class="sh">'</span><span class="p">)</span>  
<span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">&gt; Conversion Rate of Group B:</span><span class="sh">'</span><span class="p">,</span> <span class="sa">f</span><span class="sh">'</span><span class="si">{</span><span class="n">pb</span> <span class="o">*</span> <span class="mi">100</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s">%</span><span class="sh">'</span><span class="p">,</span> <span class="sa">f</span><span class="sh">'</span><span class="s">(</span><span class="si">{</span><span class="nf">str</span><span class="p">(</span><span class="n">CONFIDENCE_LEVEL</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span><span class="si">}</span><span class="s">% Confidence Interval: </span><span class="si">{</span><span class="n">b_lower</span> <span class="o">*</span> <span class="mi">100</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s">% ~ </span><span class="si">{</span><span class="n">b_upper</span> <span class="o">*</span> <span class="mi">100</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s">%)</span><span class="sh">'</span><span class="p">)</span>
</code></pre></div></div>

<p><strong>3. Visualize</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">plt</span><span class="p">.</span><span class="nf">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mf">2.5</span><span class="p">))</span>  
  
<span class="n">plt</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span>  
    <span class="p">(</span><span class="n">a_lower</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span> <span class="n">a_upper</span><span class="o">*</span><span class="mi">100</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="sh">'</span><span class="s">ro-</span><span class="sh">'</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="sh">'</span><span class="s">blue</span><span class="sh">'</span>  
<span class="p">)</span>  
<span class="n">plt</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span>  
    <span class="p">(</span><span class="n">b_lower</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span> <span class="n">b_upper</span><span class="o">*</span><span class="mi">100</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="sh">'</span><span class="s">ro-</span><span class="sh">'</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="sh">'</span><span class="s">red</span><span class="sh">'</span>  
<span class="p">)</span>  
<span class="n">plt</span><span class="p">.</span><span class="nf">yticks</span><span class="p">(</span><span class="nf">range</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="p">[</span><span class="sh">'</span><span class="s">A</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">B</span><span class="sh">'</span><span class="p">])</span>  
<span class="n">plt</span><span class="p">.</span><span class="nf">title</span><span class="p">(</span><span class="sa">f</span><span class="sh">'</span><span class="s">Conversion Rate (</span><span class="si">{</span><span class="nf">str</span><span class="p">(</span><span class="n">CONFIDENCE_LEVEL</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span><span class="si">}</span><span class="s">% Confidence Level)</span><span class="sh">'</span><span class="p">)</span>  
<span class="n">plt</span><span class="p">.</span><span class="nf">xlabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Conversion Rate (%)</span><span class="sh">'</span><span class="p">)</span>  
<span class="n">plt</span><span class="p">.</span><span class="nf">ylabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Group</span><span class="sh">'</span><span class="p">)</span>  
  
<span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">();</span>
</code></pre></div></div>

<h2 id="42-average-revenue-per-user">4.2. Average Revenue per User</h2>

<p><strong>1. Did the data meet the assumptions prior to the analysis of A/B Test?</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">na</span> <span class="o">=</span> <span class="n">arpu_df</span><span class="p">.</span><span class="nf">groupby</span><span class="p">(</span><span class="sh">'</span><span class="s">test_group</span><span class="sh">'</span><span class="p">)[</span><span class="sh">'</span><span class="s">user_pseudo_id</span><span class="sh">'</span><span class="p">].</span><span class="nf">count</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>  
<span class="n">nb</span> <span class="o">=</span> <span class="n">arpu_df</span><span class="p">.</span><span class="nf">groupby</span><span class="p">(</span><span class="sh">'</span><span class="s">test_group</span><span class="sh">'</span><span class="p">)[</span><span class="sh">'</span><span class="s">user_pseudo_id</span><span class="sh">'</span><span class="p">].</span><span class="nf">count</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>  
  
<span class="k">if</span> <span class="n">na</span> <span class="o">+</span> <span class="n">nb</span> <span class="o">&lt;</span> <span class="mi">30</span><span class="p">:</span>  
    <span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">Did not meet the assumptions!</span><span class="sh">'</span><span class="p">)</span>  
<span class="k">else</span><span class="p">:</span>  
    <span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">Met the assumptions!</span><span class="sh">'</span><span class="p">)</span>
</code></pre></div></div>

<p><strong>2. Preliminary Analysis: Homogeneity of Variance Test <code class="language-plaintext highlighter-rouge">(Bartlett’s Test)</code></strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">stat</span><span class="p">,</span> <span class="n">p_value</span> <span class="o">=</span> <span class="n">stats</span><span class="p">.</span><span class="nf">bartlett</span><span class="p">(</span>  
    <span class="n">arpu_df</span><span class="p">[</span><span class="n">arpu_df</span><span class="p">[</span><span class="sh">'</span><span class="s">test_group</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="sh">'</span><span class="s">A</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">revenue_usd</span><span class="sh">'</span><span class="p">].</span><span class="nf">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>  
    <span class="n">arpu_df</span><span class="p">[</span><span class="n">arpu_df</span><span class="p">[</span><span class="sh">'</span><span class="s">test_group</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="sh">'</span><span class="s">B</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">revenue_usd</span><span class="sh">'</span><span class="p">].</span><span class="nf">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>  
<span class="p">)</span>  
  
<span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">The result of the homoscedasticity test is as follows. (Confidence Level:</span><span class="sh">'</span><span class="p">,</span> <span class="sa">f</span><span class="sh">'</span><span class="si">{</span><span class="nf">str</span><span class="p">(</span><span class="n">CONFIDENCE_LEVEL</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span><span class="si">}</span><span class="s">%)</span><span class="sh">'</span><span class="p">)</span>  
  
<span class="k">if</span> <span class="n">p_value</span> <span class="o">&lt;</span> <span class="n">ALPHA</span><span class="p">:</span>  
    <span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">&gt; The variances of the two groups are different.</span><span class="sh">'</span><span class="p">)</span>  
    <span class="n">EQUAL_VAR</span> <span class="o">=</span> <span class="bp">False</span>  
<span class="k">else</span><span class="p">:</span>  
    <span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">&gt; The variances of the two groups are same.</span><span class="sh">'</span><span class="p">)</span>  
    <span class="n">EQUAL_VAR</span> <span class="o">=</span> <span class="bp">True</span>
</code></pre></div></div>

<p><strong>3. Start to Analyze.</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">t_result</span> <span class="o">=</span> <span class="n">stats</span><span class="p">.</span><span class="nf">ttest_ind</span><span class="p">(</span>  
    <span class="n">arpu_df</span><span class="p">[</span><span class="n">arpu_df</span><span class="p">[</span><span class="sh">'</span><span class="s">test_group</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="sh">'</span><span class="s">A</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">revenue_usd</span><span class="sh">'</span><span class="p">].</span><span class="nf">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>  
    <span class="n">arpu_df</span><span class="p">[</span><span class="n">arpu_df</span><span class="p">[</span><span class="sh">'</span><span class="s">test_group</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="sh">'</span><span class="s">B</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">revenue_usd</span><span class="sh">'</span><span class="p">].</span><span class="nf">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>  
    <span class="n">equal_var</span> <span class="o">=</span> <span class="n">EQUAL_VAR</span><span class="p">,</span>  
    <span class="n">alternative</span> <span class="o">=</span> <span class="sh">'</span><span class="s">less</span><span class="sh">'</span>  
<span class="p">)</span>  
<span class="n">t</span><span class="p">,</span> <span class="n">p_value</span> <span class="o">=</span> <span class="n">t_result</span>  
  
<span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">The results of the A/B test are as follows. (Confidence Level:</span><span class="sh">'</span><span class="p">,</span> <span class="sa">f</span><span class="sh">'</span><span class="si">{</span><span class="nf">str</span><span class="p">(</span><span class="n">CONFIDENCE_LEVEL</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span><span class="si">}</span><span class="s">%)</span><span class="sh">'</span><span class="p">)</span>  
  
<span class="k">if</span> <span class="n">p_value</span> <span class="o">&lt;</span> <span class="n">ALPHA</span><span class="p">:</span>  
  <span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">&gt; The null hypothesis can be rejected. (A &lt; B)</span><span class="sh">'</span><span class="p">)</span>   
<span class="k">else</span><span class="p">:</span>  
  <span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">&gt; The null hypothesis can not be rejected. (A &gt;= B)</span><span class="sh">'</span><span class="p">)</span>  
  
<span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">=====================================</span><span class="sh">'</span><span class="p">)</span>  
  
<span class="n">mean_a</span> <span class="o">=</span> <span class="n">arpu_df</span><span class="p">.</span><span class="nf">groupby</span><span class="p">(</span><span class="sh">'</span><span class="s">test_group</span><span class="sh">'</span><span class="p">)[</span><span class="sh">'</span><span class="s">revenue_usd</span><span class="sh">'</span><span class="p">].</span><span class="nf">mean</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>  
<span class="n">mean_b</span> <span class="o">=</span> <span class="n">arpu_df</span><span class="p">.</span><span class="nf">groupby</span><span class="p">(</span><span class="sh">'</span><span class="s">test_group</span><span class="sh">'</span><span class="p">)[</span><span class="sh">'</span><span class="s">revenue_usd</span><span class="sh">'</span><span class="p">].</span><span class="nf">mean</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>  
<span class="n">std_a</span> <span class="o">=</span> <span class="n">arpu_df</span><span class="p">.</span><span class="nf">groupby</span><span class="p">(</span><span class="sh">'</span><span class="s">test_group</span><span class="sh">'</span><span class="p">)[</span><span class="sh">'</span><span class="s">revenue_usd</span><span class="sh">'</span><span class="p">].</span><span class="nf">std</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>  
<span class="n">std_b</span> <span class="o">=</span> <span class="n">arpu_df</span><span class="p">.</span><span class="nf">groupby</span><span class="p">(</span><span class="sh">'</span><span class="s">test_group</span><span class="sh">'</span><span class="p">)[</span><span class="sh">'</span><span class="s">revenue_usd</span><span class="sh">'</span><span class="p">].</span><span class="nf">std</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>  
  
<span class="n">a_lower</span><span class="p">,</span> <span class="n">a_upper</span> <span class="o">=</span> <span class="n">stats</span><span class="p">.</span><span class="n">t</span><span class="p">.</span><span class="nf">interval</span><span class="p">(</span>  
    <span class="n">confidence</span> <span class="o">=</span> <span class="n">ALPHA</span><span class="p">,</span>  
    <span class="n">df</span> <span class="o">=</span> <span class="n">arpu_df</span><span class="p">[</span><span class="n">arpu_df</span><span class="p">[</span><span class="sh">'</span><span class="s">test_group</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="sh">'</span><span class="s">A</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">revenue_usd</span><span class="sh">'</span><span class="p">].</span><span class="nf">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="bp">True</span><span class="p">).</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>  
    <span class="n">loc</span> <span class="o">=</span> <span class="n">mean_a</span><span class="p">,</span>  
    <span class="n">scale</span> <span class="o">=</span> <span class="n">std_a</span>  
<span class="p">)</span>  
<span class="n">b_lower</span><span class="p">,</span> <span class="n">b_upper</span> <span class="o">=</span> <span class="n">stats</span><span class="p">.</span><span class="n">t</span><span class="p">.</span><span class="nf">interval</span><span class="p">(</span>  
    <span class="n">confidence</span> <span class="o">=</span> <span class="n">ALPHA</span><span class="p">,</span>  
    <span class="n">df</span> <span class="o">=</span> <span class="n">arpu_df</span><span class="p">[</span><span class="n">arpu_df</span><span class="p">[</span><span class="sh">'</span><span class="s">test_group</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="sh">'</span><span class="s">B</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">revenue_usd</span><span class="sh">'</span><span class="p">].</span><span class="nf">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="bp">True</span><span class="p">).</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>  
    <span class="n">loc</span> <span class="o">=</span> <span class="n">mean_b</span><span class="p">,</span>  
    <span class="n">scale</span> <span class="o">=</span> <span class="n">std_b</span>  
<span class="p">)</span>  
  
<span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">'</span><span class="s">p-value = </span><span class="si">{</span><span class="n">p_value</span><span class="si">:</span><span class="p">.</span><span class="mi">4</span><span class="n">f</span><span class="si">}</span><span class="sh">'</span><span class="p">)</span>  
<span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">&gt; A안의 ARPU:</span><span class="sh">'</span><span class="p">,</span> <span class="sa">f</span><span class="sh">'</span><span class="s">US$</span><span class="si">{</span><span class="n">mean_a</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="sh">'</span><span class="p">,</span> <span class="sa">f</span><span class="sh">'</span><span class="s">(</span><span class="si">{</span><span class="nf">str</span><span class="p">(</span><span class="n">CONFIDENCE_LEVEL</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span><span class="si">}</span><span class="s">% Confidence Interval: US$</span><span class="si">{</span><span class="n">a_lower</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s"> ~ US$</span><span class="si">{</span><span class="n">a_upper</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s">)</span><span class="sh">'</span><span class="p">)</span>  
<span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">&gt; B안의 ARPU:</span><span class="sh">'</span><span class="p">,</span> <span class="sa">f</span><span class="sh">'</span><span class="s">US$</span><span class="si">{</span><span class="n">mean_b</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="sh">'</span><span class="p">,</span> <span class="sa">f</span><span class="sh">'</span><span class="s">(</span><span class="si">{</span><span class="nf">str</span><span class="p">(</span><span class="n">CONFIDENCE_LEVEL</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span><span class="si">}</span><span class="s">% Confidence Interval: US$</span><span class="si">{</span><span class="n">b_lower</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s"> ~ US$</span><span class="si">{</span><span class="n">b_upper</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s">)</span><span class="sh">'</span><span class="p">)</span>
</code></pre></div></div>

<p><strong>4. Visualize</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">plt</span><span class="p">.</span><span class="nf">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mf">2.5</span><span class="p">))</span>  
  
<span class="n">plt</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span>  
    <span class="p">(</span><span class="n">a_lower</span><span class="p">,</span> <span class="n">a_upper</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="sh">'</span><span class="s">ro-</span><span class="sh">'</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="sh">'</span><span class="s">blue</span><span class="sh">'</span>  
<span class="p">)</span>  
<span class="n">plt</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span>  
    <span class="p">(</span><span class="n">b_lower</span><span class="p">,</span> <span class="n">b_upper</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="sh">'</span><span class="s">ro-</span><span class="sh">'</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="sh">'</span><span class="s">red</span><span class="sh">'</span>  
<span class="p">)</span>  
<span class="n">plt</span><span class="p">.</span><span class="nf">yticks</span><span class="p">(</span><span class="nf">range</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="p">[</span><span class="sh">'</span><span class="s">A</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">B</span><span class="sh">'</span><span class="p">])</span>  
<span class="n">plt</span><span class="p">.</span><span class="nf">title</span><span class="p">(</span><span class="sa">f</span><span class="sh">'</span><span class="s">ARPU (</span><span class="si">{</span><span class="nf">str</span><span class="p">(</span><span class="n">CONFIDENCE_LEVEL</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span><span class="si">}</span><span class="s">% Confidence Leve)</span><span class="sh">'</span><span class="p">)</span>  
<span class="n">plt</span><span class="p">.</span><span class="nf">xlabel</span><span class="p">(</span><span class="sh">'</span><span class="s">ARPU (USD)</span><span class="sh">'</span><span class="p">)</span>  
<span class="n">plt</span><span class="p">.</span><span class="nf">ylabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Group</span><span class="sh">'</span><span class="p">)</span>  
  
<span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">();</span>
</code></pre></div></div>

<p><strong>5. Visualize the Histogram of Purchase Amount by User <code class="language-plaintext highlighter-rouge">(KDE Plot)</code></strong></p>
<ul>
  <li>Checking for Data Bias due to Extremely High Purchase Amounts by Certain Minority of Users</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">plt</span><span class="p">.</span><span class="nf">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>  
  
<span class="n">sns</span><span class="p">.</span><span class="nf">kdeplot</span><span class="p">(</span>  
    <span class="n">data</span> <span class="o">=</span> <span class="n">arpu_df</span><span class="p">[</span><span class="n">arpu_df</span><span class="p">[</span><span class="sh">'</span><span class="s">test_group</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="sh">'</span><span class="s">A</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">revenue_usd</span><span class="sh">'</span><span class="p">].</span><span class="nf">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>  
    <span class="n">color</span> <span class="o">=</span> <span class="sh">'</span><span class="s">blue</span><span class="sh">'</span><span class="p">,</span>  
    <span class="n">fill</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>  
    <span class="n">label</span> <span class="o">=</span> <span class="sh">'</span><span class="s">Group A</span><span class="sh">'</span>  
<span class="p">)</span>  
<span class="n">sns</span><span class="p">.</span><span class="nf">kdeplot</span><span class="p">(</span>  
    <span class="n">data</span> <span class="o">=</span> <span class="n">arpu_df</span><span class="p">[</span><span class="n">arpu_df</span><span class="p">[</span><span class="sh">'</span><span class="s">test_group</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="sh">'</span><span class="s">B</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">revenue_usd</span><span class="sh">'</span><span class="p">].</span><span class="nf">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>  
    <span class="n">color</span> <span class="o">=</span> <span class="sh">'</span><span class="s">red</span><span class="sh">'</span><span class="p">,</span>  
    <span class="n">fill</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>  
    <span class="n">label</span> <span class="o">=</span> <span class="sh">'</span><span class="s">Group B</span><span class="sh">'</span>  
<span class="p">)</span> 

<span class="n">plt</span><span class="p">.</span><span class="nf">title</span><span class="p">(</span><span class="sa">f</span><span class="sh">'</span><span class="s">Distribution of User Purchase Amounts</span><span class="sh">'</span><span class="p">)</span>  
<span class="n">plt</span><span class="p">.</span><span class="nf">xlabel</span><span class="p">(</span><span class="sh">'</span><span class="s">User Purchase Amounts (USD)</span><span class="sh">'</span><span class="p">)</span>  
<span class="n">plt</span><span class="p">.</span><span class="nf">ylabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Proportion</span><span class="sh">'</span><span class="p">)</span>  
<span class="n">plt</span><span class="p">.</span><span class="nf">legend</span><span class="p">()</span>  
<span class="n">plt</span><span class="p">.</span><span class="nf">xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10000</span><span class="p">)</span>  
  
<span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">();</span>
</code></pre></div></div>

<h2 id="43-conversion-rate--average-revenue-per-user-by-country">4.3. Conversion Rate &amp; Average Revenue per User (by Country)</h2>

<ul>
  <li>In the following query, I have categorized countries into the US vs Others. However, depending on the distribution of countries currently using your service, it may be possible to further divide them into smaller groups.</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">plt</span><span class="p">.</span><span class="nf">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>  
  
<span class="c1"># Conversion Rate  
</span><span class="n">plt</span><span class="p">.</span><span class="nf">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  
  
<span class="n">temp_df</span> <span class="o">=</span> <span class="n">purchase_cvr_by_country_df</span>  
<span class="n">temp_df</span><span class="p">.</span><span class="n">loc</span><span class="p">[</span>  
    <span class="p">(</span><span class="n">temp_df</span><span class="p">[</span><span class="sh">'</span><span class="s">country</span><span class="sh">'</span><span class="p">]</span> <span class="o">!=</span> <span class="sh">'</span><span class="s">United States</span><span class="sh">'</span><span class="p">),</span>  
    <span class="sh">'</span><span class="s">country</span><span class="sh">'</span>  
<span class="p">]</span> <span class="o">=</span> <span class="sh">'</span><span class="s">Others</span><span class="sh">'</span>  
  
<span class="n">sns</span><span class="p">.</span><span class="nf">barplot</span><span class="p">(</span>  
    <span class="n">data</span> <span class="o">=</span> <span class="n">temp_df</span><span class="p">,</span>  
    <span class="n">x</span> <span class="o">=</span> <span class="sh">'</span><span class="s">country</span><span class="sh">'</span><span class="p">,</span>  
    <span class="n">y</span> <span class="o">=</span> <span class="sh">'</span><span class="s">purchase</span><span class="sh">'</span><span class="p">,</span>  
    <span class="n">hue</span> <span class="o">=</span> <span class="sh">'</span><span class="s">test_group</span><span class="sh">'</span><span class="p">,</span>  
    <span class="n">hue_order</span> <span class="o">=</span> <span class="p">[</span><span class="sh">'</span><span class="s">A</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">B</span><span class="sh">'</span><span class="p">],</span>  
    <span class="n">palette</span> <span class="o">=</span> <span class="sh">'</span><span class="s">coolwarm</span><span class="sh">'</span><span class="p">,</span>  
    <span class="n">order</span> <span class="o">=</span> <span class="p">[</span><span class="sh">'</span><span class="s">United States</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">Others</span><span class="sh">'</span><span class="p">]</span>      
<span class="p">)</span>  
  
<span class="n">plt</span><span class="p">.</span><span class="nf">title</span><span class="p">(</span><span class="sh">'</span><span class="s">Conversion Rate (by Countries)</span><span class="sh">'</span><span class="p">)</span>  
<span class="n">plt</span><span class="p">.</span><span class="nf">legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="sh">'</span><span class="s">Group</span><span class="sh">'</span><span class="p">)</span>  
<span class="n">plt</span><span class="p">.</span><span class="nf">xlabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Country</span><span class="sh">'</span><span class="p">)</span>  
<span class="n">plt</span><span class="p">.</span><span class="nf">ylabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Conversion Rate</span><span class="sh">'</span><span class="p">)</span>  
  
<span class="c1"># ARPU  
</span><span class="n">plt</span><span class="p">.</span><span class="nf">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>  
  
<span class="n">temp_df</span> <span class="o">=</span> <span class="n">arpu_by_country_df</span>  
<span class="n">temp_df</span><span class="p">.</span><span class="n">loc</span><span class="p">[</span>  
    <span class="p">(</span><span class="n">temp_df</span><span class="p">[</span><span class="sh">'</span><span class="s">country</span><span class="sh">'</span><span class="p">]</span> <span class="o">!=</span> <span class="sh">'</span><span class="s">United States</span><span class="sh">'</span><span class="p">),</span>  
    <span class="sh">'</span><span class="s">country</span><span class="sh">'</span>  
<span class="p">]</span> <span class="o">=</span> <span class="sh">'</span><span class="s">Others</span><span class="sh">'</span>  
  
<span class="n">sns</span><span class="p">.</span><span class="nf">barplot</span><span class="p">(</span>  
    <span class="n">data</span> <span class="o">=</span> <span class="n">temp_df</span><span class="p">,</span>  
    <span class="n">x</span> <span class="o">=</span> <span class="sh">'</span><span class="s">country</span><span class="sh">'</span><span class="p">,</span>  
    <span class="n">y</span> <span class="o">=</span> <span class="sh">'</span><span class="s">revenue_usd</span><span class="sh">'</span><span class="p">,</span>  
    <span class="n">hue</span> <span class="o">=</span> <span class="sh">'</span><span class="s">test_group</span><span class="sh">'</span><span class="p">,</span>  
    <span class="n">hue_order</span> <span class="o">=</span> <span class="p">[</span><span class="sh">'</span><span class="s">A</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">B</span><span class="sh">'</span><span class="p">],</span>  
    <span class="n">palette</span> <span class="o">=</span> <span class="sh">'</span><span class="s">coolwarm</span><span class="sh">'</span><span class="p">,</span>  
    <span class="n">order</span> <span class="o">=</span> <span class="p">[</span><span class="sh">'</span><span class="s">United States</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">Others</span><span class="sh">'</span><span class="p">]</span>      
<span class="p">)</span>  
  
<span class="n">plt</span><span class="p">.</span><span class="nf">title</span><span class="p">(</span><span class="sh">'</span><span class="s">ARPU (by Countries)</span><span class="sh">'</span><span class="p">)</span>  
<span class="n">plt</span><span class="p">.</span><span class="nf">legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="sh">'</span><span class="s">Group</span><span class="sh">'</span><span class="p">)</span>  
<span class="n">plt</span><span class="p">.</span><span class="nf">xlabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Country</span><span class="sh">'</span><span class="p">)</span>  
<span class="n">plt</span><span class="p">.</span><span class="nf">ylabel</span><span class="p">(</span><span class="sh">'</span><span class="s">ARPU (USD)</span><span class="sh">'</span><span class="p">)</span>  
  
<span class="c1"># Display!  
</span><span class="n">plt</span><span class="p">.</span><span class="nf">tight_layout</span><span class="p">()</span>  
<span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">();</span>
</code></pre></div></div>

<h1 id="5-to-recap">5. To Recap</h1>
<blockquote>
  <p>(Honestly, it’s TL;DR again.😅)</p>
</blockquote>

<p>The dashboard of Google Optimize presents an excessively one-dimensional view when analyzing A/B tests, making it very risky to base service decisions solely on this.</p>

<ul>
  <li>Even if A/B testing may lead to the conclusion of maintaining option A across all user aspects, there can be cases within specific subgroups where the conclusion may favor option B. Unfortunately, Google Optimize does not provide such detailed analysis tools.</li>
  <li>Google Optimize allows for setting a maximum of three goals, which include metrics such as purchase conversion rate and specific button click-through rate. However, to comprehensively examine actions on the following pages or retention rates, it is necessary to consider them all together. Unfortunately, Google Optimize does not provide such functionality.</li>
  <li>There is indeed a valid concern regarding Google Optimize accurately measuring goal achievement if a user executes multiple sessions and makes a purchase in the last session while bypassing the experiment assignment page. It is questionable whether Google Optimize can accurately attribute this conversion as goal achievement.</li>
</ul>

<p>While Google Analytics 4’s Explore feature provides a UI for in-depth analysis of experiment results, it can be quite cumbersome and time-consuming to manually check and explore the results every time.</p>

<p>Therefore, by connecting to BigQuery (where the experiment data is loaded) from Python and creating automated code, the analysis time can be significantly reduced, and it becomes easier to quickly determine the direction for further analysis when needed.</p>

<hr />

<h2 id="published-by-joshua-kim"><em>Published by</em> Joshua Kim</h2>
<p><img src="/assets/profile/joshua-profile.png" alt="Joshua Kim" /></p>

  </div>

  <div class="pagination">
    
      <span class="prev" >
          <a href="http://localhost:4000/sankey-chart/">
            &#xE000; Let’s Create the Sankey Chart
          </a>
      </span>
    
    
      <span class="next" >
          <a href="http://localhost:4000/extract-dau-separating-new-and-existing-users/">
            It’s Harder than You Think to Extract DAU Separating New and Existing Users in BigQuery &#xE001;
          </a>
      </span>
    
  </div>

  <script type="text/javascript"
  src="https://unpkg.com/mermaid@10.6.1/dist/mermaid.min.js">
</script>
<script>
$(document).ready(function() {
    mermaid.initialize({
        theme: 'forest'
    });
});
</script>
  
</article>

    </div>

    <div class="wrapper-footer">
      <div class="container">
        <footer class="footer">
          <!-- Refer to https://codepen.io/ruandre/pen/howFi -->
<ul class="svg-icon">

  

  

  

  

  

  
  <li><a href="https://github.com/joshua-data" class="icon-13 github" title="GitHub"><svg viewBox="0 0 512 512"><path d="M256 70.7c-102.6 0-185.9 83.2-185.9 185.9 0 82.1 53.3 151.8 127.1 176.4 9.3 1.7 12.3-4 12.3-8.9V389.4c-51.7 11.3-62.5-21.9-62.5-21.9 -8.4-21.5-20.6-27.2-20.6-27.2 -16.9-11.5 1.3-11.3 1.3-11.3 18.7 1.3 28.5 19.2 28.5 19.2 16.6 28.4 43.5 20.2 54.1 15.4 1.7-12 6.5-20.2 11.8-24.9 -41.3-4.7-84.7-20.6-84.7-91.9 0-20.3 7.3-36.9 19.2-49.9 -1.9-4.7-8.3-23.6 1.8-49.2 0 0 15.6-5 51.1 19.1 14.8-4.1 30.7-6.2 46.5-6.3 15.8 0.1 31.7 2.1 46.6 6.3 35.5-24 51.1-19.1 51.1-19.1 10.1 25.6 3.8 44.5 1.8 49.2 11.9 13 19.1 29.6 19.1 49.9 0 71.4-43.5 87.1-84.9 91.7 6.7 5.8 12.8 17.1 12.8 34.4 0 24.9 0 44.9 0 51 0 4.9 3 10.7 12.4 8.9 73.8-24.6 127-94.3 127-176.4C441.9 153.9 358.6 70.7 256 70.7z"/></svg><!--[if lt IE 9]><em>GitHub</em><![endif]--></a></li>
  

  

  

  
  <li><a href="https://www.linkedin.com/in/joshuajsk" class="icon-17 linkedin" title="LinkedIn"><svg viewBox="0 0 512 512"><path d="M186.4 142.4c0 19-15.3 34.5-34.2 34.5 -18.9 0-34.2-15.4-34.2-34.5 0-19 15.3-34.5 34.2-34.5C171.1 107.9 186.4 123.4 186.4 142.4zM181.4 201.3h-57.8V388.1h57.8V201.3zM273.8 201.3h-55.4V388.1h55.4c0 0 0-69.3 0-98 0-26.3 12.1-41.9 35.2-41.9 21.3 0 31.5 15 31.5 41.9 0 26.9 0 98 0 98h57.5c0 0 0-68.2 0-118.3 0-50-28.3-74.2-68-74.2 -39.6 0-56.3 30.9-56.3 30.9v-25.2H273.8z"/></svg><!--[if lt IE 9]><em>LinkedIn</em><![endif]--></a></li>
  

  

  
  <li><a href="/feed.xml" class="icon-21 rss" title="RSS"><svg viewBox="0 0 512 512"><path d="M201.8 347.2c0 20.3-16.5 36.8-36.8 36.8 -20.3 0-36.8-16.5-36.8-36.8s16.5-36.8 36.8-36.8C185.3 310.4 201.8 326.8 201.8 347.2zM128.2 204.7v54.5c68.5 0.7 124 56.3 124.7 124.7h54.5C306.7 285.3 226.9 205.4 128.2 204.7zM128.2 166.6c57.9 0.3 112.3 22.9 153.2 63.9 41 41 63.7 95.5 63.9 153.5h54.5c-0.3-149.9-121.7-271.4-271.6-271.9V166.6L128.2 166.6z"/></svg><!--[if lt IE 9]><em>RSS</em><![endif]--></a></li>
  

  

  

  

  

</ul>



<div class="footer-wrapper">
    <p>Joshua Kim</p>
    <a href="https://hits.seeyoufarm.com"><img src="https://hits.seeyoufarm.com/api/count/incr/badge.svg?url=https%3A%2F%2Fjoshua-data.github.io&count_bg=%2379C83D&title_bg=%23555555&icon=ghostery.svg&icon_color=%23E7E7E7&title=hits&edge_flat=false"/></a>
</div>

        </footer>
      </div>
    </div>

    

  </body>
</html>
